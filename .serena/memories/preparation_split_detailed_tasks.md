# Preparation分割実装 - 詳細タスクリスト

## 🎯 目標
preparation.htmlを2つのファイルに分割し、PitchPro二重初期化問題を完全に解決する

## 📋 詳細タスク（検証重視の細分化）

### Phase 1: 事前準備と検証環境構築
- [ ] 1.1 現在の安定版のバックアップ作成
  - preparation.html
  - preparation-pitchpro-cycle.js
  - voice-range-test-demo.js
  
- [ ] 1.2 テスト用ディレクトリ作成
  - /Bolt/v2/pages/preparation-split-test/
  
- [ ] 1.3 最小限のテストHTMLファイル作成
  - test-step1-minimal.html（ボタンのみ）
  - test-step2-minimal.html（遷移確認のみ）
  
- [ ] 1.4 localStorage動作テスト
  - データ保存テスト
  - データ読み込みテスト
  - ページ間遷移テスト

### Phase 2: Step1（マイク許可・音声テスト）基礎実装

- [ ] 2.1 preparation-step1.html作成（HTMLのみ）
  - ヘッダー部分
  - ステップインジケーター（Step1のみアクティブ）
  - マイク許可セクション
  - 音声テストセクション（非表示）
  
- [ ] 2.2 最小限のマイク許可機能実装
  - ボタンクリックイベントのみ
  - console.log出力で確認
  - アラート表示で動作確認
  
- [ ] 2.3 navigator.mediaDevices.getUserMedia単独テスト
  - マイク許可ダイアログ表示確認
  - ストリーム取得成功確認
  - エラーハンドリング確認
  
- [ ] 2.4 PitchPro初期化テスト（Step1用）
  - AudioDetectionComponent作成
  - initialize()実行
  - エラーなく初期化完了確認

- [ ] 2.5 音声検出開始テスト
  - startDetection()実行
  - 音量バー更新確認
  - 周波数表示確認

- [ ] 2.6 セクション切り替えテスト
  - マイク許可セクション → 音声テストセクション
  - UI要素の表示/非表示確認

- [ ] 2.7 Step1完了処理実装
  - localStorage保存（micPermissionGranted, audioTestCompleted）
  - 完了メッセージ表示
  - Step2への遷移ボタン表示

### Phase 3: Step2（音域テスト・結果）基礎実装

- [ ] 3.1 preparation-step2.html作成（HTMLのみ）
  - ヘッダー部分
  - ステップインジケーター（Step1完了、Step2,3アクティブ）
  - 音域テストセクション
  - 結果表示セクション（非表示）

- [ ] 3.2 Step1完了チェック機能
  - localStorage読み込み
  - 未完了時のリダイレクト処理
  - デバッグ用バイパス機能（開発時のみ）

- [ ] 3.3 PitchPro初期化テスト（Step2用、独立インスタンス）
  - 新規AudioDetectionComponent作成
  - Step1とは完全に独立した初期化
  - 二重初期化エラーが発生しないことを確認

- [ ] 3.4 音域テスト基本機能実装
  - 開始ボタン動作
  - 音声検出開始
  - 最低音・最高音の記録（簡易版）

- [ ] 3.5 結果表示機能実装
  - 測定結果の表示
  - localStorage保存
  - DataManager統合（可能なら）

- [ ] 3.6 トレーニング開始遷移
  - 音域データ保存確認
  - training.htmlへの遷移処理

### Phase 4: データ連携とエラー処理

- [ ] 4.1 ページ間データ連携テスト
  - Step1 → Step2のデータ引き継ぎ
  - 正常系フロー確認
  
- [ ] 4.2 異常系テスト
  - 直接Step2アクセス時の処理
  - localStorage削除時の処理
  - ブラウザバック対応

- [ ] 4.3 エラーハンドリング強化
  - マイク許可拒否時の処理
  - PitchPro初期化失敗時の処理
  - ネットワークエラー対応

### Phase 5: UI/UX改善

- [ ] 5.1 ローディング表示追加
  - 初期化中の表示
  - 処理中のスピナー
  
- [ ] 5.2 アニメーション追加
  - ページ遷移アニメーション
  - セクション切り替えアニメーション

- [ ] 5.3 レスポンシブ対応確認
  - モバイル表示確認
  - タブレット表示確認

### Phase 6: 既存コードからの移植

- [ ] 6.1 preparation-pitchpro-cycle.jsから必要部分を抽出
  - マイク許可フロー
  - 音声テスト機能
  - UI更新処理

- [ ] 6.2 voice-range-test-demo.jsから必要部分を抽出
  - 音域テスト機能
  - 結果計算処理
  - アニメーション処理

### Phase 7: 統合テスト

- [ ] 7.1 全体フローテスト
  - Step1開始 → 完了 → Step2開始 → 完了
  - 各種ボタンの動作確認
  
- [ ] 7.2 PitchPro独立性確認
  - Step1のPitchProインスタンス
  - Step2のPitchProインスタンス
  - 相互に影響しないことを確認

- [ ] 7.3 データ永続性テスト
  - ブラウザリロード後のデータ保持
  - 音域データの正確な保存

### Phase 8: 本番置き換え

- [ ] 8.1 バックアップ作成
  - 現在のpreparation.html
  - 関連JSファイル
  
- [ ] 8.2 リンク更新
  - index.htmlからのリンク変更
  - その他参照箇所の更新

- [ ] 8.3 最終動作確認
  - 本番環境での動作テスト
  - エラーログ確認

## 🚨 各フェーズのチェックポイント

### 必須確認項目
1. **console.logにエラーが出ていないか**
2. **期待する動作が確実に行われているか**
3. **前のフェーズの機能が壊れていないか**
4. **PitchProの二重初期化エラーが発生していないか**

### 検証方法
- 各タスク完了後にブラウザコンソール確認
- 動作確認は必ず実機で実施
- 問題があれば即座に停止し原因究明

## 📝 作業記録
- 各タスク完了時にコミット
- 問題発生時は詳細をログに記録
- 成功パターンを文書化

## 🎯 成功基準
1. マイク許可ボタンが確実に動作する
2. PitchProの二重初期化エラーが発生しない
3. Step1とStep2が独立して動作する
4. データが正しく引き継がれる
5. エラー時の処理が適切に行われる