# PitchPro-SPA 実装フロー戦略 (2025年9月30日)

## 概要
8va相対音感トレーニングアプリのPitchPro-SPAを、Vanilla JS + 自作SPAアーキテクチャで実装する段階的開発計画。音声処理の特殊性を考慮し、既存資産を最大限活用する戦略。

## 技術選択の根拠

### Vanilla JS + 自作SPA採用理由
1. **音声処理の優位性**: PitchPro v1.3.1との完全互換性
2. **開発効率**: MicPermissionManager等の既存資産活用
3. **リスク最小化**: 実証済みアーキテクチャの継続

### 主要技術制約
- Web Audio APIの直接制御必要
- 30-60FPSのリアルタイム処理
- ユーザー操作起点の初期化必須

## 実装フェーズ概要

### 📋 Phase 1: 基盤統合・完成 (1-2週間)
**目的**: マイク許可問題の根本解決と音域測定機能実装

#### 1-1. MicPermissionManager統合
- **対象**: preparation-step1.html
- **作業内容**: 
  - preparation-pitchpro-cycle.jsをMicPermissionManagerベースに置き換え
  - ユーザー操作起点でのマイク許可取得
  - PitchProインスタンス初期化の確実化
- **成果**: マイク許可ダイアログ再表示問題の完全解決

#### 1-2. 音域テスト機能実装
- **対象**: preparation-step2.html
- **作業内容**:
  - 低音・高音テストの自動化
  - 快適音域の判定ロジック実装
  - 推奨基音リスト生成機能
- **APP_SPECIFICATION対応項目**:
  - 検出音域範囲表示 (例: B2 - D5)
  - オクターブ数計算 (例: 2.3オクターブ)
  - 推奨基音リスト提案

#### 1-3. ページ間データ連携
- localStorage活用による音域データ共有
- MicPermissionManager状態の継承確認
- ダイレクトアクセス対応

### 📊 Phase 2: トレーニングコア実装 (2-3週間)
**目的**: 3つのトレーニングモード基本機能実装

#### 2-1. ランダム基音モード（初級）
- **URL**: `/training?mode=random&session=1`
- **仕様**:
  - 基音選択: C3オクターブ8音からランダム
  - セッション数: 8回（個別評価付き）
  - 判定基準: ±50セント以内
- **実装要素**:
  - 統合進行ガイドシステム
  - リアルタイム音程判定
  - 相対音感原則（基音の音名・周波数非表示）

#### 2-2. 連続チャレンジモード（中級）
- **URL**: `/training?mode=continuous&session=1`
- **仕様**:
  - 基音選択: クロマチック12音からランダム
  - セッション数: 8回連続（自動進行）
  - 評価: 総合評価のみ

#### 2-3. 12音階モード（上級）基本版
- **URL**: `/training?mode=twelve&session=1`
- **仕様**:
  - 基音選択: クロマチック12音順次
  - セッション数: 12回連続
  - 判定基準: ±30セント（厳密）

### 📱 Phase 3: UX最適化・応用機能 (2-3週間)
**目的**: ユーザビリティ向上と価値追加機能

#### 3-1. レスポンシブUI完全対応
- モバイル: 縦積み配置
- PC: 横並び配置
- タッチ操作最適化

#### 3-2. 評価システム強化
- セント精度ベースの評価
- 平均音程精度表示
- S-E級総合評価実装
- 音階別精度分析

#### 3-3. SNS共有機能
- 1080x1080px結果画像生成
- Twitter/Facebook/LINE/Instagram対応
- カスタムメッセージ機能

### 🚀 Phase 4: 高度機能・完成度向上 (2-3週間)
**目的**: 上級機能実装と長期利用対応

#### 4-1. 12音階モード完全版
- 上昇モード（12セッション）
- 下降モード（12セッション）
- 上昇下降モード（24セッション）
- 音域調整機能（±2段階）

#### 4-2. データ分析・長期保存
- 練習履歴の詳細分析
- 弱点音程の特定・改善提案
- 長期統計データの可視化
- 進捗追跡機能

#### 4-3. ダイレクトアクセス完全対応
- URL直接アクセスの自動ハンドリング
- マイク未許可時の自動リダイレクト
- 状態復元機能

### ✨ Phase 5: ポリッシュ・リリース準備 (1-2週間)
**目的**: 最終品質保証とデプロイ準備

#### 5-1. 最終統合テスト
- 全フロー動作確認
- クロスブラウザテスト (Safari/Chrome/Firefox/Edge)
- モバイル実機テスト
- パフォーマンス最適化

#### 5-2. ドキュメント・デプロイ準備
- ユーザーマニュアル作成
- GitHub Pages最適化
- PWA対応設定

## 実装優先度マトリックス

### 🔥 超重要（即座実装）
1. MicPermissionManager統合 - 根本問題解決
2. 音域テスト機能 - APP_SPECIFICATION必須要件
3. ランダム基音モード - 初級ユーザーの主要機能

### ⚡ 重要（早期実装）
4. 連続チャレンジモード - 中級ユーザー対応
5. レスポンシブUI - モバイルユーザビリティ
6. 評価システム - フィードバック機能

### 📊 価値追加（中期実装）
7. SNS共有機能 - ユーザー拡散効果
8. 12音階モード基本 - 上級ユーザー対応
9. データ分析機能 - 学習効果可視化

## 技術的実装パターン

### モジュール化された状態管理
```javascript
class AppStateManager {
  constructor() {
    this.currentMode = null;
    this.sessionData = {};
    this.audioManager = null;
  }
}
```

### コンポーネント化パターン
```javascript
class TrainingComponent {
  constructor(container, mode) {
    this.container = container;
    this.mode = mode;
    this.micManager = null;
  }
}
```

## 重要な設計原則

### 相対音感トレーニング根幹原則
- トレーニング中は基音の音程表記完全禁止
- 基音の音名(C3, D4等)や周波数表示禁止
- 相対音程(ドレミファソラシド)のみ表示可能

### 音声処理特殊要件
- Web Audio APIの直接制御維持
- 30-60FPS高頻度処理対応
- ユーザー操作起点の初期化必須
- PitchPro v1.3.1との完全互換性確保

## リスク管理

### 技術的リスク
- 状態管理の複雑化 → 段階的にコンポーネント化で対処
- デバッグの困難性 → 詳細ログシステム実装
- パフォーマンス問題 → 定期的な計測と最適化

### 対策
- 既存資産の最大活用
- 段階的な機能追加
- 各フェーズでの動作確認徹底

## 期待される成果

### Phase 1完了時
- マイク許可問題の完全解決
- 音域測定による最適な基音提案
- 快適な練習環境の確立

### Phase 2完了時
- 初級～中級ユーザー向け機能完成
- 基本的な相対音感トレーニング環境提供

### Phase 3完了時
- 全デバイス対応完了
- SNS拡散機能による認知度向上
- 充実した評価フィードバック

### 全フェーズ完了時
- APP_SPECIFICATION完全準拠
- プロレベル対応の本格的音感トレーニングアプリ
- 長期的な学習支援システム

## 次のアクション

1. **即座着手**: preparation-step1.htmlへのMicPermissionManager統合
2. **続いて実装**: preparation-step2.htmlの音域テスト機能強化
3. **コア機能**: ランダム基音モードの基本実装

この段階的アプローチにより、確実に動作する機能を積み上げながら、APP_SPECIFICATIONの要件を満たす完全なアプリケーションを構築する。

## 作成日
2025年9月30日

## ステータス
✅ 実装計画策定完了
🔄 Phase 1実装準備中