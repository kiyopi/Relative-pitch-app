<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ã‚¯æ„Ÿåº¦èª¿æ•´ãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <style>
        body {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .slider-group {
            margin: 1rem 0;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .slider {
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .value-display {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
            margin-left: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            margin: 0.5rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .volume-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .frequency-display {
            font-family: monospace;
            font-size: 1.1rem;
            color: #60a5fa;
        }
        
        #log {
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a0a0a0;
            max-height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center;">ãƒã‚¤ã‚¯æ„Ÿåº¦èª¿æ•´ãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- ç¾åœ¨ã®æ¤œå‡ºçŠ¶æ³ -->
        <div class="test-section">
            <h3>ç¾åœ¨ã®æ¤œå‡ºçŠ¶æ³</h3>
            <div class="volume-display">
                <span style="min-width: 80px;">éŸ³é‡:</span>
                <div class="progress-bar">
                    <div class="progress-fill gradient-catalog-green" id="volume-bar" style="width: 0%;"></div>
                </div>
                <span class="volume-text" id="volume-text">0%</span>
            </div>
            
            <div class="frequency-display">
                å‘¨æ³¢æ•°: <span id="frequency-display">0 Hz</span>
            </div>
        </div>
        
        <!-- æ„Ÿåº¦è¨­å®š -->
        <div class="test-section">
            <h3>æ„Ÿåº¦è¨­å®š</h3>
            
            <div class="slider-group">
                <label for="minVolume">æœ€å°éŸ³é‡é–¾å€¤ (minVolumeAbsolute)</label>
                <input type="range" id="minVolume" class="slider" min="0.001" max="0.05" step="0.001" value="0.003">
                <span class="value-display" id="minVolumeValue">0.003</span>
                <p style="font-size: 0.8rem; color: #a0a0a0;">ã“ã®å€¤ä»¥ä¸‹ã®éŸ³é‡ã¯ç„¡è¦–ã•ã‚Œã¾ã™ï¼ˆé›‘éŸ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼‰</p>
            </div>
            
            <div class="slider-group">
                <label for="clarity">éŸ³ç¨‹æ˜ç­åº¦é–¾å€¤ (clarityThreshold)</label>
                <input type="range" id="clarity" class="slider" min="0.1" max="1.0" step="0.1" value="0.4">
                <span class="value-display" id="clarityValue">0.4</span>
                <p style="font-size: 0.8rem; color: #a0a0a0;">éŸ³ç¨‹æ¤œå‡ºã®ç²¾åº¦è¦æ±‚ï¼ˆé«˜ã„ã»ã©å³æ ¼ï¼‰</p>
            </div>
            
            <div class="controls">
                <button id="apply-btn" class="btn btn-primary">è¨­å®šã‚’é©ç”¨</button>
                <button id="reset-btn" class="btn btn-secondary">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
            </div>
        </div>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="test-section">
            <h3>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
            <div class="controls">
                <button id="start-btn" class="btn btn-primary">æ¤œå‡ºé–‹å§‹</button>
                <button id="stop-btn" class="btn btn-secondary" disabled>æ¤œå‡ºåœæ­¢</button>
                <button id="silent-test-btn" class="btn btn-secondary">ç„¡éŸ³çŠ¶æ…‹ç¢ºèª</button>
            </div>
            
            <p style="font-size: 0.9rem; color: #a0a0a0;">
                ğŸ“‹ ãƒ†ã‚¹ãƒˆæ–¹æ³•:<br>
                1. ã€Œæ¤œå‡ºé–‹å§‹ã€å¾Œã€å®Œå…¨ã«ç„¡éŸ³ã«ã—ã¦ãã ã•ã„<br>
                2. éŸ³é‡ãƒãƒ¼ãŒ0%ã®ã¾ã¾ã‹ç¢ºèª<br>
                3. æ„Ÿåº¦ã‚’èª¿æ•´ã—ã¦æœ€é©å€¤ã‚’è¦‹ã¤ã‘ã¦ãã ã•ã„
            </p>
        </div>
        
        <!-- ãƒ­ã‚° -->
        <div class="test-section">
            <h3>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>
            <div id="log"></div>
        </div>
    </div>
    
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    
    <script>
        let audioDetector = null;
        let updateCounter = 0;
        
        // DOMè¦ç´ 
        const elements = {
            volumeBar: document.getElementById('volume-bar'),
            volumeText: document.getElementById('volume-text'),
            frequencyDisplay: document.getElementById('frequency-display'),
            
            minVolumeSlider: document.getElementById('minVolume'),
            claritySlider: document.getElementById('clarity'),
            minVolumeValue: document.getElementById('minVolumeValue'),
            clarityValue: document.getElementById('clarityValue'),
            
            startBtn: document.getElementById('start-btn'),
            stopBtn: document.getElementById('stop-btn'),
            applyBtn: document.getElementById('apply-btn'),
            resetBtn: document.getElementById('reset-btn'),
            silentTestBtn: document.getElementById('silent-test-btn'),
            
            log: document.getElementById('log')
        };
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                'INFO': 'â„¹ï¸',
                'SUCCESS': 'âœ…',
                'ERROR': 'âŒ',
                'WARNING': 'âš ï¸',
                'DEBUG': 'ğŸ”',
                'NOISE': 'ğŸ”‡'
            }[type] || 'ğŸ“';
            
            const logMessage = `[${timestamp}] ${emoji} ${message}\n`;
            elements.log.textContent += logMessage;
            elements.log.scrollTop = elements.log.scrollHeight;
            console.log(logMessage.trim());
        }
        
        // è¨­å®šå€¤ã®è¡¨ç¤ºæ›´æ–°
        function updateValueDisplays() {
            elements.minVolumeValue.textContent = elements.minVolumeSlider.value;
            elements.clarityValue.textContent = elements.claritySlider.value;
        }
        
        // AudioDetectoråˆæœŸåŒ–
        async function initializeDetector() {
            if (audioDetector) {
                audioDetector.destroy();
            }
            
            const minVolume = parseFloat(elements.minVolumeSlider.value);
            const clarity = parseFloat(elements.claritySlider.value);
            
            log(`AudioDetectoråˆæœŸåŒ–: minVolume=${minVolume}, clarity=${clarity}`, 'INFO');
            
            const { AudioDetectionComponent } = window.PitchPro;
            audioDetector = new AudioDetectionComponent({
                volumeBarSelector: '#dummy',
                volumeTextSelector: '#dummy',
                frequencySelector: '#dummy',
                
                clarityThreshold: clarity,
                minVolumeAbsolute: minVolume,
                deviceOptimization: true,
                debug: false,
                logPrefix: 'ğŸµ SensitivityTest'
            });
            
            // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            audioDetector.setCallbacks({
                onPitchUpdate: (result) => {
                    updateCounter++;
                    
                    // UIæ›´æ–°
                    if (result.volume !== undefined) {
                        const volume = Math.min(100, Math.max(0, result.volume));
                        elements.volumeBar.style.width = `${volume}%`;
                        elements.volumeText.textContent = `${volume.toFixed(1)}%`;
                        
                        // ä½éŸ³é‡ã®æ¤œå‡ºã‚’ãƒ­ã‚°
                        if (volume > 0 && volume < 5) {
                            if (updateCounter % 10 === 0) { // 10å›ã«1å›ãƒ­ã‚°å‡ºåŠ›
                                log(`å¾®ç´°éŸ³é‡æ¤œå‡º: ${volume.toFixed(2)}% (é–¾å€¤: ${minVolume})`, 'NOISE');
                            }
                        }
                    }
                    
                    if (result.frequency) {
                        elements.frequencyDisplay.textContent = `${result.frequency.toFixed(1)} Hz`;
                    }
                },
                onError: (error) => {
                    log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
                }
            });
            
            await audioDetector.initialize();
            log('AudioDetectoråˆæœŸåŒ–å®Œäº†', 'SUCCESS');
        }
        
        // æ¤œå‡ºé–‹å§‹
        async function startDetection() {
            try {
                if (!audioDetector) {
                    await initializeDetector();
                }
                
                await audioDetector.startDetection();
                log('æ¤œå‡ºé–‹å§‹', 'SUCCESS');
                
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
                
                // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
                updateCounter = 0;
                
            } catch (error) {
                log(`é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // æ¤œå‡ºåœæ­¢
        function stopDetection() {
            if (audioDetector) {
                audioDetector.stopDetection();
                log('æ¤œå‡ºåœæ­¢', 'INFO');
            }
            
            // UI ãƒªã‚»ãƒƒãƒˆ
            elements.volumeBar.style.width = '0%';
            elements.volumeText.textContent = '0%';
            elements.frequencyDisplay.textContent = '0 Hz';
            
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
        }
        
        // è¨­å®šé©ç”¨
        async function applySettings() {
            log('è¨­å®šã‚’é©ç”¨ä¸­...', 'INFO');
            
            if (audioDetector && !elements.startBtn.disabled) {
                // æ¤œå‡ºä¸­ã®å ´åˆã¯å†åˆæœŸåŒ–
                const wasDetecting = !elements.stopBtn.disabled;
                
                if (wasDetecting) {
                    stopDetection();
                }
                
                await initializeDetector();
                
                if (wasDetecting) {
                    await startDetection();
                }
            }
            
            log('è¨­å®šé©ç”¨å®Œäº†', 'SUCCESS');
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã™
        async function resetToDefault() {
            elements.minVolumeSlider.value = '0.003';
            elements.claritySlider.value = '0.4';
            updateValueDisplays();
            
            log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«æˆ»ã—ã¾ã—ãŸ', 'INFO');
            await applySettings();
        }
        
        // ç„¡éŸ³çŠ¶æ…‹ãƒ†ã‚¹ãƒˆ
        function testSilentState() {
            log('=== ç„¡éŸ³çŠ¶æ…‹ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'INFO');
            log('10ç§’é–“å®Œå…¨ã«ç„¡éŸ³ã«ã—ã¦ãã ã•ã„...', 'INFO');
            
            let silentCount = 0;
            let noiseCount = 0;
            const startTime = Date.now();
            
            const testInterval = setInterval(() => {
                const currentVolume = parseFloat(elements.volumeText.textContent) || 0;
                
                if (currentVolume === 0) {
                    silentCount++;
                } else {
                    noiseCount++;
                    log(`é›‘éŸ³æ¤œå‡º: ${currentVolume.toFixed(2)}%`, 'WARNING');
                }
                
                const elapsed = Date.now() - startTime;
                if (elapsed >= 10000) { // 10ç§’çµŒé
                    clearInterval(testInterval);
                    
                    const total = silentCount + noiseCount;
                    const noiseRate = total > 0 ? (noiseCount / total * 100) : 0;
                    
                    log('=== ç„¡éŸ³çŠ¶æ…‹ãƒ†ã‚¹ãƒˆçµæœ ===', 'INFO');
                    log(`å®Œå…¨ç„¡éŸ³: ${silentCount}å›, é›‘éŸ³æ¤œå‡º: ${noiseCount}å›`, 'INFO');
                    log(`é›‘éŸ³ç‡: ${noiseRate.toFixed(1)}%`, noiseRate > 20 ? 'WARNING' : 'SUCCESS');
                    
                    if (noiseRate > 20) {
                        log('âš ï¸ æ„Ÿåº¦ãŒé«˜ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'WARNING');
                        log('minVolumeAbsoluteã‚’ä¸Šã’ã‚‹ã“ã¨ã‚’æ¨å¥¨', 'WARNING');
                    } else {
                        log('âœ… é©åˆ‡ãªæ„Ÿåº¦è¨­å®šã§ã™', 'SUCCESS');
                    }
                }
            }, 200); // 200msé–“éš”ã§ãƒã‚§ãƒƒã‚¯
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        elements.minVolumeSlider.addEventListener('input', updateValueDisplays);
        elements.claritySlider.addEventListener('input', updateValueDisplays);
        
        elements.startBtn.addEventListener('click', startDetection);
        elements.stopBtn.addEventListener('click', stopDetection);
        elements.applyBtn.addEventListener('click', applySettings);
        elements.resetBtn.addEventListener('click', resetToDefault);
        elements.silentTestBtn.addEventListener('click', testSilentState);
        
        // åˆæœŸåŒ–
        updateValueDisplays();
        log('æ„Ÿåº¦èª¿æ•´ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'SUCCESS');
        log('ã¾ãšã€Œæ¤œå‡ºé–‹å§‹ã€ã—ã¦ã‹ã‚‰ã€Œç„¡éŸ³çŠ¶æ…‹ç¢ºèªã€ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'INFO');
    </script>
</body>
</html>