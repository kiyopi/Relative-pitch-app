# 倍音補正システム仕様書

**バージョン**: v1.0.0
**作成日**: 2025年10月27日
**最終更新**: 2025年10月27日
**実装バージョン**: trainingController.js v2025-10-27-004

---

## 📋 目次

1. [概要](#概要)
2. [背景と目的](#背景と目的)
3. [補正システムの仕様](#補正システムの仕様)
4. [実装詳細](#実装詳細)
5. [テスト結果](#テスト結果)
6. [既知の制限事項](#既知の制限事項)
7. [今後の拡張計画](#今後の拡張計画)

---

## 概要

### 目的
低音域～中音域（220Hz以下）における倍音誤検出を自動的に補正し、ユーザーの実際の歌唱精度を正確に評価する。

### 対象範囲
- **周波数範囲**: 期待周波数 ≤ 220Hz（～A3まで）
- **適用条件**: 誤差 > 20Hz、明瞭度 ≥ 0.8
- **補正パターン**: 7種類の倍音比率パターン

### 実装場所
- **ファイル**: `/PitchPro-SPA/js/controllers/trainingController.js`
- **関数**: `recordStepPitchData()` 内（744-804行）
- **バージョン**: v2025-10-27-004

---

## 背景と目的

### 発生した問題

#### 問題1: 完全5度の倍音誤検出（sessionId=16）
- **基音**: A2 (110Hz)
- **症状**: 全8ステップで1.4～1.5倍の周波数が検出
- **誤差**: +466¢ ～ +699¢（非常に大きい）
- **原因**: PitchProが基音（110Hz）ではなく完全5度の倍音（165Hz）を検出

#### 問題2: 短2度上の倍音誤検出（sessionId=8）
- **基音**: F3 (174.61Hz)
- **症状**: 全8ステップで1.12～1.13倍の周波数が検出
- **誤差**: +195¢ ～ +217¢
- **原因**: 補正対象周波数が150Hzまでで、F3（174.61Hz）が対象外

#### 問題3: 完全5度下の倍音誤検出（sessionId=9）
- **基音**: C#3 (138.59Hz)
- **症状**: 全8ステップで0.65～0.70倍の周波数が検出
- **誤差**: -629¢ ～ -741¢
- **原因**: 0.67倍パターンが補正リストに未登録

### 解決の必要性

1. **評価の正確性**: 倍音誤検出により、実際の歌唱精度が正しく評価されない
2. **ユーザー体験**: 正しく歌っているのに大きな誤差が表示される
3. **データの信頼性**: 総合評価・グレード計算が不正確になる

---

## 補正システムの仕様

### 補正適用条件

補正は以下の**全ての条件**を満たす場合のみ適用：

```javascript
1. 期待周波数 ≤ 220Hz
2. 絶対誤差 > 20Hz
3. 明瞭度 ≥ 0.8
4. 倍音パターンに一致
5. 補正後の誤差 < 15%
```

### 倍音パターン一覧

| パターン | 比率 | 許容範囲 | 名称 | 対応ケース |
|---------|------|---------|------|-----------|
| 1 | 2.0x | ±10% | 第2倍音（オクターブ） | 1オクターブ上を誤検出 |
| 2 | 3.0x | ±10% | 第3倍音 | 完全12度上を誤検出 |
| 3 | 1.5x | ±10% | 完全5度 | sessionId=16対応 |
| 4 | 1.33x | ±10% | 完全4度（4/3） | 完全4度上を誤検出 |
| 5 | 1.125x | ±8% | 短2度上 | sessionId=8対応（新規） |
| 6 | 0.67x | ±8% | 完全5度下（2/3） | sessionId=9対応（新規） |
| 7 | 0.5x | ±10% | 1オクターブ下 | 1オクターブ下を誤検出 |

### 補正処理フロー

```
1. 検出周波数と期待周波数の比率を計算
   ratio = detectedFrequency / expectedFrequency

2. 各倍音パターンとの誤差率を計算
   errorRatio = |ratio - pattern.ratio| / pattern.ratio

3. パターンに一致する場合（errorRatio < tolerance）
   correctedFreq = detectedFrequency / pattern.ratio

4. 補正後の周波数が期待値に近いか確認
   correctedError = |correctedFreq - expectedFrequency| / expectedFrequency

5. 補正後誤差が15%以内なら補正適用
   if (correctedError < 0.15) → 補正適用
```

---

## 実装詳細

### コード実装

**ファイル**: `/PitchPro-SPA/js/controllers/trainingController.js`

```javascript
// 期待周波数が220Hz以下の場合、倍音誤検出の可能性をチェック（拡張：150Hz→220Hz）
if (expectedFrequency <= 220 && Math.abs(bestData.frequency - expectedFrequency) > 20 && bestData.clarity >= 0.8) {
    const ratio = bestData.frequency / expectedFrequency;

    // 拡張倍音パターン検出（新パターン追加：1.125x, 0.67x）
    const harmonicPatterns = [
        { ratio: 2.0, name: '第2倍音(オクターブ)', tolerance: 0.1 },
        { ratio: 3.0, name: '第3倍音', tolerance: 0.1 },
        { ratio: 1.5, name: '完全5度', tolerance: 0.1 },
        { ratio: 1.33, name: '完全4度', tolerance: 0.1 },
        { ratio: 1.125, name: '短2度上', tolerance: 0.08 },
        { ratio: 0.67, name: '完全5度下', tolerance: 0.08 },
        { ratio: 0.5, name: '1オクターブ下', tolerance: 0.1 }
    ];

    for (const pattern of harmonicPatterns) {
        const errorRatio = Math.abs(ratio - pattern.ratio) / pattern.ratio;

        if (errorRatio < pattern.tolerance) {
            const correctedFreq = bestData.frequency / pattern.ratio;
            const correctedError = Math.abs((correctedFreq - expectedFrequency) / expectedFrequency);

            if (correctedError < 0.15) {
                finalFrequency = correctedFreq;
                correctionApplied = true;
                correctionReason = pattern.name;
                break;
            }
        }
    }
}
```

### デバッグログ

補正システムは詳細なコンソールログを出力：

```
🔍 [補正チェック] Step 0: 期待=110.0Hz, 検出=165.0Hz, 誤差=55.0Hz, 明瞭度=0.999
✓ 補正条件満たす: 期待周波数=110.0Hz ≤ 220Hz, 誤差=55.0Hz > 20Hz, 明瞭度=0.999 ≥ 0.8
🎯 倍音パターン一致: 完全5度 (比率=1.500, 誤差率=0.0%)
   補正後周波数=110.0Hz, 期待値との誤差=0.0%
🔧 [倍音補正適用] Step 0: 165.0Hz → 110.0Hz (完全5度)
```

### データ記録

補正後の周波数はlocalStorageに保存：

```javascript
sessionRecorder.recordPitchError(
    step,
    expectedNoteName,
    expectedFrequency,
    finalFrequency,        // ← 補正済み周波数
    bestData.clarity,
    bestData.volume
);
```

---

## テスト結果

### 修正前のデータ（v2025-10-27-003以前）

#### sessionId=16（A2, 110Hz）
| ステップ | 期待 | 検出 | 比率 | 誤差 | 補正 |
|---------|-----|------|------|------|------|
| ド | 110Hz | 150Hz | 1.36x | +539.7¢ | ❌ なし |
| レ | 123Hz | 162Hz | 1.31x | +466.4¢ | ❌ なし |
| 平均 | - | - | 1.44x | +626.1¢ | - |

#### sessionId=8（F3, 174.61Hz）
| ステップ | 期待 | 検出 | 比率 | 誤差 | 補正 |
|---------|-----|------|------|------|------|
| ド | 174.61Hz | 195.80Hz | 1.12x | +198.3¢ | ❌ なし（範囲外） |
| レ | 195.99Hz | 222.19Hz | 1.13x | +217.2¢ | ❌ なし（範囲外） |

#### sessionId=9（C#3, 138.59Hz）
| ステップ | 期待 | 検出 | 比率 | 誤差 | 補正 |
|---------|-----|------|------|------|------|
| ド | 138.59Hz | 90.29Hz | 0.65x | -741.8¢ | ❌ なし（パターンなし） |
| レ | 155.56Hz | 108.15Hz | 0.70x | -629.4¢ | ❌ なし（パターンなし） |

### 修正後のデータ（v2025-10-27-004）

#### 全体的な改善
- ✅ **極端な倍音誤検出パターンは消失**
- ✅ **ほとんどのセッションで正常な誤差範囲（±100¢以内）**
- ✅ **補正システムが正常に動作**

#### 稀な外れ値（sessionId=3, Step 0）
| ステップ | 期待 | 検出 | 比率 | 誤差 | 補正 | 理由 |
|---------|-----|------|------|------|------|------|
| ド | 146.83Hz | 336.22Hz | 2.29x | +1434.3¢ | ❌ なし | 比率が2.0±10%の範囲外 |

**判断**: 偶発的なノイズまたはユーザーの誤発声と推測。2倍音の許容範囲を15%に拡大すると、正しく2倍音を歌った場合も補正されるリスクがあるため、現状維持。

---

## 既知の制限事項

### 1. 補正対象周波数の上限
- **現在**: 220Hz（A3）まで
- **理由**: 中音域以上では倍音誤検出が稀
- **影響**: F3（174.61Hz）以上の基音には対応

### 2. 絶対誤差閾値
- **現在**: 20Hz固定
- **課題**: 低音域（100Hz）では過敏、高音域（200Hz）では適切
- **改善案**: セント誤差ベースの閾値（±100¢）への変更を検討中

### 3. 極端な外れ値
- **現象**: 稀に2.29xなど、許容範囲を超える倍音比率が発生
- **対応**: 現状は補正せず（偶発的なノイズと判断）
- **今後**: 頻発する場合は許容範囲の拡大を検討

### 4. 補正パターンの限界
- **現在**: 7種類のパターンのみ
- **未対応**: 短6度下（0.82x）など、稀なパターン
- **方針**: 頻発する場合に追加検討

---

## 今後の拡張計画

### Phase 1: 様子見（現在）
- ✅ **実装完了**: 220Hzまで対応、7パターン
- 📊 **データ収集**: 実運用でのパフォーマンス確認
- 🔍 **監視**: 新しい倍音誤検出パターンの出現

### Phase 2: 閾値の最適化（必要に応じて）
- **セント誤差ベース**: 20Hz → ±100¢
- **2倍音の許容範囲**: 10% → 15%（頻発する場合）

### Phase 3: パターンの拡張（必要に応じて）
- **短6度下**: 0.82x（tolerance: 0.08）
- **その他**: データ分析により追加

### Phase 4: リリース時のクリーンアップ
- **PitchPro側の未使用コード削除**
  - `PitchDetector.ts`: `correctLowFrequencyHarmonic()` メソッド
  - `AudioDetectionComponent.ts`: `getPitchDetector()` メソッド
- **理由**: アプリケーション側で完全実装済み

---

## 変更履歴

### v1.0.0（2025年10月27日）
- ✅ 補正対象周波数を150Hz → 220Hzに拡大
- ✅ 倍音パターンを5種類 → 7種類に拡張
  - 追加: 1.125x（短2度上）
  - 追加: 0.67x（完全5度下）
- ✅ trainingController.js v2025-10-27-004 で実装
- ✅ index.html キャッシュバスター v20251027004 に更新

---

## 関連ドキュメント

- **実装ファイル**: `/PitchPro-SPA/js/controllers/trainingController.js`
- **テストログ**: `/Users/isao/Desktop/相対音間トレ/ログ/`
- **PitchPro仕様**: `/Users/isao/Documents/pitchpro-audio-processing/README.md`

---

**このドキュメントは、倍音補正システムの仕様・実装・テスト結果を包括的に記録します。**
