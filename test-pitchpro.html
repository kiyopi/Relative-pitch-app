<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchProæœ€å°é™ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            background: #2a2a3e;
            border-radius: 5px;
            min-height: 50px;
        }
        .volume-bar {
            height: 30px;
            background: #333;
            border-radius: 5px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.1s ease;
        }
        .log {
            background: #0a0a0e;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-error {
            color: #ff5555;
        }
        .log-success {
            color: #50fa7b;
        }
        .log-info {
            color: #8be9fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ PitchPro æœ€å°é™ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="status" style="background: #2a2a3e; border-left: 4px solid #f59e0b;">
            <h3>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</h3>
            <div style="font-size: 13px; line-height: 1.4;">
                <p><strong>CORSã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€ä»¥ä¸‹ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„:</strong></p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li><strong>VS Code Live Server</strong>: VS Codeã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å³ã‚¯ãƒªãƒƒã‚¯ â†’ "Open with Live Server"</li>
                    <li><strong>Python HTTP Server</strong>: <code>python -m http.server 8000</code></li>
                    <li><strong>Node.js HTTP Server</strong>: <code>npx http-server .</code></li>
                </ul>
                <p>ç›´æ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ãŸå ´åˆã€MP3ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚</p>
            </div>
        </div>
        
        <div class="status">
            <h3>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
            <div id="status">åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>

        <h2>1. åŸºéŸ³å†ç”Ÿãƒ†ã‚¹ãƒˆ (Tone.js + Salamander Piano)</h2>
        <div style="background: #2a2a3e; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
            <div style="font-size: 13px; color: #8be9fd;"><strong>â„¹ï¸ éŸ³é•·èª¿æ•´æƒ…å ±:</strong></div>
            <div style="font-size: 12px; color: #f8f8f2; margin-top: 4px;">
                â€¢ Tone.js + Salamander Pianoä½¿ç”¨ (ä»•æ§˜æ›¸æº–æ‹ )<br>
                â€¢ åŸºéŸ³å†ç”Ÿ: 2.0ç§’<br>
                â€¢ triggerAttack/triggerReleaseæ–¹å¼<br>
                â€¢ iPhoneå¯¾å¿œéŸ³é‡è¨­å®š (volume: 6)
            </div>
        </div>
        <button id="play-c4">C4 - Salamander Piano (2.0ç§’)</button>
        <button id="play-a4">A4 - ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ (1.0ç§’)</button>
        <button id="test-piano-a4">A4 - Salamander Piano (2.5ç§’)</button>
        <button id="play-scale">ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰ - Salamander Piano</button>

        <h2>2. ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆ</h2>
        <button id="init-mic">ãƒã‚¤ã‚¯åˆæœŸåŒ–</button>
        <button id="start-detection">éŸ³ç¨‹æ¤œå‡ºé–‹å§‹</button>
        <button id="stop-detection">éŸ³ç¨‹æ¤œå‡ºåœæ­¢</button>

        <div class="status">
            <h3>æ¤œå‡ºãƒ‡ãƒ¼ã‚¿</h3>
            <div>å‘¨æ³¢æ•°: <span id="frequency">--</span> Hz</div>
            <div>éŸ³å: <span id="note">--</span></div>
            <div>éŸ³é‡: <span id="volume">--</span> %</div>
        </div>

        <div class="volume-bar">
            <div class="volume-fill" id="volume-bar"></div>
        </div>

        <h3>ãƒ­ã‚°</h3>
        <div class="log" id="log"></div>
    </div>

    <!-- Tone.jsãƒ©ã‚¤ãƒ–ãƒ©ãƒª (ä»•æ§˜æ›¸æº–æ‹ ) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- pitchpro-audio UMDãƒãƒ³ãƒ‰ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="./js/pitchpro-audio/index.umd.js"></script>

    <script>
        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let audioContext = null;
        let audioManager = null;
        let pitchDetector = null;
        let isDetecting = false;
        
        // Tone.jséŸ³æºã‚·ã‚¹ãƒ†ãƒ  (ä»•æ§˜æ›¸æº–æ‹ )
        let pianoSampler = null;
        let isAudioInitialized = false;
        
        // Tone.js Salamander PianoåˆæœŸåŒ–é–¢æ•°
        async function initializeToneJS() {
            if (!isAudioInitialized) {
                try {
                    addLog('Tone.js Salamander PianoåˆæœŸåŒ–é–‹å§‹', 'info');
                    
                    // Tone.js AudioContextå†é–‹ï¼ˆiPhoneå¯¾å¿œï¼‰
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        addLog('Tone.js AudioContextå†é–‹å®Œäº†', 'success');
                    }
                    
                    // Salamander PianoåˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«éŸ³æºä½¿ç”¨ï¼‰
                    pianoSampler = new Tone.Sampler({
                        urls: {
                            "C4": "C4.mp3"
                        },
                        baseUrl: "./",  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨ï¼ˆCDNå•é¡Œå›é¿ï¼‰
                        release: 1.5,
                        volume: 6 // iPhoneéŸ³é‡å•é¡Œè§£æ±ºã®ãŸã‚ï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
                    }).toDestination();
                    
                    addLog('Salamander PianoéŸ³æºèª­ã¿è¾¼ã¿ä¸­...', 'info');
                    await Tone.loaded();
                    
                    isAudioInitialized = true;
                    addLog('âœ… Tone.js Salamander PianoåˆæœŸåŒ–å®Œäº†', 'success');
                    updateStatus('Tone.js åˆæœŸåŒ–å®Œäº† - ä»•æ§˜æ›¸æº–æ‹ è¨­å®š');
                    
                } catch (error) {
                    addLog(`âŒ Tone.jsåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    throw error;
                }
            }
        }

        // 1. åŸºéŸ³å†ç”Ÿãƒ†ã‚¹ãƒˆï¼ˆMP3ãƒ•ã‚¡ã‚¤ãƒ«ä½¿ç”¨ï¼‰
        async function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog('AudioContextåˆæœŸåŒ–å®Œäº†', 'success');
            }
            return audioContext;
        }

        async function playMP3(filepath) {
            try {
                const ctx = await initAudioContext();
                
                // MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
                addLog(`MP3ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿è©¦è¡Œ: ${filepath}`, 'info');
                const response = await fetch(filepath);
                if (!response.ok) {
                    throw new Error(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${response.status} ${response.statusText} - ${filepath}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                
                // å†ç”Ÿ
                const source = ctx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(ctx.destination);
                // 2.0ç§’é–“å†ç”Ÿï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
                source.start();
                source.stop(ctx.currentTime + 2.0);
                
                addLog(`MP3å†ç”Ÿ (2.0ç§’): ${filepath}`, 'success');
                updateStatus(`å†ç”Ÿä¸­: ${filepath.split('/').pop()}`);
                
            } catch (error) {
                addLog(`MP3å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // C4 Salamander Pianoå†ç”Ÿï¼ˆä»•æ§˜æ›¸æº–æ‹ ï¼‰
        document.getElementById('play-c4').addEventListener('click', async () => {
            await initializeToneJS();
            if (pianoSampler) {
                pianoSampler.triggerAttackRelease('C4', '2.0s');
                addLog('C4 Salamander Pianoå†ç”Ÿ (2.0ç§’)', 'success');
                updateStatus('C4 Salamander Pianoå†ç”Ÿä¸­ (ä»•æ§˜æ›¸æº–æ‹ )');
            }
        });

        // A4å†ç”Ÿï¼ˆã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã¾ã¾ï¼‰
        document.getElementById('play-a4').addEventListener('click', async () => {
            const ctx = await initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 440;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 1);
            
            addLog('A4(440Hz)å†ç”Ÿ', 'info');
        });

        // ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆæ©Ÿèƒ½ (C4.mp3ã‹ã‚‰å…¨éŸ³ç¨‹ç”Ÿæˆ)
        async function playNoteWithPitchShift(targetFreq, noteName, duration = 2.0) {
            try {
                const ctx = await initAudioContext();
                const baseFreq = 261.63; // C4ã®å‘¨æ³¢æ•°
                
                // C4.mp3ã‚’èª­ã¿è¾¼ã¿
                addLog('C4.mp3ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆç”¨ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­...', 'info');
                const response = await fetch('./C4.mp3');
                if (!response.ok) {
                    throw new Error(`C4.mp3ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${response.status} - CORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚HTTPã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                
                // ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆæ¯”ç‡è¨ˆç®— (targetFreq / baseFreq)
                const pitchRatio = targetFreq / baseFreq;
                
                // AudioBufferSourceã§ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆå®Ÿè¡Œ
                const source = ctx.createBufferSource();
                const gainNode = ctx.createGain();
                
                source.buffer = audioBuffer;
                source.playbackRate.value = pitchRatio; // ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆ
                source.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // éŸ³é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆï¼‰
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime + duration * 0.8); // 80%ã¾ã§ç¶­æŒ
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                
                // å†ç”Ÿ
                source.start(ctx.currentTime);
                source.stop(ctx.currentTime + duration);
                
                addLog(`ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆå†ç”Ÿ: ${noteName} (${baseFreq.toFixed(1)}Hz â†’ ${targetFreq.toFixed(1)}Hz, æ¯”ç‡: ${pitchRatio.toFixed(3)}x)`, 'success');
                updateStatus(`ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆå†ç”Ÿä¸­: ${noteName} (${targetFreq.toFixed(1)}Hz)`);
                
                return source; // Promiseè§£æ±ºç”¨
                
            } catch (error) {
                addLog(`ãƒ”ãƒƒãƒã‚·ãƒ•ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    addLog('ğŸš¨ CORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§: HTTPã‚µãƒ¼ãƒãƒ¼ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„', 'error');
                }
                throw error;
            }
        }
        
        // A4 Salamander Pianoãƒ†ã‚¹ãƒˆ
        document.getElementById('test-piano-a4').addEventListener('click', async () => {
            await initializeToneJS();
            if (pianoSampler) {
                pianoSampler.triggerAttackRelease('A4', '2.5s');
                addLog('A4 Salamander Pianoå†ç”Ÿ (2.5ç§’)', 'success');
                updateStatus('A4 Salamander Pianoå†ç”Ÿä¸­');
            }
        });

        // ãƒ‰ãƒ¬ãƒŸãƒ•ã‚¡ã‚½ãƒ©ã‚·ãƒ‰å†ç”Ÿï¼ˆTone.js Salamander Pianoç‰ˆï¼‰
        document.getElementById('play-scale').addEventListener('click', async () => {
            await initializeToneJS();
            if (pianoSampler) {
                const scale = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                const scaleNames = ['ãƒ‰', 'ãƒ¬', 'ãƒŸ', 'ãƒ•ã‚¡', 'ã‚½', 'ãƒ©', 'ã‚·', 'ãƒ‰'];
                
                addLog('Salamander Piano ãƒ‰ãƒ¬ãƒŸã‚¹ã‚±ãƒ¼ãƒ«å†ç”Ÿé–‹å§‹', 'info');
                
                for (let i = 0; i < scale.length; i++) {
                    setTimeout(() => {
                        pianoSampler.triggerAttackRelease(scale[i], '0.8s');
                        addLog(`${scaleNames[i]}(${scale[i]}) Salamander Pianoå†ç”Ÿ`, 'success');
                        updateStatus(`ã‚¹ã‚±ãƒ¼ãƒ«å†ç”Ÿä¸­: ${scaleNames[i]}(${scale[i]})`);
                    }, i * 1000);
                }
            }
        });

        // 2. ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆPitchProä½¿ç”¨ï¼‰
        document.getElementById('init-mic').addEventListener('click', async () => {
            try {
                addLog('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªä¸­...', 'info');
                
                if (!window.PitchPro) {
                    throw new Error('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                addLog('PitchProæ¤œå‡º: ' + Object.keys(window.PitchPro).join(', '), 'success');
                
                // AudioManageråˆæœŸåŒ–ï¼ˆAGCå®Œå…¨ç„¡åŠ¹åŒ–è¨­å®šï¼‰
                const { AudioManager, PitchDetector } = window.PitchPro;
                
                addLog('AudioManageråˆæœŸåŒ–é–‹å§‹ï¼ˆAGCç„¡åŠ¹åŒ–è¨­å®šï¼‰...', 'info');
                
                // AGCå®Œå…¨ç„¡åŠ¹åŒ–è¨­å®š
                const audioConfig = {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false,
                    // ãƒ–ãƒ©ã‚¦ã‚¶å›ºæœ‰ã®AGCç„¡åŠ¹åŒ–ï¼ˆChrome/Safariå¯¾å¿œï¼‰
                    googAutoGainControl: false,
                    googNoiseSuppression: false,
                    googEchoCancellation: false,
                    googHighpassFilter: false,
                    mozAutoGainControl: false,
                    mozNoiseSuppression: false,
                    // å®‰å®šã—ãŸé€£ç¶šæ¤œå‡ºã®ãŸã‚ã®è¨­å®š
                    sampleRate: 44100,
                    channelCount: 1,
                    latency: 0.1
                };
                
                audioManager = new AudioManager(audioConfig);
                await audioManager.initialize();
                addLog('AudioManageråˆæœŸåŒ–å®Œäº†ï¼ˆAGCç„¡åŠ¹åŒ–ï¼‰', 'success');
                
                // PitchDetectoråˆæœŸåŒ–ï¼ˆAudioManagerã‚’æ¸¡ã™ï¼‰
                addLog('PitchDetectoråˆæœŸåŒ–é–‹å§‹...', 'info');
                pitchDetector = new PitchDetector(audioManager);
                await pitchDetector.initialize();
                addLog('PitchDetectoråˆæœŸåŒ–å®Œäº†', 'success');
                
                // ãƒã‚¤ã‚¯æ„Ÿåº¦ã‚’æœ€å¤§ã«è¨­å®š
                audioManager.setSensitivity(10.0);
                addLog('ãƒã‚¤ã‚¯æ„Ÿåº¦ã‚’æœ€å¤§ï¼ˆ10.0xï¼‰ã«è¨­å®š', 'info');
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        // ãƒ‡ãƒãƒƒã‚°: å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ã‚°
                        if (result) {
                            console.log('PitchDetectorçµæœ:', result);
                            
                            document.getElementById('frequency').textContent = result.frequency ? result.frequency.toFixed(1) : '0';
                            document.getElementById('note').textContent = result.note || '--';
                            document.getElementById('volume').textContent = result.volume ? (result.volume * 100).toFixed(1) : '0';
                            
                            // éŸ³é‡ãƒãƒ¼æ›´æ–°
                            const volumePercent = Math.min(100, result.volume * 100);
                            document.getElementById('volume-bar').style.width = volumePercent + '%';
                            
                            // éŸ³é‡ãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆéŸ³ç¨‹ãŒã‚¼ãƒ­ã§ã‚‚ï¼‰
                            if (result.volume > 0.01) {
                                addLog(`éŸ³é‡æ¤œå‡º: ${(result.volume * 100).toFixed(1)}% | å‘¨æ³¢æ•°: ${result.frequency.toFixed(1)}Hz`, 'info');
                            }
                            
                            // æœ‰åŠ¹ãªéŸ³ç¨‹æ¤œå‡ºæ™‚
                            if (result.frequency > 50 && result.clarity > 0.5) {
                                addLog(`éŸ³ç¨‹æ¤œå‡º: ${result.note} ${result.frequency.toFixed(1)}Hz (æ˜ç­åº¦: ${(result.clarity * 100).toFixed(1)}%)`, 'success');
                            }
                        }
                    }
                });
                
                updateStatus('ãƒã‚¤ã‚¯åˆæœŸåŒ–å®Œäº† - éŸ³ç¨‹æ¤œå‡ºé–‹å§‹å¯èƒ½');
                document.getElementById('start-detection').disabled = false;
                
            } catch (error) {
                addLog(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('åˆæœŸåŒ–å¤±æ•—');
            }
        });

        // éŸ³ç¨‹æ¤œå‡ºé–‹å§‹
        document.getElementById('start-detection').addEventListener('click', () => {
            if (!pitchDetector) {
                addLog('å…ˆã«ãƒã‚¤ã‚¯ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            try {
                pitchDetector.startDetection();
                isDetecting = true;
                updateStatus('éŸ³ç¨‹æ¤œå‡ºä¸­... ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦å£°ã‚’å‡ºã—ã¦ãã ã•ã„');
                addLog('éŸ³ç¨‹æ¤œå‡ºé–‹å§‹', 'success');
                
                document.getElementById('start-detection').disabled = true;
                document.getElementById('stop-detection').disabled = false;
                
            } catch (error) {
                addLog(`æ¤œå‡ºé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        // éŸ³ç¨‹æ¤œå‡ºåœæ­¢
        document.getElementById('stop-detection').addEventListener('click', () => {
            if (!pitchDetector || !isDetecting) return;
            
            try {
                pitchDetector.stopDetection();
                isDetecting = false;
                updateStatus('éŸ³ç¨‹æ¤œå‡ºåœæ­¢');
                addLog('éŸ³ç¨‹æ¤œå‡ºåœæ­¢', 'info');
                
                document.getElementById('start-detection').disabled = false;
                document.getElementById('stop-detection').disabled = true;
                
                // è¡¨ç¤ºã‚¯ãƒªã‚¢
                document.getElementById('frequency').textContent = '--';
                document.getElementById('note').textContent = '--';
                document.getElementById('volume').textContent = '--';
                document.getElementById('volume-bar').style.width = '0%';
                
            } catch (error) {
                addLog(`æ¤œå‡ºåœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        // åˆæœŸçŠ¶æ…‹
        document.getElementById('start-detection').disabled = true;
        document.getElementById('stop-detection').disabled = true;
        
        addLog('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'success');
    </script>
</body>
</html>