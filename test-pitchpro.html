<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro最小限テスト</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            background: #2a2a3e;
            border-radius: 5px;
            min-height: 50px;
        }
        .volume-bar {
            height: 30px;
            background: #333;
            border-radius: 5px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 0%;
            transition: width 0.1s ease;
        }
        .log {
            background: #0a0a0e;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-error {
            color: #ff5555;
        }
        .log-success {
            color: #50fa7b;
        }
        .log-info {
            color: #8be9fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 PitchPro 最小限テスト</h1>
        
        <div class="status" style="background: #2a2a3e; border-left: 4px solid #f59e0b;">
            <h3>⚠️ 重要な注意事項</h3>
            <div style="font-size: 13px; line-height: 1.4;">
                <p><strong>CORSエラー回避のため、以下のいずれかの方法でアクセスしてください:</strong></p>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    <li><strong>VS Code Live Server</strong>: VS Codeでファイルを右クリック → "Open with Live Server"</li>
                    <li><strong>Python HTTP Server</strong>: <code>python -m http.server 8000</code></li>
                    <li><strong>Node.js HTTP Server</strong>: <code>npx http-server .</code></li>
                </ul>
                <p>直接ファイルをブラウザで開いた場合、MP3ファイルが読み込めません。</p>
            </div>
        </div>
        
        <div class="status">
            <h3>ステータス</h3>
            <div id="status">初期化されていません</div>
        </div>

        <h2>1. 基音再生テスト (Tone.js + Salamander Piano)</h2>
        <div style="background: #2a2a3e; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
            <div style="font-size: 13px; color: #8be9fd;"><strong>ℹ️ 音長調整情報:</strong></div>
            <div style="font-size: 12px; color: #f8f8f2; margin-top: 4px;">
                • Tone.js + Salamander Piano使用 (仕様書準拠)<br>
                • 基音再生: 2.0秒<br>
                • triggerAttack/triggerRelease方式<br>
                • iPhone対応音量設定 (volume: 6)
            </div>
        </div>
        <button id="play-c4">C4 - Salamander Piano (2.0秒)</button>
        <button id="play-a4">A4 - オシレーター (1.0秒)</button>
        <button id="test-piano-a4">A4 - Salamander Piano (2.5秒)</button>
        <button id="play-scale">ドレミファソラシド - Salamander Piano</button>

        <h2>2. マイクテスト</h2>
        <button id="init-mic">マイク初期化</button>
        <button id="start-detection">音程検出開始</button>
        <button id="stop-detection">音程検出停止</button>

        <div class="status">
            <h3>検出データ</h3>
            <div>周波数: <span id="frequency">--</span> Hz</div>
            <div>音名: <span id="note">--</span></div>
            <div>音量: <span id="volume">--</span> %</div>
        </div>

        <div class="volume-bar">
            <div class="volume-fill" id="volume-bar"></div>
        </div>

        <h3>ログ</h3>
        <div class="log" id="log"></div>
    </div>

    <!-- Tone.jsライブラリ (仕様書準拠) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- pitchpro-audio UMDバンドル読み込み -->
    <script src="./js/pitchpro-audio/index.umd.js"></script>

    <script>
        // ログ出力関数
        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // ステータス更新
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // グローバル変数
        let audioContext = null;
        let audioManager = null;
        let pitchDetector = null;
        let isDetecting = false;
        
        // Tone.js音源システム (仕様書準拠)
        let pianoSampler = null;
        let isAudioInitialized = false;
        
        // Tone.js Salamander Piano初期化関数
        async function initializeToneJS() {
            if (!isAudioInitialized) {
                try {
                    addLog('Tone.js Salamander Piano初期化開始', 'info');
                    
                    // Tone.js AudioContext再開（iPhone対応）
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                        addLog('Tone.js AudioContext再開完了', 'success');
                    }
                    
                    // Salamander Piano初期化（ローカル音源使用）
                    pianoSampler = new Tone.Sampler({
                        urls: {
                            "C4": "C4.mp3"
                        },
                        baseUrl: "./",  // ローカルファイル使用（CDN問題回避）
                        release: 1.5,
                        volume: 6 // iPhone音量問題解決のため（仕様書準拠）
                    }).toDestination();
                    
                    addLog('Salamander Piano音源読み込み中...', 'info');
                    await Tone.loaded();
                    
                    isAudioInitialized = true;
                    addLog('✅ Tone.js Salamander Piano初期化完了', 'success');
                    updateStatus('Tone.js 初期化完了 - 仕様書準拠設定');
                    
                } catch (error) {
                    addLog(`❌ Tone.js初期化エラー: ${error.message}`, 'error');
                    throw error;
                }
            }
        }

        // 1. 基音再生テスト（MP3ファイル使用）
        async function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                addLog('AudioContext初期化完了', 'success');
            }
            return audioContext;
        }

        async function playMP3(filepath) {
            try {
                const ctx = await initAudioContext();
                
                // MP3ファイルを読み込み
                addLog(`MP3ファイル読み込み試行: ${filepath}`, 'info');
                const response = await fetch(filepath);
                if (!response.ok) {
                    throw new Error(`ファイル読み込み失敗: ${response.status} ${response.statusText} - ${filepath}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                
                // 再生
                const source = ctx.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(ctx.destination);
                // 2.0秒間再生（仕様書準拠）
                source.start();
                source.stop(ctx.currentTime + 2.0);
                
                addLog(`MP3再生 (2.0秒): ${filepath}`, 'success');
                updateStatus(`再生中: ${filepath.split('/').pop()}`);
                
            } catch (error) {
                addLog(`MP3再生エラー: ${error.message}`, 'error');
            }
        }

        // C4 Salamander Piano再生（仕様書準拠）
        document.getElementById('play-c4').addEventListener('click', async () => {
            await initializeToneJS();
            if (pianoSampler) {
                pianoSampler.triggerAttackRelease('C4', '2.0s');
                addLog('C4 Salamander Piano再生 (2.0秒)', 'success');
                updateStatus('C4 Salamander Piano再生中 (仕様書準拠)');
            }
        });

        // A4再生（オシレーターのまま）
        document.getElementById('play-a4').addEventListener('click', async () => {
            const ctx = await initAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            
            oscillator.frequency.value = 440;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 1);
            
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 1);
            
            addLog('A4(440Hz)再生', 'info');
        });

        // ピッチシフト機能 (C4.mp3から全音程生成)
        async function playNoteWithPitchShift(targetFreq, noteName, duration = 2.0) {
            try {
                const ctx = await initAudioContext();
                const baseFreq = 261.63; // C4の周波数
                
                // C4.mp3を読み込み
                addLog('C4.mp3ピッチシフト用ファイル読み込み中...', 'info');
                const response = await fetch('./C4.mp3');
                if (!response.ok) {
                    throw new Error(`C4.mp3ファイル読み込み失敗: ${response.status} - CORSエラーの可能性があります。HTTPサーバー経由でアクセスしてください。`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await ctx.decodeAudioData(arrayBuffer);
                
                // ピッチシフト比率計算 (targetFreq / baseFreq)
                const pitchRatio = targetFreq / baseFreq;
                
                // AudioBufferSourceでピッチシフト実行
                const source = ctx.createBufferSource();
                const gainNode = ctx.createGain();
                
                source.buffer = audioBuffer;
                source.playbackRate.value = pitchRatio; // ピッチシフト
                source.connect(gainNode);
                gainNode.connect(ctx.destination);
                
                // 音量コントロール（より自然なフェードアウト）
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
                gainNode.gain.setValueAtTime(0.5, ctx.currentTime + duration * 0.8); // 80%まで維持
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                
                // 再生
                source.start(ctx.currentTime);
                source.stop(ctx.currentTime + duration);
                
                addLog(`ピッチシフト再生: ${noteName} (${baseFreq.toFixed(1)}Hz → ${targetFreq.toFixed(1)}Hz, 比率: ${pitchRatio.toFixed(3)}x)`, 'success');
                updateStatus(`ピッチシフト再生中: ${noteName} (${targetFreq.toFixed(1)}Hz)`);
                
                return source; // Promise解決用
                
            } catch (error) {
                addLog(`ピッチシフトエラー: ${error.message}`, 'error');
                if (error.message.includes('CORS') || error.message.includes('fetch')) {
                    addLog('🚨 CORSエラーの可能性: HTTPサーバーでアクセスしてください', 'error');
                }
                throw error;
            }
        }
        
        // A4 Salamander Pianoテスト
        document.getElementById('test-piano-a4').addEventListener('click', async () => {
            await initializeToneJS();
            if (pianoSampler) {
                pianoSampler.triggerAttackRelease('A4', '2.5s');
                addLog('A4 Salamander Piano再生 (2.5秒)', 'success');
                updateStatus('A4 Salamander Piano再生中');
            }
        });

        // ドレミファソラシド再生（Tone.js Salamander Piano版）
        document.getElementById('play-scale').addEventListener('click', async () => {
            await initializeToneJS();
            if (pianoSampler) {
                const scale = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
                const scaleNames = ['ド', 'レ', 'ミ', 'ファ', 'ソ', 'ラ', 'シ', 'ド'];
                
                addLog('Salamander Piano ドレミスケール再生開始', 'info');
                
                for (let i = 0; i < scale.length; i++) {
                    setTimeout(() => {
                        pianoSampler.triggerAttackRelease(scale[i], '0.8s');
                        addLog(`${scaleNames[i]}(${scale[i]}) Salamander Piano再生`, 'success');
                        updateStatus(`スケール再生中: ${scaleNames[i]}(${scale[i]})`);
                    }, i * 1000);
                }
            }
        });

        // 2. マイクテスト（PitchPro使用）
        document.getElementById('init-mic').addEventListener('click', async () => {
            try {
                addLog('PitchProライブラリ確認中...', 'info');
                
                if (!window.PitchPro) {
                    throw new Error('PitchProライブラリが読み込まれていません');
                }
                
                addLog('PitchPro検出: ' + Object.keys(window.PitchPro).join(', '), 'success');
                
                // AudioManager初期化（AGC完全無効化設定）
                const { AudioManager, PitchDetector } = window.PitchPro;
                
                addLog('AudioManager初期化開始（AGC無効化設定）...', 'info');
                
                // AGC完全無効化設定
                const audioConfig = {
                    echoCancellation: false,
                    noiseSuppression: false,
                    autoGainControl: false,
                    // ブラウザ固有のAGC無効化（Chrome/Safari対応）
                    googAutoGainControl: false,
                    googNoiseSuppression: false,
                    googEchoCancellation: false,
                    googHighpassFilter: false,
                    mozAutoGainControl: false,
                    mozNoiseSuppression: false,
                    // 安定した連続検出のための設定
                    sampleRate: 44100,
                    channelCount: 1,
                    latency: 0.1
                };
                
                audioManager = new AudioManager(audioConfig);
                await audioManager.initialize();
                addLog('AudioManager初期化完了（AGC無効化）', 'success');
                
                // PitchDetector初期化（AudioManagerを渡す）
                addLog('PitchDetector初期化開始...', 'info');
                pitchDetector = new PitchDetector(audioManager);
                await pitchDetector.initialize();
                addLog('PitchDetector初期化完了', 'success');
                
                // マイク感度を最大に設定
                audioManager.setSensitivity(10.0);
                addLog('マイク感度を最大（10.0x）に設定', 'info');
                
                // コールバック設定
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        // デバッグ: 全データをログ
                        if (result) {
                            console.log('PitchDetector結果:', result);
                            
                            document.getElementById('frequency').textContent = result.frequency ? result.frequency.toFixed(1) : '0';
                            document.getElementById('note').textContent = result.note || '--';
                            document.getElementById('volume').textContent = result.volume ? (result.volume * 100).toFixed(1) : '0';
                            
                            // 音量バー更新
                            const volumePercent = Math.min(100, result.volume * 100);
                            document.getElementById('volume-bar').style.width = volumePercent + '%';
                            
                            // 音量があれば表示（音程がゼロでも）
                            if (result.volume > 0.01) {
                                addLog(`音量検出: ${(result.volume * 100).toFixed(1)}% | 周波数: ${result.frequency.toFixed(1)}Hz`, 'info');
                            }
                            
                            // 有効な音程検出時
                            if (result.frequency > 50 && result.clarity > 0.5) {
                                addLog(`音程検出: ${result.note} ${result.frequency.toFixed(1)}Hz (明瞭度: ${(result.clarity * 100).toFixed(1)}%)`, 'success');
                            }
                        }
                    }
                });
                
                updateStatus('マイク初期化完了 - 音程検出開始可能');
                document.getElementById('start-detection').disabled = false;
                
            } catch (error) {
                addLog(`エラー: ${error.message}`, 'error');
                updateStatus('初期化失敗');
            }
        });

        // 音程検出開始
        document.getElementById('start-detection').addEventListener('click', () => {
            if (!pitchDetector) {
                addLog('先にマイクを初期化してください', 'error');
                return;
            }
            
            try {
                pitchDetector.startDetection();
                isDetecting = true;
                updateStatus('音程検出中... マイクに向かって声を出してください');
                addLog('音程検出開始', 'success');
                
                document.getElementById('start-detection').disabled = true;
                document.getElementById('stop-detection').disabled = false;
                
            } catch (error) {
                addLog(`検出開始エラー: ${error.message}`, 'error');
            }
        });

        // 音程検出停止
        document.getElementById('stop-detection').addEventListener('click', () => {
            if (!pitchDetector || !isDetecting) return;
            
            try {
                pitchDetector.stopDetection();
                isDetecting = false;
                updateStatus('音程検出停止');
                addLog('音程検出停止', 'info');
                
                document.getElementById('start-detection').disabled = false;
                document.getElementById('stop-detection').disabled = true;
                
                // 表示クリア
                document.getElementById('frequency').textContent = '--';
                document.getElementById('note').textContent = '--';
                document.getElementById('volume').textContent = '--';
                document.getElementById('volume-bar').style.width = '0%';
                
            } catch (error) {
                addLog(`検出停止エラー: ${error.message}`, 'error');
            }
        });

        // 初期状態
        document.getElementById('start-detection').disabled = true;
        document.getElementById('stop-detection').disabled = true;
        
        addLog('ページ読み込み完了 - テスト準備完了', 'success');
    </script>
</body>
</html>