<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioDetectionComponent統合テスト - 8va相対音感トレーニング</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <link rel="stylesheet" href="Bolt/v2/styles/results.css">
    <link rel="stylesheet" href="Bolt/v2/styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">AudioDetectionComponent統合テスト</h1>
                    <p class="page-subtitle text-green-200">新しいPitchPro統合音声処理システム</p>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="narrow-main">
            <!-- ステータス表示 -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: マイク許可 -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">マイク許可</p>
                    </div>
                    
                    <!-- 接続線 -->
                    <div class="step-connector" id="connector-1"></div>
                    
                    <!-- Step 2: 音声テスト -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">音声テスト</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- マイク許可セクション -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">AudioDetectionComponent初期化</h3>
                        <p class="section-description">音程検出のためマイクロフォンへのアクセスが必要です</p>
                    </div>
                    
                    <div class="info-alert">
                        <i data-lucide="shield-check" style="width: 48px; height: 48px; color: #60a5fa;"></i>
                        <p>音声データは外部に送信されません。ブラウザ内でリアルタイム処理されます。</p>
                    </div>
                    
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>マイクを許可</span>
                    </button>
                </section>

                <!-- 音声テストセクション -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">音声テスト</h3>
                        <p class="section-description">AudioDetectionComponentによる音量と周波数検出を確認します</p>
                    </div>
                    
                    <div class="voice-instruction">
                        <div class="voice-instruction-icon">
                            <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                        </div>
                        <p class="voice-instruction-text" id="voice-instruction-text">「ド」を発声してください</p>
                        <div class="voice-instruction-pulse"></div>
                    </div>
                    
                    <!-- 音量レベル -->
                    <div class="detection-meters" style="margin-top: 20px;">
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>音量レベル</span>
                                <span class="meter-value" id="volume-value">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%;"></div>
                            </div>
                        </div>

                        <!-- 検出周波数 -->
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>検出周波数</span>
                                <span class="meter-value" id="frequency-value">0 Hz</span>
                            </div>
                        </div>

                        <!-- 音程 -->
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>音程</span>
                                <span class="meter-value" id="note-display">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- 進捗表示 -->
                    <div class="progress-display hidden" id="progress-display">
                        <div class="progress-text" id="progress-text">初期化中...</div>
                        <div class="progress-detail" id="progress-detail"></div>
                    </div>

                    <!-- 成功表示 -->
                    <div class="detection-success hidden" id="detection-success">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <span>音声検出成功！</span>
                    </div>

                    <!-- テスト完了 -->
                    <div class="text-center mt-4">
                        <button class="btn btn-success hidden" id="test-complete-btn">
                            <span>テスト完了</span>
                            <i data-lucide="check" style="width: 20px; height: 20px;"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- スクリプト -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>

    <script>
        // DOMロード後の初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📦 DOM Content Loaded');
            
            // Lucideアイコン初期化
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log('✅ Lucide icons initialized');
            }

            // AudioDetectionComponent読み込み待機
            let attempts = 0;
            const maxAttempts = 20;
            
            while (attempts < maxAttempts && !window.PitchPro) {
                console.log(`⏳ AudioDetectionComponent読み込み待機... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            console.log('🔍 PitchPro availability:', !!window.PitchPro);
            if (window.PitchPro) {
                console.log('🔍 PitchPro keys:', Object.keys(window.PitchPro));
            }

            // システム変数
            let audioDetector = null;
            let isAudioTesting = false;
            let detectedVoice = false;

            // DOM要素
            const requestMicBtn = document.getElementById('request-mic-btn');
            const permissionSection = document.getElementById('permission-section');
            const audioTestSection = document.getElementById('audio-test-section');
            const detectionSuccess = document.getElementById('detection-success');
            const testCompleteBtn = document.getElementById('test-complete-btn');
            const progressDisplay = document.getElementById('progress-display');
            const progressText = document.getElementById('progress-text');
            const progressDetail = document.getElementById('progress-detail');

            // ステップインジケーター更新
            function updateStepStatus(stepNumber, status) {
                const step = document.getElementById(`step-${stepNumber}`);
                const connector = document.getElementById(`connector-${stepNumber}`);
                
                if (!step) return;
                
                step.classList.remove('active', 'completed', 'pending');
                if (connector) {
                    connector.classList.remove('active', 'completed');
                }
                
                step.classList.add(status);
                if (connector && status === 'completed') {
                    connector.classList.add('completed');
                }
                
                if (status === 'active' && connector) {
                    connector.classList.add('active');
                }
            }

            // セクション表示切り替え
            function showSection(targetSection) {
                [permissionSection, audioTestSection].forEach(section => {
                    if (section) {
                        section.classList.add('hidden');
                    }
                });
                
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
            }

            // エラーメッセージ表示
            function showErrorMessage(message) {
                console.error('❌ エラー:', message);
                alert(`エラー: ${message}`);
            }

            // 進捗表示更新
            function updateProgressDisplay(mainText, detailText) {
                if (progressDisplay) {
                    progressDisplay.classList.remove('hidden');
                }
                if (progressText) {
                    progressText.textContent = mainText;
                }
                if (progressDetail) {
                    progressDetail.textContent = detailText;
                }
            }

            // AudioDetectionComponent初期化
            async function initializeAudioDetection() {
                try {
                    console.log('🎤 AudioDetectionComponent初期化開始');
                    requestMicBtn.disabled = true;
                    requestMicBtn.innerHTML = '<i data-lucide="loader" style="width: 24px; height: 24px;"></i><span>初期化中...</span>';
                    lucide.createIcons();
                    
                    if (!window.PitchPro) {
                        throw new Error('PitchProライブラリが読み込まれていません');
                    }

                    const { AudioDetectionComponent } = window.PitchPro;
                    
                    if (!AudioDetectionComponent) {
                        throw new Error('AudioDetectionComponentクラスが見つかりません');
                    }

                    // AudioDetectionComponent初期化
                    audioDetector = new AudioDetectionComponent({
                        // UI要素セレクター
                        volumeBarSelector: '#volume-progress',
                        volumeTextSelector: '#volume-value', 
                        frequencySelector: '#frequency-value',
                        noteSelector: '#note-display',
                        
                        // 検出設定
                        clarityThreshold: 0.4,
                        minVolumeAbsolute: 0.003,
                        
                        // デバイス最適化（自動）
                        deviceOptimization: true,
                        
                        // UI更新レート
                        uiUpdateInterval: 50, // 20fps
                        
                        // デバッグ
                        debug: true,
                        logPrefix: '🎵 AudioTest'
                    });

                    // コールバック設定
                    audioDetector.setCallbacks({
                        onPitchUpdate: (result) => {
                            if (!isAudioTesting) return;
                            
                            const { frequency, note, volume } = result;
                            
                            console.log(`🎵 検出: ${note} (${frequency.toFixed(1)}Hz) 音量: ${volume.toFixed(1)}%`);
                            
                            // 音声検出チェック
                            if (frequency >= 80 && frequency <= 400 && volume >= 15) {
                                if (!detectedVoice) {
                                    detectedVoice = true;
                                    updateProgressDisplay('声を検出しました！', `${frequency.toFixed(1)}Hz - 安定した音声を検出中`);
                                    
                                    setTimeout(() => {
                                        completeAudioTest();
                                    }, 2000);
                                }
                            }
                        },
                        onVolumeUpdate: (volume) => {
                            // 音量更新（UIは自動更新される）
                        },
                        onStateChange: (state) => {
                            console.log('状態変更:', state);
                        },
                        onError: (error) => {
                            console.error('エラー:', error.message);
                            showErrorMessage(`音声検出エラー: ${error.message}`);
                        },
                        onDeviceDetected: (specs) => {
                            console.log('デバイス検出:', specs.deviceType, '感度:', specs.deviceConfig.sensitivity);
                        }
                    });

                    await audioDetector.initialize();
                    console.log('✅ AudioDetectionComponent初期化完了');
                    
                    updateStepStatus(1, 'completed');
                    updateStepStatus(2, 'active');
                    
                    showSection(audioTestSection);
                    startAudioTest();
                    
                } catch (error) {
                    console.error('❌ 初期化エラー:', error);
                    showErrorMessage(`初期化に失敗: ${error.message}`);
                    
                    requestMicBtn.disabled = false;
                    requestMicBtn.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>マイクを許可</span>';
                    lucide.createIcons();
                }
            }

            // 音声テスト開始
            function startAudioTest() {
                if (!audioDetector) {
                    console.error('❌ AudioDetector未初期化');
                    return;
                }
                
                isAudioTesting = true;
                detectedVoice = false;
                
                audioDetector.startDetection();
                console.log('🎵 音声テスト開始');
                updateProgressDisplay('声を出してください', '「ド」の音程で発声してください');
                
                // 15秒タイマー
                setTimeout(() => {
                    if (isAudioTesting && !detectedVoice) {
                        updateProgressDisplay('時間切れ', 'もう一度試してください');
                        setTimeout(() => {
                            startAudioTest();
                        }, 2000);
                    }
                }, 15000);
            }

            // 音声テスト完了
            function completeAudioTest() {
                isAudioTesting = false;
                
                if (audioDetector) {
                    audioDetector.stopDetection();
                    console.log('🎵 AudioDetector停止完了');
                }
                
                console.log('✅ 音声テスト完了');
                
                // 成功メッセージ表示
                if (detectionSuccess) {
                    detectionSuccess.classList.remove('hidden');
                }
                
                // 進捗表示を隠す
                if (progressDisplay) {
                    progressDisplay.classList.add('hidden');
                }
                
                // 完了ボタン表示
                if (testCompleteBtn) {
                    testCompleteBtn.classList.remove('hidden');
                }
                
                updateStepStatus(2, 'completed');
            }

            // イベントリスナー設定
            if (requestMicBtn) {
                requestMicBtn.addEventListener('click', initializeAudioDetection);
            }

            if (testCompleteBtn) {
                testCompleteBtn.addEventListener('click', () => {
                    console.log('🎉 テスト完了');
                    alert('AudioDetectionComponentテストが完了しました！');
                });
            }

            console.log('📄 AudioDetectionComponent統合テストページ準備完了');
        });
    </script>
</body>
</html>