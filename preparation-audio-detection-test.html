<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioDetectionComponentçµ±åˆãƒ†ã‚¹ãƒˆ - 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <link rel="stylesheet" href="Bolt/v2/styles/results.css">
    <link rel="stylesheet" href="Bolt/v2/styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">AudioDetectionComponentçµ±åˆãƒ†ã‚¹ãƒˆ</h1>
                    <p class="page-subtitle text-green-200">æ–°ã—ã„PitchProçµ±åˆéŸ³å£°å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: ãƒã‚¤ã‚¯è¨±å¯ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">ãƒã‚¤ã‚¯è¨±å¯</p>
                    </div>
                    
                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-1"></div>
                    
                    <!-- Step 2: éŸ³å£°ãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³å£°ãƒ†ã‚¹ãƒˆ</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- ãƒã‚¤ã‚¯è¨±å¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">AudioDetectionComponentåˆæœŸåŒ–</h3>
                        <p class="section-description">éŸ³ç¨‹æ¤œå‡ºã®ãŸã‚ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</p>
                    </div>
                    
                    <div class="info-alert">
                        <i data-lucide="shield-check" style="width: 48px; height: 48px; color: #60a5fa;"></i>
                        <p>éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>
                    </button>
                </section>

                <!-- éŸ³å£°ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">éŸ³å£°ãƒ†ã‚¹ãƒˆ</h3>
                        <p class="section-description">AudioDetectionComponentã«ã‚ˆã‚‹éŸ³é‡ã¨å‘¨æ³¢æ•°æ¤œå‡ºã‚’ç¢ºèªã—ã¾ã™</p>
                    </div>
                    
                    <div class="voice-instruction">
                        <div class="voice-instruction-icon">
                            <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                        </div>
                        <p class="voice-instruction-text" id="voice-instruction-text">ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„</p>
                        <div class="voice-instruction-pulse"></div>
                    </div>
                    
                    <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                    <div class="detection-meters" style="margin-top: 20px;">
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                                <span class="meter-value" id="volume-value">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%;"></div>
                            </div>
                        </div>

                        <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                                <span class="meter-value" id="frequency-value">0 Hz</span>
                            </div>
                        </div>

                        <!-- éŸ³ç¨‹ -->
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>éŸ³ç¨‹</span>
                                <span class="meter-value" id="note-display">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- é€²æ—è¡¨ç¤º -->
                    <div class="progress-display hidden" id="progress-display">
                        <div class="progress-text" id="progress-text">åˆæœŸåŒ–ä¸­...</div>
                        <div class="progress-detail" id="progress-detail"></div>
                    </div>

                    <!-- æˆåŠŸè¡¨ç¤º -->
                    <div class="detection-success hidden" id="detection-success">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <span>éŸ³å£°æ¤œå‡ºæˆåŠŸï¼</span>
                    </div>

                    <!-- ãƒ†ã‚¹ãƒˆå®Œäº† -->
                    <div class="text-center mt-4">
                        <button class="btn btn-success hidden" id="test-complete-btn">
                            <span>ãƒ†ã‚¹ãƒˆå®Œäº†</span>
                            <i data-lucide="check" style="width: 20px; height: 20px;"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>

    <script>
        // DOMãƒ­ãƒ¼ãƒ‰å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ“¦ DOM Content Loaded');
            
            // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log('âœ… Lucide icons initialized');
            }

            // AudioDetectionComponentèª­ã¿è¾¼ã¿å¾…æ©Ÿ
            let attempts = 0;
            const maxAttempts = 20;
            
            while (attempts < maxAttempts && !window.PitchPro) {
                console.log(`â³ AudioDetectionComponentèª­ã¿è¾¼ã¿å¾…æ©Ÿ... (${attempts + 1}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }

            console.log('ğŸ” PitchPro availability:', !!window.PitchPro);
            if (window.PitchPro) {
                console.log('ğŸ” PitchPro keys:', Object.keys(window.PitchPro));
            }

            // ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°
            let audioDetector = null;
            let isAudioTesting = false;
            let detectedVoice = false;

            // DOMè¦ç´ 
            const requestMicBtn = document.getElementById('request-mic-btn');
            const permissionSection = document.getElementById('permission-section');
            const audioTestSection = document.getElementById('audio-test-section');
            const detectionSuccess = document.getElementById('detection-success');
            const testCompleteBtn = document.getElementById('test-complete-btn');
            const progressDisplay = document.getElementById('progress-display');
            const progressText = document.getElementById('progress-text');
            const progressDetail = document.getElementById('progress-detail');

            // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
            function updateStepStatus(stepNumber, status) {
                const step = document.getElementById(`step-${stepNumber}`);
                const connector = document.getElementById(`connector-${stepNumber}`);
                
                if (!step) return;
                
                step.classList.remove('active', 'completed', 'pending');
                if (connector) {
                    connector.classList.remove('active', 'completed');
                }
                
                step.classList.add(status);
                if (connector && status === 'completed') {
                    connector.classList.add('completed');
                }
                
                if (status === 'active' && connector) {
                    connector.classList.add('active');
                }
            }

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            function showSection(targetSection) {
                [permissionSection, audioTestSection].forEach(section => {
                    if (section) {
                        section.classList.add('hidden');
                    }
                });
                
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                }
            }

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            function showErrorMessage(message) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼:', message);
                alert(`ã‚¨ãƒ©ãƒ¼: ${message}`);
            }

            // é€²æ—è¡¨ç¤ºæ›´æ–°
            function updateProgressDisplay(mainText, detailText) {
                if (progressDisplay) {
                    progressDisplay.classList.remove('hidden');
                }
                if (progressText) {
                    progressText.textContent = mainText;
                }
                if (progressDetail) {
                    progressDetail.textContent = detailText;
                }
            }

            // AudioDetectionComponentåˆæœŸåŒ–
            async function initializeAudioDetection() {
                try {
                    console.log('ğŸ¤ AudioDetectionComponentåˆæœŸåŒ–é–‹å§‹');
                    requestMicBtn.disabled = true;
                    requestMicBtn.innerHTML = '<i data-lucide="loader" style="width: 24px; height: 24px;"></i><span>åˆæœŸåŒ–ä¸­...</span>';
                    lucide.createIcons();
                    
                    if (!window.PitchPro) {
                        throw new Error('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    }

                    const { AudioDetectionComponent } = window.PitchPro;
                    
                    if (!AudioDetectionComponent) {
                        throw new Error('AudioDetectionComponentã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }

                    // AudioDetectionComponentåˆæœŸåŒ–
                    audioDetector = new AudioDetectionComponent({
                        // UIè¦ç´ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
                        volumeBarSelector: '#volume-progress',
                        volumeTextSelector: '#volume-value', 
                        frequencySelector: '#frequency-value',
                        noteSelector: '#note-display',
                        
                        // æ¤œå‡ºè¨­å®š
                        clarityThreshold: 0.4,
                        minVolumeAbsolute: 0.003,
                        
                        // ãƒ‡ãƒã‚¤ã‚¹æœ€é©åŒ–ï¼ˆè‡ªå‹•ï¼‰
                        deviceOptimization: true,
                        
                        // UIæ›´æ–°ãƒ¬ãƒ¼ãƒˆ
                        uiUpdateInterval: 50, // 20fps
                        
                        // ãƒ‡ãƒãƒƒã‚°
                        debug: true,
                        logPrefix: 'ğŸµ AudioTest'
                    });

                    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                    audioDetector.setCallbacks({
                        onPitchUpdate: (result) => {
                            if (!isAudioTesting) return;
                            
                            const { frequency, note, volume } = result;
                            
                            console.log(`ğŸµ æ¤œå‡º: ${note} (${frequency.toFixed(1)}Hz) éŸ³é‡: ${volume.toFixed(1)}%`);
                            
                            // éŸ³å£°æ¤œå‡ºãƒã‚§ãƒƒã‚¯
                            if (frequency >= 80 && frequency <= 400 && volume >= 15) {
                                if (!detectedVoice) {
                                    detectedVoice = true;
                                    updateProgressDisplay('å£°ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼', `${frequency.toFixed(1)}Hz - å®‰å®šã—ãŸéŸ³å£°ã‚’æ¤œå‡ºä¸­`);
                                    
                                    setTimeout(() => {
                                        completeAudioTest();
                                    }, 2000);
                                }
                            }
                        },
                        onVolumeUpdate: (volume) => {
                            // éŸ³é‡æ›´æ–°ï¼ˆUIã¯è‡ªå‹•æ›´æ–°ã•ã‚Œã‚‹ï¼‰
                        },
                        onStateChange: (state) => {
                            console.log('çŠ¶æ…‹å¤‰æ›´:', state);
                        },
                        onError: (error) => {
                            console.error('ã‚¨ãƒ©ãƒ¼:', error.message);
                            showErrorMessage(`éŸ³å£°æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
                        },
                        onDeviceDetected: (specs) => {
                            console.log('ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º:', specs.deviceType, 'æ„Ÿåº¦:', specs.deviceConfig.sensitivity);
                        }
                    });

                    await audioDetector.initialize();
                    console.log('âœ… AudioDetectionComponentåˆæœŸåŒ–å®Œäº†');
                    
                    updateStepStatus(1, 'completed');
                    updateStepStatus(2, 'active');
                    
                    showSection(audioTestSection);
                    startAudioTest();
                    
                } catch (error) {
                    console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    showErrorMessage(`åˆæœŸåŒ–ã«å¤±æ•—: ${error.message}`);
                    
                    requestMicBtn.disabled = false;
                    requestMicBtn.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>';
                    lucide.createIcons();
                }
            }

            // éŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹
            function startAudioTest() {
                if (!audioDetector) {
                    console.error('âŒ AudioDetectoræœªåˆæœŸåŒ–');
                    return;
                }
                
                isAudioTesting = true;
                detectedVoice = false;
                
                audioDetector.startDetection();
                console.log('ğŸµ éŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹');
                updateProgressDisplay('å£°ã‚’å‡ºã—ã¦ãã ã•ã„', 'ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã§ç™ºå£°ã—ã¦ãã ã•ã„');
                
                // 15ç§’ã‚¿ã‚¤ãƒãƒ¼
                setTimeout(() => {
                    if (isAudioTesting && !detectedVoice) {
                        updateProgressDisplay('æ™‚é–“åˆ‡ã‚Œ', 'ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„');
                        setTimeout(() => {
                            startAudioTest();
                        }, 2000);
                    }
                }, 15000);
            }

            // éŸ³å£°ãƒ†ã‚¹ãƒˆå®Œäº†
            function completeAudioTest() {
                isAudioTesting = false;
                
                if (audioDetector) {
                    audioDetector.stopDetection();
                    console.log('ğŸµ AudioDetectoråœæ­¢å®Œäº†');
                }
                
                console.log('âœ… éŸ³å£°ãƒ†ã‚¹ãƒˆå®Œäº†');
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                if (detectionSuccess) {
                    detectionSuccess.classList.remove('hidden');
                }
                
                // é€²æ—è¡¨ç¤ºã‚’éš ã™
                if (progressDisplay) {
                    progressDisplay.classList.add('hidden');
                }
                
                // å®Œäº†ãƒœã‚¿ãƒ³è¡¨ç¤º
                if (testCompleteBtn) {
                    testCompleteBtn.classList.remove('hidden');
                }
                
                updateStepStatus(2, 'completed');
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            if (requestMicBtn) {
                requestMicBtn.addEventListener('click', initializeAudioDetection);
            }

            if (testCompleteBtn) {
                testCompleteBtn.addEventListener('click', () => {
                    console.log('ğŸ‰ ãƒ†ã‚¹ãƒˆå®Œäº†');
                    alert('AudioDetectionComponentãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                });
            }

            console.log('ğŸ“„ AudioDetectionComponentçµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†');
        });
    </script>
</body>
</html>