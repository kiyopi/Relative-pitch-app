<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>8va相対音感トレーニング - セッション評価</title>
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/results.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex justify-center mb-6">
                    <div class="page-header-icon" style="width: 6rem; height: 6rem; border-radius: 50%; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="circle-check-big" class="icon-2xl text-white"></i>
                    </div>
                </div>
                <h1 class="text-4xl font-bold text-white mb-4">セッション 1 完了！</h1>
                <p class="text-green-200 text-xl mb-6">基音 C4 - 8音の評価結果</p>
            </div>

            <!-- 進行バー -->
            <div class="glass-card">
                <div class="progress-section completed">
                    <div class="progress-content">
                        <div class="progress-bar with-margin">
                            <div class="progress-fill gradient-catalog-blue" style="width: 25%;"></div>
                        </div>
                        <div class="progress-label">セッション 2 / 8</div>
                    </div>
                    <a href="training.html" class="btn btn-primary progress-action">
                        <i data-lucide="arrow-right" class="icon-sm mr-2"></i>
                        <span>次の基音へ</span>
                    </a>
                </div>
            </div>

            <!-- セッション概要 -->
            <div class="glass-card mb-8">
                <div class="text-center mb-10 pb-8 border-b border-white/10">
                    <div class="flex flex-col gap-6 items-center">
                        <!-- トロフィーアイコン（中央） -->
                        <div class="trophy-section flex flex-col items-center text-center justify-end">
                            <div>
                                <div class="accuracy-badge accuracy-badge-excellent relative">
                                    <i data-lucide="trophy" class="text-yellow-300 accuracy-icon"></i>
                                    <!-- 精度ランク説明アイコン -->
                                    <button class="rank-info-btn help-btn-position" onclick="toggleRankPopover()">
                                        <i data-lucide="help-circle" class="text-white icon-xs"></i>
                                    </button>
                                    
                                    <!-- 精度ランク説明ポップオーバー -->
                                    <div id="rank-popover" class="rank-popover">
                                        <h4 class="popover-title">精度ランク</h4>
                                        
                                        <div class="rank-item">
                                            <i data-lucide="trophy" class="text-yellow-300 icon-md shrink-0"></i>
                                            <div>
                                                <div class="rank-name rank-name-excellent">Excellent</div>
                                                <div class="rank-range">±15セント以内</div>
                                            </div>
                                        </div>
                                        
                                        <div class="rank-item">
                                            <i data-lucide="star" class="text-green-300 icon-md shrink-0"></i>
                                            <div>
                                                <div class="rank-name rank-name-good">Good</div>
                                                <div class="rank-range">15～25セント</div>
                                            </div>
                                        </div>
                                        
                                        <div class="rank-item">
                                            <i data-lucide="thumbs-up" class="text-blue-300 icon-md shrink-0"></i>
                                            <div>
                                                <div class="rank-name rank-name-pass">Pass</div>
                                                <div class="rank-range">25～40セント</div>
                                            </div>
                                        </div>
                                        
                                        <div class="rank-item">
                                            <i data-lucide="triangle-alert" class="text-red-300 icon-md shrink-0"></i>
                                            <div>
                                                <div class="rank-name rank-name-practice">Practice</div>
                                                <div class="rank-range">40セント以上</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-lg text-white font-medium mt-4">素晴らしい精度！</p>
                            </div>
                        </div>
                        <!-- C4 基音（左） -->
                        <div class="flex flex-col items-center text-center">
                            <div class="text-3xl font-bold text-white">C4</div>
                            <p class="text-sm text-green-200">基音</p>
                        </div>
                        <!-- 平均誤差（右） -->
                        <div class="flex flex-col items-center text-center">
                            <div class="text-3xl font-bold text-white" id="average-error">+0.0¢</div>
                            <p class="text-sm text-green-200">セッション平均誤差</p>
                        </div>
                    </div>
                </div>
                
                <!-- 評価分布見出し -->
                <h3 class="text-xl font-medium text-white mb-4 text-center">評価分布</h3>
                
                <!-- 評価分布バー -->
                <div class="flex flex-col gap-3 px-4">
                    <!-- Excellent -->
                    <div class="flex items-center gap-3">
                        <i data-lucide="trophy" class="text-yellow-300 icon-md shrink-0"></i>
                        <div class="flex-1 flex items-center gap-2">
                            <div class="progress-bar flex">
                                <div class="progress-fill-custom color-eval-gold" style="width: 37.5%;"></div>
                            </div>
                            <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">3</span>
                        </div>
                    </div>
                    
                    <!-- Good -->
                    <div class="flex items-center gap-3">
                        <i data-lucide="star" class="text-green-300 icon-md shrink-0"></i>
                        <div class="flex-1 flex items-center gap-2">
                            <div class="progress-bar flex">
                                <div class="progress-fill-custom color-eval-good" style="width: 25%;"></div>
                            </div>
                            <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">2</span>
                        </div>
                    </div>
                    
                    <!-- Pass -->
                    <div class="flex items-center gap-3">
                        <i data-lucide="thumbs-up" class="text-blue-300 icon-md shrink-0"></i>
                        <div class="flex-1 flex items-center gap-2">
                            <div class="progress-bar flex">
                                <div class="progress-fill-custom color-eval-pass" style="width: 37.5%;"></div>
                            </div>
                            <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">3</span>
                        </div>
                    </div>
                    
                    <!-- Practice -->
                    <div class="flex items-center gap-3">
                        <i data-lucide="triangle-alert" class="text-red-300 icon-md shrink-0"></i>
                        <div class="flex-1 flex items-center gap-2">
                            <div class="progress-bar flex">
                                <div class="progress-fill-custom color-eval-practice" style="width: 0%;"></div>
                            </div>
                            <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 詳細分析 -->
            <div class="glass-card mb-8">
                <h3 class="text-xl font-medium text-white mb-6 text-center">詳細分析</h3>
                <div class="space-y-2" id="note-results">
                    <!-- Note results will be populated by JavaScript -->
                </div>
            </div>

            <!-- Action Buttons -->
            <section class="final-actions">
                <a href="training.html" class="btn btn-primary btn-large">
                    <i data-lucide="arrow-right" class="icon-sm mr-2"></i>
                    <span>次の基音へ</span>
                </a>
                <a href="index.html" class="btn btn-secondary btn-large">
                    <i data-lucide="home" class="icon-sm mr-2"></i>
                    <span>ホームに戻る</span>
                </a>
            </section>
        </div>
    </div>

    <script>
        // Mock session data for current session
        const currentSessionData = {
            session: 2,
            baseNote: 'C4',
            totalSessions: 8,
            noteResults: [
                { noteIndex: 0, noteName: 'ド', targetFrequency: 261.63, userFrequency: 265.2, centError: 24, isCorrect: true },
                { noteIndex: 1, noteName: 'レ', targetFrequency: 293.66, userFrequency: 290.1, centError: -21, isCorrect: true },
                { noteIndex: 2, noteName: 'ミ', targetFrequency: 329.63, userFrequency: 335.8, centError: 32, isCorrect: true },
                { noteIndex: 3, noteName: 'ファ', targetFrequency: 349.23, userFrequency: 348.0, centError: -6, isCorrect: true },
                { noteIndex: 4, noteName: 'ソ', targetFrequency: 392.00, userFrequency: 388.5, centError: -16, isCorrect: true },
                { noteIndex: 5, noteName: 'ラ', targetFrequency: 440.00, userFrequency: 445.2, centError: 20, isCorrect: true },
                { noteIndex: 6, noteName: 'シ', targetFrequency: 493.88, userFrequency: 490.0, centError: -14, isCorrect: true },
                { noteIndex: 7, noteName: 'ド\'', targetFrequency: 523.25, userFrequency: 528.6, centError: 18, isCorrect: true }
            ]
        };

        // Helper function to create Lucide icons
        function lucideIcon(iconName, colorClass = '', sizeClass = 'icon-lg') {
            return `<i data-lucide="${iconName}" class="${colorClass} ${sizeClass}"></i>`;
        }

        // Get evaluation level for a note
        function getEvaluationLevel(centError) {
            const absError = Math.abs(centError);
            if (absError <= 15) return { level: 'excellent', color: 'text-yellow-300', label: 'Excellent', icon: lucideIcon('trophy', 'text-yellow-300', 'icon-lg') };
            if (absError <= 25) return { level: 'good', color: 'text-green-300', label: 'Good', icon: lucideIcon('star', 'text-green-300', 'icon-lg') };
            if (absError <= 40) return { level: 'pass', color: 'text-blue-300', label: 'Pass', icon: lucideIcon('thumbs-up', 'text-blue-300', 'icon-lg') };
            return { level: 'practice', color: 'text-red-300', label: 'Practice', icon: lucideIcon('triangle-alert', 'text-red-300', 'icon-lg') };
        }

        // Display note results
        function displayNoteResults() {
            const noteResults = document.getElementById('note-results');
            noteResults.innerHTML = '';

            currentSessionData.noteResults.forEach((note) => {
                const evaluation = getEvaluationLevel(note.centError);

                const noteElement = document.createElement('div');
                noteElement.className = 'glass-card-sm hover:bg-white/10 transition-colors';
                noteElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div>
                                <div class="text-lg font-bold text-white">${note.noteName}</div>
                            </div>
                            <div>
                                <div class="text-base text-white-60 font-medium">目標 ${note.targetFrequency.toFixed(0)}Hz</div>
                                <div class="text-base text-white-60 font-medium">実音 ${note.userFrequency.toFixed(0)}Hz</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="font-bold text-2xl ${note.centError > 0 ? 'text-red-300' : 'text-blue-300'}">
                                ${note.centError > 0 ? '+' : ''}${note.centError}¢
                            </div>
                            <div class="flex items-center justify-center" style="min-width: 36px;">
                                ${evaluation.icon}
                            </div>
                        </div>
                    </div>
                `;

                noteResults.appendChild(noteElement);
            });
        }

        // Update progress bar
        function updateProgressBar() {
            const progressPercent = (currentSessionData.session / currentSessionData.totalSessions) * 100;
            const progressBar = document.querySelector('.progress-bar-fill');
            if (progressBar) {
                setTimeout(() => {
                    progressBar.style.width = `${progressPercent}%`;
                }, 300);
            }
        }

        // Animate average error
        function animateAverageError() {
            const element = document.getElementById('average-error');
            if (!element) return;
            
            const targetValue = 12.1;
            const isPositive = true; // サンプルデータではプラス
            let currentValue = 0;
            const increment = targetValue / 60; // 1秒で完了
            
            const animation = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    currentValue = targetValue;
                    clearInterval(animation);
                    
                    // アニメーション完了時に色変更
                    setTimeout(() => {
                        element.classList.remove('text-white');
                        element.classList.add('text-yellow-300');
                    }, 200);
                }
                element.textContent = (isPositive ? '+' : '-') + currentValue.toFixed(1) + '¢';
            }, 16); // 60fps
        }

        // Initialize page
        function initializePage() {
            displayNoteResults();
            updateProgressBar();
            
            // Initialize Lucide icons with stroke width 1.5 as default
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({
                        strokeWidth: 1.5  // デフォルト: 1.5、強調時: 1.75
                    });
                }
            }, 100);
            
            // Start average error animation
            setTimeout(animateAverageError, 500);
        }

        // ランク説明ポップオーバー制御
        function toggleRankPopover() {
            const popover = document.getElementById('rank-popover');
            popover.classList.toggle('show');
        }
        
        // ポップオーバー外クリックで閉じる
        document.addEventListener('click', function(event) {
            const popover = document.getElementById('rank-popover');
            const button = document.querySelector('.rank-info-btn');
            
            if (popover && !popover.contains(event.target) && !button.contains(event.target)) {
                popover.classList.remove('show');
            }
        });

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', initializePage);
        window.addEventListener('load', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons({
                    strokeWidth: 1.5  // デフォルト: 1.5、強調時: 1.75
                });
            }
        });
    </script>
</body>
</html>