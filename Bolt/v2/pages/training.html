<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トレーニング - 8va相対音感トレーニング</title>
    
    <!-- フォント最適化 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- クリティカルCSS（インライン） -->
    <style>
        /* 初期表示に必要な最小限のスタイル */
        .container { opacity: 0; transition: opacity 0.3s; }
        .container.loaded { opacity: 1; }
    </style>
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="../styles/base.css?v=2">
    <link rel="stylesheet" href="../styles/training.css?v=2">
    
    <!-- JavaScript モジュール -->
    <script src="../../js/data-manager.js"></script>
    <script src="../../js/audio-processor.js"></script>
    <script src="../../js/training-session.js"></script>
    
    <!-- フォント（非ブロッキング） -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-green">
                        <i data-lucide="shuffle" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">ランダム基音モード</h1>
                    <p class="page-subtitle text-green-200">トレーニング実施中</p>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="narrow-main">
            <!-- 進行バーセクション（セッション中） -->
            <div class="progress-section progress-section-training">
                <div class="flex items-center gap-4">
                    <div class="progress-bar with-margin">
                        <div class="progress-fill gradient-catalog-blue" style="width: 25%;"></div>
                    </div>
                    <div class="session-badge">
                        セッション 1/8
                    </div>
                </div>
            </div>
            <!-- マイク許可セクション -->
            <div class="glass-card">
                <section class="test-section" id="permission-section">
                    <div class="section-header-training">
                        <h4 class="text-sub-title heading-md">
                            <i data-lucide="music-2" class="text-blue-300" style="width: 48px; height: 48px; transform: translateY(-8px);"></i>
                            <span>基音再生とドレミガイド</span>
                        </h4>
                        <p class="text-body">基音スタートボタンでトレーニング開始</p>
                    </div>
                    
                    <div class="base-note-control">
                        <button class="btn btn-primary" id="play-base-note">
                            <i data-lucide="volume-2" style="width: 24px; height: 24px;"></i>
                            <span>基音スタート</span>
                        </button>
                        
                        <!-- プログレス四角（ボタンと横並び） -->
                        <div class="progress-section-inline">
                            <div class="progress-labels">
                                <span>ドレミガイド開始インターバル</span>
                            </div>
                            <div class="progress-squares" id="progress-squares">
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ドレミガイド（同じglass-card内） -->
                    <h4 class="text-sub-title heading-sm">ドレミガイド</h4>
                    <div class="doremi-guide">
                        <div class="note-circles">
                            <div class="note-circle" data-note="ド">ド</div>
                            <div class="note-circle" data-note="レ">レ</div>
                            <div class="note-circle" data-note="ミ">ミ</div>
                            <div class="note-circle" data-note="ファ">ファ</div>
                            <div class="note-circle" data-note="ソ">ソ</div>
                            <div class="note-circle" data-note="ラ">ラ</div>
                            <div class="note-circle" data-note="シ">シ</div>
                            <div class="note-circle" data-note="ド">ド</div>
                        </div>
                        <div class="test-status">ガイドに合わせて発声しましょう</div>
                        
                        <!-- マイク認識 -->
                        <div class="mic-recognition-section">
                            <div class="test-instruction test-instruction-green" id="mic-badge">
                                <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                            </div>
                            <div class="progress-bar flex">
                                <div class="progress-fill gradient-catalog-green" style="width: 65%;"></div>
                            </div>
                        </div>
                        
                        <!-- 12音階モード専用：音域調整（ドレミガイド下） -->
                        <div class="range-adjustment" id="range-adjustment">
                            <!-- トグルヘッダー -->
                            <div class="range-toggle-header" id="range-toggle-header">
                                <div>
                                    <h5 class="heading-sm">
                                        <i data-lucide="sliders" class="text-blue-300"></i>
                                        <span>音域調整</span>
                                    </h5>
                                </div>
                                <button class="btn btn-ghost" id="range-toggle-btn">
                                    <i data-lucide="chevron-down" style="width: 20px; height: 20px;"></i>
                                </button>
                            </div>
                            
                            <!-- 調整コントロール（初期は非表示） -->
                            <div class="range-controls range-controls-collapsed" id="range-controls">
                                <p class="range-description text-sm text-white-60">あなたの声域に合わせて基音の高さを調整できます</p>
                                <div class="flex items-center gap-3">
                                    <button class="btn btn-primary" id="range-down">
                                        <i data-lucide="chevron-down" style="width: 20px; height: 20px;"></i>
                                        <span>下げる</span>
                                    </button>
                                    <div class="range-indicator" id="range-indicator">
                                        <span class="text-sm">標準</span>
                                    </div>
                                    <button class="btn btn-primary" id="range-up">
                                        <i data-lucide="chevron-up" style="width: 20px; height: 20px;"></i>
                                        <span>上げる</span>
                                    </button>
                                </div>
                                
                                <!-- 音域テストボタン -->
                                <div class="range-test-buttons">
                                    <div class="flex items-center gap-3">
                                        <button class="btn btn-outline" id="test-lowest">
                                            <i data-lucide="volume-1" class="icon-md"></i>
                                            <span>最低音<span class="mobile-hide">を確認</span></span>
                                        </button>
                                        <button class="btn btn-outline" id="test-highest">
                                            <i data-lucide="volume-2" class="icon-md"></i>
                                            <span>最高音<span class="mobile-hide">を確認</span></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            
            <!-- ホームボタン -->
            <section class="text-center">
                <button class="btn btn-outline" onclick="window.location.href='index.html'">
                    <i data-lucide="home"></i>
                    <span>ホームに戻る</span>
                </button>
            </section>
        </main>
        
        <!-- フッター -->
        <footer class="footer-base">
            <p class="footer-copyright">© 2024 8va相対音感トレーニングアプリ</p>
            <p class="footer-tagline">音楽の新しい扉を開こう</p>
        </footer>
    </div>

    <!-- モード対応トレーニングスクリプト -->
    <script>
        // モード設定の初期化
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'random';
        const sessionNum = parseInt(urlParams.get('session')) || 1;
        
        // モード別設定
        const modeConfig = {
            random: {
                name: 'ランダム基音モード',
                totalSessions: 8,
                icon: 'shuffle',
                description: 'トレーニング実施中'
            },
            continuous: {
                name: '連続チャレンジモード',
                totalSessions: 12,
                icon: 'zap',
                description: 'クロマチック12音'
            },
            twelve: {
                name: '12音階モード',
                totalSessions: 12,
                icon: 'music',
                description: '全音域対応'
            }
        };

        // Lucideライブラリの確実な読み込み
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';

        script.onload = function() {
            lucide.createIcons();
            
            // モード別UI初期化
            initializeModeUI();
            
            // コンテナをフェードイン
            document.querySelector('.container').classList.add('loaded');

            // 基音再生ボタンの処理
            document.getElementById('play-base-note').addEventListener('click', function() {
                startTraining();
            });
        };

        // 音域調整の状態管理
        let rangeOffset = 0; // -2から+2まで（半音5段階）
        
        function initializeModeUI() {
            const config = modeConfig[mode];
            console.log('Current mode:', mode, 'Config:', config); // デバッグ用
            
            // ヘッダー更新
            const pageTitle = document.querySelector('.page-title');
            const pageSubtitle = document.querySelector('.page-subtitle');
            const headerIcon = document.querySelector('.page-header-icon i');
            
            if (pageTitle) pageTitle.textContent = config.name;
            if (pageSubtitle) pageSubtitle.textContent = config.description;
            if (headerIcon) {
                headerIcon.setAttribute('data-lucide', config.icon);
                lucide.createIcons(); // アイコン更新後に再作成
            }
            
            // 進行バー更新
            const progressFill = document.querySelector('.progress-fill');
            const progressLabel = document.querySelector('.progress-label');
            
            if (progressFill && progressLabel) {
                const progressPercent = Math.round((sessionNum / config.totalSessions) * 100);
                progressFill.style.width = progressPercent + '%'; // 動的値のため例外許可
                progressLabel.textContent = `セッション ${sessionNum} / ${config.totalSessions}`;
            }
            
            // 12音階モードの場合：音域調整を表示
            if (mode === 'twelve') {
                const rangeAdjustment = document.getElementById('range-adjustment');
                if (rangeAdjustment) {
                    rangeAdjustment.classList.remove('range-adjustment-hidden');
                    rangeAdjustment.classList.add('range-adjustment-visible');
                    initializeRangeAdjustment();
                }
            }
            
            // アイコン再作成
            lucide.createIcons();
        }
        
        function initializeRangeAdjustment() {
            // トグル機能
            const toggleHeader = document.getElementById('range-toggle-header');
            const toggleBtn = document.getElementById('range-toggle-btn');
            const controls = document.getElementById('range-controls');
            let isExpanded = false;
            
            toggleHeader.addEventListener('click', function() {
                isExpanded = !isExpanded;
                
                if (isExpanded) {
                    controls.classList.remove('range-controls-collapsed');
                    controls.classList.add('range-controls-expanded');
                } else {
                    controls.classList.remove('range-controls-expanded');
                    controls.classList.add('range-controls-collapsed');
                }
                
                const chevronIcon = toggleBtn.querySelector('i');
                chevronIcon.setAttribute('data-lucide', isExpanded ? 'chevron-up' : 'chevron-down');
                lucide.createIcons();
            });
            
            // 音域調整ボタンのイベントリスナー
            document.getElementById('range-down').addEventListener('click', function() {
                if (rangeOffset > -2) {
                    rangeOffset--;
                    updateRangeIndicator();
                }
            });
            
            document.getElementById('range-up').addEventListener('click', function() {
                if (rangeOffset < 2) {
                    rangeOffset++;
                    updateRangeIndicator();
                }
            });
            
            // 音域テストボタン
            document.getElementById('test-lowest').addEventListener('click', function() {
                playRangeTest('lowest');
            });
            
            document.getElementById('test-highest').addEventListener('click', function() {
                playRangeTest('highest');
            });
        }
        
        function updateRangeIndicator() {
            const indicator = document.getElementById('range-indicator').querySelector('span');
            const rangeLabels = ['低音域', '低め', '標準', '高め', '高音域'];
            indicator.textContent = rangeLabels[rangeOffset + 2];
        }
        
        function playRangeTest(type) {
            // 音域テスト再生（実装例）
            console.log(`${type === 'lowest' ? '最低音' : '最高音'}テスト再生 (offset: ${rangeOffset})`);
            // TODO: Web Audio APIで実際の音程再生
        }

        // グローバル変数でセッション管理
        let trainingSession = null;

        function startTraining() {
            const button = document.getElementById('play-base-note');
            const progressSquares = document.querySelectorAll('.progress-square');
            
            // ボタンを無効化
            button.disabled = true;
            button.innerHTML = '<i data-lucide="volume-2" style="width: 24px; height: 24px;"></i><span>初期化中...</span>';
            lucide.createIcons(); // アイコンを再作成
            
            // TrainingSession初期化・開始
            initializeAndStartSession();
            
        }

        // TrainingSession初期化・実行
        async function initializeAndStartSession() {
            try {
                // セッション初期化
                trainingSession = new TrainingSession(mode);
                
                // UI更新コールバック設定
                trainingSession.setUICallbacks({
                    onSessionStart: handleSessionStart,
                    onIntervalChange: handleIntervalChange,
                    onPitchUpdate: handlePitchUpdate,
                    onSessionComplete: handleSessionComplete,
                    onError: handleTrainingError
                });
                
                // TrainingSession初期化
                const initResult = await trainingSession.initializeTraining();
                
                if (!initResult.success) {
                    throw new Error(initResult.error);
                }
                
                // セッション開始
                await trainingSession.startSession();
                
            } catch (error) {
                handleTrainingError('initialization', error);
            }
        }

        // セッション開始ハンドラ
        function handleSessionStart(sessionInfo) {
            const button = document.getElementById('play-base-note');
            button.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>歌ってください</span>';
            button.disabled = true;
            lucide.createIcons();
            
            console.log('🎯 セッション開始:', sessionInfo);
        }

        // 音程進行ハンドラ
        function handleIntervalChange(intervalInfo) {
            const circles = document.querySelectorAll('.progress-circle');
            
            // 前の音程を完了マーク
            if (intervalInfo.index > 0) {
                circles[intervalInfo.index - 1]?.classList.remove('current');
                circles[intervalInfo.index - 1]?.classList.add('completed');
            }
            
            // 現在の音程をハイライト
            if (intervalInfo.index < circles.length) {
                circles[intervalInfo.index]?.classList.add('current');
            }
            
            console.log(`🎵 音程変更: ${intervalInfo.interval} (${intervalInfo.targetFreq.toFixed(1)}Hz)`);
        }

        // リアルタイム音程更新ハンドラ
        function handlePitchUpdate(updateInfo) {
            // TODO: ピッチ可視化エリアの更新
            console.log('🎤 音程検出:', {
                interval: updateInfo.interval,
                grade: updateInfo.result.evaluation.grade,
                centError: updateInfo.result.evaluation.centError,
                progress: (updateInfo.progress * 100).toFixed(1) + '%'
            });
        }

        // セッション完了ハンドラ
        function handleSessionComplete(completionInfo) {
            const config = modeConfig[mode];
            
            console.log('✅ セッション完了:', completionInfo);
            
            // 後続処理（モード別）
            if (completionInfo.isLastSession) {
                // 全セッション完了 - 総合評価へ
                setTimeout(() => {
                    window.location.href = 'results-overview.html';
                }, 2000);
            } else {
                // セッション評価へ（ランダムモードのみ）
                if (mode === 'random') {
                    setTimeout(() => {
                        window.location.href = 'result-session.html';
                    }, 1000);
                } else {
                    // 次セッション準備
                    prepareNextSession();
                }
            }
        }

        // 次セッション準備
        function prepareNextSession() {
            const hasNext = trainingSession.prepareNextSession();
            
            if (hasNext) {
                const button = document.getElementById('play-base-note');
                button.innerHTML = '<i data-lucide="play" style="width: 24px; height: 24px;"></i><span>次のセッション</span>';
                button.disabled = false;
                button.onclick = function() {
                    trainingSession.startSession();
                };
                lucide.createIcons();
                
                // 進行バー更新
                updateProgressBar();
            }
        }

        // 進行バー更新
        function updateProgressBar() {
            const sessionStats = trainingSession.getSessionStats();
            const config = modeConfig[mode];
            
            const progressFill = document.querySelector('.progress-fill');
            const progressLabel = document.querySelector('.progress-label');
            
            if (progressFill && progressLabel) {
                const progressPercent = Math.round((sessionStats.currentSession / config.totalSessions) * 100);
                progressFill.style.width = progressPercent + '%'; // 動的値のため例外許可
                progressLabel.textContent = `セッション ${sessionStats.currentSession} / ${config.totalSessions}`;
            }
        }

        // エラーハンドラ
        function handleTrainingError(context, error) {
            console.error(`[Training UI] ${context}:`, error);
            
            const button = document.getElementById('play-base-note');
            button.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>エラー発生</span>';
            button.disabled = false;
            button.onclick = function() {
                location.reload(); // リロードで再試行
            };
            lucide.createIcons();
            
            // ユーザー向けエラー表示
            alert(`エラーが発生しました: ${error.message}\nページをリロードして再試行してください。`);
        }

        // 旧実装を完全置換
        function startTrainingOld() {
            // この関数は削除予定（後方互換のため一時保持）
            // 新しいstartTraining()が置き換え
        }

        // 旧実装関数（削除予定）
        function updateProgressAnimationOld() {
            // 旧シミュレーション実装 - TrainingSessionで置換済み
            const squareInterval = 500; // 0.5秒間隔
            progressSquares.forEach((square, index) => {
                setTimeout(() => {
                    square.classList.add('consumed');
                    
                    // 最後の四角が消去されたらドレミガイド開始
                    if (index === progressSquares.length - 1) {
                        startDoremiGuide();
                    }
                }, squareInterval * index);
            });
        }

        function startDoremiGuide() {
            const circles = document.querySelectorAll('.note-circle');
            const micBadge = document.getElementById('mic-badge');
            let currentIndex = 0;
            
            // マイクバッジを認識中アニメーションに
            micBadge.classList.add('measuring');
            
            const interval = setInterval(() => {
                if (currentIndex > 0) {
                    circles[currentIndex - 1].classList.remove('current');
                    circles[currentIndex - 1].classList.add('completed');
                }
                
                if (currentIndex < circles.length) {
                    circles[currentIndex].classList.add('current');
                    currentIndex++;
                } else {
                    clearInterval(interval);
                    // 旧実装：TrainingSessionで置換済み
                    // handleTrainingComplete();
                }
            }, 662.5); // 5.3秒 ÷ 8音 = 662.5ms
        }

        // 旧実装（TrainingSessionで置換済み）
        function handleTrainingCompleteOld() {
            // この関数は削除予定
        }
        
        document.head.appendChild(script);
    </script>
</body>
</html>