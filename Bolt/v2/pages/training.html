<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° - 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆæœ€é©åŒ– -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«CSSï¼ˆã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ï¼‰ -->
    <style>
        /* åˆæœŸè¡¨ç¤ºã«å¿…è¦ãªæœ€å°é™ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .container { opacity: 0; transition: opacity 0.3s; }
        .container.loaded { opacity: 1; }
    </style>
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
    <link rel="stylesheet" href="../styles/base.css?v=2">
    <link rel="stylesheet" href="../styles/training.css?v=2">
    
    <!-- JavaScript ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="../../js/data-manager.js"></script>
    <script src="../../js/audio-processor.js"></script>
    <script src="../../js/training-session.js"></script>
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆï¼ˆéãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰ -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-green">
                        <i data-lucide="shuffle" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">ãƒ©ãƒ³ãƒ€ãƒ åŸºéŸ³ãƒ¢ãƒ¼ãƒ‰</h1>
                    <p class="page-subtitle text-green-200">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿæ–½ä¸­</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- é€²è¡Œãƒãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ï¼‰ -->
            <div class="progress-section progress-section-training">
                <div class="flex items-center gap-4">
                    <div class="progress-bar with-margin">
                        <div class="progress-fill gradient-catalog-blue" style="width: 25%;"></div>
                    </div>
                    <div class="session-badge">
                        ã‚»ãƒƒã‚·ãƒ§ãƒ³ 1/8
                    </div>
                </div>
            </div>
            <!-- ãƒã‚¤ã‚¯è¨±å¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="glass-card">
                <section class="test-section" id="permission-section">
                    <div class="section-header-training">
                        <h4 class="text-sub-title heading-md">
                            <i data-lucide="music-2" class="text-blue-300" style="width: 48px; height: 48px; transform: translateY(-8px);"></i>
                            <span>åŸºéŸ³å†ç”Ÿã¨ãƒ‰ãƒ¬ãƒŸã‚¬ã‚¤ãƒ‰</span>
                        </h4>
                        <p class="text-body">åŸºéŸ³ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</p>
                    </div>
                    
                    <div class="base-note-control">
                        <button class="btn btn-primary" id="play-base-note">
                            <i data-lucide="volume-2" style="width: 24px; height: 24px;"></i>
                            <span>åŸºéŸ³ã‚¹ã‚¿ãƒ¼ãƒˆ</span>
                        </button>
                        
                        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å››è§’ï¼ˆãƒœã‚¿ãƒ³ã¨æ¨ªä¸¦ã³ï¼‰ -->
                        <div class="progress-section-inline">
                            <div class="progress-labels">
                                <span>ãƒ‰ãƒ¬ãƒŸã‚¬ã‚¤ãƒ‰é–‹å§‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«</span>
                            </div>
                            <div class="progress-squares" id="progress-squares">
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                                <div class="progress-square"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ãƒ‰ãƒ¬ãƒŸã‚¬ã‚¤ãƒ‰ï¼ˆåŒã˜glass-cardå†…ï¼‰ -->
                    <h4 class="text-sub-title heading-sm">ãƒ‰ãƒ¬ãƒŸã‚¬ã‚¤ãƒ‰</h4>
                    <div class="doremi-guide">
                        <div class="note-circles">
                            <div class="note-circle" data-note="ãƒ‰">ãƒ‰</div>
                            <div class="note-circle" data-note="ãƒ¬">ãƒ¬</div>
                            <div class="note-circle" data-note="ãƒŸ">ãƒŸ</div>
                            <div class="note-circle" data-note="ãƒ•ã‚¡">ãƒ•ã‚¡</div>
                            <div class="note-circle" data-note="ã‚½">ã‚½</div>
                            <div class="note-circle" data-note="ãƒ©">ãƒ©</div>
                            <div class="note-circle" data-note="ã‚·">ã‚·</div>
                            <div class="note-circle" data-note="ãƒ‰">ãƒ‰</div>
                        </div>
                        <div class="test-status">ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ç™ºå£°ã—ã¾ã—ã‚‡ã†</div>
                        
                        <!-- ãƒã‚¤ã‚¯èªè­˜ -->
                        <div class="mic-recognition-section">
                            <div class="test-instruction test-instruction-green" id="mic-badge">
                                <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                            </div>
                            <div class="progress-bar flex">
                                <div class="progress-fill gradient-catalog-green" style="width: 65%;"></div>
                            </div>
                        </div>
                        
                        <!-- 12éŸ³éšãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ï¼šéŸ³åŸŸèª¿æ•´ï¼ˆãƒ‰ãƒ¬ãƒŸã‚¬ã‚¤ãƒ‰ä¸‹ï¼‰ -->
                        <div class="range-adjustment" id="range-adjustment">
                            <!-- ãƒˆã‚°ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                            <div class="range-toggle-header" id="range-toggle-header">
                                <div>
                                    <h5 class="heading-sm">
                                        <i data-lucide="sliders" class="text-blue-300"></i>
                                        <span>éŸ³åŸŸèª¿æ•´</span>
                                    </h5>
                                </div>
                                <button class="btn btn-ghost" id="range-toggle-btn">
                                    <i data-lucide="chevron-down" style="width: 20px; height: 20px;"></i>
                                </button>
                            </div>
                            
                            <!-- èª¿æ•´ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
                            <div class="range-controls range-controls-collapsed" id="range-controls">
                                <p class="range-description text-sm text-white-60">ã‚ãªãŸã®å£°åŸŸã«åˆã‚ã›ã¦åŸºéŸ³ã®é«˜ã•ã‚’èª¿æ•´ã§ãã¾ã™</p>
                                <div class="flex items-center gap-3">
                                    <button class="btn btn-primary" id="range-down">
                                        <i data-lucide="chevron-down" style="width: 20px; height: 20px;"></i>
                                        <span>ä¸‹ã’ã‚‹</span>
                                    </button>
                                    <div class="range-indicator" id="range-indicator">
                                        <span class="text-sm">æ¨™æº–</span>
                                    </div>
                                    <button class="btn btn-primary" id="range-up">
                                        <i data-lucide="chevron-up" style="width: 20px; height: 20px;"></i>
                                        <span>ä¸Šã’ã‚‹</span>
                                    </button>
                                </div>
                                
                                <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
                                <div class="range-test-buttons">
                                    <div class="flex items-center gap-3">
                                        <button class="btn btn-outline" id="test-lowest">
                                            <i data-lucide="volume-1" class="icon-md"></i>
                                            <span>æœ€ä½éŸ³<span class="mobile-hide">ã‚’ç¢ºèª</span></span>
                                        </button>
                                        <button class="btn btn-outline" id="test-highest">
                                            <i data-lucide="volume-2" class="icon-md"></i>
                                            <span>æœ€é«˜éŸ³<span class="mobile-hide">ã‚’ç¢ºèª</span></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            
            <!-- ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ -->
            <section class="text-center">
                <button class="btn btn-outline" onclick="window.location.href='index.html'">
                    <i data-lucide="home"></i>
                    <span>ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</span>
                </button>
            </section>
        </main>
        
        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <footer class="footer-base">
            <p class="footer-copyright">Â© 2024 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¢ãƒ—ãƒª</p>
            <p class="footer-tagline">éŸ³æ¥½ã®æ–°ã—ã„æ‰‰ã‚’é–‹ã“ã†</p>
        </footer>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ãƒ¢ãƒ¼ãƒ‰è¨­å®šã®åˆæœŸåŒ–
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode') || 'random';
        const sessionNum = parseInt(urlParams.get('session')) || 1;
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ¥è¨­å®š
        const modeConfig = {
            random: {
                name: 'ãƒ©ãƒ³ãƒ€ãƒ åŸºéŸ³ãƒ¢ãƒ¼ãƒ‰',
                totalSessions: 8,
                icon: 'shuffle',
                description: 'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿæ–½ä¸­'
            },
            continuous: {
                name: 'é€£ç¶šãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰',
                totalSessions: 12,
                icon: 'zap',
                description: 'ã‚¯ãƒ­ãƒãƒãƒƒã‚¯12éŸ³'
            },
            twelve: {
                name: '12éŸ³éšãƒ¢ãƒ¼ãƒ‰',
                totalSessions: 12,
                icon: 'music',
                description: 'å…¨éŸ³åŸŸå¯¾å¿œ'
            }
        };

        // Lucideãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºå®Ÿãªèª­ã¿è¾¼ã¿
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/lucide@latest/dist/umd/lucide.js';

        script.onload = function() {
            lucide.createIcons();
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ¥UIåˆæœŸåŒ–
            initializeModeUI();
            
            // ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
            document.querySelector('.container').classList.add('loaded');

            // åŸºéŸ³å†ç”Ÿãƒœã‚¿ãƒ³ã®å‡¦ç†
            document.getElementById('play-base-note').addEventListener('click', function() {
                startTraining();
            });
        };

        // éŸ³åŸŸèª¿æ•´ã®çŠ¶æ…‹ç®¡ç†
        let rangeOffset = 0; // -2ã‹ã‚‰+2ã¾ã§ï¼ˆåŠéŸ³5æ®µéšï¼‰
        
        function initializeModeUI() {
            const config = modeConfig[mode];
            console.log('Current mode:', mode, 'Config:', config); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
            const pageTitle = document.querySelector('.page-title');
            const pageSubtitle = document.querySelector('.page-subtitle');
            const headerIcon = document.querySelector('.page-header-icon i');
            
            if (pageTitle) pageTitle.textContent = config.name;
            if (pageSubtitle) pageSubtitle.textContent = config.description;
            if (headerIcon) {
                headerIcon.setAttribute('data-lucide', config.icon);
                lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°å¾Œã«å†ä½œæˆ
            }
            
            // é€²è¡Œãƒãƒ¼æ›´æ–°
            const progressFill = document.querySelector('.progress-fill');
            const progressLabel = document.querySelector('.progress-label');
            
            if (progressFill && progressLabel) {
                const progressPercent = Math.round((sessionNum / config.totalSessions) * 100);
                progressFill.style.width = progressPercent + '%'; // å‹•çš„å€¤ã®ãŸã‚ä¾‹å¤–è¨±å¯
                progressLabel.textContent = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionNum} / ${config.totalSessions}`;
            }
            
            // 12éŸ³éšãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼šéŸ³åŸŸèª¿æ•´ã‚’è¡¨ç¤º
            if (mode === 'twelve') {
                const rangeAdjustment = document.getElementById('range-adjustment');
                if (rangeAdjustment) {
                    rangeAdjustment.classList.remove('range-adjustment-hidden');
                    rangeAdjustment.classList.add('range-adjustment-visible');
                    initializeRangeAdjustment();
                }
            }
            
            // ã‚¢ã‚¤ã‚³ãƒ³å†ä½œæˆ
            lucide.createIcons();
        }
        
        function initializeRangeAdjustment() {
            // ãƒˆã‚°ãƒ«æ©Ÿèƒ½
            const toggleHeader = document.getElementById('range-toggle-header');
            const toggleBtn = document.getElementById('range-toggle-btn');
            const controls = document.getElementById('range-controls');
            let isExpanded = false;
            
            toggleHeader.addEventListener('click', function() {
                isExpanded = !isExpanded;
                
                if (isExpanded) {
                    controls.classList.remove('range-controls-collapsed');
                    controls.classList.add('range-controls-expanded');
                } else {
                    controls.classList.remove('range-controls-expanded');
                    controls.classList.add('range-controls-collapsed');
                }
                
                const chevronIcon = toggleBtn.querySelector('i');
                chevronIcon.setAttribute('data-lucide', isExpanded ? 'chevron-up' : 'chevron-down');
                lucide.createIcons();
            });
            
            // éŸ³åŸŸèª¿æ•´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('range-down').addEventListener('click', function() {
                if (rangeOffset > -2) {
                    rangeOffset--;
                    updateRangeIndicator();
                }
            });
            
            document.getElementById('range-up').addEventListener('click', function() {
                if (rangeOffset < 2) {
                    rangeOffset++;
                    updateRangeIndicator();
                }
            });
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            document.getElementById('test-lowest').addEventListener('click', function() {
                playRangeTest('lowest');
            });
            
            document.getElementById('test-highest').addEventListener('click', function() {
                playRangeTest('highest');
            });
        }
        
        function updateRangeIndicator() {
            const indicator = document.getElementById('range-indicator').querySelector('span');
            const rangeLabels = ['ä½éŸ³åŸŸ', 'ä½ã‚', 'æ¨™æº–', 'é«˜ã‚', 'é«˜éŸ³åŸŸ'];
            indicator.textContent = rangeLabels[rangeOffset + 2];
        }
        
        function playRangeTest(type) {
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆå†ç”Ÿï¼ˆå®Ÿè£…ä¾‹ï¼‰
            console.log(`${type === 'lowest' ? 'æœ€ä½éŸ³' : 'æœ€é«˜éŸ³'}ãƒ†ã‚¹ãƒˆå†ç”Ÿ (offset: ${rangeOffset})`);
            // TODO: Web Audio APIã§å®Ÿéš›ã®éŸ³ç¨‹å†ç”Ÿ
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        let trainingSession = null;

        function startTraining() {
            const button = document.getElementById('play-base-note');
            const progressSquares = document.querySelectorAll('.progress-square');
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            button.disabled = true;
            button.innerHTML = '<i data-lucide="volume-2" style="width: 24px; height: 24px;"></i><span>åˆæœŸåŒ–ä¸­...</span>';
            lucide.createIcons(); // ã‚¢ã‚¤ã‚³ãƒ³ã‚’å†ä½œæˆ
            
            // TrainingSessionåˆæœŸåŒ–ãƒ»é–‹å§‹
            initializeAndStartSession();
            
        }

        // TrainingSessionåˆæœŸåŒ–ãƒ»å®Ÿè¡Œ
        async function initializeAndStartSession() {
            try {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–
                trainingSession = new TrainingSession(mode);
                
                // UIæ›´æ–°ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                trainingSession.setUICallbacks({
                    onSessionStart: handleSessionStart,
                    onIntervalChange: handleIntervalChange,
                    onPitchUpdate: handlePitchUpdate,
                    onSessionComplete: handleSessionComplete,
                    onError: handleTrainingError
                });
                
                // TrainingSessionåˆæœŸåŒ–
                const initResult = await trainingSession.initializeTraining();
                
                if (!initResult.success) {
                    throw new Error(initResult.error);
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
                await trainingSession.startSession();
                
            } catch (error) {
                handleTrainingError('initialization', error);
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒãƒ³ãƒ‰ãƒ©
        function handleSessionStart(sessionInfo) {
            const button = document.getElementById('play-base-note');
            button.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>æ­Œã£ã¦ãã ã•ã„</span>';
            button.disabled = true;
            lucide.createIcons();
            
            console.log('ğŸ¯ ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹:', sessionInfo);
        }

        // éŸ³ç¨‹é€²è¡Œãƒãƒ³ãƒ‰ãƒ©
        function handleIntervalChange(intervalInfo) {
            const circles = document.querySelectorAll('.progress-circle');
            
            // å‰ã®éŸ³ç¨‹ã‚’å®Œäº†ãƒãƒ¼ã‚¯
            if (intervalInfo.index > 0) {
                circles[intervalInfo.index - 1]?.classList.remove('current');
                circles[intervalInfo.index - 1]?.classList.add('completed');
            }
            
            // ç¾åœ¨ã®éŸ³ç¨‹ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (intervalInfo.index < circles.length) {
                circles[intervalInfo.index]?.classList.add('current');
            }
            
            console.log(`ğŸµ éŸ³ç¨‹å¤‰æ›´: ${intervalInfo.interval} (${intervalInfo.targetFreq.toFixed(1)}Hz)`);
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³ç¨‹æ›´æ–°ãƒãƒ³ãƒ‰ãƒ©
        function handlePitchUpdate(updateInfo) {
            // TODO: ãƒ”ãƒƒãƒå¯è¦–åŒ–ã‚¨ãƒªã‚¢ã®æ›´æ–°
            console.log('ğŸ¤ éŸ³ç¨‹æ¤œå‡º:', {
                interval: updateInfo.interval,
                grade: updateInfo.result.evaluation.grade,
                centError: updateInfo.result.evaluation.centError,
                progress: (updateInfo.progress * 100).toFixed(1) + '%'
            });
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ãƒãƒ³ãƒ‰ãƒ©
        function handleSessionComplete(completionInfo) {
            const config = modeConfig[mode];
            
            console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†:', completionInfo);
            
            // å¾Œç¶šå‡¦ç†ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
            if (completionInfo.isLastSession) {
                // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† - ç·åˆè©•ä¾¡ã¸
                setTimeout(() => {
                    window.location.href = 'results-overview.html';
                }, 2000);
            } else {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©•ä¾¡ã¸ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
                if (mode === 'random') {
                    setTimeout(() => {
                        window.location.href = 'result-session.html';
                    }, 1000);
                } else {
                    // æ¬¡ã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™
                    prepareNextSession();
                }
            }
        }

        // æ¬¡ã‚»ãƒƒã‚·ãƒ§ãƒ³æº–å‚™
        function prepareNextSession() {
            const hasNext = trainingSession.prepareNextSession();
            
            if (hasNext) {
                const button = document.getElementById('play-base-note');
                button.innerHTML = '<i data-lucide="play" style="width: 24px; height: 24px;"></i><span>æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³</span>';
                button.disabled = false;
                button.onclick = function() {
                    trainingSession.startSession();
                };
                lucide.createIcons();
                
                // é€²è¡Œãƒãƒ¼æ›´æ–°
                updateProgressBar();
            }
        }

        // é€²è¡Œãƒãƒ¼æ›´æ–°
        function updateProgressBar() {
            const sessionStats = trainingSession.getSessionStats();
            const config = modeConfig[mode];
            
            const progressFill = document.querySelector('.progress-fill');
            const progressLabel = document.querySelector('.progress-label');
            
            if (progressFill && progressLabel) {
                const progressPercent = Math.round((sessionStats.currentSession / config.totalSessions) * 100);
                progressFill.style.width = progressPercent + '%'; // å‹•çš„å€¤ã®ãŸã‚ä¾‹å¤–è¨±å¯
                progressLabel.textContent = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${sessionStats.currentSession} / ${config.totalSessions}`;
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        function handleTrainingError(context, error) {
            console.error(`[Training UI] ${context}:`, error);
            
            const button = document.getElementById('play-base-note');
            button.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ</span>';
            button.disabled = false;
            button.onclick = function() {
                location.reload(); // ãƒªãƒ­ãƒ¼ãƒ‰ã§å†è©¦è¡Œ
            };
            lucide.createIcons();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
        }

        // æ—§å®Ÿè£…ã‚’å®Œå…¨ç½®æ›
        function startTrainingOld() {
            // ã“ã®é–¢æ•°ã¯å‰Šé™¤äºˆå®šï¼ˆå¾Œæ–¹äº’æ›ã®ãŸã‚ä¸€æ™‚ä¿æŒï¼‰
            // æ–°ã—ã„startTraining()ãŒç½®ãæ›ãˆ
        }

        // æ—§å®Ÿè£…é–¢æ•°ï¼ˆå‰Šé™¤äºˆå®šï¼‰
        function updateProgressAnimationOld() {
            // æ—§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£… - TrainingSessionã§ç½®æ›æ¸ˆã¿
            const squareInterval = 500; // 0.5ç§’é–“éš”
            progressSquares.forEach((square, index) => {
                setTimeout(() => {
                    square.classList.add('consumed');
                    
                    // æœ€å¾Œã®å››è§’ãŒæ¶ˆå»ã•ã‚ŒãŸã‚‰ãƒ‰ãƒ¬ãƒŸã‚¬ã‚¤ãƒ‰é–‹å§‹
                    if (index === progressSquares.length - 1) {
                        startDoremiGuide();
                    }
                }, squareInterval * index);
            });
        }

        function startDoremiGuide() {
            const circles = document.querySelectorAll('.note-circle');
            const micBadge = document.getElementById('mic-badge');
            let currentIndex = 0;
            
            // ãƒã‚¤ã‚¯ãƒãƒƒã‚¸ã‚’èªè­˜ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«
            micBadge.classList.add('measuring');
            
            const interval = setInterval(() => {
                if (currentIndex > 0) {
                    circles[currentIndex - 1].classList.remove('current');
                    circles[currentIndex - 1].classList.add('completed');
                }
                
                if (currentIndex < circles.length) {
                    circles[currentIndex].classList.add('current');
                    currentIndex++;
                } else {
                    clearInterval(interval);
                    // æ—§å®Ÿè£…ï¼šTrainingSessionã§ç½®æ›æ¸ˆã¿
                    // handleTrainingComplete();
                }
            }, 662.5); // 5.3ç§’ Ã· 8éŸ³ = 662.5ms
        }

        // æ—§å®Ÿè£…ï¼ˆTrainingSessionã§ç½®æ›æ¸ˆã¿ï¼‰
        function handleTrainingCompleteOld() {
            // ã“ã®é–¢æ•°ã¯å‰Šé™¤äºˆå®š
        }
        
        document.head.appendChild(script);
    </script>
</body>
</html>