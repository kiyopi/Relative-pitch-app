<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トレーニング前の準備 - 8va相対音感トレーニング</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/results.css">
    <link rel="stylesheet" href="../styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">トレーニング前の準備</h1>
                    <p class="page-subtitle text-green-200">ランダム基音モード へのアクセス</p>
                </div>
            </div>
        </header>


        <!-- メインコンテンツ -->
        <main class="narrow-main">
            <!-- ステータス表示 -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: マイク許可 -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">マイク許可</p>
                    </div>
                    
                    <!-- 接続線 -->
                    <div class="step-connector" id="connector-1"></div>
                    
                    <!-- Step 2: 音声テスト -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">音声テスト</p>
                    </div>
                    
                    <!-- 接続線 -->
                    <div class="step-connector" id="connector-2"></div>
                    
                    <!-- Step 3: 音域テスト -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-3">
                            <i data-lucide="music" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">音域テスト</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- マイク許可セクション -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">マイクロフォンの許可</h3>
                        <p class="section-description">音程検出のためマイクロフォンへのアクセスが必要です</p>
                    </div>
                    
                    <div class="info-alert">
                        <i data-lucide="shield-check" style="width: 48px; height: 48px; color: #60a5fa;"></i>
                        <p>音声データは外部に送信されません。ブラウザ内でリアルタイム処理されます。</p>
                    </div>
                    
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>マイクを許可</span>
                    </button>
                </section>

                <!-- 音声テストセクション -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">音声テスト</h3>
                        <p class="section-description">音量と周波数検出を確認します</p>
                    </div>
                    
                    <div class="voice-instruction">
                        <div class="voice-instruction-icon">
                            <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                        </div>
                        <p class="voice-instruction-text" id="voice-instruction-text">「ド」を発声してください</p>
                        <div class="voice-instruction-pulse"></div>
                    </div>
                    
                    <!-- 音量レベル -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>音量レベル</span>
                            <span class="meter-value" id="volume-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- 検出周波数 -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>検出周波数</span>
                            <span class="meter-value" id="frequency-value">261.6 Hz (C4)</span>
                        </div>
                    </div>
                    
                    <!-- 進捗表示エリア（新追加） -->
                    <div class="meter-group" id="progress-display" style="display: none;">
                        <div class="text-center p-4 bg-blue-500 bg-opacity-20 rounded-lg border border-blue-300 border-opacity-30">
                            <div class="text-sm text-blue-200 mb-2">検出進捗</div>
                            <div class="text-lg font-semibold text-white" id="progress-text">「ド」を発声してください</div>
                            <div class="mt-2 text-xs text-blue-300" id="progress-detail">時間・回数の条件をクリアしてください</div>
                        </div>
                    </div>

                    <div class="success-alert" id="detection-success">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p id="detection-success-message">「ド」の音程を検出できました！音域テストに進みましょう。</p>
                    </div>

                    <!-- 音域設定済みの場合の表示 -->
                    <div class="glass-card hidden" id="range-saved-display">
                        <h4 class="heading-sm">
                            <i data-lucide="check-circle" class="text-green-400"></i>
                            <span>音域設定済み</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>音域範囲</span>
                                <span class="range-info-value" id="saved-range">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>オクターブ数</span>
                                <span class="range-info-value" id="saved-octaves">2.6オクターブ</span>
                            </div>
                            <div class="range-info-row">
                                <span>設定日時</span>
                                <span class="range-info-value" id="saved-date">2024-01-01</span>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-success" id="skip-range-test-btn">
                                <span>スキップして練習開始</span>
                                <i data-lucide="skip-forward" style="width: 20px; height: 20px;"></i>
                            </button>
                            <button class="btn btn-primary" id="retest-range-btn">
                                <span>音域を再テスト</span>
                                <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary hidden" id="start-range-test-btn">
                        <span>音域テストを開始</span>
                        <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                    </button>
                </section>

                <!-- 音域テストセクション -->
                <section class="test-section hidden" id="range-test-section">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-section-title">音域テスト</h3>
                                <p class="section-description">あなたの快適な音域を測定しています</p>
                            </div>
                            <div class="test-instruction" style="flex-shrink: 0;">
                                <i data-lucide="mic" class="text-red-400" style="width: 32px; height: 32px;"></i>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- テスト指示 -->
                    <div class="text-center mb-6">
                        <h4 class="text-sub-title" id="test-instruction-text">音域を測定します</h4>
                    </div>
                    
                    <!-- 検出状況 -->
                    <div class="detection-meters">
                        <!-- 音域テスト表示 -->
                        <div class="range-test-layout-flex">
                            <!-- 中央: 音程バッジと円形プログレスバー -->
                            <div class="range-test-item">
                                <div class="voice-range-display-container">
                                    <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16" 
                                                stroke-dasharray="452" stroke-dashoffset="452" 
                                                transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                                    </svg>
                                    <div class="voice-note-badge">
                                        <i data-lucide="arrow-down" id="range-icon" style="width: 80px; height: 80px; color: white; display: block;"></i>
                                        <p class="countdown-text" id="countdown-display" style="display: none;">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>

                    <p class="test-status" id="test-status">待機中...</p>
                </section>

                <!-- 結果表示セクション -->
                <section class="test-section hidden" id="result-section">
                    <div class="section-header">
                        <h3 class="text-section-title">テスト完了</h3>
                        <p class="section-description">音域テストが完了しました</p>
                    </div>
                    
                    <div class="result-card">
                        <h4 class="heading-sm">
                            <i data-lucide="music" class="text-orange-400"></i>
                            <span>あなたの音域</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>音域範囲</span>
                                <span class="range-info-value">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>オクターブ数</span>
                                <span class="range-info-value">2.6オクターブ</span>
                            </div>
                        </div>
                    </div>

                    <div class="success-alert">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p>最適な基音が自動選択されます。この結果でよろしいですか？</p>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button class="btn btn-outline" id="remeasure-range-btn">
                            <span>再測定</span>
                            <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                        </button>
                        <button class="btn btn-success" id="start-training-btn">
                            <span>この結果でトレーニング開始</span>
                            <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- JavaScript モジュール -->
    <script src="../../../js/data-manager.js"></script>
    <script src="../../../js/audio-processor.js"></script>
    <script src="../../../js/volume-bar-controller.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- JavaScript外部ファイル化完了 -->
    <script src="../../../js/preparation.js"></script>
</body>
</html>