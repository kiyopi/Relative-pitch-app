<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®æº–å‚™ - 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/results.css">
    <link rel="stylesheet" href="../styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®æº–å‚™</h1>
                    <p class="page-subtitle text-green-200">ãƒ©ãƒ³ãƒ€ãƒ åŸºéŸ³ãƒ¢ãƒ¼ãƒ‰ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹</p>
                </div>
            </div>
        </header>


        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: ãƒã‚¤ã‚¯è¨±å¯ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">ãƒã‚¤ã‚¯è¨±å¯</p>
                    </div>
                    
                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-1"></div>
                    
                    <!-- Step 2: éŸ³å£°ãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³å£°ãƒ†ã‚¹ãƒˆ</p>
                    </div>
                    
                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-2"></div>
                    
                    <!-- Step 3: éŸ³åŸŸãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-3">
                            <i data-lucide="music" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³åŸŸãƒ†ã‚¹ãƒˆ</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- ãƒã‚¤ã‚¯è¨±å¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã®è¨±å¯</h3>
                        <p class="section-description">éŸ³ç¨‹æ¤œå‡ºã®ãŸã‚ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</p>
                    </div>
                    
                    <div class="info-alert">
                        <i data-lucide="shield-check" style="width: 48px; height: 48px; color: #60a5fa;"></i>
                        <p>éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>
                    </button>
                </section>

                <!-- éŸ³å£°ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">éŸ³å£°ãƒ†ã‚¹ãƒˆ</h3>
                        <p class="section-description">éŸ³é‡ã¨å‘¨æ³¢æ•°æ¤œå‡ºã‚’ç¢ºèªã—ã¾ã™</p>
                    </div>
                    
                    <div class="voice-instruction">
                        <div class="voice-instruction-icon">
                            <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                        </div>
                        <p class="voice-instruction-text" id="voice-instruction-text">ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„</p>
                        <div class="voice-instruction-pulse"></div>
                    </div>
                    
                    <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                            <span class="meter-value" id="volume-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                            <span class="meter-value" id="frequency-value">261.6 Hz (C4)</span>
                        </div>
                    </div>
                    
                    <!-- é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆæ–°è¿½åŠ ï¼‰ -->
                    <div class="meter-group" id="progress-display" style="display: none;">
                        <div class="text-center p-4 bg-blue-500 bg-opacity-20 rounded-lg border border-blue-300 border-opacity-30">
                            <div class="text-sm text-blue-200 mb-2">æ¤œå‡ºé€²æ—</div>
                            <div class="text-lg font-semibold text-white" id="progress-text">ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„</div>
                            <div class="mt-2 text-xs text-blue-300" id="progress-detail">æ™‚é–“ãƒ»å›æ•°ã®æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>

                    <div class="success-alert" id="detection-success">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p id="detection-success-message">ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                    </div>

                    <!-- éŸ³åŸŸè¨­å®šæ¸ˆã¿ã®å ´åˆã®è¡¨ç¤º -->
                    <div class="glass-card hidden" id="range-saved-display">
                        <h4 class="heading-sm">
                            <i data-lucide="check-circle" class="text-green-400"></i>
                            <span>éŸ³åŸŸè¨­å®šæ¸ˆã¿</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>éŸ³åŸŸç¯„å›²</span>
                                <span class="range-info-value" id="saved-range">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                                <span class="range-info-value" id="saved-octaves">2.6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</span>
                            </div>
                            <div class="range-info-row">
                                <span>è¨­å®šæ—¥æ™‚</span>
                                <span class="range-info-value" id="saved-date">2024-01-01</span>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-success" id="skip-range-test-btn">
                                <span>ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç·´ç¿’é–‹å§‹</span>
                                <i data-lucide="skip-forward" style="width: 20px; height: 20px;"></i>
                            </button>
                            <button class="btn btn-primary" id="retest-range-btn">
                                <span>éŸ³åŸŸã‚’å†ãƒ†ã‚¹ãƒˆ</span>
                                <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary hidden" id="start-range-test-btn">
                        <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹</span>
                        <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                    </button>
                </section>

                <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="range-test-section">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-section-title">éŸ³åŸŸãƒ†ã‚¹ãƒˆ</h3>
                                <p class="section-description">ã‚ãªãŸã®å¿«é©ãªéŸ³åŸŸã‚’æ¸¬å®šã—ã¦ã„ã¾ã™</p>
                            </div>
                            <div class="test-instruction" style="flex-shrink: 0;">
                                <i data-lucide="mic" class="text-red-400" style="width: 32px; height: 32px;"></i>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- ãƒ†ã‚¹ãƒˆæŒ‡ç¤º -->
                    <div class="text-center mb-6">
                        <h4 class="text-sub-title" id="test-instruction-text">éŸ³åŸŸã‚’æ¸¬å®šã—ã¾ã™</h4>
                    </div>
                    
                    <!-- æ¤œå‡ºçŠ¶æ³ -->
                    <div class="detection-meters">
                        <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆè¡¨ç¤º -->
                        <div class="range-test-layout-flex">
                            <!-- ä¸­å¤®: éŸ³ç¨‹ãƒãƒƒã‚¸ã¨å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                            <div class="range-test-item">
                                <div class="voice-range-display-container">
                                    <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16" 
                                                stroke-dasharray="452" stroke-dashoffset="452" 
                                                transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                                    </svg>
                                    <div class="voice-note-badge">
                                        <i data-lucide="arrow-down" id="range-icon" style="width: 80px; height: 80px; color: white; display: block;"></i>
                                        <p class="countdown-text" id="countdown-display" style="display: none;">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>

                    <p class="test-status" id="test-status">å¾…æ©Ÿä¸­...</p>
                </section>

                <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="result-section">
                    <div class="section-header">
                        <h3 class="text-section-title">ãƒ†ã‚¹ãƒˆå®Œäº†</h3>
                        <p class="section-description">éŸ³åŸŸãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ</p>
                    </div>
                    
                    <div class="result-card">
                        <h4 class="heading-sm">
                            <i data-lucide="music" class="text-orange-400"></i>
                            <span>ã‚ãªãŸã®éŸ³åŸŸ</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>éŸ³åŸŸç¯„å›²</span>
                                <span class="range-info-value">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                                <span class="range-info-value">2.6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</span>
                            </div>
                        </div>
                    </div>

                    <div class="success-alert">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p>æœ€é©ãªåŸºéŸ³ãŒè‡ªå‹•é¸æŠã•ã‚Œã¾ã™ã€‚ã“ã®çµæœã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button class="btn btn-outline" id="remeasure-range-btn">
                            <span>å†æ¸¬å®š</span>
                            <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                        </button>
                        <button class="btn btn-success" id="start-training-btn">
                            <span>ã“ã®çµæœã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</span>
                            <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- JavaScript ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script src="../../../js/data-manager.js"></script>
    <script src="../../../js/audio-processor.js"></script>
    <script src="../../../js/volume-bar-controller.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- TODO: å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ– /js/preparation.js -->
    <!-- é–‹ç™ºæœŸé–“ä¸­ã®ä¸€æ™‚çš„ãªã‚¤ãƒ³ãƒ©ã‚¤ãƒ³è¨˜è¿° -->
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«å®Ÿè£…å®Œäº†å¾Œã«å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ–å¿…é ˆ -->
    <script>
        lucide.createIcons();

        // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºï¼ˆCRITICAL_DECISIONS_AND_INSIGHTS.mdæº–æ‹  - iPadOS 13+ãƒã‚°å¯¾ç­–ï¼‰
        function detectDeviceWithSpecs() {
            const userAgent = navigator.userAgent; // toLowerCaseå‰Šé™¤ï¼ˆå¤§æ–‡å­—å°æ–‡å­—åŒºåˆ¥é‡è¦ï¼‰
            
            // iPadOS 13+ å®Œå…¨å¯¾å¿œæ¤œå‡ºãƒ­ã‚¸ãƒƒã‚¯
            const isIPhone = /iPhone/.test(userAgent);
            const isIPad = /iPad/.test(userAgent);
            const isIPadOS = /Macintosh/.test(userAgent) && 'ontouchend' in document; // iPadOS 13+å½è£…å¯¾ç­–
            const hasIOSNavigator = /iPad|iPhone|iPod/.test(userAgent);
            const hasIOSPlatform = /iPad|iPhone|iPod/.test((navigator).platform || '');
            
            // è¤‡æ•°æ–¹å¼ã«ã‚ˆã‚‹ç·åˆåˆ¤å®š
            const isIOS = isIPhone || isIPad || isIPadOS || hasIOSNavigator || hasIOSPlatform;
            
            let deviceType = 'PC';
            let sensitivityMultiplier = 2.5; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®š
            let volumeBarScale = 4.0; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®š
            
            if (isIPhone) {
                deviceType = 'iPhone';
                sensitivityMultiplier = 3.5; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®š
                volumeBarScale = 4.5; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®š
            } else if (isIPad || isIPadOS) { // isIPadOSè¿½åŠ ãŒé‡è¦
                deviceType = 'iPad';
                sensitivityMultiplier = 5.0; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®š
                volumeBarScale = 7.0; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®š
            } else if (isIOS) {
                deviceType = 'iOS Device';
                sensitivityMultiplier = 3.5; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                volumeBarScale = 4.5;
            }
            
            return {
                deviceType,
                sensitivityMultiplier,
                volumeBarScale,
                isIOS,
                debugInfo: {
                    userAgent: userAgent,
                    detectionMethods: {
                        isIPhone,
                        isIPad,
                        isIPadOS, // iPadOS 13+æ¤œå‡ºçŠ¶æ…‹
                        hasIOSNavigator,
                        hasIOSPlatform,
                        touchSupport: 'ontouchend' in document
                    }
                }
            };
        }

        // DOMè¦ç´ ã®å–å¾—
        const requestMicBtn = document.getElementById('request-mic-btn');
        const startRangeTestBtn = document.getElementById('start-range-test-btn');
        const startTrainingBtn = document.getElementById('start-training-btn');
        
        const permissionSection = document.getElementById('permission-section');
        const audioTestSection = document.getElementById('audio-test-section');
        const rangeTestSection = document.getElementById('range-test-section');
        const resultSection = document.getElementById('result-section');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒã‚¤ã‚¹è¨­å®š
        const deviceSpecs = detectDeviceWithSpecs();
        console.log(`ğŸ” ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºçµæœ: ${deviceSpecs.deviceType}`, deviceSpecs);
        
        // iPadOS 13+ æ¤œå‡ºã®è©³ç´°ãƒ­ã‚°
        if (deviceSpecs.debugInfo.detectionMethods.isIPadOS) {
            console.log('âš ï¸ iPadOS 13+ æ¤œå‡º: Macintoshå½è£…ã‚’ç™ºè¦‹ãƒ»iPadåˆ¤å®šã«ä¿®æ­£', {
                userAgent: deviceSpecs.debugInfo.userAgent,
                touchSupport: deviceSpecs.debugInfo.detectionMethods.touchSupport,
                macintoshUA: /Macintosh/.test(deviceSpecs.debugInfo.userAgent),
                iPadUA: /iPad/.test(deviceSpecs.debugInfo.userAgent)
            });
        }

        // ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’localStorageã«ä¿å­˜ï¼ˆå¾Œç¶šãƒšãƒ¼ã‚¸ã§ä½¿ç”¨ï¼‰
        try {
            const deviceSettings = {
                deviceType: deviceSpecs.deviceType,
                sensitivityMultiplier: deviceSpecs.sensitivityMultiplier,
                volumeBarScale: deviceSpecs.volumeBarScale,
                isIOS: deviceSpecs.isIOS,
                detectedAt: new Date().toISOString(),
                userAgent: deviceSpecs.debugInfo.userAgent
            };
            localStorage.setItem('deviceSettings', JSON.stringify(deviceSettings));
            console.log('ğŸ’¾ ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’localStorageã«ä¿å­˜å®Œäº†');
        } catch (error) {
            console.warn('âš ï¸ ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã®ä¿å­˜ã«å¤±æ•—:', error);
        }

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
        function updateStepStatus(stepNumber, status) {
            const step = document.getElementById(`step-${stepNumber}`);
            if (step) {
                step.classList.remove('active', 'completed');
                if (status === 'active') {
                    step.classList.add('active');
                } else if (status === 'completed') {
                    step.classList.add('completed');
                }
            }
            
            // ã‚³ãƒã‚¯ã‚¿ãƒ¼ã®æ›´æ–°
            if (stepNumber > 1) {
                const connector = document.getElementById(`connector-${stepNumber - 1}`);
                if (connector && status === 'completed') {
                    connector.classList.add('active');
                }
            }
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showSection(sectionToShow) {
            [permissionSection, audioTestSection, rangeTestSection, resultSection].forEach(section => {
                section.classList.add('hidden');
            });
            sectionToShow.classList.remove('hidden');
        }
        
        // åˆæœŸçŠ¶æ…‹è¨­å®š
        updateStepStatus(1, 'active');

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒ­ã‚»ãƒƒã‚µãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let audioProcessor = null;
        
        // VolumeBarControllerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆæ–°çµ±åˆã‚·ã‚¹ãƒ†ãƒ ï¼‰
        let volumeBarController = null;

        // ãƒã‚¤ã‚¯è¨±å¯ãƒœã‚¿ãƒ³
        requestMicBtn.addEventListener('click', async () => {
            try {
                requestMicBtn.disabled = true;
                requestMicBtn.innerHTML = '<i data-lucide="loader" style="width: 24px; height: 24px;"></i><span>è¨±å¯ã‚’å¾…ã£ã¦ã„ã¾ã™...</span>';
                lucide.createIcons();

                // ãƒ‡ãƒã‚¤ã‚¹åˆ¥æœ€é©åŒ–AudioProcessoråˆæœŸåŒ–
                console.log(`ğŸš€ AudioProcessoråˆæœŸåŒ–é–‹å§‹ï¼ˆ${deviceSpecs.deviceType}ç”¨æœ€é©åŒ–ï¼‰...`);
                audioProcessor = new AudioProcessor();
                console.log('ğŸ“¦ AudioProcessorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆå®Œäº†');
                
                const initResult = await audioProcessor.initialize();
                console.log('ğŸ” åˆæœŸåŒ–çµæœ:', initResult);
                
                if (!initResult.success) {
                    console.error('âŒ AudioProcessoråˆæœŸåŒ–å¤±æ•—:', initResult.error);
                    throw new Error(initResult.error);
                }

                // ãƒ‡ãƒã‚¤ã‚¹åˆ¥æ„Ÿåº¦è¨­å®šé©ç”¨
                console.log(`ğŸ”§ ${deviceSpecs.deviceType}ç”¨æ„Ÿåº¦è¨­å®šé©ç”¨: ${deviceSpecs.sensitivityMultiplier}x`);
                
                // TODO: AudioProcessorã®æ„Ÿåº¦è¨­å®šãƒ¡ã‚½ãƒƒãƒ‰ãŒå®Ÿè£…ã•ã‚Œæ¬¡ç¬¬é©ç”¨
                // audioProcessor.setSensitivity(deviceSpecs.sensitivityMultiplier);
                
                // VolumeBarControlleråˆæœŸåŒ–ï¼ˆæ–°çµ±åˆã‚·ã‚¹ãƒ†ãƒ ï¼‰
                console.log('ğŸšï¸ VolumeBarControlleråˆæœŸåŒ–é–‹å§‹...');
                try {
                    volumeBarController = new VolumeBarController({
                        updateInterval: 50,          // 20fpsæ›´æ–°
                        enableSmoothing: false,      // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç„¡åŠ¹ï¼ˆæ¨å¥¨ï¼‰
                        debugMode: true,             // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹
                        autoDetectDevice: true       // ãƒ‡ãƒã‚¤ã‚¹è‡ªå‹•æ¤œå‡º
                    });
                    
                    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®è¦ç´ ã«ã‚¯ãƒ©ã‚¹è¿½åŠ ï¼ˆVolumeBarControllerè‡ªå‹•æ¤œå‡ºç”¨ï¼‰
                    const volumePercentElement = document.getElementById('volume-value');
                    if (volumePercentElement) {
                        volumePercentElement.classList.add('volume-percent');
                    }
                    
                    // éŸ³é‡ãƒãƒ¼è¦ç´ ã‚’ç™»éŒ²ï¼ˆè¦ªã‚³ãƒ³ãƒ†ãƒŠã‚’ç™»éŒ²ã—ã¦progress-fillã¨.volume-percentã‚’è‡ªå‹•æ¤œå‡ºï¼‰
                    const volumeProgressElement = document.getElementById('volume-progress');
                    if (volumeProgressElement) {
                        const meterGroupContainer = volumeProgressElement.closest('.meter-group');
                        if (meterGroupContainer) {
                            volumeBarController.addVolumeBar('volume-bar-1', meterGroupContainer);
                            console.log('ğŸšï¸ éŸ³é‡ãƒãƒ¼è¦ªã‚³ãƒ³ãƒ†ãƒŠã‚’ç™»éŒ²:', meterGroupContainer);
                        } else {
                            console.warn('âš ï¸ meter-groupè¦ªã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                    }
                    
                    console.log('âœ… VolumeBarControlleråˆæœŸåŒ–å®Œäº†', {
                        deviceType: volumeBarController.getDeviceSpecs().deviceType,
                        volumeBarScale: volumeBarController.getDeviceSpecs().volumeBarScale,
                        sensitivityMultiplier: volumeBarController.getDeviceSpecs().sensitivityMultiplier
                    });
                } catch (error) {
                    console.error('âŒ VolumeBarControlleråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã§ç¶™ç¶š
                }

                // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šï¼ˆVolumeBarControllerçµ±åˆæ–¹å¼ï¼‰
                audioProcessor.setCallbacks({
                    onPitchUpdate: (result) => {
                        console.log('ğŸµ onPitchUpdateçµ±åˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å—ä¿¡:', {
                            result: result,
                            volume: result?.volume,
                            volumeType: typeof result?.volume,
                            frequency: result?.frequency,
                            clarity: result?.clarity,
                            detectionActive: detectionActive
                        });
                        
                        // æ¤œå‡ºåœæ­¢ä¸­ã¯éŸ³é‡ãƒãƒ¼æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒã‚¤ã‚¯ãƒŸãƒ¥ãƒ¼ãƒˆé€£å‹•ï¼‰
                        console.log('ğŸ” detectionActiveçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯:', detectionActive);
                        if (!detectionActive) {
                            console.log('â¸ï¸ æ¤œå‡ºåœæ­¢ä¸­ã®ãŸã‚éŸ³é‡ãƒãƒ¼æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                            return;
                        }
                        console.log('â–¶ï¸ detectionActive=trueã®ãŸã‚å‡¦ç†ç¶™ç¶š');
                        
                        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³ç¨‹å‡¦ç†
                        handleRealPitchUpdate(result);
                        
                        // VolumeBarControllerçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã§éŸ³é‡ãƒãƒ¼æ›´æ–°
                        if (result && typeof result.volume === 'number' && volumeBarController) {
                            // VolumeBarControllerã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ‰‹å‹•å‘¼ã³å‡ºã—
                            volumeBarController.handlePitchUpdate(result);
                            
                            // ä½¿ç”¨çŠ¶æ³ãƒ­ã‚°ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ä¸¦è¡Œå‹•ä½œç¢ºèªç”¨ï¼‰
                            if (result.volume > 0.01 && detectionActive && Math.random() < 0.1) {
                                console.log('ğŸšï¸ VolumeBarControllerçµ±åˆã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ä¸­:', {
                                    rawVolume: result.volume.toFixed(3),
                                    deviceType: volumeBarController.getDeviceSpecs().deviceType,
                                    volumeBarScale: volumeBarController.getDeviceSpecs().volumeBarScale
                                });
                            }
                        }
                        
                        // æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã€æœ€çµ‚çš„ã«å‰Šé™¤äºˆå®šï¼‰
                        if (result && typeof result.volume === 'number' && !volumeBarController) {
                            const rawVolume = result.volume || 0;
                            
                            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥éŸ³é‡ãƒãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿è¨­å®šï¼‰
                            let scale = 4.0; // PCæ¨™æº–ï¼ˆå®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼‰
                            if (deviceSpecs?.deviceType === 'iPhone') {
                                scale = 4.5; // iPhone: æ„Ÿåº¦3.5x, éŸ³é‡ãƒãƒ¼4.5x
                            } else if (deviceSpecs?.deviceType === 'iPad') {
                                scale = 7.0; // iPad: æ„Ÿåº¦5.0x, éŸ³é‡ãƒãƒ¼7.0x  
                            }
                            
                            // åŸºæœ¬éŸ³é‡è¨ˆç®—
                            const adjustedVolume = rawVolume * scale * deviceSpecs.sensitivityMultiplier;
                            
                            // 0-100%åˆ¶é™
                            let volumePercent = Math.min(100, Math.max(0, adjustedVolume));
                            
                            const volumeProgress = document.getElementById('volume-progress');
                            const volumeValue = document.getElementById('volume-value');
                            
                            if (volumeProgress) {
                                volumeProgress.style.width = volumePercent + '%';
                            }
                            if (volumeValue) {
                                volumeValue.textContent = volumePercent.toFixed(0) + '%';
                            }
                            
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ãƒ­ã‚°
                            if (rawVolume > 0.01 && detectionActive && Math.random() < 0.1) {
                                console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨ä¸­:', {
                                    rawVolume: rawVolume.toFixed(3),
                                    scale: scale,
                                    volumePercent: volumePercent.toFixed(1)
                                });
                            }
                        }
                    },
                    onVolumeUpdate: (volume) => {
                        console.log('ğŸ”Š onVolumeUpdateï¼ˆåˆ†é›¢æ–¹å¼ï¼‰å—ä¿¡:', volume);
                        handleVolumeUpdate(volume, deviceSpecs.volumeBarScale);
                    },
                    onError: (context, error) => handleAudioError(context, error),
                    onStateChange: (state) => console.log('Audio state:', state)
                });
                
                // ã‚¹ãƒ†ãƒƒãƒ—1å®Œäº†ã€ã‚¹ãƒ†ãƒƒãƒ—2ã¸
                updateStepStatus(1, 'completed');
                updateStepStatus(2, 'active');
                
                showSection(audioTestSection);
                startRealAudioDetection();
                
            } catch (error) {
                console.error('ãƒã‚¤ã‚¯è¨±å¯ã‚¨ãƒ©ãƒ¼:', error);
                requestMicBtn.disabled = false;
                requestMicBtn.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>ãƒã‚¤ã‚¯è¨±å¯å¤±æ•— - å†è©¦è¡Œ</span>';
                lucide.createIcons();
                
                alert(`ãƒã‚¤ã‚¯ã®è¨±å¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        });

        // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³
        const skipRangeTestBtn = document.getElementById('skip-range-test-btn');
        const retestRangeBtn = document.getElementById('retest-range-btn');
        
        if (skipRangeTestBtn) {
            skipRangeTestBtn.addEventListener('click', () => {
                // ã‚¹ãƒ†ãƒƒãƒ—2å®Œäº†ã€ç›´æ¥ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã¸
                updateStepStatus(2, 'completed');
                updateStepStatus(3, 'completed');
                window.location.href = 'training.html';
            });
        }
        
        if (retestRangeBtn) {
            retestRangeBtn.addEventListener('click', () => {
                // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ãƒ†ã‚¹ãƒˆ
                localStorage.removeItem('voiceRangeData');
                
                // ã‚¹ãƒ†ãƒƒãƒ—2å®Œäº†ã€ã‚¹ãƒ†ãƒƒãƒ—3ã¸
                updateStepStatus(2, 'completed');
                updateStepStatus(3, 'active');
                
                showSection(rangeTestSection);
                startRangeTest();
            });
        }

        // éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³
        startRangeTestBtn.addEventListener('click', () => {
            // ã‚¹ãƒ†ãƒƒãƒ—2å®Œäº†ã€ã‚¹ãƒ†ãƒƒãƒ—3ã¸
            updateStepStatus(2, 'completed');
            updateStepStatus(3, 'active');
            
            showSection(rangeTestSection);
            startRangeTest();
        });

        // å†æ¸¬å®šãƒœã‚¿ãƒ³
        const remeasureRangeBtn = document.getElementById('remeasure-range-btn');
        if (remeasureRangeBtn) {
            remeasureRangeBtn.addEventListener('click', () => {
                // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†ãƒ†ã‚¹ãƒˆ
                localStorage.removeItem('voiceRangeData');
                
                // ã‚¹ãƒ†ãƒƒãƒ—3ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«æˆ»ã™
                updateStepStatus(3, 'active');
                
                showSection(rangeTestSection);
                startRangeTest();
            });
        }

        // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ãƒœã‚¿ãƒ³
        startTrainingBtn.addEventListener('click', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode') || 'random';
            const session = urlParams.get('session') || '1';
            window.location.href = `training.html?mode=${mode}&session=${session}`;
        });

        // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºç”¨ã®å…±é€šé–¢æ•°
        function displaySavedRangeData(data, displayElement) {
            const savedRange = document.getElementById('saved-range');
            const savedOctaves = document.getElementById('saved-octaves');
            const savedDate = document.getElementById('saved-date');
            
            if (savedRange) savedRange.textContent = `${data.lowestNote} - ${data.highestNote}`;
            if (savedOctaves) savedOctaves.textContent = `${data.octaveCount}ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–`;
            if (savedDate) {
                const date = new Date(data.testDate);
                savedDate.textContent = date.toLocaleDateString('ja-JP');
            }
            
            // è¡¨ç¤ºè¦ç´ ã‚’è¡¨ç¤º
            if (displayElement) {
                setTimeout(() => {
                    displayElement.classList.remove('hidden');
                    // displayElement.classList.add('fade-in-up'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
                }, 200);
            }
        }

        // å®Ÿéš›ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ¤œå‡ºå‡¦ç†
        let detectionActive = false;
        let detectedCDoPitches = [];
        
        // éŸ³é‡ãƒãƒ¼è¡¨ç¤ºæ™‚é–“ä¿è¨¼ã®ãŸã‚ã®çŠ¶æ…‹ç®¡ç†
        let detectionStartTime = null;
        const MIN_DETECTION_TIME = 2000; // æœ€ä½2ç§’é–“ã¯éŸ³é‡ãƒãƒ¼è¡¨ç¤ºã‚’ä¿è¨¼
        const MIN_PITCH_DETECTIONS = 3;   // æœ€ä½3å›ã®éŸ³ç¨‹æ¤œå‡ºã‚’è¦æ±‚
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³ç¨‹æ¤œå‡ºé–‹å§‹
        function startRealAudioDetection() {
            console.log('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³ç¨‹æ¤œå‡ºé–‹å§‹');
            detectionActive = true;
            detectedCDoPitches = [];
            detectionStartTime = Date.now(); // é–‹å§‹æ™‚åˆ»è¨˜éŒ²
            audioProcessor.startDetection();
            
            // é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
            const progressDisplay = document.getElementById('progress-display');
            if (progressDisplay) {
                progressDisplay.style.display = 'block';
                console.log('ğŸ“Š é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
            }
            
            console.log('ğŸ• éŸ³é‡ãƒãƒ¼è¡¨ç¤ºä¿è¨¼é–‹å§‹:', {
                detectionStartTime: detectionStartTime,
                minTime: MIN_DETECTION_TIME + 'ms',
                minDetections: MIN_PITCH_DETECTIONS,
                startTimeReadable: new Date(detectionStartTime).toLocaleTimeString()
            });
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³ç¨‹æ›´æ–°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleRealPitchUpdate(result) {
            if (!detectionActive) {
                console.log('â¸ï¸ detectionActive=false ã®ãŸã‚éŸ³ç¨‹å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }
            
            // è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            console.log('ğŸµ handleRealPitchUpdateå‘¼ã³å‡ºã—:', {
                result: result,
                resultKeys: result ? Object.keys(result) : 'null',
                frequency: result?.frequency,
                volume: result?.volume,
                clarity: result?.clarity,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
            window.lastDetectedFrequency = result.frequency;
            window.lastDetectedClarity = result.clarity;
            window.lastDetectedVolume = result.volume || 0;
            
            const volumeProgress = document.getElementById('volume-progress');
            const volumeValue = document.getElementById('volume-value');
            const frequencyValue = document.getElementById('frequency-value');
            
            // éŸ³é‡è¡¨ç¤ºæ›´æ–°ï¼ˆçµ±åˆæ–¹å¼ã§å‡¦ç†æ¸ˆã¿ã®ãŸã‚ã€ã“ã®å‡¦ç†ã¯ä¸è¦ï¼‰
            // çµ±åˆæ–¹å¼ã®onPitchUpdateã§éŸ³é‡ãƒãƒ¼æ›´æ–°ã‚’å®Ÿè¡Œä¸­
            
            // å‘¨æ³¢æ•°è¡¨ç¤ºæ›´æ–°
            if (frequencyValue && result.frequency > 0) {
                const note = frequencyToNote(result.frequency);
                frequencyValue.textContent = `${result.frequency.toFixed(1)} Hz (${note})`;
                
                // C4éŸ³ç¨‹æ¤œå‡ºï¼ˆè¶…å¤§å¹…ç·©å’Œï¼š200Hzæœªæº€ã«ã‚‚å¯¾å¿œï¼‰
                const isFreqInRange = result.frequency >= 150 && result.frequency <= 400;
                const isClarityOK = result.clarity > 0.15;
                const isVolumeOK = result.volume > 0.03;
                
                console.log('ğŸ¯ C4æ¤œå‡ºãƒã‚§ãƒƒã‚¯:', {
                    frequency: result.frequency,
                    clarity: result.clarity,
                    volume: result.volume,
                    isInRange: isFreqInRange,
                    clarityOK: isClarityOK,
                    volumeOK: isVolumeOK,
                    allConditionsMet: isFreqInRange && isClarityOK && isVolumeOK
                });
                
                // æ¡ä»¶è¶…è¶…ç·©å’Œï¼š150-400Hzã€clarity>0.15ã€volume>0.03ï¼ˆæ¥µå°éŸ³é‡ãƒ»ä½éŸ³åŸŸå¯¾å¿œï¼‰
                if (result.frequency >= 150 && result.frequency <= 400 && 
                    result.clarity > 0.15 && result.volume > 0.03) {
                    detectedCDoPitches.push(result.frequency);
                    
                    const currentTime = Date.now();
                    
                    // detectionStartTimeãŒnullã§ãªã„ã“ã¨ã‚’ç¢ºèª
                    if (detectionStartTime === null) {
                        console.error('âŒ detectionStartTimeãŒnullã§ã™ï¼é–‹å§‹æ™‚åˆ»ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                        return;
                    }
                    
                    const elapsedTime = currentTime - detectionStartTime;
                    const timeConditionMet = elapsedTime >= MIN_DETECTION_TIME;
                    const countConditionMet = detectedCDoPitches.length >= MIN_PITCH_DETECTIONS;
                    
                    // è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                    console.log('ğŸ” è©³ç´°æ¡ä»¶ãƒã‚§ãƒƒã‚¯:', {
                        currentTime: currentTime,
                        detectionStartTime: detectionStartTime,
                        elapsedTime: elapsedTime,
                        MIN_DETECTION_TIME: MIN_DETECTION_TIME,
                        MIN_PITCH_DETECTIONS: MIN_PITCH_DETECTIONS,
                        timeConditionMet: timeConditionMet,
                        countConditionMet: countConditionMet,
                        detectionCount: detectedCDoPitches.length
                    });
                    
                    console.log('âœ… C4å€™è£œæ¤œå‡ºï¼', {
                        frequency: result.frequency,
                        detectedCount: detectedCDoPitches.length,
                        elapsedTime: elapsedTime + 'ms',
                        timeConditionMet: timeConditionMet,
                        countConditionMet: countConditionMet,
                        canProceed: timeConditionMet && countConditionMet
                    });
                    
                    // UIé€²æ—è¡¨ç¤ºã‚’æ›´æ–°
                    updateDetectionProgress(detectedCDoPitches.length, elapsedTime, timeConditionMet, countConditionMet);
                    
                    // æœ€ä½è¡¨ç¤ºæ™‚é–“ AND æœ€ä½æ¤œå‡ºå›æ•°ã®ä¸¡æ–¹ã‚’æº€ãŸã—ãŸå ´åˆã®ã¿æˆåŠŸ
                    if (timeConditionMet && countConditionMet) {
                        console.log('ğŸ‰ C4æ¤œå‡ºæˆåŠŸï¼æ™‚é–“ãƒ»å›æ•°æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ â†’ showDetectionSuccess()å‘¼ã³å‡ºã—');
                        showDetectionSuccess();
                    } else if (!timeConditionMet) {
                        console.log('â³ ã¾ã æœ€ä½è¡¨ç¤ºæ™‚é–“æœªé”æˆ:', {
                            required: MIN_DETECTION_TIME + 'ms',
                            elapsed: elapsedTime + 'ms',
                            remaining: (MIN_DETECTION_TIME - elapsedTime) + 'ms'
                        });
                    } else if (!countConditionMet) {
                        console.log('ğŸ”¢ ã¾ã æœ€ä½æ¤œå‡ºå›æ•°æœªé”æˆ:', {
                            required: MIN_PITCH_DETECTIONS,
                            current: detectedCDoPitches.length,
                            remaining: (MIN_PITCH_DETECTIONS - detectedCDoPitches.length)
                        });
                    }
                } else {
                    // æ¡ä»¶æœªé”æˆã®è©³ç´°ãƒ­ã‚°
                    if (result.frequency > 0) {
                        console.log('âš ï¸ C4æ¤œå‡ºæ¡ä»¶æœªé”æˆ:', {
                            frequency: result.frequency,
                            frequencyInRange: result.frequency >= 150 && result.frequency <= 400,
                            clarityOK: result.clarity > 0.15,
                            volumeOK: result.volume > 0.03
                        });
                    }
                }
            }
        }

        // éŸ³é‡æ›´æ–°ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒã‚¤ã‚¹åˆ¥æœ€é©åŒ–å¯¾å¿œï¼‰
        function handleVolumeUpdate(volume, volumeScale = null) {
            // è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            console.log('ğŸ“Š handleVolumeUpdateå‘¼ã³å‡ºã—:', {
                volume: volume,
                volumeScale: volumeScale,
                deviceSpecs: deviceSpecs?.volumeBarScale,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ãƒãƒ¼æ›´æ–°
            const volumeProgress = document.getElementById('volume-progress');
            if (volumeProgress) {
                // ãƒ‡ãƒã‚¤ã‚¹åˆ¥éŸ³é‡ãƒãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨
                const scale = volumeScale || deviceSpecs.volumeBarScale;
                const adjustedVolume = volume * scale;
                
                // volumeå€¤ã‚’0-100%ã«å¤‰æ›
                const volumePercent = Math.min(100, Math.max(0, adjustedVolume * 100));
                volumeProgress.style.width = volumePercent + '%';
                
                // è©³ç´°ãƒ­ã‚°å‡ºåŠ›
                console.log('ğŸšï¸ éŸ³é‡ãƒãƒ¼æ›´æ–°:', {
                    rawVolume: volume,
                    scale: scale,
                    adjustedVolume: adjustedVolume,
                    volumePercent: volumePercent,
                    elementFound: !!volumeProgress
                });
                
                // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆãƒ‡ãƒã‚¤ã‚¹æœ€é©åŒ–æƒ…å ±å«ã‚€ï¼‰
                if (scale !== 1.0) {
                    console.log(`ğŸ“Š Volume update [${deviceSpecs.deviceType}]:`, 
                        `${volume.toFixed(3)} Ã— ${scale}x = ${adjustedVolume.toFixed(3)} â†’ ${volumePercent.toFixed(1)}%`);
                } else {
                    console.log('ğŸ“Š Volume update:', volume, 'â†’', volumePercent + '%');
                }
            }
        }

        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        function handleAudioError(context, error) {
            console.error(`Audio Error [${context}]:`, error);
            detectionActive = false;
            
            const requestMicBtn = document.getElementById('request-mic-btn');
            requestMicBtn.disabled = false;
            requestMicBtn.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>ã‚¨ãƒ©ãƒ¼ - å†è©¦è¡Œ</span>';
            lucide.createIcons();
            
            alert(`ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¨ãƒ©ãƒ¼: ${error.message}\nãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚`);
        }
        
        // UIé€²æ—è¡¨ç¤ºæ›´æ–°ï¼ˆéŸ³ç¨‹æ¤œå‡ºãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼‰
        function updateDetectionProgress(detectionCount, elapsedTime, timeConditionMet, countConditionMet) {
            console.log('ğŸ“± updateDetectionProgresså‘¼ã³å‡ºã—:', {
                detectionCount, elapsedTime, timeConditionMet, countConditionMet
            });
            
            const voiceInstructionText = document.getElementById('voice-instruction-text');
            console.log('ğŸ¯ voice-instruction-textè¦ç´ :', voiceInstructionText);
            
            if (!voiceInstructionText) {
                console.error('âŒ voice-instruction-textè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
                return;
            }
            
            const timeProgress = Math.min(100, (elapsedTime / MIN_DETECTION_TIME) * 100);
            const countProgress = Math.min(100, (detectionCount / MIN_PITCH_DETECTIONS) * 100);
            
            let newText = '';
            
            if (timeConditionMet && countConditionMet) {
                newText = 'âœ… æ¤œå‡ºå®Œäº†ï¼ã¾ã‚‚ãªãæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸...';
            } else {
                const timeRemaining = Math.max(0, Math.ceil((MIN_DETECTION_TIME - elapsedTime) / 1000));
                const countRemaining = Math.max(0, MIN_PITCH_DETECTIONS - detectionCount);
                
                if (!timeConditionMet && !countConditionMet) {
                    newText = `ã€Œãƒ‰ã€ã‚’ç¶™ç¶š (${timeRemaining}ç§’, ${countRemaining}å›æ¤œå‡ºå¿…è¦)`;
                } else if (!timeConditionMet) {
                    newText = `ã€Œãƒ‰ã€ã‚’ç¶™ç¶š (ã‚ã¨${timeRemaining}ç§’)`;
                } else if (!countConditionMet) {
                    newText = `ã€Œãƒ‰ã€ã‚’ç¶™ç¶š (ã‚ã¨${countRemaining}å›æ¤œå‡ºå¿…è¦)`;
                }
            }
            
            console.log('ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°:', {
                oldText: voiceInstructionText.textContent,
                newText: newText
            });
            
            voiceInstructionText.textContent = newText;
            
            // è¦–è¦šçš„ã«ç›®ç«‹ãŸã›ã‚‹ãŸã‚ã€è‰²ã‚‚å¤‰æ›´
            if (timeConditionMet && countConditionMet) {
                voiceInstructionText.style.color = '#22c55e'; // ç·‘è‰²
            } else {
                voiceInstructionText.style.color = '#f59e0b'; // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
            }
            
            // å°‚ç”¨é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚‚æ›´æ–°
            const progressText = document.getElementById('progress-text');
            const progressDetail = document.getElementById('progress-detail');
            
            if (progressText) {
                progressText.textContent = newText;
                progressText.style.color = timeConditionMet && countConditionMet ? '#22c55e' : '#ffffff';
                console.log('ğŸ“Š progress-textæ›´æ–°å®Œäº†:', newText);
            }
            
            if (progressDetail) {
                const timeRemaining = Math.max(0, Math.ceil((MIN_DETECTION_TIME - elapsedTime) / 1000));
                const countRemaining = Math.max(0, MIN_PITCH_DETECTIONS - detectionCount);
                const timePercent = Math.min(100, Math.round((elapsedTime / MIN_DETECTION_TIME) * 100));
                const countPercent = Math.min(100, Math.round((detectionCount / MIN_PITCH_DETECTIONS) * 100));
                
                progressDetail.textContent = `æ™‚é–“: ${timePercent}% (${timeRemaining}ç§’æ®‹ã‚Š) | å›æ•°: ${countPercent}% (${countRemaining}å›æ®‹ã‚Š)`;
                console.log('ğŸ“Š progress-detailæ›´æ–°å®Œäº†:', progressDetail.textContent);
            }
        }

        // æ¤œå‡ºæˆåŠŸè¡¨ç¤º
        function showDetectionSuccess() {
            console.log('ğŸ‰ showDetectionSuccesså®Ÿè¡Œé–‹å§‹');
            
            detectionActive = false;
            audioProcessor.stopDetection();
            console.log('ğŸ›‘ éŸ³ç¨‹æ¤œå‡ºåœæ­¢å®Œäº†');
            
            // VolumeBarControllerçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã§éŸ³é‡ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            if (volumeBarController) {
                console.log('ğŸšï¸ VolumeBarController.stop()ã§ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ');
                volumeBarController.stop(); // çµ±ä¸€ã•ã‚ŒãŸãƒªã‚»ãƒƒãƒˆãƒ»åœæ­¢å‡¦ç†
            } else {
                console.log('âš ï¸ VolumeBarControllerãŒåˆ©ç”¨ä¸å¯ã®ãŸã‚æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆï¼ˆVolumeBarControlleråˆæœŸåŒ–å¤±æ•—æ™‚ï¼‰
                const volumeProgress = document.getElementById('volume-progress');
                const volumeValue = document.getElementById('volume-value');
                if (volumeProgress) {
                    volumeProgress.style.transition = 'none';
                    volumeProgress.style.width = '0%';
                    volumeProgress.style.opacity = '0.3';
                    setTimeout(() => {
                        if (volumeProgress) {
                            volumeProgress.style.transition = 'width 0.5s ease';
                        }
                    }, 200);
                }
                if (volumeValue) {
                    volumeValue.textContent = '0%';
                }
            }
            
            // é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            const progressDisplay = document.getElementById('progress-display');
            if (progressDisplay) {
                progressDisplay.style.display = 'none';
                console.log('ğŸ“Š é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
            }
            
            const detectionSuccess = document.getElementById('detection-success');
            const startRangeBtn = document.getElementById('start-range-test-btn');
            const rangeSavedDisplay = document.getElementById('range-saved-display');
            
            console.log('ğŸ“‹ è¦ç´ å–å¾—ç¢ºèª:', {
                detectionSuccess: !!detectionSuccess,
                startRangeBtn: !!startRangeBtn,
                rangeSavedDisplay: !!rangeSavedDisplay
            });
            
            if (detectionSuccess) {
                // éŸ³å£°æŒ‡ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å³åº§ã«éè¡¨ç¤º
                const voiceInstruction = document.querySelector('.voice-instruction');
                if (voiceInstruction) {
                    // å³åº§ã«å¼·åˆ¶éè¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å•é¡Œã‚’å®Œå…¨ã«å›é¿ï¼‰
                    voiceInstruction.style.display = 'none';
                    voiceInstruction.classList.add('hidden');
                    voiceInstruction.classList.add('collapse-out');
                    console.log('âœ… voice-instruction ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼·åˆ¶éè¡¨ç¤º');
                }
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ï¼ˆéŸ³é‡ãƒãƒ¼ç«¶åˆå›é¿ï¼‰
                // detectionSuccess.classList.remove('hidden'); // æ—¢ã«è¡¨ç¤ºæ¸ˆã¿
                // detectionSuccess.classList.add('fade-in-up'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
                console.log('âœ… detection-success ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰');
                
                // æ—¢å­˜ã®éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
                const voiceRangeData = DataManager.getVoiceRangeData();
                const successMessage = document.getElementById('detection-success-message');
                
                if (voiceRangeData && rangeSavedDisplay) {
                    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                    if (successMessage) {
                        successMessage.textContent = 'ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸã¯è¨­å®šæ¸ˆã¿ã§ã™ã€‚';
                    }
                    displaySavedRangeData(voiceRangeData.results, rangeSavedDisplay);
                } else {
                    // æ–°è¦éŸ³åŸŸãƒ†ã‚¹ãƒˆãŒå¿…è¦
                    if (successMessage) {
                        successMessage.textContent = 'ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚';
                    }
                    
                    if (startRangeBtn) {
                        setTimeout(() => {
                            startRangeBtn.classList.remove('hidden');
                            // startRangeBtn.classList.add('fade-in-up'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
                        }, 500);
                    }
                }
            }
        }

        // å‘¨æ³¢æ•°ã‹ã‚‰éŸ³åå¤‰æ›
        function frequencyToNote(frequency) {
            const A4_FREQ = 440.0;
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            const semitones = Math.round(12 * Math.log2(frequency / A4_FREQ));
            const octave = Math.floor((semitones + 9) / 12) + 4;
            const noteIndex = (semitones + 9 + 120) % 12; // è² æ•°å¯¾å¿œ
            
            return `${noteNames[noteIndex]}${octave}`;
        }

        // éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‰Šé™¤äºˆå®šï¼‰
        function startVolumeSimulation() {
            console.log('éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            const volumeProgress = document.getElementById('volume-progress');
            const volumeValue = document.getElementById('volume-value');
            const frequencyValue = document.getElementById('frequency-value');
            const detectionSuccess = document.getElementById('detection-success');
            const startRangeBtn = document.getElementById('start-range-test-btn');
            const rangeSavedDisplay = document.getElementById('range-saved-display');
            
            // è¦ç´ ã®å­˜åœ¨ç¢ºèª
            if (!volumeProgress || !volumeValue || !frequencyValue) {
                console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let detectionCount = 0;

            const interval = setInterval(() => {
                const volume = Math.floor(Math.random() * 30) + 50; // 50-80%
                // C4ï¼ˆãƒ‰ï¼‰ä»˜è¿‘ã®å‘¨æ³¢æ•°ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼ˆ261.6Hzå‰å¾Œï¼‰
                const frequency = (Math.random() * 20 + 251.6).toFixed(1); // 251.6-271.6Hz
                
                volumeProgress.style.width = volume + '%';
                volumeValue.textContent = volume + '%';
                
                // å‘¨æ³¢æ•°ã«éŸ³åã‚’è¿½åŠ 
                const isC4 = (frequency >= 255 && frequency <= 268);
                const note = isC4 ? ' (C4)' : ' (è¿‘ä¼¼)';
                frequencyValue.textContent = frequency + ' Hz' + note;
                
                console.log(`å‘¨æ³¢æ•°: ${frequency} Hz, C4åˆ¤å®š: ${isC4}, ã‚«ã‚¦ãƒ³ãƒˆ: ${detectionCount}`);
                
                // C4ã‚’æ¤œå‡ºã—ãŸã‚‰ã‚«ã‚¦ãƒ³ãƒˆ
                if (isC4) {
                    detectionCount++;
                    
                    // 3å›C4ã‚’æ¤œå‡ºã—ãŸã‚‰æˆåŠŸã¨åˆ¤å®š
                    if (detectionCount >= 3) {
                        console.log('æ¤œå‡ºæˆåŠŸï¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º');
                        
                        if (detectionSuccess && detectionSuccess.classList.contains('hidden')) {
                            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒœã‚¿ãƒ³ã‚’å³åº§ã«è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ï¼‰
                            detectionSuccess.classList.remove('hidden');
                            // detectionSuccess.classList.add('fade-in-up'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
                            
                            // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ”¹å–„ç‰ˆ - DataManagerä½¿ç”¨ï¼‰
                            console.log('ğŸ” éŸ³åŸŸãƒ‡ãƒ¼ã‚¿å­˜åœ¨ãƒã‚§ãƒƒã‚¯:', {
                                hasExistingRangeData: window.hasExistingRangeData,
                                existingRangeData: window.existingRangeData
                            });
                            
                            const successMessage = document.getElementById('detection-success-message');
                            
                            if (window.hasExistingRangeData && window.existingRangeData && rangeSavedDisplay) {
                                // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼ˆã‚¹ã‚­ãƒƒãƒ—è¡¨ç¤ºï¼‰
                                const data = window.existingRangeData;
                                const rangeDisplay = `${data.lowestNote} - ${data.highestNote}`;
                                
                                if (successMessage) {
                                    successMessage.textContent = `ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸã¯è¨­å®šæ¸ˆã¿ã§ã™ï¼ˆ${rangeDisplay}ï¼‰ã€‚`;
                                }
                                
                                // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹å…±é€šé–¢æ•°ã‚’å‘¼ã³å‡ºã—
                                displaySavedRangeData(data, rangeSavedDisplay);
                                console.log('âœ… éŸ³åŸŸãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºå®Œäº† - ã‚¹ã‚­ãƒƒãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º');
                                
                            } else {
                                // æ–°è¦éŸ³åŸŸãƒ†ã‚¹ãƒˆãŒå¿…è¦
                                console.log('ğŸ“‹ æ–°è¦éŸ³åŸŸãƒ†ã‚¹ãƒˆæº–å‚™');
                                if (successMessage) {
                                    successMessage.textContent = 'ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚';
                                }
                                
                                if (startRangeTestBtn) {
                                    setTimeout(() => {
                                        startRangeTestBtn.classList.remove('hidden');
                                        console.log('ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º');
                                    }, 200);
                                }
                            }
                            
                            // éŸ³å£°æŒ‡ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é«˜ã•ç¸®å°ã§éè¡¨ç¤º
                            const voiceInstruction = document.querySelector('.voice-instruction');
                            if (voiceInstruction) {
                                voiceInstruction.classList.add('collapse-out');
                                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
                                setTimeout(() => {
                                    voiceInstruction.classList.add('hidden');
                                }, 1000);
                            }
                            
                            // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’åœæ­¢
                            clearInterval(interval);
                        }
                    }
                }
            }, 800);
        }

        // éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå®Ÿéš›ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ¤œå‡ºï¼‰
        function startRangeTest() {
            console.log('ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ - å‹•çš„å®Ÿè£…ç‰ˆ');
            
            // VolumeBarControllerçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã§éŸ³é‡ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            if (volumeBarController) {
                console.log('ğŸšï¸ VolumeBarController.stop()ã§ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œï¼ˆéŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ï¼‰');
                volumeBarController.stop(); // çµ±ä¸€ã•ã‚ŒãŸãƒªã‚»ãƒƒãƒˆå‡¦ç†
            } else {
                console.log('âš ï¸ VolumeBarControllerãŒåˆ©ç”¨ä¸å¯ã®ãŸã‚æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œï¼ˆéŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹æ™‚ï¼‰');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ãƒªã‚»ãƒƒãƒˆï¼ˆVolumeBarControlleråˆæœŸåŒ–å¤±æ•—æ™‚ï¼‰
                const volumeProgress = document.getElementById('volume-progress');
                const volumeValue = document.getElementById('volume-value');
                if (volumeProgress) {
                    volumeProgress.style.width = '0%';
                    volumeProgress.style.opacity = '0.3';
                }
                if (volumeValue) {
                    volumeValue.textContent = '0%';
                }
            }
            
            // UIè¦ç´ ã®å–å¾—
            const testInstructionText = document.getElementById('test-instruction-text');
            const testStatus = document.getElementById('test-status');
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆçŠ¶æ…‹ç®¡ç†
            let currentPhase = 'low'; // 'low' or 'high'
            let testResults = {
                lowestNote: null,
                lowestFrequency: null,
                highestNote: null,
                highestFrequency: null
            };
            
            // å®‰å®šæ€§æ¤œå‡ºç”¨
            let stableFrequencies = [];
            let stabilityStartTime = null;
            let detectionInterval = null;
            
            // éŸ³åã¨Hzã®ãƒãƒƒãƒ”ãƒ³ã‚°
            const noteMapping = [
                { note: 'C2', frequency: 65.4 },
                { note: 'C#2', frequency: 69.3 },
                { note: 'D2', frequency: 73.4 },
                { note: 'D#2', frequency: 77.8 },
                { note: 'E2', frequency: 82.4 },
                { note: 'F2', frequency: 87.3 },
                { note: 'F#2', frequency: 92.5 },
                { note: 'G2', frequency: 98.0 },
                { note: 'G#2', frequency: 103.8 },
                { note: 'A2', frequency: 110.0 },
                { note: 'A#2', frequency: 116.5 },
                { note: 'B2', frequency: 123.5 },
                { note: 'C3', frequency: 130.8 },
                { note: 'C#3', frequency: 138.6 },
                { note: 'D3', frequency: 146.8 },
                { note: 'D#3', frequency: 155.6 },
                { note: 'E3', frequency: 164.8 },
                { note: 'F3', frequency: 174.6 },
                { note: 'F#3', frequency: 185.0 },
                { note: 'G3', frequency: 196.0 },
                { note: 'G#3', frequency: 207.7 },
                { note: 'A3', frequency: 220.0 },
                { note: 'A#3', frequency: 233.1 },
                { note: 'B3', frequency: 246.9 },
                { note: 'C4', frequency: 261.6 },
                { note: 'C#4', frequency: 277.2 },
                { note: 'D4', frequency: 293.7 },
                { note: 'D#4', frequency: 311.1 },
                { note: 'E4', frequency: 329.6 },
                { note: 'F4', frequency: 349.2 },
                { note: 'F#4', frequency: 370.0 },
                { note: 'G4', frequency: 392.0 },
                { note: 'G#4', frequency: 415.3 },
                { note: 'A4', frequency: 440.0 },
                { note: 'A#4', frequency: 466.2 },
                { note: 'B4', frequency: 493.9 },
                { note: 'C5', frequency: 523.3 },
                { note: 'C#5', frequency: 554.4 },
                { note: 'D5', frequency: 587.3 },
                { note: 'D#5', frequency: 622.3 },
                { note: 'E5', frequency: 659.3 },
                { note: 'F5', frequency: 698.5 },
                { note: 'F#5', frequency: 740.0 },
                { note: 'G5', frequency: 784.0 },
                { note: 'G#5', frequency: 830.6 },
                { note: 'A5', frequency: 880.0 }
            ];
            
            // å‘¨æ³¢æ•°ã‹ã‚‰éŸ³åã‚’å–å¾—
            function getClosestNote(frequency) {
                let closestNote = noteMapping[0];
                let minDifference = Math.abs(frequency - closestNote.frequency);
                
                for (const note of noteMapping) {
                    const difference = Math.abs(frequency - note.frequency);
                    if (difference < minDifference) {
                        minDifference = difference;
                        closestNote = note;
                    }
                }
                
                return closestNote;
            }
            
            // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆé–¢æ•°
            function resetCircularProgress() {
                const stabilitySvg = document.getElementById('stability-ring');
                const progressCircle = stabilitySvg ? stabilitySvg.querySelector('.voice-progress-circle') : null;
                
                if (progressCircle) {
                    progressCircle.style.strokeDashoffset = '452';
                    progressCircle.style.transition = 'stroke-dashoffset 0.3s ease';
                }
                if (stabilitySvg) {
                    stabilitySvg.classList.remove('completed');
                }
                
                console.log('ğŸ”„ å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆå®Œäº†');
            }
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Œäº†æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            function showRangeTestComplete(phase, note, frequency) {
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                const voiceNoteBadge = document.querySelector('.voice-note-badge');
                const stabilitySvg = document.getElementById('stability-ring');
                
                console.log(`âœ… ${phase}éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Œäº†:`, { note: note.note, frequency: frequency.toFixed(1) + 'Hz' });
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ã«å¤‰æ›´
                if (rangeIcon && countdownDisplay) {
                    countdownDisplay.style.display = 'none';
                    rangeIcon.setAttribute('data-lucide', 'check');
                    rangeIcon.style.color = '#22c55e'; // ç·‘è‰²ã§æˆåŠŸã‚’è¡¨ç¾
                    rangeIcon.style.display = 'block';
                    lucide.createIcons();
                }
                
                // ãƒãƒƒã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                if (voiceNoteBadge) {
                    voiceNoteBadge.classList.remove('measuring');
                    voiceNoteBadge.classList.add('confirmed');
                    setTimeout(() => {
                        voiceNoteBadge.classList.remove('confirmed');
                    }, 600);
                }
                
                // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹å®Œäº†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                if (stabilitySvg) {
                    stabilitySvg.classList.add('completed');
                }
            }
            
            // ãƒ†ã‚¹ãƒˆé–‹å§‹
            startLowRangeTest();
            
            function startLowRangeTest() {
                console.log('ğŸ”Š ä½éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹');
                currentPhase = 'low';
                stableFrequencies = [];
                stabilityStartTime = null;
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                const voiceNoteBadge = document.querySelector('.voice-note-badge');
                
                if (rangeIcon) {
                    rangeIcon.setAttribute('data-lucide', 'arrow-down');
                    rangeIcon.style.display = 'block';
                    rangeIcon.style.color = 'white';  // ç™½è‰²ã«å¤‰æ›´
                    lucide.createIcons();
                }
                if (countdownDisplay) {
                    countdownDisplay.style.display = 'none';
                }
                
                // æ¸¬å®šä¸­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                const testInstruction = document.querySelector('.test-instruction');
                if (voiceNoteBadge) {
                    voiceNoteBadge.classList.add('measuring');
                }
                if (testInstruction) {
                    testInstruction.classList.add('measuring');
                }
                
                // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
                resetCircularProgress();
                
                // 3ç§’é–“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¿½åŠ 
                testInstructionText.textContent = 'ã§ãã‚‹ã ã‘ä½ã„å£°ã‚’å‡ºã—ï¼“ç§’é–“ã‚­ãƒ¼ãƒ—ã—ã¦ãã ã•ã„';
                testStatus.textContent = '3ç§’å¾Œã«æ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™...';
                
                setTimeout(() => {
                    testStatus.textContent = 'å¾…æ©Ÿä¸­...';
                    console.log('â° 3ç§’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å®Œäº† - éŸ³å£°æ¤œå‡ºå¾…æ©Ÿé–‹å§‹');
                    startContinuousDetection();
                }, 3000);
            }
            
            function startHighRangeTest() {
                console.log('ğŸ”Š é«˜éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹');
                currentPhase = 'high';
                stableFrequencies = [];
                stabilityStartTime = null;
                
                // é«˜éŸ³ãƒ†ã‚¹ãƒˆç”¨ã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå‘¨æ³¢æ•°ãƒªã‚»ãƒƒãƒˆ
                window.simulationTargetFreq = null;
                
                // ã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                const voiceNoteBadge = document.querySelector('.voice-note-badge');
                
                if (rangeIcon) {
                    rangeIcon.setAttribute('data-lucide', 'arrow-up');
                    rangeIcon.style.display = 'block';
                    rangeIcon.style.color = 'white';  // ç™½è‰²ã«å¤‰æ›´
                    lucide.createIcons();
                }
                if (countdownDisplay) {
                    countdownDisplay.style.display = 'none';
                }
                
                // æ¸¬å®šä¸­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                const testInstruction = document.querySelector('.test-instruction');
                if (testInstruction) {
                    testInstruction.classList.add('measuring');
                }
                if (voiceNoteBadge) {
                    voiceNoteBadge.classList.add('measuring');
                }
                
                // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
                resetCircularProgress();
                
                // 3ç§’é–“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¿½åŠ 
                testInstructionText.textContent = 'ã§ãã‚‹ã ã‘é«˜ã„å£°ã‚’å‡ºã—ï¼“ç§’é–“ã‚­ãƒ¼ãƒ—ã—ã¦ãã ã•ã„';
                testStatus.textContent = '3ç§’å¾Œã«æ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™...';
                
                setTimeout(() => {
                    testStatus.textContent = 'å¾…æ©Ÿä¸­...';
                    console.log('â° 3ç§’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å®Œäº† - éŸ³å£°æ¤œå‡ºå¾…æ©Ÿé–‹å§‹');
                    startContinuousDetection();
                }, 3000);
            }
            
            function startContinuousDetection() {
                const stabilitySvg = document.getElementById('stability-ring');
                const progressCircle = stabilitySvg ? stabilitySvg.querySelector('.voice-progress-circle') : null;
                const testStatus = document.getElementById('test-status');
                
                // éŸ³å£°æ¤œå‡ºé–‹å§‹ãƒ•ãƒ©ã‚°
                let voiceDetectionStarted = false;
                
                // å®Ÿéš›ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæ¤œå‡ºé–‹å§‹
                detectionActive = true;
                audioProcessor.startDetection();
                
                // VolumeBarControllerå†é–‹ï¼ˆéŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ï¼‰
                if (volumeBarController) {
                    console.log('ğŸšï¸ VolumeBarControllerå†é–‹ï¼ˆéŸ³åŸŸãƒ†ã‚¹ãƒˆç¶™ç¶šç”¨ï¼‰');
                    try {
                        // startãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦é©åˆ‡ã«å†é–‹
                        volumeBarController.start();
                        console.log('âœ… VolumeBarControllerå†é–‹æˆåŠŸ');
                    } catch (error) {
                        console.warn('âš ï¸ VolumeBarControllerå†é–‹ã‚¨ãƒ©ãƒ¼:', error);
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: çŠ¶æ…‹ç®¡ç†ã‚’ç›´æ¥æ›´æ–°
                        volumeBarController.isActive = true;
                        volumeBarController.startUpdateLoop();
                    }
                }
                
                detectionInterval = setInterval(() => {
                    // å®Ÿéš›ã®éŸ³ç¨‹æ¤œå‡ºçµæœã‚’ä½¿ç”¨ï¼ˆéŸ³é‡é–¾å€¤ã‚‚è¿½åŠ ã—ã¦ãƒã‚¤ã‚ºé™¤å¤–ï¼‰
                    if (window.lastDetectedFrequency && window.lastDetectedFrequency > 0 && 
                        window.lastDetectedClarity > 0.6 && window.lastDetectedVolume > 0.02) {  // éŸ³é‡é–¾å€¤ã‚’2%ã«è¨­å®š
                        const detectedHz = window.lastDetectedFrequency;
                        
                        // åˆå›éŸ³å£°æ¤œå‡ºæ™‚ã®å‡¦ç†
                        if (!voiceDetectionStarted) {
                            voiceDetectionStarted = true;
                            console.log('ğŸ¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å£°ã‚’æ¤œå‡º - æ¸¬å®šé–‹å§‹ï¼ˆéŸ³é‡:', (window.lastDetectedVolume * 100).toFixed(1), '%ï¼‰');
                            if (testStatus) {
                                testStatus.textContent = 'æ¸¬å®šä¸­...';
                            }
                        }
                        
                        // éŸ³åå–å¾—
                        const closestNote = getClosestNote(detectedHz);
                    
                        // å®‰å®šæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆÂ±8Hzä»¥å†…ã§å®‰å®šã¨åˆ¤å®šï¼‰ - éŸ³å£°æ¤œå‡ºé–‹å§‹å¾Œã®ã¿
                        if (voiceDetectionStarted && (stableFrequencies.length === 0 || Math.abs(detectedHz - stableFrequencies[stableFrequencies.length - 1]) <= 8)) {
                        stableFrequencies.push(detectedHz);
                        
                        // å®‰å®šæ€§é–‹å§‹æ™‚åˆ»è¨˜éŒ²
                        if (stabilityStartTime === null) {
                            stabilityStartTime = Date.now();
                            console.log('â±ï¸ å®‰å®šæ€§æ¸¬å®šé–‹å§‹ - 3ç§’ã‚«ã‚¦ãƒ³ãƒˆé–‹å§‹');
                        }
                        
                        // 3ç§’é–“å®‰å®šæ€§ãƒã‚§ãƒƒã‚¯
                        const stabilityDuration = Date.now() - stabilityStartTime;
                        const stabilityPercent = Math.min(100, (stabilityDuration / 3000) * 100);
                        
                        // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—è¡¨ç¤ºï¼ˆ1, 2, 3ï¼‰
                        const countdownDisplay = document.getElementById('countdown-display');
                        const rangeIcon = document.getElementById('range-icon');
                        const elapsedTime = Math.floor(stabilityDuration / 1000);
                        
                        if (countdownDisplay && rangeIcon) {
                            // éŸ³å£°æ¤œå‡ºä¸­ï¼šã‚¢ã‚¤ã‚³ãƒ³éè¡¨ç¤ºã€æ•°å­—è¡¨ç¤º
                            rangeIcon.style.display = 'none';
                            countdownDisplay.style.display = 'block';
                            countdownDisplay.textContent = Math.min(elapsedTime + 1, 3); // 1, 2, 3ã§ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
                        }
                        
                        // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°ï¼ˆSVG stroke-dashoffsetã§è¡¨ç¾ï¼‰ - éŸ³å£°æ¤œå‡ºé–‹å§‹å¾Œã®ã¿
                        if (progressCircle) {
                            const circumference = 452; // 2Ï€ Ã— 72 = 452
                            const offset = circumference - (circumference * stabilityPercent / 100);
                            progressCircle.style.strokeDashoffset = offset;
                        }
                        
                        
                        // 3ç§’é”æˆ
                        if (stabilityDuration >= 3000) {
                            clearInterval(detectionInterval);
                            
                            // æ¸¬å®šä¸­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåœæ­¢
                            const testInstruction = document.querySelector('.test-instruction');
                            if (testInstruction) {
                                testInstruction.classList.remove('measuring');
                            }
                            
                            // å®‰å®šã—ãŸå‘¨æ³¢æ•°ã®å¹³å‡ã‚’è¨ˆç®—
                            const averageFreq = stableFrequencies.slice(-30).reduce((sum, freq) => sum + freq, 0) / Math.min(30, stableFrequencies.length);
                            const finalNote = getClosestNote(averageFreq);
                            
                            // å®Œäº†ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
                            showRangeTestComplete(currentPhase, finalNote, averageFreq);
                            
                            setTimeout(() => {
                                recordRangeResult(finalNote, averageFreq);
                            }, 1000);
                        }
                        
                    } else {
                        // å®‰å®šæ€§ãƒªã‚»ãƒƒãƒˆï¼ˆéŸ³ãŒé€”çµ¶ãˆãŸï¼‰
                        stableFrequencies = [detectedHz];
                        stabilityStartTime = Date.now();
                        
                        // ãƒªã‚»ãƒƒãƒˆæ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
                        if (testStatus) {
                            testStatus.textContent = 'ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ - æ¸¬å®šä¸­...';
                            setTimeout(() => {
                                testStatus.textContent = 'æ¸¬å®šä¸­...';
                            }, 1500);
                        }
                        
                        // éŸ³ãŒé€”çµ¶ãˆãŸï¼šæ•°å­—éè¡¨ç¤ºã€ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
                        const countdownDisplay = document.getElementById('countdown-display');
                        const rangeIcon = document.getElementById('range-icon');
                        if (countdownDisplay && rangeIcon) {
                            countdownDisplay.style.display = 'none';
                            rangeIcon.style.display = 'block';
                        }
                        
                        // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
                        if (progressCircle) {
                            progressCircle.style.transition = 'stroke-dashoffset 0.3s ease-out';
                            progressCircle.style.strokeDashoffset = '452';
                            
                            // å°‘ã—é…ã‚Œã¦é€šå¸¸ã®transitionã«æˆ»ã™
                            setTimeout(() => {
                                progressCircle.style.transition = 'stroke-dashoffset 0.1s ease';
                            }, 300);
                        }
                        
                        if (stabilitySvg) {
                            stabilitySvg.classList.remove('completed');
                        }
                    }
                    } else if (voiceDetectionStarted && stabilityStartTime !== null) {
                        // éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œãªããªã£ãŸï¼ˆå£°ãŒæ­¢ã¾ã£ãŸï¼‰å ´åˆã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
                        console.log('ğŸ”‡ éŸ³å£°ãŒé€”åˆ‡ã‚Œã¾ã—ãŸ - ãƒªã‚»ãƒƒãƒˆ');
                        stableFrequencies = [];
                        stabilityStartTime = null;
                        voiceDetectionStarted = false;  // éŸ³å£°æ¤œå‡ºãƒ•ãƒ©ã‚°ã‚‚ãƒªã‚»ãƒƒãƒˆ
                        
                        // ãƒªã‚»ãƒƒãƒˆæ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°
                        if (testStatus) {
                            testStatus.textContent = 'ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ - å¾…æ©Ÿä¸­...';
                            setTimeout(() => {
                                testStatus.textContent = 'å¾…æ©Ÿä¸­...';
                            }, 1500);
                        }
                        
                        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
                        const countdownDisplay = document.getElementById('countdown-display');
                        const rangeIcon = document.getElementById('range-icon');
                        if (countdownDisplay && rangeIcon) {
                            countdownDisplay.style.display = 'none';
                            rangeIcon.style.display = 'block';
                        }
                        
                        // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
                        if (progressCircle) {
                            progressCircle.style.transition = 'stroke-dashoffset 0.3s ease-out';
                            progressCircle.style.strokeDashoffset = '452';
                            
                            setTimeout(() => {
                                progressCircle.style.transition = 'stroke-dashoffset 0.1s ease';
                            }, 300);
                        }
                        
                        if (stabilitySvg) {
                            stabilitySvg.classList.remove('completed');
                        }
                    }
                }, 100);
            }
            
            function recordRangeResult(note, frequency) {
                console.log(`ğŸ¯ ${currentPhase}éŸ³åŸŸæ¤œå‡ºå®Œäº†: ${note.note} (${frequency.toFixed(1)}Hz)`);
                
                // çµæœè¨˜éŒ²
                if (currentPhase === 'low') {
                    testResults.lowestNote = note.note;
                    testResults.lowestFrequency = frequency;
                    
                    // ä½éŸ³è¨­å®šå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    if (testInstructionText) {
                        testInstructionText.textContent = 'æ¸¬å®šå®Œäº†';
                    }
                    if (testStatus) {
                        testStatus.textContent = 'æ¬¡ã®æ¸¬å®šã‚’æº–å‚™ã—ã¦ã„ã¾ã™...';
                    }
                    
                    console.log('â±ï¸ é«˜éŸ³åŸŸãƒ†ã‚¹ãƒˆã¾ã§å¾…æ©Ÿä¸­...');
                    setTimeout(() => {
                        console.log('ğŸ”„ ä½éŸ³åŸŸ â†’ é«˜éŸ³åŸŸãƒ†ã‚¹ãƒˆé·ç§»');
                        startHighRangeTest();  // é«˜éŸ³ãƒ†ã‚¹ãƒˆå†…ã§ã‚‚3ç§’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒã‚ã‚‹ã®ã§åˆè¨ˆ6ç§’ã«ãªã‚‹
                    }, 2000); // 2ç§’ã«çŸ­ç¸®ï¼ˆé«˜éŸ³ãƒ†ã‚¹ãƒˆå†…ã®3ç§’ã¨åˆã‚ã›ã¦åˆè¨ˆ5ç§’ï¼‰
                } else {
                    testResults.highestNote = note.note;
                    testResults.highestFrequency = frequency;
                    
                    // é«˜éŸ³è¨­å®šå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    if (testInstructionText) {
                        testInstructionText.textContent = 'æ¸¬å®šå®Œäº†';
                    }
                    if (testStatus) {
                        testStatus.textContent = 'éŸ³åŸŸæ¸¬å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼';
                    }
                    
                    console.log('â±ï¸ éŸ³åŸŸãƒ†ã‚¹ãƒˆçµæœè¨ˆç®—ä¸­...');
                    setTimeout(() => {
                        console.log('ğŸ‰ éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Œäº† â†’ çµæœç”»é¢è¡¨ç¤º');
                        finishRangeTest();
                    }, 2000);
                }
            }
            
            function finishRangeTest() {
                console.log('éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Œäº†', testResults);
                
                // UIæ›´æ–°ï¼ˆæ®µéšè¡¨ç¤ºå‰Šé™¤ã«ã‚ˆã‚Šä¸è¦ï¼‰
                
                // çµæœè¨ˆç®—
                const lowestNote = testResults.lowestNote || 'A2';
                const highestNote = testResults.highestNote || 'F5';
                const octaveCount = calculateOctaveRange(lowestNote, highestNote);
                
                // çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³æ›´æ–°
                const rangeInfoRows = document.querySelectorAll('#result-section .range-info-row');
                if (rangeInfoRows.length >= 2) {
                    const rangeSpan = rangeInfoRows[0].querySelector('.range-info-value');
                    const octaveSpan = rangeInfoRows[1].querySelector('.range-info-value');
                    
                    if (rangeSpan) rangeSpan.textContent = `${lowestNote} - ${highestNote}`;
                    if (octaveSpan) octaveSpan.textContent = `${octaveCount}ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–`;
                }
                
                // DataManagerçµŒç”±ã§ä¿å­˜
                const rangeResults = {
                    lowestNote: lowestNote,
                    highestNote: highestNote,
                    comfortableRange: {
                        min: lowestNote,
                        max: highestNote,
                        recommendedRoot: 'C4' // åŸºæœ¬æ¨å¥¨
                    },
                    lowestFrequency: testResults.lowestFrequency,
                    highestFrequency: testResults.highestFrequency,
                    octaveCount: octaveCount
                };
                
                const savedData = DataManager.saveVoiceRangeData(rangeResults);
                console.log('éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†ï¼ˆDataManagerï¼‰:', savedData);
                
                // ã‚¹ãƒ†ãƒƒãƒ—3å®Œäº†
                updateStepStatus(3, 'completed');
                
                // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
                setTimeout(() => {
                    showSection(resultSection);
                }, 1000);
            }
            
            function calculateOctaveRange(lowest, highest) {
                // éŸ³åã‹ã‚‰MIDIç•ªå·ã¸ã®å¤‰æ›
                const noteToMidi = (noteName) => {
                    const noteMap = { 'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11 };
                    const match = noteName.match(/([A-G]#?)(\d+)/);
                    if (!match) return 60; // C4 as default
                    
                    const [, note, octave] = match;
                    return noteMap[note] + (parseInt(octave) + 1) * 12;
                };
                
                const lowestMidi = noteToMidi(lowest);
                const highestMidi = noteToMidi(highest);
                const semitonesRange = highestMidi - lowestMidi;
                
                return (semitonesRange / 12).toFixed(1);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ preparation.htmlèª­ã¿è¾¼ã¿å®Œäº† - åˆæœŸåŒ–é–‹å§‹');
            
            // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯ï¼ˆDataManagerä½¿ç”¨ï¼‰
            const voiceRangeData = DataManager.getVoiceRangeData();
            console.log('ğŸ” ä¿å­˜æ¸ˆã¿éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ç¢ºèª:', voiceRangeData);
            
            if (voiceRangeData) {
                // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã®è¡¨ç¤ºå‡¦ç†ã‚’æ”¹å–„
                console.log('âœ… éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ç™ºè¦‹ - ã‚¹ã‚­ãƒƒãƒ—è¡¨ç¤ºã‚’æº–å‚™');
                
                // éŸ³å£°ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã«éŸ³åŸŸãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ã‚’è¨­å®š
                // ï¼ˆshowDetectionSuccessé–¢æ•°å†…ã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯æº–å‚™ã®ã¿ï¼‰
                window.hasExistingRangeData = true;
                window.existingRangeData = voiceRangeData;
            } else {
                console.log('â„¹ï¸ éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ãªã— - é€šå¸¸ãƒ•ãƒ­ãƒ¼ã§é€²è¡Œ');
                window.hasExistingRangeData = false;
            }
            
            // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’UIã«è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            console.log('ğŸ“± æ¤œå‡ºã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹æƒ…å ±:', {
                deviceType: deviceSpecs.deviceType,
                sensitivityMultiplier: deviceSpecs.sensitivityMultiplier,
                volumeBarScale: deviceSpecs.volumeBarScale,
                isIOS: deviceSpecs.isIOS
            });
        });
    </script>
</body>
</html>