<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トレーニング前の準備 - 8va相対音感トレーニング</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/results.css">
    <link rel="stylesheet" href="../styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">トレーニング前の準備</h1>
                    <p class="page-subtitle text-green-200">ランダム基音モード へのアクセス</p>
                </div>
            </div>
        </header>


        <!-- メインコンテンツ -->
        <main class="narrow-main">
            <!-- ステータス表示 -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: マイク許可 -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">マイク許可</p>
                    </div>
                    
                    <!-- 接続線 -->
                    <div class="step-connector" id="connector-1"></div>
                    
                    <!-- Step 2: 音声テスト -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">音声テスト</p>
                    </div>
                    
                    <!-- 接続線 -->
                    <div class="step-connector" id="connector-2"></div>
                    
                    <!-- Step 3: 音域テスト -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-3">
                            <i data-lucide="music" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">音域テスト</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- マイク許可セクション -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">マイクロフォンの許可</h3>
                        <p class="section-description">音程検出のためマイクロフォンへのアクセスが必要です</p>
                    </div>
                    
                    <div class="info-alert">
                        <i data-lucide="shield-check" style="width: 48px; height: 48px; color: #60a5fa;"></i>
                        <p>音声データは外部に送信されません。ブラウザ内でリアルタイム処理されます。</p>
                    </div>
                    
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>マイクを許可</span>
                    </button>
                </section>

                <!-- 音声テストセクション -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">音声テスト</h3>
                        <p class="section-description">音量と周波数検出を確認します</p>
                    </div>
                    
                    <div class="voice-instruction">
                        <div class="voice-instruction-icon">
                            <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                        </div>
                        <p class="voice-instruction-text" id="voice-instruction-text">「ド」を発声してください</p>
                        <div class="voice-instruction-pulse"></div>
                    </div>
                    
                    <!-- 音量レベル -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>音量レベル</span>
                            <span class="meter-value" id="volume-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- 検出周波数 -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>検出周波数</span>
                            <span class="meter-value" id="frequency-value">261.6 Hz (C4)</span>
                        </div>
                    </div>
                    
                    <!-- 進捗表示エリア（新追加） -->
                    <div class="meter-group" id="progress-display" style="display: none;">
                        <div class="text-center p-4 bg-blue-500 bg-opacity-20 rounded-lg border border-blue-300 border-opacity-30">
                            <div class="text-sm text-blue-200 mb-2">検出進捗</div>
                            <div class="text-lg font-semibold text-white" id="progress-text">「ド」を発声してください</div>
                            <div class="mt-2 text-xs text-blue-300" id="progress-detail">時間・回数の条件をクリアしてください</div>
                        </div>
                    </div>

                    <div class="success-alert" id="detection-success">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p id="detection-success-message">「ド」の音程を検出できました！音域テストに進みましょう。</p>
                    </div>

                    <!-- 音域設定済みの場合の表示 -->
                    <div class="glass-card hidden" id="range-saved-display">
                        <h4 class="heading-sm">
                            <i data-lucide="check-circle" class="text-green-400"></i>
                            <span>音域設定済み</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>音域範囲</span>
                                <span class="range-info-value" id="saved-range">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>オクターブ数</span>
                                <span class="range-info-value" id="saved-octaves">2.6オクターブ</span>
                            </div>
                            <div class="range-info-row">
                                <span>設定日時</span>
                                <span class="range-info-value" id="saved-date">2024-01-01</span>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-success" id="skip-range-test-btn">
                                <span>スキップして練習開始</span>
                                <i data-lucide="skip-forward" style="width: 20px; height: 20px;"></i>
                            </button>
                            <button class="btn btn-primary" id="retest-range-btn">
                                <span>音域を再テスト</span>
                                <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary hidden" id="start-range-test-btn">
                        <span>音域テストを開始</span>
                        <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                    </button>
                </section>

                <!-- 音域テストセクション -->
                <section class="test-section hidden" id="range-test-section">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-section-title">音域テスト</h3>
                                <p class="section-description">あなたの快適な音域を測定しています</p>
                            </div>
                            <div class="test-instruction" style="flex-shrink: 0;">
                                <i data-lucide="mic" class="text-red-400" style="width: 32px; height: 32px;"></i>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- テスト指示 -->
                    <div class="text-center mb-6">
                        <h4 class="text-sub-title" id="test-instruction-text">音域を測定します</h4>
                    </div>
                    
                    <!-- 検出状況 -->
                    <div class="detection-meters">
                        <!-- 音域テスト表示 -->
                        <div class="range-test-layout-flex">
                            <!-- 中央: 音程バッジと円形プログレスバー -->
                            <div class="range-test-item">
                                <div class="voice-range-display-container">
                                    <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16" 
                                                stroke-dasharray="452" stroke-dashoffset="452" 
                                                transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                                    </svg>
                                    <div class="voice-note-badge">
                                        <i data-lucide="arrow-down" id="range-icon" style="width: 80px; height: 80px; color: white; display: block;"></i>
                                        <p class="countdown-text" id="countdown-display" style="display: none;">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                    </div>

                    <p class="test-status" id="test-status">待機中...</p>
                </section>

                <!-- 結果表示セクション -->
                <section class="test-section hidden" id="result-section">
                    <div class="section-header">
                        <h3 class="text-section-title">テスト完了</h3>
                        <p class="section-description">音域テストが完了しました</p>
                    </div>
                    
                    <div class="result-card">
                        <h4 class="heading-sm">
                            <i data-lucide="music" class="text-orange-400"></i>
                            <span>あなたの音域</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>音域範囲</span>
                                <span class="range-info-value">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>オクターブ数</span>
                                <span class="range-info-value">2.6オクターブ</span>
                            </div>
                        </div>
                    </div>

                    <div class="success-alert">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p>最適な基音が自動選択されます。この結果でよろしいですか？</p>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button class="btn btn-outline" id="remeasure-range-btn">
                            <span>再測定</span>
                            <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                        </button>
                        <button class="btn btn-success" id="start-training-btn">
                            <span>この結果でトレーニング開始</span>
                            <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- JavaScript モジュール -->
    <script src="../../../js/data-manager.js"></script>
    <script src="../../../js/audio-processor.js"></script>
    <script src="../../../js/volume-bar-controller.js"></script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- TODO: 外部ファイル化 /js/preparation.js -->
    <!-- 開発期間中の一時的なインライン記述 -->
    <!-- スタイル実装完了後に外部ファイル化必須 -->
    <script>
        lucide.createIcons();

        // デバイス検出（CRITICAL_DECISIONS_AND_INSIGHTS.md準拠 - iPadOS 13+バグ対策）
        function detectDeviceWithSpecs() {
            const userAgent = navigator.userAgent; // toLowerCase削除（大文字小文字区別重要）
            
            // iPadOS 13+ 完全対応検出ロジック
            const isIPhone = /iPhone/.test(userAgent);
            const isIPad = /iPad/.test(userAgent);
            const isIPadOS = /Macintosh/.test(userAgent) && 'ontouchend' in document; // iPadOS 13+偽装対策
            const hasIOSNavigator = /iPad|iPhone|iPod/.test(userAgent);
            const hasIOSPlatform = /iPad|iPhone|iPod/.test((navigator).platform || '');
            
            // 複数方式による総合判定
            const isIOS = isIPhone || isIPad || isIPadOS || hasIOSNavigator || hasIOSPlatform;
            
            let deviceType = 'PC';
            let sensitivityMultiplier = 2.5; // 実機テスト済み設定
            let volumeBarScale = 4.0; // 実機テスト済み設定
            
            if (isIPhone) {
                deviceType = 'iPhone';
                sensitivityMultiplier = 3.5; // 実機テスト済み設定
                volumeBarScale = 4.5; // 実機テスト済み設定
            } else if (isIPad || isIPadOS) { // isIPadOS追加が重要
                deviceType = 'iPad';
                sensitivityMultiplier = 5.0; // 実機テスト済み設定
                volumeBarScale = 7.0; // 実機テスト済み設定
            } else if (isIOS) {
                deviceType = 'iOS Device';
                sensitivityMultiplier = 3.5; // フォールバック
                volumeBarScale = 4.5;
            }
            
            return {
                deviceType,
                sensitivityMultiplier,
                volumeBarScale,
                isIOS,
                debugInfo: {
                    userAgent: userAgent,
                    detectionMethods: {
                        isIPhone,
                        isIPad,
                        isIPadOS, // iPadOS 13+検出状態
                        hasIOSNavigator,
                        hasIOSPlatform,
                        touchSupport: 'ontouchend' in document
                    }
                }
            };
        }

        // DOM要素の取得
        const requestMicBtn = document.getElementById('request-mic-btn');
        const startRangeTestBtn = document.getElementById('start-range-test-btn');
        const startTrainingBtn = document.getElementById('start-training-btn');
        
        const permissionSection = document.getElementById('permission-section');
        const audioTestSection = document.getElementById('audio-test-section');
        const rangeTestSection = document.getElementById('range-test-section');
        const resultSection = document.getElementById('result-section');

        // グローバルデバイス設定
        const deviceSpecs = detectDeviceWithSpecs();
        console.log(`🔍 デバイス検出結果: ${deviceSpecs.deviceType}`, deviceSpecs);
        
        // iPadOS 13+ 検出の詳細ログ
        if (deviceSpecs.debugInfo.detectionMethods.isIPadOS) {
            console.log('⚠️ iPadOS 13+ 検出: Macintosh偽装を発見・iPad判定に修正', {
                userAgent: deviceSpecs.debugInfo.userAgent,
                touchSupport: deviceSpecs.debugInfo.detectionMethods.touchSupport,
                macintoshUA: /Macintosh/.test(deviceSpecs.debugInfo.userAgent),
                iPadUA: /iPad/.test(deviceSpecs.debugInfo.userAgent)
            });
        }

        // デバイス設定をlocalStorageに保存（後続ページで使用）
        try {
            const deviceSettings = {
                deviceType: deviceSpecs.deviceType,
                sensitivityMultiplier: deviceSpecs.sensitivityMultiplier,
                volumeBarScale: deviceSpecs.volumeBarScale,
                isIOS: deviceSpecs.isIOS,
                detectedAt: new Date().toISOString(),
                userAgent: deviceSpecs.debugInfo.userAgent
            };
            localStorage.setItem('deviceSettings', JSON.stringify(deviceSettings));
            console.log('💾 デバイス設定をlocalStorageに保存完了');
        } catch (error) {
            console.warn('⚠️ デバイス設定の保存に失敗:', error);
        }

        // ステップインジケーター更新
        function updateStepStatus(stepNumber, status) {
            const step = document.getElementById(`step-${stepNumber}`);
            if (step) {
                step.classList.remove('active', 'completed');
                if (status === 'active') {
                    step.classList.add('active');
                } else if (status === 'completed') {
                    step.classList.add('completed');
                }
            }
            
            // コネクターの更新
            if (stepNumber > 1) {
                const connector = document.getElementById(`connector-${stepNumber - 1}`);
                if (connector && status === 'completed') {
                    connector.classList.add('active');
                }
            }
        }

        // セクション表示切り替え
        function showSection(sectionToShow) {
            [permissionSection, audioTestSection, rangeTestSection, resultSection].forEach(section => {
                section.classList.add('hidden');
            });
            sectionToShow.classList.remove('hidden');
        }
        
        // 初期状態設定
        updateStepStatus(1, 'active');

        // オーディオプロセッサーインスタンス
        let audioProcessor = null;
        
        // VolumeBarControllerインスタンス（新統合システム）
        let volumeBarController = null;

        // マイク許可ボタン
        requestMicBtn.addEventListener('click', async () => {
            try {
                requestMicBtn.disabled = true;
                requestMicBtn.innerHTML = '<i data-lucide="loader" style="width: 24px; height: 24px;"></i><span>許可を待っています...</span>';
                lucide.createIcons();

                // デバイス別最適化AudioProcessor初期化
                console.log(`🚀 AudioProcessor初期化開始（${deviceSpecs.deviceType}用最適化）...`);
                audioProcessor = new AudioProcessor();
                console.log('📦 AudioProcessorインスタンス作成完了');
                
                const initResult = await audioProcessor.initialize();
                console.log('🔍 初期化結果:', initResult);
                
                if (!initResult.success) {
                    console.error('❌ AudioProcessor初期化失敗:', initResult.error);
                    throw new Error(initResult.error);
                }

                // デバイス別感度設定適用
                console.log(`🔧 ${deviceSpecs.deviceType}用感度設定適用: ${deviceSpecs.sensitivityMultiplier}x`);
                
                // TODO: AudioProcessorの感度設定メソッドが実装され次第適用
                // audioProcessor.setSensitivity(deviceSpecs.sensitivityMultiplier);
                
                // VolumeBarController初期化（新統合システム）
                console.log('🎚️ VolumeBarController初期化開始...');
                try {
                    volumeBarController = new VolumeBarController({
                        updateInterval: 50,          // 20fps更新
                        enableSmoothing: false,      // スムージング無効（推奨）
                        debugMode: true,             // デバッグモード有効
                        autoDetectDevice: true       // デバイス自動検出
                    });
                    
                    // パーセンテージ表示用の要素にクラス追加（VolumeBarController自動検出用）
                    const volumePercentElement = document.getElementById('volume-value');
                    if (volumePercentElement) {
                        volumePercentElement.classList.add('volume-percent');
                    }
                    
                    // 音量バー要素を登録（親コンテナを登録してprogress-fillと.volume-percentを自動検出）
                    const volumeProgressElement = document.getElementById('volume-progress');
                    if (volumeProgressElement) {
                        const meterGroupContainer = volumeProgressElement.closest('.meter-group');
                        if (meterGroupContainer) {
                            volumeBarController.addVolumeBar('volume-bar-1', meterGroupContainer);
                            console.log('🎚️ 音量バー親コンテナを登録:', meterGroupContainer);
                        } else {
                            console.warn('⚠️ meter-group親コンテナが見つかりません');
                        }
                    }
                    
                    console.log('✅ VolumeBarController初期化完了', {
                        deviceType: volumeBarController.getDeviceSpecs().deviceType,
                        volumeBarScale: volumeBarController.getDeviceSpecs().volumeBarScale,
                        sensitivityMultiplier: volumeBarController.getDeviceSpecs().sensitivityMultiplier
                    });
                } catch (error) {
                    console.error('❌ VolumeBarController初期化エラー:', error);
                    // エラー時は既存システムで継続
                }

                // オーディオコールバック設定（VolumeBarController統合方式）
                audioProcessor.setCallbacks({
                    onPitchUpdate: (result) => {
                        console.log('🎵 onPitchUpdate統合コールバック受信:', {
                            result: result,
                            volume: result?.volume,
                            volumeType: typeof result?.volume,
                            frequency: result?.frequency,
                            clarity: result?.clarity,
                            detectionActive: detectionActive
                        });
                        
                        // 検出停止中は音量バー更新をスキップ（マイクミュート連動）
                        console.log('🔍 detectionActive状態チェック:', detectionActive);
                        if (!detectionActive) {
                            console.log('⏸️ 検出停止中のため音量バー更新をスキップ');
                            return;
                        }
                        console.log('▶️ detectionActive=trueのため処理継続');
                        
                        // リアルタイム音程処理
                        handleRealPitchUpdate(result);
                        
                        // VolumeBarController統合システムで音量バー更新
                        if (result && typeof result.volume === 'number' && volumeBarController) {
                            // VolumeBarControllerのコールバックを手動呼び出し
                            volumeBarController.handlePitchUpdate(result);
                            
                            // 使用状況ログ（既存システムと並行動作確認用）
                            if (result.volume > 0.01 && detectionActive && Math.random() < 0.1) {
                                console.log('🎚️ VolumeBarController統合システム使用中:', {
                                    rawVolume: result.volume.toFixed(3),
                                    deviceType: volumeBarController.getDeviceSpecs().deviceType,
                                    volumeBarScale: volumeBarController.getDeviceSpecs().volumeBarScale
                                });
                            }
                        }
                        
                        // 既存システム（フォールバック用、最終的に削除予定）
                        if (result && typeof result.volume === 'number' && !volumeBarController) {
                            const rawVolume = result.volume || 0;
                            
                            // デバイス別音量バースケール（実機テスト済み設定）
                            let scale = 4.0; // PC標準（実機テスト済み）
                            if (deviceSpecs?.deviceType === 'iPhone') {
                                scale = 4.5; // iPhone: 感度3.5x, 音量バー4.5x
                            } else if (deviceSpecs?.deviceType === 'iPad') {
                                scale = 7.0; // iPad: 感度5.0x, 音量バー7.0x  
                            }
                            
                            // 基本音量計算
                            const adjustedVolume = rawVolume * scale * deviceSpecs.sensitivityMultiplier;
                            
                            // 0-100%制限
                            let volumePercent = Math.min(100, Math.max(0, adjustedVolume));
                            
                            const volumeProgress = document.getElementById('volume-progress');
                            const volumeValue = document.getElementById('volume-value');
                            
                            if (volumeProgress) {
                                volumeProgress.style.width = volumePercent + '%';
                            }
                            if (volumeValue) {
                                volumeValue.textContent = volumePercent.toFixed(0) + '%';
                            }
                            
                            // フォールバックシステム使用ログ
                            if (rawVolume > 0.01 && detectionActive && Math.random() < 0.1) {
                                console.log('⚠️ フォールバックシステム使用中:', {
                                    rawVolume: rawVolume.toFixed(3),
                                    scale: scale,
                                    volumePercent: volumePercent.toFixed(1)
                                });
                            }
                        }
                    },
                    onVolumeUpdate: (volume) => {
                        console.log('🔊 onVolumeUpdate（分離方式）受信:', volume);
                        handleVolumeUpdate(volume, deviceSpecs.volumeBarScale);
                    },
                    onError: (context, error) => handleAudioError(context, error),
                    onStateChange: (state) => console.log('Audio state:', state)
                });
                
                // ステップ1完了、ステップ2へ
                updateStepStatus(1, 'completed');
                updateStepStatus(2, 'active');
                
                showSection(audioTestSection);
                startRealAudioDetection();
                
            } catch (error) {
                console.error('マイク許可エラー:', error);
                requestMicBtn.disabled = false;
                requestMicBtn.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>マイク許可失敗 - 再試行</span>';
                lucide.createIcons();
                
                alert(`マイクの許可に失敗しました: ${error.message}`);
            }
        });

        // スキップボタン
        const skipRangeTestBtn = document.getElementById('skip-range-test-btn');
        const retestRangeBtn = document.getElementById('retest-range-btn');
        
        if (skipRangeTestBtn) {
            skipRangeTestBtn.addEventListener('click', () => {
                // ステップ2完了、直接トレーニングへ
                updateStepStatus(2, 'completed');
                updateStepStatus(3, 'completed');
                window.location.href = 'training.html';
            });
        }
        
        if (retestRangeBtn) {
            retestRangeBtn.addEventListener('click', () => {
                // 音域データをクリアして再テスト
                localStorage.removeItem('voiceRangeData');
                
                // ステップ2完了、ステップ3へ
                updateStepStatus(2, 'completed');
                updateStepStatus(3, 'active');
                
                showSection(rangeTestSection);
                startRangeTest();
            });
        }

        // 音域テスト開始ボタン
        startRangeTestBtn.addEventListener('click', () => {
            // ステップ2完了、ステップ3へ
            updateStepStatus(2, 'completed');
            updateStepStatus(3, 'active');
            
            showSection(rangeTestSection);
            startRangeTest();
        });

        // 再測定ボタン
        const remeasureRangeBtn = document.getElementById('remeasure-range-btn');
        if (remeasureRangeBtn) {
            remeasureRangeBtn.addEventListener('click', () => {
                // 音域データをクリアして再テスト
                localStorage.removeItem('voiceRangeData');
                
                // ステップ3をアクティブに戻す
                updateStepStatus(3, 'active');
                
                showSection(rangeTestSection);
                startRangeTest();
            });
        }

        // トレーニング開始ボタン
        startTrainingBtn.addEventListener('click', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode') || 'random';
            const session = urlParams.get('session') || '1';
            window.location.href = `training.html?mode=${mode}&session=${session}`;
        });

        // 音域データ表示用の共通関数
        function displaySavedRangeData(data, displayElement) {
            const savedRange = document.getElementById('saved-range');
            const savedOctaves = document.getElementById('saved-octaves');
            const savedDate = document.getElementById('saved-date');
            
            if (savedRange) savedRange.textContent = `${data.lowestNote} - ${data.highestNote}`;
            if (savedOctaves) savedOctaves.textContent = `${data.octaveCount}オクターブ`;
            if (savedDate) {
                const date = new Date(data.testDate);
                savedDate.textContent = date.toLocaleDateString('ja-JP');
            }
            
            // 表示要素を表示
            if (displayElement) {
                setTimeout(() => {
                    displayElement.classList.remove('hidden');
                    // displayElement.classList.add('fade-in-up'); // アニメーション無効化
                }, 200);
            }
        }

        // 実際のオーディオ検出処理
        let detectionActive = false;
        let detectedCDoPitches = [];
        
        // 音量バー表示時間保証のための状態管理
        let detectionStartTime = null;
        const MIN_DETECTION_TIME = 2000; // 最低2秒間は音量バー表示を保証
        const MIN_PITCH_DETECTIONS = 3;   // 最低3回の音程検出を要求
        
        // リアルタイム音程検出開始
        function startRealAudioDetection() {
            console.log('リアルタイム音程検出開始');
            detectionActive = true;
            detectedCDoPitches = [];
            detectionStartTime = Date.now(); // 開始時刻記録
            audioProcessor.startDetection();
            
            // 進捗表示エリアを表示
            const progressDisplay = document.getElementById('progress-display');
            if (progressDisplay) {
                progressDisplay.style.display = 'block';
                console.log('📊 進捗表示エリアを表示しました');
            }
            
            console.log('🕐 音量バー表示保証開始:', {
                detectionStartTime: detectionStartTime,
                minTime: MIN_DETECTION_TIME + 'ms',
                minDetections: MIN_PITCH_DETECTIONS,
                startTimeReadable: new Date(detectionStartTime).toLocaleTimeString()
            });
        }

        // リアルタイム音程更新ハンドラー
        function handleRealPitchUpdate(result) {
            if (!detectionActive) {
                console.log('⏸️ detectionActive=false のため音程処理をスキップ');
                return;
            }
            
            // 詳細デバッグログ
            console.log('🎵 handleRealPitchUpdate呼び出し:', {
                result: result,
                resultKeys: result ? Object.keys(result) : 'null',
                frequency: result?.frequency,
                volume: result?.volume,
                clarity: result?.clarity,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // 音域テスト用のグローバル変数に保存
            window.lastDetectedFrequency = result.frequency;
            window.lastDetectedClarity = result.clarity;
            window.lastDetectedVolume = result.volume || 0;
            
            const volumeProgress = document.getElementById('volume-progress');
            const volumeValue = document.getElementById('volume-value');
            const frequencyValue = document.getElementById('frequency-value');
            
            // 音量表示更新（統合方式で処理済みのため、この処理は不要）
            // 統合方式のonPitchUpdateで音量バー更新を実行中
            
            // 周波数表示更新
            if (frequencyValue && result.frequency > 0) {
                const note = frequencyToNote(result.frequency);
                frequencyValue.textContent = `${result.frequency.toFixed(1)} Hz (${note})`;
                
                // C4音程検出（超大幅緩和：200Hz未満にも対応）
                const isFreqInRange = result.frequency >= 150 && result.frequency <= 400;
                const isClarityOK = result.clarity > 0.15;
                const isVolumeOK = result.volume > 0.03;
                
                console.log('🎯 C4検出チェック:', {
                    frequency: result.frequency,
                    clarity: result.clarity,
                    volume: result.volume,
                    isInRange: isFreqInRange,
                    clarityOK: isClarityOK,
                    volumeOK: isVolumeOK,
                    allConditionsMet: isFreqInRange && isClarityOK && isVolumeOK
                });
                
                // 条件超超緩和：150-400Hz、clarity>0.15、volume>0.03（極小音量・低音域対応）
                if (result.frequency >= 150 && result.frequency <= 400 && 
                    result.clarity > 0.15 && result.volume > 0.03) {
                    detectedCDoPitches.push(result.frequency);
                    
                    const currentTime = Date.now();
                    
                    // detectionStartTimeがnullでないことを確認
                    if (detectionStartTime === null) {
                        console.error('❌ detectionStartTimeがnullです！開始時刻が正しく設定されていません');
                        return;
                    }
                    
                    const elapsedTime = currentTime - detectionStartTime;
                    const timeConditionMet = elapsedTime >= MIN_DETECTION_TIME;
                    const countConditionMet = detectedCDoPitches.length >= MIN_PITCH_DETECTIONS;
                    
                    // 詳細デバッグ情報
                    console.log('🔍 詳細条件チェック:', {
                        currentTime: currentTime,
                        detectionStartTime: detectionStartTime,
                        elapsedTime: elapsedTime,
                        MIN_DETECTION_TIME: MIN_DETECTION_TIME,
                        MIN_PITCH_DETECTIONS: MIN_PITCH_DETECTIONS,
                        timeConditionMet: timeConditionMet,
                        countConditionMet: countConditionMet,
                        detectionCount: detectedCDoPitches.length
                    });
                    
                    console.log('✅ C4候補検出！', {
                        frequency: result.frequency,
                        detectedCount: detectedCDoPitches.length,
                        elapsedTime: elapsedTime + 'ms',
                        timeConditionMet: timeConditionMet,
                        countConditionMet: countConditionMet,
                        canProceed: timeConditionMet && countConditionMet
                    });
                    
                    // UI進捗表示を更新
                    updateDetectionProgress(detectedCDoPitches.length, elapsedTime, timeConditionMet, countConditionMet);
                    
                    // 最低表示時間 AND 最低検出回数の両方を満たした場合のみ成功
                    if (timeConditionMet && countConditionMet) {
                        console.log('🎉 C4検出成功！時間・回数条件をクリア → showDetectionSuccess()呼び出し');
                        showDetectionSuccess();
                    } else if (!timeConditionMet) {
                        console.log('⏳ まだ最低表示時間未達成:', {
                            required: MIN_DETECTION_TIME + 'ms',
                            elapsed: elapsedTime + 'ms',
                            remaining: (MIN_DETECTION_TIME - elapsedTime) + 'ms'
                        });
                    } else if (!countConditionMet) {
                        console.log('🔢 まだ最低検出回数未達成:', {
                            required: MIN_PITCH_DETECTIONS,
                            current: detectedCDoPitches.length,
                            remaining: (MIN_PITCH_DETECTIONS - detectedCDoPitches.length)
                        });
                    }
                } else {
                    // 条件未達成の詳細ログ
                    if (result.frequency > 0) {
                        console.log('⚠️ C4検出条件未達成:', {
                            frequency: result.frequency,
                            frequencyInRange: result.frequency >= 150 && result.frequency <= 400,
                            clarityOK: result.clarity > 0.15,
                            volumeOK: result.volume > 0.03
                        });
                    }
                }
            }
        }

        // 音量更新ハンドラー（デバイス別最適化対応）
        function handleVolumeUpdate(volume, volumeScale = null) {
            // 詳細デバッグログ
            console.log('📊 handleVolumeUpdate呼び出し:', {
                volume: volume,
                volumeScale: volumeScale,
                deviceSpecs: deviceSpecs?.volumeBarScale,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // ボリュームレベルバー更新
            const volumeProgress = document.getElementById('volume-progress');
            if (volumeProgress) {
                // デバイス別音量バースケール適用
                const scale = volumeScale || deviceSpecs.volumeBarScale;
                const adjustedVolume = volume * scale;
                
                // volume値を0-100%に変換
                const volumePercent = Math.min(100, Math.max(0, adjustedVolume * 100));
                volumeProgress.style.width = volumePercent + '%';
                
                // 詳細ログ出力
                console.log('🎚️ 音量バー更新:', {
                    rawVolume: volume,
                    scale: scale,
                    adjustedVolume: adjustedVolume,
                    volumePercent: volumePercent,
                    elementFound: !!volumeProgress
                });
                
                // デバッグ用ログ（デバイス最適化情報含む）
                if (scale !== 1.0) {
                    console.log(`📊 Volume update [${deviceSpecs.deviceType}]:`, 
                        `${volume.toFixed(3)} × ${scale}x = ${adjustedVolume.toFixed(3)} → ${volumePercent.toFixed(1)}%`);
                } else {
                    console.log('📊 Volume update:', volume, '→', volumePercent + '%');
                }
            }
        }

        // オーディオエラーハンドラー
        function handleAudioError(context, error) {
            console.error(`Audio Error [${context}]:`, error);
            detectionActive = false;
            
            const requestMicBtn = document.getElementById('request-mic-btn');
            requestMicBtn.disabled = false;
            requestMicBtn.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>エラー - 再試行</span>';
            lucide.createIcons();
            
            alert(`オーディオエラー: ${error.message}\nページを更新して再試行してください。`);
        }
        
        // UI進捗表示更新（音程検出プログレス）
        function updateDetectionProgress(detectionCount, elapsedTime, timeConditionMet, countConditionMet) {
            console.log('📱 updateDetectionProgress呼び出し:', {
                detectionCount, elapsedTime, timeConditionMet, countConditionMet
            });
            
            const voiceInstructionText = document.getElementById('voice-instruction-text');
            console.log('🎯 voice-instruction-text要素:', voiceInstructionText);
            
            if (!voiceInstructionText) {
                console.error('❌ voice-instruction-text要素が見つかりません！');
                return;
            }
            
            const timeProgress = Math.min(100, (elapsedTime / MIN_DETECTION_TIME) * 100);
            const countProgress = Math.min(100, (detectionCount / MIN_PITCH_DETECTIONS) * 100);
            
            let newText = '';
            
            if (timeConditionMet && countConditionMet) {
                newText = '✅ 検出完了！まもなく次のステップへ...';
            } else {
                const timeRemaining = Math.max(0, Math.ceil((MIN_DETECTION_TIME - elapsedTime) / 1000));
                const countRemaining = Math.max(0, MIN_PITCH_DETECTIONS - detectionCount);
                
                if (!timeConditionMet && !countConditionMet) {
                    newText = `「ド」を継続 (${timeRemaining}秒, ${countRemaining}回検出必要)`;
                } else if (!timeConditionMet) {
                    newText = `「ド」を継続 (あと${timeRemaining}秒)`;
                } else if (!countConditionMet) {
                    newText = `「ド」を継続 (あと${countRemaining}回検出必要)`;
                }
            }
            
            console.log('📝 テキスト更新:', {
                oldText: voiceInstructionText.textContent,
                newText: newText
            });
            
            voiceInstructionText.textContent = newText;
            
            // 視覚的に目立たせるため、色も変更
            if (timeConditionMet && countConditionMet) {
                voiceInstructionText.style.color = '#22c55e'; // 緑色
            } else {
                voiceInstructionText.style.color = '#f59e0b'; // オレンジ色
            }
            
            // 専用進捗表示エリアも更新
            const progressText = document.getElementById('progress-text');
            const progressDetail = document.getElementById('progress-detail');
            
            if (progressText) {
                progressText.textContent = newText;
                progressText.style.color = timeConditionMet && countConditionMet ? '#22c55e' : '#ffffff';
                console.log('📊 progress-text更新完了:', newText);
            }
            
            if (progressDetail) {
                const timeRemaining = Math.max(0, Math.ceil((MIN_DETECTION_TIME - elapsedTime) / 1000));
                const countRemaining = Math.max(0, MIN_PITCH_DETECTIONS - detectionCount);
                const timePercent = Math.min(100, Math.round((elapsedTime / MIN_DETECTION_TIME) * 100));
                const countPercent = Math.min(100, Math.round((detectionCount / MIN_PITCH_DETECTIONS) * 100));
                
                progressDetail.textContent = `時間: ${timePercent}% (${timeRemaining}秒残り) | 回数: ${countPercent}% (${countRemaining}回残り)`;
                console.log('📊 progress-detail更新完了:', progressDetail.textContent);
            }
        }

        // 検出成功表示
        function showDetectionSuccess() {
            console.log('🎉 showDetectionSuccess実行開始');
            
            detectionActive = false;
            audioProcessor.stopDetection();
            console.log('🛑 音程検出停止完了');
            
            // VolumeBarController統合システムで音量バーリセット
            if (volumeBarController) {
                console.log('🎚️ VolumeBarController.stop()でリセット実行');
                volumeBarController.stop(); // 統一されたリセット・停止処理
            } else {
                console.log('⚠️ VolumeBarControllerが利用不可のため手動リセット実行');
                // フォールバック: 手動リセット（VolumeBarController初期化失敗時）
                const volumeProgress = document.getElementById('volume-progress');
                const volumeValue = document.getElementById('volume-value');
                if (volumeProgress) {
                    volumeProgress.style.transition = 'none';
                    volumeProgress.style.width = '0%';
                    volumeProgress.style.opacity = '0.3';
                    setTimeout(() => {
                        if (volumeProgress) {
                            volumeProgress.style.transition = 'width 0.5s ease';
                        }
                    }, 200);
                }
                if (volumeValue) {
                    volumeValue.textContent = '0%';
                }
            }
            
            // 進捗表示エリアを非表示
            const progressDisplay = document.getElementById('progress-display');
            if (progressDisplay) {
                progressDisplay.style.display = 'none';
                console.log('📊 進捗表示エリアを非表示にしました');
            }
            
            const detectionSuccess = document.getElementById('detection-success');
            const startRangeBtn = document.getElementById('start-range-test-btn');
            const rangeSavedDisplay = document.getElementById('range-saved-display');
            
            console.log('📋 要素取得確認:', {
                detectionSuccess: !!detectionSuccess,
                startRangeBtn: !!startRangeBtn,
                rangeSavedDisplay: !!rangeSavedDisplay
            });
            
            if (detectionSuccess) {
                // 音声指示セクションを即座に非表示
                const voiceInstruction = document.querySelector('.voice-instruction');
                if (voiceInstruction) {
                    // 即座に強制非表示（アニメーション問題を完全に回避）
                    voiceInstruction.style.display = 'none';
                    voiceInstruction.classList.add('hidden');
                    voiceInstruction.classList.add('collapse-out');
                    console.log('✅ voice-instruction セクションを強制非表示');
                }
                
                // アニメーション無効化（音量バー競合回避）
                // detectionSuccess.classList.remove('hidden'); // 既に表示済み
                // detectionSuccess.classList.add('fade-in-up'); // アニメーション無効化
                console.log('✅ detection-success セクション（アニメーション無効化済み）');
                
                // 既存の音域データをチェック
                const voiceRangeData = DataManager.getVoiceRangeData();
                const successMessage = document.getElementById('detection-success-message');
                
                if (voiceRangeData && rangeSavedDisplay) {
                    // 既存データ表示
                    if (successMessage) {
                        successMessage.textContent = '「ド」の音程を検出できました！音域は設定済みです。';
                    }
                    displaySavedRangeData(voiceRangeData.results, rangeSavedDisplay);
                } else {
                    // 新規音域テストが必要
                    if (successMessage) {
                        successMessage.textContent = '「ド」の音程を検出できました！音域テストに進みましょう。';
                    }
                    
                    if (startRangeBtn) {
                        setTimeout(() => {
                            startRangeBtn.classList.remove('hidden');
                            // startRangeBtn.classList.add('fade-in-up'); // アニメーション無効化
                        }, 500);
                    }
                }
            }
        }

        // 周波数から音名変換
        function frequencyToNote(frequency) {
            const A4_FREQ = 440.0;
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            const semitones = Math.round(12 * Math.log2(frequency / A4_FREQ));
            const octave = Math.floor((semitones + 9) / 12) + 4;
            const noteIndex = (semitones + 9 + 120) % 12; // 負数対応
            
            return `${noteNames[noteIndex]}${octave}`;
        }

        // 音量シミュレーション（削除予定）
        function startVolumeSimulation() {
            console.log('音量シミュレーション開始');
            
            const volumeProgress = document.getElementById('volume-progress');
            const volumeValue = document.getElementById('volume-value');
            const frequencyValue = document.getElementById('frequency-value');
            const detectionSuccess = document.getElementById('detection-success');
            const startRangeBtn = document.getElementById('start-range-test-btn');
            const rangeSavedDisplay = document.getElementById('range-saved-display');
            
            // 要素の存在確認
            if (!volumeProgress || !volumeValue || !frequencyValue) {
                console.error('必要な要素が見つかりません');
                return;
            }
            
            let detectionCount = 0;

            const interval = setInterval(() => {
                const volume = Math.floor(Math.random() * 30) + 50; // 50-80%
                // C4（ド）付近の周波数をシミュレート（261.6Hz前後）
                const frequency = (Math.random() * 20 + 251.6).toFixed(1); // 251.6-271.6Hz
                
                volumeProgress.style.width = volume + '%';
                volumeValue.textContent = volume + '%';
                
                // 周波数に音名を追加
                const isC4 = (frequency >= 255 && frequency <= 268);
                const note = isC4 ? ' (C4)' : ' (近似)';
                frequencyValue.textContent = frequency + ' Hz' + note;
                
                console.log(`周波数: ${frequency} Hz, C4判定: ${isC4}, カウント: ${detectionCount}`);
                
                // C4を検出したらカウント
                if (isC4) {
                    detectionCount++;
                    
                    // 3回C4を検出したら成功と判定
                    if (detectionCount >= 3) {
                        console.log('検出成功！メッセージとボタンを表示');
                        
                        if (detectionSuccess && detectionSuccess.classList.contains('hidden')) {
                            // 成功メッセージとボタンを即座に表示（アニメーション無効化）
                            detectionSuccess.classList.remove('hidden');
                            // detectionSuccess.classList.add('fade-in-up'); // アニメーション無効化
                            
                            // 音域データをチェック（改善版 - DataManager使用）
                            console.log('🔍 音域データ存在チェック:', {
                                hasExistingRangeData: window.hasExistingRangeData,
                                existingRangeData: window.existingRangeData
                            });
                            
                            const successMessage = document.getElementById('detection-success-message');
                            
                            if (window.hasExistingRangeData && window.existingRangeData && rangeSavedDisplay) {
                                // 音域データが存在する場合（スキップ表示）
                                const data = window.existingRangeData;
                                const rangeDisplay = `${data.lowestNote} - ${data.highestNote}`;
                                
                                if (successMessage) {
                                    successMessage.textContent = `「ド」の音程を検出できました！音域は設定済みです（${rangeDisplay}）。`;
                                }
                                
                                // 保存データを表示する共通関数を呼び出し
                                displaySavedRangeData(data, rangeSavedDisplay);
                                console.log('✅ 音域データ表示完了 - スキップオプション表示');
                                
                            } else {
                                // 新規音域テストが必要
                                console.log('📋 新規音域テスト準備');
                                if (successMessage) {
                                    successMessage.textContent = '「ド」の音程を検出できました！音域テストに進みましょう。';
                                }
                                
                                if (startRangeTestBtn) {
                                    setTimeout(() => {
                                        startRangeTestBtn.classList.remove('hidden');
                                        console.log('🎯 音域テストボタンを表示');
                                    }, 200);
                                }
                            }
                            
                            // 音声指示セクションを高さ縮小で非表示
                            const voiceInstruction = document.querySelector('.voice-instruction');
                            if (voiceInstruction) {
                                voiceInstruction.classList.add('collapse-out');
                                // アニメーション完了後に非表示
                                setTimeout(() => {
                                    voiceInstruction.classList.add('hidden');
                                }, 1000);
                            }
                            
                            // インターバルを停止
                            clearInterval(interval);
                        }
                    }
                }
            }, 800);
        }

        // 音域テスト実装（実際のオーディオ検出）
        function startRangeTest() {
            console.log('🎵 音域テスト開始 - 動的実装版');
            
            // VolumeBarController統合システムで音量バーリセット
            if (volumeBarController) {
                console.log('🎚️ VolumeBarController.stop()でリセット実行（音域テスト開始時）');
                volumeBarController.stop(); // 統一されたリセット処理
            } else {
                console.log('⚠️ VolumeBarControllerが利用不可のため手動リセット実行（音域テスト開始時）');
                // フォールバック: 手動リセット（VolumeBarController初期化失敗時）
                const volumeProgress = document.getElementById('volume-progress');
                const volumeValue = document.getElementById('volume-value');
                if (volumeProgress) {
                    volumeProgress.style.width = '0%';
                    volumeProgress.style.opacity = '0.3';
                }
                if (volumeValue) {
                    volumeValue.textContent = '0%';
                }
            }
            
            // UI要素の取得
            const testInstructionText = document.getElementById('test-instruction-text');
            const testStatus = document.getElementById('test-status');
            
            // 音域テスト状態管理
            let currentPhase = 'low'; // 'low' or 'high'
            let testResults = {
                lowestNote: null,
                lowestFrequency: null,
                highestNote: null,
                highestFrequency: null
            };
            
            // 安定性検出用
            let stableFrequencies = [];
            let stabilityStartTime = null;
            let detectionInterval = null;
            
            // 音名とHzのマッピング
            const noteMapping = [
                { note: 'C2', frequency: 65.4 },
                { note: 'C#2', frequency: 69.3 },
                { note: 'D2', frequency: 73.4 },
                { note: 'D#2', frequency: 77.8 },
                { note: 'E2', frequency: 82.4 },
                { note: 'F2', frequency: 87.3 },
                { note: 'F#2', frequency: 92.5 },
                { note: 'G2', frequency: 98.0 },
                { note: 'G#2', frequency: 103.8 },
                { note: 'A2', frequency: 110.0 },
                { note: 'A#2', frequency: 116.5 },
                { note: 'B2', frequency: 123.5 },
                { note: 'C3', frequency: 130.8 },
                { note: 'C#3', frequency: 138.6 },
                { note: 'D3', frequency: 146.8 },
                { note: 'D#3', frequency: 155.6 },
                { note: 'E3', frequency: 164.8 },
                { note: 'F3', frequency: 174.6 },
                { note: 'F#3', frequency: 185.0 },
                { note: 'G3', frequency: 196.0 },
                { note: 'G#3', frequency: 207.7 },
                { note: 'A3', frequency: 220.0 },
                { note: 'A#3', frequency: 233.1 },
                { note: 'B3', frequency: 246.9 },
                { note: 'C4', frequency: 261.6 },
                { note: 'C#4', frequency: 277.2 },
                { note: 'D4', frequency: 293.7 },
                { note: 'D#4', frequency: 311.1 },
                { note: 'E4', frequency: 329.6 },
                { note: 'F4', frequency: 349.2 },
                { note: 'F#4', frequency: 370.0 },
                { note: 'G4', frequency: 392.0 },
                { note: 'G#4', frequency: 415.3 },
                { note: 'A4', frequency: 440.0 },
                { note: 'A#4', frequency: 466.2 },
                { note: 'B4', frequency: 493.9 },
                { note: 'C5', frequency: 523.3 },
                { note: 'C#5', frequency: 554.4 },
                { note: 'D5', frequency: 587.3 },
                { note: 'D#5', frequency: 622.3 },
                { note: 'E5', frequency: 659.3 },
                { note: 'F5', frequency: 698.5 },
                { note: 'F#5', frequency: 740.0 },
                { note: 'G5', frequency: 784.0 },
                { note: 'G#5', frequency: 830.6 },
                { note: 'A5', frequency: 880.0 }
            ];
            
            // 周波数から音名を取得
            function getClosestNote(frequency) {
                let closestNote = noteMapping[0];
                let minDifference = Math.abs(frequency - closestNote.frequency);
                
                for (const note of noteMapping) {
                    const difference = Math.abs(frequency - note.frequency);
                    if (difference < minDifference) {
                        minDifference = difference;
                        closestNote = note;
                    }
                }
                
                return closestNote;
            }
            
            // 円形プログレスバーリセット関数
            function resetCircularProgress() {
                const stabilitySvg = document.getElementById('stability-ring');
                const progressCircle = stabilitySvg ? stabilitySvg.querySelector('.voice-progress-circle') : null;
                
                if (progressCircle) {
                    progressCircle.style.strokeDashoffset = '452';
                    progressCircle.style.transition = 'stroke-dashoffset 0.3s ease';
                }
                if (stabilitySvg) {
                    stabilitySvg.classList.remove('completed');
                }
                
                console.log('🔄 円形プログレスバーリセット完了');
            }
            
            // 音域テスト完了時のエフェクト
            function showRangeTestComplete(phase, note, frequency) {
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                const voiceNoteBadge = document.querySelector('.voice-note-badge');
                const stabilitySvg = document.getElementById('stability-ring');
                
                console.log(`✅ ${phase}音域テスト完了:`, { note: note.note, frequency: frequency.toFixed(1) + 'Hz' });
                
                // アイコンをチェックマークに変更
                if (rangeIcon && countdownDisplay) {
                    countdownDisplay.style.display = 'none';
                    rangeIcon.setAttribute('data-lucide', 'check');
                    rangeIcon.style.color = '#22c55e'; // 緑色で成功を表現
                    rangeIcon.style.display = 'block';
                    lucide.createIcons();
                }
                
                // バッジアニメーション
                if (voiceNoteBadge) {
                    voiceNoteBadge.classList.remove('measuring');
                    voiceNoteBadge.classList.add('confirmed');
                    setTimeout(() => {
                        voiceNoteBadge.classList.remove('confirmed');
                    }, 600);
                }
                
                // 円形プログレス完了エフェクト
                if (stabilitySvg) {
                    stabilitySvg.classList.add('completed');
                }
            }
            
            // テスト開始
            startLowRangeTest();
            
            function startLowRangeTest() {
                console.log('🔊 低音域テスト開始');
                currentPhase = 'low';
                stableFrequencies = [];
                stabilityStartTime = null;
                
                // アイコンとカウントダウン設定
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                const voiceNoteBadge = document.querySelector('.voice-note-badge');
                
                if (rangeIcon) {
                    rangeIcon.setAttribute('data-lucide', 'arrow-down');
                    rangeIcon.style.display = 'block';
                    rangeIcon.style.color = 'white';  // 白色に変更
                    lucide.createIcons();
                }
                if (countdownDisplay) {
                    countdownDisplay.style.display = 'none';
                }
                
                // 測定中エフェクト追加
                const testInstruction = document.querySelector('.test-instruction');
                if (voiceNoteBadge) {
                    voiceNoteBadge.classList.add('measuring');
                }
                if (testInstruction) {
                    testInstruction.classList.add('measuring');
                }
                
                // 円形プログレスバーリセット
                resetCircularProgress();
                
                // 3秒間のインターバルを追加
                testInstructionText.textContent = 'できるだけ低い声を出し３秒間キープしてください';
                testStatus.textContent = '3秒後に測定を開始します...';
                
                setTimeout(() => {
                    testStatus.textContent = '待機中...';
                    console.log('⏰ 3秒インターバル完了 - 音声検出待機開始');
                    startContinuousDetection();
                }, 3000);
            }
            
            function startHighRangeTest() {
                console.log('🔊 高音域テスト開始');
                currentPhase = 'high';
                stableFrequencies = [];
                stabilityStartTime = null;
                
                // 高音テスト用にターゲット周波数リセット
                window.simulationTargetFreq = null;
                
                // アイコンとカウントダウン設定
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                const voiceNoteBadge = document.querySelector('.voice-note-badge');
                
                if (rangeIcon) {
                    rangeIcon.setAttribute('data-lucide', 'arrow-up');
                    rangeIcon.style.display = 'block';
                    rangeIcon.style.color = 'white';  // 白色に変更
                    lucide.createIcons();
                }
                if (countdownDisplay) {
                    countdownDisplay.style.display = 'none';
                }
                
                // 測定中エフェクト追加
                const testInstruction = document.querySelector('.test-instruction');
                if (testInstruction) {
                    testInstruction.classList.add('measuring');
                }
                if (voiceNoteBadge) {
                    voiceNoteBadge.classList.add('measuring');
                }
                
                // 円形プログレスバーリセット
                resetCircularProgress();
                
                // 3秒間のインターバルを追加
                testInstructionText.textContent = 'できるだけ高い声を出し３秒間キープしてください';
                testStatus.textContent = '3秒後に測定を開始します...';
                
                setTimeout(() => {
                    testStatus.textContent = '待機中...';
                    console.log('⏰ 3秒インターバル完了 - 音声検出待機開始');
                    startContinuousDetection();
                }, 3000);
            }
            
            function startContinuousDetection() {
                const stabilitySvg = document.getElementById('stability-ring');
                const progressCircle = stabilitySvg ? stabilitySvg.querySelector('.voice-progress-circle') : null;
                const testStatus = document.getElementById('test-status');
                
                // 音声検出開始フラグ
                let voiceDetectionStarted = false;
                
                // 実際のオーディオ検出開始
                detectionActive = true;
                audioProcessor.startDetection();
                
                // VolumeBarController再開（音域テスト用）
                if (volumeBarController) {
                    console.log('🎚️ VolumeBarController再開（音域テスト継続用）');
                    try {
                        // startメソッドを使って適切に再開
                        volumeBarController.start();
                        console.log('✅ VolumeBarController再開成功');
                    } catch (error) {
                        console.warn('⚠️ VolumeBarController再開エラー:', error);
                        // フォールバック: 状態管理を直接更新
                        volumeBarController.isActive = true;
                        volumeBarController.startUpdateLoop();
                    }
                }
                
                detectionInterval = setInterval(() => {
                    // 実際の音程検出結果を使用（音量閾値も追加してノイズ除外）
                    if (window.lastDetectedFrequency && window.lastDetectedFrequency > 0 && 
                        window.lastDetectedClarity > 0.6 && window.lastDetectedVolume > 0.02) {  // 音量閾値を2%に設定
                        const detectedHz = window.lastDetectedFrequency;
                        
                        // 初回音声検出時の処理
                        if (!voiceDetectionStarted) {
                            voiceDetectionStarted = true;
                            console.log('🎤 ユーザーの声を検出 - 測定開始（音量:', (window.lastDetectedVolume * 100).toFixed(1), '%）');
                            if (testStatus) {
                                testStatus.textContent = '測定中...';
                            }
                        }
                        
                        // 音名取得
                        const closestNote = getClosestNote(detectedHz);
                    
                        // 安定性チェック（±8Hz以内で安定と判定） - 音声検出開始後のみ
                        if (voiceDetectionStarted && (stableFrequencies.length === 0 || Math.abs(detectedHz - stableFrequencies[stableFrequencies.length - 1]) <= 8)) {
                        stableFrequencies.push(detectedHz);
                        
                        // 安定性開始時刻記録
                        if (stabilityStartTime === null) {
                            stabilityStartTime = Date.now();
                            console.log('⏱️ 安定性測定開始 - 3秒カウント開始');
                        }
                        
                        // 3秒間安定性チェック
                        const stabilityDuration = Date.now() - stabilityStartTime;
                        const stabilityPercent = Math.min(100, (stabilityDuration / 3000) * 100);
                        
                        // カウントアップ表示（1, 2, 3）
                        const countdownDisplay = document.getElementById('countdown-display');
                        const rangeIcon = document.getElementById('range-icon');
                        const elapsedTime = Math.floor(stabilityDuration / 1000);
                        
                        if (countdownDisplay && rangeIcon) {
                            // 音声検出中：アイコン非表示、数字表示
                            rangeIcon.style.display = 'none';
                            countdownDisplay.style.display = 'block';
                            countdownDisplay.textContent = Math.min(elapsedTime + 1, 3); // 1, 2, 3でカウントアップ
                        }
                        
                        // 円形プログレスバー更新（SVG stroke-dashoffsetで表現） - 音声検出開始後のみ
                        if (progressCircle) {
                            const circumference = 452; // 2π × 72 = 452
                            const offset = circumference - (circumference * stabilityPercent / 100);
                            progressCircle.style.strokeDashoffset = offset;
                        }
                        
                        
                        // 3秒達成
                        if (stabilityDuration >= 3000) {
                            clearInterval(detectionInterval);
                            
                            // 測定中エフェクト停止
                            const testInstruction = document.querySelector('.test-instruction');
                            if (testInstruction) {
                                testInstruction.classList.remove('measuring');
                            }
                            
                            // 安定した周波数の平均を計算
                            const averageFreq = stableFrequencies.slice(-30).reduce((sum, freq) => sum + freq, 0) / Math.min(30, stableFrequencies.length);
                            const finalNote = getClosestNote(averageFreq);
                            
                            // 完了エフェクト表示
                            showRangeTestComplete(currentPhase, finalNote, averageFreq);
                            
                            setTimeout(() => {
                                recordRangeResult(finalNote, averageFreq);
                            }, 1000);
                        }
                        
                    } else {
                        // 安定性リセット（音が途絶えた）
                        stableFrequencies = [detectedHz];
                        stabilityStartTime = Date.now();
                        
                        // リセット時にメッセージ更新
                        if (testStatus) {
                            testStatus.textContent = 'リセットされました - 測定中...';
                            setTimeout(() => {
                                testStatus.textContent = '測定中...';
                            }, 1500);
                        }
                        
                        // 音が途絶えた：数字非表示、アイコン表示
                        const countdownDisplay = document.getElementById('countdown-display');
                        const rangeIcon = document.getElementById('range-icon');
                        if (countdownDisplay && rangeIcon) {
                            countdownDisplay.style.display = 'none';
                            rangeIcon.style.display = 'block';
                        }
                        
                        // 円形プログレスバーリセット（アニメーション付き）
                        if (progressCircle) {
                            progressCircle.style.transition = 'stroke-dashoffset 0.3s ease-out';
                            progressCircle.style.strokeDashoffset = '452';
                            
                            // 少し遅れて通常のtransitionに戻す
                            setTimeout(() => {
                                progressCircle.style.transition = 'stroke-dashoffset 0.1s ease';
                            }, 300);
                        }
                        
                        if (stabilitySvg) {
                            stabilitySvg.classList.remove('completed');
                        }
                    }
                    } else if (voiceDetectionStarted && stabilityStartTime !== null) {
                        // 音声が検出されなくなった（声が止まった）場合のリセット処理
                        console.log('🔇 音声が途切れました - リセット');
                        stableFrequencies = [];
                        stabilityStartTime = null;
                        voiceDetectionStarted = false;  // 音声検出フラグもリセット
                        
                        // リセット時にメッセージ更新
                        if (testStatus) {
                            testStatus.textContent = 'リセットされました - 待機中...';
                            setTimeout(() => {
                                testStatus.textContent = '待機中...';
                            }, 1500);
                        }
                        
                        // カウントダウン表示リセット
                        const countdownDisplay = document.getElementById('countdown-display');
                        const rangeIcon = document.getElementById('range-icon');
                        if (countdownDisplay && rangeIcon) {
                            countdownDisplay.style.display = 'none';
                            rangeIcon.style.display = 'block';
                        }
                        
                        // 円形プログレスバーリセット
                        if (progressCircle) {
                            progressCircle.style.transition = 'stroke-dashoffset 0.3s ease-out';
                            progressCircle.style.strokeDashoffset = '452';
                            
                            setTimeout(() => {
                                progressCircle.style.transition = 'stroke-dashoffset 0.1s ease';
                            }, 300);
                        }
                        
                        if (stabilitySvg) {
                            stabilitySvg.classList.remove('completed');
                        }
                    }
                }, 100);
            }
            
            function recordRangeResult(note, frequency) {
                console.log(`🎯 ${currentPhase}音域検出完了: ${note.note} (${frequency.toFixed(1)}Hz)`);
                
                // 結果記録
                if (currentPhase === 'low') {
                    testResults.lowestNote = note.note;
                    testResults.lowestFrequency = frequency;
                    
                    // 低音設定完了メッセージを表示
                    if (testInstructionText) {
                        testInstructionText.textContent = '測定完了';
                    }
                    if (testStatus) {
                        testStatus.textContent = '次の測定を準備しています...';
                    }
                    
                    console.log('⏱️ 高音域テストまで待機中...');
                    setTimeout(() => {
                        console.log('🔄 低音域 → 高音域テスト遷移');
                        startHighRangeTest();  // 高音テスト内でも3秒インターバルがあるので合計6秒になる
                    }, 2000); // 2秒に短縮（高音テスト内の3秒と合わせて合計5秒）
                } else {
                    testResults.highestNote = note.note;
                    testResults.highestFrequency = frequency;
                    
                    // 高音設定完了メッセージを表示
                    if (testInstructionText) {
                        testInstructionText.textContent = '測定完了';
                    }
                    if (testStatus) {
                        testStatus.textContent = '音域測定が完了しました！';
                    }
                    
                    console.log('⏱️ 音域テスト結果計算中...');
                    setTimeout(() => {
                        console.log('🎉 音域テスト完了 → 結果画面表示');
                        finishRangeTest();
                    }, 2000);
                }
            }
            
            function finishRangeTest() {
                console.log('音域テスト完了', testResults);
                
                // UI更新（段階表示削除により不要）
                
                // 結果計算
                const lowestNote = testResults.lowestNote || 'A2';
                const highestNote = testResults.highestNote || 'F5';
                const octaveCount = calculateOctaveRange(lowestNote, highestNote);
                
                // 結果表示セクション更新
                const rangeInfoRows = document.querySelectorAll('#result-section .range-info-row');
                if (rangeInfoRows.length >= 2) {
                    const rangeSpan = rangeInfoRows[0].querySelector('.range-info-value');
                    const octaveSpan = rangeInfoRows[1].querySelector('.range-info-value');
                    
                    if (rangeSpan) rangeSpan.textContent = `${lowestNote} - ${highestNote}`;
                    if (octaveSpan) octaveSpan.textContent = `${octaveCount}オクターブ`;
                }
                
                // DataManager経由で保存
                const rangeResults = {
                    lowestNote: lowestNote,
                    highestNote: highestNote,
                    comfortableRange: {
                        min: lowestNote,
                        max: highestNote,
                        recommendedRoot: 'C4' // 基本推奨
                    },
                    lowestFrequency: testResults.lowestFrequency,
                    highestFrequency: testResults.highestFrequency,
                    octaveCount: octaveCount
                };
                
                const savedData = DataManager.saveVoiceRangeData(rangeResults);
                console.log('音域データ保存完了（DataManager）:', savedData);
                
                // ステップ3完了
                updateStepStatus(3, 'completed');
                
                // 結果セクション表示
                setTimeout(() => {
                    showSection(resultSection);
                }, 1000);
            }
            
            function calculateOctaveRange(lowest, highest) {
                // 音名からMIDI番号への変換
                const noteToMidi = (noteName) => {
                    const noteMap = { 'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5, 'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11 };
                    const match = noteName.match(/([A-G]#?)(\d+)/);
                    if (!match) return 60; // C4 as default
                    
                    const [, note, octave] = match;
                    return noteMap[note] + (parseInt(octave) + 1) * 12;
                };
                
                const lowestMidi = noteToMidi(lowest);
                const highestMidi = noteToMidi(highest);
                const semitonesRange = highestMidi - lowestMidi;
                
                return (semitonesRange / 12).toFixed(1);
            }
        }

        // ページ読み込み時の初期化処理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 preparation.html読み込み完了 - 初期化開始');
            
            // 音域データのチェック（DataManager使用）
            const voiceRangeData = DataManager.getVoiceRangeData();
            console.log('🔍 保存済み音域データ確認:', voiceRangeData);
            
            if (voiceRangeData) {
                // 音域データが既に存在する場合の表示処理を改善
                console.log('✅ 音域データ発見 - スキップ表示を準備');
                
                // 音声テスト完了後に音域データ表示を実行する処理を設定
                // （showDetectionSuccess関数内で処理されるため、ここでは準備のみ）
                window.hasExistingRangeData = true;
                window.existingRangeData = voiceRangeData;
            } else {
                console.log('ℹ️ 音域データなし - 通常フローで進行');
                window.hasExistingRangeData = false;
            }
            
            // デバイス情報をUIに表示（デバッグ用）
            console.log('📱 検出されたデバイス情報:', {
                deviceType: deviceSpecs.deviceType,
                sensitivityMultiplier: deviceSpecs.sensitivityMultiplier,
                volumeBarScale: deviceSpecs.volumeBarScale,
                isIOS: deviceSpecs.isIOS
            });
        });
    </script>
</body>
</html>