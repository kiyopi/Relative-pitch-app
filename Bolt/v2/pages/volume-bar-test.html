<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸšï¸ éŸ³é‡ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ãƒ†ã‚¹ãƒˆ</title>
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
    <link rel="stylesheet" href="../styles/base.css">
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-green">
                        <i data-lucide="volume-2" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">éŸ³é‡ãƒãƒ¼ãƒ†ã‚¹ãƒˆ</h1>
                    <p class="page-subtitle text-green-200">ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå‹•ä½œç¢ºèª</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="settings" class="text-blue-300"></i>
                    <span>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</span>
                </h3>
                
                <div class="flex gap-4 mt-4">
                    <button id="test-volume" class="btn btn-primary">
                        <i data-lucide="volume-2" style="width: 20px; height: 20px;"></i>
                        éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    </button>
                    <button id="reset-volume" class="btn btn-secondary">
                        <i data-lucide="volume-x" style="width: 20px; height: 20px;"></i>
                        ãƒªã‚»ãƒƒãƒˆ
                    </button>
                    <button id="start-real-audio" class="btn btn-outline">
                        <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                        å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆ
                    </button>
                    <button id="direct-test" class="btn btn-secondary">
                        <i data-lucide="zap" style="width: 20px; height: 20px;"></i>
                        ç›´æ¥ãƒ†ã‚¹ãƒˆ50%
                    </button>
                </div>
            </div>

            <!-- éŸ³é‡ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ†ã‚¹ãƒˆ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="bar-chart-3" class="text-green-300"></i>
                    <span>éŸ³é‡ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</span>
                </h3>
                
                <!-- éŸ³é‡ãƒãƒ¼ 1: åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                <div class="mt-4">
                    <h5 class="text-sm font-medium mb-2">åŸºæœ¬éŸ³é‡ãƒãƒ¼</h5>
                    <div class="volume-bar-component" id="volume-bar-1">
                        <div class="flex items-center gap-3">
                            <i data-lucide="volume-2" class="text-yellow-300" style="width: 20px; height: 20px;"></i>
                            <div class="progress-bar flex-1">
                                <div class="progress-fill gradient-catalog-green volume-progress" data-volume="0" style="width: 0%;"></div>
                            </div>
                            <span class="text-sm text-white-60 min-w-16 volume-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- éŸ³é‡ãƒãƒ¼ 2: éŸ³å£°èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                <div class="mt-6">
                    <h5 class="text-sm font-medium mb-2">éŸ³å£°èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³</h5>
                    <div class="volume-bar-component" id="volume-bar-2">
                        <div class="mic-recognition-section">
                            <div class="test-instruction test-instruction-green">
                                <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                            </div>
                            <div class="progress-bar flex">
                                <div class="progress-fill gradient-catalog-green volume-progress" data-volume="0" style="width: 0%;"></div>
                            </div>
                            <span class="text-sm text-white-60 min-w-16 volume-text">0%</span>
                        </div>
                    </div>
                </div>

                <!-- éŸ³é‡ãƒãƒ¼ 3: ã‚«ã‚¹ã‚¿ãƒ è‰²ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                <div class="mt-6">
                    <h5 class="text-sm font-medium mb-2">ã‚«ã‚¹ã‚¿ãƒ è‰²ãƒ‘ã‚¿ãƒ¼ãƒ³</h5>
                    <div class="volume-bar-component" id="volume-bar-3">
                        <div class="flex items-center gap-3">
                            <i data-lucide="volume-2" class="text-blue-300" style="width: 20px; height: 20px;"></i>
                            <div class="progress-bar flex-1">
                                <div class="progress-fill gradient-catalog-blue volume-progress" data-volume="0" style="width: 0%;"></div>
                            </div>
                            <span class="text-sm text-white-60 min-w-16 volume-text">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒã‚¤ã‚¹åˆ¥è¨­å®šè¡¨ç¤º -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="smartphone" class="text-purple-300"></i>
                    <span>ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±</span>
                </h3>
                <div class="mt-4">
                    <div class="text-sm text-white-80" id="device-info">
                        ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºä¸­...
                    </div>
                    <div class="text-xs text-white-60 mt-2" id="volume-scale-info">
                        éŸ³é‡ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š: èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="terminal" class="text-orange-300"></i>
                    <span>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</span>
                </h3>
                <div class="mt-4 p-4 bg-black bg-opacity-50 rounded-lg max-h-64 overflow-y-auto font-mono text-sm" id="debug-log">
                    <div class="text-green-300">[INFO] éŸ³é‡ãƒãƒ¼ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Lucideã‚¢ã‚¤ã‚³ãƒ³ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- PitchProç›´æ¥ä½¿ç”¨ -->
    <script src="../../../js/pitchpro-audio/index.umd.js"></script>
    
    <!-- éŸ³é‡ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    <script src="../../../js/volume-bar-component.js"></script>

    <!-- ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ãƒ­ã‚°æ©Ÿèƒ½
        function addLog(message, type = 'INFO') {
            const log = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'INFO': 'text-blue-300',
                'SUCCESS': 'text-green-300', 
                'ERROR': 'text-red-300',
                'WARNING': 'text-yellow-300'
            }[type] || 'text-gray-300';
            
            const entry = document.createElement('div');
            entry.className = colorClass;
            entry.textContent = `[${type}] ${timestamp}: ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
            
            console.log(`[${type}] ${message}`);
        }

        // VolumeBarComponentã¯å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿æ¸ˆã¿

        // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºï¼ˆtest-ui-integrationã¨åŒã˜å½¢å¼ï¼‰
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const isIPhone = /iPhone/.test(userAgent);
            const isIPad = /iPad/.test(userAgent) || (/Macintosh/.test(userAgent) && 'ontouchend' in document);
            
            let deviceType = 'PC';
            let volumeScale = 4.0; // PCå‘ã‘æ„Ÿåº¦ã•ã‚‰ã«å‘ä¸Š
            let sensitivityMultiplier = 2.5; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆçµæœ
            
            if (isIPhone) {
                deviceType = 'iPhone';
                volumeScale = 4.5; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆçµæœ
                sensitivityMultiplier = 3.5; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆçµæœ
            } else if (isIPad) {
                deviceType = 'iPad';
                volumeScale = 7.0; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆçµæœ
                sensitivityMultiplier = 5.0; // å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆçµæœ
            }
            
            return { deviceType, volumeScale, sensitivityMultiplier };
        }

        // å¤‰æ•°
        let volumeBars = {};
        let pitchProInstance = null;
        let audioUpdateLoop = null;
        let isRealAudioActive = false;
        
        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç”¨å¤‰æ•°
        let smoothedVolume = 0;
        let volumeHistory = [];
        const SMOOTHING_FACTOR = 0.5; // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°å¼·åº¦ã‚’èª¿æ•´ï¼ˆåå¿œæ€§é‡è¦–ï¼‰
        const HISTORY_SIZE = 2; // å±¥æ­´ã‚µã‚¤ã‚ºã‚’æœ€å°åŒ–ï¼ˆå³å¿œæ€§å‘ä¸Šï¼‰

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // LucideåˆæœŸåŒ–
            lucide.createIcons();
            
            // éŸ³é‡ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ï¼‰
            try {
                volumeBars.bar1 = new VolumeBarComponent('volume-bar-1', { debugMode: true, deviceOptimization: false });
                volumeBars.bar2 = new VolumeBarComponent('volume-bar-2', { debugMode: true, deviceOptimization: false });
                volumeBars.bar3 = new VolumeBarComponent('volume-bar-3', { debugMode: true, deviceOptimization: false });
                addLog('å…¨éŸ³é‡ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†', 'SUCCESS');
            } catch (error) {
                addLog(`éŸ³é‡ãƒãƒ¼åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }

            // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è¡¨ç¤º
            const device = detectDevice();
            document.getElementById('device-info').textContent = 
                `ãƒ‡ãƒã‚¤ã‚¹: ${device.deviceType}`;
            document.getElementById('volume-scale-info').textContent = 
                `éŸ³é‡ã‚¹ã‚±ãƒ¼ãƒ«è¨­å®š: ${device.volumeScale}x`;

            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('test-volume').addEventListener('click', function() {
                addLog('éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹', 'INFO');
                Object.values(volumeBars).forEach(bar => {
                    addLog(`ãƒãƒ¼æ‰‹å‹•ãƒ†ã‚¹ãƒˆ: ${bar.element.id}`, 'INFO');
                    bar.startAnimationTest();
                });
            });

            document.getElementById('reset-volume').addEventListener('click', function() {
                addLog('å…¨éŸ³é‡ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ', 'INFO');
                Object.values(volumeBars).forEach(bar => bar.reset());
            });

            document.getElementById('start-real-audio').addEventListener('click', async function() {
                const button = this;
                if (isRealAudioActive) {
                    stopRealAudio();
                } else {
                    await startRealAudio();
                }
            });

            document.getElementById('direct-test').addEventListener('click', function() {
                addLog('ç›´æ¥50%éŸ³é‡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ', 'INFO');
                Object.values(volumeBars).forEach(bar => {
                    addLog(`ç›´æ¥æ›´æ–°ãƒ†ã‚¹ãƒˆ: ${bar.element.id} â†’ 50%`, 'INFO');
                    bar.updateVolume(50, { immediate: false, forceUpdate: true });
                });
            });

            addLog('éŸ³é‡ãƒãƒ¼ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†', 'SUCCESS');
        });

        // PitchProç›´æ¥ä½¿ç”¨ã®å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        let audioManager = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ç§»å‹•
        
        async function startRealAudio() {
            try {
                addLog('å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹ - PitchProåˆæœŸåŒ–ä¸­...', 'INFO');
                
                // PitchPro AudioManageråˆæœŸåŒ–
                if (!window.PitchPro || !window.PitchPro.AudioManager) {
                    throw new Error('PitchPro library not loaded properly');
                }
                
                audioManager = new window.PitchPro.AudioManager();
                await audioManager.initialize();
                
                // PitchDetectorä½œæˆ
                pitchProInstance = new window.PitchPro.PitchDetector(audioManager);
                await pitchProInstance.initialize();
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šï¼ˆé‡è¦ï¼štest-ui-integrationã¨åŒã˜æ–¹å¼ï¼‰
                pitchProInstance.setCallbacks({
                    onPitchUpdate: (result) => {
                        if (result && result.volume !== undefined) {
                            // éŸ³é‡å€¤ã‚’ç›´æ¥ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                            window.lastPitchResult = result;
                        }
                    },
                    onError: (error) => {
                        addLog(`éŸ³ç¨‹æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
                    }
                });
                
                // æ¤œå‡ºé–‹å§‹
                pitchProInstance.startDetection();
                addLog('PitchProåˆæœŸåŒ–ãƒ»æ¤œå‡ºé–‹å§‹å®Œäº†', 'SUCCESS');
                
                // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
                const device = detectDevice();
                addLog(`ãƒ‡ãƒã‚¤ã‚¹: ${device.deviceType}, éŸ³é‡ã‚¹ã‚±ãƒ¼ãƒ«: ${device.volumeScale}x`, 'INFO');
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³é‡æ›´æ–°é–‹å§‹
                startVolumeUpdate(device);
                
                // UIæ›´æ–°
                isRealAudioActive = true;
                const button = document.getElementById('start-real-audio');
                button.innerHTML = '<i data-lucide="mic-off" style="width: 20px; height: 20px;"></i> åœæ­¢';
                button.className = 'btn btn-danger';
                lucide.createIcons();
                
                addLog('å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹å®Œäº† - ãƒã‚¤ã‚¯ã«å‘ã‹ã£ã¦éŸ³ã‚’å‡ºã—ã¦ãã ã•ã„', 'SUCCESS');
                
            } catch (error) {
                addLog(`å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
                console.error('å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function stopRealAudio() {
            addLog('å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆåœæ­¢ä¸­...', 'INFO');
            
            // æ›´æ–°ãƒ«ãƒ¼ãƒ—åœæ­¢
            if (audioUpdateLoop) {
                clearInterval(audioUpdateLoop);
                audioUpdateLoop = null;
            }
            
            // PitchProåœæ­¢ãƒ»è§£æ”¾
            if (pitchProInstance) {
                pitchProInstance.stopDetection();
                pitchProInstance.cleanup();
                pitchProInstance = null;
            }
            
            // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            smoothedVolume = 0;
            volumeHistory = [];
            
            // éŸ³é‡ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            Object.values(volumeBars).forEach(bar => bar.reset());
            
            // UIæ›´æ–°
            isRealAudioActive = false;
            const button = document.getElementById('start-real-audio');
            button.innerHTML = '<i data-lucide="mic" style="width: 20px; height: 20px;"></i> å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆ';
            button.className = 'btn btn-outline';
            lucide.createIcons();
            
            addLog('å®ŸéŸ³å£°ãƒ†ã‚¹ãƒˆåœæ­¢å®Œäº†', 'SUCCESS');
        }
        
        function startVolumeUpdate(device) {
            audioUpdateLoop = setInterval(() => {
                if (!window.lastPitchResult) return;
                
                try {
                    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‹ã‚‰å–å¾—ã—ãŸéŸ³é‡å€¤ã‚’ä½¿ç”¨ï¼ˆtest-ui-integrationã¨å®Œå…¨ã«åŒã˜ï¼‰
                    const result = window.lastPitchResult;
                    const rawVolume = result.volume || 0;
                    
                    // test-ui-integrationã¨åŒã˜è¨ˆç®—å¼ã‚’ä½¿ç”¨
                    const deviceSpecs = detectDevice();
                    const adjustedVolume = rawVolume * device.volumeScale * deviceSpecs.sensitivityMultiplier;
                    const displayVolume = Math.min(100, Math.max(0, adjustedVolume));
                    
                    // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°å‡¦ç†ã‚’ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
                    /*
                    // å±¥æ­´ã«è¿½åŠ ï¼ˆç§»å‹•å¹³å‡ç”¨ï¼‰
                    volumeHistory.push(volume);
                    if (volumeHistory.length > HISTORY_SIZE) {
                        volumeHistory.shift();
                    }
                    
                    // ç§»å‹•å¹³å‡è¨ˆç®—
                    const averageVolume = volumeHistory.reduce((sum, v) => sum + v, 0) / volumeHistory.length;
                    
                    // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°é©ç”¨ï¼ˆæŒ‡æ•°ç§»å‹•å¹³å‡ï¼‰
                    smoothedVolume = smoothedVolume + SMOOTHING_FACTOR * (averageVolume - smoothedVolume);
                    
                    // æœ€å°å¤‰åŒ–é‡åˆ¶é™ï¼ˆç´°ã‹ã„æŒ¯å‹•ã‚’æŠ‘åˆ¶ï¼‰
                    const minChange = 1.0; // 1.0%ä»¥ä¸‹ã®å¤‰åŒ–ã¯ç„¡è¦–ï¼ˆé«˜æ„Ÿåº¦ç¶­æŒï¼‰
                    const volumeDifference = Math.abs(smoothedVolume - (volumeBars.bar1?.getCurrentVolume() || 0));
                    
                    if (volumeDifference < minChange && smoothedVolume > 0.5) { // 0.5%ä»¥ä¸Šã®ã¨ãã®ã¿åˆ¶é™
                        return; // å°ã•ãªå¤‰åŒ–ã¯ã‚¹ã‚­ãƒƒãƒ—
                    }
                    
                    // 0-100%ã«åˆ¶é™
                    const displayVolume = Math.min(100, Math.max(0, smoothedVolume));
                    */
                    
                    // éŸ³é‡ãƒãƒ¼æ›´æ–°
                    Object.values(volumeBars).forEach(bar => {
                        bar.updateVolume(displayVolume);
                    });
                    
                    // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆé »ç¹ã«è¡¨ç¤ºï¼‰
                    if (Math.random() < 0.1) { // ç´„10%ã®ç¢ºç‡ = ç´„0.5ç§’ã«1å›
                        addLog(`éŸ³é‡æ›´æ–°: Raw=${rawVolume.toFixed(2)}, Scale=${device.volumeScale.toFixed(1)}x, Sens=${deviceSpecs.sensitivityMultiplier}x, Final=${displayVolume.toFixed(1)}%`, 'INFO');
                    }
                    
                } catch (error) {
                    addLog(`éŸ³é‡å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'WARNING');
                }
                
            }, 50); // 20fpsæ›´æ–°
        }
    </script>
</body>
</html>