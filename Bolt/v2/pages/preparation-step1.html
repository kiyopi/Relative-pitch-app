<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®æº–å‚™ - 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/results.css">
    <link rel="stylesheet" href="../styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®æº–å‚™</h1>
                    <p class="page-subtitle text-green-200">ãƒ©ãƒ³ãƒ€ãƒ åŸºéŸ³ãƒ¢ãƒ¼ãƒ‰ ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹</p>
                </div>
            </div>
        </header>


        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: ãƒã‚¤ã‚¯è¨±å¯ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">ãƒã‚¤ã‚¯è¨±å¯</p>
                    </div>

                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-1"></div>

                    <!-- Step 2: éŸ³å£°ãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³å£°ãƒ†ã‚¹ãƒˆ</p>
                    </div>

                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-2"></div>

                    <!-- Step 3: éŸ³åŸŸãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-3">
                            <i data-lucide="music" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³åŸŸãƒ†ã‚¹ãƒˆ</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- ãƒã‚¤ã‚¯è¨±å¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã®è¨±å¯</h3>
                        <p class="section-description">éŸ³ç¨‹æ¤œå‡ºã®ãŸã‚ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</p>
                    </div>

                    <div class="info-alert">
                        <i data-lucide="shield-check" style="color: #60a5fa; width: 32px; height: 32px; display: block; min-width: 32px; min-height: 32px;"></i>
                        <p>éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
                    </div>

                    <!-- æ—¢å­˜ã®ãƒœã‚¿ãƒ³ï¼ˆCSSå½±éŸ¿ã‚ã‚Šï¼‰ -->
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>
                    </button>


                </section>

                <!-- éŸ³å£°ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">éŸ³å£°ãƒ†ã‚¹ãƒˆ</h3>
                        <p class="section-description">éŸ³é‡ã¨å‘¨æ³¢æ•°æ¤œå‡ºã‚’ç¢ºèªã—ã¾ã™</p>
                    </div>

                    <!-- éŸ³å£°ãƒ†ã‚¹ãƒˆä¸­è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div class="audio-test-content" id="audio-test-content">
                        <div class="voice-instruction">
                            <div class="voice-instruction-icon">
                                <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                            </div>
                            <p class="voice-instruction-text" id="voice-instruction-text">ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„</p>
                            <div class="voice-instruction-pulse"></div>
                        </div>

                        <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                                <span class="meter-value" id="volume-value">0%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                        <div class="meter-group">
                            <div class="meter-label">
                                <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                                <span class="meter-value" id="frequency-value">261.6 Hz (C4)</span>
                            </div>
                        </div>
                    </div>

                    <div class="success-alert hidden" id="detection-success">
                        <i data-lucide="check-circle" style="color: #22c55e; width: 32px; height: 32px; display: block; min-width: 32px; min-height: 32px;"></i>
                        <p id="detection-success-message">ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                    </div>

                    <!-- éŸ³åŸŸè¨­å®šæ¸ˆã¿ã®å ´åˆã®è¡¨ç¤º -->
                    <div class="glass-card hidden" id="range-saved-display">
                        <h4 class="heading-sm">
                            <i data-lucide="check-circle" class="text-green-400"></i>
                            <span>éŸ³åŸŸè¨­å®šæ¸ˆã¿</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>éŸ³åŸŸç¯„å›²</span>
                                <span class="range-info-value" id="saved-range">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                                <span class="range-info-value" id="saved-octaves">2.6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</span>
                            </div>
                            <div class="range-info-row">
                                <span>è¨­å®šæ—¥æ™‚</span>
                                <span class="range-info-value" id="saved-date">2024-01-01</span>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-outline" id="retest-range-btn">
                                <span>éŸ³åŸŸã‚’å†æ¸¬å®š</span>
                                <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                            </button>
                            <button class="btn btn-success" id="skip-range-test-btn">
                                <span>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</span>
                                <i data-lucide="skip-forward" style="width: 20px; height: 20px;"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary hidden" id="start-range-test-btn">
                        <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹</span>
                        <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                    </button>
                </section>


            </div>
        </main>
    </div>


    <!-- å¿…è¦ãªJavaScriptï¼ˆGlobalAudioManageræœ€é©åŒ–æ§‹æˆï¼‰ -->
    <!-- 1. UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- 2. éŸ³å£°å‡¦ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆv1.3.1ç‰ˆï¼‰ -->
    <script src="../../../js/pitchpro-audio/pitchpro-v1.3.1.umd.js"></script>

    <!-- 3. ã‚°ãƒ­ãƒ¼ãƒãƒ«éŸ³å£°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="../../../js/global-audio-manager.js"></script>

    <!-- 4. ã‚·ãƒ³ãƒ—ãƒ«ãªåˆ©ç”¨è€…ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ DOMèª­ã¿è¾¼ã¿å®Œäº† - Step1');
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const requestMicBtn = document.getElementById('request-mic-btn');
            const step1Indicator = document.getElementById('step-1');
            const step2Indicator = document.getElementById('step-2');
            const permissionSection = document.getElementById('permission-section');
            const audioTestSection = document.getElementById('audio-test-section');
            const startRangeTestBtn = document.getElementById('start-range-test-btn');
            const detectionSuccess = document.getElementById('detection-success');

            if (!requestMicBtn) {
                return console.error('âŒ ãƒã‚¤ã‚¯è¨±å¯ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ã‚’å®šç¾©
            const handleMicRequest = async () => {
                console.log('ğŸ¤ ãƒã‚¤ã‚¯è¨±å¯ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
                requestMicBtn.disabled = true;
                requestMicBtn.innerHTML = '<i data-lucide="loader" style="width: 24px; height: 24px;"></i><span>è¨±å¯ã‚’å¾…ã£ã¦ã„ã¾ã™...</span>';
                lucide.createIcons();

                try {
                    // 1. ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰ã€å®Œå…¨ã«æº–å‚™ãŒã§ããŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—
                    const audioDetector = await window.globalAudioManager.getInstance();
                    console.log('âœ… PitchProã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—å®Œäº†');

                    // 2. ã“ã®ãƒšãƒ¼ã‚¸å°‚ç”¨ã®UIã‚»ãƒ¬ã‚¯ã‚¿ã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
                    if (audioDetector.updateSelectors) {
                        audioDetector.updateSelectors({
                            volumeBarSelector: '#volume-progress',
                            volumeTextSelector: '#volume-value',
                            frequencySelector: '#frequency-value'
                        });
                    }

                    let successTriggered = false;
                    let audioStartTime = null;
                    const REQUIRED_DURATION = 1000; // 1ç§’é–“
                    const MIN_FREQUENCY = 100; // 100Hzä»¥ä¸Š

                    audioDetector.setCallbacks({
                        onPitchUpdate: (result) => {
                            console.log(`ğŸµ éŸ³å£°æ¤œå‡º: ${result.frequency ? result.frequency.toFixed(1) + 'Hz' : '--'} (éŸ³é‡: ${result.volume.toFixed(3)})`);

                            // 100Hzä»¥ä¸Šã®éŸ³ã‚’æ¤œå‡ºã—ãŸå ´åˆ
                            if (result.frequency && result.frequency >= MIN_FREQUENCY && !successTriggered) {
                                if (!audioStartTime) {
                                    audioStartTime = Date.now();
                                    console.log(`ğŸ¯ éŸ³å£°é–‹å§‹: ${result.frequency.toFixed(1)}Hz`);
                                }

                                // 1ç§’é–“ç¶™ç¶šã—ãŸã‚‰æˆåŠŸ
                                const duration = Date.now() - audioStartTime;
                                if (duration >= REQUIRED_DURATION) {
                                    successTriggered = true;
                                    console.log(`âœ… éŸ³å£°ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ (${duration}msç¶™ç¶š)`);
                                    showSuccess();
                                } else {
                                    // é€²æ—è¡¨ç¤º
                                    const progress = Math.round((duration / REQUIRED_DURATION) * 100);
                                    document.getElementById('voice-instruction-text').textContent =
                                        `éŸ³å£°æ¤œå‡ºä¸­... ${progress}% (${result.frequency.toFixed(1)}Hz)`;
                                }
                            } else {
                                // éŸ³å£°ãŒé€”åˆ‡ã‚ŒãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                                if (audioStartTime && !successTriggered) {
                                    audioStartTime = null;
                                    document.getElementById('voice-instruction-text').textContent =
                                        'ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„';
                                }
                            }
                        },
                        onError: (error) => {
                            console.error('ğŸš¨ éŸ³å£°ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    });
                    console.log('âœ… Step1ç”¨ã®UIã¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šå®Œäº†');

                    // 3. éŸ³å£°æ¤œå‡ºã‚’é–‹å§‹
                    await audioDetector.startDetection();
                    console.log('âœ… éŸ³å£°æ¤œå‡ºé–‹å§‹');

                    // 4. UIã‚’æ›´æ–°
                    step1Indicator.className = 'step-indicator completed';
                    permissionSection.classList.add('hidden');
                    audioTestSection.classList.remove('hidden');

                    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’å¾©å…ƒ
                    requestMicBtn.disabled = false;
                    requestMicBtn.innerHTML = '<i data-lucide="check" style="width: 24px; height: 24px;"></i><span>è¨±å¯æ¸ˆã¿</span>';
                    requestMicBtn.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
                    lucide.createIcons();

                    // localStorageä¿å­˜
                    localStorage.setItem('micPermissionGranted', 'true');
                    localStorage.setItem('micPermissionTimestamp', new Date().toISOString());

                    // éŸ³åŸŸè¨­å®šæ¸ˆã¿è¡¨ç¤ºãŒèª¤ã£ã¦è¡¨ç¤ºã•ã‚Œãªã„ã‚ˆã†éè¡¨ç¤ºã«å¼·åˆ¶
                    const rangeSavedDisplay = document.getElementById('range-saved-display');
                    if (rangeSavedDisplay) {
                        rangeSavedDisplay.classList.add('hidden');
                    }

                    // åˆæœŸæŒ‡ç¤ºæ–‡ã‚’è¨­å®š
                    document.getElementById('voice-instruction-text').textContent =
                        'ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„';

                    // 30ç§’å¾Œã«è‡ªå‹•çš„ã«æˆåŠŸè¡¨ç¤ºï¼ˆååˆ†ãªãƒ†ã‚¹ãƒˆæ™‚é–“ã‚’æä¾›ï¼‰
                    setTimeout(() => {
                        if (!successTriggered) {
                            console.log('â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: è‡ªå‹•çš„ã«æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸');
                            showSuccess();
                        }
                    }, 30000);

                } catch (error) {
                    console.error('âŒ ãƒã‚¤ã‚¯è¨±å¯ãƒ•ãƒ­ãƒ¼ã«å¤±æ•—:', error);
                    requestMicBtn.disabled = false;
                    requestMicBtn.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>';
                    lucide.createIcons();
                    alert(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            };

            // æˆåŠŸè¡¨ç¤ºç”¨ã®é–¢æ•°
            const showSuccess = async () => {
                console.log('âœ… éŸ³å£°ãƒ†ã‚¹ãƒˆæˆåŠŸï¼');
                try {
                    const audioDetector = await window.globalAudioManager.getInstance();

                    // éŸ³å£°æ¤œå‡ºã‚’åœæ­¢
                    audioDetector.stopDetection();

                    // PitchProã®UIã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆéŸ³é‡ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼‰
                    if (audioDetector.resetDisplayElements) {
                        audioDetector.resetDisplayElements();
                    }

                    // ãƒ†ã‚­ã‚¹ãƒˆã‚’æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´
                    document.getElementById('voice-instruction-text').textContent =
                        'éŸ³å£°æ¤œå‡ºãŒå®Œäº†ã—ã¾ã—ãŸï¼';

                } catch (e) {
                    console.warn('åœæ­¢æ™‚ã®ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–å¯èƒ½ï¼‰:', e);
                }

                step2Indicator.className = 'step-indicator completed';

                // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
                const rangeData = localStorage.getItem('voiceRangeData');
                if (rangeData) {
                    console.log('âœ… éŸ³åŸŸãƒ‡ãƒ¼ã‚¿å­˜åœ¨ - éŸ³åŸŸè¨­å®šæ¸ˆã¿è¡¨ç¤º');

                    try {
                        const parsedData = JSON.parse(rangeData);

                        // éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                        if (parsedData.range) {
                            document.getElementById('saved-range').textContent =
                                `${parsedData.range.lowest} - ${parsedData.range.highest}`;
                        }
                        if (parsedData.octaveRange) {
                            document.getElementById('saved-octaves').textContent =
                                `${parsedData.octaveRange}ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–`;
                        }
                        if (parsedData.timestamp) {
                            const date = new Date(parsedData.timestamp);
                            document.getElementById('saved-date').textContent =
                                date.toLocaleDateString('ja-JP');
                        }

                        // éŸ³å£°ãƒ†ã‚¹ãƒˆä¸­è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºï¼ˆéŸ³å£°ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯è¡¨ç¤ºã®ã¾ã¾ï¼‰
                        document.getElementById('audio-test-content').classList.add('hidden');

                        // æˆåŠŸã‚¢ãƒ©ãƒ¼ãƒˆã‚‚è¡¨ç¤º
                        detectionSuccess.classList.remove('hidden');

                        // éŸ³åŸŸè¨­å®šæ¸ˆã¿è¡¨ç¤ºã‚’è¡¨ç¤º
                        document.getElementById('range-saved-display').classList.remove('hidden');

                        // Step3ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚‚å®Œäº†çŠ¶æ…‹ã«
                        const step3Indicator = document.getElementById('step-3');
                        if (step3Indicator) {
                            step3Indicator.className = 'step-indicator completed';
                        }

                    } catch (error) {
                        console.warn('éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã®è§£æã‚¨ãƒ©ãƒ¼:', error);
                        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯é€šå¸¸ã®æµã‚Œã«
                        detectionSuccess.classList.remove('hidden');
                        startRangeTestBtn.classList.remove('hidden');
                    }
                } else {
                    console.log('ğŸ“‹ éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ãªã— - é€šå¸¸ã®éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒ•ãƒ­ãƒ¼');

                    // é€šå¸¸ã®æˆåŠŸè¡¨ç¤º
                    detectionSuccess.classList.remove('hidden');
                    startRangeTestBtn.classList.remove('hidden');
                }
            };

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            requestMicBtn.addEventListener('click', handleMicRequest);
            console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†ï¼ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚');

            // éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³
            if (startRangeTestBtn) {
                startRangeTestBtn.addEventListener('click', () => {
                    console.log('ğŸ”„ Step2ã¸é·ç§»');
                    localStorage.setItem('step1Completed', 'true');
                    window.location.href = 'preparation-step2.html';
                });
            }

            // éŸ³åŸŸã‚’å†æ¸¬å®šãƒœã‚¿ãƒ³
            const retestRangeBtn = document.getElementById('retest-range-btn');
            if (retestRangeBtn) {
                retestRangeBtn.addEventListener('click', () => {
                    console.log('ğŸ”„ éŸ³åŸŸå†æ¸¬å®š - Step2ã¸é·ç§»');
                    localStorage.setItem('step1Completed', 'true');
                    window.location.href = 'preparation-step2.html';
                });
            }

            // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ãƒœã‚¿ãƒ³
            const skipRangeTestBtn = document.getElementById('skip-range-test-btn');
            if (skipRangeTestBtn) {
                skipRangeTestBtn.addEventListener('click', () => {
                    console.log('ğŸš€ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹ - training.htmlã¸é·ç§»');
                    localStorage.setItem('step1Completed', 'true');
                    localStorage.setItem('step2Completed', 'true');
                    window.location.href = '../training.html';
                });
            }

            // localStorageç¢ºèª
            const micPermission = localStorage.getItem('micPermissionGranted');
            const rangeData = localStorage.getItem('voiceRangeData');

            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¯å¸¸ã«åˆæœŸçŠ¶æ…‹ã‹ã‚‰é–‹å§‹
            // localStorageæƒ…å ±ã¯å‚è€ƒç¨‹åº¦ã«ç•™ã‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ™‚ã«é©åˆ‡ã«æ›´æ–°
            console.log('ğŸ“‹ localStorageçŠ¶æ…‹ç¢ºèª:', {
                micPermission: micPermission === 'true',
                rangeData: !!rangeData
            });
        });
    </script>
</body>
</html>