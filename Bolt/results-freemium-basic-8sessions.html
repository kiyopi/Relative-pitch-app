<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>8va相対音感トレーニング - 総合評価</title>
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="styles/system.css">
    
    <!-- アイコンライブラリ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        /* アイコン付き見出しクラス - UIカタログから統一 */
        .heading-sm {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.125rem; /* text-lg */
            line-height: 1.75rem;
            font-weight: 500; /* font-medium */
            color: white;
            margin-bottom: 1rem;
        }

        .heading-sm i {
            width: 20px;
            height: 20px;
            color: white;
        }

        .heading-md {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem; /* text-xl */
            line-height: 1.75rem;
            font-weight: 600; /* font-semibold */
            color: white;
            margin-bottom: 1.5rem;
        }

        .heading-md i {
            width: 24px;
            height: 24px;
            color: white;
        }

        .heading-lg {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem; /* text-2xl */
            line-height: 2rem;
            font-weight: 700; /* font-bold */
            color: white;
            margin-bottom: 1.5rem;
        }

        .heading-lg i {
            width: 28px;
            height: 28px;
            color: white;
        }

        /* 背景アニメーション - UIカタログベース */
        body {
            position: relative;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            -webkit-overflow-scrolling: touch;
            background: #0f172a;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0f172a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: -1;
            transform: translateZ(0);
            will-change: background-position;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 評価グラフアニメーション */
        @keyframes slideIn {
            from {
                width: 0;
            }
            to {
                width: var(--bar-width);
            }
        }
        
        .evaluation-bar {
            animation: slideIn 0.8s ease-out forwards;
            animation-delay: var(--delay);
        }
        
        /* シェアボタンスタイル */
        .share-buttons {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .share-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .share-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.2);
        }
        
        .share-btn svg {
            width: 24px;
            height: 24px;
            z-index: 1;
        }
        
        .share-btn.twitter:hover {
            box-shadow: 0 8px 25px rgba(29, 161, 242, 0.4), 0 0 30px rgba(29, 161, 242, 0.3);
        }
        
        .share-btn.line:hover {
            box-shadow: 0 8px 25px rgba(0, 195, 0, 0.4), 0 0 30px rgba(0, 195, 0, 0.3);
        }
        
        .share-btn.facebook:hover {
            box-shadow: 0 8px 25px rgba(24, 119, 242, 0.4), 0 0 30px rgba(24, 119, 242, 0.3);
        }
        
        .share-btn.copy:hover {
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4), 0 0 30px rgba(139, 92, 246, 0.3);
        }
        
        @media (max-width: 640px) {
            .share-btn {
                width: 48px;
                height: 48px;
            }
            
            .share-btn svg {
                width: 20px;
                height: 20px;
            }
        }
        
        /* 8セッション専用グリッド */
        .sessions-grid-8 {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .sessions-grid-8 {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .sessions-grid-8 {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }
        }
        
        /* セッションボックス - UIカタログベース（改良版） */
        .session-box {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .session-box:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .session-box.selected {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        /* レスポンシブ セッション番号 */
        .session-number {
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        /* 8個表示時のサイズ（デスクトップ） */
        .sessions-grid-8 .session-number {
            font-size: 1rem;
        }
        
        .sessions-grid-8 .session-icon i {
            width: 24px;
            height: 24px;
        }
        
        /* 4x2表示時のサイズ（タブレット・モバイル） */
        @media (max-width: 768px) {
            .sessions-grid-8 .session-number {
                font-size: 0.875rem;
            }
            
            .sessions-grid-8 .session-icon i {
                width: 20px;
                height: 20px;
            }
        }

        /* Glass Card 拡張ホバーエフェクト */
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
            transform: translateY(-4px) !important;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2) !important;
        }

        /* Share Card 反射エフェクト */
        .share-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .share-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 11s infinite;
        }

        @keyframes shimmer {
            0% { 
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 1;
            }
            9.1% { 
                transform: translateX(100%) translateY(100%) rotate(45deg);
                opacity: 1;
            }
            9.2% { 
                transform: translateX(100%) translateY(100%) rotate(45deg);
                opacity: 0;
            }
            99.9% { 
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 0;
            }
            100% { 
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 1;
            }
        }
        
        /* 12個表示時の対応（将来用） */
        .sessions-grid-12 .session-number {
            font-size: 0.875rem;
        }
        
        .sessions-grid-12 .session-icon i {
            width: 20px;
            height: 20px;
        }
        
        /* 評価レベル別色 - UIカタログから */
        .session-excellent {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.3);
        }
        
        .session-good {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .session-pass {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .session-practice {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container">
            <!-- ヘッダーセクション -->
            <div class="text-center mb-8">
                <div class="flex justify-center mb-6">
                    <div class="page-header-icon page-header-icon-purple animate-float">
                        <i data-lucide="file-chart-column-increasing" class="icon-2xl text-white" data-stroke-width="2"></i>
                    </div>
                </div>
                <h1 class="text-4xl font-bold text-white mb-4">総合評価</h1>
                <p class="text-green-200 text-xl mb-6">8セッション完了 - あなたの相対音感能力を分析</p>
            </div>

            <!-- 総合評価セクション -->
            <div class="share-card mb-8">
                <section class="rank-section">
                    <!-- モード名 -->
                    <div class="rank-mode">
                        <h3 class="mode-title" id="main-mode-title">ランダム基音モード</h3>
                    </div>
                    
                    <!-- グレードアイコンと統計情報を横一列に -->
                    <div class="rank-content-row">
                        <!-- グレードアイコン -->
                        <div class="rank-icon">
                            <div class="rank-circle rank-md rank-circle-b">
                                <i data-lucide="circle-star" class="text-white" style="width: 64px; height: 64px;"></i>
                            </div>
                        </div>
                        
                        <!-- 統計情報 -->
                        <div class="rank-stats-row">
                            <div class="rank-stat-item">
                                <div class="stat-value-rank grade-value" id="dynamic-grade">B</div>
                                <div class="stat-label-rank">総合グレード</div>
                            </div>
                            <div class="rank-stat-item">
                                <div class="stat-value-rank stat-value-avg-error avg-error">±18.2¢</div>
                                <div class="stat-label-rank">平均誤差（セント）</div>
                            </div>
                            <div class="rank-stat-item">
                                <div class="stat-value-rank max-error">+25.8¢</div>
                                <div class="stat-label-rank">最大誤差（セント）</div>
                            </div>
                            <div class="rank-stat-item">
                                <div class="stat-value-rank stat-value-session-count session-count">8</div>
                                <div class="stat-label-rank">セッション数</div>
                            </div>
                        </div>
                        
                        <!-- ランク取得メッセージ -->
                        <div class="rank-achievement-message" style="margin-top: 0px; margin-bottom: 0px; text-align: center;">
                            <p id="share-message" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin: 0;">
                                B級ランク取得！グッドプレイヤー！
                            </p>
                        </div>
                    </div>
                </section>
                
                <h3 class="heading-md" style="margin-top: 0px; justify-content: center;">
                    <i data-lucide="share-2" class="text-blue-400"></i>
                    みんなに成果をシェアしよう！
                </h3>
                <div class="share-buttons">
                    <a href="#" class="share-btn twitter" onclick="shareToTwitter(event)" title="Xでシェア">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="#" class="share-btn line" onclick="shareToLine(event)" title="LINEで送る">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.348 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                        </svg>
                    </a>
                    <a href="#" class="share-btn facebook" onclick="shareToFacebook(event)" title="Facebookでシェア">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                    </a>
                    <button class="share-btn copy" onclick="copyShareText(event)" title="リンクをコピー">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- 評価内訳（元の位置に残す） -->
                <div class="mb-6" style="display: none;">
                    <h3 class="text-lg font-medium text-white mb-4 text-center">8セッション64音の評価内訳</h3>
                    
                    <!-- 評価グラフ（移動用に元のまま残す） -->
                    <div class="mb-6" id="evaluation-chart" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 0 1rem;">
                        <!-- Excellent -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="trophy" class="text-yellow-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 25%; --delay: 0.1s; width: 0; height: 100%; background: #fbbf24; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">16</span>
                            </div>
                        </div>
                        
                        <!-- Good -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="star" class="text-green-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 37.5%; --delay: 0.2s; width: 0; height: 100%; background: #22c55e; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">24</span>
                            </div>
                        </div>
                        
                        <!-- Pass -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="thumbs-up" class="text-blue-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 25%; --delay: 0.3s; width: 0; height: 100%; background: #3b82f6; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">16</span>
                            </div>
                        </div>
                        
                        <!-- Practice -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="triangle-alert" class="text-red-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 12.5%; --delay: 0.4s; width: 0; height: 100%; background: #ef4444; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">8</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 誤差推移グラフ（元の位置に残す・非表示） -->
                    <div class="mt-8" style="display: none;">
                        <h4 class="heading-sm">
                            <i data-lucide="trending-up"></i>
                            誤差推移
                        </h4>
                        <div class="bg-white/5 rounded-lg p-4" id="error-trend-container" style="height: 280px; position: relative; overflow-x: auto; overflow-y: hidden;">
                            <div id="chart-wrapper" style="min-width: 100%; height: 100%;">
                                <canvas id="error-trend-chart" style="height: 100%;"></canvas>
                            </div>
                        </div>
                        <div class="text-xs text-white-60 text-center mt-3" id="chart-description" style="min-height: 60px;">
                            <!-- グラフの説明はJavaScriptで動的に設定 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- グラフ表示セクション -->
            <div class="glass-card mb-8">
                <h3 class="heading-lg">
                    <i data-lucide="bar-chart-3"></i>
                    成績分析グラフ
                </h3>
                
                <!-- 評価内訳グラフ -->
                <div class="mb-8">
                    <h4 class="heading-sm">
                        <i data-lucide="pie-chart"></i>
                        評価内訳（64音）
                    </h4>
                    
                    <!-- 評価グラフをここに移動 -->
                    <div id="evaluation-chart-container" class="bg-white/5 rounded-lg p-4">
                        <!-- JavaScriptで移動 -->
                    </div>
                </div>
                
                <!-- 誤差推移グラフ -->
                <div>
                    <h4 class="heading-sm">
                        <i data-lucide="trending-up"></i>
                        誤差推移
                    </h4>
                    
                    <!-- 誤差推移グラフをここに移動 -->
                    <div id="error-trend-section">
                        <!-- JavaScriptで移動 -->
                    </div>
                </div>
            </div>
            
            <!-- セッション別成績 -->
            <div class="glass-card mb-8">
                <h3 class="text-2xl font-bold text-white mb-6">セッション別成績</h3>
                <p class="text-white-70 text-sm mb-4">
                    <span class="lg:hidden">セッションをタップして詳細分析を表示</span>
                    <span class="hidden lg:inline">セッションをクリックして詳細分析を表示</span>
                </p>
                <div class="sessions-grid-8" id="sessions-grid">
                    <!-- JavaScriptで8セッション分のHTMLを生成 -->
                </div>
            </div>
            
            <!-- 詳細分析 -->
            <div class="glass-card mb-8" id="detailed-analysis-section">
                <div class="flex items-center justify-between mb-6">
                    <button id="prev-session-btn" class="glass-card-sm hover:bg-white/10 transition-colors cursor-pointer flex-shrink-0">
                        <i data-lucide="chevron-left" class="text-white" style="width: 24px; height: 24px;"></i>
                    </button>
                    <h3 class="text-xl font-bold text-white text-center flex-1 px-2">
                        <div>詳細分析</div>
                        <div class="text-lg mt-1">セッション<span id="selected-session">1</span></div>
                    </h3>
                    <button id="next-session-btn" class="glass-card-sm hover:bg-white/10 transition-colors cursor-pointer flex-shrink-0">
                        <i data-lucide="chevron-right" class="text-white" style="width: 24px; height: 24px;"></i>
                    </button>
                </div>
                
                <!-- セッション詳細情報 -->
                <div class="mb-4 text-center" id="session-info">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; align-items: end; min-height: 80px;">
                        <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: center; height: 100%;">
                            <div class="text-2xl md:text-4xl font-bold text-white" id="session-base-note">C4</div>
                            <p class="text-xs md:text-base text-green-200">基音</p>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; height: 100%;">
                            <div class="mb-2" id="session-rank-icon">
                                <i data-lucide="thumbs-up" class="text-blue-300" style="width: 80px; height: 80px;"></i>
                            </div>
                            <p class="text-base md:text-lg font-bold text-blue-300" id="session-rank-text">Pass</p>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: center; height: 100%;">
                            <div class="text-2xl md:text-4xl font-bold text-white" id="session-average-error">±12.3¢</div>
                            <p class="text-xs md:text-base text-green-200">セッション平均誤差</p>
                        </div>
                    </div>
                </div>
                
                <!-- 音別詳細結果 -->
                <div class="space-y-2" id="note-results">
                    <!-- JavaScriptで生成 -->
                </div>
            </div>
            
            <!-- 次のステップセクション -->
            <div class="glass-card mb-8">
                <div class="text-center mb-8">
                    <h2 class="heading-lg" style="justify-content: center;">
                        <i data-lucide="lightbulb" class="text-yellow-300"></i>
                        次のステップ
                    </h2>
                    <p class="text-green-300 font-semibold text-lg mb-3">
                        B級達成おめでとうございます！
                    </p>
                    <p class="text-white-70">
                        相対音感の基礎が身につきました。さらなる上達を目指しましょう！
                    </p>
                </div>
                
                <div class="next-steps-grid grid gap-8 mb-8" style="grid-template-columns: repeat(1, 1fr);">
                    <style>
                        @media (min-width: 768px) {
                            .next-steps-grid {
                                grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
                            }
                        }
                    </style>
                    <!-- 現在の成果 -->
                    <div class="glass-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="check-circle" class="w-5 h-5 text-green-300 mr-3"></i>
                            現在の成果
                        </h3>
                        <div class="space-y-2 text-left">
                            <div class="text-white-70">• 各基音での相対音感能力向上</div>
                            <div class="text-white-70">• 平均誤差±18.2セントを達成</div>
                            <div class="text-white-70">• 8セッション完了の練習習慣確立</div>
                        </div>
                    </div>
                    
                    <!-- 次の目標 -->
                    <div class="glass-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="arrow-up-right" class="w-5 h-5 text-blue-300 mr-3"></i>
                            次の目標
                        </h3>
                        <div class="space-y-2 text-left">
                            <div class="text-white-70">• A級（±15¢以下）を目指す</div>
                            <div class="text-white-70">• 12セッション完了に挑戦</div>
                            <div class="text-blue-200 font-medium">• 連続チャレンジモードで更なる向上</div>
                            <div class="text-white-70">• どんな基音でも安定した相対音感を目指す</div>
                        </div>
                    </div>
                    
                    <!-- 効果的な練習スケジュール -->
                    <div class="glass-card">
                        <h3 class="text-lg font-semibold text-white mb-4 flex items-center">
                            <i data-lucide="clock" class="w-5 h-5 text-yellow-300 mr-3"></i>
                            効果的な練習スケジュール
                        </h3>
                        <div class="space-y-2 text-left">
                            <div class="text-white-70">• 週3回、1回15分の継続練習</div>
                            <div class="text-white-70">• シャープ系基音での集中練習</div>
                            <div class="text-white-70">• 集中力の高い午前中がおすすめ</div>
                        </div>
                    </div>
                </div>
                
                <!-- プレミアム機能の紹介 -->
                <div class="mt-12 p-6 glass-card" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05)); border: 1px solid rgba(251, 191, 36, 0.2);">
                    <div class="text-center mb-6">
                        <div class="flex items-center justify-center gap-3 mb-4">
                            <i data-lucide="zap" class="text-blue-300" style="width: 24px; height: 24px;"></i>
                            <h3 class="text-xl font-bold text-white">連続チャレンジモードとは？</h3>
                        </div>
                        <p class="text-white-70 text-base">
                            12セッション連続で集中トレーニング。中断のないフローで深い音感を養う中級者向けモードです。
                        </p>
                    </div>
                    
                    <div class="grid gap-6 mb-6" style="grid-template-columns: repeat(1, 1fr);">
                        <style>
                            @media (min-width: 768px) {
                                .premium-info-grid {
                                    grid-template-columns: repeat(2, 1fr) !important;
                                }
                            }
                        </style>
                        
                        <div class="premium-info-grid">
                            <div class="text-center p-4 glass-card">
                                <div class="text-3xl font-bold text-blue-300 mb-2">12</div>
                                <div class="text-base font-medium text-white mb-1">異なる基音</div>
                                <div class="text-sm text-white-60">すべての音階で練習</div>
                            </div>
                            <div class="text-center p-4 glass-card">
                                <div class="text-lg font-bold text-green-300 mb-2">詳細分析</div>
                                <div class="text-base font-medium text-white mb-1">弱点特定・改善提案</div>
                                <div class="text-sm text-white-60">AI による個別アドバイス</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-secondary" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none;">
                            <i data-lucide="star" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                            <span>7日間無料でお試し</span>
                        </button>
                        <p class="text-white-60 text-xs mt-2">月額480円 • いつでもキャンセル可能</p>
                    </div>
                </div>
            </div>
            
            <!-- 無料版 vs プレミアム版比較 -->
            <div class="glass-card mb-8">
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 2rem;">
                    <i data-lucide="scale" style="width: 24px; height: 24px; color: white;"></i>
                    <h3 style="color: white; font-size: 1.25rem; font-weight: 600; margin: 0;">
                        無料版 vs プレミアム版
                    </h3>
                </div>
                
                <!-- 機能比較テーブル -->
                <div style="background: rgba(255, 255, 255, 0.02); border-radius: 12px; overflow: hidden;">
                    <!-- ヘッダー -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; background: rgba(255, 255, 255, 0.05);">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <h4 style="color: white; font-weight: 600; margin: 0;">機能</h4>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i data-lucide="user" style="width: 18px; height: 18px; color: white;"></i>
                                <h4 style="color: white; font-weight: 600; margin: 0;">無料版</h4>
                            </div>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i data-lucide="crown" style="width: 18px; height: 18px; color: white;"></i>
                                <h4 style="color: white; font-weight: 600; margin: 0;">プレミアム版</h4>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ランダムモード -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: white;">ランダム基音モード</span>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <i data-lucide="circle-check-big" style="width: 20px; height: 20px; color: white;"></i>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <i data-lucide="circle-check-big" style="width: 20px; height: 20px; color: white;"></i>
                        </div>
                    </div>
                    
                    <!-- 連続チャレンジモード -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: white;">連続チャレンジモード</span>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <i data-lucide="minus" style="width: 20px; height: 20px; color: #6b7280;"></i>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <i data-lucide="circle-check-big" style="width: 20px; height: 20px; color: white;"></i>
                        </div>
                    </div>
                    
                    <!-- 詳細分析レポート -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: white;">詳細分析レポート</span>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <span style="color: #6b7280; font-size: 0.875rem;">基本表示</span>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <span style="color: white; font-size: 0.875rem;">AI分析付き</span>
                        </div>
                    </div>
                    
                    <!-- 12音階マスターモード -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: white;">12音階マスターモード</span>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <i data-lucide="minus" style="width: 20px; height: 20px; color: #6b7280;"></i>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <i data-lucide="circle-check-big" style="width: 20px; height: 20px; color: white;"></i>
                        </div>
                    </div>
                    
                    <!-- 弱点特定・改善提案 -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: white;">弱点特定・改善提案</span>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <i data-lucide="minus" style="width: 20px; height: 20px; color: #6b7280;"></i>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <i data-lucide="circle-check-big" style="width: 20px; height: 20px; color: white;"></i>
                        </div>
                    </div>
                    
                    <!-- データエクスポート -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr;">
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1);">
                            <span style="color: white;">データエクスポート</span>
                        </div>
                        <div style="padding: 1rem; border-right: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
                            <i data-lucide="minus" style="width: 20px; height: 20px; color: #6b7280;"></i>
                        </div>
                        <div style="padding: 1rem; text-align: center;">
                            <i data-lucide="circle-check-big" style="width: 20px; height: 20px; color: white;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- アクションボタン -->
            <section class="final-actions">
                <a href="training.html" class="btn btn-primary btn-large">
                    <i data-lucide="arrow-right" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    <span>続行</span>
                </a>
                <a href="index.html" class="btn btn-secondary btn-large">
                    <i data-lucide="home" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    <span>ホームに戻る</span>
                </a>
            </section>
        </div>
    </div>

    <script>
        // 8セッション用モックデータ（音別結果付き）
        const sessionsData = [
            { session: 1, baseNote: 'C4', avgError: 12.3, rank: 'excellent', icon: 'trophy', color: 'yellow',
              noteResults: [
                { note: 'ド', error: +8.2, status: 'excellent', targetHz: 262, actualHz: 264 }, 
                { note: 'レ', error: +15.1, status: 'excellent', targetHz: 294, actualHz: 297 },
                { note: 'ミ', error: -12.4, status: 'excellent', targetHz: 330, actualHz: 327 }, 
                { note: 'ファ', error: +9.8, status: 'excellent', targetHz: 349, actualHz: 351 },
                { note: 'ソ', error: +14.2, status: 'excellent', targetHz: 392, actualHz: 395 }, 
                { note: 'ラ', error: -8.7, status: 'excellent', targetHz: 440, actualHz: 437 },
                { note: 'シ', error: +11.5, status: 'excellent', targetHz: 494, actualHz: 497 }, 
                { note: 'ド', error: +13.8, status: 'excellent', targetHz: 523, actualHz: 527 }
              ]
            },
            { session: 2, baseNote: 'D4', avgError: 18.7, rank: 'good', icon: 'star', color: 'green',
              noteResults: [
                { note: 'ド', error: +22.1, status: 'good', targetHz: 294, actualHz: 298 }, 
                { note: 'レ', error: +16.3, status: 'good', targetHz: 330, actualHz: 333 },
                { note: 'ミ', error: -19.8, status: 'good', targetHz: 370, actualHz: 366 }, 
                { note: 'ファ', error: +15.2, status: 'good', targetHz: 392, actualHz: 394 },
                { note: 'ソ', error: +21.4, status: 'good', targetHz: 440, actualHz: 445 }, 
                { note: 'ラ', error: -17.6, status: 'good', targetHz: 494, actualHz: 489 },
                { note: 'シ', error: +18.9, status: 'good', targetHz: 554, actualHz: 560 }, 
                { note: 'ド', error: +12.4, status: 'excellent', targetHz: 587, actualHz: 590 }
              ]
            },
            { session: 3, baseNote: 'E4', avgError: 32.1, rank: 'pass', icon: 'thumbs-up', color: 'blue',
              noteResults: [
                { note: 'ド', error: +35.2, status: 'pass', targetHz: 330, actualHz: 337 }, 
                { note: 'レ', error: +28.7, status: 'pass', targetHz: 370, actualHz: 375 },
                { note: 'ミ', error: -31.4, status: 'pass', targetHz: 415, actualHz: 408 }, 
                { note: 'ファ', error: +39.1, status: 'pass', targetHz: 440, actualHz: 448 },
                { note: 'ソ', error: +25.8, status: 'pass', targetHz: 494, actualHz: 500 }, 
                { note: 'ラ', error: -34.6, status: 'pass', targetHz: 554, actualHz: 543 },
                { note: 'シ', error: +33.2, status: 'pass', targetHz: 622, actualHz: 634 }, 
                { note: 'ド', error: +29.8, status: 'pass', targetHz: 659, actualHz: 671 }
              ]
            },
            { session: 4, baseNote: 'F4', avgError: 14.9, rank: 'excellent', icon: 'trophy', color: 'yellow',
              noteResults: [
                { note: 'ド', error: +12.8, status: 'excellent', targetHz: 349, actualHz: 352 }, 
                { note: 'レ', error: +17.2, status: 'good', targetHz: 392, actualHz: 396 },
                { note: 'ミ', error: -11.4, status: 'excellent', targetHz: 440, actualHz: 437 }, 
                { note: 'ファ', error: +13.7, status: 'excellent', targetHz: 466, actualHz: 469 },
                { note: 'ソ', error: +16.9, status: 'good', targetHz: 523, actualHz: 528 }, 
                { note: 'ラ', error: -14.1, status: 'excellent', targetHz: 587, actualHz: 582 },
                { note: 'シ', error: +15.3, status: 'excellent', targetHz: 659, actualHz: 664 }, 
                { note: 'ド', error: +18.8, status: 'good', targetHz: 698, actualHz: 705 }
              ]
            },
            { session: 5, baseNote: 'G4', avgError: 22.4, rank: 'good', icon: 'star', color: 'green',
              noteResults: [
                { note: 'ド', error: +24.1, status: 'good', targetHz: 392, actualHz: 398 }, 
                { note: 'レ', error: +19.8, status: 'good', targetHz: 440, actualHz: 445 },
                { note: 'ミ', error: -25.7, status: 'pass', targetHz: 494, actualHz: 486 }, 
                { note: 'ファ', error: +21.4, status: 'good', targetHz: 523, actualHz: 529 },
                { note: 'ソ', error: +18.9, status: 'good', targetHz: 587, actualHz: 593 }, 
                { note: 'ラ', error: -23.2, status: 'good', targetHz: 659, actualHz: 649 },
                { note: 'シ', error: +26.8, status: 'pass', targetHz: 740, actualHz: 752 }, 
                { note: 'ド', error: +20.5, status: 'good', targetHz: 784, actualHz: 794 }
              ]
            },
            { session: 6, baseNote: 'A4', avgError: 28.8, rank: 'pass', icon: 'thumbs-up', color: 'blue',
              noteResults: [
                { note: 'ド', error: +31.2, status: 'pass', targetHz: 440, actualHz: 449 }, 
                { note: 'レ', error: +26.4, status: 'pass', targetHz: 494, actualHz: 501 },
                { note: 'ミ', error: -29.8, status: 'pass', targetHz: 554, actualHz: 544 }, 
                { note: 'ファ', error: +33.1, status: 'pass', targetHz: 587, actualHz: 599 },
                { note: 'ソ', error: +24.7, status: 'good', targetHz: 659, actualHz: 669 }, 
                { note: 'ラ', error: -32.5, status: 'pass', targetHz: 740, actualHz: 723 },
                { note: 'シ', error: +35.9, status: 'pass', targetHz: 831, actualHz: 849 }, 
                { note: 'ド', error: +27.6, status: 'pass', targetHz: 880, actualHz: 896 }
              ]
            },
            { session: 7, baseNote: 'B4', avgError: 20.1, rank: 'good', icon: 'star', color: 'green',
              noteResults: [
                { note: 'ド', error: +18.7, status: 'good', targetHz: 494, actualHz: 500 }, 
                { note: 'レ', error: +22.3, status: 'good', targetHz: 554, actualHz: 562 },
                { note: 'ミ', error: -17.9, status: 'good', targetHz: 622, actualHz: 615 }, 
                { note: 'ファ', error: +24.1, status: 'good', targetHz: 659, actualHz: 669 },
                { note: 'ソ', error: +19.5, status: 'good', targetHz: 740, actualHz: 749 }, 
                { note: 'ラ', error: -21.8, status: 'good', targetHz: 831, actualHz: 816 },
                { note: 'シ', error: +16.4, status: 'good', targetHz: 932, actualHz: 942 }, 
                { note: 'ド', error: +23.7, status: 'good', targetHz: 988, actualHz: 1003 }
              ]
            },
            { session: 8, baseNote: 'C5', avgError: 45.2, rank: 'practice', icon: 'triangle-alert', color: 'red',
              noteResults: [
                { note: 'ド', error: +42.3, status: 'practice', targetHz: 523, actualHz: 535 }, 
                { note: 'レ', error: +48.7, status: 'practice', targetHz: 587, actualHz: 604 },
                { note: 'ミ', error: -43.1, status: 'practice', targetHz: 659, actualHz: 642 }, 
                { note: 'ファ', error: +52.4, status: 'practice', targetHz: 698, actualHz: 719 },
                { note: 'ソ', error: +39.8, status: 'pass', targetHz: 784, actualHz: 800 }, 
                { note: 'ラ', error: -46.9, status: 'practice', targetHz: 880, actualHz: 855 },
                { note: 'シ', error: +44.6, status: 'practice', targetHz: 988, actualHz: 1014 }, 
                { note: 'ド', error: +41.8, status: 'practice', targetHz: 1047, actualHz: 1069 }
              ]
            }
        ];
        
        let selectedSession = 1;
        
        // セッショングリッド生成（最小HTML）
        function generateSessionsGrid() {
            const grid = document.getElementById('sessions-grid');
            grid.innerHTML = '';
            
            sessionsData.forEach((session, index) => {
                const box = document.createElement('div');
                box.className = `session-box session-${session.rank} ${selectedSession === session.session ? 'selected' : ''}`;
                box.onclick = () => selectSession(session.session);
                
                box.innerHTML = `
                    <div class="session-number">${session.session}</div>
                    <div class="session-icon">
                        <i data-lucide="${session.icon}" class="text-${session.color}-300"></i>
                    </div>
                `;
                
                grid.appendChild(box);
            });
            
            // Lucideアイコンを初期化
            lucide.createIcons();
        }
        
        // セッション選択
        function selectSession(sessionNum) {
            selectedSession = sessionNum;
            generateSessionsGrid();
            updateDetailedAnalysis();
        }
        
        // 詳細分析更新
        function updateDetailedAnalysis() {
            const session = sessionsData[selectedSession - 1];
            
            document.getElementById('selected-session').textContent = selectedSession;
            document.getElementById('session-base-note').textContent = session.baseNote;
            document.getElementById('session-average-error').textContent = `±${session.avgError}¢`;
            
            // ランクアイコンと色の更新（完全な要素再生成）
            const iconContainer = document.getElementById('session-rank-icon');
            const textElement = document.getElementById('session-rank-text');
            
            // アイコン要素を完全に再生成
            iconContainer.innerHTML = `<i data-lucide="${session.icon}" class="text-${session.color}-300" style="width: 80px; height: 80px;"></i>`;
            
            textElement.textContent = session.rank.charAt(0).toUpperCase() + session.rank.slice(1);
            textElement.className = `text-base md:text-lg font-bold text-${session.color}-300`;
            
            // 音別結果を表示
            const noteResultsHtml = session.noteResults.map(noteResult => {
                const statusColors = {
                    'excellent': 'text-yellow-300',
                    'good': 'text-green-300',
                    'pass': 'text-blue-300', 
                    'practice': 'text-red-300'
                };
                const statusIcons = {
                    'excellent': 'trophy',
                    'good': 'star',
                    'pass': 'thumbs-up',
                    'practice': 'triangle-alert'
                };
                const errorText = `${noteResult.error > 0 ? '+' : ''}${noteResult.error}¢`;
                const colorClass = noteResult.error > 0 ? 'text-red-300' : 'text-blue-300';
                
                return `
                    <div class="note-result-item">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="text-lg font-bold text-white">${noteResult.note}</div>
                                <div>
                                    <div class="text-sm text-white-60">目標 ${noteResult.targetHz}Hz</div>
                                    <div class="text-sm text-white-60">実音 ${noteResult.actualHz}Hz</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="font-bold text-xl ${colorClass}">
                                    ${errorText}
                                </div>
                                <div class="flex items-center justify-center" style="min-width: 36px;">
                                    <i data-lucide="${statusIcons[noteResult.status]}" class="${statusColors[noteResult.status]}" style="width: 24px; height: 24px;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('note-results').innerHTML = noteResultsHtml;
            
            // Lucideアイコンを再初期化
            lucide.createIcons();
        }
        
        // ナビゲーション
        document.getElementById('prev-session-btn').onclick = () => {
            if (selectedSession > 1) selectSession(selectedSession - 1);
        };
        
        document.getElementById('next-session-btn').onclick = () => {
            if (selectedSession < 8) selectSession(selectedSession + 1);
        };
        
        // 数値アニメーション関数
        function animateCountUp(element, targetValue, duration = 1000, isDecimal = false, isMaxError = false) {
            const startTime = performance.now();
            const startValue = 0;
            
            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // イージング関数（ease-out-cubic）
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = startValue + (targetValue - startValue) * easedProgress;
                
                if (isDecimal) {
                    if (isMaxError) {
                        // 最大誤差は実際の符号を表示
                        element.textContent = (targetValue >= 0 ? '+' : '') + currentValue.toFixed(1) + '¢';
                    } else {
                        // 平均誤差は±を表示
                        element.textContent = (targetValue >= 0 ? '±' : '') + currentValue.toFixed(1) + '¢';
                    }
                } else {
                    element.textContent = Math.floor(currentValue);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }
            
            requestAnimationFrame(updateValue);
        }
        
        function animateGradeDisplay(element, finalGrade, totalDuration = 2000) {
            const grades = ['S', 'A', 'B', 'C', 'D', 'E'];
            const finalIndex = grades.indexOf(finalGrade);
            
            if (finalIndex === -1) {
                element.textContent = finalGrade;
                return;
            }
            
            // 全グレード表示にかける時間を計算（総時間の70%）
            const gradeDisplayTime = totalDuration * 0.7;
            const intervalTime = gradeDisplayTime / grades.length;
            let currentIndex = -1;
            
            const gradeInterval = setInterval(() => {
                currentIndex++;
                if (currentIndex < grades.length) {
                    element.textContent = grades[currentIndex];
                } else {
                    clearInterval(gradeInterval);
                    // 残り時間で目的のグレードに戻る
                    const remainingTime = totalDuration - gradeDisplayTime;
                    setTimeout(() => {
                        element.textContent = finalGrade;
                    }, remainingTime / 2);
                }
            }, intervalTime);
        }
        
        function animateStatistics() {
            setTimeout(() => {
                // 全ての数値を初期化
                const avgErrorElement = document.querySelector('.avg-error');
                const maxErrorElement = document.querySelector('.max-error');
                const sessionCountElement = document.querySelector('.session-count');
                const gradeElement = document.getElementById('dynamic-grade');
                
                if (avgErrorElement) avgErrorElement.textContent = '±0.0¢';
                if (maxErrorElement) maxErrorElement.textContent = '+0¢';
                if (sessionCountElement) sessionCountElement.textContent = '0';
                if (gradeElement) gradeElement.textContent = 'S';
                
                const animationDuration = 1500;
                
                setTimeout(() => {
                    // Grade animation - 全グレード表示
                    if (gradeElement) {
                        animateGradeDisplay(gradeElement, 'B', animationDuration);
                    }
                    // Average error animation
                    if (avgErrorElement) {
                        animateCountUp({
                            set textContent(val) { avgErrorElement.textContent = val; }
                        }, 18.2, animationDuration, true);
                    }
                    // Max error animation
                    if (maxErrorElement) {
                        animateCountUp({
                            set textContent(val) { maxErrorElement.textContent = val; }
                        }, 25.8, animationDuration, true, true);
                    }
                    // Session count animation - 白色のまま
                    if (sessionCountElement) {
                        animateCountUp(sessionCountElement, 8, animationDuration, false);
                    }
                }, 300);
            }, 500);
        }
        
        // モックデータ（8セッション分）
        const mockSessionData = [
            { rootNote: 'C', avgError: 22.3, notes: [
                { note: 'ド', error: -15.2 },
                { note: 'レ', error: 28.5 },
                { note: 'ミ', error: -12.8 },
                { note: 'ファ', error: 35.2 },
                { note: 'ソ', error: -18.9 },
                { note: 'ラ', error: 22.4 },
                { note: 'シ', error: -31.5 },
                { note: 'ド\'', error: 13.9 }
            ]},
            { rootNote: 'G', avgError: 18.7, notes: [
                { note: 'ド', error: 12.5 },
                { note: 'レ', error: -25.3 },
                { note: 'ミ', error: 9.8 },
                { note: 'ファ', error: -28.6 },
                { note: 'ソ', error: 14.2 },
                { note: 'ラ', error: -19.8 },
                { note: 'シ', error: 26.3 },
                { note: 'ド\'', error: -13.1 }
            ]},
            { rootNote: 'D', avgError: 15.2, notes: [
                { note: 'ド', error: -10.2 },
                { note: 'レ', error: 18.5 },
                { note: 'ミ', error: -8.3 },
                { note: 'ファ', error: 22.1 },
                { note: 'ソ', error: -11.5 },
                { note: 'ラ', error: 15.8 },
                { note: 'シ', error: -20.2 },
                { note: 'ド\'', error: 15.0 }
            ]},
            { rootNote: 'A', avgError: 19.8, notes: [
                { note: 'ド', error: 14.3 },
                { note: 'レ', error: -26.2 },
                { note: 'ミ', error: 11.5 },
                { note: 'ファ', error: -30.8 },
                { note: 'ソ', error: 16.9 },
                { note: 'ラ', error: -20.5 },
                { note: 'シ', error: 28.1 },
                { note: 'ド\'', error: -10.1 }
            ]},
            { rootNote: 'E', avgError: 16.5, notes: [
                { note: 'ド', error: -11.8 },
                { note: 'レ', error: 20.3 },
                { note: 'ミ', error: -9.2 },
                { note: 'ファ', error: 24.5 },
                { note: 'ソ', error: -13.6 },
                { note: 'ラ', error: 17.2 },
                { note: 'シ', error: -22.8 },
                { note: 'ド\'', error: 12.6 }
            ]},
            { rootNote: 'B', avgError: 21.2, notes: [
                { note: 'ド', error: 16.5 },
                { note: 'レ', error: -29.8 },
                { note: 'ミ', error: 13.2 },
                { note: 'ファ', error: -32.5 },
                { note: 'ソ', error: 18.3 },
                { note: 'ラ', error: -23.1 },
                { note: 'シ', error: 30.2 },
                { note: 'ド\'', error: -6.0 }
            ]},
            { rootNote: 'F', avgError: 14.3, notes: [
                { note: 'ド', error: -9.5 },
                { note: 'レ', error: 17.2 },
                { note: 'ミ', error: -7.8 },
                { note: 'ファ', error: 20.5 },
                { note: 'ソ', error: -10.8 },
                { note: 'ラ', error: 14.6 },
                { note: 'シ', error: -18.9 },
                { note: 'ド\'', error: 15.1 }
            ]},
            { rootNote: 'C#', avgError: 17.9, notes: [
                { note: 'ド', error: 13.2 },
                { note: 'レ', error: -23.5 },
                { note: 'ミ', error: 10.5 },
                { note: 'ファ', error: -26.8 },
                { note: 'ソ', error: 15.2 },
                { note: 'ラ', error: -18.6 },
                { note: 'シ', error: 24.5 },
                { note: 'ド\'', error: -11.0 }
            ]}
        ];
        
        // Chart.js関連の変数とフラグ
        let errorTrendChartAnimated = false;
        let errorTrendObserver = null;
        
        // 誤差推移チャートの初期化
        function initializeErrorTrendChart() {
            const canvas = document.getElementById('error-trend-chart');
            if (!canvas) {
                console.error('Error trend chart canvas not found');
                return;
            }
            
            // Canvas のサイズをコンテナに合わせて設定
            const container = document.getElementById('error-trend-container');
            const wrapper = document.getElementById('chart-wrapper');
            const isMobile = window.innerWidth < 768;
            
            if (container && wrapper) {
                const rect = container.getBoundingClientRect();
                if (isMobile) {
                    // モバイル: 横幅を広げて横スクロール可能に
                    const minWidth = Math.max(800, rect.width); // 最小800px
                    wrapper.style.width = minWidth + 'px';
                    canvas.width = minWidth - 32;
                    canvas.height = rect.height - 32;
                } else {
                    // PC: コンテナに合わせる
                    canvas.width = rect.width - 32;
                    canvas.height = rect.height - 32;
                }
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Failed to get 2D context from canvas');
                return;
            }
            
            console.log('🎯 Initializing error trend chart, animated:', errorTrendChartAnimated);
            
            // レスポンシブ設定: デバイス判定（isMobileの再定義）
            const isMobileChart = window.innerWidth < 768;
            
            // グラフの説明を動的に設定
            const descriptionElement = document.getElementById('chart-description');
            if (descriptionElement) {
                if (isMobileChart) {
                    descriptionElement.innerHTML = `
                        <div class="font-semibold text-white-70">【グラフの見方】</div>
                        <div class="mt-1">縦軸: セッション番号（S1～S8） / 横軸: 平均誤差（セント）</div>
                        <div>0に近いほど正確な音程です</div>
                    `;
                } else {
                    descriptionElement.innerHTML = `
                        <div class="font-semibold text-white-70">【グラフの見方】</div>
                        <div class="mt-1">横軸: セッション別8音 / 縦軸: 誤差（セント）</div>
                        <div>0に近いほど正確な音程です・横スクロールで全体を表示</div>
                    `;
                }
            }
            
            // 既存のチャートインスタンスを破棄
            if (window.errorTrendChartInstance) {
                window.errorTrendChartInstance.destroy();
            }
            
            if (isMobileChart) {
                initializeMobileBarChart(ctx, canvas);
            } else {
                initializePCLineChart(ctx, canvas);
            }
        }
        
        // PC版: Line Chart実装（8セッション用）
        function initializePCLineChart(ctx, canvas) {
            const noteNames = ['ド', 'レ', 'ミ', 'ファ', 'ソ', 'ラ', 'シ', 'ド\''];
            const labels = [];
            const allData = [];
            const colors = [];
            
            // 8セッション分のデータを構築
            mockSessionData.forEach((session, sessionIndex) => {
                session.notes.forEach((noteResult, noteIndex) => {
                    labels.push(`S${sessionIndex + 1}-${noteNames[noteIndex]}`);
                    allData.push(noteResult.error);
                    
                    // 誤差レベルに応じた色分け
                    const absError = Math.abs(noteResult.error);
                    if (absError <= 10) colors.push('rgba(34, 197, 94, 0.8)');      // Green (excellent)
                    else if (absError <= 20) colors.push('rgba(251, 191, 36, 0.8)'); // Yellow (good)  
                    else if (absError <= 35) colors.push('rgba(59, 130, 246, 0.8)');  // Blue (pass)
                    else colors.push('rgba(239, 68, 68, 0.8)');                     // Red (practice)
                });
            });
            
            const dataset = {
                label: '誤差（セント）',
                data: allData,
                borderColor: 'rgba(255, 255, 255, 0.8)',
                backgroundColor: 'rgba(255, 255, 255, 0.1)',
                pointBackgroundColor: colors,
                pointBorderColor: colors,
                pointRadius: 3,
                pointHoverRadius: 5,
                borderWidth: 1.5,  // 線を細く
                tension: 0.3,
                fill: false
            };
            
            window.errorTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [dataset]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: errorTrendChartAnimated ? false : {
                        duration: 800,
                        onComplete: () => {
                            console.log('✅ Error trend chart animation completed (PC Line)');
                            errorTrendChartAnimated = true;
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const sign = value >= 0 ? '+' : '';
                                    return `誤差: ${sign}${value.toFixed(1)}¢`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: function(context) {
                                    // セッションの境界で線を濃く
                                    if (context.index % 8 === 0 && context.index !== 0) {
                                        return 'rgba(255, 255, 255, 0.3)';
                                    }
                                    return 'rgba(255, 255, 255, 0.05)';
                                },
                                lineWidth: function(context) {
                                    if (context.index % 8 === 0 && context.index !== 0) {
                                        return 1.5;
                                    }
                                    return 0.5;
                                }
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: { size: 9 },
                                maxRotation: 45,
                                autoSkip: false,
                                callback: function(value, index) {
                                    // セッションの最初と中間のみラベル表示
                                    const label = this.getLabelForValue(value);
                                    if (index % 8 === 0) {
                                        return label.split('-')[0]; // S1, S2などを表示
                                    } else if (index % 8 === 4) {
                                        return label.split('-')[1]; // 中間の音名
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            min: -40,
                            max: 40,
                            grid: {
                                color: function(context) {
                                    if (context.tick && context.tick.value === 0) {
                                        return 'rgba(255, 255, 255, 0.4)';
                                    }
                                    return 'rgba(255, 255, 255, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick && context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                },
                                drawOnChartArea: true,
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: { size: 10 },
                                stepSize: 20,
                                callback: function(value) {
                                    if (value === 0) return '0';
                                    return value > 0 ? `+${value}¢` : `${value}¢`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // モバイル版: 横向きバーチャート実装（8セッション用）
        function initializeMobileBarChart(ctx, canvas) {
            const labels = mockSessionData.map((session, index) => `セッション${index + 1}`);
            const data = mockSessionData.map(session => session.avgError);
            const backgroundColors = [];
            
            // セッション平均誤差に応じた色分け
            data.forEach(avgError => {
                const absError = Math.abs(avgError);
                let barColor;
                if (absError <= 10) barColor = 'rgba(34, 197, 94, 0.8)';      // Green
                else if (absError <= 20) barColor = 'rgba(251, 191, 36, 0.8)'; // Yellow
                else if (absError <= 35) barColor = 'rgba(59, 130, 246, 0.8)';  // Blue
                else barColor = 'rgba(239, 68, 68, 0.8)';                     // Red
                
                backgroundColors.push(barColor);
            });
            
            window.errorTrendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均誤差',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: errorTrendChartAnimated ? false : {
                        duration: 1000,
                        onComplete: () => {
                            console.log('✅ Error trend chart animation completed (Mobile Bar)');
                            errorTrendChartAnimated = true;
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.x;
                                    const sign = value >= 0 ? '+' : '';
                                    return `平均誤差: ${sign}${value.toFixed(1)}¢`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: function(context) {
                                    if (context.tick && context.tick.value === 0) {
                                        return 'rgba(255, 255, 255, 0.4)';
                                    }
                                    return 'rgba(255, 255, 255, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick && context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: { size: 10 },
                                callback: function(value) {
                                    return value >= 0 ? `+${value}¢` : `${value}¢`;
                                }
                            }
                        },
                        y: {
                            grid: { display: false },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }
        
        // グラフセクションの表示監視
        function observeErrorTrendChart() {
            const errorTrendContainer = document.getElementById('error-trend-container');
            
            if (!errorTrendContainer) {
                console.log('⚠️ Error trend container not found, initializing immediately');
                initializeErrorTrendChart();
                return;
            }
            
            console.log('📊 Setting up error trend chart observer...');
            
            // 既存のオブザーバーをクリーンアップ
            if (errorTrendObserver) {
                errorTrendObserver.disconnect();
                errorTrendObserver = null;
            }
            
            // まだアニメーション済みでない場合のみオブザーバーを設定
            if (!errorTrendChartAnimated) {
                errorTrendObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        console.log('👁️ Intersection observer triggered:', entry.isIntersecting);
                        if (entry.isIntersecting && !errorTrendChartAnimated) {
                            console.log('🎯 Error trend chart visible, initializing...');
                            initializeErrorTrendChart();
                            errorTrendObserver.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '50px'
                });
                
                errorTrendObserver.observe(errorTrendContainer);
                
                // フォールバック: 3秒後にまだ初期化されていなければ強制初期化
                setTimeout(() => {
                    if (!errorTrendChartAnimated) {
                        console.log('⏰ Timeout fallback: forcing chart initialization');
                        initializeErrorTrendChart();
                    }
                }, 3000);
            }
        }
        
        // グラフ要素を新しいセクションに移動
        function moveGraphsToNewSection() {
            // 評価グラフを移動
            const evaluationChart = document.getElementById('evaluation-chart');
            const evaluationContainer = document.getElementById('evaluation-chart-container');
            if (evaluationChart && evaluationContainer) {
                evaluationContainer.appendChild(evaluationChart);
            }
            
            // 誤差推移グラフセクションを移動
            const errorTrendContainer = document.getElementById('error-trend-container');
            const errorTrendSection = document.getElementById('error-trend-section');
            const chartDescription = document.getElementById('chart-description');
            
            if (errorTrendContainer && errorTrendSection) {
                errorTrendSection.appendChild(errorTrendContainer);
                if (chartDescription) {
                    errorTrendSection.appendChild(chartDescription);
                }
            }
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM loaded, starting initialization...');
            
            generateSessionsGrid();
            updateDetailedAnalysis();
            lucide.createIcons();
            animateStatistics();
            
            // グラフを新しいセクションに移動
            moveGraphsToNewSection();
            
            // Chart.js の利用可能性をチェック
            function checkChartJS() {
                if (typeof Chart !== 'undefined') {
                    console.log('✅ Chart.js is available');
                    // グラフセクションの表示監視を開始
                    observeErrorTrendChart();
                    
                    // Canvas要素の存在確認
                    const canvas = document.getElementById('error-trend-chart');
                    console.log('Canvas element:', canvas);
                    
                    // 即座にグラフを初期化（デバッグ用）
                    setTimeout(() => {
                        console.log('🔧 Forcing chart initialization for debugging...');
                        initializeErrorTrendChart();
                    }, 500);
                } else {
                    console.error('❌ Chart.js is not available, retrying...');
                    setTimeout(checkChartJS, 100);
                }
            }
            
            checkChartJS();
            
            // コンテナ要素の存在確認
            const container = document.getElementById('error-trend-container');
            console.log('Container element:', container);
        });

        // SNSシェア機能
        function getShareText() {
            const gradeElement = document.querySelector('#overall-stats > div:first-child .text-4xl');
            const grade = gradeElement ? gradeElement.textContent : 'B';
            const errorElement = document.querySelector('#overall-stats > div:nth-child(2) .text-4xl');
            const error = errorElement ? errorElement.textContent : '±19.8';
            const sessionsElement = document.querySelector('#overall-stats > div:nth-child(4) .text-4xl');
            const sessions = sessionsElement ? sessionsElement.textContent : '8';
            
            return `🎵 8va相対音感トレーニングで【${grade}級】獲得！\n平均誤差: ${error}セント\n${sessions}セッション完走しました！\n\n#相対音感 #音感トレーニング #8va`;
        }
        
        function shareToTwitter(event) {
            event.preventDefault();
            const text = encodeURIComponent(getShareText());
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=450');
        }
        
        function shareToLine(event) {
            event.preventDefault();
            const text = encodeURIComponent(getShareText() + '\n' + window.location.href);
            window.open(`https://social-plugins.line.me/lineit/share?text=${text}`, '_blank', 'width=550,height=450');
        }
        
        function shareToFacebook(event) {
            event.preventDefault();
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=450');
        }
        
        function copyShareText(event) {
            event.preventDefault();
            const text = getShareText() + '\n' + window.location.href;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // ボタンのテキストを一時的に変更
                    const btn = event.currentTarget;
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    `;
                    btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('コピーに失敗しました:', err);
                });
            } else {
                // 旧式のコピー方法
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>
</html>