<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>8va相対音感トレーニング - 総合評価</title>
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="styles/system.css">
    
    <!-- アイコンライブラリ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* 背景アニメーション - UIカタログベース */
        body {
            position: relative;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            -webkit-overflow-scrolling: touch;
            background: #0f172a;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #581c87 50%, #0f172a 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: -1;
            transform: translateZ(0);
            will-change: background-position;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 評価グラフアニメーション */
        @keyframes slideIn {
            from {
                width: 0;
            }
            to {
                width: var(--bar-width);
            }
        }
        
        .evaluation-bar {
            animation: slideIn 0.8s ease-out forwards;
            animation-delay: var(--delay);
        }
        
        /* 8セッション専用グリッド */
        .sessions-grid-8 {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .sessions-grid-8 {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .sessions-grid-8 {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }
        }
        
        /* セッションボックス - UIカタログベース（改良版） */
        .session-box {
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .session-box:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .session-box.selected {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        /* レスポンシブ セッション番号 */
        .session-number {
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        /* 8個表示時のサイズ（デスクトップ） */
        .sessions-grid-8 .session-number {
            font-size: 1rem;
        }
        
        .sessions-grid-8 .session-icon i {
            width: 24px;
            height: 24px;
        }
        
        /* 4x2表示時のサイズ（タブレット・モバイル） */
        @media (max-width: 768px) {
            .sessions-grid-8 .session-number {
                font-size: 0.875rem;
            }
            
            .sessions-grid-8 .session-icon i {
                width: 20px;
                height: 20px;
            }
        }
        
        /* 12個表示時の対応（将来用） */
        .sessions-grid-12 .session-number {
            font-size: 0.875rem;
        }
        
        .sessions-grid-12 .session-icon i {
            width: 20px;
            height: 20px;
        }
        
        /* 評価レベル別色 - UIカタログから */
        .session-excellent {
            background: rgba(251, 191, 36, 0.2);
            border-color: rgba(251, 191, 36, 0.3);
        }
        
        .session-good {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.3);
        }
        
        .session-pass {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .session-practice {
            background: rgba(239, 68, 68, 0.2);
            border-color: rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container">
            <!-- ヘッダーセクション -->
            <div class="text-center mb-8">
                <div class="flex justify-center mb-6">
                    <div class="page-header-icon page-header-icon-purple animate-float">
                        <i data-lucide="file-chart-column-increasing" class="icon-2xl text-white" data-stroke-width="2"></i>
                    </div>
                </div>
                <h1 class="text-4xl font-bold text-white mb-4">総合評価</h1>
                <p class="text-green-200 text-xl mb-6">8セッション完了 - あなたの相対音感能力を分析</p>
            </div>

            <!-- 総合評価セクション -->
            <div class="glass-card mb-8">
                <section class="rank-section">
                    <!-- モード名 -->
                    <div class="rank-mode">
                        <h3 class="mode-title" id="main-mode-title">ランダム基音モード</h3>
                    </div>
                    
                    <!-- グレードアイコンと統計情報を横一列に -->
                    <div class="rank-content-row">
                        <!-- グレードアイコン -->
                        <div class="rank-icon">
                            <div class="rank-circle rank-md rank-circle-b">
                                <i data-lucide="circle-star" class="text-white" style="width: 64px; height: 64px;"></i>
                            </div>
                        </div>
                        
                        <!-- 統計情報 -->
                        <div class="rank-stats-row">
                            <div class="rank-stat-item">
                                <div class="stat-value-rank grade-value" id="dynamic-grade">B</div>
                                <div class="stat-label-rank">総合グレード</div>
                            </div>
                            <div class="rank-stat-item">
                                <div class="stat-value-rank stat-value-avg-error avg-error">±18.2¢</div>
                                <div class="stat-label-rank">平均誤差（セント）</div>
                            </div>
                            <div class="rank-stat-item">
                                <div class="stat-value-rank max-error">+25.8¢</div>
                                <div class="stat-label-rank">最大誤差（セント）</div>
                            </div>
                            <div class="rank-stat-item">
                                <div class="stat-value-rank stat-value-session-count session-count">8</div>
                                <div class="stat-label-rank">セッション数</div>
                            </div>
                        </div>
                        
                        <!-- ランク取得メッセージ -->
                        <div class="rank-achievement-message" style="margin-top: 0px; margin-bottom: 0px; text-align: center;">
                            <p id="share-message" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin: 0;">
                                B級ランク取得！グッドプレイヤー！
                            </p>
                        </div>
                    </div>
                </section>
                
                <!-- 評価内訳 -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-white mb-4 text-center">8セッション64音の評価内訳</h3>
                    
                    <!-- 評価グラフ -->
                    <div class="mb-6" id="evaluation-chart" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 0 1rem;">
                        <!-- Excellent -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="trophy" class="text-yellow-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 25%; --delay: 0.1s; width: 0; height: 100%; background: #fbbf24; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">16</span>
                            </div>
                        </div>
                        
                        <!-- Good -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="star" class="text-green-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 37.5%; --delay: 0.2s; width: 0; height: 100%; background: #22c55e; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">24</span>
                            </div>
                        </div>
                        
                        <!-- Pass -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="thumbs-up" class="text-blue-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 25%; --delay: 0.3s; width: 0; height: 100%; background: #3b82f6; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">16</span>
                            </div>
                        </div>
                        
                        <!-- Practice -->
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <i data-lucide="triangle-alert" class="text-red-300" style="width: 20px; height: 20px; flex-shrink: 0;"></i>
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <div style="flex: 1; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 3px; overflow: hidden;">
                                    <div class="evaluation-bar" style="--bar-width: 12.5%; --delay: 0.4s; width: 0; height: 100%; background: #ef4444; border-radius: 3px;"></div>
                                </div>
                                <span class="text-sm text-white-60" style="min-width: 20px; text-align: right;">8</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- セッション別成績 -->
            <div class="glass-card mb-8">
                <h3 class="text-2xl font-bold text-white mb-6">セッション別成績</h3>
                <p class="text-white-70 text-sm mb-4">
                    <span class="lg:hidden">セッションをタップして詳細分析を表示</span>
                    <span class="hidden lg:inline">セッションをクリックして詳細分析を表示</span>
                </p>
                <div class="sessions-grid-8" id="sessions-grid">
                    <!-- JavaScriptで8セッション分のHTMLを生成 -->
                </div>
            </div>
            
            <!-- 詳細分析 -->
            <div class="glass-card mb-8" id="detailed-analysis-section">
                <div class="flex items-center justify-between mb-6">
                    <button id="prev-session-btn" class="glass-card-sm hover:bg-white/10 transition-colors cursor-pointer flex-shrink-0">
                        <i data-lucide="chevron-left" class="text-white" style="width: 24px; height: 24px;"></i>
                    </button>
                    <h3 class="text-xl font-bold text-white text-center flex-1 px-2">
                        <div>詳細分析</div>
                        <div class="text-lg mt-1">セッション<span id="selected-session">1</span></div>
                    </h3>
                    <button id="next-session-btn" class="glass-card-sm hover:bg-white/10 transition-colors cursor-pointer flex-shrink-0">
                        <i data-lucide="chevron-right" class="text-white" style="width: 24px; height: 24px;"></i>
                    </button>
                </div>
                
                <!-- セッション詳細情報 -->
                <div class="mb-4 text-center" id="session-info">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; align-items: end; min-height: 80px;">
                        <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: center; height: 100%;">
                            <div class="text-2xl md:text-4xl font-bold text-white" id="session-base-note">C4</div>
                            <p class="text-xs md:text-base text-green-200">基音</p>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; height: 100%;">
                            <div class="mb-2" id="session-rank-icon">
                                <i data-lucide="thumbs-up" class="text-blue-300" style="width: 80px; height: 80px;"></i>
                            </div>
                            <p class="text-base md:text-lg font-bold text-blue-300" id="session-rank-text">Pass</p>
                        </div>
                        <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: center; height: 100%;">
                            <div class="text-2xl md:text-4xl font-bold text-white" id="session-average-error">±12.3¢</div>
                            <p class="text-xs md:text-base text-green-200">セッション平均誤差</p>
                        </div>
                    </div>
                </div>
                
                <!-- 音別詳細結果 -->
                <div class="space-y-2" id="note-results">
                    <!-- JavaScriptで生成 -->
                </div>
            </div>
            
            <!-- アクションボタン -->
            <section class="final-actions">
                <a href="training.html" class="btn btn-primary btn-large">
                    <i data-lucide="arrow-right" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    <span>続行</span>
                </a>
                <a href="index.html" class="btn btn-secondary btn-large">
                    <i data-lucide="home" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    <span>ホームに戻る</span>
                </a>
            </section>
        </div>
    </div>

    <script>
        // 8セッション用モックデータ（音別結果付き）
        const sessionsData = [
            { session: 1, baseNote: 'C4', avgError: 12.3, rank: 'excellent', icon: 'trophy', color: 'yellow',
              noteResults: [
                { note: 'ド', error: +8.2, status: 'excellent', targetHz: 262, actualHz: 264 }, 
                { note: 'レ', error: +15.1, status: 'excellent', targetHz: 294, actualHz: 297 },
                { note: 'ミ', error: -12.4, status: 'excellent', targetHz: 330, actualHz: 327 }, 
                { note: 'ファ', error: +9.8, status: 'excellent', targetHz: 349, actualHz: 351 },
                { note: 'ソ', error: +14.2, status: 'excellent', targetHz: 392, actualHz: 395 }, 
                { note: 'ラ', error: -8.7, status: 'excellent', targetHz: 440, actualHz: 437 },
                { note: 'シ', error: +11.5, status: 'excellent', targetHz: 494, actualHz: 497 }, 
                { note: 'ド', error: +13.8, status: 'excellent', targetHz: 523, actualHz: 527 }
              ]
            },
            { session: 2, baseNote: 'D4', avgError: 18.7, rank: 'good', icon: 'star', color: 'green',
              noteResults: [
                { note: 'ド', error: +22.1, status: 'good', targetHz: 294, actualHz: 298 }, 
                { note: 'レ', error: +16.3, status: 'good', targetHz: 330, actualHz: 333 },
                { note: 'ミ', error: -19.8, status: 'good', targetHz: 370, actualHz: 366 }, 
                { note: 'ファ', error: +15.2, status: 'good', targetHz: 392, actualHz: 394 },
                { note: 'ソ', error: +21.4, status: 'good', targetHz: 440, actualHz: 445 }, 
                { note: 'ラ', error: -17.6, status: 'good', targetHz: 494, actualHz: 489 },
                { note: 'シ', error: +18.9, status: 'good', targetHz: 554, actualHz: 560 }, 
                { note: 'ド', error: +12.4, status: 'excellent', targetHz: 587, actualHz: 590 }
              ]
            },
            { session: 3, baseNote: 'E4', avgError: 32.1, rank: 'pass', icon: 'thumbs-up', color: 'blue',
              noteResults: [
                { note: 'ド', error: +35.2, status: 'pass', targetHz: 330, actualHz: 337 }, 
                { note: 'レ', error: +28.7, status: 'pass', targetHz: 370, actualHz: 375 },
                { note: 'ミ', error: -31.4, status: 'pass', targetHz: 415, actualHz: 408 }, 
                { note: 'ファ', error: +39.1, status: 'pass', targetHz: 440, actualHz: 448 },
                { note: 'ソ', error: +25.8, status: 'pass', targetHz: 494, actualHz: 500 }, 
                { note: 'ラ', error: -34.6, status: 'pass', targetHz: 554, actualHz: 543 },
                { note: 'シ', error: +33.2, status: 'pass', targetHz: 622, actualHz: 634 }, 
                { note: 'ド', error: +29.8, status: 'pass', targetHz: 659, actualHz: 671 }
              ]
            },
            { session: 4, baseNote: 'F4', avgError: 14.9, rank: 'excellent', icon: 'trophy', color: 'yellow',
              noteResults: [
                { note: 'ド', error: +12.8, status: 'excellent', targetHz: 349, actualHz: 352 }, 
                { note: 'レ', error: +17.2, status: 'good', targetHz: 392, actualHz: 396 },
                { note: 'ミ', error: -11.4, status: 'excellent', targetHz: 440, actualHz: 437 }, 
                { note: 'ファ', error: +13.7, status: 'excellent', targetHz: 466, actualHz: 469 },
                { note: 'ソ', error: +16.9, status: 'good', targetHz: 523, actualHz: 528 }, 
                { note: 'ラ', error: -14.1, status: 'excellent', targetHz: 587, actualHz: 582 },
                { note: 'シ', error: +15.3, status: 'excellent', targetHz: 659, actualHz: 664 }, 
                { note: 'ド', error: +18.8, status: 'good', targetHz: 698, actualHz: 705 }
              ]
            },
            { session: 5, baseNote: 'G4', avgError: 22.4, rank: 'good', icon: 'star', color: 'green',
              noteResults: [
                { note: 'ド', error: +24.1, status: 'good', targetHz: 392, actualHz: 398 }, 
                { note: 'レ', error: +19.8, status: 'good', targetHz: 440, actualHz: 445 },
                { note: 'ミ', error: -25.7, status: 'pass', targetHz: 494, actualHz: 486 }, 
                { note: 'ファ', error: +21.4, status: 'good', targetHz: 523, actualHz: 529 },
                { note: 'ソ', error: +18.9, status: 'good', targetHz: 587, actualHz: 593 }, 
                { note: 'ラ', error: -23.2, status: 'good', targetHz: 659, actualHz: 649 },
                { note: 'シ', error: +26.8, status: 'pass', targetHz: 740, actualHz: 752 }, 
                { note: 'ド', error: +20.5, status: 'good', targetHz: 784, actualHz: 794 }
              ]
            },
            { session: 6, baseNote: 'A4', avgError: 28.8, rank: 'pass', icon: 'thumbs-up', color: 'blue',
              noteResults: [
                { note: 'ド', error: +31.2, status: 'pass', targetHz: 440, actualHz: 449 }, 
                { note: 'レ', error: +26.4, status: 'pass', targetHz: 494, actualHz: 501 },
                { note: 'ミ', error: -29.8, status: 'pass', targetHz: 554, actualHz: 544 }, 
                { note: 'ファ', error: +33.1, status: 'pass', targetHz: 587, actualHz: 599 },
                { note: 'ソ', error: +24.7, status: 'good', targetHz: 659, actualHz: 669 }, 
                { note: 'ラ', error: -32.5, status: 'pass', targetHz: 740, actualHz: 723 },
                { note: 'シ', error: +35.9, status: 'pass', targetHz: 831, actualHz: 849 }, 
                { note: 'ド', error: +27.6, status: 'pass', targetHz: 880, actualHz: 896 }
              ]
            },
            { session: 7, baseNote: 'B4', avgError: 20.1, rank: 'good', icon: 'star', color: 'green',
              noteResults: [
                { note: 'ド', error: +18.7, status: 'good', targetHz: 494, actualHz: 500 }, 
                { note: 'レ', error: +22.3, status: 'good', targetHz: 554, actualHz: 562 },
                { note: 'ミ', error: -17.9, status: 'good', targetHz: 622, actualHz: 615 }, 
                { note: 'ファ', error: +24.1, status: 'good', targetHz: 659, actualHz: 669 },
                { note: 'ソ', error: +19.5, status: 'good', targetHz: 740, actualHz: 749 }, 
                { note: 'ラ', error: -21.8, status: 'good', targetHz: 831, actualHz: 816 },
                { note: 'シ', error: +16.4, status: 'good', targetHz: 932, actualHz: 942 }, 
                { note: 'ド', error: +23.7, status: 'good', targetHz: 988, actualHz: 1003 }
              ]
            },
            { session: 8, baseNote: 'C5', avgError: 45.2, rank: 'practice', icon: 'triangle-alert', color: 'red',
              noteResults: [
                { note: 'ド', error: +42.3, status: 'practice', targetHz: 523, actualHz: 535 }, 
                { note: 'レ', error: +48.7, status: 'practice', targetHz: 587, actualHz: 604 },
                { note: 'ミ', error: -43.1, status: 'practice', targetHz: 659, actualHz: 642 }, 
                { note: 'ファ', error: +52.4, status: 'practice', targetHz: 698, actualHz: 719 },
                { note: 'ソ', error: +39.8, status: 'pass', targetHz: 784, actualHz: 800 }, 
                { note: 'ラ', error: -46.9, status: 'practice', targetHz: 880, actualHz: 855 },
                { note: 'シ', error: +44.6, status: 'practice', targetHz: 988, actualHz: 1014 }, 
                { note: 'ド', error: +41.8, status: 'practice', targetHz: 1047, actualHz: 1069 }
              ]
            }
        ];
        
        let selectedSession = 1;
        
        // セッショングリッド生成（最小HTML）
        function generateSessionsGrid() {
            const grid = document.getElementById('sessions-grid');
            grid.innerHTML = '';
            
            sessionsData.forEach((session, index) => {
                const box = document.createElement('div');
                box.className = `session-box session-${session.rank} ${selectedSession === session.session ? 'selected' : ''}`;
                box.onclick = () => selectSession(session.session);
                
                box.innerHTML = `
                    <div class="session-number">${session.session}</div>
                    <div class="session-icon">
                        <i data-lucide="${session.icon}" class="text-${session.color}-300"></i>
                    </div>
                `;
                
                grid.appendChild(box);
            });
            
            // Lucideアイコンを初期化
            lucide.createIcons();
        }
        
        // セッション選択
        function selectSession(sessionNum) {
            selectedSession = sessionNum;
            generateSessionsGrid();
            updateDetailedAnalysis();
        }
        
        // 詳細分析更新
        function updateDetailedAnalysis() {
            const session = sessionsData[selectedSession - 1];
            
            document.getElementById('selected-session').textContent = selectedSession;
            document.getElementById('session-base-note').textContent = session.baseNote;
            document.getElementById('session-average-error').textContent = `±${session.avgError}¢`;
            
            // ランクアイコンと色の更新（完全な要素再生成）
            const iconContainer = document.getElementById('session-rank-icon');
            const textElement = document.getElementById('session-rank-text');
            
            // アイコン要素を完全に再生成
            iconContainer.innerHTML = `<i data-lucide="${session.icon}" class="text-${session.color}-300" style="width: 80px; height: 80px;"></i>`;
            
            textElement.textContent = session.rank.charAt(0).toUpperCase() + session.rank.slice(1);
            textElement.className = `text-base md:text-lg font-bold text-${session.color}-300`;
            
            // 音別結果を表示
            const noteResultsHtml = session.noteResults.map(noteResult => {
                const statusColors = {
                    'excellent': 'text-yellow-300',
                    'good': 'text-green-300',
                    'pass': 'text-blue-300', 
                    'practice': 'text-red-300'
                };
                const statusIcons = {
                    'excellent': 'trophy',
                    'good': 'star',
                    'pass': 'thumbs-up',
                    'practice': 'triangle-alert'
                };
                const errorText = `${noteResult.error > 0 ? '+' : ''}${noteResult.error}¢`;
                const colorClass = noteResult.error > 0 ? 'text-red-300' : 'text-blue-300';
                
                return `
                    <div class="note-result-item">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="text-lg font-bold text-white">${noteResult.note}</div>
                                <div>
                                    <div class="text-sm text-white-60">目標 ${noteResult.targetHz}Hz</div>
                                    <div class="text-sm text-white-60">実音 ${noteResult.actualHz}Hz</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="font-bold text-xl ${colorClass}">
                                    ${errorText}
                                </div>
                                <div class="flex items-center justify-center" style="min-width: 36px;">
                                    <i data-lucide="${statusIcons[noteResult.status]}" class="${statusColors[noteResult.status]}" style="width: 24px; height: 24px;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('note-results').innerHTML = noteResultsHtml;
            
            // Lucideアイコンを再初期化
            lucide.createIcons();
        }
        
        // ナビゲーション
        document.getElementById('prev-session-btn').onclick = () => {
            if (selectedSession > 1) selectSession(selectedSession - 1);
        };
        
        document.getElementById('next-session-btn').onclick = () => {
            if (selectedSession < 8) selectSession(selectedSession + 1);
        };
        
        // 数値アニメーション関数
        function animateCountUp(element, targetValue, duration = 1000, isDecimal = false) {
            const startTime = performance.now();
            const startValue = 0;
            
            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // イージング関数（ease-out-cubic）
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = startValue + (targetValue - startValue) * easedProgress;
                
                if (isDecimal) {
                    element.textContent = (targetValue >= 0 ? '±' : '') + currentValue.toFixed(1) + '¢';
                } else {
                    element.textContent = Math.floor(currentValue);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                }
            }
            
            requestAnimationFrame(updateValue);
        }
        
        function animateGradeDisplay(element, finalGrade, totalDuration = 2000) {
            const grades = ['S', 'A', 'B', 'C', 'D', 'E'];
            const finalIndex = grades.indexOf(finalGrade);
            
            if (finalIndex === -1) {
                element.textContent = finalGrade;
                return;
            }
            
            // 全グレード表示にかける時間を計算（総時間の70%）
            const gradeDisplayTime = totalDuration * 0.7;
            const intervalTime = gradeDisplayTime / grades.length;
            let currentIndex = -1;
            
            const gradeInterval = setInterval(() => {
                currentIndex++;
                if (currentIndex < grades.length) {
                    element.textContent = grades[currentIndex];
                } else {
                    clearInterval(gradeInterval);
                    // 残り時間で目的のグレードに戻る
                    const remainingTime = totalDuration - gradeDisplayTime;
                    setTimeout(() => {
                        element.textContent = finalGrade;
                    }, remainingTime / 2);
                }
            }, intervalTime);
        }
        
        function animateStatistics() {
            setTimeout(() => {
                // 全ての数値を初期化
                const avgErrorElement = document.querySelector('.avg-error');
                const maxErrorElement = document.querySelector('.max-error');
                const sessionCountElement = document.querySelector('.session-count');
                const gradeElement = document.getElementById('dynamic-grade');
                
                if (avgErrorElement) avgErrorElement.textContent = '±0.0¢';
                if (maxErrorElement) maxErrorElement.textContent = '+0¢';
                if (sessionCountElement) sessionCountElement.textContent = '0';
                if (gradeElement) gradeElement.textContent = 'S';
                
                const animationDuration = 1500;
                
                setTimeout(() => {
                    // Grade animation - 全グレード表示
                    if (gradeElement) {
                        animateGradeDisplay(gradeElement, 'B', animationDuration);
                    }
                    // Average error animation
                    if (avgErrorElement) {
                        animateCountUp({
                            set textContent(val) { avgErrorElement.textContent = val; }
                        }, 18.2, animationDuration, true);
                    }
                    // Max error animation
                    if (maxErrorElement) {
                        animateCountUp({
                            set textContent(val) { maxErrorElement.textContent = val; }
                        }, 25.8, animationDuration, true);
                    }
                    // Session count animation - 白色のまま
                    if (sessionCountElement) {
                        animateCountUp(sessionCountElement, 8, animationDuration, false);
                    }
                }, 300);
            }, 500);
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            generateSessionsGrid();
            updateDetailedAnalysis();
            lucide.createIcons();
            animateStatistics();
        });
    </script>
</body>
</html>