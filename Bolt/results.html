<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8va相対音感トレーニング - 総合評価</title>
    <link rel="stylesheet" href="styles/system.css?v=4">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* 背景グラデーションアニメーション */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* フローティングアニメーション */
        .page-header-icon {
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        /* SNSシェアセクション */
        .share-section {
            margin: 2rem 0;
            animation: fadeInUp 0.8s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .share-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .share-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 11s infinite;
        }
        
        @keyframes shimmer {
            0% { 
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 1;
            }
            9.1% { 
                transform: translateX(100%) translateY(100%) rotate(45deg);
                opacity: 1;
            }
            9.2% { 
                transform: translateX(100%) translateY(100%) rotate(45deg);
                opacity: 0;
            }
            99.9% { 
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 0;
            }
            100% { 
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
                opacity: 1;
            }
        }
        
        .share-card h3 {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .share-card p {
            color: white;
            margin-bottom: 1.5rem;
            font-size: 1rem;
        }
        
        /* rank-sectionスタイル（新横一列レイアウト） */
        .rank-section {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .rank-mode {
            margin-bottom: 24px;
        }
        
        .rank-section .mode-title {
            font-size: 2.0rem !important;
            font-weight: 700;
            color: white;
            margin: 0;
        }
        
        .rank-content-row {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 24px;
        }
        
        .rank-icon {
            flex-shrink: 0;
        }
        
        .rank-stats-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            flex-wrap: wrap;
        }
        
        .rank-stat-item {
            text-align: center;
            min-width: 80px;
        }
        
        .stat-value-rank {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 4px;
            transition: transform 0.2s ease;
            line-height: 1;
        }
        
        .stat-value-rank.grade-value {
            font-size: 2.0rem;
            color: #ffffff; /* グレードは白色 */
        }
        
        .stat-value-rank.avg-error {
            color: #fbbf24; /* 平均誤差もグレードと同じ黄色 */
        }
        
        .stat-label-rank {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.1;
            margin: 0;
            white-space: nowrap;
        }
        
        .rank-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            .rank-content-row {
                gap: 20px;
            }
            
            .rank-stats-row {
                gap: 20px;
            }
            
            .rank-circle {
                width: 80px;
                height: 80px;
            }
            
            .rank-circle i {
                width: 48px !important;
                height: 48px !important;
            }
            
            .stat-value-rank {
                font-size: 1.5rem;
            }
            
            .stat-value-rank.grade-value {
                font-size: 2rem;
            }
        }
        
        .share-buttons {
            display: flex;
            gap: 1.2rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .share-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .share-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            padding: 1px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
        
        .share-btn:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.2);
        }
        
        .share-btn svg {
            width: 24px;
            height: 24px;
            z-index: 1;
        }
        
        .share-btn.twitter:hover {
            box-shadow: 0 8px 25px rgba(29, 161, 242, 0.4), 0 0 30px rgba(29, 161, 242, 0.3);
        }
        
        .share-btn.line:hover {
            box-shadow: 0 8px 25px rgba(0, 195, 0, 0.4), 0 0 30px rgba(0, 195, 0, 0.3);
        }
        
        .share-btn.facebook:hover {
            box-shadow: 0 8px 25px rgba(24, 119, 242, 0.4), 0 0 30px rgba(24, 119, 242, 0.3);
        }
        
        .share-btn.copy:hover {
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4), 0 0 30px rgba(139, 92, 246, 0.3);
        }
        
        @media (max-width: 640px) {
            .share-btn {
                width: 48px;
                height: 48px;
            }
            
            .share-btn svg {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex justify-center mb-6">
                    <div class="page-header-icon page-header-icon-purple">
                        <i data-lucide="file-chart-column-increasing" class="icon-2xl text-white" data-stroke-width="2"></i>
                    </div>
                </div>
                <h1 class="text-4xl font-bold text-white mb-4">総合評価</h1>
                <p class="text-green-200 text-xl mb-6">12セッション完了 - あなたの音感レベルを分析しました</p>
                
            </div>

            <!-- SNSシェアセクション -->
            <div class="share-section" id="share-section">
                <div class="share-card">
                    <!-- rank-section -->
                    <section class="rank-section">
                        <!-- モード名 -->
                        <div class="rank-mode">
                            <h3 class="mode-title">ランダム基音モード</h3>
                        </div>
                        
                        <!-- グレードアイコンと統計情報を横一列に -->
                        <div class="rank-content-row">
                            <!-- グレードアイコン -->
                            <div class="rank-icon">
                                <div class="rank-circle" style="background: linear-gradient(135deg, #fbbf24, #d97706);">
                                    <i data-lucide="crown" style="width: 64px; height: 64px; color: white;"></i>
                                </div>
                            </div>
                            
                            <!-- 統計情報 -->
                            <div class="rank-stats-row">
                                <div class="rank-stat-item">
                                    <div class="stat-value-rank grade-value">B</div>
                                    <div class="stat-label-rank">総合グレード</div>
                                </div>
                                <div class="rank-stat-item">
                                    <div class="stat-value-rank avg-error" style="color: #fbbf24;">±0.0¢</div>
                                    <div class="stat-label-rank">平均誤差（セント）</div>
                                </div>
                                <div class="rank-stat-item">
                                    <div class="stat-value-rank max-error">±0.0¢</div>
                                    <div class="stat-label-rank">最大誤差（セント）</div>
                                </div>
                                <div class="rank-stat-item">
                                    <div class="stat-value-rank session-count">0</div>
                                    <div class="stat-label-rank">セッション数</div>
                                </div>
                            </div>
                            
                            <!-- ランク取得メッセージ -->
                            <div class="rank-achievement-message" style="margin-top: 0px; margin-bottom: 0px; text-align: center;">
                                <p id="share-message" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; margin: 0;">
                                    B級ランク取得！グッドプレイヤー！
                                </p>
                            </div>
                        </div>
                    </section>
                    
                    <h3 style="margin-top: 0px; margin-bottom: 24px;">みんなに成果をシェアしよう！</h3>
                    <div class="share-buttons">
                        <a href="#" class="share-btn twitter" onclick="shareToTwitter(event)" title="Xでシェア">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                            </svg>
                        </a>
                        <a href="#" class="share-btn line" onclick="shareToLine(event)" title="LINEで送る">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.349 0 .63.285.63.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.627-.63.348 0 .631.285.631.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.282.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
                            </svg>
                        </a>
                        <a href="#" class="share-btn facebook" onclick="shareToFacebook(event)" title="Facebookでシェア">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                            </svg>
                        </a>
                        <button class="share-btn copy" onclick="copyShareText(event)" title="リンクをコピー">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Overall Statistics (hidden - moved to rank-section) -->
            <div class="glass-card mb-8" id="overall-stats-container" style="display: none; max-width: 100vw; overflow-x: hidden;">
                <div class="grid grid-cols-4 gap-6 mb-8" id="overall-stats">
                    <!-- Stats will be populated by JavaScript -->
                </div>
            </div>

            <!-- Performance Charts -->
            <div class="glass-card mb-8" style="max-width: 100vw; overflow-x: hidden;">
                <div class="block md:grid md:grid-cols-2 gap-4 md:gap-8">
                    <!-- Error Trend Chart -->
                    <div class="mb-8 md:mb-0">
                        <h3 class="text-xl font-bold text-white mb-4">誤差推移</h3>
                        <div class="relative bg-white/5 rounded-lg p-0 md:p-4" id="error-trend-container" style="height: 280px;">
                            <canvas id="error-trend-chart"></canvas>
                        </div>
                        <div class="text-xs text-white-60 text-center mt-2" id="chart-description" style="min-height: 80px; height: auto;">
                            <!-- グラフの説明はJavaScriptで動的に設定 -->
                        </div>
                    </div>
                    
                    <!-- Accuracy Chart -->
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4">評価分布</h3>
                        <div class="bg-white/5 rounded-lg" style="height: 200px;">
                            <canvas id="accuracy-chart" width="400" height="200"></canvas>
                        </div>
                        <div class="text-xs text-white-60 text-center mt-2">12セッションの評価内訳</div>
                    </div>
                </div>
            </div>

            <!-- Sessions Overview -->
            <div class="glass-card mb-8">
                <h3 class="text-2xl font-bold text-white mb-6">12セッション概要</h3>
                <p class="text-white-70 text-sm mb-4">
                    <span class="lg:hidden">セッションをタップして詳細分析を表示</span>
                    <span class="hidden lg:inline">セッションをクリックして詳細分析を表示</span>
                </p>
                <div class="grid grid-cols-12 gap-3" id="sessions-grid">
                    <!-- Sessions will be populated by JavaScript -->
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="glass-card mb-8">
                <div class="flex items-center justify-between mb-6">
                    <button id="prev-session-btn" class="glass-card-sm hover:bg-white/10 transition-colors cursor-pointer flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                            <path d="m15 18-6-6 6-6"/>
                        </svg>
                    </button>
                    <h3 class="text-xl font-bold text-white text-center flex-1 px-2">
                        <div>詳細分析</div>
                        <div class="text-lg mt-1">セッション<span id="selected-session">1</span></div>
                    </h3>
                    <button id="next-session-btn" class="glass-card-sm hover:bg-white/10 transition-colors cursor-pointer flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white">
                            <path d="m9 18 6-6-6-6"/>
                        </svg>
                    </button>
                </div>
                <div class="mb-4 text-center" id="session-info">
                    <!-- Session info will be populated by JavaScript -->
                </div>
                <div class="space-y-2" id="note-results">
                    <!-- Note results will be populated by JavaScript -->
                </div>
            </div>


            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row justify-center space-y-3 md:space-y-0 md:space-x-4">
                <a href="records.html" class="btn btn-primary min-w-0" style="white-space: nowrap; font-size: 0.875rem; padding: 0.75rem 1rem;">
                    <svg class="icon-sm mr-2 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M3 3h18v18H3z"/>
                        <path d="M21 9H3"/>
                        <path d="M9 21V9"/>
                    </svg>
                    記録を見る
                </a>
                <a href="index.html" class="btn btn-secondary min-w-0" style="white-space: nowrap; font-size: 0.875rem; padding: 0.75rem 1rem;">
                    ホームに戻る
                </a>
                <a href="mic-test.html" class="btn btn-primary min-w-0" style="white-space: nowrap; font-size: 0.875rem; padding: 0.75rem 1rem;">
                    再チャレンジ
                </a>
            </div>
        </div>
    </div>

    <script>
        // Mock session data
        const mockSessionsData = [
            { session: 1, baseNote: 'C4', accuracy: 87.5, averageCentError: 12.1 },
            { session: 2, baseNote: 'D4', accuracy: 82.3, averageCentError: 28.4 },
            { session: 3, baseNote: 'E4', accuracy: 89.1, averageCentError: 14.7 },
            { session: 4, baseNote: 'F4', accuracy: 91.2, averageCentError: 10.8 },
            { session: 5, baseNote: 'G4', accuracy: 78.9, averageCentError: 30.2 },
            { session: 6, baseNote: 'A4', accuracy: 88.7, averageCentError: 18.9 },
            { session: 7, baseNote: 'B4', accuracy: 92.4, averageCentError: 11.3 },
            { session: 8, baseNote: 'C5', accuracy: 85.6, averageCentError: 22.7 },
            { session: 9, baseNote: 'C#4', accuracy: 84.2, averageCentError: 26.1 },
            { session: 10, baseNote: 'D#4', accuracy: 73.8, averageCentError: 45.3 },
            { session: 11, baseNote: 'F#4', accuracy: 90.3, averageCentError: 13.9 },
            { session: 12, baseNote: 'G#4', accuracy: 62.1, averageCentError: 48.7 }
        ];

        // Simple pseudo-random number generator with seed
        function seededRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // Generate session-specific note results with consistent seed
        function generateSessionNoteResults(sessionData) {
            const noteNames = ['ド', 'レ', 'ミ', 'ファ', 'ソ', 'ラ', 'シ', 'ド'];
            const baseFreqs = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25];
            
            // セッション番号をシードとして使用して一貫したデータを生成
            let seed = sessionData.session * 1000;
            
            return noteNames.map((noteName, index) => {
                // シード基づく擬似ランダム生成で一貫した結果を保証
                const baseError = sessionData.averageCentError;
                const variation = (seededRandom(seed + index * 10) - 0.5) * 0.8 * baseError;
                const sign = seededRandom(seed + index * 10 + 5) > 0.5 ? 1 : -1;
                const absError = Math.max(1, Math.abs(baseError + variation));
                const centError = Math.round(absError * sign);
                
                const targetFreq = baseFreqs[index];
                const userFreq = targetFreq * Math.pow(2, centError / 1200);
                
                return {
                    noteIndex: index,
                    noteName: noteName,
                    targetFrequency: targetFreq,
                    userFrequency: userFreq,
                    centError: centError,
                    isCorrect: Math.abs(centError) <= 50
                };
            });
        }

        let selectedSessionForAnalysis = 1;
        
        // Chart.jsアニメーション制御フラグ
        let errorTrendChartAnimated = false;
        let accuracyChartAnimated = false;
        
        // オブザーバー管理
        let errorTrendObserver = null;
        let accuracyObserver = null;

        // Get evaluation level and color (仕様書準拠)
        function getSessionEvaluationLabel(averageCentError) {
            if (averageCentError <= 15) return 'Excellent';      // ±15セント以内
            if (averageCentError <= 25) return 'Good';           // 15セント超～25セント以内  
            if (averageCentError <= 40) return 'Pass';           // 25セント超～40セント以内
            return 'Practice';                                   // 41セント以上
        }

        function getSessionEvaluationColor(label) {
            switch (label) {
                case 'Excellent': return 'gradient-warning';
                case 'Good': return 'gradient-success'; 
                case 'Pass': return 'gradient-blue';
                default: return 'gradient-error';
            }
        }

        function getGlassBackground(label, isSelected = false) {
            const opacity1 = isSelected ? 0.6 : 0.45;
            const opacity2 = isSelected ? 0.8 : 0.65;
            
            switch (label) {
                case 'Excellent': return `rgba(251, 191, 36, ${opacity1}), rgba(245, 158, 11, ${opacity2})`; // 黄色系
                case 'Good': return `rgba(74, 222, 128, ${opacity1}), rgba(34, 197, 94, ${opacity2})`; // 緑色系
                case 'Pass': return `rgba(59, 130, 246, ${opacity1}), rgba(29, 78, 216, ${opacity2})`; // 青色系
                case 'Practice': return `rgba(239, 68, 68, ${opacity1}), rgba(220, 38, 38, ${opacity2})`; // 赤色系
                default: return `rgba(255, 255, 255, ${opacity1 * 0.8}), rgba(255, 255, 255, ${opacity2 * 0.8})`;
            }
        }

        function getEvaluationIcon(label, colorClass = 'text-white', size = 24) {
            // Lucideアイコンを使用（直感的なアイコン配置）
            switch (label) {
                case 'Excellent': return lucideIcon('trophy', colorClass, size);     // ±15セント以内 - トロフィー
                case 'Good': return lucideIcon('star', colorClass, size);            // 15～25セント - 星  
                case 'Pass': return lucideIcon('thumbs-up', colorClass, size);       // 25～40セント - 親指UP
                case 'Practice': return lucideIcon('triangle-alert', colorClass, size); // 41セント以上 - 三角警告
                default: return lucideIcon('alert-circle', colorClass, size);        // フォールバック
            }
        }

        // Initialize sessions grid
        function initializeSessionsGrid() {
            const grid = document.getElementById('sessions-grid');
            grid.innerHTML = '';

            mockSessionsData.forEach((session) => {
                const label = getSessionEvaluationLabel(session.averageCentError);
                const colorClass = getSessionEvaluationColor(label);
                
                // アイコン用の色クラスを設定
                let iconColorClass = 'text-white';
                switch (label) {
                    case 'Excellent': iconColorClass = 'text-yellow-200'; break;
                    case 'Good': iconColorClass = 'text-green-200'; break;
                    case 'Pass': iconColorClass = 'text-blue-200'; break;
                    case 'Practice': iconColorClass = 'text-red-200'; break;
                }
                
                const icon = getEvaluationIcon(label, iconColorClass, 24); // 12セッション概要は24px
                

                const sessionElement = document.createElement('div');
                sessionElement.className = `aspect-square rounded-lg cursor-pointer transition-all hover-scale active:scale-95 flex flex-col items-center justify-center text-center relative ${
                    selectedSessionForAnalysis === session.session ? 'scale-105' : ''
                }`;
                
                // 選択時の枠線をオーバーレイ効果付きで追加
                if (selectedSessionForAnalysis === session.session) {
                    sessionElement.style.boxShadow = '0 0 0 2px rgba(255, 255, 255, 0.6), 0 4px 6px rgba(0, 0, 0, 0.1)';
                    sessionElement.style.position = 'relative';
                } else {
                    sessionElement.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                }
                
                // 背景とコンテンツを分離
                const isSelected = selectedSessionForAnalysis === session.session;
                sessionElement.style.position = 'relative';
                
                // 文字色を各ボタンの色に合わせて設定
                let textColor = 'text-white';
                switch (label) {
                    case 'Excellent': textColor = 'text-yellow-200'; break;
                    case 'Good': textColor = 'text-green-200'; break;
                    case 'Pass': textColor = 'text-blue-200'; break;
                    case 'Practice': textColor = 'text-red-200'; break;
                }
                
                sessionElement.innerHTML = `
                    <div class="absolute inset-0 rounded-lg" style="
                        opacity: ${isSelected ? '1' : '0.7'};
                        background: linear-gradient(135deg, ${getGlassBackground(label, isSelected)});
                        backdrop-filter: blur(8px);
                        -webkit-backdrop-filter: blur(8px);
                        -moz-backdrop-filter: blur(8px);
                        border: 1px solid rgba(255, 255, 255, ${isSelected ? '0.4' : '0.3'});
                        border-radius: 12px;
                        will-change: transform, opacity;
                        -webkit-transform: translateZ(0);
                        transform: translateZ(0);
                        -webkit-backface-visibility: hidden;
                        backface-visibility: hidden;
                        -webkit-perspective: 1000px;
                        perspective: 1000px;
                    "></div>
                    <div class="relative z-10 flex flex-col items-center justify-center h-full" style="
                        opacity: 1;
                        will-change: transform;
                        -webkit-transform: translateZ(0);
                        transform: translateZ(0);
                        -webkit-backface-visibility: hidden;
                        backface-visibility: hidden;
                        pointer-events: none;
                    ">
                        <div class="${textColor} font-bold text-sm mb-1" style="
                            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
                            filter: brightness(1.2);
                            -webkit-font-smoothing: antialiased;
                            -moz-osx-font-smoothing: grayscale;
                        ">${session.session}</div>
                        <div class="mb-1" style="
                            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.8)) brightness(1.2);
                            -webkit-backface-visibility: hidden;
                            backface-visibility: hidden;
                        ">${icon}</div>
                    </div>
                `;

                // ホバー効果 - 背景のみの透明度変化
                sessionElement.addEventListener('mouseenter', () => {
                    if (selectedSessionForAnalysis !== session.session) {
                        const bgElement = sessionElement.querySelector('.absolute.inset-0');
                        if (bgElement) {
                            bgElement.style.opacity = '1';
                        }
                        sessionElement.style.transform = 'scale(1.05)';
                    }
                });
                
                sessionElement.addEventListener('mouseleave', () => {
                    if (selectedSessionForAnalysis !== session.session) {
                        const bgElement = sessionElement.querySelector('.absolute.inset-0');
                        if (bgElement) {
                            bgElement.style.opacity = '0.7';
                        }
                        sessionElement.style.transform = 'scale(1)';
                    }
                });
                
                sessionElement.addEventListener('click', () => {
                    selectedSessionForAnalysis = session.session;
                    updateSelectedSession();
                    initializeSessionsGrid(); // Refresh to update selection
                });

                grid.appendChild(sessionElement);
            });
        }

        // Update selected session details
        function updateSelectedSession() {
            const selectedSession = mockSessionsData.find(s => s.session === selectedSessionForAnalysis);
            if (!selectedSession) return;

            document.getElementById('selected-session').textContent = selectedSession.session;

            // セッションの評価ラベルを取得
            const label = getSessionEvaluationLabel(selectedSession.averageCentError);

            // Update session info - 1行中央寄せレイアウト
            const sessionInfo = document.getElementById('session-info');
            
            // アイコンの色クラスを設定
            let iconColorClass = 'text-white';
            switch (label) {
                case 'Excellent': iconColorClass = 'text-yellow-300'; break;
                case 'Good': iconColorClass = 'text-green-300'; break;
                case 'Pass': iconColorClass = 'text-blue-300'; break;
                case 'Practice': iconColorClass = 'text-red-300'; break;
            }
            
            // 画面サイズに応じてアイコンサイズを動的に決定
            const isDesktop = window.innerWidth >= 768;
            const iconSize = isDesktop ? 80 : 32; // PC版80px、モバイル版32px
            const largeIcon = getEvaluationIcon(label, iconColorClass, iconSize);
            
            sessionInfo.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem; align-items: end; min-height: 80px;">
                    <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: center; height: 100%;">
                        <div class="text-2xl md:text-4xl font-bold text-white">${selectedSession.baseNote}</div>
                        <p class="text-xs md:text-base text-green-200">基音</p>
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: flex-end; align-items: center; text-align: center; height: 100%;">
                        <div class="mb-2">${largeIcon}</div>
                        <p class="text-base md:text-lg font-bold ${iconColorClass}">${label}</p>
                    </div>
                    <div style="display: flex; flex-direction: column; justify-content: flex-end; text-align: center; height: 100%;">
                        <div class="text-2xl md:text-4xl font-bold text-white">${
                            // データの正負に基づいて表示を調整
                            (() => {
                                const seed = selectedSession.session * 1234;
                                const isPositive = (Math.sin(seed) > 0);
                                return isPositive ? `+${selectedSession.averageCentError}` : `-${selectedSession.averageCentError}`;
                            })()
                        }</div>
                        <p class="text-xs md:text-base text-green-200">セッション平均誤差</p>
                    </div>
                </div>
            `;

            // Update note results
            const noteResults = document.getElementById('note-results');
            noteResults.innerHTML = '';

            const sessionNoteResults = generateSessionNoteResults(selectedSession);
            sessionNoteResults.forEach((note, index) => {
                const getEvaluationLevel = (centError) => {
                    const absError = Math.abs(centError);
                    // 直感的なアイコン配置で統一評価基準（アイコンサイズを20pxに拡大）
                    if (absError <= 15) return { level: 'excellent', color: 'text-yellow-300', label: 'Excellent', icon: lucideIcon('trophy', 'text-yellow-300', 20) };
                    if (absError <= 25) return { level: 'good', color: 'text-green-300', label: 'Good', icon: lucideIcon('star', 'text-green-300', 20) };
                    if (absError <= 40) return { level: 'pass', color: 'text-blue-300', label: 'Pass', icon: lucideIcon('thumbs-up', 'text-blue-300', 20) };
                    return { level: 'practice', color: 'text-red-300', label: 'Practice', icon: lucideIcon('triangle-alert', 'text-red-300', 20) };
                };

                const evaluation = getEvaluationLevel(note.centError);

                const noteElement = document.createElement('div');
                noteElement.className = 'glass-card-sm hover:bg-white/10 transition-colors';
                noteElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center text-xs font-bold text-white">
                                ${note.noteIndex + 1}
                            </span>
                            <div>
                                <div class="flex items-center space-x-2">
                                    <span class="text-white font-medium">${note.noteName}</span>
                                    <span class="font-bold ${note.centError > 0 ? 'text-red-300' : 'text-blue-300'}">
                                        ${note.centError > 0 ? '+' : ''}${note.centError}¢
                                    </span>
                                </div>
                                <div class="text-xs text-white-60">
                                    ${note.targetFrequency.toFixed(0)}Hz → ${note.userFrequency.toFixed(0)}Hz
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-center justify-center" style="min-width: 60px;">
                            ${evaluation.icon}
                            <span class="text-xs font-medium ${evaluation.color} mt-2 text-center">${evaluation.label}</span>
                        </div>
                    </div>
                `;

                noteResults.appendChild(noteElement);
            });
            
            // 詳細分析のアイコンを再初期化
            setTimeout(() => {
                initializeLucideIcons();
            }, 50);
        }


        // Initialize overall statistics
        function initializeOverallStats() {
            const overallStats = document.getElementById('overall-stats');
            
            // Calculate overall statistics
            const totalSessions = mockSessionsData.length;
            const completedSessions = totalSessions; // All sessions completed
            
            // Calculate average error across all sessions (絶対値の平均)
            const totalError = mockSessionsData.reduce((sum, session) => sum + session.averageCentError, 0);
            const averageError = Math.round(totalError / totalSessions * 10) / 10;
            
            // Find maximum error (絶対値の最大)
            const maxError = Math.max(...mockSessionsData.map(session => session.averageCentError));
            
            // Calculate overall grade based on average error
            let overallGrade;
            if (averageError <= 15) overallGrade = 'S';
            else if (averageError <= 20) overallGrade = 'A';
            else if (averageError <= 25) overallGrade = 'B';
            else if (averageError <= 35) overallGrade = 'C';
            else overallGrade = 'D';
            
            overallStats.innerHTML = `
                <div class="text-center">
                    <div class="text-4xl font-bold text-white mb-2">${overallGrade}</div>
                    <p class="text-green-200">総合グレード</p>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold text-white mb-2 stat-value" data-value="${averageError}">±0.0</div>
                    <p class="text-green-200">平均誤差（セント）</p>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold text-white mb-2 stat-value" data-value="${maxError}">±0.0</div>
                    <p class="text-green-200">最大誤差（セント）</p>
                </div>
                <div class="text-center">
                    <div class="text-4xl font-bold text-white mb-2 stat-value" data-value="${totalSessions}">0</div>
                    <p class="text-green-200">セッション数</p>
                </div>
            `;
        }

        // グラス効果用のグラデーションを作成（グローバル関数）
        function createGlassGradient(ctx, color, chartType = 'mobile') {
            // 固定幅でグラデーションを作成して安定性を確保
            let gradient;
            if (chartType === 'mobile') {
                // モバイル版: 横向きグラデーション（固定幅200px）
                gradient = ctx.createLinearGradient(0, 0, 200, 0);
            } else {
                // PC版: 縦向きグラデーション（固定高さ200px）で統一
                gradient = ctx.createLinearGradient(0, 0, 0, 200);
            }
            
            // 元の色をRGBに変換してアルファ値を調整
            let r, g, b;
            if (color === '#fbbf24') { r = 251; g = 191; b = 36; } // Excellent - 黄色
            else if (color === '#22c55e') { r = 34; g = 197; b = 94; } // Good - 緑
            else if (color === '#3b82f6') { r = 59; g = 130; b = 246; } // Pass - 青
            else { r = 239; g = 68; b = 68; } // Practice - 赤
            
            // グラス効果: 均等なグラデーションで安定性を確保（終点を明るく調整）
            gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.9)`); // 開始点（明るい）
            gradient.addColorStop(0.3, `rgba(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)}, 0.8)`); // 明るい部分
            gradient.addColorStop(0.7, `rgba(${r}, ${g}, ${b}, 0.7)`); // 中央
            gradient.addColorStop(1, `rgba(${Math.max(0, r - 10)}, ${Math.max(0, g - 10)}, ${Math.max(0, b - 10)}, 0.75)`); // 終点（明るく調整）
            
            return gradient;
        }

        // Initialize error trend chart with Chart.js (PC: Line Chart, Mobile: Stacked Bar Chart)
        function initializeErrorTrendChart() {
            const ctx = document.getElementById('error-trend-chart');
            if (!ctx) {
                console.error('Error trend chart canvas not found');
                return;
            }
            
            console.log('🎯 Initializing error trend chart, animated:', errorTrendChartAnimated);
            
            // レスポンシブ設定: デバイス判定
            const isMobile = window.innerWidth < 768;
            const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024; // iPad対応
            
            // グラフの説明を動的に設定
            const descriptionElement = document.getElementById('chart-description');
            if (descriptionElement) {
                if (isMobile) {
                    // モバイル版（横向きバーチャート）の説明
                    descriptionElement.innerHTML = `
                        <div class="font-semibold text-white-70">【グラフの見方】</div>
                        <div class="mt-1">縦軸: セッション番号（S1～S12） / 横軸: 平均誤差（セント）</div>
                        <div>プラス(+) = 音が高い / マイナス(-) = 音が低い</div>
                        <div class="mt-1">0に近いほど正確な音程です</div>
                    `;
                } else {
                    // PC版・iPad版（ラインチャート）の説明
                    descriptionElement.innerHTML = `
                        <div class="font-semibold text-white-70">【グラフの見方】</div>
                        <div class="mt-1">横軸: セッション別8音 / 縦軸: 誤差（セント）</div>
                        <div>プラス(+) = 音が高い / マイナス(-) = 音が低い</div>
                        <div class="mt-1">0に近いほど正確な音程です</div>
                    `;
                }
            }
            
            // 既存のチャートインスタンスを破棄
            if (window.errorTrendChartInstance) {
                window.errorTrendChartInstance.destroy();
            }
            
            if (isMobile) {
                // モバイル版: Stacked Bar Chart（アニメーション制御付き）
                initializeMobileStackedBarChart(ctx);
            } else {
                // PC版・iPad版: Line Chart（iPad版はアニメーション無効）
                initializePCLineChart(ctx, isTablet);
            }
        }
        
        // PC版: Line Chart実装
        function initializePCLineChart(ctx, isTabletDevice = false) {
            // X軸ラベル: セッション1の8音、セッション2の8音...という形式
            const noteNames = ['ド', 'レ', 'ミ', 'ファ', 'ソ', 'ラ', 'シ', 'ド\''];
            const labels = [];
            const allData = [];
            const colors = [];
            
            // 全96音のデータを準備（セッション順×音順）
            mockSessionsData.forEach((session, sessionIndex) => {
                const sessionNoteResults = generateSessionNoteResults(session);
                const evaluation = getSessionEvaluationLabel(session.averageCentError);
                
                // 評価レベルに基づく色
                let pointColor;
                switch (evaluation) {
                    case 'Excellent': pointColor = '#fbbf24'; break; // 黄色
                    case 'Good': pointColor = '#22c55e'; break;      // 緑色
                    case 'Pass': pointColor = '#3b82f6'; break;      // 青色
                    default: pointColor = '#ef4444';                 // 赤色
                }
                
                // 各音のデータとラベルを追加
                sessionNoteResults.forEach((note, noteIndex) => {
                    labels.push(`S${session.session}-${noteNames[noteIndex]}`);
                    allData.push(note.centError);
                    colors.push(pointColor);
                });
            });
            
            // データの最大値・最小値を計算
            const maxValue = Math.max(...allData);
            const minValue = Math.min(...allData);
            const maxAbsValue = Math.max(Math.abs(maxValue), Math.abs(minValue));
            
            // 1つのデータセットで全96音を表示
            const dataset = {
                label: '音程誤差',
                data: allData,
                borderColor: 'rgba(255, 255, 255, 0.6)', // 透明度60%
                backgroundColor: colors,
                pointBackgroundColor: colors,
                pointBorderColor: 'rgba(255, 255, 255, 0.6)', // 透明度60%
                pointBorderWidth: 1,
                pointRadius: 4,
                pointHoverRadius: 6,
                tension: 0.1,
                fill: false,
                segment: {
                    borderColor: function(ctx) {
                        // セグメントの色を次のポイントの色に合わせて透明度60%適用
                        const nextIndex = ctx.p1DataIndex;
                        const baseColor = colors[nextIndex] || '#ffffff';
                        
                        // カラーコードをRGBAに変換して透明度60%適用
                        if (baseColor === '#fbbf24') return 'rgba(251, 191, 36, 0.6)';
                        else if (baseColor === '#22c55e') return 'rgba(34, 197, 94, 0.6)';
                        else if (baseColor === '#3b82f6') return 'rgba(59, 130, 246, 0.6)';
                        else if (baseColor === '#ef4444') return 'rgba(239, 68, 68, 0.6)';
                        else return 'rgba(255, 255, 255, 0.6)';
                    }
                }
            };
            
            window.errorTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [dataset]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: errorTrendChartAnimated ? false : {
                        duration: 800,
                        onComplete: () => {
                            console.log('✅ Error trend chart animation completed (PC Line)');
                            errorTrendChartAnimated = true;
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (tooltipItems.length > 0) {
                                        const dataIndex = tooltipItems[0].dataIndex;
                                        return labels[dataIndex];
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    const dataIndex = context.dataIndex;
                                    const sessionIndex = Math.floor(dataIndex / 8);
                                    const noteIndex = dataIndex % 8;
                                    const session = mockSessionsData[sessionIndex];
                                    const evaluation = getSessionEvaluationLabel(session.averageCentError);
                                    const centValue = context.parsed.y;
                                    const centDisplay = centValue >= 0 ? `+${centValue}` : `${centValue}`;
                                    return `基音${session.baseNote}: ${centDisplay}セント (${evaluation})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: function(context) {
                                    // セッション境界（8の倍数）で線を太く
                                    if (context.tick && context.tick.value % 8 === 0) {
                                        return 'rgba(255, 255, 255, 0.3)';
                                    }
                                    return 'rgba(255, 255, 255, 0.1)';
                                },
                                lineWidth: function(context) {
                                    if (context.tick && context.tick.value % 8 === 0) {
                                        return 2;
                                    }
                                    return 1;
                                }
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: {
                                    size: 9
                                },
                                maxRotation: 45,
                                callback: function(value, index) {
                                    // セッション境界のみ表示
                                    if (index % 8 === 0) {
                                        const sessionNum = Math.floor(index / 8) + 1;
                                        return `セッション${sessionNum}`;
                                    }
                                    return '';
                                }
                            }
                        },
                        y: {
                            display: true,
                            position: 'left',
                            min: -maxAbsValue - 10, // 実データの最大絶対値 + マージン
                            max: maxAbsValue + 10,  // 実データの最大絶対値 + マージン
                            grid: {
                                color: (context) => {
                                    if (context.tick && context.tick.value === 0) {
                                        return 'rgba(255, 255, 255, 0.5)';
                                    }
                                    return 'rgba(255, 255, 255, 0.1)';
                                },
                                lineWidth: (context) => {
                                    if (context.tick && context.tick.value === 0) {
                                        return 2;
                                    }
                                    return 1;
                                },
                                drawOnChartArea: true,
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    if (value === 0) {
                                        return '0¢';
                                    } else if (value > 0) {
                                        return `+${value}¢`;
                                    } else {
                                        return `${value}¢`;
                                    }
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });
        }
        
        // モバイル版: 横向きバーチャート実装（セッション別）
        function initializeMobileStackedBarChart(ctx) {
            // コンテナの幅を制限
            const container = document.getElementById('error-trend-container');
            if (container) {
                const viewportWidth = window.innerWidth;
                const maxWidth = Math.min(viewportWidth - 48, 350); // 最大350pxに制限
                container.style.width = `${maxWidth}px`;
                container.style.maxWidth = '100%';
            }
            
            const labels = [];
            const data = [];
            const backgroundColors = [];
            
            // 各セッションのデータを準備
            mockSessionsData.forEach((session) => {
                labels.push(`S${session.session}`);
                data.push(session.averageCentError);
                
                // 評価レベルに基づく色
                const evaluation = getSessionEvaluationLabel(session.averageCentError);
                let barColor;
                switch (evaluation) {
                    case 'Excellent': barColor = '#fbbf24'; break;
                    case 'Good': barColor = '#22c55e'; break;
                    case 'Pass': barColor = '#3b82f6'; break;
                    default: barColor = '#ef4444';
                }
                backgroundColors.push(barColor);
            });
            
            
            // グラフの最大値を計算
            const maxValue = Math.max(...data);
            
            window.errorTrendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '平均誤差',
                        data: data,
                        backgroundColor: function(context) {
                            if (context.parsed !== undefined) {
                                const index = context.dataIndex;
                                const baseColor = backgroundColors[index];
                                return createGlassGradient(context.chart.ctx, baseColor, 'mobile');
                            }
                            return backgroundColors;
                        },
                        borderColor: 'rgba(255, 255, 255, 0.3)', // 薄い白ボーダーでグラス効果を強化
                        borderWidth: 1,
                        borderRadius: 8, // バーを角丸に
                        borderSkipped: false, // 全ての角を丸くする
                        barPercentage: 0.7,  // バーの高さを70%に
                        categoryPercentage: 0.9  // カテゴリ間隔を90%に
                    }]
                },
                options: {
                    indexAxis: 'y', // 横向きバーチャート
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: errorTrendChartAnimated ? false : {
                        duration: 1000,
                        onComplete: () => {
                            console.log('✅ Error trend chart animation completed (Mobile Bar)');
                            errorTrendChartAnimated = true;
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 0,
                            top: 0,
                            bottom: 0
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            callbacks: {
                                title: function(tooltipItems) {
                                    if (tooltipItems.length > 0) {
                                        const index = tooltipItems[0].dataIndex;
                                        const session = mockSessionsData[index];
                                        return `セッション${session.session}`;
                                    }
                                    return '';
                                },
                                label: function(context) {
                                    const index = context.dataIndex;
                                    const session = mockSessionsData[index];
                                    const evaluation = getSessionEvaluationLabel(session.averageCentError);
                                    return [
                                        `基音: ${session.baseNote}`,
                                        `誤差: ±${context.parsed.x}セント`,
                                        `評価: ${evaluation}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: true,  // グリッド線を表示
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: true,
                                borderColor: 'rgba(255, 255, 255, 0.2)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: {
                                    size: 10
                                },
                                stepSize: 10,
                                callback: function(value) {
                                    // 10の倍数のみ表示
                                    if (value % 10 === 0) {
                                        return value;
                                    }
                                    return '';
                                }
                            },
                            suggestedMax: maxValue + 5,
                            min: 0
                        },
                        y: {
                            grid: {
                                display: true,  // グリッド線を表示
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: true,
                                borderColor: 'rgba(255, 255, 255, 0.2)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 10  // フォントサイズを10pxに統一
                                },
                                padding: 3,
                                autoSkip: false  // ラベルを省略しない
                            }
                        }
                    }
                }
            });
        }

        // Initialize accuracy chart (evaluation distribution) with Chart.js
        function initializeAccuracyChart() {
            const ctx = document.getElementById('accuracy-chart');
            if (!ctx) {
                console.error('Accuracy chart canvas not found');
                return;
            }
            
            console.log('📈 Initializing accuracy chart, animated:', accuracyChartAnimated);
            
            // 既存のチャートインスタンスを破棄
            if (window.accuracyChartInstance) {
                window.accuracyChartInstance.destroy();
            }
            
            // 評価レベル別にセッション数をカウント
            const evaluationCounts = {
                'Excellent': 0,
                'Good': 0,
                'Pass': 0,
                'Practice': 0
            };
            
            mockSessionsData.forEach(session => {
                const label = getSessionEvaluationLabel(session.averageCentError);
                evaluationCounts[label]++;
            });
            
            
            const labels = ['Excellent', 'Good', 'Pass', 'Practice'];
            const data = [
                evaluationCounts['Excellent'],
                evaluationCounts['Good'],
                evaluationCounts['Pass'],
                evaluationCounts['Practice']
            ];
            const backgroundColors = ['#fbbf24', '#22c55e', '#3b82f6', '#ef4444'];
            
            window.accuracyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'セッション数',
                        data: data,
                        backgroundColor: function(context) {
                            if (context.parsed !== undefined) {
                                const index = context.dataIndex;
                                const baseColor = backgroundColors[index];
                                return createGlassGradient(context.chart.ctx, baseColor, 'mobile');
                            }
                            return backgroundColors;
                        },
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false,
                        barPercentage: 0.7,
                        categoryPercentage: 0.9
                    }]
                },
                options: {
                    indexAxis: 'y', // 横向きバーチャート
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: accuracyChartAnimated ? false : {
                        duration: 1000,
                        onComplete: () => {
                            console.log('✅ Accuracy chart animation completed');
                            accuracyChartAnimated = true;
                        }
                    },
                    layout: {
                        padding: {
                            left: 0,
                            right: 0,
                            top: 0,
                            bottom: 0
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // 凡例を非表示（ラベルで十分）
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const total = mockSessionsData.length;
                                    const value = context.parsed.x;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value}セッション (${percentage}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: true,
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: true,
                                borderColor: 'rgba(255, 255, 255, 0.2)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)',
                                font: {
                                    size: 14
                                },
                                stepSize: 1,
                                callback: function(value) {
                                    return Math.floor(value) === value ? value : '';
                                }
                            },
                            min: 0
                        },
                        y: {
                            grid: {
                                display: true,
                                color: 'rgba(255, 255, 255, 0.05)',
                                drawBorder: true,
                                borderColor: 'rgba(255, 255, 255, 0.2)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 14
                                },
                                padding: 3,
                                autoSkip: false
                            }
                        }
                    }
                }
            });
        }

        // セッションナビゲーション機能
        function navigateToSession(direction) {
            const totalSessions = mockSessionsData.length;
            
            if (direction === 'prev') {
                selectedSessionForAnalysis = selectedSessionForAnalysis > 1 
                    ? selectedSessionForAnalysis - 1 
                    : totalSessions; // 最初から最後へループ
            } else if (direction === 'next') {
                selectedSessionForAnalysis = selectedSessionForAnalysis < totalSessions 
                    ? selectedSessionForAnalysis + 1 
                    : 1; // 最後から最初へループ
            }
            
            updateSelectedSession();
            initializeSessionsGrid(); // グリッドの選択状態も更新
        }

        // グローバルフラグでイベントリスナーの重複登録を防ぐ
        let navigationEventListenersAdded = false;
        
        // グラフセクションの表示監視
        function observeChartsSection() {
            // 誤差推移チャートのコンテナを直接監視
            const errorTrendContainer = document.getElementById('error-trend-container');
            
            // 評価分布チャートの親要素を直接監視
            const accuracyChart = document.getElementById('accuracy-chart');
            const accuracyContainer = accuracyChart ? accuracyChart.parentElement : null;
            
            console.log('📊 Charts setup:', {
                errorTrendContainer: !!errorTrendContainer,
                accuracyContainer: !!accuracyContainer,
                errorTrendAnimated: errorTrendChartAnimated,
                accuracyAnimated: accuracyChartAnimated
            });
            
            if (!errorTrendContainer && !accuracyContainer) {
                // チャートコンテナが見つからない場合は即座にチャートを初期化
                console.log('⚠️ No chart containers found, initializing immediately');
                initializeErrorTrendChart();
                initializeAccuracyChart();
                return;
            }
            
            // 既存のオブザーバーをクリーンアップ
            if (errorTrendObserver) {
                errorTrendObserver.disconnect();
                errorTrendObserver = null;
            }
            if (accuracyObserver) {
                accuracyObserver.disconnect();
                accuracyObserver = null;
            }
            
            // 誤差推移チャート用のオブザーバー（まだアニメーション済みでない場合のみ）
            if (errorTrendContainer && !errorTrendChartAnimated) {
                errorTrendObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !errorTrendChartAnimated) {
                            console.log('🎯 Error trend chart visible, initializing...');
                            initializeErrorTrendChart();
                            errorTrendObserver.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.2,
                    rootMargin: '0px 0px -10% 0px'
                });
                
                errorTrendObserver.observe(errorTrendContainer);
            }
            
            // 評価分布チャート用のオブザーバー（まだアニメーション済みでない場合のみ）
            if (accuracyContainer && !accuracyChartAnimated) {
                accuracyObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting && !accuracyChartAnimated) {
                            console.log('📈 Accuracy chart visible, initializing...');
                            initializeAccuracyChart();
                            accuracyObserver.unobserve(entry.target);
                        }
                    });
                }, {
                    threshold: 0.2,
                    rootMargin: '0px 0px -10% 0px'
                });
                
                accuracyObserver.observe(accuracyContainer);
            }
        }

        // Initialize page
        function initializePage() {
            initializeOverallStats();
            initializeSessionsGrid();
            updateSelectedSession();
            
            // グラフセクションの表示監視を開始
            observeChartsSection();
            
            // セッショングリッド生成後にアイコンを再初期化
            setTimeout(() => {
                initializeLucideIcons();
            }, 100);
            
            // イベントリスナーは初回のみ設定
            if (!navigationEventListenersAdded) {
                // ナビゲーションボタンのイベントリスナーを設定
                const prevBtn = document.getElementById('prev-session-btn');
                const nextBtn = document.getElementById('next-session-btn');
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => navigateToSession('prev'));
                }
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => navigateToSession('next'));
                }
                
                // キーボードショートカット（左右矢印キー）
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') {
                        navigateToSession('prev');
                    } else if (e.key === 'ArrowRight') {
                        navigateToSession('next');
                    }
                });
                
                navigationEventListenersAdded = true;
            }
        }

        // ウィンドウリサイズ時の再描画対応
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                // リサイズ時はアニメーション状態を保持して再初期化
                console.log('🔄 Resize detected, reinitializing charts with animation state preserved');
                
                // 既にアニメーション済みの場合は強制的にアニメーション無効で再初期化
                if (errorTrendChartAnimated) {
                    initializeErrorTrendChart();
                }
                if (accuracyChartAnimated) {
                    initializeAccuracyChart();
                }
                
                // まだアニメーションしていない場合は監視を継続
                if (!errorTrendChartAnimated || !accuracyChartAnimated) {
                    observeChartsSection();
                }
            }, 250);
        });

        // Initialize Lucide icons - simple version like final-result.html
        function initializeLucideIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                console.log('✅ [RESULTS] Lucide icons initialized');
            } else {
                console.error('❌ [RESULTS] Lucide library not loaded');
            }
        }
        
        // Helper function to create Lucide icons for standard system
        function lucideIcon(iconName, colorClass = '', size = 24) {
            return `<i data-lucide="${iconName}" class="${colorClass}" style="width: ${size}px; height: ${size}px;"></i>`;
        }
        
        // カウントアップアニメーション関数
        function animateCountUp(element, targetValue, duration = 1000, isDecimal = false) {
            const startTime = performance.now();
            const startValue = 0;
            
            function updateValue(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // イージング関数（ease-out-cubic）
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = startValue + (targetValue - startValue) * easedProgress;
                
                if (isDecimal) {
                    element.textContent = currentValue.toFixed(1);
                } else {
                    element.textContent = Math.round(currentValue);
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateValue);
                } else {
                    // 最終値を確実に設定
                    if (isDecimal) {
                        element.textContent = targetValue.toFixed(1);
                    } else {
                        element.textContent = targetValue;
                    }
                }
            }
            
            requestAnimationFrame(updateValue);
        }
        
        // 統計情報のアニメーション
        function animateStatistics() {
            // Overall Statisticsの数値をアニメーション
            setTimeout(() => {
                const statElements = document.querySelectorAll('#overall-stats .stat-value');
                console.log('Found stat elements:', statElements.length);
                
                statElements.forEach((element, index) => {
                    const dataValue = element.getAttribute('data-value');
                    const value = parseFloat(dataValue);
                    console.log(`Element ${index}: data-value="${dataValue}", value=${value}`);
                    
                    if (!isNaN(value)) {
                        const isDecimal = dataValue.includes('.');
                        const hasPrefix = element.textContent.includes('±');
                        
                        // 一旦0に設定
                        if (hasPrefix) {
                            element.textContent = isDecimal ? '±0.0¢' : '±0¢';
                        } else {
                            element.textContent = isDecimal ? '0.0' : '0';
                        }
                        
                        setTimeout(() => {
                            animateCountUp({
                                textContent: '',
                                set textContent(val) {
                                    if (hasPrefix) {
                                        element.textContent = '±' + val + '¢';
                                    } else {
                                        element.textContent = val;
                                    }
                                }
                            }, value, 1200, isDecimal);
                        }, index * 150);
                    } else if (dataValue && isNaN(value)) {
                        // 文字（グレードなど）の場合は遅延表示
                        element.textContent = '';
                        setTimeout(() => {
                            element.textContent = dataValue;
                        }, index * 150 + 600);
                    }
                });
            }, 100);
            
            // 総合評価点数のアニメーション（S級の横の数字）
            const gradeScore = document.querySelector('#overall-grade');
            if (gradeScore && gradeScore.textContent.includes('級')) {
                // もし点数が表示されている場合はそれもアニメーション
                const scoreMatch = gradeScore.textContent.match(/(\d+\.?\d*)/);
                if (scoreMatch) {
                    const score = parseFloat(scoreMatch[1]);
                    const gradeText = gradeScore.textContent.replace(scoreMatch[0], '');
                    gradeScore.textContent = '0' + gradeText;
                    setTimeout(() => {
                        animateCountUp({
                            textContent: '',
                            set textContent(val) {
                                gradeScore.textContent = val + gradeText;
                            }
                        }, score, 1500, true);
                    }, 300);
                }
            }
        }
        
        // Multiple initialization triggers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 [RESULTS] DOM Content Loaded - starting icon initialization');
            initializeLucideIcons();
            
        });
        
        window.addEventListener('load', function() {
            console.log('🌍 [RESULTS] Window loaded - ensuring icons are initialized');
            initializeLucideIcons();
            
            // 統計データが生成されるまで待ってからアニメーション開始
            setTimeout(() => {
                // 再度統計データを初期化してからアニメーション
                initializeOverallStats();
                
                
                setTimeout(() => {
                    animateStatistics();
                    updateShareMessage();  // シェアメッセージも更新
                    animateRankSection();  // ランクセクションのアニメーション
                }, 100);
            }, 1200);
        });

        // SNSシェア機能
        function getShareText() {
            const gradeElement = document.querySelector('#overall-stats > div:first-child .text-4xl');
            const grade = gradeElement ? gradeElement.textContent : 'B';
            const errorElement = document.querySelector('#overall-stats > div:nth-child(2) .text-4xl');
            const error = errorElement ? errorElement.textContent : '±19.8';
            const sessionsElement = document.querySelector('#overall-stats > div:nth-child(4) .text-4xl');
            const sessions = sessionsElement ? sessionsElement.textContent : '12';
            
            return `🎵 8va相対音感トレーニングで【${grade}級】獲得！\n平均誤差: ${error}セント\n${sessions}セッション完走しました！\n\n#相対音感 #音感トレーニング #8va`;
        }
        
        function updateShareMessage() {
            const gradeElement = document.querySelector('#overall-stats > div:first-child .text-4xl');
            const grade = gradeElement ? gradeElement.textContent : 'B';
            const messageElement = document.getElementById('share-message');
            
            if (messageElement) {
                let message = '';
                switch(grade) {
                    case 'S':
                        message = 'S級ランク取得！パーフェクトマスター！';
                        break;
                    case 'A':
                        message = 'A級ランク取得！エクセレントプレイヤー！';
                        break;
                    case 'B':
                        message = 'B級ランク取得！グッドプレイヤー！';
                        break;
                    case 'C':
                        message = 'C級ランク取得！練習の成果が出ています！';
                        break;
                    case 'D':
                        message = 'D級ランク取得！もう少しで上達します！';
                        break;
                    default:
                        message = `${grade}級ランク取得！おめでとうございます！`;
                }
                messageElement.textContent = message;
            }
        }
        
        function shareToTwitter(event) {
            event.preventDefault();
            const text = encodeURIComponent(getShareText());
            const url = encodeURIComponent(window.location.href);
            window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=450');
        }
        
        function shareToLine(event) {
            event.preventDefault();
            const text = encodeURIComponent(getShareText() + '\n' + window.location.href);
            window.open(`https://social-plugins.line.me/lineit/share?text=${text}`, '_blank', 'width=550,height=450');
        }
        
        function shareToFacebook(event) {
            event.preventDefault();
            const url = encodeURIComponent(window.location.href);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=450');
        }
        
        function copyShareText(event) {
            event.preventDefault();
            const text = getShareText() + '\n' + window.location.href;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    // ボタンのテキストを一時的に変更
                    const btn = event.currentTarget;
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    `;
                    btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('コピーに失敗しました:', err);
                });
            } else {
                // 旧式のコピー方法
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
            }
        }
        
        // Rank section animation
        function animateRankSection() {
            const rankCircle = document.querySelector('.rank-circle');
            const gradeValue = document.querySelector('.grade-value');
            const sessionCount = document.querySelector('.session-count');
            const avgError = document.querySelector('.avg-error');
            const maxError = document.querySelector('.max-error');
            
            if (!rankCircle) return;
            
            // サークルのスケールアニメーション
            rankCircle.style.transform = 'scale(0)';
            rankCircle.style.transition = 'transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
            
            setTimeout(() => {
                rankCircle.style.transform = 'scale(1)';
            }, 300);
            
            // 統計値のカウントアップアニメーション
            setTimeout(() => {
                // 実際のデータ値を取得（Overall Statisticsから）
                const gradeElement = document.querySelector('#overall-stats > div:first-child .text-4xl');
                const grade = gradeElement ? gradeElement.textContent : 'B';
                
                const avgElement = document.querySelector('#overall-stats > div:nth-child(2) .stat-value');
                const avgValue = avgElement ? parseFloat(avgElement.getAttribute('data-value')) : 23.6;
                
                const maxElement = document.querySelector('#overall-stats > div:nth-child(3) .stat-value');
                const maxValue = maxElement ? parseFloat(maxElement.getAttribute('data-value')) : 48.7;
                
                const sessionsElement = document.querySelector('#overall-stats > div:nth-child(4) .stat-value');
                const sessionsValue = sessionsElement ? parseInt(sessionsElement.getAttribute('data-value')) : 12;
                
                // グレード表示（最初にアニメーション）
                if (gradeValue) {
                    animateGradeDisplay(gradeValue, grade);
                }
                
                // 平均誤差アニメーション（グレードと同じタイミング）
                if (avgError) {
                    animateCountUp({
                        textContent: '',
                        set textContent(val) { avgError.textContent = '±' + val + '¢'; }
                    }, avgValue, 1200, true);
                }
                
                // 最大誤差アニメーション
                if (maxError) {
                    setTimeout(() => {
                        animateCountUp({
                            textContent: '',
                            set textContent(val) { maxError.textContent = '±' + val + '¢'; }
                        }, maxValue, 1200, true);
                    }, 150);
                }
                
                // セッション数アニメーション
                if (sessionCount) {
                    setTimeout(() => {
                        animateCountUp({
                            textContent: '',
                            set textContent(val) { sessionCount.textContent = val; }
                        }, sessionsValue, 1000, false);
                    }, 300);
                }
            }, 800);
        }
        
        // グレード専用アニメーション関数
        function animateGradeDisplay(element, finalGrade) {
            const grades = ['E', 'D', 'C', 'B', 'A', 'S'];
            const finalIndex = grades.indexOf(finalGrade);
            
            if (finalIndex === -1) {
                element.textContent = finalGrade;
                return;
            }
            
            let currentIndex = 0;
            element.textContent = grades[currentIndex];
            
            const gradeInterval = setInterval(() => {
                currentIndex++;
                if (currentIndex <= finalIndex) {
                    element.textContent = grades[currentIndex];
                    
                    if (currentIndex === finalIndex) {
                        clearInterval(gradeInterval);
                        // 最終グレードに達したら少し強調
                        element.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            element.style.transform = 'scale(1)';
                        }, 200);
                    }
                } else {
                    clearInterval(gradeInterval);
                }
            }, 100); // 100msごとにグレードを上げる
        }
        
        // Start initialization
        initializePage();
    </script>
</body>
</html>