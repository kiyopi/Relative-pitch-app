<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸµ PitchPro v1.1.3ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ</title>
    
    <!-- UIã‚«ã‚¿ãƒ­ã‚°æº–æ‹ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <link rel="stylesheet" href="Bolt/v2/styles/results.css">
    <link rel="stylesheet" href="Bolt/v2/styles/training.css">
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- UIã‚«ã‚¿ãƒ­ã‚°æº–æ‹ ã®ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">PitchPro v1.1.3ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ãƒ†ã‚¹ãƒˆ</h1>
                    <p class="page-subtitle text-green-200">ãƒã‚¤ã‚¯ãƒ¬ãƒ™ãƒ«ä½ä¸‹ãƒã‚°ä¿®æ­£ + ã‚²ã‚¤ãƒ³ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  + Safariå®Œå…¨å¯¾å¿œ</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            
            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="activity" class="text-blue-300"></i>
                    <span>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</span>
                </h3>
                <div class="text-lg text-white-80 mt-4" id="system-status">
                    æº–å‚™ä¸­...
                </div>
            </div>

            <!-- åˆ¶å¾¡ãƒ‘ãƒãƒ« -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="settings" class="text-green-300"></i>
                    <span>åˆ¶å¾¡ãƒ‘ãƒãƒ«</span>
                </h3>
                <div class="flex gap-4 mt-4">
                    <button id="init-btn" class="btn btn-primary flex-1">
                        <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                        <span>ãƒã‚¤ã‚¯åˆæœŸåŒ–</span>
                    </button>
                    <button id="start-btn" class="btn btn-success flex-1" disabled>
                        <i data-lucide="play" style="width: 20px; height: 20px;"></i>
                        <span>æ¤œå‡ºé–‹å§‹</span>
                    </button>
                    <button id="stop-btn" class="btn btn-secondary flex-1" disabled>
                        <i data-lucide="stop-circle" style="width: 20px; height: 20px;"></i>
                        <span>æ¤œå‡ºåœæ­¢</span>
                    </button>
                </div>
            </div>

            <!-- éŸ³ç¨‹æ¤œå‡ºçµæœè¡¨ç¤º -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="music" class="text-purple-300"></i>
                    <span>éŸ³ç¨‹æ¤œå‡ºçµæœ</span>
                </h3>
                
                <!-- å‘¨æ³¢æ•°è¡¨ç¤º -->
                <div class="result-metric-card mt-4">
                    <div class="result-metric-value" id="frequency-display">--</div>
                    <div class="result-metric-label">Hz</div>
                </div>
                
                <!-- éŸ³åè¡¨ç¤º -->
                <div class="result-metric-card mt-4">
                    <div class="result-metric-value" id="note-display">--</div>
                    <div class="result-metric-label">éŸ³å</div>
                </div>
                
                <!-- æ˜ç­åº¦è¡¨ç¤º -->
                <div class="result-metric-card mt-4">
                    <div class="result-metric-value" id="clarity-display">--</div>
                    <div class="result-metric-label">æ˜ç­åº¦</div>
                </div>
            </div>

            <!-- éŸ³é‡ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="volume-2" class="text-yellow-300"></i>
                    <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                </h3>
                
                <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼ˆUIã‚«ã‚¿ãƒ­ã‚°æº–æ‹ ï¼‰ -->
                <div class="mt-4">
                    <div class="flex items-center gap-3">
                        <i data-lucide="volume-2" class="text-yellow-300" style="width: 20px; height: 20px;"></i>
                        <div class="progress-bar flex-1">
                            <div class="progress-fill gradient-catalog-green" id="volume-bar" style="width: 0%;"></div>
                        </div>
                        <span class="text-sm text-white-60" id="volume-percent">0%</span>
                    </div>
                </div>
            </div>

            <!-- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ãƒ†ã‚¹ãƒˆ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="code" class="text-orange-300"></i>
                    <span>ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ãƒ†ã‚¹ãƒˆ</span>
                </h3>
                
                <div class="mt-4 space-y-2">
                    <div class="flex justify-between">
                        <span class="text-white-70">æ›´æ–°å›æ•°:</span>
                        <span class="text-white" id="callback-count">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white-70">æœ‰åŠ¹æ¤œå‡º:</span>
                        <span class="text-green-300" id="valid-count">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white-70">æœ€å¾Œã®æ›´æ–°:</span>
                        <span class="text-white-60 text-sm" id="last-update">--</span>
                    </div>
                </div>
            </div>

            <!-- v1.1.1æ–°æ©Ÿèƒ½: æ¶ˆéŸ³æ¤œå‡ºãƒ†ã‚¹ãƒˆ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="volume-x" class="text-red-300"></i>
                    <span>æ¶ˆéŸ³æ¤œå‡ºæ©Ÿèƒ½ (v1.1.1)</span>
                </h3>
                
                <div class="mt-4 space-y-2">
                    <div class="flex justify-between">
                        <span class="text-white-70">æ¤œå‡ºçŠ¶æ…‹:</span>
                        <span class="text-white" id="silence-enabled">ç„¡åŠ¹</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white-70">ç¾åœ¨ã®çŠ¶æ…‹:</span>
                        <span class="text-green-300" id="silence-status">éŸ³å£°ã‚ã‚Š</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white-70">ç„¡éŸ³æ™‚é–“:</span>
                        <span class="text-white-60 text-sm" id="silence-duration">--</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-white-70">è­¦å‘ŠçŠ¶æ…‹:</span>
                        <span class="text-yellow-300" id="silence-warning">ãªã—</span>
                    </div>
                </div>
            </div>

            <!-- ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="terminal" class="text-red-300"></i>
                    <span>ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</span>
                </h3>
                <div class="mt-4 p-4 bg-black bg-opacity-50 rounded-lg max-h-64 overflow-y-auto font-mono text-sm" id="log-area">
                    <div class="text-blue-300">[INFO] ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†</div>
                </div>
                <button id="clear-log" class="btn btn-outline mt-4">
                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                    <span>ãƒ­ã‚°ã‚¯ãƒªã‚¢</span>
                </button>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="js/pitchpro-audio/pitchpro-v1.1.3.umd.js"></script>
    
    <!-- TODO: å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ– /js/pitchpro-correct-test.js -->
    <script>
        // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
        lucide.createIcons();
        
        // ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°
        let micController = null;
        let pitchDetector = null;
        let isDetecting = false;
        let callbackCount = 0;
        let validCount = 0;
        
        // DOMè¦ç´ 
        const systemStatus = document.getElementById('system-status');
        const initBtn = document.getElementById('init-btn');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const frequencyDisplay = document.getElementById('frequency-display');
        const noteDisplay = document.getElementById('note-display');
        const clarityDisplay = document.getElementById('clarity-display');
        const volumeBar = document.getElementById('volume-bar');
        const volumePercent = document.getElementById('volume-percent');
        const callbackCountEl = document.getElementById('callback-count');
        const validCountEl = document.getElementById('valid-count');
        const lastUpdateEl = document.getElementById('last-update');
        const logArea = document.getElementById('log-area');
        
        // æ¶ˆéŸ³æ¤œå‡ºç”¨DOMè¦ç´ 
        const silenceEnabledEl = document.getElementById('silence-enabled');
        const silenceStatusEl = document.getElementById('silence-status');
        const silenceDurationEl = document.getElementById('silence-duration');
        const silenceWarningEl = document.getElementById('silence-warning');
        
        // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
        function addLog(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = {
                'INFO': 'text-blue-300',
                'SUCCESS': 'text-green-300',
                'ERROR': 'text-red-300',
                'WARNING': 'text-yellow-300'
            }[type] || 'text-gray-300';
            
            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.textContent = `[${type}] ${timestamp}: ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            
            console.log(`[${type}] ${message}`);
        }
        
        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹æ›´æ–°
        function updateSystemStatus(message, type = 'info') {
            systemStatus.textContent = message;
            systemStatus.className = 'text-lg mt-4 ' + {
                'info': 'text-white-80',
                'success': 'text-green-300',
                'error': 'text-red-300',
                'warning': 'text-yellow-300'
            }[type];
        }
        
        // ãƒã‚¤ã‚¯åˆæœŸåŒ–ï¼ˆv1.1.1ä¿®æ­£ç¢ºèª - MicrophoneControllerå†ãƒ†ã‚¹ãƒˆï¼‰
        async function initializeMicrophone() {
            try {
                updateSystemStatus('ãƒã‚¤ã‚¯åˆæœŸåŒ–ä¸­...', 'warning');
                addLog('PitchPro v1.1.1ä¿®æ­£ç¢ºèª - MicrophoneControllerå†ãƒ†ã‚¹ãƒˆ');
                
                if (!window.PitchPro) {
                    throw new Error('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                addLog(`åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ©ã‚¹: ${Object.keys(window.PitchPro).join(', ')}`, 'INFO');
                
                // MicrophoneControllerä¿®æ­£ç¢ºèª
                const { MicrophoneController, PitchDetector, AudioManager } = window.PitchPro;
                
                // AudioManageråˆæœŸåŒ–ï¼ˆSafari Web Audio APIéŸ³é‡ä½ä¸‹å•é¡Œã®åŒ…æ‹¬çš„å¯¾ç­–ï¼‰
                micController = new AudioManager({
                    sampleRate: 44100,
                    channelCount: 1,
                    echoCancellation: false,        // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 1: ã‚¨ã‚³ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç„¡åŠ¹åŒ–
                    noiseSuppression: false,        // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 2: ãƒã‚¤ã‚ºæŠ‘åˆ¶ç„¡åŠ¹åŒ–  
                    autoGainControl: false          // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 3: è‡ªå‹•ã‚²ã‚¤ãƒ³åˆ¶å¾¡ç„¡åŠ¹åŒ–
                });
                
                await micController.initialize();
                addLog('AudioManageråˆæœŸåŒ–å®Œäº†ï¼ˆSafariéŸ³é‡ä½ä¸‹å¯¾ç­–ï¼šAGCãƒ»ECãƒ»NSå…¨ç„¡åŠ¹ï¼‰', 'SUCCESS');
                
                // PitchDetectoråˆæœŸåŒ–ï¼ˆSafariéŸ³é‡ä½ä¸‹å•é¡Œå®Œå…¨å¯¾ç­–ç‰ˆï¼‰
                pitchDetector = new PitchDetector(micController, {
                    fftSize: 4096,
                    smoothing: 0.0,  // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 4: smoothingTimeConstantç„¡åŠ¹åŒ–ï¼ˆæœ€é‡è¦ï¼‰
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.0001,  // éŸ³é‡é–¾å€¤ã‚’ã•ã‚‰ã«ä½ãï¼ˆå¾®ç´°éŸ³é‡ã‚‚æ¤œå‡ºï¼‰
                    harmonicCorrection: false,  // å‡¦ç†è² è·è»½æ¸›ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§å‘ä¸Š
                    silenceDetection: {
                        enabled: false,  // æ¶ˆéŸ³æ¤œå‡ºã‚’ç„¡åŠ¹åŒ–ï¼ˆSafariå¯¾å¿œã§éŸ³é‡æ¤œå‡ºå„ªå…ˆï¼‰
                        warningThreshold: 30000,
                        timeoutThreshold: 60000,
                        minVolumeThreshold: 0.0001,
                        onSilenceWarning: (duration) => {
                            addLog(`âš ï¸ æ¶ˆéŸ³è­¦å‘Š: ${Math.round(duration/1000)}ç§’é–“ç„¡éŸ³ã§ã™`, 'WARNING');
                        },
                        onSilenceTimeout: () => {
                            addLog('â° æ¶ˆéŸ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: æ¤œå‡ºã‚’è‡ªå‹•åœæ­¢ã—ã¾ã—ãŸ', 'ERROR');
                            updateSystemStatus('æ¶ˆéŸ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã«ã‚ˆã‚Šåœæ­¢', 'error');
                        },
                        onSilenceRecovered: () => {
                            addLog('ğŸ”Š éŸ³å£°å¾©å¸°: æ¶ˆéŸ³çŠ¶æ…‹ã‹ã‚‰å›å¾©ã—ã¾ã—ãŸ', 'SUCCESS');
                        }
                    }
                });
                
                await pitchDetector.initialize();
                
                addLog('PitchDetectoråˆæœŸåŒ–å®Œäº†ï¼ˆSafariéŸ³é‡ä½ä¸‹4å¤§å¯¾ç­–å®Ÿè£…æ¸ˆã¿ï¼‰', 'SUCCESS');
                
                // æ¶ˆéŸ³æ¤œå‡ºçŠ¶æ…‹è¡¨ç¤ºã‚’æ›´æ–°
                silenceEnabledEl.textContent = 'ç„¡åŠ¹ï¼ˆSafariéŸ³é‡ä½ä¸‹å¯¾ç­–å„ªå…ˆï¼‰';
                silenceEnabledEl.className = 'text-blue-400';
                updateSystemStatus('åˆæœŸåŒ–å®Œäº† - æ¤œå‡ºé–‹å§‹å¯èƒ½', 'success');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹å¤‰æ›´
                initBtn.disabled = true;
                startBtn.disabled = false;
                
                return true;
                
            } catch (error) {
                const errorMsg = `åˆæœŸåŒ–å¤±æ•—: ${error.message}`;
                addLog(errorMsg, 'ERROR');
                updateSystemStatus('åˆæœŸåŒ–å¤±æ•—', 'error');
                console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }
        
        // éŸ³ç¨‹æ¤œå‡ºé–‹å§‹
        function startDetection() {
            try {
                if (!pitchDetector) {
                    addLog('PitchDetectorãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ERROR');
                    return;
                }
                
                // æ¤œå‡ºé–‹å§‹
                pitchDetector.startDetection();
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                pitchDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        callbackCount++;
                        callbackCountEl.textContent = callbackCount;
                        lastUpdateEl.textContent = new Date().toLocaleTimeString();
                        
                        // ã€SafariéŸ³é‡ä½ä¸‹å•é¡Œæ ¹æœ¬è§£æ±ºã€‘Web Audio APIã‹ã‚‰ç›´æ¥éŸ³é‡ã‚’é«˜ç²¾åº¦è¨ˆç®—
                        let volumeLevel = 0;
                        let calculationMethod = 'Unknown';
                        
                        try {
                            // PitchDetectorã®å†…éƒ¨rawAnalyserã‹ã‚‰ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                            if (pitchDetector && pitchDetector.rawAnalyser) {
                                const bufferLength = pitchDetector.rawAnalyser.fftSize;
                                const dataArray = new Float32Array(bufferLength);
                                pitchDetector.rawAnalyser.getFloatTimeDomainData(dataArray);
                                
                                // é«˜ç²¾åº¦RMSè¨ˆç®—ï¼ˆSafariæœ€é©åŒ–ç‰ˆï¼‰
                                let sum = 0;
                                let maxValue = 0;
                                for (let i = 0; i < bufferLength; i++) {
                                    const value = Math.abs(dataArray[i]);
                                    sum += value * value;
                                    maxValue = Math.max(maxValue, value);
                                }
                                
                                const rms = Math.sqrt(sum / bufferLength);
                                
                                // Safariå¯¾å¿œï¼šã‚¹ãƒ ãƒ¼ã‚ºãªéŸ³é‡æ¤œå‡ºï¼ˆè‡ªç„¶ãªä¸Šæ˜‡ã‚«ãƒ¼ãƒ–æœ€é©åŒ–ï¼‰
                                const baseMultiplier = 2800; // å…¨ä½“çš„ã«æ„Ÿåº¦å‘ä¸Š
                                const minThreshold = 0.0005;   // æ¤œå‡ºæœ€å°é–¾å€¤
                                const instantDropThreshold = 0.002; // å³åº§ã‚¼ãƒ­åŒ–é–¾å€¤
                                
                                // éŸ³é‡è¨ˆç®—ï¼šRMSã¨ãƒ”ãƒ¼ã‚¯å€¤ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
                                const combinedVolume = (rms * 0.85) + (maxValue * 0.15); // RMSé‡è¦–ã§å®‰å®šæ€§ç¢ºä¿
                                
                                // ã‚¹ãƒ ãƒ¼ã‚ºãªéŸ³é‡ãƒãƒ¼åå¿œï¼ˆæ®µéšçš„å¤‰åŒ–ãªã—ï¼‰
                                if (combinedVolume < instantDropThreshold) {
                                    volumeLevel = 0; // å³åº§ã‚¼ãƒ­åŒ–
                                } else if (combinedVolume < minThreshold) {
                                    volumeLevel = 0; // å¾®ç´°éŸ³é‡ã‚«ãƒƒãƒˆ
                                } else {
                                    // å˜ä¸€ã®æ„Ÿåº¦è¨­å®šã§ã‚¹ãƒ ãƒ¼ã‚ºãªä¸Šæ˜‡ã‚«ãƒ¼ãƒ–ã‚’å®Ÿç¾
                                    volumeLevel = Math.min(100, Math.max(0, combinedVolume * baseMultiplier));
                                }
                                
                                calculationMethod = 'Safarié«˜ç²¾åº¦ç›´æ¥è¨ˆç®—';
                            }
                        } catch (error) {
                            console.warn('Direct volume calculation failed, using fallback:', error);
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šPitchProã®å€¤ã‚’ä½¿ç”¨ï¼ˆSafariå¯¾å¿œæ„Ÿåº¦å‘ä¸Šï¼‰
                            const rawVolume = result.volume || 0;
                            volumeLevel = Math.min(100, Math.max(0, rawVolume * 800)); // æ„Ÿåº¦å‘ä¸Š
                            calculationMethod = 'PitchProæ„Ÿåº¦å‘ä¸Šãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯';
                        }
                        
                        // SafariéŸ³é‡ä½ä¸‹å¯¾ç­–ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆè©³ç´°è¨ˆç®—æ–¹æ³•ã®ç¢ºèªï¼‰
                        if (callbackCount % 10 === 0) {
                            addLog(`Safariå¯¾ç­–éŸ³é‡ãƒ‡ãƒãƒƒã‚°: ${calculationMethod}, volumeLevel=${volumeLevel.toFixed(1)}%, frequency=${result.frequency || 0}`, 'INFO');
                        }
                        
                        volumeBar.style.width = volumeLevel + '%';
                        volumePercent.textContent = volumeLevel.toFixed(1) + '%';
                        
                        // æœ‰åŠ¹æ¤œå‡ºã®ç¢ºèªï¼ˆéŸ³ç¨‹ãŒå–å¾—ã§ããŸå ´åˆï¼‰
                        if (result.frequency > 0) {
                            validCount++;
                            validCountEl.textContent = validCount;
                            
                            // éŸ³ç¨‹æƒ…å ±è¡¨ç¤º
                            frequencyDisplay.textContent = result.frequency.toFixed(1);
                            noteDisplay.textContent = result.note || '--';
                            clarityDisplay.textContent = result.clarity ? result.clarity.toFixed(2) : '--';
                            
                            // SafariéŸ³é‡ä½ä¸‹å¯¾ç­–ï¼šæœ‰åŠ¹æ¤œå‡ºæ™‚ã®è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                            if (validCount % 10 === 0) {
                                addLog(`Safariå¯¾ç­–æœ‰åŠ¹æ¤œå‡º ${validCount}å›: ${result.frequency.toFixed(1)}Hz (${result.note}) éŸ³é‡: ${volumeLevel.toFixed(1)}%`, 'INFO');
                            }
                        } else {
                            // ç„¡éŸ³æ™‚ã¯éŸ³ç¨‹è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆéŸ³é‡ãƒãƒ¼ã¯ãã®ã¾ã¾ï¼‰
                            frequencyDisplay.textContent = '--';
                            noteDisplay.textContent = '--';
                            clarityDisplay.textContent = '--';
                        }
                        
                        // æ¶ˆéŸ³æ¤œå‡ºçŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°ï¼ˆv1.1.1æ–°æ©Ÿèƒ½ï¼‰
                        if (pitchDetector && pitchDetector.getSilenceStatus) {
                            const silenceStatus = pitchDetector.getSilenceStatus();
                            if (silenceStatus) {
                                silenceStatusEl.textContent = silenceStatus.isSilent ? 'ç„¡éŸ³ä¸­' : 'éŸ³å£°ã‚ã‚Š';
                                silenceStatusEl.className = silenceStatus.isSilent ? 'text-red-300' : 'text-green-300';
                                
                                if (silenceStatus.silenceDuration) {
                                    const seconds = Math.round(silenceStatus.silenceDuration / 1000);
                                    silenceDurationEl.textContent = `${seconds}ç§’`;
                                } else {
                                    silenceDurationEl.textContent = '--';
                                }
                                
                                silenceWarningEl.textContent = silenceStatus.hasWarned ? 'è­¦å‘Šæ¸ˆã¿' : 'ãªã—';
                                silenceWarningEl.className = silenceStatus.hasWarned ? 'text-yellow-300' : 'text-gray-400';
                            }
                        }
                    },
                    onError: (error) => {
                        addLog(`æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
                    }
                });
                
                isDetecting = true;
                updateSystemStatus('éŸ³ç¨‹æ¤œå‡ºä¸­...', 'info');
                addLog('éŸ³ç¨‹æ¤œå‡ºé–‹å§‹', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹å¤‰æ›´
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
            } catch (error) {
                addLog(`æ¤œå‡ºé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // éŸ³ç¨‹æ¤œå‡ºåœæ­¢
        function stopDetection() {
            try {
                if (pitchDetector && isDetecting) {
                    pitchDetector.stopDetection();
                    isDetecting = false;
                    
                    // è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
                    frequencyDisplay.textContent = '--';
                    noteDisplay.textContent = '--';
                    clarityDisplay.textContent = '--';
                    volumeBar.style.width = '0%';
                    volumePercent.textContent = '0%';
                    
                    updateSystemStatus('éŸ³ç¨‹æ¤œå‡ºåœæ­¢', 'info');
                    addLog('éŸ³ç¨‹æ¤œå‡ºåœæ­¢', 'INFO');
                    
                    // ãƒœã‚¿ãƒ³çŠ¶æ…‹å¤‰æ›´
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            } catch (error) {
                addLog(`æ¤œå‡ºåœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // ãƒ­ã‚°ã‚¯ãƒªã‚¢
        function clearLog() {
            logArea.innerHTML = '<div class="text-blue-300">[INFO] ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†</div>';
            callbackCount = 0;
            validCount = 0;
            callbackCountEl.textContent = '0';
            validCountEl.textContent = '0';
            lastUpdateEl.textContent = '--';
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        initBtn.addEventListener('click', initializeMicrophone);
        startBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);
        document.getElementById('clear-log').addEventListener('click', clearLog);
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†
        document.addEventListener('DOMContentLoaded', () => {
            updateSystemStatus('v1.1.3ãƒ›ãƒƒãƒˆãƒ•ã‚£ãƒƒã‚¯ã‚¹ç‰ˆ - ãƒã‚¤ã‚¯åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯', 'info');
            addLog('ğŸµ PitchPro v1.1.3 ãƒã‚¤ã‚¯ãƒ¬ãƒ™ãƒ«ä½ä¸‹ãƒã‚°ä¿®æ­£ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'SUCCESS');
        });
    </script>
</body>
</html>