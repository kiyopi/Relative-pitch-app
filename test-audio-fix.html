<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioDetectionComponent Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #0d4d33; color: #00cc66; }
        .error { background: #4d1a1a; color: #ff4d4d; }
        .info { background: #1a3d4d; color: #4da6cc; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #0066cc;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #debug-log {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª AudioDetectionComponent Fix Test</h1>
    <div id="status" class="status info">æº–å‚™ä¸­...</div>
    
    <button id="test-btn">AudioDetectionComponentãƒ†ã‚¹ãƒˆé–‹å§‹</button>
    <button id="clear-log-btn">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    
    <div id="debug-log"></div>

    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const testBtn = document.getElementById('test-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const debugLog = document.getElementById('debug-log');
        
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            debugLog.innerHTML = logs.join('\n');
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(logEntry);
            
            if (type === 'error') {
                statusEl.textContent = message;
                statusEl.className = 'status error';
            } else if (type === 'success') {
                statusEl.textContent = message;
                statusEl.className = 'status success';
            } else {
                statusEl.textContent = message;
                statusEl.className = 'status info';
            }
        }
        
        clearLogBtn.addEventListener('click', () => {
            logs = [];
            debugLog.innerHTML = '';
            statusEl.textContent = 'æº–å‚™ä¸­...';
            statusEl.className = 'status info';
        });
        
        async function testAudioDetectionComponent() {
            try {
                testBtn.disabled = true;
                log('ğŸ” PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèªä¸­...');
                
                // PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å­˜åœ¨ç¢ºèª
                if (!window.PitchPro) {
                    throw new Error('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                log('âœ… PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                log(`ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚¯ãƒ©ã‚¹: ${Object.keys(window.PitchPro).join(', ')}`);
                
                // AudioDetectionComponentã®å­˜åœ¨ç¢ºèª
                const { AudioDetectionComponent } = window.PitchPro;
                if (!AudioDetectionComponent) {
                    throw new Error('AudioDetectionComponentãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('âœ… AudioDetectionComponentã‚¯ãƒ©ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆãƒ†ã‚¹ãƒˆ
                log('ğŸ—ï¸ AudioDetectionComponentã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆä¸­...');
                const audioDetector = new AudioDetectionComponent({
                    debug: true,
                    logPrefix: 'ğŸ§ª FixTest',
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    deviceOptimization: true
                });
                
                log('âœ… AudioDetectionComponentã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šãƒ†ã‚¹ãƒˆ
                log('âš™ï¸ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šä¸­...');
                audioDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        log(`ğŸµ éŸ³ç¨‹æ¤œå‡º: ${result.frequency?.toFixed(1)}Hz, éŸ³é‡: ${result.volume?.toFixed(1)}%`);
                    },
                    onStateChange: (state) => {
                        log(`ğŸ”„ çŠ¶æ…‹å¤‰æ›´: ${state}`);
                    },
                    onError: (error) => {
                        log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    },
                    onDeviceDetected: (specs) => {
                        log(`ğŸ“± ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º: ${specs.deviceType} (æ„Ÿåº¦: ${specs.deviceConfig?.sensitivity || 'N/A'})`);
                    }
                });
                
                log('âœ… ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šå®Œäº†');
                
                // åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
                log('ğŸ¤ åˆæœŸåŒ–é–‹å§‹...');
                await audioDetector.initialize();
                
                log('âœ… åˆæœŸåŒ–å®Œäº†ï¼', 'success');
                log('ğŸ‰ AudioDetectionComponentã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                
                // 5ç§’å¾Œã«åœæ­¢
                setTimeout(() => {
                    log('ğŸ›‘ ãƒ†ã‚¹ãƒˆçµ‚äº†');
                    if (audioDetector) {
                        try {
                            audioDetector.destroy();
                            log('âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
                        } catch (e) {
                            log(`âš ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                        }
                    }
                    testBtn.disabled = false;
                }, 5000);
                
            } catch (error) {
                log(`âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                console.error('Test error:', error);
                testBtn.disabled = false;
            }
        }
        
        testBtn.addEventListener('click', testAudioDetectionComponent);
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸç¢ºèª
        window.addEventListener('DOMContentLoaded', () => {
            log('ğŸ“„ ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å®Œäº†');
            log('ğŸ” PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®åˆæœŸç¢ºèª...');
            
            setTimeout(() => {
                if (window.PitchPro) {
                    log(`âœ… PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¢ºèªæ¸ˆã¿: ${Object.keys(window.PitchPro).length}å€‹ã®ã‚¯ãƒ©ã‚¹`);
                    log('ğŸš€ ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„', 'success');
                } else {
                    log('âŒ PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                }
            }, 500);
        });
    </script>
</body>
</html>