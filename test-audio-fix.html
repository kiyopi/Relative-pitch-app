<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioDetectionComponent Fix Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #0d4d33; color: #00cc66; }
        .error { background: #4d1a1a; color: #ff4d4d; }
        .info { background: #1a3d4d; color: #4da6cc; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #0066cc;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #debug-log {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>🧪 AudioDetectionComponent Fix Test</h1>
    <div id="status" class="status info">準備中...</div>
    
    <button id="test-btn">AudioDetectionComponentテスト開始</button>
    <button id="clear-log-btn">ログクリア</button>
    
    <div id="debug-log"></div>

    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const testBtn = document.getElementById('test-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const debugLog = document.getElementById('debug-log');
        
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            debugLog.innerHTML = logs.join('\n');
            debugLog.scrollTop = debugLog.scrollHeight;
            
            console.log(logEntry);
            
            if (type === 'error') {
                statusEl.textContent = message;
                statusEl.className = 'status error';
            } else if (type === 'success') {
                statusEl.textContent = message;
                statusEl.className = 'status success';
            } else {
                statusEl.textContent = message;
                statusEl.className = 'status info';
            }
        }
        
        clearLogBtn.addEventListener('click', () => {
            logs = [];
            debugLog.innerHTML = '';
            statusEl.textContent = '準備中...';
            statusEl.className = 'status info';
        });
        
        async function testAudioDetectionComponent() {
            try {
                testBtn.disabled = true;
                log('🔍 PitchProライブラリの確認中...');
                
                // PitchProライブラリの存在確認
                if (!window.PitchPro) {
                    throw new Error('PitchProライブラリが読み込まれていません');
                }
                
                log('✅ PitchProライブラリが見つかりました');
                log(`📋 利用可能なクラス: ${Object.keys(window.PitchPro).join(', ')}`);
                
                // AudioDetectionComponentの存在確認
                const { AudioDetectionComponent } = window.PitchPro;
                if (!AudioDetectionComponent) {
                    throw new Error('AudioDetectionComponentが見つかりません');
                }
                
                log('✅ AudioDetectionComponentクラスが見つかりました');
                
                // インスタンス作成テスト
                log('🏗️ AudioDetectionComponentインスタンス作成中...');
                const audioDetector = new AudioDetectionComponent({
                    debug: true,
                    logPrefix: '🧪 FixTest',
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    deviceOptimization: true
                });
                
                log('✅ AudioDetectionComponentインスタンス作成成功');
                
                // コールバック設定テスト
                log('⚙️ コールバック設定中...');
                audioDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        log(`🎵 音程検出: ${result.frequency?.toFixed(1)}Hz, 音量: ${result.volume?.toFixed(1)}%`);
                    },
                    onStateChange: (state) => {
                        log(`🔄 状態変更: ${state}`);
                    },
                    onError: (error) => {
                        log(`❌ エラー: ${error.message}`, 'error');
                    },
                    onDeviceDetected: (specs) => {
                        log(`📱 デバイス検出: ${specs.deviceType} (感度: ${specs.deviceConfig?.sensitivity || 'N/A'})`);
                    }
                });
                
                log('✅ コールバック設定完了');
                
                // 初期化テスト
                log('🎤 初期化開始...');
                await audioDetector.initialize();
                
                log('✅ 初期化完了！', 'success');
                log('🎉 AudioDetectionComponentは正常に動作しています');
                
                // 5秒後に停止
                setTimeout(() => {
                    log('🛑 テスト終了');
                    if (audioDetector) {
                        try {
                            audioDetector.destroy();
                            log('✅ クリーンアップ完了');
                        } catch (e) {
                            log(`⚠️ クリーンアップ中にエラー: ${e.message}`);
                        }
                    }
                    testBtn.disabled = false;
                }, 5000);
                
            } catch (error) {
                log(`❌ テスト失敗: ${error.message}`, 'error');
                console.error('Test error:', error);
                testBtn.disabled = false;
            }
        }
        
        testBtn.addEventListener('click', testAudioDetectionComponent);
        
        // ページロード時の初期確認
        window.addEventListener('DOMContentLoaded', () => {
            log('📄 ページロード完了');
            log('🔍 PitchProライブラリの初期確認...');
            
            setTimeout(() => {
                if (window.PitchPro) {
                    log(`✅ PitchProライブラリ確認済み: ${Object.keys(window.PitchPro).length}個のクラス`);
                    log('🚀 テストボタンを押して開始してください', 'success');
                } else {
                    log('❌ PitchProライブラリが読み込まれていません', 'error');
                }
            }, 500);
        });
    </script>
</body>
</html>