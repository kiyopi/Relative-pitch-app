<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 音域テスト専用テストページ</title>
    
    <!-- 必要最小限のスタイル -->
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    
    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .voice-range-display {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🎯 音域テスト専用テストページ</h1>
        
        <div class="test-status" id="status">
            ステータス: 初期化前
        </div>
        
        <div class="control-panel">
            <h3>制御パネル</h3>
            <button id="init-btn" class="btn btn-primary">1. 音響システム初期化</button>
            <button id="test-btn" class="btn btn-success" disabled>2. 音域テスト開始</button>
            <button id="stop-btn" class="btn" style="background: #ef4444; color: white;" disabled>テスト停止</button>
        </div>
        
        <div class="voice-range-display">
            <h3 id="test-phase">待機中...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="test-instruction">音響システムを初期化してください</p>
            <div id="frequency-display" style="font-size: 24px; font-weight: bold; margin-top: 20px;">
                -- Hz
            </div>
            <div id="volume-display" style="font-size: 18px; color: #10b981;">
                音量: 0%
            </div>
        </div>
        
        <div class="control-panel">
            <h3>ログ</h3>
            <div class="log-area" id="log"></div>
            <button onclick="clearLog()" class="btn" style="background: #6b7280; color: white; font-size: 12px;">ログクリア</button>
        </div>
    </div>

    <!-- 必要なJavaScriptライブラリ -->
    <script src="./js/pitchpro-audio/index.umd.js"></script>
    <script src="./js/audio-detection-component.js"></script>
    <script src="Bolt/v2/js/lucide-init.js"></script>

    <script>
        // 統一音響検出コンポーネントを使用
        let audioDetector = null;
        
        // 音域テスト専用変数
        let isVoiceRangeTesting = false;
        let voiceRangeTestData = null;
        let currentPhase = 'low'; // 'low' or 'high'
        let detectionActive = false;
        
        // DOM要素
        const statusEl = document.getElementById('status');
        const initBtn = document.getElementById('init-btn');
        const testBtn = document.getElementById('test-btn');
        const stopBtn = document.getElementById('stop-btn');
        const testPhaseEl = document.getElementById('test-phase');
        const progressFillEl = document.getElementById('progress-fill');
        const testInstructionEl = document.getElementById('test-instruction');
        const frequencyDisplayEl = document.getElementById('frequency-display');
        const volumeDisplayEl = document.getElementById('volume-display');
        const logEl = document.getElementById('log');
        
        // ログ機能
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const levelColors = {
                info: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logEl.innerHTML += `<span style="color: ${levelColors[level] || '#ffffff'}">${logEntry}</span>`;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${level.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logEl.innerHTML = '';
        }
        
        function updateStatus(message) {
            statusEl.textContent = `ステータス: ${message}`;
            addLog(`Status: ${message}`);
        }
        
        // 音響システム初期化（コンポーネント使用）
        initBtn.addEventListener('click', async () => {
            try {
                updateStatus('初期化中...');
                addLog('🎤 統一コンポーネントで初期化開始', 'info');
                
                // AudioDetectionComponent初期化（自動UI更新なし）
                audioDetector = new AudioDetectionComponent({
                    // 音域テスト時はUI更新を手動で行う
                });
                
                await audioDetector.initialize();
                
                const status = audioDetector.getStatus();
                addLog(`✅ デバイス検出: ${status.deviceType}, 音量バー感度: ${status.volumeBarScale}x`, 'success');
                
                updateStatus('初期化完了');
                initBtn.disabled = true;
                testBtn.disabled = false;
                addLog('🎉 統一コンポーネント初期化完了 - 音域テスト開始可能', 'success');
                
            } catch (error) {
                addLog(`❌ 初期化エラー: ${error.message}`, 'error');
                updateStatus('初期化失敗');
            }
        });
        
        // 音域テスト開始
        testBtn.addEventListener('click', () => {
            startVoiceRangeTest();
        });
        
        // テスト停止
        stopBtn.addEventListener('click', () => {
            stopVoiceRangeTest();
        });
        
        // 音域テスト実行
        function startVoiceRangeTest() {
            addLog('🎯 音域テスト開始', 'info');
            updateStatus('音域テスト実行中');
            
            isVoiceRangeTesting = true;
            detectionActive = true;
            currentPhase = 'low';
            
            // テスト用データ初期化
            voiceRangeTestData = {
                phase: currentPhase,
                measurementStartTime: null,
                detectedFrequencies: [],
                results: {
                    lowestNote: null,
                    highestNote: null
                }
            };
            
            // UI更新
            testPhaseEl.textContent = '低音テスト';
            testInstructionEl.textContent = 'できるだけ低い声で「あー」を3秒間発声してください';
            progressFillEl.style.width = '0%';
            
            // 音域テスト用コールバック設定
            audioDetector.setCallbacks({
                onPitchUpdate: handleVoiceRangeUpdate
            });
            
            // 検出開始
            const startResult = audioDetector.startDetection();
            addLog(`🎤 検出開始結果: ${startResult}`, startResult ? 'success' : 'error');
            
            testBtn.disabled = true;
            stopBtn.disabled = false;
            
            addLog('🎤 低音測定開始 - 3秒間継続発声してください', 'info');
        }
        
        // 音域テスト用コールバック
        function handleVoiceRangeUpdate(result) {
            // UI更新（手動）
            if (result && result.frequency > 0) {
                frequencyDisplayEl.textContent = result.frequency.toFixed(1);
                
                // 音量バー更新（コンポーネントと同じロジック）
                const status = audioDetector.getStatus();
                const rawVolume = result.volume || 0;
                const adjustedVolume = rawVolume * status.volumeBarScale * status.sensitivityMultiplier;
                const volumePercent = Math.min(100, Math.max(0, adjustedVolume));
                
                volumeDisplayEl.textContent = volumePercent.toFixed(1) + '%';
                progressFillEl.style.width = volumePercent + '%';
            }
            
            // ログ頻度を下げる（10回に1回）
            if (Math.random() < 0.1) {
                addLog(`🎵 音域テスト処理: ${result.frequency?.toFixed(1)}Hz, 音量${((result.volume || 0) * 1000).toFixed(1)}`, 'info');
            }
            
            if (!isVoiceRangeTesting || !voiceRangeTestData || !detectionActive) {
                addLog('⏸️ 音域テスト非アクティブのためスキップ', 'warning');
                return;
            }
            
            // 周波数・音量表示更新
            if (result && result.frequency > 0) {
                frequencyDisplayEl.textContent = `${result.frequency.toFixed(1)} Hz`;
                const volumePercent = (result.volume * 100).toFixed(1);
                volumeDisplayEl.textContent = `音量: ${volumePercent}%`;
                
                addLog(`🎯 音域テスト処理: ${result.frequency.toFixed(1)}Hz, 音量${volumePercent}%`, 'info');
                
                // 測定開始時刻設定
                if (!voiceRangeTestData.measurementStartTime) {
                    voiceRangeTestData.measurementStartTime = Date.now();
                    addLog('⏱️ 3秒測定開始', 'info');
                }
                
                // 有効な周波数データを記録
                if (result.frequency > 50 && result.volume > 0.01 && result.clarity > 0.5) {
                    voiceRangeTestData.detectedFrequencies.push({
                        frequency: result.frequency,
                        time: Date.now() - voiceRangeTestData.measurementStartTime,
                        volume: result.volume,
                        clarity: result.clarity
                    });
                    
                    // 進捗表示更新
                    const elapsed = Date.now() - voiceRangeTestData.measurementStartTime;
                    const progress = Math.min(100, (elapsed / 3000) * 100);
                    progressFillEl.style.width = `${progress}%`;
                    
                    // 3秒経過で測定完了
                    if (elapsed >= 3000) {
                        completePhaseMeasurement();
                    }
                } else {
                    addLog('⚠️ 無効な音声データ（音量・明瞭度不足）', 'warning');
                }
            }
        }
        
        // フェーズ測定完了
        function completePhaseMeasurement() {
            addLog(`✅ ${currentPhase}音測定完了`, 'success');
            
            if (voiceRangeTestData.detectedFrequencies.length === 0) {
                addLog('❌ 有効な音声データが検出されませんでした', 'error');
                return;
            }
            
            // 最低/最高周波数を計算
            const frequencies = voiceRangeTestData.detectedFrequencies.map(d => d.frequency);
            const avgFreq = frequencies.reduce((a, b) => a + b) / frequencies.length;
            
            if (currentPhase === 'low') {
                voiceRangeTestData.results.lowestNote = avgFreq;
                addLog(`📊 低音結果: ${avgFreq.toFixed(1)}Hz`, 'success');
                
                // 高音測定に移行
                currentPhase = 'high';
                voiceRangeTestData.phase = 'high';
                voiceRangeTestData.measurementStartTime = null;
                voiceRangeTestData.detectedFrequencies = [];
                
                testPhaseEl.textContent = '高音テスト';
                testInstructionEl.textContent = 'できるだけ高い声で「あー」を3秒間発声してください';
                progressFillEl.style.width = '0%';
                
                addLog('🎤 高音測定開始 - 3秒間継続発声してください', 'info');
                
            } else {
                voiceRangeTestData.results.highestNote = avgFreq;
                addLog(`📊 高音結果: ${avgFreq.toFixed(1)}Hz`, 'success');
                
                // テスト完了
                finishVoiceRangeTest();
            }
        }
        
        // テスト完了
        function finishVoiceRangeTest() {
            addLog('🎉 音域テスト完了', 'success');
            
            const results = voiceRangeTestData.results;
            const range = (results.highestNote - results.lowestNote).toFixed(1);
            
            testPhaseEl.textContent = 'テスト完了';
            testInstructionEl.innerHTML = `
                <strong>測定結果</strong><br>
                低音: ${results.lowestNote.toFixed(1)} Hz<br>
                高音: ${results.highestNote.toFixed(1)} Hz<br>
                音域: ${range} Hz
            `;
            progressFillEl.style.width = '100%';
            
            addLog(`📋 最終結果 - 低音:${results.lowestNote.toFixed(1)}Hz, 高音:${results.highestNote.toFixed(1)}Hz, 範囲:${range}Hz`, 'success');
            
            stopVoiceRangeTest();
        }
        
        // テスト停止
        function stopVoiceRangeTest() {
            isVoiceRangeTesting = false;
            detectionActive = false;
            
            if (audioDetector) {
                audioDetector.stopDetection();
            }
            
            testBtn.disabled = false;
            stopBtn.disabled = true;
            
            updateStatus('テスト停止');
            addLog('🛑 音域テスト停止', 'info');
        }
        
        // 初期化
        addLog('🚀 音域テスト専用ページ読み込み完了', 'success');
        updateStatus('音響システムの初期化が必要です');
    </script>
</body>
</html>