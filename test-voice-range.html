<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆå°‚ç”¨ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
    
    <!-- å¿…è¦æœ€å°é™ã®ã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-status {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .voice-range-display {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-area {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆå°‚ç”¨ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</h1>
        
        <div class="test-status" id="status">
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: åˆæœŸåŒ–å‰
        </div>
        
        <div class="control-panel">
            <h3>åˆ¶å¾¡ãƒ‘ãƒãƒ«</h3>
            <button id="init-btn" class="btn btn-primary">1. éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</button>
            <button id="test-btn" class="btn btn-success" disabled>2. éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button id="stop-btn" class="btn" style="background: #ef4444; color: white;" disabled>ãƒ†ã‚¹ãƒˆåœæ­¢</button>
        </div>
        
        <div class="voice-range-display">
            <h3 id="test-phase">å¾…æ©Ÿä¸­...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p id="test-instruction">éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„</p>
            <div id="frequency-display" style="font-size: 24px; font-weight: bold; margin-top: 20px;">
                -- Hz
            </div>
            <div id="volume-display" style="font-size: 18px; color: #10b981;">
                éŸ³é‡: 0%
            </div>
        </div>
        
        <div class="control-panel">
            <h3>ãƒ­ã‚°</h3>
            <div class="log-area" id="log"></div>
            <button onclick="clearLog()" class="btn" style="background: #6b7280; color: white; font-size: 12px;">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <!-- å¿…è¦ãªJavaScriptãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="./js/pitchpro-audio/index.umd.js"></script>
    <script src="./js/audio-detection-component.js"></script>
    <script src="Bolt/v2/js/lucide-init.js"></script>

    <script>
        // çµ±ä¸€éŸ³éŸ¿æ¤œå‡ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨
        let audioDetector = null;
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆå°‚ç”¨å¤‰æ•°
        let isVoiceRangeTesting = false;
        let voiceRangeTestData = null;
        let currentPhase = 'low'; // 'low' or 'high'
        let detectionActive = false;
        
        // DOMè¦ç´ 
        const statusEl = document.getElementById('status');
        const initBtn = document.getElementById('init-btn');
        const testBtn = document.getElementById('test-btn');
        const stopBtn = document.getElementById('stop-btn');
        const testPhaseEl = document.getElementById('test-phase');
        const progressFillEl = document.getElementById('progress-fill');
        const testInstructionEl = document.getElementById('test-instruction');
        const frequencyDisplayEl = document.getElementById('frequency-display');
        const volumeDisplayEl = document.getElementById('volume-display');
        const logEl = document.getElementById('log');
        
        // ãƒ­ã‚°æ©Ÿèƒ½
        function addLog(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const levelColors = {
                info: '#3b82f6',
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            const logEntry = `[${timestamp}] ${message}\n`;
            logEl.innerHTML += `<span style="color: ${levelColors[level] || '#ffffff'}">${logEntry}</span>`;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${level.toUpperCase()}] ${message}`);
        }
        
        function clearLog() {
            logEl.innerHTML = '';
        }
        
        function updateStatus(message) {
            statusEl.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${message}`;
            addLog(`Status: ${message}`);
        }
        
        // éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½¿ç”¨ï¼‰
        initBtn.addEventListener('click', async () => {
            try {
                updateStatus('åˆæœŸåŒ–ä¸­...');
                addLog('ğŸ¤ çµ±ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åˆæœŸåŒ–é–‹å§‹', 'info');
                
                // AudioDetectionComponentåˆæœŸåŒ–ï¼ˆè‡ªå‹•UIæ›´æ–°ãªã—ï¼‰
                audioDetector = new AudioDetectionComponent({
                    // éŸ³åŸŸãƒ†ã‚¹ãƒˆæ™‚ã¯UIæ›´æ–°ã‚’æ‰‹å‹•ã§è¡Œã†
                });
                
                await audioDetector.initialize();
                
                const status = audioDetector.getStatus();
                addLog(`âœ… ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º: ${status.deviceType}, éŸ³é‡ãƒãƒ¼æ„Ÿåº¦: ${status.volumeBarScale}x`, 'success');
                
                updateStatus('åˆæœŸåŒ–å®Œäº†');
                initBtn.disabled = true;
                testBtn.disabled = false;
                addLog('ğŸ‰ çµ±ä¸€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å®Œäº† - éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹å¯èƒ½', 'success');
                
            } catch (error) {
                addLog(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus('åˆæœŸåŒ–å¤±æ•—');
            }
        });
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹
        testBtn.addEventListener('click', () => {
            startVoiceRangeTest();
        });
        
        // ãƒ†ã‚¹ãƒˆåœæ­¢
        stopBtn.addEventListener('click', () => {
            stopVoiceRangeTest();
        });
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function startVoiceRangeTest() {
            addLog('ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            updateStatus('éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­');
            
            isVoiceRangeTesting = true;
            detectionActive = true;
            currentPhase = 'low';
            
            // ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
            voiceRangeTestData = {
                phase: currentPhase,
                measurementStartTime: null,
                detectedFrequencies: [],
                results: {
                    lowestNote: null,
                    highestNote: null
                }
            };
            
            // UIæ›´æ–°
            testPhaseEl.textContent = 'ä½éŸ³ãƒ†ã‚¹ãƒˆ';
            testInstructionEl.textContent = 'ã§ãã‚‹ã ã‘ä½ã„å£°ã§ã€Œã‚ãƒ¼ã€ã‚’3ç§’é–“ç™ºå£°ã—ã¦ãã ã•ã„';
            progressFillEl.style.width = '0%';
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            audioDetector.setCallbacks({
                onPitchUpdate: handleVoiceRangeUpdate
            });
            
            // æ¤œå‡ºé–‹å§‹
            const startResult = audioDetector.startDetection();
            addLog(`ğŸ¤ æ¤œå‡ºé–‹å§‹çµæœ: ${startResult}`, startResult ? 'success' : 'error');
            
            testBtn.disabled = true;
            stopBtn.disabled = false;
            
            addLog('ğŸ¤ ä½éŸ³æ¸¬å®šé–‹å§‹ - 3ç§’é–“ç¶™ç¶šç™ºå£°ã—ã¦ãã ã•ã„', 'info');
        }
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        function handleVoiceRangeUpdate(result) {
            // UIæ›´æ–°ï¼ˆæ‰‹å‹•ï¼‰
            if (result && result.frequency > 0) {
                frequencyDisplayEl.textContent = result.frequency.toFixed(1);
                
                // éŸ³é‡ãƒãƒ¼æ›´æ–°ï¼ˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                const status = audioDetector.getStatus();
                const rawVolume = result.volume || 0;
                const adjustedVolume = rawVolume * status.volumeBarScale * status.sensitivityMultiplier;
                const volumePercent = Math.min(100, Math.max(0, adjustedVolume));
                
                volumeDisplayEl.textContent = volumePercent.toFixed(1) + '%';
                progressFillEl.style.width = volumePercent + '%';
            }
            
            // ãƒ­ã‚°é »åº¦ã‚’ä¸‹ã’ã‚‹ï¼ˆ10å›ã«1å›ï¼‰
            if (Math.random() < 0.1) {
                addLog(`ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆå‡¦ç†: ${result.frequency?.toFixed(1)}Hz, éŸ³é‡${((result.volume || 0) * 1000).toFixed(1)}`, 'info');
            }
            
            if (!isVoiceRangeTesting || !voiceRangeTestData || !detectionActive) {
                addLog('â¸ï¸ éŸ³åŸŸãƒ†ã‚¹ãƒˆéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—', 'warning');
                return;
            }
            
            // å‘¨æ³¢æ•°ãƒ»éŸ³é‡è¡¨ç¤ºæ›´æ–°
            if (result && result.frequency > 0) {
                frequencyDisplayEl.textContent = `${result.frequency.toFixed(1)} Hz`;
                const volumePercent = (result.volume * 100).toFixed(1);
                volumeDisplayEl.textContent = `éŸ³é‡: ${volumePercent}%`;
                
                addLog(`ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆå‡¦ç†: ${result.frequency.toFixed(1)}Hz, éŸ³é‡${volumePercent}%`, 'info');
                
                // æ¸¬å®šé–‹å§‹æ™‚åˆ»è¨­å®š
                if (!voiceRangeTestData.measurementStartTime) {
                    voiceRangeTestData.measurementStartTime = Date.now();
                    addLog('â±ï¸ 3ç§’æ¸¬å®šé–‹å§‹', 'info');
                }
                
                // æœ‰åŠ¹ãªå‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
                if (result.frequency > 50 && result.volume > 0.01 && result.clarity > 0.5) {
                    voiceRangeTestData.detectedFrequencies.push({
                        frequency: result.frequency,
                        time: Date.now() - voiceRangeTestData.measurementStartTime,
                        volume: result.volume,
                        clarity: result.clarity
                    });
                    
                    // é€²æ—è¡¨ç¤ºæ›´æ–°
                    const elapsed = Date.now() - voiceRangeTestData.measurementStartTime;
                    const progress = Math.min(100, (elapsed / 3000) * 100);
                    progressFillEl.style.width = `${progress}%`;
                    
                    // 3ç§’çµŒéã§æ¸¬å®šå®Œäº†
                    if (elapsed >= 3000) {
                        completePhaseMeasurement();
                    }
                } else {
                    addLog('âš ï¸ ç„¡åŠ¹ãªéŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼ˆéŸ³é‡ãƒ»æ˜ç­åº¦ä¸è¶³ï¼‰', 'warning');
                }
            }
        }
        
        // ãƒ•ã‚§ãƒ¼ã‚ºæ¸¬å®šå®Œäº†
        function completePhaseMeasurement() {
            addLog(`âœ… ${currentPhase}éŸ³æ¸¬å®šå®Œäº†`, 'success');
            
            if (voiceRangeTestData.detectedFrequencies.length === 0) {
                addLog('âŒ æœ‰åŠ¹ãªéŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error');
                return;
            }
            
            // æœ€ä½/æœ€é«˜å‘¨æ³¢æ•°ã‚’è¨ˆç®—
            const frequencies = voiceRangeTestData.detectedFrequencies.map(d => d.frequency);
            const avgFreq = frequencies.reduce((a, b) => a + b) / frequencies.length;
            
            if (currentPhase === 'low') {
                voiceRangeTestData.results.lowestNote = avgFreq;
                addLog(`ğŸ“Š ä½éŸ³çµæœ: ${avgFreq.toFixed(1)}Hz`, 'success');
                
                // é«˜éŸ³æ¸¬å®šã«ç§»è¡Œ
                currentPhase = 'high';
                voiceRangeTestData.phase = 'high';
                voiceRangeTestData.measurementStartTime = null;
                voiceRangeTestData.detectedFrequencies = [];
                
                testPhaseEl.textContent = 'é«˜éŸ³ãƒ†ã‚¹ãƒˆ';
                testInstructionEl.textContent = 'ã§ãã‚‹ã ã‘é«˜ã„å£°ã§ã€Œã‚ãƒ¼ã€ã‚’3ç§’é–“ç™ºå£°ã—ã¦ãã ã•ã„';
                progressFillEl.style.width = '0%';
                
                addLog('ğŸ¤ é«˜éŸ³æ¸¬å®šé–‹å§‹ - 3ç§’é–“ç¶™ç¶šç™ºå£°ã—ã¦ãã ã•ã„', 'info');
                
            } else {
                voiceRangeTestData.results.highestNote = avgFreq;
                addLog(`ğŸ“Š é«˜éŸ³çµæœ: ${avgFreq.toFixed(1)}Hz`, 'success');
                
                // ãƒ†ã‚¹ãƒˆå®Œäº†
                finishVoiceRangeTest();
            }
        }
        
        // ãƒ†ã‚¹ãƒˆå®Œäº†
        function finishVoiceRangeTest() {
            addLog('ğŸ‰ éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
            
            const results = voiceRangeTestData.results;
            const range = (results.highestNote - results.lowestNote).toFixed(1);
            
            testPhaseEl.textContent = 'ãƒ†ã‚¹ãƒˆå®Œäº†';
            testInstructionEl.innerHTML = `
                <strong>æ¸¬å®šçµæœ</strong><br>
                ä½éŸ³: ${results.lowestNote.toFixed(1)} Hz<br>
                é«˜éŸ³: ${results.highestNote.toFixed(1)} Hz<br>
                éŸ³åŸŸ: ${range} Hz
            `;
            progressFillEl.style.width = '100%';
            
            addLog(`ğŸ“‹ æœ€çµ‚çµæœ - ä½éŸ³:${results.lowestNote.toFixed(1)}Hz, é«˜éŸ³:${results.highestNote.toFixed(1)}Hz, ç¯„å›²:${range}Hz`, 'success');
            
            stopVoiceRangeTest();
        }
        
        // ãƒ†ã‚¹ãƒˆåœæ­¢
        function stopVoiceRangeTest() {
            isVoiceRangeTesting = false;
            detectionActive = false;
            
            if (audioDetector) {
                audioDetector.stopDetection();
            }
            
            testBtn.disabled = false;
            stopBtn.disabled = true;
            
            updateStatus('ãƒ†ã‚¹ãƒˆåœæ­¢');
            addLog('ğŸ›‘ éŸ³åŸŸãƒ†ã‚¹ãƒˆåœæ­¢', 'info');
        }
        
        // åˆæœŸåŒ–
        addLog('ğŸš€ éŸ³åŸŸãƒ†ã‚¹ãƒˆå°‚ç”¨ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'success');
        updateStatus('éŸ³éŸ¿ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ãŒå¿…è¦ã§ã™');
    </script>
</body>
</html>