<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Test - voice-range-test-v4</title>
    <style>
        /* å®Œå…¨å†…åŒ…ç‰ˆ - å¤–éƒ¨ä¾å­˜ä¸€åˆ‡ãªã— */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #581c87 100%);
            color: #ffffff;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
            background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
        }
        
        .test-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 1.5rem 0;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, #60a5fa 0%, #34d399 100%);
            border-radius: 2px;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .test-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            min-width: 120px;
        }
        
        .test-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .test-button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .test-button.success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .test-result {
            margin: 0.5rem 0;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border-left: 4px solid transparent;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .test-success {
            background: rgba(16, 185, 129, 0.15);
            border-left-color: #10b981;
            color: #34d399;
        }
        
        .test-error {
            background: rgba(239, 68, 68, 0.15);
            border-left-color: #ef4444;
            color: #f87171;
        }
        
        .test-info {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: #3b82f6;
            color: #60a5fa;
        }
        
        .test-warning {
            background: rgba(245, 158, 11, 0.15);
            border-left-color: #f59e0b;
            color: #fbbf24;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .stats-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stats-item .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .stats-item .label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }
        
        .notice {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .notice h3 {
            color: #fbbf24;
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .notice p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .test-section {
                padding: 1rem;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .test-button {
                min-width: 100px;
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸ§ª voice-range-test-v4</h1>
            <p>å®Œå…¨è‡ªå·±å®Œçµç‰ˆ å˜ä½“ãƒ†ã‚¹ãƒˆ</p>
        </div>

        <!-- æƒ…å ± -->
        <div class="notice">
            <h3>ğŸ“‹ å®Œå…¨è‡ªå·±å®Œçµç‰ˆ</h3>
            <p>
                å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ»CSSã‚’ä¸€åˆ‡ä½¿ç”¨ã—ãªã„å®Œå…¨è‡ªå·±å®Œçµãƒ†ã‚¹ãƒˆã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã§ç›´æ¥é–‹ãã ã‘ã§å‹•ä½œã™ã‚‹å®‰å…¨ç‰ˆã§ã™ã€‚
            </p>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="test-section">
            <h2 class="section-title">ğŸ“Š ãƒ†ã‚¹ãƒˆçµ±è¨ˆ</h2>
            <div class="stats-grid">
                <div class="stats-item">
                    <div class="value" id="total-tests">0</div>
                    <div class="label">ç·ãƒ†ã‚¹ãƒˆæ•°</div>
                </div>
                <div class="stats-item">
                    <div class="value" id="passed-tests">0</div>
                    <div class="label">æˆåŠŸ</div>
                </div>
                <div class="stats-item">
                    <div class="value" id="failed-tests">0</div>
                    <div class="label">å¤±æ•—</div>
                </div>
                <div class="stats-item">
                    <div class="value" id="test-duration">0ms</div>
                    <div class="label">å®Ÿè¡Œæ™‚é–“</div>
                </div>
            </div>
        </div>

        <!-- ãƒ¢ãƒƒã‚¯ç”¨UIè¦ç´ ï¼ˆéè¡¨ç¤ºï¼‰ -->
        <div class="hidden">
            <div id="volume-progress" style="width: 0%;"></div>
            <div id="volume-percentage">0%</div>
            <div id="range-test-volume-bar" style="width: 0%;"></div>
            <div id="range-test-volume-text">0%</div>
            <div id="range-test-frequency-value">-- Hz</div>
            <button id="start-mic-test">ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button id="start-range-test">éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <div id="recording-status">æº–å‚™ä¸­</div>
            <div id="test-progress">0/15</div>
            <button class="record-btn" data-note="C3">è¨˜éŒ²</button>
            <button class="record-btn" data-note="D3">è¨˜éŒ²</button>
        </div>

        <!-- AudioDetectionComponent ãƒ†ã‚¹ãƒˆ -->
        <section class="test-section">
            <h2 class="section-title">ğŸ™ï¸ AudioDetectionComponent</h2>
            <div class="button-group">
                <button class="test-button" onclick="testAudioDetection()">åŸºæœ¬å‹•ä½œ</button>
                <button class="test-button" onclick="testAudioInit()">åˆæœŸåŒ–</button>
                <button class="test-button" onclick="testAudioDestroy()">ç ´æ£„å‡¦ç†</button>
                <button class="test-button" onclick="testDeviceDetect()">ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º</button>
            </div>
            <div id="audio-results"></div>
        </section>

        <!-- RecordingController ãƒ†ã‚¹ãƒˆ -->
        <section class="test-section">
            <h2 class="section-title">ğŸ›ï¸ RecordingController</h2>
            <div class="button-group">
                <button class="test-button" onclick="testRecording()">åŸºæœ¬å‹•ä½œ</button>
                <button class="test-button" onclick="testRecordingInit()">åˆæœŸåŒ–</button>
                <button class="test-button" onclick="testPhases()">ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»</button>
            </div>
            <div id="recording-results"></div>
        </section>

        <!-- VoiceRangeUI ãƒ†ã‚¹ãƒˆ -->
        <section class="test-section">
            <h2 class="section-title">ğŸ¨ VoiceRangeUI</h2>
            <div class="button-group">
                <button class="test-button" onclick="testUI()">åŸºæœ¬å‹•ä½œ</button>
                <button class="test-button" onclick="testUIInit()">åˆæœŸåŒ–</button>
                <button class="test-button" onclick="testProgress()">é€²æ—æ›´æ–°</button>
            </div>
            <div id="ui-results"></div>
        </section>

        <!-- VoiceRangeTester ãƒ†ã‚¹ãƒˆ -->
        <section class="test-section">
            <h2 class="section-title">ğŸ¯ VoiceRangeTester</h2>
            <div class="button-group">
                <button class="test-button" onclick="testTester()">åŸºæœ¬å‹•ä½œ</button>
                <button class="test-button" onclick="testAnalysis()">åˆ†ææ©Ÿèƒ½</button>
                <button class="test-button" onclick="testNotes()">éŸ³åãƒãƒƒãƒ”ãƒ³ã‚°</button>
            </div>
            <div id="tester-results"></div>
        </section>

        <!-- çµ±åˆãƒ†ã‚¹ãƒˆ -->
        <section class="test-section">
            <h2 class="section-title">âš¡ çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
            <div class="button-group">
                <button class="test-button success" onclick="runAllTests()" id="run-all-btn">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
                <button class="test-button" onclick="clearAll()">çµæœã‚¯ãƒªã‚¢</button>
            </div>
            <div id="overall-results"></div>
        </section>
    </div>

    <script>
        // ===== ãƒ†ã‚¹ãƒˆçµ±è¨ˆ =====
        const Stats = {
            total: 0,
            passed: 0,
            failed: 0,
            start: null,
            
            reset() {
                this.total = 0;
                this.passed = 0;
                this.failed = 0;
                this.start = Date.now();
                this.update();
            },
            
            add(success) {
                this.total++;
                if (success) this.passed++; else this.failed++;
                this.update();
            },
            
            update() {
                document.getElementById('total-tests').textContent = this.total;
                document.getElementById('passed-tests').textContent = this.passed;
                document.getElementById('failed-tests').textContent = this.failed;
                if (this.start) {
                    document.getElementById('test-duration').textContent = `${Date.now() - this.start}ms`;
                }
            }
        };

        // ===== ãƒ­ã‚°é–¢æ•° =====
        function log(sectionId, message, type = 'info') {
            const section = document.getElementById(sectionId);
            const div = document.createElement('div');
            div.className = `test-result test-${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            section.appendChild(div);
            
            console.log(`[TEST ${type.toUpperCase()}] ${message}`);
            Stats.add(type === 'success');
        }

        function clear(sectionId) {
            document.getElementById(sectionId).innerHTML = '';
        }

        // ===== AudioDetectionComponentå®Ÿè£… =====
        class AudioDetectionComponent {
            constructor(options = {}) {
                this.options = {
                    volumeBarSelector: '#volume-progress',
                    volumeTextSelector: '#volume-percentage',
                    debugMode: false,
                    ...options
                };
                
                this.isInitialized = false;
                this.isDetecting = false;
                this.isDestroyed = false;
                this.deviceSpecs = this.detectDevice();
                this.callbacks = {};
                this.mockInterval = null;
                
                if (this.options.debugMode) {
                    console.log('AudioDetectionComponentä½œæˆå®Œäº†');
                }
            }
            
            detectDevice() {
                const ua = navigator.userAgent;
                const isIPhone = /iPhone/.test(ua);
                const isIPad = /iPad/.test(ua) || (/Macintosh/.test(ua) && 'ontouchend' in document);
                
                if (isIPhone) {
                    return { type: 'iPhone', sensitivity: 3.5, multiplier: 4.5 };
                } else if (isIPad) {
                    return { type: 'iPad', sensitivity: 5.0, multiplier: 7.0 };
                } else {
                    return { type: 'PC', sensitivity: 2.5, multiplier: 4.0 };
                }
            }
            
            async initialize() {
                if (this.isDestroyed) throw new Error('ç ´æ£„æ¸ˆã¿');
                if (this.isInitialized) return true;
                
                await new Promise(resolve => setTimeout(resolve, 100));
                this.isInitialized = true;
                return true;
            }
            
            async startDetection() {
                if (!this.isInitialized) throw new Error('æœªåˆæœŸåŒ–');
                if (this.isDetecting) return true;
                
                this.isDetecting = true;
                this.mockInterval = setInterval(() => {
                    if (this.callbacks.onPitchUpdate && this.isDetecting) {
                        this.callbacks.onPitchUpdate({
                            volume: 30 + Math.random() * 60,
                            frequency: 200 + Math.random() * 200,
                            clarity: 0.5 + Math.random() * 0.5,
                            timestamp: Date.now()
                        });
                    }
                }, 100);
                
                return true;
            }
            
            stopDetection() {
                this.isDetecting = false;
                if (this.mockInterval) {
                    clearInterval(this.mockInterval);
                    this.mockInterval = null;
                }
            }
            
            setCallbacks(callbacks) {
                Object.assign(this.callbacks, callbacks);
            }
            
            getStats() {
                return {
                    deviceType: this.deviceSpecs.type,
                    isInitialized: this.isInitialized,
                    isDetecting: this.isDetecting,
                    isDestroyed: this.isDestroyed
                };
            }
            
            destroy() {
                if (this.isDestroyed) return;
                this.stopDetection();
                this.callbacks = {};
                this.isDestroyed = true;
            }
        }

        // ===== RecordingControllerå®Ÿè£… =====
        class RecordingController {
            constructor(options = {}) {
                this.options = { debugMode: false, ...options };
                this.currentPhase = 'initial';
                this.elements = {};
                this.eventListeners = new Map();
            }
            
            async initialize() {
                this.cacheElements();
                this.setupEventListeners();
                await new Promise(resolve => setTimeout(resolve, 50));
                return true;
            }
            
            cacheElements() {
                const selectors = ['#start-mic-test', '#start-range-test', '#recording-status'];
                selectors.forEach((sel, i) => {
                    const el = document.querySelector(sel);
                    if (el) this.elements[`element${i}`] = el;
                });
                this.elements.recordButtons = document.querySelectorAll('.record-btn');
            }
            
            setupEventListeners() {
                // ãƒ¢ãƒƒã‚¯å®Ÿè£…
            }
            
            updateUIState(phase) {
                this.currentPhase = phase;
                document.body.classList.remove('phase-initial', 'phase-mic-test', 'phase-range-test');
                document.body.classList.add(`phase-${phase}`);
            }
            
            destroy() {
                this.eventListeners.clear();
                this.elements = {};
            }
        }

        // ===== VoiceRangeUIå®Ÿè£… =====
        class VoiceRangeUI {
            constructor(options = {}) {
                this.options = { totalNotes: 15, ...options };
                this.currentPhase = 'initial';
                this.completedNotes = new Set();
                this.elements = {};
            }
            
            initialize() {
                this.cacheUIElements();
                this.setPhase('initial');
                return true;
            }
            
            cacheUIElements() {
                const selectors = ['#recording-status', '#test-progress'];
                selectors.forEach((sel, i) => {
                    const el = document.querySelector(sel);
                    if (el) this.elements[`ui${i}`] = el;
                });
            }
            
            setPhase(phase) {
                this.currentPhase = phase;
                document.body.classList.remove('phase-initial', 'phase-mic-test', 'phase-range-test');
                document.body.classList.add(`phase-${phase}`);
            }
            
            updateProgress(completed, total = this.options.totalNotes) {
                const percentage = Math.round((completed / total) * 100);
                return percentage;
            }
            
            destroy() {
                this.elements = {};
            }
        }

        // ===== VoiceRangeTesterå®Ÿè£… =====
        class VoiceRangeTester {
            constructor() {
                this.targetNotes = [
                    { name: 'C3', frequency: 130.8 },
                    { name: 'D3', frequency: 146.8 },
                    { name: 'E3', frequency: 164.8 },
                    { name: 'C4', frequency: 261.6 },
                    { name: 'A4', frequency: 440.0 },
                    { name: 'C5', frequency: 523.3 }
                ];
                this.results = new Map();
            }
            
            findNoteByName(name) {
                return this.targetNotes.find(note => note.name === name);
            }
            
            analyzeMeasurementData(noteName, targetNote, data) {
                if (!data || data.length === 0) {
                    return { noteName, success: false, reason: 'ãƒ‡ãƒ¼ã‚¿ãªã—', confidence: 0 };
                }
                
                const validData = data.filter(d => d.volume > 30 && d.frequency > 0);
                if (validData.length === 0) {
                    return { noteName, success: false, reason: 'æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãªã—', confidence: 0 };
                }
                
                const avgFreq = validData.reduce((sum, d) => sum + d.frequency, 0) / validData.length;
                const error = Math.abs(avgFreq - targetNote.frequency) / targetNote.frequency * 100;
                const success = error <= 5.0;
                const confidence = Math.max(0, 100 - error * 2);
                
                return {
                    noteName,
                    success,
                    confidence: Math.round(confidence),
                    frequencyError: Math.round(error * 100) / 100,
                    reason: success ? 'æ¸¬å®šæˆåŠŸ' : `èª¤å·®${Math.round(error)}%`
                };
            }
            
            getResults() {
                return Array.from(this.results.values());
            }
        }

        // ===== ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç† =====
        window.testInstances = {};

        // ===== AudioDetectionComponent ãƒ†ã‚¹ãƒˆ =====
        window.testAudioDetection = function() {
            clear('audio-results');
            try {
                log('audio-results', 'AudioDetectionComponentåŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                const detector = new AudioDetectionComponent({ debugMode: true });
                const stats = detector.getStats();
                
                log('audio-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                log('audio-results', `ãƒ‡ãƒã‚¤ã‚¹: ${stats.deviceType}`, 'info');
                
                window.testInstances.audioDetector = detector;
                log('audio-results', 'AudioDetectionComponentåŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('audio-results', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testAudioInit = async function() {
            try {
                log('audio-results', 'åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.audioDetector) {
                    log('audio-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const detector = window.testInstances.audioDetector;
                const result = await detector.initialize();
                
                if (result) {
                    log('audio-results', 'åˆæœŸåŒ–æˆåŠŸ', 'success');
                    
                    await detector.startDetection();
                    log('audio-results', 'æ¤œå‡ºé–‹å§‹æˆåŠŸ', 'success');
                    
                    setTimeout(() => {
                        detector.stopDetection();
                        log('audio-results', 'æ¤œå‡ºåœæ­¢æˆåŠŸ', 'info');
                    }, 2000);
                }
                
            } catch (error) {
                log('audio-results', `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testAudioDestroy = function() {
            try {
                log('audio-results', 'ç ´æ£„ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.audioDetector) {
                    log('audio-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
                    return;
                }
                
                const detector = window.testInstances.audioDetector;
                detector.destroy();
                
                const stats = detector.getStats();
                log('audio-results', `ç ´æ£„çŠ¶æ…‹: ${stats.isDestroyed}`, 'success');
                
            } catch (error) {
                log('audio-results', `ç ´æ£„ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testDeviceDetect = function() {
            try {
                log('audio-results', 'ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                const detector = new AudioDetectionComponent();
                const stats = detector.getStats();
                
                log('audio-results', `æ¤œå‡ºãƒ‡ãƒã‚¤ã‚¹: ${stats.deviceType}`, 'info');
                log('audio-results', `User Agent: ${navigator.userAgent.substring(0, 50)}...`, 'info');
                log('audio-results', `ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆ: ${'ontouchend' in document}`, 'info');
                
                detector.destroy();
                log('audio-results', 'ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('audio-results', `ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ===== RecordingController ãƒ†ã‚¹ãƒˆ =====
        window.testRecording = function() {
            clear('recording-results');
            try {
                log('recording-results', 'RecordingControlleråŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                const controller = new RecordingController({ debugMode: true });
                
                log('recording-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                log('recording-results', `åˆæœŸãƒ•ã‚§ãƒ¼ã‚º: ${controller.currentPhase}`, 'info');
                
                window.testInstances.controller = controller;
                log('recording-results', 'RecordingControlleråŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('recording-results', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testRecordingInit = async function() {
            try {
                log('recording-results', 'åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.controller) {
                    log('recording-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const controller = window.testInstances.controller;
                const result = await controller.initialize();
                
                if (result) {
                    log('recording-results', 'åˆæœŸåŒ–æˆåŠŸ', 'success');
                    log('recording-results', `è¦ç´ æ•°: ${Object.keys(controller.elements).length}`, 'info');
                }
                
            } catch (error) {
                log('recording-results', `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testPhases = function() {
            try {
                log('recording-results', 'ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.controller) {
                    log('recording-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const controller = window.testInstances.controller;
                const phases = ['mic-test', 'range-test', 'completed'];
                
                phases.forEach((phase, i) => {
                    setTimeout(() => {
                        controller.updateUIState(phase);
                        log('recording-results', `${phase}ãƒ•ã‚§ãƒ¼ã‚ºè¨­å®šå®Œäº†`, 'info');
                        
                        if (i === phases.length - 1) {
                            log('recording-results', 'ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                        }
                    }, i * 300);
                });
                
            } catch (error) {
                log('recording-results', `ãƒ•ã‚§ãƒ¼ã‚ºé·ç§»ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ===== VoiceRangeUI ãƒ†ã‚¹ãƒˆ =====
        window.testUI = function() {
            clear('ui-results');
            try {
                log('ui-results', 'VoiceRangeUIåŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                const ui = new VoiceRangeUI({ debugMode: true });
                
                log('ui-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                log('ui-results', `åˆæœŸãƒ•ã‚§ãƒ¼ã‚º: ${ui.currentPhase}`, 'info');
                
                window.testInstances.ui = ui;
                log('ui-results', 'VoiceRangeUIåŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('ui-results', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testUIInit = function() {
            try {
                log('ui-results', 'UIåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.ui) {
                    log('ui-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const ui = window.testInstances.ui;
                const result = ui.initialize();
                
                if (result) {
                    log('ui-results', 'UIåˆæœŸåŒ–æˆåŠŸ', 'success');
                    log('ui-results', `è¦ç´ æ•°: ${Object.keys(ui.elements).length}`, 'info');
                }
                
            } catch (error) {
                log('ui-results', `UIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testProgress = function() {
            try {
                log('ui-results', 'é€²æ—æ›´æ–°ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.ui) {
                    log('ui-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const ui = window.testInstances.ui;
                const steps = [0, 5, 10, 15];
                
                steps.forEach((step, i) => {
                    setTimeout(() => {
                        const percentage = ui.updateProgress(step);
                        log('ui-results', `é€²æ—æ›´æ–° ${step}/15 (${percentage}%)`, 'info');
                        
                        if (i === steps.length - 1) {
                            log('ui-results', 'é€²æ—æ›´æ–°ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                        }
                    }, i * 200);
                });
                
            } catch (error) {
                log('ui-results', `é€²æ—æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ===== VoiceRangeTester ãƒ†ã‚¹ãƒˆ =====
        window.testTester = function() {
            clear('tester-results');
            try {
                log('tester-results', 'VoiceRangeTesteråŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                const tester = new VoiceRangeTester();
                
                log('tester-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');
                log('tester-results', `å¯¾è±¡éŸ³æ•°: ${tester.targetNotes.length}`, 'info');
                
                window.testInstances.tester = tester;
                log('tester-results', 'VoiceRangeTesteråŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('tester-results', `ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testAnalysis = function() {
            try {
                log('tester-results', 'åˆ†ææ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.tester) {
                    log('tester-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const tester = window.testInstances.tester;
                const mockData = [
                    { volume: 75, frequency: 261.6, clarity: 0.8 },
                    { volume: 80, frequency: 260.0, clarity: 0.9 }
                ];
                
                const targetNote = { name: 'C4', frequency: 261.6 };
                const result = tester.analyzeMeasurementData('C4', targetNote, mockData);
                
                log('tester-results', `åˆ†æçµæœ: æˆåŠŸ=${result.success}`, 'info');
                log('tester-results', `å‘¨æ³¢æ•°èª¤å·®: ${result.frequencyError}%`, 'info');
                log('tester-results', `ä¿¡é ¼åº¦: ${result.confidence}%`, 'info');
                log('tester-results', 'åˆ†ææ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('tester-results', `åˆ†ææ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        window.testNotes = function() {
            try {
                log('tester-results', 'éŸ³åãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                if (!window.testInstances.tester) {
                    log('tester-results', 'ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                
                const tester = window.testInstances.tester;
                const testNotes = ['C3', 'C4', 'A4', 'X1'];
                
                testNotes.forEach(name => {
                    const note = tester.findNoteByName(name);
                    if (note) {
                        log('tester-results', `${name}: ${note.frequency} Hz`, 'info');
                    } else {
                        log('tester-results', `${name}: è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
                    }
                });
                
                log('tester-results', 'éŸ³åãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                log('tester-results', `éŸ³åãƒãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // ===== çµ±åˆãƒ†ã‚¹ãƒˆ =====
        window.runAllTests = async function() {
            clear('overall-results');
            Stats.reset();
            
            try {
                log('overall-results', '=== å…¨ä½“ãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'info');
                document.getElementById('run-all-btn').disabled = true;
                
                // AudioDetectionComponent
                log('overall-results', 'ğŸ™ï¸ AudioDetectionComponent ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
                window.testAudioDetection();
                await new Promise(resolve => setTimeout(resolve, 300));
                await window.testAudioInit();
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // RecordingController
                log('overall-results', 'ğŸ›ï¸ RecordingController ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
                window.testRecording();
                await new Promise(resolve => setTimeout(resolve, 200));
                await window.testRecordingInit();
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // VoiceRangeUI
                log('overall-results', 'ğŸ¨ VoiceRangeUI ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
                window.testUI();
                await new Promise(resolve => setTimeout(resolve, 200));
                window.testUIInit();
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // VoiceRangeTester
                log('overall-results', 'ğŸ¯ VoiceRangeTester ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...', 'info');
                window.testTester();
                await new Promise(resolve => setTimeout(resolve, 200));
                window.testAnalysis();
                await new Promise(resolve => setTimeout(resolve, 200));
                
                log('overall-results', '=== å…¨ä½“ãƒ†ã‚¹ãƒˆå®Œäº† ===', 'success');
                log('overall-results', `æˆåŠŸ: ${Stats.passed}, å¤±æ•—: ${Stats.failed}`, 'info');
                
            } catch (error) {
                log('overall-results', `å…¨ä½“ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                document.getElementById('run-all-btn').disabled = false;
            }
        };

        window.clearAll = function() {
            ['audio-results', 'recording-results', 'ui-results', 'tester-results', 'overall-results']
                .forEach(id => clear(id));
            window.testInstances = {};
            Stats.reset();
            console.clear();
            log('overall-results', 'ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        };

        // ===== åˆæœŸåŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            Stats.reset();
            log('overall-results', 'ğŸ§ª å®Œå…¨è‡ªå·±å®Œçµç‰ˆãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†', 'success');
            log('overall-results', 'ã‚¨ãƒ©ãƒ¼ãªã—ã§å‹•ä½œé–‹å§‹', 'info');
        });

    </script>
</body>
</html>