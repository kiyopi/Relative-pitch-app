<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ éŸ³åŸŸãƒ†ã‚¹ãƒˆ - 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤</text></svg>">
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
    <link rel="stylesheet" href="../../Bolt/v2/styles/base.css">
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container">
        <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="flex items-center gap-3">
                <button id="back-button" class="nav-button" title="æˆ»ã‚‹">
                    <i data-lucide="arrow-left" class="icon-md"></i>
                </button>
                <h1 class="heading-lg">
                    <i data-lucide="mic" class="text-blue-300"></i>
                    <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆ</span>
                </h1>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main>
            <!-- ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º -->
            <section class="glass-card">
                <div class="flex items-center gap-3">
                    <i data-lucide="list-checks" class="text-green-300 icon-md"></i>
                    <div>
                        <h2 class="text-section-title">éŸ³åŸŸæ¸¬å®šæº–å‚™</h2>
                        <p class="text-white-70 text-sub-text">ãƒã‚¤ã‚¯ã®æº–å‚™ãŒã§ããŸã‚‰é–‹å§‹ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </section>

            <!-- éŸ³é‡ãƒãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="volume-2" class="text-blue-300"></i>
                    <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                </h3>
                
                <!-- éŸ³é‡ãƒãƒ¼ -->
                <div class="progress-bar">
                    <div id="volume-bar" class="progress-fill gradient-catalog-green" style="width: 0%;"></div>
                </div>
                
                <!-- éŸ³é‡æƒ…å ± -->
                <div class="flex items-center gap-4">
                    <span class="text-white-70">éŸ³é‡:</span>
                    <span id="volume-text" class="text-white">0%</span>
                    <span class="text-white-70">å‘¨æ³¢æ•°:</span>
                    <span id="frequency-value" class="text-blue-300">--- Hz</span>
                    <span class="text-white-70">ãƒãƒ¼ãƒˆ:</span>
                    <span id="note-value" class="text-green-300">---</span>
                </div>
            </section>

            <!-- æ¸¬å®šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <section class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="play-circle" class="text-green-300"></i>
                    <span>æ¸¬å®šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</span>
                </h3>
                
                <div class="flex gap-3">
                    <button id="start-test-btn" class="btn btn-primary btn-w-full">
                        <i data-lucide="mic"></i>
                        <span>éŸ³åŸŸæ¸¬å®šé–‹å§‹</span>
                    </button>
                    <button id="stop-test-btn" class="btn btn-outline btn-w-full" style="display: none;">
                        <i data-lucide="square"></i>
                        <span>æ¸¬å®šåœæ­¢</span>
                    </button>
                </div>
            </section>

            <!-- æ¸¬å®šçµæœè¡¨ç¤º -->
            <section id="results-section" class="glass-card" style="display: none;">
                <h3 class="heading-md">
                    <i data-lucide="bar-chart-3" class="text-yellow-300"></i>
                    <span>æ¸¬å®šçµæœ</span>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center">
                        <h4 class="text-white-70">æœ€ä½éŸ³</h4>
                        <div id="lowest-note" class="text-section-title text-blue-300">---</div>
                        <div id="lowest-frequency" class="text-white-60">--- Hz</div>
                    </div>
                    <div class="text-center">
                        <h4 class="text-white-70">æœ€é«˜éŸ³</h4>
                        <div id="highest-note" class="text-section-title text-red-300">---</div>
                        <div id="highest-frequency" class="text-white-60">--- Hz</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <h4 class="text-white-70">éŸ³åŸŸå¹…</h4>
                    <div id="range-semitones" class="text-main-title text-green-300">--- ã‚»ãƒŸãƒˆãƒ¼ãƒ³</div>
                </div>
            </section>

            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <section id="error-section" class="glass-card" style="display: none;">
                <div class="flex items-center gap-3">
                    <i data-lucide="alert-triangle" class="text-red-300 icon-md"></i>
                    <div>
                        <h3 class="text-section-title text-red-300">ã‚¨ãƒ©ãƒ¼</h3>
                        <p id="error-message" class="text-white-70">---</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="../src/js/pitchpro-v1.2.1.umd.js"></script>
    
    <!-- TODO: å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ– /js/voice-range-test-simple.js -->
    <script>
        // PitchPro AudioDetectionComponent ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
        let audioDetector = null;
        let isTestRunning = false;
        let lowestNote = null;
        let highestNote = null;
        let lowestFreq = Infinity;
        let highestFreq = 0;

        // UIè¦ç´ ã®å–å¾—
        const elements = {
            startBtn: document.getElementById('start-test-btn'),
            stopBtn: document.getElementById('stop-test-btn'),
            volumeBar: document.getElementById('volume-bar'),
            volumeText: document.getElementById('volume-text'),
            frequencyValue: document.getElementById('frequency-value'),
            noteValue: document.getElementById('note-value'),
            resultsSection: document.getElementById('results-section'),
            errorSection: document.getElementById('error-section'),
            errorMessage: document.getElementById('error-message'),
            lowestNote: document.getElementById('lowest-note'),
            lowestFrequency: document.getElementById('lowest-frequency'),
            highestNote: document.getElementById('highest-note'),
            highestFrequency: document.getElementById('highest-frequency'),
            rangeSemitones: document.getElementById('range-semitones'),
            backButton: document.getElementById('back-button')
        };

        // AudioDetectionComponentåˆæœŸåŒ–
        async function initAudioDetection() {
            try {
                // PitchPro v1.2.1ã®AudioDetectionComponentä½¿ç”¨
                audioDetector = new PitchPro.AudioDetectionComponent({
                    volumeBarSelector: '#volume-bar',
                    volumeTextSelector: '#volume-text',
                    frequencySelector: '#frequency-value',
                    noteSelector: '#note-value',
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.01,
                    deviceOptimization: true
                });

                await audioDetector.initialize();

                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                audioDetector.setCallbacks({
                    onPitchUpdate: handlePitchUpdate,
                    onError: handleError
                });

                console.log('âœ… PitchPro v1.2.1 AudioDetectionComponentåˆæœŸåŒ–å®Œäº†');
                console.log('ğŸ”§ åˆ©ç”¨å¯èƒ½æ©Ÿèƒ½: updateSelectors(), æ”¹å–„ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°');
                return true;
            } catch (error) {
                console.error('AudioDetectionComponentåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showError('ãƒã‚¤ã‚¯ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                return false;
            }
        }

        // éŸ³ç¨‹æ¤œå‡ºçµæœå‡¦ç†
        function handlePitchUpdate(result) {
            if (!isTestRunning || !result.frequency || !result.note) return;

            const freq = result.frequency;
            
            // æœ€ä½éŸ³ãƒ»æœ€é«˜éŸ³ã‚’æ›´æ–°
            if (freq < lowestFreq) {
                lowestFreq = freq;
                lowestNote = result.note;
            }
            
            if (freq > highestFreq) {
                highestFreq = freq;
                highestNote = result.note;
            }

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§çµæœã‚’æ›´æ–°
            updateResults();
        }

        // ã‚¨ãƒ©ãƒ¼å‡¦ç†
        function handleError(error) {
            console.error('PitchPro ã‚¨ãƒ©ãƒ¼:', error);
            showError('éŸ³å£°æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            stopTest();
        }

        // æ¸¬å®šé–‹å§‹
        async function startTest() {
            if (!audioDetector) {
                const success = await initAudioDetection();
                if (!success) return;
            }

            try {
                // v1.2.1ã®æ–°æ©Ÿèƒ½: å¿…è¦ã«å¿œã˜ã¦UIã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’å‹•çš„å¤‰æ›´å¯èƒ½
                // audioDetector.updateSelectors({
                //     volumeBarSelector: '#custom-volume-bar',
                //     frequencySelector: '#custom-frequency'
                // });

                await audioDetector.startDetection();
                isTestRunning = true;
                
                // æ¸¬å®šå€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
                lowestFreq = Infinity;
                highestFreq = 0;
                lowestNote = null;
                highestNote = null;
                
                // UIåˆ‡ã‚Šæ›¿ãˆ
                elements.startBtn.style.display = 'none';
                elements.stopBtn.style.display = 'block';
                elements.resultsSection.style.display = 'block';
                elements.errorSection.style.display = 'none';
                
                console.log('éŸ³åŸŸæ¸¬å®šé–‹å§‹');
            } catch (error) {
                console.error('æ¸¬å®šé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                showError('æ¸¬å®šé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // æ¸¬å®šåœæ­¢
        function stopTest() {
            if (audioDetector) {
                audioDetector.stopDetection();
            }
            
            isTestRunning = false;
            
            // UIåˆ‡ã‚Šæ›¿ãˆ
            elements.startBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            
            console.log('éŸ³åŸŸæ¸¬å®šåœæ­¢');
        }

        // çµæœè¡¨ç¤ºæ›´æ–°
        function updateResults() {
            if (lowestNote && highestNote) {
                elements.lowestNote.textContent = lowestNote;
                elements.lowestFrequency.textContent = `${lowestFreq.toFixed(1)} Hz`;
                elements.highestNote.textContent = highestNote;
                elements.highestFrequency.textContent = `${highestFreq.toFixed(1)} Hz`;
                
                // ã‚»ãƒŸãƒˆãƒ¼ãƒ³è¨ˆç®—
                const semitones = Math.round(12 * Math.log2(highestFreq / lowestFreq));
                elements.rangeSemitones.textContent = `${semitones} ã‚»ãƒŸãƒˆãƒ¼ãƒ³`;
            }
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorSection.style.display = 'block';
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        elements.startBtn.addEventListener('click', startTest);
        elements.stopBtn.addEventListener('click', stopTest);
        elements.backButton.addEventListener('click', () => {
            if (confirm('éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’çµ‚äº†ã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
                if (audioDetector) {
                    audioDetector.destroy();
                }
                window.location.href = '../../index.html';
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // Lucide iconsåˆæœŸåŒ–
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // PitchPro v1.2.1æƒ…å ±è¡¨ç¤º
            if (typeof PitchPro !== 'undefined') {
                console.log('ğŸµ PitchPro v1.2.1 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†');
                console.log('ğŸ“‹ åˆ©ç”¨å¯èƒ½ã‚¯ãƒ©ã‚¹:', Object.keys(PitchPro));
                if (PitchPro.VERSION) {
                    console.log('ğŸ†” Version:', PitchPro.VERSION);
                }
            }

            console.log('éŸ³åŸŸãƒ†ã‚¹ãƒˆç”»é¢åˆæœŸåŒ–å®Œäº† (PitchPro v1.2.1å¯¾å¿œç‰ˆ)');
        });

        // ãƒšãƒ¼ã‚¸ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (audioDetector) {
                audioDetector.destroy();
            }
        });
    </script>
</body>
</html>