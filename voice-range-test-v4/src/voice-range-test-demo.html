<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ ãƒ‡ãƒ¢ - ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../Bolt/v2/styles/base.css">
    <link rel="stylesheet" href="../../Bolt/v2/styles/results.css">
    <link rel="stylesheet" href="../../Bolt/v2/styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-purple">
                        <i data-lucide="package" class="text-white" data-stroke-width="2" class="icon-xl"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">VoiceRangeTestController ãƒ‡ãƒ¢</h1>
                    <p class="page-subtitle text-purple-200">ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã§å®Œå…¨ãªéŸ³åŸŸãƒ†ã‚¹ãƒˆ</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- APIãƒ‡ãƒ¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="glass-card mb-6">
                <h3 class="heading-md">
                    <i data-lucide="code" class="text-blue-300"></i>
                    <span>ã‚·ãƒ³ãƒ—ãƒ«APIå‘¼ã³å‡ºã—</span>
                </h3>
                
                <div class="code-block">
                    <pre><code>// ğŸ¯ ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹
const controller = new VoiceRangeTestController({
    debugMode: true,
    onTestComplete: (results) => {
        console.log('æ¸¬å®šå®Œäº†:', results);
    }
});

await controller.startVoiceRangeTest();</code></pre>
                </div>
                
                <button class="btn btn-primary" id="start-one-method-test">
                    <i data-lucide="play" class="icon-md"></i>
                    <span>ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</span>
                </button>
            </div>
            
            <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒªã‚¢ -->
            <div class="glass-card">
                <div class="section-header">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-section-title">éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
                            <p class="section-description">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚ŒãŸçµ±åˆéŸ³åŸŸãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </p>
                        </div>
                        <!-- ãƒã‚¤ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ -->
                        <div class="mic-status-container standby" id="mic-status-container">
                            <i data-lucide="mic" id="mic-status-icon"></i>
                        </div>
                    </div>
                </div>
                
                <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="text-center mb-6">
                    <h4 class="text-sub-title main-status-display" id="main-status-text">éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„</h4>
                </div>
                
                <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒãƒƒã‚¸ -->
                <div class="range-test-layout-flex">
                    <div class="range-test-item">
                        <div class="voice-range-display-container">
                            <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                                <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                                <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16" 
                                        stroke-dasharray="452" stroke-dashoffset="452" 
                                        transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                            </svg>
                            <div class="voice-note-badge">
                                <div id="range-icon" class="icon-4xl text-white" style="display: block;">
                                    <img src="./icons/arrow-down.png" alt="åˆæœŸã‚¢ã‚¤ã‚³ãƒ³" style="width: 80px; height: 80px; display: block;">
                                </div>
                                <p class="countdown-text" id="countdown-display" style="display: none;">3</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚µãƒ–æƒ…å ± -->
                <div class="text-center mt-4">
                    <p class="text-sm text-white-70 sub-info-display" id="sub-info-text">å¾…æ©Ÿä¸­...</p>
                </div>

                <!-- æ¤œå‡ºçŠ¶æ³è¡¨ç¤º -->
                <div class="detection-meters" style="margin-top: 24px;">
                    <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                    <div class="meter-group" id="range-volume-container">
                        <div class="meter-label">
                            <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                            <span class="volume-text meter-value" id="range-test-volume-text">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill gradient-catalog-green" 
                                 id="range-test-volume-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                            <span class="meter-value" id="range-test-frequency-value">0 Hz</span>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
                <div class="text-center mt-6">
                    <button class="btn btn-primary" id="begin-range-test-btn">
                        <i data-lucide="play" class="icon-sm"></i>
                        <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</span>
                    </button>
                    
                    <button class="btn btn-outline ml-3" id="stop-range-test-btn" style="display: none;">
                        <i data-lucide="square" class="icon-sm"></i>
                        <span>ãƒ†ã‚¹ãƒˆåœæ­¢</span>
                    </button>
                </div>
            </div>
            
            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="glass-card mt-6" id="results-section" style="display: none;">
                <h3 class="heading-md">
                    <i data-lucide="bar-chart-3" class="text-green-300"></i>
                    <span>æ¸¬å®šçµæœ</span>
                </h3>
                
                <div class="result-info-container">
                    <div class="result-info-row">
                        <span>éŸ³åŸŸç¯„å›²</span>
                        <span class="result-info-value" id="result-range">-</span>
                    </div>
                    <div class="result-info-row">
                        <span>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                        <span class="result-info-value" id="result-octaves">-</span>
                    </div>
                    <div class="result-info-row">
                        <span>ä½éŸ³å‘¨æ³¢æ•°</span>
                        <span class="result-info-value" id="result-low-freq">-</span>
                    </div>
                    <div class="result-info-row">
                        <span>é«˜éŸ³å‘¨æ³¢æ•°</span>
                        <span class="result-info-value" id="result-high-freq">-</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- PitchPro v1.2.1 çµ±åˆ -->
    <script src="js/pitchpro-v1.2.1.umd.js"></script>
    
    <!-- çµ±åˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ‡ãƒ¢ -->
    <script type="module">
        import VoiceRangeTestController from './js/voice-range-test-controller.js';
        
        document.addEventListener('DOMContentLoaded', async function() {
            // PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ç¢ºèª
            console.log('ğŸ” PitchProèª­ã¿è¾¼ã¿ç¢ºèª:');
            console.log('  PitchPro:', typeof PitchPro);
            console.log('  window.PitchPro:', window.PitchPro);
            console.log('  AudioManager:', typeof AudioManager);
            console.log('  PitchDetector:', typeof PitchDetector);
            console.log('  window.AudioManager:', typeof window.AudioManager);
            console.log('  window.PitchDetector:', typeof window.PitchDetector);
            
            // PitchProã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
            if (typeof PitchPro !== 'undefined' && PitchPro) {
                console.log('  PitchPro.AudioManager:', PitchPro.AudioManager);
                console.log('  PitchPro.PitchDetector:', PitchPro.PitchDetector);
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«è¿½åŠ 
                window.AudioManager = PitchPro.AudioManager;
                window.PitchDetector = PitchPro.PitchDetector;
                console.log('âœ… PitchProã‹ã‚‰AudioManagerãƒ»PitchDetectorã‚’å–å¾—');
            }
            
            if (typeof AudioManager === 'undefined' || typeof PitchDetector === 'undefined') {
                console.error('âŒ PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                showNotification('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return;
            }
            
            // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–ï¼ˆrange-iconä»¥å¤–ï¼‰
            lucide.createIcons();
            
            let controller = null;
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨: è¡¨ç¤ºåˆ¶å¾¡ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
            window.debugBadgeDisplay = function() {
                const rangeIcon = document.getElementById('range-icon');
                const countdownDisplay = document.getElementById('countdown-display');
                console.log('ğŸ” ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹:');
                console.log('  rangeIcon.style.display:', rangeIcon.style.display);
                console.log('  rangeIcon.innerHTML:', rangeIcon.innerHTML);
                console.log('  countdownDisplay.style.display:', countdownDisplay.style.display);
                console.log('  countdownDisplay.textContent:', countdownDisplay.textContent);
            };
            
            // ğŸ¯ ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ãƒ‡ãƒ¢ãƒœã‚¿ãƒ³
            document.getElementById('start-one-method-test').addEventListener('click', async () => {
                console.log('ğŸš€ ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆé–‹å§‹');
                
                try {
                    // æ—¢å­˜ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ç ´æ£„
                    if (controller) {
                        controller.destroy();
                    }
                    
                    // UIè¦ç´ ã‚’æ‰‹å‹•ã§ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                    const rangeIcon = document.getElementById('range-icon');
                    const countdownDisplay = document.getElementById('countdown-display');
                    const badge = document.querySelector('.voice-note-badge');
                    
                    if (rangeIcon && countdownDisplay && badge) {
                        // åˆæœŸçŠ¶æ…‹ã«å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
                        rangeIcon.innerHTML = ''; // æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
                        rangeIcon.style.display = 'block';
                        countdownDisplay.style.display = 'none';
                        badge.classList.remove('measuring', 'confirmed');
                        console.log('ğŸ”„ UIè¦ç´ ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ');
                    }
                    
                    // æ–°ã—ã„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆï¼ˆå®Œå…¨ãªè¨­å®šï¼‰
                    controller = new VoiceRangeTestController({
                        debugMode: true,
                        
                        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                        onLowPitchComplete: (result) => {
                            console.log('ğŸ”½ ä½éŸ³æ¸¬å®šå®Œäº†:', result);
                            showNotification('ä½éŸ³æ¸¬å®šå®Œäº†: ' + result.note, 'success');
                            window.debugBadgeDisplay(); // ãƒ‡ãƒãƒƒã‚°ç¢ºèª
                        },
                        
                        onHighPitchComplete: (result) => {
                            console.log('ğŸ”¼ é«˜éŸ³æ¸¬å®šå®Œäº†:', result);
                            showNotification('é«˜éŸ³æ¸¬å®šå®Œäº†: ' + result.note, 'success');
                            window.debugBadgeDisplay(); // ãƒ‡ãƒãƒƒã‚°ç¢ºèª
                        },
                        
                        onTestComplete: (results) => {
                            console.log('ğŸ éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Œäº†:', results);
                            showNotification('éŸ³åŸŸæ¸¬å®šå®Œäº†ï¼', 'success');
                            displayResults(results);
                            window.debugBadgeDisplay(); // ãƒ‡ãƒãƒƒã‚°ç¢ºèª
                        },
                        
                        onError: (error) => {
                            console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
                            showNotification('ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                        }
                    });
                    
                    // ğŸ¯ ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ï¼
                    await controller.startVoiceRangeTest();
                    
                    // UIæ›´æ–°
                    document.getElementById('stop-range-test-btn').style.display = 'inline-block';
                    
                } catch (error) {
                    console.error('âŒ ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            });
            
            // é€šå¸¸ã®é–‹å§‹ãƒœã‚¿ãƒ³ï¼ˆäº’æ›æ€§ç¢ºä¿ï¼‰
            document.getElementById('begin-range-test-btn').addEventListener('click', async () => {
                document.getElementById('start-one-method-test').click();
            });
            
            // åœæ­¢ãƒœã‚¿ãƒ³
            document.getElementById('stop-range-test-btn').addEventListener('click', () => {
                if (controller) {
                    controller.stopTest();
                    showNotification('ãƒ†ã‚¹ãƒˆåœæ­¢', 'info');
                    document.getElementById('stop-range-test-btn').style.display = 'none';
                }
            });
            
            // çµæœè¡¨ç¤ºé–¢æ•°
            function displayResults(results) {
                document.getElementById('result-range').textContent = results.range || '-';
                document.getElementById('result-octaves').textContent = results.octaves ? `${results.octaves}ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–` : '-';
                document.getElementById('result-low-freq').textContent = results.lowPitch ? `${results.lowPitch.frequency.toFixed(1)} Hz (${results.lowPitch.note})` : '-';
                document.getElementById('result-high-freq').textContent = results.highPitch ? `${results.highPitch.frequency.toFixed(1)} Hz (${results.highPitch.note})` : '-';
                
                document.getElementById('results-section').style.display = 'block';
                document.getElementById('stop-range-test-btn').style.display = 'none';
            }
            
            // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
            function showNotification(message, type = 'info') {
                const colors = {
                    success: '#10b981',
                    error: '#ef4444', 
                    info: '#3b82f6'
                };
                
                console.log(`%c${message}`, `color: ${colors[type]}; font-weight: bold;`);
            }
            
            console.log('âœ… VoiceRangeTestController ãƒ‡ãƒ¢æº–å‚™å®Œäº†');
            console.log('ğŸ¯ ã€Œãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„');
            console.log('ğŸ”§ ãƒ‡ãƒãƒƒã‚°ç”¨: window.debugBadgeDisplay() ã§è¡¨ç¤ºçŠ¶æ…‹ç¢ºèª');
        });
    </script>
</body>
</html>