<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro v1.1.9 製品レベル統合管理テスト</title>
    
    <!-- 本番スタイルシート使用 -->
    <link rel="stylesheet" href="../../Bolt/v2/styles/base.css">
    
    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- アイコンライブラリ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container max-w-4xl mx-auto">
            <!-- ヘッダー -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">🎉 PitchPro v1.1.9 製品レベル到達</h1>
                <p class="text-yellow-200 text-lg">統合管理システム・4ボタンUI・完全なMicrophoneController対応</p>
            </header>

            <!-- v1.1.9製品レベル到達機能 -->
            <div class="glass-card mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="award" class="text-gold-300 icon-md"></i>
                    <h3 class="heading-md text-gold-300">v1.1.9 製品レベル到達機能</h3>
                </div>
                <ul class="text-white-70 space-y-2">
                    <li class="flex items-center gap-2">
                        <i data-lucide="check" class="text-green-300 icon-sm"></i>
                        <span><strong>統合start()メソッド</strong> - ミュート解除+検出開始の一括実行</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="check" class="text-green-300 icon-sm"></i>
                        <span><strong>4ボタンUI</strong> - 7→4ボタン（42%削減）の直感的操作</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="check" class="text-green-300 icon-sm"></i>
                        <span><strong>対称的操作設計</strong> - reset()⇄start()の完全対応</span>
                    </li>
                    <li class="flex items-center gap-2">
                        <i data-lucide="check" class="text-green-300 icon-sm"></i>
                        <span><strong>MicrophoneController統合管理</strong> - AudioDetectionComponent自動登録</span>
                    </li>
                </ul>
            </div>
            
            <!-- システム状態 -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="activity" class="text-blue-300"></i>
                    <span>システム状態</span>
                </h3>
                <div id="system-status" class="status-card mb-4">初期化前...</div>
                
                <div class="flex gap-3 flex-wrap">
                    <button id="init-btn" class="btn btn-primary">
                        <i data-lucide="mic" class="icon-sm"></i>
                        <span>初期化</span>
                    </button>
                    <button id="start-btn" class="btn btn-success" disabled>
                        <i data-lucide="play" class="icon-sm"></i>
                        <span>検出開始</span>
                    </button>
                    <button id="stop-btn" class="btn btn-outline" disabled>
                        <i data-lucide="stop-circle" class="icon-sm"></i>
                        <span>検出停止</span>
                    </button>
                </div>
            </div>
            
            <!-- モード切り替えコントロール -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="repeat" class="text-green-300"></i>
                    <span>モード切り替え（v1.1.8対応）</span>
                </h3>
                <div class="info-card mb-4">
                    <h4 class="text-white font-medium mb-2">🔧 PitchDetector + MicrophoneController 統合管理</h4>
                    <p class="text-white-70">v1.1.8では分離されたコンポーネントを統合管理して、UI要素を完全分離します。</p>
                </div>
                
                <div class="flex gap-3 flex-wrap">
                    <button id="mic-mode-btn" class="btn btn-outline" disabled>
                        <i data-lucide="mic" class="icon-sm"></i>
                        <span>マイクテスト</span>
                    </button>
                    <button id="range-mode-btn" class="btn btn-outline" disabled>
                        <i data-lucide="music" class="icon-sm"></i>
                        <span>音域テスト</span>
                    </button>
                    <button id="practice-mode-btn" class="btn btn-outline" disabled>
                        <i data-lucide="headphones" class="icon-sm"></i>
                        <span>練習モード</span>
                    </button>
                </div>
            </div>
            
            <!-- マイクテストモードUI -->
            <div class="glass-card mb-6" id="mic-mode-section">
                <h3 class="heading-md mb-4">
                    <i data-lucide="mic" class="text-blue-300"></i>
                    <span>マイクテストモード</span>
                </h3>
                <div class="volume-meter">
                    <div class="flex items-center justify-between mb-2 w-full">
                        <span class="text-white-70">マイク音量</span>
                        <span id="mic-volume-text" class="text-white font-medium">0.0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-blue" id="mic-volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <div class="frequency-display text-2xl font-bold text-blue-300 bg-black bg-opacity-30 px-4 py-2 rounded-lg inline-block" id="mic-frequency">0 Hz</div>
                </div>
            </div>
            
            <!-- 音域テストモードUI -->
            <div class="glass-card mb-6" id="range-mode-section">
                <h3 class="heading-md mb-4">
                    <i data-lucide="music" class="text-green-300"></i>
                    <span>音域テストモード</span>
                </h3>
                <div class="volume-meter">
                    <div class="flex items-center justify-between mb-2 w-full">
                        <span class="text-white-70">測定音量</span>
                        <span id="range-volume-text" class="text-white font-medium">0.0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="range-volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <div class="frequency-display text-2xl font-bold text-green-300 bg-black bg-opacity-30 px-4 py-2 rounded-lg inline-block" id="range-frequency">0 Hz</div>
                </div>
            </div>
            
            <!-- 練習モードUI -->
            <div class="glass-card mb-6" id="practice-mode-section">
                <h3 class="heading-md mb-4">
                    <i data-lucide="headphones" class="text-orange-300"></i>
                    <span>練習モード</span>
                </h3>
                <div class="volume-meter">
                    <div class="flex items-center justify-between mb-2 w-full">
                        <span class="text-white-70">練習音量</span>
                        <span id="practice-volume-text" class="text-white font-medium">0.0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-orange" id="practice-volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-4 mt-4">
                    <div class="frequency-display text-2xl font-bold text-orange-300 bg-black bg-opacity-30 px-4 py-2 rounded-lg" id="practice-frequency">0 Hz</div>
                    <div class="note-display text-xl font-bold text-yellow-300 bg-black bg-opacity-30 px-4 py-2 rounded-lg" id="practice-note">-</div>
                </div>
            </div>
            
            <!-- ログ出力 -->
            <div class="glass-card">
                <h3 class="heading-md mb-4">
                    <i data-lucide="file-text" class="text-white-70"></i>
                    <span>ログ出力</span>
                </h3>
                <div id="log-output" class="bg-black bg-opacity-50 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm"></div>
            </div>
        </div>
    </div>

    <!-- PitchPro v1.1.9 最新版UMDライブラリ -->
    <script src="../../js/pitchpro-audio/pitchpro-v1.1.9-latest.umd.js"></script>
    <script>
        // UMD版の読み込み確認
        if (typeof PitchPro !== 'undefined') {
            console.log('🎉 PitchPro v1.1.9 製品レベル到達版 UMD loaded successfully');
            console.log('Version:', PitchPro.VERSION);
            console.log('Build Date:', PitchPro.BUILD_DATE);
            console.log('利用可能なクラス:', Object.keys(PitchPro));
            console.log('🏆 v1.1.9製品レベル統合管理システム対応版');
            
            console.log('🔍 v1.1.9統合管理システム機能:');
            console.log('  - 統合start()メソッド: ミュート解除+検出開始一括');
            console.log('  - 4ボタンUI: 7→4ボタン（42%削減）の直感的操作');
            console.log('  - 対称的操作: reset()⇄start()完全対応');
            console.log('  - MicrophoneController統合管理システム');
            
            // 利用可能コンポーネント確認
            console.log('🔍 利用可能コンポーネント:');
            console.log('  - PitchDetector:', !!PitchPro.PitchDetector);
            console.log('  - MicrophoneController:', !!PitchPro.MicrophoneController);
            console.log('  - AudioManager:', !!PitchPro.AudioManager);
            console.log('  - AudioDetectionComponent:', !!PitchPro.AudioDetectionComponent);
            
            // PitchPro読み込み完了を通知
            window.pitchProLoaded = true;
            window.dispatchEvent(new CustomEvent('pitchpro-loaded', { detail: PitchPro }));
        } else {
            console.error('❌ PitchPro UMD failed to load');
        }
    </script>
    
    <!-- TODO: 外部ファイル化 /js/pitchpro-v118-controller.js -->
    <script>
        // グローバル変数宣言
        let microphoneController = null;
        let pitchDetector = null;
        let currentMode = 'mic';
        let logLines = [];
        let isDetecting = false;
        
        // DOM要素取得
        const logContainer = document.getElementById('log-output');
        
        // PitchPro v1.1.8の読み込み確認
        if (typeof PitchPro !== 'undefined') {
            console.log('✅ PitchPro v1.1.8ライブラリ読み込み成功');
            console.log('利用可能なクラス:', Object.keys(PitchPro));
            console.log('🎯 v1.1.8新アーキテクチャテストモード実行中');
            
            // メインシステム初期化
            
            // Lucide初期化
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // ログ出力システム
            function log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                logLines.push(`[${timestamp}] ${message}`);
                if (logLines.length > 100) logLines.shift();
                
                const logEntry = document.createElement('div');
                logEntry.className = `text-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-300 mb-1`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logContainer.innerHTML = logLines.map(line => {
                    const logType = line.includes('❌') ? 'red' : line.includes('✅') ? 'green' : 'blue';
                    return `<div class="text-${logType}-300 mb-1">${line}</div>`;
                }).join('');
                logContainer.scrollTop = logContainer.scrollHeight;
                
                console.log(`%c${message}`, `color: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'}`);
            }
            
            // ステータス更新
            function updateStatus(message, type = 'info') {
                const statusDiv = document.getElementById('system-status');
                statusDiv.className = `status-card text-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-300`;
                statusDiv.textContent = message;
            }
            
            // UI切り替え（本番スタイル準拠）
            function updateModeUI(mode) {
                // すべてのセクションのアクティブ状態をリセット
                document.querySelectorAll('[id$="-mode-section"]').forEach(section => {
                    section.classList.remove('border-green-300');
                    section.style.borderColor = '';
                });
                
                // ボタン状態更新
                document.querySelectorAll('[id$="-mode-btn"]').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                });
                
                // 現在のモードをアクティブに
                const activeSection = document.getElementById(`${mode}-mode-section`);
                const activeButton = document.getElementById(`${mode}-mode-btn`);
                
                if (activeSection) {
                    activeSection.classList.add('border-green-300');
                    activeSection.style.borderColor = '#22c55e';
                }
                if (activeButton) {
                    activeButton.classList.remove('btn-outline');
                    activeButton.classList.add('btn-primary');
                }
                
                currentMode = mode;
                log(`🔄 ${mode}モードに切り替え（v1.1.8新アーキテクチャ）`, 'info');
            }
            
            // UI要素の完全リセット
            function resetAllUIElements() {
                // すべての音量バーとテキストをリセット
                ['mic', 'range', 'practice'].forEach(mode => {
                    const volumeBar = document.getElementById(`${mode}-volume-bar`);
                    const volumeText = document.getElementById(`${mode}-volume-text`);
                    const frequencyDisplay = document.getElementById(`${mode}-frequency`);
                    
                    if (volumeBar) {
                        // 🔧 CSS設定をリセット
                        volumeBar.style.width = '0%';
                        // minWidthとmaxWidthを削除（初期値に戻す）
                        volumeBar.style.minWidth = '';
                        volumeBar.style.maxWidth = '';
                        volumeBar.style.flexShrink = '';
                    }
                    if (volumeText) volumeText.textContent = '0.0%';
                    if (frequencyDisplay) {
                        frequencyDisplay.textContent = '0 Hz';
                    }
                });
                
                // 練習モードの音程表示もリセット
                const practiceNote = document.getElementById('practice-note');
                if (practiceNote) practiceNote.textContent = '-';
                
                log('🧹 全UI要素リセット完了（CSS強制設定クリア含む）', 'info');
            }
            
            // 現在のモード用UI要素の取得
            function getCurrentModeElements() {
                const prefix = currentMode === 'practice' ? 'practice' : 
                              currentMode === 'range' ? 'range' : 'mic';
                
                return {
                    volumeBar: document.getElementById(`${prefix}-volume-bar`),
                    volumeText: document.getElementById(`${prefix}-volume-text`),
                    frequencyDisplay: document.getElementById(`${prefix}-frequency`),
                    noteDisplay: prefix === 'practice' ? document.getElementById('practice-note') : null
                };
            }
            
            // UI更新関数
            function updateUI(result) {
                const elements = getCurrentModeElements();
                
                // 🔍 詳細デバッグ: 音量の同期問題調査
                if (Math.random() < 0.1) { // 10%の確率でログ
                    console.group(`🔍 UI更新デバッグ [${currentMode}モード]`);
                    console.log('📊 result全体:', result);
                    console.log('🔊 result.volume値:', result.volume);
                    console.log('📈 typeof result.volume:', typeof result.volume);
                    console.log('🎯 現在のモード:', currentMode);
                    console.log('📍 取得した要素:', {
                        volumeBar: elements.volumeBar?.id,
                        volumeText: elements.volumeText?.id,
                        frequencyDisplay: elements.frequencyDisplay?.id
                    });
                }
                
                if (elements.volumeBar) {
                    // PitchProのデフォルト値をそのまま使用
                    const volumePercent = result.volume || 0;
                    elements.volumeBar.style.width = `${volumePercent}%`;
                    
                    if (Math.random() < 0.1) {
                        console.log(`💉 volumeBar設定: width="${volumePercent}%"`);
                        console.log(`📏 実際のDOM width:`, elements.volumeBar.style.width);
                    }
                }
                if (elements.volumeText) {
                    // PitchProのデフォルト値をそのまま表示
                    const volumeTextValue = (result.volume || 0).toFixed(1);
                    elements.volumeText.textContent = `${volumeTextValue}%`;
                    
                    if (Math.random() < 0.1) {
                        console.log(`📝 volumeText設定: "${volumeTextValue}%"`);
                        console.log(`📄 実際のDOM text:`, elements.volumeText.textContent);
                    }
                }
                if (elements.frequencyDisplay) {
                    // 周波数表示（pitchまたはfrequencyプロパティ）
                    const frequency = result.pitch || result.frequency || 0;
                    elements.frequencyDisplay.textContent = `${frequency.toFixed(1)} Hz`;
                }
                if (elements.noteDisplay && result.note) {
                    elements.noteDisplay.textContent = result.note;
                }
                
                if (Math.random() < 0.1) {
                    console.groupEnd();
                }
            }
            
            // 初期化
            document.getElementById('init-btn').addEventListener('click', async () => {
                try {
                    updateStatus('初期化中...', 'info');
                    log('🎤 v1.1.8 新アーキテクチャ初期化開始', 'info');
                    
                    // MicrophoneControllerを初期化
                    microphoneController = new PitchPro.MicrophoneController();
                    await microphoneController.initialize();
                    log('✅ MicrophoneController初期化完了', 'success');
                    
                    // PitchDetectorを初期化（完全デフォルト値使用）
                    const audioManager = microphoneController.audioManager;
                    pitchDetector = new PitchPro.PitchDetector(audioManager);
                    // ⚠️ 重要: カスタム設定なし、デフォルト値のみ使用
                    
                    await pitchDetector.initialize();
                    log('✅ PitchDetector初期化完了（デフォルト設定）', 'success');
                    
                    // 🎯 重要: PitchDetectorをMicrophoneControllerに登録
                    microphoneController.registerDetector(pitchDetector);
                    log('✅ PitchDetector → MicrophoneController 登録完了', 'success');
                    log('🔗 v1.1.9統合管理システム準備完了', 'success');
                    
                    // コールバック設定
                    pitchDetector.setCallbacks({
                        onPitchUpdate: (result) => {
                            updateUI(result);
                            
                            // 練習モードの音程表示更新を監視
                            if (currentMode === 'practice' && result.frequency > 0) {
                                const practiceNote = document.querySelector('#practice-note');
                                if (practiceNote && Math.random() < 0.05) { // 5%の確率でログ
                                    log(`🎼 練習モード音程更新: ${result.frequency?.toFixed(1)}Hz → DOM: "${practiceNote.textContent}"`, 'info');
                                }
                            }
                            
                            // 🔍 result object debug - 全プロパティを詳細ログ（2%の確率）
                            if (Math.random() < 0.02) {
                                console.group('🔍 PitchPro Result Object Analysis');
                                console.log('📊 Full result object:', result);
                                console.log('📋 Available properties:', Object.keys(result));
                                console.log('🎵 result.frequency:', result.frequency);
                                console.log('🔊 result.volume:', result.volume);
                                console.log('📈 result.stableVolume:', result.stableVolume);
                                console.log('💾 result.volumePercent:', result.volumePercent);
                                console.log('🎯 result.rawVolume:', result.rawVolume);
                                console.log('📊 result.normalizedVolume:', result.normalizedVolume);
                                console.groupEnd();
                                
                                log(`🎵 ${result.frequency?.toFixed(1) || 0}Hz, 音量分析: volume=${result.volume?.toFixed(1) || 0}%, stableVolume=${result.stableVolume?.toFixed(1) || 0}%, volumePercent=${result.volumePercent?.toFixed(1) || 0}%`, 'info');
                            }
                        },
                        onError: (error) => {
                            log(`❌ エラー: ${error.message}`, 'error');
                            updateStatus(`エラー: ${error.message}`, 'error');
                        },
                        onStateChange: (state) => {
                            log(`🔄 状態変化: ${state}`, 'info');
                        }
                    });
                    
                    updateStatus('初期化完了', 'success');
                    log('✅ v1.1.8新アーキテクチャ初期化完了', 'success');
                    log('ℹ️ PitchDetector + MicrophoneController統合管理', 'success');
                    
                    // ボタン状態更新
                    document.getElementById('init-btn').disabled = true;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('mic-mode-btn').disabled = false;
                    document.getElementById('range-mode-btn').disabled = false;
                    document.getElementById('practice-mode-btn').disabled = false;
                    
                    // デフォルトでマイクモード
                    updateModeUI('mic');
                    
                } catch (error) {
                    log(`❌ 初期化エラー: ${error.message}`, 'error');
                    updateStatus(`初期化エラー: ${error.message}`, 'error');
                }
            });
            
            // 統合検出開始ボタン（v1.1.9新機能）
            document.getElementById('start-btn').addEventListener('click', async () => {
                if (!microphoneController) return;
                
                try {
                    log('🚀 統合start()実行（v1.1.9製品レベル機能）', 'info');
                    log('  - ミュート解除 + 検出開始の一括実行', 'info');
                    
                    // v1.1.9の統合start()メソッド使用
                    const started = microphoneController.start();
                    
                    if (started) {
                        isDetecting = true;
                        updateStatus('🎤 音声検出中...', 'success');
                        document.getElementById('start-btn').disabled = true;
                        document.getElementById('stop-btn').disabled = false;
                        log('✅ 統合start()完了 - ミュート解除+検出開始', 'success');
                    } else {
                        log('❌ 統合start()に失敗', 'error');
                    }
                } catch (error) {
                    log(`❌ 統合start()エラー: ${error.message}`, 'error');
                }
            });
            
            // 統合検出停止ボタン（v1.1.9統合管理）
            document.getElementById('stop-btn').addEventListener('click', () => {
                if (!microphoneController) return;
                
                try {
                    log('🛑 統合reset()実行（v1.1.9製品レベル機能）', 'info');
                    log('  - システム完全停止 + UIリセットの一括実行', 'info');
                    
                    microphoneController.reset();
                    isDetecting = false;
                    
                    updateStatus('音声検出停止', 'info');
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('stop-btn').disabled = true;
                    log('✅ 統合reset()完了 - システム完全停止+UIリセット', 'success');
                    
                } catch (error) {
                    log(`❌ 統合reset()エラー: ${error.message}`, 'error');
                }
            });
            
            // モード切り替え関数（v1.1.9統合管理対応）
            async function switchMode(mode) {
                log(`🔘 ${mode}モードボタンがクリックされました`, 'info');
                
                if (!microphoneController) {
                    log('❌ MicrophoneControllerが初期化されていません', 'error');
                    return;
                }
                
                try {
                    log(`🔄 ${mode}モードに切り替え中（v1.1.9統合管理システム）...`, 'info');
                    
                    // 検出中かどうかを記録
                    const wasDetecting = isDetecting;
                    
                    // v1.1.9統合reset()メソッドでシステム完全停止
                    log('🛑 統合reset()実行中...', 'info');
                    microphoneController.reset();
                    isDetecting = false;
                    log('✅ 統合reset()完了 - システム完全停止+UIリセット', 'success');
                    
                    // モードUI更新
                    updateModeUI(mode);
                    
                    // 必要に応じて統合start()で復帰
                    if (wasDetecting) {
                        setTimeout(() => {
                            log('🚀 統合start()で完全復帰中...', 'info');
                            const restarted = microphoneController.start();
                            if (restarted) {
                                isDetecting = true;
                                log('✅ 統合start()完了 - 完全復帰', 'success');
                            } else {
                                log('❌ 統合start()復帰に失敗', 'error');
                            }
                        }, 200);
                    }
                    
                    log(`✅ ${mode}モードに切り替え完了（v1.1.9統合管理）`, 'success');
                    log(`🎯 統合reset()→start()による完全なモード分離`, 'info');
                    
                } catch (error) {
                    log(`❌ ${mode}モード切り替えエラー: ${error.message}`, 'error');
                }
            }
            
            // マイクテストモード
            document.getElementById('mic-mode-btn').addEventListener('click', () => {
                switchMode('mic');
            });
            
            // 音域テストモード
            document.getElementById('range-mode-btn').addEventListener('click', () => {
                switchMode('range');
            });
            
            // 練習モード
            document.getElementById('practice-mode-btn').addEventListener('click', () => {
                switchMode('practice');
            });
            
            // 初期ログ
            log('✅ PitchPro v1.1.8新アーキテクチャテスト準備完了', 'success');
            log('🎯 PitchDetector + MicrophoneController分離アーキテクチャ対応', 'success');
            log('手順: 1) 初期化 → 2) 検出開始 → 3) モード切り替えテスト', 'info');
            updateStatus('準備完了 - 初期化ボタンをクリック', 'success');
            
            // デフォルトでマイクモード表示
            updateModeUI('mic');
            
        } else {
            console.error('❌ PitchPro v1.1.8ライブラリが読み込まれていません');
            alert('PitchPro v1.1.8ライブラリの読み込みに失敗しました。ページを再読み込みしてください。');
        }
    </script>
</body>
</html>