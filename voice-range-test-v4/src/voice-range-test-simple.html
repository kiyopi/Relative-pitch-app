<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎤 音域テスト - 8va相対音感トレーニング</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎤</text></svg>">
    
    <!-- スタイルシート -->
    <link rel="stylesheet" href="../../Bolt/v2/styles/base.css">
    
    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- メインコンテナ -->
    <div class="container">
        <!-- ページヘッダー -->
        <header class="page-header">
            <div class="flex items-center gap-3">
                <button id="back-button" class="nav-button" title="戻る">
                    <i data-lucide="arrow-left" class="icon-md"></i>
                </button>
                <h1 class="heading-lg">
                    <i data-lucide="mic" class="text-blue-300"></i>
                    <span>音域テスト</span>
                </h1>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main>
            <!-- ステップ表示 -->
            <section class="glass-card">
                <div class="flex items-center gap-3">
                    <i data-lucide="list-checks" class="text-green-300 icon-md"></i>
                    <div>
                        <h2 class="text-section-title">音域測定準備</h2>
                        <p class="text-white-70 text-sub-text">マイクの準備ができたら開始してください</p>
                    </div>
                </div>
            </section>

            <!-- 音量バーセクション -->
            <section class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="volume-2" class="text-blue-300"></i>
                    <span>音量レベル</span>
                </h3>
                
                <!-- 音量バー -->
                <div class="progress-bar">
                    <div id="volume-bar" class="progress-fill gradient-catalog-green" style="width: 0%;"></div>
                </div>
                
                <!-- 音量情報 -->
                <div class="flex items-center gap-4">
                    <span class="text-white-70">音量:</span>
                    <span id="volume-text" class="text-white">0%</span>
                    <span class="text-white-70">周波数:</span>
                    <span id="frequency-value" class="text-blue-300">--- Hz</span>
                    <span class="text-white-70">ノート:</span>
                    <span id="note-value" class="text-green-300">---</span>
                </div>
            </section>

            <!-- 測定ステップ表示 -->
            <section class="glass-card">
                <h3 class="heading-md">
                    <i id="step-icon" data-lucide="play-circle" class="text-green-300"></i>
                    <span id="step-title">測定準備</span>
                </h3>
                
                <div id="step-description" class="text-white-70 text-sub-text">
                    音域測定を開始する準備をしています
                </div>
                
                <!-- 測定プログレス -->
                <div id="measurement-progress" class="progress-bar" style="display: none;">
                    <div id="measurement-progress-fill" class="progress-fill gradient-catalog-blue" style="width: 0%;"></div>
                </div>
                
                <!-- カウントダウン表示 -->
                <div id="countdown-display" style="display: none; text-align: center;">
                    <div id="countdown-number" class="text-main-title text-yellow-300">3</div>
                    <div class="text-white-70">秒後に開始</div>
                </div>
                
                <div class="flex gap-3">
                    <button id="start-test-btn" class="btn btn-primary btn-w-full">
                        <i data-lucide="mic"></i>
                        <span>音域測定開始</span>
                    </button>
                    <button id="stop-test-btn" class="btn btn-outline btn-w-full" style="display: none;">
                        <i data-lucide="square"></i>
                        <span>測定停止</span>
                    </button>
                </div>
            </section>

            <!-- 測定結果表示 -->
            <section id="results-section" class="glass-card" style="display: none;">
                <h3 class="heading-md">
                    <i data-lucide="bar-chart-3" class="text-yellow-300"></i>
                    <span>測定結果</span>
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center">
                        <h4 class="text-white-70">最低音</h4>
                        <div id="lowest-note" class="text-section-title text-blue-300">---</div>
                        <div id="lowest-frequency" class="text-white-60">--- Hz</div>
                    </div>
                    <div class="text-center">
                        <h4 class="text-white-70">最高音</h4>
                        <div id="highest-note" class="text-section-title text-red-300">---</div>
                        <div id="highest-frequency" class="text-white-60">--- Hz</div>
                    </div>
                </div>
                
                <div class="text-center">
                    <h4 class="text-white-70">音域幅</h4>
                    <div id="range-semitones" class="text-main-title text-green-300">--- セミトーン</div>
                </div>
            </section>

            <!-- エラーメッセージ -->
            <section id="error-section" class="glass-card" style="display: none;">
                <div class="flex items-center gap-3">
                    <i data-lucide="alert-triangle" class="text-red-300 icon-md"></i>
                    <div>
                        <h3 class="text-section-title text-red-300">エラー</h3>
                        <p id="error-message" class="text-white-70">---</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="js/pitchpro-v1.3.0.umd.js"></script>
    
    <!-- TODO: 外部ファイル化 /js/voice-range-test-simple.js -->
    <script>
        // 測定状態の定義
        const TestPhase = {
            READY: 'ready',
            MIC_INIT: 'mic_init',
            LOW_PREPARE: 'low_prepare',
            LOW_MEASURING: 'low_measuring',
            INTERVAL: 'interval',
            HIGH_PREPARE: 'high_prepare', 
            HIGH_MEASURING: 'high_measuring',
            COMPLETED: 'completed'
        };

        // PitchPro AudioDetectionComponent インスタンス
        let audioDetector = null;
        let currentPhase = TestPhase.READY;
        let isTestRunning = false;
        
        // 測定結果データ
        let lowestNote = null;
        let highestNote = null;
        let lowestFreq = Infinity;
        let highestFreq = 0;
        
        // 安定性測定用変数
        let stabilityStartTime = null;
        let stabilityBuffer = [];
        let stabilityThreshold = 15; // ±15Hz以内（実用的な範囲）
        let stabilityDuration = 3000; // 3秒間

        // UI要素の取得
        const elements = {
            startBtn: document.getElementById('start-test-btn'),
            stopBtn: document.getElementById('stop-test-btn'),
            volumeBar: document.getElementById('volume-bar'),
            volumeText: document.getElementById('volume-text'),
            frequencyValue: document.getElementById('frequency-value'),
            noteValue: document.getElementById('note-value'),
            resultsSection: document.getElementById('results-section'),
            errorSection: document.getElementById('error-section'),
            errorMessage: document.getElementById('error-message'),
            lowestNote: document.getElementById('lowest-note'),
            lowestFrequency: document.getElementById('lowest-frequency'),
            highestNote: document.getElementById('highest-note'),
            highestFrequency: document.getElementById('highest-frequency'),
            rangeSemitones: document.getElementById('range-semitones'),
            backButton: document.getElementById('back-button'),
            // 新しいUI要素
            stepIcon: document.getElementById('step-icon'),
            stepTitle: document.getElementById('step-title'),
            stepDescription: document.getElementById('step-description'),
            measurementProgress: document.getElementById('measurement-progress'),
            measurementProgressFill: document.getElementById('measurement-progress-fill'),
            countdownDisplay: document.getElementById('countdown-display'),
            countdownNumber: document.getElementById('countdown-number')
        };

        // UI状態更新
        function updateStepUI(phase, progress = 0) {
            currentPhase = phase;
            
            const stepConfig = {
                [TestPhase.READY]: {
                    icon: 'play-circle',
                    iconColor: 'text-green-300',
                    title: '測定準備',
                    description: '音域測定を開始する準備をしています'
                },
                [TestPhase.MIC_INIT]: {
                    icon: 'mic',
                    iconColor: 'text-blue-300', 
                    title: 'マイク許可',
                    description: 'マイクへのアクセスを許可してください'
                },
                [TestPhase.LOW_PREPARE]: {
                    icon: 'arrow-down',
                    iconColor: 'text-blue-300',
                    title: '低音を測定します',
                    description: 'マイクに向かって低い声を出してください'
                },
                [TestPhase.LOW_MEASURING]: {
                    icon: 'circle',
                    iconColor: 'text-blue-300',
                    title: '低音測定中',
                    description: '安定した低音を3秒間保持してください'
                },
                [TestPhase.INTERVAL]: {
                    icon: 'clock',
                    iconColor: 'text-yellow-300',
                    title: 'インターバル',
                    description: '次の測定まで少しお待ちください'
                },
                [TestPhase.HIGH_PREPARE]: {
                    icon: 'arrow-up',
                    iconColor: 'text-red-300',
                    title: '高音を測定します',
                    description: 'マイクに向かって高い声を出してください'
                },
                [TestPhase.HIGH_MEASURING]: {
                    icon: 'circle',
                    iconColor: 'text-red-300',
                    title: '高音測定中',
                    description: '安定した高音を3秒間保持してください'
                },
                [TestPhase.COMPLETED]: {
                    icon: 'check-circle',
                    iconColor: 'text-green-300',
                    title: '測定完了',
                    description: '音域測定が完了しました'
                }
            };
            
            const config = stepConfig[phase];
            if (config) {
                elements.stepIcon.setAttribute('data-lucide', config.icon);
                elements.stepIcon.className = `${config.iconColor} icon-md`;
                elements.stepTitle.textContent = config.title;
                elements.stepDescription.textContent = config.description;
                
                // Lucideアイコンを再描画
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            // プログレスバーの表示制御
            if (phase === TestPhase.LOW_MEASURING || phase === TestPhase.HIGH_MEASURING) {
                elements.measurementProgress.style.display = 'block';
                elements.measurementProgressFill.style.width = `${progress}%`;
            } else {
                elements.measurementProgress.style.display = 'none';
            }
        }

        // AudioDetectionComponent初期化
        async function initAudioDetection() {
            try {
                updateStepUI(TestPhase.MIC_INIT);

                // PitchPro v1.3.0 確実動作版（setCallbacks()問題対応）

                audioDetector = new PitchPro.AudioDetectionComponent({
                    // volumeBarSelector: '#volume-bar',     // UI自動更新を無効化
                    // volumeTextSelector: '#volume-text',   // UI自動更新を無効化
                    frequencySelector: '#frequency-value',
                    noteSelector: '#note-value',
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003, // CLAUDE.mdの推奨値
                    deviceOptimization: true,
                    autoUpdateUI: false,  // v1.3.0の機能：UI自動更新を明示的に無効化
                    debugMode: true,
                    // v1.3.0確実動作版: コンストラクタでコールバック設定
                    onPitchUpdate: (result) => {
                        // 📊 主要ログのみ表示（10%の確率）
                        if (Math.random() < 0.1) {
                            console.log('🎯 Volume:', Math.round(result.volume) + '%', 'Freq:', Math.round(result.frequency || 0) + 'Hz');
                        }

                        // v1.3.0の修正確認: volume値が0-100%の予測可能な範囲内か
                        if (result.volume !== undefined) {
                            const isValidRange = result.volume >= 0 && result.volume <= 100;

                            // ❌ 範囲外の値のみログ表示
                            if (!isValidRange) {
                                console.error('❌ Volume範囲エラー:', result.volume + '%');
                            }

                            // 🔧 手動UI更新（PitchProの正確な値を直接使用）
                            const volumeBar = document.getElementById('volume-bar');
                            const volumeText = document.getElementById('volume-text');

                            if (volumeBar) {
                                volumeBar.style.width = result.volume + '%';
                            }
                            if (volumeText) {
                                volumeText.textContent = Math.round(result.volume) + '%';
                            }
                        }

                        handlePitchUpdate(result);
                    },
                    onError: handleError
                });

                await audioDetector.initialize();

                console.log('AudioDetectionComponent初期化完了');
                return true;
            } catch (error) {
                console.error('AudioDetectionComponent初期化エラー:', error);
                showError('マイクの初期化に失敗しました: ' + error.message);
                return false;
            }
        }

        // 安定性判定ロジック
        function checkStability(frequency) {
            const now = Date.now();
            
            // バッファに新しい周波数を追加
            stabilityBuffer.push({ frequency, timestamp: now });
            
            // 古いデータを削除（1秒以上古いもの）
            stabilityBuffer = stabilityBuffer.filter(item => now - item.timestamp <= 1000);
            
            if (stabilityBuffer.length < 10) return false; // 最低10サンプル必要
            
            // 平均周波数を計算
            const avgFreq = stabilityBuffer.reduce((sum, item) => sum + item.frequency, 0) / stabilityBuffer.length;
            
            // 全てのサンプルが閾値以内か確認
            const isStable = stabilityBuffer.every(item => 
                Math.abs(item.frequency - avgFreq) <= stabilityThreshold
            );
            
            if (isStable && !stabilityStartTime) {
                // 安定開始
                stabilityStartTime = now;
                console.log(`安定開始: ${avgFreq.toFixed(1)}Hz`);
            } else if (!isStable && stabilityStartTime) {
                // 不安定になった
                stabilityStartTime = null;
                stabilityBuffer = [];
                console.log('不安定 - リセット');
            }
            
            return { isStable, avgFreq, duration: stabilityStartTime ? now - stabilityStartTime : 0 };
        }
        
        // 音程検出結果処理
        function handlePitchUpdate(result) {
            if (!isTestRunning || !result.frequency || !result.note) return;

            const freq = result.frequency;
            
            // 現在のフェーズに応じた処理
            if (currentPhase === TestPhase.LOW_MEASURING) {
                const stability = checkStability(freq);
                
                if (stability.isStable && stability.duration >= stabilityDuration) {
                    // 低音測定完了
                    lowestFreq = stability.avgFreq;
                    lowestNote = result.note;
                    console.log(`低音測定完了: ${lowestNote} (${lowestFreq.toFixed(1)}Hz)`);
                    
                    // インターバルフェーズに移行
                    startIntervalPhase();
                } else if (stability.isStable) {
                    // 進捗表示
                    const progress = (stability.duration / stabilityDuration) * 100;
                    updateStepUI(TestPhase.LOW_MEASURING, progress);
                }
                
            } else if (currentPhase === TestPhase.HIGH_MEASURING) {
                const stability = checkStability(freq);
                
                if (stability.isStable && stability.duration >= stabilityDuration) {
                    // 高音測定完了
                    highestFreq = stability.avgFreq;
                    highestNote = result.note;
                    console.log(`高音測定完了: ${highestNote} (${highestFreq.toFixed(1)}Hz)`);
                    
                    // 測定完了
                    completeMeasurement();
                } else if (stability.isStable) {
                    // 進捗表示
                    const progress = (stability.duration / stabilityDuration) * 100;
                    updateStepUI(TestPhase.HIGH_MEASURING, progress);
                }
            }
            
            // リアルタイムで結果を更新
            updateResults();
        }

        // エラー処理
        function handleError(error) {
            console.error('PitchPro エラー:', error);
            showError('音声検出エラー: ' + error.message);
            stopTest();
        }

        // カウントダウン表示
        function showCountdown(seconds, callback) {
            elements.countdownDisplay.style.display = 'block';
            elements.countdownNumber.textContent = seconds;
            
            const interval = setInterval(() => {
                seconds--;
                if (seconds > 0) {
                    elements.countdownNumber.textContent = seconds;
                } else {
                    clearInterval(interval);
                    elements.countdownDisplay.style.display = 'none';
                    callback();
                }
            }, 1000);
        }
        
        // インターバルフェーズ開始
        function startIntervalPhase() {
            audioDetector.stopDetection();
            updateStepUI(TestPhase.INTERVAL);
            
            // 3秒インターバル
            showCountdown(3, () => {
                startHighPhase();
            });
        }
        
        // 低音測定フェーズ開始
        function startLowPhase() {
            resetStabilityMeasurement();
            updateStepUI(TestPhase.LOW_PREPARE);
            
            // 1秒後に測定モードに移行
            setTimeout(() => {
                updateStepUI(TestPhase.LOW_MEASURING);
            }, 1000);
        }
        
        // 高音測定フェーズ開始
        function startHighPhase() {
            resetStabilityMeasurement();
            updateStepUI(TestPhase.HIGH_PREPARE);
            audioDetector.startDetection();
            
            // 1秒後に測定モードに移行
            setTimeout(() => {
                updateStepUI(TestPhase.HIGH_MEASURING);
            }, 1000);
        }
        
        // 安定性測定リセット
        function resetStabilityMeasurement() {
            stabilityStartTime = null;
            stabilityBuffer = [];
        }
        
        // 測定完了
        function completeMeasurement() {
            audioDetector.stopDetection();
            isTestRunning = false;
            updateStepUI(TestPhase.COMPLETED);
            
            // UI切り替え
            elements.startBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            elements.resultsSection.style.display = 'block';
            
            updateResults();
            console.log('音域測定完了');
        }

        // 測定開始
        async function startTest() {
            if (!audioDetector) {
                const success = await initAudioDetection();
                if (!success) return;
            }

            try {
                await audioDetector.startDetection();
                isTestRunning = true;
                
                // 測定値をリセット
                lowestFreq = Infinity;
                highestFreq = 0;
                lowestNote = null;
                highestNote = null;
                
                // UI切り替え
                elements.startBtn.style.display = 'none';
                elements.stopBtn.style.display = 'block';
                elements.errorSection.style.display = 'none';
                
                // 低音測定フェーズ開始
                startLowPhase();
                
                console.log('音域測定開始');
            } catch (error) {
                console.error('測定開始エラー:', error);
                showError('測定開始に失敗しました: ' + error.message);
            }
        }

        // 測定停止
        function stopTest() {
            if (audioDetector) {
                audioDetector.stopDetection();
            }
            
            isTestRunning = false;
            currentPhase = TestPhase.READY;
            resetStabilityMeasurement();
            
            // UI切り替え
            elements.startBtn.style.display = 'block';
            elements.stopBtn.style.display = 'none';
            elements.measurementProgress.style.display = 'none';
            elements.countdownDisplay.style.display = 'none';
            
            updateStepUI(TestPhase.READY);
            
            console.log('音域測定停止');
        }

        // 結果表示更新
        function updateResults() {
            if (lowestNote && highestNote) {
                elements.lowestNote.textContent = lowestNote;
                elements.lowestFrequency.textContent = `${lowestFreq.toFixed(1)} Hz`;
                elements.highestNote.textContent = highestNote;
                elements.highestFrequency.textContent = `${highestFreq.toFixed(1)} Hz`;
                
                // セミトーン計算
                const semitones = Math.round(12 * Math.log2(highestFreq / lowestFreq));
                elements.rangeSemitones.textContent = `${semitones} セミトーン`;
            }
        }

        // エラー表示
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorSection.style.display = 'block';
        }

        // イベントリスナー設定
        elements.startBtn.addEventListener('click', startTest);
        elements.stopBtn.addEventListener('click', stopTest);
        elements.backButton.addEventListener('click', () => {
            if (confirm('音域テストを終了してホームに戻りますか？')) {
                if (audioDetector) {
                    audioDetector.destroy();
                }
                window.location.href = '../../index.html';
            }
        });

        // ページ読み込み完了時の初期化
        document.addEventListener('DOMContentLoaded', () => {
            // Lucide icons初期化
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            console.log('音域テスト画面初期化完了');
        });

        // ページアンロード時のクリーンアップ
        window.addEventListener('beforeunload', () => {
            if (audioDetector) {
                audioDetector.destroy();
            }
        });
    </script>
</body>
</html>