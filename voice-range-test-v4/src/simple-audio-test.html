<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒ³ãƒ—ãƒ«éŸ³å£°ãƒ†ã‚¹ãƒˆ - PitchPro v1.1.9</title>
    
    <!-- æœ¬ç•ªã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆä½¿ç”¨ -->
    <link rel="stylesheet" href="../../Bolt/v2/styles/base.css">
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- ã‚¢ã‚¤ã‚³ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container max-w-2xl mx-auto">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">ğŸ¤ ã‚·ãƒ³ãƒ—ãƒ«éŸ³å£°ãƒ†ã‚¹ãƒˆ</h1>
                <p class="text-yellow-200 text-lg">éŸ³é‡ãƒãƒ¼ãƒ»å‘¨æ³¢æ•°ãƒ»éŸ³ç¨‹è¡¨ç¤ºã®ã¿</p>
            </header>

            <!-- åˆ¶å¾¡ãƒœã‚¿ãƒ³ -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="play" class="text-blue-300"></i>
                    <span>éŸ³å£°åˆ¶å¾¡</span>
                </h3>
                <div class="flex gap-3 justify-center">
                    <button id="init-btn" class="btn btn-primary">
                        <i data-lucide="power" class="icon-sm"></i>
                        <span>åˆæœŸåŒ–</span>
                    </button>
                    <button id="start-btn" class="btn btn-success" disabled>
                        <i data-lucide="mic" class="icon-sm"></i>
                        <span>é–‹å§‹</span>
                    </button>
                    <button id="stop-btn" class="btn btn-outline" disabled>
                        <i data-lucide="square" class="icon-sm"></i>
                        <span>åœæ­¢</span>
                    </button>
                </div>
            </div>
            
            <!-- éŸ³é‡è¡¨ç¤º -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="volume-2" class="text-green-300"></i>
                    <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                </h3>
                <div class="volume-meter">
                    <div class="flex items-center justify-between mb-2 w-full">
                        <span class="text-white-70">ç¾åœ¨ã®éŸ³é‡</span>
                        <span id="volume-text" class="text-white font-medium">0.0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- å‘¨æ³¢æ•°ãƒ»éŸ³ç¨‹è¡¨ç¤º -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="music" class="text-purple-300"></i>
                    <span>éŸ³ç¨‹æƒ…å ±</span>
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="text-center">
                        <div class="text-white-70 text-sm mb-2">å‘¨æ³¢æ•°</div>
                        <div id="frequency-display" class="text-3xl font-bold text-purple-300 bg-black bg-opacity-30 px-4 py-3 rounded-lg">0.0 Hz</div>
                    </div>
                    <div class="text-center">
                        <div class="text-white-70 text-sm mb-2">éŸ³ç¨‹</div>
                        <div id="note-display" class="text-3xl font-bold text-yellow-300 bg-black bg-opacity-30 px-4 py-3 rounded-lg">-</div>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="activity" class="text-blue-300"></i>
                    <span>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</span>
                </h3>
                <div id="status" class="text-center text-white-70">åˆæœŸåŒ–å‰...</div>
            </div>
            
            <!-- ãƒ­ã‚°å‡ºåŠ› -->
            <div class="glass-card">
                <h3 class="heading-md mb-4">
                    <i data-lucide="file-text" class="text-white-70"></i>
                    <span>ãƒ­ã‚°å‡ºåŠ›</span>
                </h3>
                <div id="log-output" class="bg-black bg-opacity-50 p-4 rounded-lg h-48 overflow-y-auto font-mono text-sm"></div>
            </div>
        </div>
    </div>

    <!-- PitchPro v1.1.9 æœ€æ–°ç‰ˆUMDãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="../../js/pitchpro-audio/pitchpro-v1.1.9-latest.umd.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let microphoneController = null;
        let pitchDetector = null;
        let isDetecting = false;

        // ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `text-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-300 mb-1`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const logContainer = document.getElementById('log-output');
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`%c${message}`, `color: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'}`);
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `text-center text-${type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue'}-300`;
            statusDiv.textContent = message;
        }

        // UIæ›´æ–°é–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        function updateUI(result) {
            // éŸ³é‡ãƒãƒ¼
            const volumeBar = document.getElementById('volume-bar');
            const volumeText = document.getElementById('volume-text');
            if (volumeBar && volumeText) {
                const volume = result.volume || 0;
                volumeBar.style.width = `${volume}%`;
                volumeText.textContent = `${volume.toFixed(1)}%`;
                
                // ğŸ” éŸ³é‡ãƒãƒ¼è©³ç´°ãƒ­ã‚°ï¼ˆ10%ã®ç¢ºç‡ï¼‰
                if (Math.random() < 0.1) {
                    const computedWidth = getComputedStyle(volumeBar).width;
                    const parentWidth = getComputedStyle(volumeBar.parentElement).width;
                    const computedStyle = getComputedStyle(volumeBar);
                    
                    // æœŸå¾…å€¤è¨ˆç®—
                    const expectedWidthPx = (volume / 100) * parseFloat(parentWidth);
                    const actualWidthPx = parseFloat(computedWidth);
                    const widthRatio = (actualWidthPx / expectedWidthPx * 100).toFixed(1);
                    
                    log(`ğŸ“Š éŸ³é‡è©³ç´° | result.volume: ${volume.toFixed(1)}% | è¨­å®šwidth: ${volumeBar.style.width}`, 'info');
                    log(`ğŸ“ ã‚µã‚¤ã‚ºåˆ†æ | æœŸå¾…width: ${expectedWidthPx.toFixed(1)}px | å®Ÿéš›width: ${computedWidth} | æ¯”ç‡: ${widthRatio}%`, 'info');
                    log(`ğŸ¨ CSSçŠ¶æ…‹ | transition: ${computedStyle.transition} | flexShrink: ${computedStyle.flexShrink} | maxWidth: ${computedStyle.maxWidth}`, 'info');
                }
            }

            // å‘¨æ³¢æ•°è¡¨ç¤º
            const frequencyDisplay = document.getElementById('frequency-display');
            if (frequencyDisplay) {
                const frequency = result.pitch || result.frequency || 0;
                frequencyDisplay.textContent = `${frequency.toFixed(1)} Hz`;
            }

            // éŸ³ç¨‹è¡¨ç¤º
            const noteDisplay = document.getElementById('note-display');
            if (noteDisplay && result.note) {
                noteDisplay.textContent = result.note.name || result.note || '-';
            }

            // ä½é »åº¦ã§å…¨ä½“ãƒ­ã‚°
            if (Math.random() < 0.02) {
                log(`ğŸµ å‘¨æ³¢æ•°: ${(result.pitch || result.frequency || 0).toFixed(1)}Hz | éŸ³é‡: ${(result.volume || 0).toFixed(1)}% | éŸ³ç¨‹: ${result.note?.name || result.note || '-'}`, 'info');
            }
        }

        // åˆæœŸåŒ–
        document.getElementById('init-btn').addEventListener('click', async () => {
            try {
                updateStatus('åˆæœŸåŒ–ä¸­...', 'info');
                log('ğŸ¤ PitchPro v1.1.9 åˆæœŸåŒ–é–‹å§‹', 'info');
                
                // MicrophoneControlleråˆæœŸåŒ–
                microphoneController = new PitchPro.MicrophoneController();
                await microphoneController.initialize();
                log('âœ… MicrophoneControlleråˆæœŸåŒ–å®Œäº†', 'success');
                
                // PitchDetectoråˆæœŸåŒ–ï¼ˆå®Œå…¨ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
                const audioManager = microphoneController.audioManager;
                pitchDetector = new PitchPro.PitchDetector(audioManager);
                await pitchDetector.initialize();
                log('âœ… PitchDetectoråˆæœŸåŒ–å®Œäº†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼‰', 'success');
                
                // ç™»éŒ²
                microphoneController.registerDetector(pitchDetector);
                log('âœ… PitchDetectorç™»éŒ²å®Œäº†', 'success');
                
                // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                pitchDetector.setCallbacks({
                    onPitchUpdate: updateUI,
                    onError: (error) => {
                        log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                        updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    },
                    onStateChange: (state) => {
                        log(`ğŸ”„ çŠ¶æ…‹å¤‰åŒ–: ${state}`, 'info');
                    }
                });
                
                updateStatus('åˆæœŸåŒ–å®Œäº†', 'success');
                log('âœ… å…¨ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                document.getElementById('init-btn').disabled = true;
                document.getElementById('start-btn').disabled = false;
                
            } catch (error) {
                log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        // é–‹å§‹
        document.getElementById('start-btn').addEventListener('click', async () => {
            if (!microphoneController) return;
            
            try {
                log('ğŸš€ éŸ³å£°æ¤œå‡ºé–‹å§‹', 'info');
                const started = microphoneController.start();
                
                if (started) {
                    isDetecting = true;
                    updateStatus('ğŸ¤ éŸ³å£°æ¤œå‡ºä¸­...', 'success');
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('stop-btn').disabled = false;
                    log('âœ… éŸ³å£°æ¤œå‡ºé–‹å§‹å®Œäº†', 'success');
                } else {
                    log('âŒ éŸ³å£°æ¤œå‡ºé–‹å§‹ã«å¤±æ•—', 'error');
                }
            } catch (error) {
                log(`âŒ é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        // åœæ­¢
        document.getElementById('stop-btn').addEventListener('click', () => {
            if (!microphoneController) return;
            
            try {
                log('ğŸ›‘ éŸ³å£°æ¤œå‡ºåœæ­¢', 'info');
                microphoneController.reset();
                isDetecting = false;
                
                updateStatus('éŸ³å£°æ¤œå‡ºåœæ­¢', 'info');
                document.getElementById('start-btn').disabled = false;
                document.getElementById('stop-btn').disabled = true;
                log('âœ… éŸ³å£°æ¤œå‡ºåœæ­¢å®Œäº†', 'success');
                
            } catch (error) {
                log(`âŒ åœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });

        // LucideåˆæœŸåŒ–
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        // åˆæœŸãƒ­ã‚°
        if (typeof PitchPro !== 'undefined') {
            log('âœ… PitchPro v1.1.9 ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å®Œäº†', 'success');
            log('ğŸ¯ ã‚·ãƒ³ãƒ—ãƒ«éŸ³å£°ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰æº–å‚™å®Œäº†', 'success');
            updateStatus('æº–å‚™å®Œäº† - åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯', 'success');
        } else {
            log('âŒ PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿å¤±æ•—', 'error');
            updateStatus('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¨ãƒ©ãƒ¼', 'error');
        }
    </script>
</body>
</html>