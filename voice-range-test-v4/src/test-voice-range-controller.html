<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceRangeTestController - PitchProçµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="../../Bolt/v2/styles/base.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .status.success { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .status.info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        
        /* éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨UI */
        .voice-range-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }
        
        .range-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            font-size: 40px;
        }
        
        .countdown-display {
            width: 80px;
            height: 80px;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            font-size: 32px;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .voice-note-badge {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#3b82f6 0deg, transparent 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .voice-progress-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .volume-bar {
            width: 300px;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            width: 0%;
            transition: width 0.1s ease;
        }
        
        .frequency-display {
            font-size: 24px;
            font-weight: bold;
            color: #58a6ff;
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            min-width: 150px;
        }
        
        .status-text {
            text-align: center;
            margin: 10px 0;
        }
        
        #main-status-text {
            font-size: 18px;
            font-weight: bold;
            color: #f0f6fc;
        }
        
        #sub-info-text {
            font-size: 14px;
            color: #8b949e;
        }
        
        #mic-status-container {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        #mic-status-container.standby {
            background: rgba(107, 114, 128, 0.2);
        }
        
        #mic-status-container.recording {
            background: rgba(239, 68, 68, 0.2);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸµ VoiceRangeTestControllerçµ±åˆãƒ†ã‚¹ãƒˆ</h1>
        <p>PitchPro AudioDetectionComponentã‚’ä½¿ç”¨ã—ãŸéŸ³åŸŸãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="test-section">
            <h3>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
            <div id="system-status">åˆæœŸåŒ–å‰...</div>
        </div>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="test-section">
            <h3>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
            <button id="init-btn" class="btn">ğŸ¤ åˆæœŸåŒ–</button>
            <button id="start-test-btn" class="btn" disabled>ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button id="stop-test-btn" class="btn" disabled>â¹ ãƒ†ã‚¹ãƒˆåœæ­¢</button>
        </div>
        
        <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆUI -->
        <div class="test-section">
            <h3>éŸ³åŸŸãƒ†ã‚¹ãƒˆ</h3>
            <div class="voice-range-ui">
                <!-- ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="range-icon" class="range-icon">ğŸ¤</div>
                <div id="countdown-display" class="countdown-display">3</div>
                
                <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒƒã‚¸ -->
                <div class="voice-note-badge">
                    <div class="voice-progress-circle"></div>
                </div>
                
                <!-- éŸ³é‡ãƒãƒ¼ -->
                <div class="volume-bar">
                    <div class="volume-fill" id="range-test-volume-bar"></div>
                </div>
                
                <!-- éŸ³é‡ãƒ†ã‚­ã‚¹ãƒˆ -->
                <div id="range-test-volume-text">0%</div>
                
                <!-- å‘¨æ³¢æ•°è¡¨ç¤º -->
                <div class="frequency-display" id="range-test-frequency-value">0 Hz</div>
                
                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
                <div class="status-text">
                    <div id="main-status-text">éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>
                    <div id="sub-info-text">å¾…æ©Ÿä¸­...</div>
                </div>
                
                <!-- ãƒã‚¤ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div id="mic-status-container" class="standby">
                    ãƒã‚¤ã‚¯: å¾…æ©Ÿä¸­
                </div>
            </div>
        </div>
        
        <!-- ãƒ­ã‚°å‡ºåŠ› -->
        <div class="test-section">
            <h3>ãƒ­ã‚°</h3>
            <div id="log-output" style="height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script type="module">
        // PitchPro ESMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { AudioDetectionComponent } from '/js/pitchpro-audio/dist/index.esm.js';
        
        // VoiceRangeTestControllerã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆESMãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰
        // æ³¨æ„: AudioDetectionComponentã‚’å¤–éƒ¨ã‹ã‚‰æ¸¡ã™å¿…è¦ãŒã‚ã‚‹
        
        let voiceRangeController = null;
        let logLines = [];
        
        // ãƒ­ã‚°å‡ºåŠ›ã‚·ã‚¹ãƒ†ãƒ 
        const logContainer = document.getElementById('log-output');
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`%c${message}`, `color: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'}`);
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('system-status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        // ç°¡æ˜“VoiceRangeTestControllerï¼ˆESMå¯¾å¿œç‰ˆï¼‰
        class VoiceRangeTestController {
            constructor(AudioDetectionComponent, options = {}) {
                this.AudioDetectionComponent = AudioDetectionComponent;
                this.options = {
                    volumeBarSelector: '#range-test-volume-bar',
                    volumeTextSelector: '#range-test-volume-text', 
                    frequencySelector: '#range-test-frequency-value',
                    mainStatusSelector: '#main-status-text',
                    subInfoSelector: '#sub-info-text',
                    micContainerSelector: '#mic-status-container',
                    rangeIconSelector: '#range-icon',
                    countdownDisplaySelector: '#countdown-display',
                    measurementDuration: 3000,
                    debugMode: true,
                    ...options
                };
                
                this.audioDetector = null;
                this.currentPhase = 'idle';
                this.measurementData = {
                    lowPhaseFrequencies: [],
                    highPhaseFrequencies: [],
                    currentLowestFreq: null,
                    currentHighestFreq: null
                };
                
                log('VoiceRangeTestController (ESMå¯¾å¿œç‰ˆ) åˆæœŸåŒ–å®Œäº†', 'success');
            }
            
            async initialize() {
                try {
                    log('AudioDetectionComponent åˆæœŸåŒ–é–‹å§‹', 'info');
                    
                    this.audioDetector = new this.AudioDetectionComponent({
                        volumeBarSelector: this.options.volumeBarSelector,
                        volumeTextSelector: this.options.volumeTextSelector,
                        frequencySelector: this.options.frequencySelector,
                        clarityThreshold: 0.4,
                        minVolumeAbsolute: 0.003,
                        deviceOptimization: true,
                        debug: this.options.debugMode
                    });
                    
                    await this.audioDetector.initialize();
                    
                    // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                    this.audioDetector.setCallbacks({
                        onPitchUpdate: (result) => this.recordFrequencyData(result),
                        onError: (error) => log(`AudioDetection ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error'),
                        onStateChange: (state) => log(`çŠ¶æ…‹å¤‰åŒ–: ${state}`, 'info')
                    });
                    
                    log('AudioDetectionComponent åˆæœŸåŒ–å®Œäº†', 'success');
                    return true;
                    
                } catch (error) {
                    log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            recordFrequencyData(result) {
                if (this.currentPhase !== 'low-measuring' && this.currentPhase !== 'high-measuring') {
                    return;
                }
                
                if (!result.frequency || result.frequency < 50 || result.frequency > 2000) {
                    return;
                }
                
                if (!result.volume || result.volume < 0.1) {
                    return;
                }
                
                const frequency = result.frequency;
                
                if (this.currentPhase === 'low-measuring') {
                    this.measurementData.lowPhaseFrequencies.push({ frequency, volume: result.volume });
                    if (!this.measurementData.currentLowestFreq || frequency < this.measurementData.currentLowestFreq) {
                        this.measurementData.currentLowestFreq = frequency;
                        log(`ğŸ”½ æ–°ã—ã„æœ€ä½éŸ³è¨˜éŒ²: ${frequency.toFixed(1)} Hz`, 'success');
                    }
                } else if (this.currentPhase === 'high-measuring') {
                    this.measurementData.highPhaseFrequencies.push({ frequency, volume: result.volume });
                    if (!this.measurementData.currentHighestFreq || frequency > this.measurementData.currentHighestFreq) {
                        this.measurementData.currentHighestFreq = frequency;
                        log(`ğŸ”¼ æ–°ã—ã„æœ€é«˜éŸ³è¨˜éŒ²: ${frequency.toFixed(1)} Hz`, 'success');
                    }
                }
            }
            
            async startVoiceRangeTest() {
                try {
                    log('ğŸ¬ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                    
                    // éŸ³å£°æ¤œå‡ºé–‹å§‹
                    await this.audioDetector.startDetection();
                    
                    // UIæ›´æ–°
                    this.updateStatus('æº–å‚™å®Œäº†', 'ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...');
                    
                    // ä½éŸ³æ¸¬å®šé–‹å§‹
                    setTimeout(() => {
                        this.startLowPitchPhase();
                    }, 1000);
                    
                    return true;
                    
                } catch (error) {
                    log(`ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    throw error;
                }
            }
            
            startLowPitchPhase() {
                log('ğŸ”½ ä½éŸ³æ¸¬å®šãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹', 'info');
                this.currentPhase = 'low-measuring';
                
                this.measurementData.lowPhaseFrequencies = [];
                this.measurementData.currentLowestFreq = null;
                
                this.updateStatus('ã§ãã‚‹ã ã‘ä½ã„å£°ã‚’å‡ºã—ã¦ãã ã•ã„', 'æ¸¬å®šä¸­... (3ç§’é–“)');
                
                // 3ç§’å¾Œã«æ¸¬å®šå®Œäº†
                setTimeout(() => {
                    this.completeLowPhase();
                }, this.options.measurementDuration);
            }
            
            completeLowPhase() {
                this.currentPhase = 'low-complete';
                const lowFreq = this.measurementData.currentLowestFreq || 130;
                
                log(`âœ… ä½éŸ³æ¸¬å®šå®Œäº†: ${lowFreq.toFixed(1)} Hz`, 'success');
                this.updateStatus(`ä½éŸ³æ¸¬å®šå®Œäº†: ${lowFreq.toFixed(1)}Hz`, '1ç§’å¾Œã«é«˜éŸ³æ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™');
                
                // é«˜éŸ³æ¸¬å®šé–‹å§‹
                setTimeout(() => {
                    this.startHighPitchPhase();
                }, 1000);
            }
            
            startHighPitchPhase() {
                log('ğŸ”¼ é«˜éŸ³æ¸¬å®šãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹', 'info');
                this.currentPhase = 'high-measuring';
                
                this.measurementData.highPhaseFrequencies = [];
                this.measurementData.currentHighestFreq = null;
                
                this.updateStatus('ã§ãã‚‹ã ã‘é«˜ã„å£°ã‚’å‡ºã—ã¦ãã ã•ã„', 'æ¸¬å®šä¸­... (3ç§’é–“)');
                
                // 3ç§’å¾Œã«æ¸¬å®šå®Œäº†
                setTimeout(() => {
                    this.completeHighPhase();
                }, this.options.measurementDuration);
            }
            
            completeHighPhase() {
                this.currentPhase = 'high-complete';
                const highFreq = this.measurementData.currentHighestFreq || 523;
                const lowFreq = this.measurementData.currentLowestFreq || 130;
                
                // éŸ³åŸŸè¨ˆç®—
                const octaves = Math.log2(highFreq / lowFreq);
                const rangeText = `${lowFreq.toFixed(1)}Hz - ${highFreq.toFixed(1)}Hz`;
                
                log(`âœ… é«˜éŸ³æ¸¬å®šå®Œäº†: ${highFreq.toFixed(1)} Hz`, 'success');
                log(`ğŸµ éŸ³åŸŸè¨ˆç®—çµæœ: ${rangeText} (${octaves.toFixed(1)}ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–)`, 'success');
                
                this.updateStatus('éŸ³åŸŸæ¸¬å®šå®Œäº†ï¼', `æ¸¬å®šçµæœ: ${rangeText} (${octaves.toFixed(1)}ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–)`);
                
                // æ¸¬å®šåœæ­¢
                this.stopTest();
            }
            
            updateStatus(mainMessage, subMessage = '') {
                const mainStatus = document.querySelector(this.options.mainStatusSelector);
                const subInfo = document.querySelector(this.options.subInfoSelector);
                
                if (mainStatus) mainStatus.textContent = mainMessage;
                if (subInfo) subInfo.textContent = subMessage;
            }
            
            stopTest() {
                if (this.audioDetector) {
                    this.audioDetector.stopDetection();
                }
                this.currentPhase = 'idle';
                log('â¹ï¸ ãƒ†ã‚¹ãƒˆåœæ­¢', 'info');
            }
            
            destroy() {
                this.stopTest();
                if (this.audioDetector) {
                    this.audioDetector.destroy();
                    this.audioDetector = null;
                }
                log('ğŸ—‘ï¸ ãƒªã‚½ãƒ¼ã‚¹ç ´æ£„å®Œäº†', 'info');
            }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
        document.getElementById('init-btn').addEventListener('click', async () => {
            try {
                updateStatus('åˆæœŸåŒ–ä¸­...', 'info');
                log('VoiceRangeTestController åˆæœŸåŒ–é–‹å§‹', 'info');
                
                // AudioDetectionComponentã‚’æ¸¡ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆ
                voiceRangeController = new VoiceRangeTestController(AudioDetectionComponent, {
                    debugMode: true
                });
                
                await voiceRangeController.initialize();
                
                updateStatus('åˆæœŸåŒ–å®Œäº†', 'success');
                log('âœ… åˆæœŸåŒ–å®Œäº†', 'success');
                
                document.getElementById('init-btn').disabled = true;
                document.getElementById('start-test-btn').disabled = false;
                
            } catch (error) {
                updateStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('start-test-btn').addEventListener('click', async () => {
            if (voiceRangeController) {
                try {
                    await voiceRangeController.startVoiceRangeTest();
                    
                    document.getElementById('start-test-btn').disabled = true;
                    document.getElementById('stop-test-btn').disabled = false;
                    
                } catch (error) {
                    log(`âŒ ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
        });
        
        document.getElementById('stop-test-btn').addEventListener('click', () => {
            if (voiceRangeController) {
                voiceRangeController.stopTest();
                
                document.getElementById('start-test-btn').disabled = false;
                document.getElementById('stop-test-btn').disabled = true;
            }
        });
        
        // åˆæœŸãƒ­ã‚°
        log('VoiceRangeTestControllerçµ±åˆãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'success');
        log('æ‰‹é †: 1) åˆæœŸåŒ– â†’ 2) éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
        updateStatus('æº–å‚™å®Œäº† - åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯', 'success');
        
    </script>
</body>
</html>