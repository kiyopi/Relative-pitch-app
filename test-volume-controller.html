<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸšï¸ VolumeBarController ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ä¾‹</title>
    
    <!-- ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ -->
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-purple">
                        <i data-lucide="activity" class="text-white" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">VolumeBarController</h1>
                    <p class="page-subtitle text-purple-200">ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ä¾‹</p>
                </div>
            </div>
        </header>

        <main class="narrow-main">
            <!-- ã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="play-circle" class="text-green-300"></i>
                    <span>ã‚·ãƒ³ãƒ—ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</span>
                </h3>
                
                <div class="flex gap-4 mt-4">
                    <button id="start-btn" class="btn btn-primary">
                        <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                        é–‹å§‹
                    </button>
                    <button id="stop-btn" class="btn btn-secondary" disabled>
                        <i data-lucide="stop-circle" style="width: 20px; height: 20px;"></i>
                        åœæ­¢
                    </button>
                </div>
                
                <div class="mt-4 text-sm text-white-60" id="status">
                    åœæ­¢ä¸­
                </div>
            </div>

            <!-- éŸ³é‡è¡¨ç¤º -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="volume-2" class="text-yellow-300"></i>
                    <span>éŸ³é‡è¡¨ç¤º</span>
                </h3>
                
                <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªéŸ³é‡ãƒãƒ¼ -->
                <div class="mt-4" id="volume-bar-simple">
                    <div class="flex items-center gap-3">
                        <i data-lucide="mic" class="text-green-300" style="width: 20px; height: 20px;"></i>
                        <div class="progress-bar flex-1">
                            <div class="progress-fill gradient-catalog-green" style="width: 0%;"></div>
                        </div>
                        <span class="volume-percent text-sm text-white-60">0.0%</span>
                    </div>
                </div>
                
                <!-- è¤‡æ•°ã®éŸ³é‡ãƒãƒ¼ä¾‹ -->
                <div class="mt-6">
                    <h5 class="text-sm text-white-60 mb-3">è¤‡æ•°ãƒãƒ¼åŒæ™‚åˆ¶å¾¡</h5>
                    
                    <div class="space-y-3">
                        <!-- ãƒãƒ¼1 -->
                        <div id="volume-bar-1">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-white-40 min-w-12">Bar 1</span>
                                <div class="progress-bar flex-1">
                                    <div class="progress-fill gradient-catalog-blue" style="width: 0%;"></div>
                                </div>
                                <span class="volume-percent text-sm text-white-60">0.0%</span>
                            </div>
                        </div>
                        
                        <!-- ãƒãƒ¼2 -->
                        <div id="volume-bar-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-white-40 min-w-12">Bar 2</span>
                                <div class="progress-bar flex-1">
                                    <div class="progress-fill gradient-catalog-purple" style="width: 0%;"></div>
                                </div>
                                <span class="volume-percent text-sm text-white-60">0.0%</span>
                            </div>
                        </div>
                        
                        <!-- ãƒãƒ¼3 -->
                        <div id="volume-bar-3">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-white-40 min-w-12">Bar 3</span>
                                <div class="progress-bar flex-1">
                                    <div class="progress-fill gradient-catalog-orange" style="width: 0%;"></div>
                                </div>
                                <span class="volume-percent text-sm text-white-60">0.0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒã‚¤ã‚¹æƒ…å ± -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="smartphone" class="text-blue-300"></i>
                    <span>ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±</span>
                </h3>
                
                <div class="mt-4 space-y-2 text-sm" id="device-info">
                    <div>ãƒ‡ãƒã‚¤ã‚¹: <span class="text-white-80">æ¤œå‡ºä¸­...</span></div>
                    <div>ãƒã‚¤ã‚¯æ„Ÿåº¦: <span class="text-white-80">--</span></div>
                    <div>éŸ³é‡ãƒãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«: <span class="text-white-80">--</span></div>
                </div>
            </div>

            <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="settings" class="text-purple-300"></i>
                    <span>ã‚ªãƒ—ã‚·ãƒ§ãƒ³</span>
                </h3>
                
                <div class="mt-4 space-y-4">
                    <!-- ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°åˆ‡ã‚Šæ›¿ãˆ -->
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-white-80">ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°</label>
                        <button id="toggle-smoothing" class="btn btn-sm btn-outline">
                            ç„¡åŠ¹
                        </button>
                    </div>
                    
                    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ -->
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-white-80">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰</label>
                        <button id="toggle-debug" class="btn btn-sm btn-outline">
                            ç„¡åŠ¹
                        </button>
                    </div>
                </div>
            </div>

            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
            <div class="glass-card" id="debug-panel" style="display: none;">
                <h3 class="heading-md">
                    <i data-lucide="bug" class="text-red-300"></i>
                    <span>ãƒ‡ãƒãƒƒã‚°æƒ…å ±</span>
                </h3>
                
                <div class="mt-4 p-4 bg-black bg-opacity-50 rounded-lg font-mono text-xs" id="debug-info">
                    å¾…æ©Ÿä¸­...
                </div>
            </div>
        </main>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="./js/pitchpro-audio/index.umd.js"></script>
    <script src="./js/volume-bar-controller.js"></script>

    <!-- ã‚·ãƒ³ãƒ—ãƒ«å®Ÿè£…ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let controller = null;
        let isSmoothing = false;
        let isDebugMode = false;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
            lucide.createIcons();
            
            // VolumeBarControllerä½œæˆï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
            controller = new VolumeBarController({
                enableSmoothing: false,
                debugMode: false,
                updateInterval: 50  // 20fps
            });
            
            // éŸ³é‡ãƒãƒ¼ã‚’ç™»éŒ²
            controller.addVolumeBar('simple', document.getElementById('volume-bar-simple'));
            controller.addVolumeBar('bar1', document.getElementById('volume-bar-1'));
            controller.addVolumeBar('bar2', document.getElementById('volume-bar-2'));
            controller.addVolumeBar('bar3', document.getElementById('volume-bar-3'));
            
            // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±è¡¨ç¤º
            const specs = controller.getDeviceSpecs();
            document.querySelector('#device-info').innerHTML = `
                <div>ãƒ‡ãƒã‚¤ã‚¹: <span class="text-white-80">${specs.deviceType}</span></div>
                <div>ãƒã‚¤ã‚¯æ„Ÿåº¦: <span class="text-white-80">${specs.sensitivityMultiplier}x</span></div>
                <div>éŸ³é‡ãƒãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«: <span class="text-white-80">${specs.volumeBarScale}x</span></div>
            `;
            
            // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            controller.onVolumeUpdate = (data) => {
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
                if (isDebugMode) {
                    updateDebugInfo(data);
                }
            };
            
            controller.onError = (error) => {
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            };
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('start-btn').addEventListener('click', startDetection);
            document.getElementById('stop-btn').addEventListener('click', stopDetection);
            document.getElementById('toggle-smoothing').addEventListener('click', toggleSmoothing);
            document.getElementById('toggle-debug').addEventListener('click', toggleDebug);
            
            updateStatus('æº–å‚™å®Œäº†', 'ready');
        });

        // æ¤œå‡ºé–‹å§‹ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
        async function startDetection() {
            try {
                updateStatus('åˆæœŸåŒ–ä¸­...', 'loading');
                
                // åˆæœŸåŒ–ã¨é–‹å§‹ã‚’ä¸€è¡Œã§
                await controller.initialize();
                await controller.start();
                
                // UIæ›´æ–°
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
                updateStatus('æ¤œå‡ºä¸­', 'active');
                
            } catch (error) {
                console.error('é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                updateStatus(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // æ¤œå‡ºåœæ­¢ï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
        function stopDetection() {
            // åœæ­¢ã‚’ä¸€è¡Œã§
            controller.stop();
            
            // UIæ›´æ–°
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            updateStatus('åœæ­¢ä¸­', 'stopped');
        }

        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°åˆ‡ã‚Šæ›¿ãˆ
        function toggleSmoothing() {
            isSmoothing = !isSmoothing;
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
            controller.updateOptions({
                enableSmoothing: isSmoothing
            });
            
            // ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°
            const btn = document.getElementById('toggle-smoothing');
            btn.textContent = isSmoothing ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
            btn.className = isSmoothing ? 'btn btn-sm btn-success' : 'btn btn-sm btn-outline';
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleDebug() {
            isDebugMode = !isDebugMode;
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
            controller.updateOptions({
                debugMode: isDebugMode
            });
            
            // ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('debug-panel').style.display = isDebugMode ? 'block' : 'none';
            
            // ãƒœã‚¿ãƒ³è¡¨ç¤ºæ›´æ–°
            const btn = document.getElementById('toggle-debug');
            btn.textContent = isDebugMode ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹';
            btn.className = isDebugMode ? 'btn btn-sm btn-success' : 'btn btn-sm btn-outline';
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus(text, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            
            // è‰²å¤‰æ›´
            const colorClass = {
                'ready': 'text-green-300',
                'loading': 'text-yellow-300',
                'active': 'text-blue-300',
                'stopped': 'text-white-60',
                'error': 'text-red-300'
            }[type] || 'text-white-60';
            
            statusEl.className = `mt-4 text-sm ${colorClass}`;
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±æ›´æ–°
        function updateDebugInfo(data) {
            const debugInfo = controller.getDebugInfo();
            
            document.getElementById('debug-info').innerHTML = `
                <div>çŠ¶æ…‹: ${debugInfo.isActive ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}</div>
                <div>ç¾åœ¨éŸ³é‡: ${debugInfo.currentVolume}</div>
                <div>ã‚¹ãƒ ãƒ¼ã‚ºéŸ³é‡: ${debugInfo.smoothedVolume}</div>
                <div>ç”Ÿãƒ‡ãƒ¼ã‚¿: ${data.raw ? data.raw.toFixed(3) : '0.000'}</div>
                <div>å‡¦ç†æ¸ˆã¿: ${data.processed ? data.processed.toFixed(1) : '0.0'}%</div>
                <div>å‘¨æ³¢æ•°: ${data.frequency ? data.frequency.toFixed(1) : '--'} Hz</div>
                <div>éŸ³å: ${data.note || '--'}</div>
                <div>ãƒ‡ãƒã‚¤ã‚¹: ${debugInfo.deviceSpecs.deviceType}</div>
                <div>æ›´æ–°æ™‚åˆ»: ${new Date().toLocaleTimeString()}</div>
            `;
        }
    </script>
</body>
</html>