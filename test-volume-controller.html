<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéöÔ∏è VolumeBarController „Ç∑„É≥„Éó„É´ÂÆüË£Ö‰æã</title>
    
    <!-- „Çπ„Çø„Ç§„É´„Ç∑„Éº„Éà -->
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    
    <!-- „Éï„Ç©„É≥„Éà -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-purple">
                        <i data-lucide="activity" class="text-white" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">VolumeBarController</h1>
                    <p class="page-subtitle text-purple-200">„Ç∑„É≥„Éó„É´ÂÆüË£Ö‰æã</p>
                </div>
            </div>
        </header>

        <main class="narrow-main">
            <!-- „Ç∑„É≥„Éó„É´„Ç≥„É≥„Éà„É≠„Éº„É´ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="play-circle" class="text-green-300"></i>
                    <span>„Ç∑„É≥„Éó„É´„Ç≥„É≥„Éà„É≠„Éº„É´</span>
                </h3>
                
                <div class="flex gap-4 mt-4">
                    <button id="start-btn" class="btn btn-primary">
                        <i data-lucide="mic" style="width: 20px; height: 20px;"></i>
                        ÈñãÂßã
                    </button>
                    <button id="stop-btn" class="btn btn-secondary" disabled>
                        <i data-lucide="stop-circle" style="width: 20px; height: 20px;"></i>
                        ÂÅúÊ≠¢
                    </button>
                </div>
                
                <div class="mt-4 text-sm text-white-60" id="status">
                    ÂÅúÊ≠¢‰∏≠
                </div>
            </div>

            <!-- Èü≥ÈáèË°®Á§∫ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="volume-2" class="text-yellow-300"></i>
                    <span>Èü≥ÈáèË°®Á§∫</span>
                </h3>
                
                <!-- „Ç∑„É≥„Éó„É´„Å™Èü≥Èáè„Éê„Éº -->
                <div class="mt-4" id="volume-bar-simple">
                    <div class="flex items-center gap-3">
                        <i data-lucide="mic" class="text-green-300" style="width: 20px; height: 20px;"></i>
                        <div class="progress-bar flex-1">
                            <div class="progress-fill gradient-catalog-green" style="width: 0%;"></div>
                        </div>
                        <span class="volume-percent text-sm text-white-60">0.0%</span>
                    </div>
                </div>
                
                <!-- Ë§áÊï∞„ÅÆÈü≥Èáè„Éê„Éº‰æã -->
                <div class="mt-6">
                    <h5 class="text-sm text-white-60 mb-3">Ë§áÊï∞„Éê„ÉºÂêåÊôÇÂà∂Âæ°</h5>
                    
                    <div class="space-y-3">
                        <!-- „Éê„Éº1 -->
                        <div id="volume-bar-1">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-white-40 min-w-12">Bar 1</span>
                                <div class="progress-bar flex-1">
                                    <div class="progress-fill gradient-catalog-blue" style="width: 0%;"></div>
                                </div>
                                <span class="volume-percent text-sm text-white-60">0.0%</span>
                            </div>
                        </div>
                        
                        <!-- „Éê„Éº2 -->
                        <div id="volume-bar-2">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-white-40 min-w-12">Bar 2</span>
                                <div class="progress-bar flex-1">
                                    <div class="progress-fill gradient-catalog-purple" style="width: 0%;"></div>
                                </div>
                                <span class="volume-percent text-sm text-white-60">0.0%</span>
                            </div>
                        </div>
                        
                        <!-- „Éê„Éº3 -->
                        <div id="volume-bar-3">
                            <div class="flex items-center gap-3">
                                <span class="text-xs text-white-40 min-w-12">Bar 3</span>
                                <div class="progress-bar flex-1">
                                    <div class="progress-fill gradient-catalog-orange" style="width: 0%;"></div>
                                </div>
                                <span class="volume-percent text-sm text-white-60">0.0%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- „Éá„Éê„Ç§„ÇπÊÉÖÂ†± -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="smartphone" class="text-blue-300"></i>
                    <span>„Éá„Éê„Ç§„ÇπÊÉÖÂ†±</span>
                </h3>
                
                <div class="mt-4 space-y-2 text-sm" id="device-info">
                    <div>„Éá„Éê„Ç§„Çπ: <span class="text-white-80">Ê§úÂá∫‰∏≠...</span></div>
                    <div>„Éû„Ç§„ÇØÊÑüÂ∫¶: <span class="text-white-80">--</span></div>
                    <div>Èü≥Èáè„Éê„Éº„Çπ„Ç±„Éº„É´: <span class="text-white-80">--</span></div>
                </div>
            </div>

            <!-- „Ç™„Éó„Ç∑„Éß„É≥ -->
            <div class="glass-card">
                <h3 class="heading-md">
                    <i data-lucide="settings" class="text-purple-300"></i>
                    <span>„Ç™„Éó„Ç∑„Éß„É≥</span>
                </h3>
                
                <div class="mt-4 space-y-4">
                    <!-- „Çπ„É†„Éº„Ç∏„É≥„Ç∞Âàá„ÇäÊõø„Åà -->
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-white-80">„Çπ„É†„Éº„Ç∏„É≥„Ç∞</label>
                        <button id="toggle-smoothing" class="btn btn-sm btn-outline">
                            ÁÑ°Âäπ
                        </button>
                    </div>
                    
                    <!-- „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ -->
                    <div class="flex items-center justify-between">
                        <label class="text-sm text-white-80">„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ</label>
                        <button id="toggle-debug" class="btn btn-sm btn-outline">
                            ÁÑ°Âäπ
                        </button>
                    </div>
                </div>
            </div>

            <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± -->
            <div class="glass-card" id="debug-panel" style="display: none;">
                <h3 class="heading-md">
                    <i data-lucide="bug" class="text-red-300"></i>
                    <span>„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</span>
                </h3>
                
                <div class="mt-4 p-4 bg-black bg-opacity-50 rounded-lg font-mono text-xs" id="debug-info">
                    ÂæÖÊ©ü‰∏≠...
                </div>
            </div>
        </main>
    </div>

    <!-- ÂøÖË¶Å„Å™„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="./js/pitchpro-audio/index.umd.js"></script>
    <script src="./js/volume-bar-controller.js"></script>

    <!-- „Ç∑„É≥„Éó„É´ÂÆüË£Ö„Çπ„ÇØ„É™„Éó„Éà -->
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let controller = null;
        let isSmoothing = false;
        let isDebugMode = false;

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            // Lucide„Ç¢„Ç§„Ç≥„É≥ÂàùÊúüÂåñ
            lucide.createIcons();
            
            // VolumeBarController‰ΩúÊàêÔºàË∂Ö„Ç∑„É≥„Éó„É´Ôºâ
            controller = new VolumeBarController({
                enableSmoothing: false,
                debugMode: false,
                updateInterval: 50  // 20fps
            });
            
            // Èü≥Èáè„Éê„Éº„ÇíÁôªÈå≤
            controller.addVolumeBar('simple', document.getElementById('volume-bar-simple'));
            controller.addVolumeBar('bar1', document.getElementById('volume-bar-1'));
            controller.addVolumeBar('bar2', document.getElementById('volume-bar-2'));
            controller.addVolumeBar('bar3', document.getElementById('volume-bar-3'));
            
            // „Éá„Éê„Ç§„ÇπÊÉÖÂ†±Ë°®Á§∫
            const specs = controller.getDeviceSpecs();
            document.querySelector('#device-info').innerHTML = `
                <div>„Éá„Éê„Ç§„Çπ: <span class="text-white-80">${specs.deviceType}</span></div>
                <div>„Éû„Ç§„ÇØÊÑüÂ∫¶: <span class="text-white-80">${specs.sensitivityMultiplier}x</span></div>
                <div>Èü≥Èáè„Éê„Éº„Çπ„Ç±„Éº„É´: <span class="text-white-80">${specs.volumeBarScale}x</span></div>
            `;
            
            // „Ç´„Çπ„Çø„É†„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            controller.onVolumeUpdate = (data) => {
                // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Êõ¥Êñ∞
                if (isDebugMode) {
                    updateDebugInfo(data);
                }
            };
            
            controller.onError = (error) => {
                updateStatus(`„Ç®„É©„Éº: ${error.message}`, 'error');
            };
            
            // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
            document.getElementById('start-btn').addEventListener('click', startDetection);
            document.getElementById('stop-btn').addEventListener('click', stopDetection);
            document.getElementById('toggle-smoothing').addEventListener('click', toggleSmoothing);
            document.getElementById('toggle-debug').addEventListener('click', toggleDebug);
            
            updateStatus('Ê∫ñÂÇôÂÆå‰∫Ü', 'ready');
        });

        // Ê§úÂá∫ÈñãÂßãÔºàË∂Ö„Ç∑„É≥„Éó„É´Ôºâ
        async function startDetection() {
            try {
                updateStatus('ÂàùÊúüÂåñ‰∏≠...', 'loading');
                
                // ÂàùÊúüÂåñ„Å®ÈñãÂßã„Çí‰∏ÄË°å„Åß
                await controller.initialize();
                await controller.start();
                
                // UIÊõ¥Êñ∞
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
                updateStatus('Ê§úÂá∫‰∏≠', 'active');
                
            } catch (error) {
                console.error('ÈñãÂßã„Ç®„É©„Éº:', error);
                updateStatus(`„Ç®„É©„Éº: ${error.message}`, 'error');
            }
        }

        // Ê§úÂá∫ÂÅúÊ≠¢ÔºàË∂Ö„Ç∑„É≥„Éó„É´Ôºâ
        function stopDetection() {
            // ÂÅúÊ≠¢„Çí‰∏ÄË°å„Åß
            controller.stop();
            
            // UIÊõ¥Êñ∞
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            
            updateStatus('ÂÅúÊ≠¢‰∏≠', 'stopped');
        }

        // „Çπ„É†„Éº„Ç∏„É≥„Ç∞Âàá„ÇäÊõø„Åà
        function toggleSmoothing() {
            isSmoothing = !isSmoothing;
            
            // „Ç™„Éó„Ç∑„Éß„É≥Êõ¥Êñ∞
            controller.updateOptions({
                enableSmoothing: isSmoothing
            });
            
            // „Éú„Çø„É≥Ë°®Á§∫Êõ¥Êñ∞
            const btn = document.getElementById('toggle-smoothing');
            btn.textContent = isSmoothing ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
            btn.className = isSmoothing ? 'btn btn-sm btn-success' : 'btn btn-sm btn-outline';
        }

        // „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
        function toggleDebug() {
            isDebugMode = !isDebugMode;
            
            // „Ç™„Éó„Ç∑„Éß„É≥Êõ¥Êñ∞
            controller.updateOptions({
                debugMode: isDebugMode
            });
            
            // „Éë„Éç„É´Ë°®Á§∫Âàá„ÇäÊõø„Åà
            document.getElementById('debug-panel').style.display = isDebugMode ? 'block' : 'none';
            
            // „Éú„Çø„É≥Ë°®Á§∫Êõ¥Êñ∞
            const btn = document.getElementById('toggle-debug');
            btn.textContent = isDebugMode ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ';
            btn.className = isDebugMode ? 'btn btn-sm btn-success' : 'btn btn-sm btn-outline';
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞
        function updateStatus(text, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            
            // Ëâ≤Â§âÊõ¥
            const colorClass = {
                'ready': 'text-green-300',
                'loading': 'text-yellow-300',
                'active': 'text-blue-300',
                'stopped': 'text-white-60',
                'error': 'text-red-300'
            }[type] || 'text-white-60';
            
            statusEl.className = `mt-4 text-sm ${colorClass}`;
        }

        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Êõ¥Êñ∞
        function updateDebugInfo(data) {
            const debugInfo = controller.getDebugInfo();
            
            document.getElementById('debug-info').innerHTML = `
                <div>Áä∂ÊÖã: ${debugInfo.isActive ? 'Âãï‰Ωú‰∏≠' : 'ÂÅúÊ≠¢‰∏≠'}</div>
                <div>ÁèæÂú®Èü≥Èáè: ${debugInfo.currentVolume}</div>
                <div>„Çπ„É†„Éº„Ç∫Èü≥Èáè: ${debugInfo.smoothedVolume}</div>
                <div>Áîü„Éá„Éº„Çø: ${data.raw ? data.raw.toFixed(3) : '0.000'}</div>
                <div>Âá¶ÁêÜÊ∏à„Åø: ${data.processed ? data.processed.toFixed(1) : '0.0'}%</div>
                <div>Âë®Ê≥¢Êï∞: ${data.frequency ? data.frequency.toFixed(1) : '--'} Hz</div>
                <div>Èü≥Âêç: ${data.note || '--'}</div>
                <div>„Éá„Éê„Ç§„Çπ: ${debugInfo.deviceSpecs.deviceType}</div>
                <div>Êõ¥Êñ∞ÊôÇÂàª: ${new Date().toLocaleTimeString()}</div>
            `;
        }
    </script>
</body>
</html>