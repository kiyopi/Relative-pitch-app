<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioDetectionComponent „ÉÜ„Çπ„Éà - 8vaÁõ∏ÂØæÈü≥ÊÑü„Éà„É¨„Éº„Éã„É≥„Ç∞</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <link rel="stylesheet" href="Bolt/v2/styles/results.css">
    <link rel="stylesheet" href="Bolt/v2/styles/training.css">
</head>
<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">AudioDetectionComponent „ÉÜ„Çπ„Éà</h1>
                    <p class="page-subtitle text-green-200">Êñ∞„Åó„ÅÑPitchProÁµ±ÂêàÈü≥Â£∞Âá¶ÁêÜ„Ç∑„Çπ„ÉÜ„É†</p>
                </div>
            </div>
        </header>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <main class="narrow-main">
            <div class="glass-card">
                <div class="section-header">
                    <h3 class="text-section-title">Èü≥Â£∞Ê§úÂá∫„ÉÜ„Çπ„Éà</h3>
                    <p class="section-description">AudioDetectionComponent„ÅÆÂãï‰ΩúÁ¢∫Ë™ç</p>
                </div>

                <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
                <div class="flex gap-3 mb-4">
                    <button class="btn btn-primary" id="start-btn">
                        <i data-lucide="play" style="width: 20px; height: 20px;"></i>
                        <span>ÈñãÂßã</span>
                    </button>
                    <button class="btn btn-secondary" id="stop-btn" disabled>
                        <i data-lucide="square" style="width: 20px; height: 20px;"></i>
                        <span>ÂÅúÊ≠¢</span>
                    </button>
                </div>

                <!-- Èü≥ÈáèË°®Á§∫ -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-white-60">Èü≥Èáè„É¨„Éô„É´</span>
                        <span class="text-sm text-white" id="volume-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="volume-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <!-- Âë®Ê≥¢Êï∞„ÉªÈü≥Á®ãË°®Á§∫ -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <i data-lucide="activity" class="text-blue-300" style="width: 20px; height: 20px;"></i>
                            <span>Âë®Ê≥¢Êï∞</span>
                        </div>
                        <div class="stat-card-value" id="frequency-display">-- Hz</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <i data-lucide="music" class="text-green-300" style="width: 20px; height: 20px;"></i>
                            <span>Èü≥Á®ã</span>
                        </div>
                        <div class="stat-card-value" id="note-display">--</div>
                    </div>
                </div>

                <!-- „Éá„Éê„Ç§„ÇπÊÉÖÂ†± -->
                <div class="info-alert mb-4">
                    <i data-lucide="smartphone" style="width: 24px; height: 24px; color: #60a5fa;"></i>
                    <div>
                        <p class="text-sm">„Éá„Éê„Ç§„Çπ: <span id="device-type">Ê§úÂá∫‰∏≠...</span></p>
                        <p class="text-xs text-white-60">ÊÑüÂ∫¶: <span id="device-sensitivity">--</span></p>
                    </div>
                </div>

                <!-- Áä∂ÊÖãË°®Á§∫ -->
                <div class="mb-4">
                    <div class="text-sm text-white-60">
                        Áä∂ÊÖã: <span id="state-display" class="text-white">ÂàùÊúüÂåñÂâç</span>
                    </div>
                </div>

                <!-- „É≠„Ç∞Ë°®Á§∫ -->
                <div class="glass-card-secondary">
                    <h4 class="heading-sm mb-3">
                        <i data-lucide="terminal" class="text-blue-300"></i>
                        <span>„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞</span>
                    </h4>
                    <div id="log-display" class="text-xs text-white-60 font-mono" style="max-height: 200px; overflow-y: auto;">
                        <!-- „É≠„Ç∞„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- „Çπ„ÇØ„É™„Éó„Éà -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="js/lucide-init.js"></script>

    <!-- AudioDetectionComponent -->
    <script type="module">
        // UMD„Éì„É´„Éâ„Çí‰ΩøÁî®
        const script = document.createElement('script');
        script.src = './js/pitchpro-audio/dist/pitchpro.umd.js';
        script.onload = () => {
            const { AudioDetectionComponent } = window.PitchPro;
            
            let audioDetector = null;
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const logDisplay = document.getElementById('log-display');
            
            // „É≠„Ç∞Ë°®Á§∫Èñ¢Êï∞
            function addLog(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString('ja-JP', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit',
                    fractionalSecondDigits: 3 
                });
                const logEntry = document.createElement('div');
                const color = type === 'error' ? '#ef4444' : 
                             type === 'warning' ? '#f59e0b' : 
                             type === 'success' ? '#10b981' : '#60a5fa';
                logEntry.style.color = color;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logDisplay.appendChild(logEntry);
                logDisplay.scrollTop = logDisplay.scrollHeight;
                
                // „É≠„Ç∞„ÅåÂ§ö„Åè„Å™„Å£„Åü„ÇâÂè§„ÅÑ„ÇÇ„ÅÆ„ÇíÂâäÈô§
                if (logDisplay.children.length > 100) {
                    logDisplay.removeChild(logDisplay.firstChild);
                }
            }
            
            // ÈñãÂßã„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
            startBtn.addEventListener('click', async () => {
                try {
                    addLog('AudioDetectionComponentÂàùÊúüÂåñÈñãÂßã...', 'info');
                    
                    // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà‰ΩúÊàê
                    audioDetector = new AudioDetectionComponent({
                        // UIË¶ÅÁ¥†„ÅÆ„Çª„É¨„ÇØ„Çø„Éº
                        volumeBarSelector: '#volume-bar',
                        volumeTextSelector: '#volume-text',
                        frequencySelector: '#frequency-display',
                        noteSelector: '#note-display',
                        
                        // Ê§úÂá∫Ë®≠ÂÆö
                        clarityThreshold: 0.4,
                        minVolumeAbsolute: 0.003,
                        
                        // „Éá„Éê„Ç§„ÇπÊúÄÈÅ©Âåñ
                        deviceOptimization: true,
                        
                        // UIÊõ¥Êñ∞„É¨„Éº„Éà
                        uiUpdateInterval: 50, // 20fps
                        
                        // „Éá„Éê„ÉÉ„Ç∞
                        debug: true,
                        logPrefix: 'üéµ AudioDetection'
                    });
                    
                    // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØË®≠ÂÆö
                    audioDetector.setCallbacks({
                        onPitchUpdate: (result) => {
                            // Èü≥Á®ãÊ§úÂá∫ÊôÇÔºàÈ†ªÂ∫¶„ÅåÈ´ò„ÅÑ„ÅÆ„ÅßÊù°‰ª∂‰ªò„Åç„Åß„É≠„Ç∞Ôºâ
                            if (Math.random() < 0.1) { // 10%„ÅÆÁ¢∫Áéá„Åß„É≠„Ç∞
                                addLog(`Èü≥Á®ãÊ§úÂá∫: ${result.note} (${result.frequency.toFixed(1)}Hz, Èü≥Èáè: ${result.volume.toFixed(1)}%)`, 'success');
                            }
                        },
                        onVolumeUpdate: (volume) => {
                            // Èü≥ÈáèÊõ¥Êñ∞ÔºàUI„ÅßË°®Á§∫„Åï„Çå„Çã„ÅÆ„Åß„É≠„Ç∞„ÅØ‰∏çË¶ÅÔºâ
                        },
                        onStateChange: (state) => {
                            addLog(`Áä∂ÊÖãÂ§âÊõ¥: ${state}`, 'warning');
                            document.getElementById('state-display').textContent = state;
                            
                            // „Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
                            if (state === 'detecting') {
                                startBtn.disabled = true;
                                stopBtn.disabled = false;
                            } else {
                                startBtn.disabled = false;
                                stopBtn.disabled = true;
                            }
                        },
                        onError: (error) => {
                            addLog(`„Ç®„É©„Éº: ${error.message}`, 'error');
                        },
                        onDeviceDetected: (specs) => {
                            addLog(`„Éá„Éê„Ç§„ÇπÊ§úÂá∫: ${specs.deviceType}`, 'info');
                            document.getElementById('device-type').textContent = specs.deviceType;
                            document.getElementById('device-sensitivity').textContent = `${specs.deviceConfig.sensitivity}x`;
                        }
                    });
                    
                    // ÂàùÊúüÂåñ
                    addLog('„Éû„Ç§„ÇØÂàùÊúüÂåñ‰∏≠...', 'info');
                    await audioDetector.initialize();
                    addLog('ÂàùÊúüÂåñÂÆå‰∫Ü', 'success');
                    
                    // Ê§úÂá∫ÈñãÂßã
                    audioDetector.startDetection();
                    addLog('Èü≥Â£∞Ê§úÂá∫ÈñãÂßã', 'success');
                    
                } catch (error) {
                    addLog(`ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, 'error');
                    console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                }
            });
            
            // ÂÅúÊ≠¢„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
            stopBtn.addEventListener('click', () => {
                if (audioDetector) {
                    audioDetector.stopDetection();
                    addLog('Èü≥Â£∞Ê§úÂá∫ÂÅúÊ≠¢', 'warning');
                }
            });
            
            // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            window.addEventListener('beforeunload', () => {
                if (audioDetector) {
                    audioDetector.destroy();
                }
            });
            
            addLog('AudioDetectionComponent„ÉÜ„Çπ„Éà„Éö„Éº„Ç∏Ê∫ñÂÇôÂÆå‰∫Ü', 'info');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>