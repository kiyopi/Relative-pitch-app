<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ ãƒ‡ãƒ¢ - ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/base.css">
    <link rel="stylesheet" href="../styles/results.css">
    <link rel="stylesheet" href="../styles/training.css">
    <link rel="stylesheet" href="css/voice-range-test.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-purple">
                        <i data-lucide="package" class="text-white" data-stroke-width="2" class="icon-xl"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">VoiceRangeTestController ãƒ‡ãƒ¢</h1>
                    <p class="page-subtitle text-purple-200">PitchPro v1.3.1çµ±åˆç‰ˆ - ãƒ¯ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã§å®Œå…¨ãªéŸ³åŸŸãƒ†ã‚¹ãƒˆ</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- ãƒã‚¤ã‚¯è¨±å¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div style="text-align: center; padding: 20px 0;">
                <button class="btn btn-primary mic-button mic-idle system-control-btn" id="request-mic-permission">
                    <i data-lucide="mic" class="icon-md"></i>
                    <span>ãƒã‚¤ã‚¯è¨±å¯ã‚’è¦æ±‚</span>
                </button>

                <div id="mic-permission-status" class="mt-4" aria-live="polite">
                    <p class="text-sm" id="mic-status-text">ãƒã‚¤ã‚¯ã®è¨±å¯ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
                </div>
            </div>
            
            <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒªã‚¢ -->
            <div class="glass-card">
                <div class="section-header">
                    <div>
                        <h3 class="text-section-title">éŸ³åŸŸãƒ†ã‚¹ãƒˆ</h3>
                        <p class="section-description">ã‚ãªãŸã®å¿«é©ãªéŸ³åŸŸã‚’æ¸¬å®šã—ã¾ã™</p>
                        <!-- ãƒã‚¤ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ -->
                        <div class="text-center">
                            <div class="mic-status-container standby" id="mic-status-container" style="margin: 12px auto 0 auto;">
                                <i data-lucide="mic" id="mic-status-icon" style="width: 40px; height: 40px;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="text-center mb-6">
                    <h4 class="voice-range-main-text" id="main-status-text">ã€ŒéŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„</h4>
                </div>
                
                <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒãƒƒã‚¸ -->
                <div class="range-test-layout-flex">
                    <div class="range-test-item">
                        <div class="voice-range-display-container">
                            <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                                <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                                <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16" 
                                        stroke-dasharray="452" stroke-dashoffset="452" 
                                        transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                            </svg>
                            <div class="voice-note-badge">
                                <div id="range-icon" class="icon-4xl text-white" style="display: block;">
                                    <img src="./icons/arrow-down.png" alt="ä¸‹å‘ãçŸ¢å°" style="width: 80px; height: 80px; display: block;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚µãƒ–æƒ…å ± -->
                <div class="text-center mt-4">
                    <p class="text-sm voice-range-sub-text" id="sub-info-text">å¾…æ©Ÿä¸­...</p>
                </div>

                <!-- æ¤œå‡ºçŠ¶æ³è¡¨ç¤º -->
                <div class="detection-meters" style="margin-top: 24px;">
                    <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                    <div class="meter-group" id="range-volume-container">
                        <div class="meter-label">
                            <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                            <span class="volume-text meter-value" id="range-test-volume-text">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill gradient-catalog-green" 
                                 id="range-test-volume-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                            <span class="meter-value" id="range-test-frequency-value">0 Hz</span>
                        </div>
                    </div>
                </div>
                
                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆå®Ÿç”¨æ©Ÿèƒ½ã®ã¿ï¼‰ -->
                <div class="text-center mt-6">
                    <button class="btn btn-primary voice-range-btn" id="begin-range-test-btn" disabled>
                        <i data-lucide="play" class="icon-sm"></i>
                        <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</span>
                    </button>

                    <button class="btn btn-outline ml-3 voice-range-btn btn-hidden" id="retry-measurement-btn">
                        <i data-lucide="refresh-cw" class="icon-sm"></i>
                        <span>å†æ¸¬å®š</span>
                    </button>
                </div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div class="glass-card mt-6 hidden" id="results-section">
                <h3 class="heading-md">
                    <i data-lucide="bar-chart-3" class="text-green-300"></i>
                    <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆçµæœ</span>
                </h3>

                <!-- åŸºæœ¬çµæœ -->
                <div class="result-info-container">
                    <div class="result-info-row">
                        <span>ğŸµ éŸ³åŸŸç¯„å›²</span>
                        <span class="result-info-value" id="result-range">-</span>
                    </div>
                    <div class="result-info-row">
                        <span>ğŸ¹ ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                        <span class="result-info-value" id="result-octaves">-</span>
                    </div>
                    <div class="result-info-row">
                        <span>ğŸ”½ æœ€ä½éŸ³</span>
                        <span class="result-info-value" id="result-low-freq">-</span>
                    </div>
                    <div class="result-info-row">
                        <span>ğŸ”¼ æœ€é«˜éŸ³</span>
                        <span class="result-info-value" id="result-high-freq">-</span>
                    </div>
                </div>

                <!-- è©³ç´°çµ±è¨ˆ -->
                <div class="mt-5">
                    <h4 class="heading-sm">
                        <i data-lucide="activity" class="text-blue-300"></i>
                        <span>æ¸¬å®šçµ±è¨ˆ</span>
                    </h4>
                    <div class="result-info-container" id="result-details">
                        <!-- JavaScript ã§å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>
                </div>

                <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="text-center mt-5">
                    <button class="btn btn-primary voice-range-btn" id="remeasure-btn">
                        <i data-lucide="refresh-cw" class="icon-sm"></i>
                        <span>å†æ¸¬å®š</span>
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- ğŸµ PitchPro v1.3.1 éŸ³å£°å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³ -->
    <script src="js/core/pitchpro-v1.3.1.umd.js"></script>

    <!-- ğŸ“Š ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="../../js/data-manager.js"></script>

    <!-- ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«éŸ³å£°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="js/core/global-audio-manager.js"></script>

    <!-- ğŸµ æ—¢å­˜éŸ³åŸŸãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ -->
    <script src="js/voice-range-test-demo.js"></script>

    <!-- ğŸ”’ Step2ã‚·ãƒ³ãƒ—ãƒ«åˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨ï¼‰ -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“„ Step2 DOMèª­ã¿è¾¼ã¿å®Œäº†');
            if (typeof lucide !== 'undefined') lucide.createIcons();

            try {
                // === ç°¡æ˜“çŠ¶æ…‹æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚º ===
                console.log('ğŸ” Step1å®Œäº†çŠ¶æ…‹ã‚’ç¢ºèª');

                // 1. DataManagerã‹ã‚‰ã®çŠ¶æ…‹ç¢ºèª
                const progressData = DataManager?.getFromStorage('preparationProgress');
                console.log('ğŸ“Š DataManagerçŠ¶æ…‹:', progressData);

                if (!progressData || !progressData.step1Completed) {
                    console.warn('âš ï¸ Step1ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
                    // Step1ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    setTimeout(() => {
                        window.location.href = 'preparation-step1.html';
                    }, 2000);

                    const mainStatus = document.getElementById('main-status-text');
                    if (mainStatus) {
                        mainStatus.textContent = 'Step1ã‹ã‚‰é–‹å§‹ã—ã¦ãã ã•ã„';
                    }
                    return;
                }

                console.log('âœ… Step1å®Œäº†ç¢ºèª - Step2åˆæœŸåŒ–é–‹å§‹');

                // === Step2ã‚·ãƒ³ãƒ—ãƒ«åˆæœŸåŒ–ãƒ•ã‚§ãƒ¼ã‚º ===
                initializeStep2Simple();

            } catch (error) {
                console.error('âŒ Step2åˆæœŸåŒ–å¤±æ•—:', error.message);
                await handleStep2InitializationError(error);
            }
        });

        // Step2ã‚·ãƒ³ãƒ—ãƒ«åˆæœŸåŒ–é–¢æ•°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œèµ·ç‚¹ç‰ˆï¼‰
        function initializeStep2Simple() {
            console.log('ğŸš€ Step2ã‚·ãƒ³ãƒ—ãƒ«åˆæœŸåŒ–å‡¦ç†é–‹å§‹');

            // UIçŠ¶æ…‹ã‚’æº–å‚™å®Œäº†ã«è¨­å®šï¼ˆPitchProåˆæœŸåŒ–ã¯ã—ãªã„ï¼‰
            const mainStatus = document.getElementById('main-status-text');
            const subInfo = document.getElementById('sub-info-text');
            const beginBtn = document.getElementById('begin-range-test-btn');

            if (mainStatus) mainStatus.textContent = 'ã€ŒéŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ã€ãƒœã‚¿ãƒ³ã§æ¸¬å®šã‚’é–‹å§‹ã—ã¾ã™';
            if (subInfo) subInfo.textContent = 'æº–å‚™å®Œäº†';

            // éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            if (beginBtn) {
                beginBtn.disabled = false;
                console.log('âœ… éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–');

                beginBtn.addEventListener('click', handleStartTestClick);
            }

            console.log('âœ… Step2ã‚·ãƒ³ãƒ—ãƒ«åˆæœŸåŒ–å®Œäº†ï¼ˆPitchProåˆæœŸåŒ–ã¯å¾…æ©Ÿä¸­ï¼‰');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã‚’èµ·ç‚¹ã¨ã—ãŸéŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹å‡¦ç†
        async function handleStartTestClick() {
            console.log('ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');
            const beginBtn = document.getElementById('begin-range-test-btn');

            if (beginBtn) {
                beginBtn.disabled = true;
                beginBtn.innerHTML = '<span>åˆæœŸåŒ–ä¸­...</span>';
            }

            try {
                // ã€é‡è¦ã€‘ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã‚’èµ·ç‚¹ã«PitchProã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—ãƒ»åˆæœŸåŒ–
                console.log('ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œèµ·ç‚¹ã§globalAudioManagerã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—...');
                const audioDetector = await window.globalAudioManager.getInstance();
                console.log('ğŸµ PitchProã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—ãƒ»åˆæœŸåŒ–å®Œäº†ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯è¡¨ç¤ºã•ã‚Œãªã„ã¯ãšï¼‰');

                // æ—¢å­˜ã®éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆvoice-range-test-demo.jsï¼‰ã‚’å‘¼ã³å‡ºã™
                if (typeof window.startVoiceRangeTest === 'function') {
                    await window.startVoiceRangeTest(audioDetector); // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¼•æ•°ã§æ¸¡ã™
                } else {
                    console.error('âŒ startVoiceRangeTesté–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }

            } catch (error) {
                console.error('âŒ éŸ³åŸŸãƒ†ã‚¹ãƒˆã®é–‹å§‹ã«å¤±æ•—:', error);
                handleStep2InitializationError(error);
            }
        }

        // æ—§åˆæœŸåŒ–é–¢æ•°ï¼ˆä½¿ç”¨ã—ãªã„ï¼‰
        async function initializeStep2(progressData, audioDetector) {
            console.log('ğŸš€ Step2åˆæœŸåŒ–å‡¦ç†é–‹å§‹', { progressData, audioDetector });

            // Step2ç”¨UIã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šï¼ˆStep1ç¢ºç«‹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            if (audioDetector.updateSelectors) {
                // 1. ã¾ãšè¡¨ç¤ºè¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆv1.3.1æ¨å¥¨ï¼‰
                if (audioDetector.resetDisplayElements) {
                    await audioDetector.resetDisplayElements();
                    console.log('ğŸ”„ UIè¡¨ç¤ºè¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆ');
                }

                // 2. Step2ç”¨ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è¨­å®š
                audioDetector.updateSelectors({
                    volumeBarSelector: '#range-test-volume-bar',
                    volumeTextSelector: '#range-test-volume-text',
                    frequencySelector: '#range-test-frequency-value'
                });
                console.log('ğŸ›ï¸ Step2ç”¨UIã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼è¨­å®šå®Œäº†');

                // 3. éŸ³å£°æ¤œå‡ºã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®šï¼ˆv1.3.1å¿…é ˆï¼‰
                if (audioDetector.setCallbacks) {
                    audioDetector.setCallbacks({
                        onPitchUpdate: (result) => {
                            // éŸ³åŸŸãƒ†ã‚¹ãƒˆä¸­ã®å‡¦ç†ã¯ voice-range-test-demo.js ãŒæ‹…å½“
                            console.log('ğŸµ éŸ³å£°æ¤œå‡ºã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å—ä¿¡:', result.frequency);
                        }
                    });
                    console.log('ğŸ“ éŸ³å£°æ¤œå‡ºã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šå®Œäº†');
                }
            } else {
                console.warn('âš ï¸ audioDetector.updateSelectors ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const beginBtn = document.getElementById('begin-range-test-btn');
            console.log('ğŸ” ãƒœã‚¿ãƒ³è¦ç´ ç¢ºèª:', {
                element: beginBtn,
                disabled: beginBtn?.disabled,
                className: beginBtn?.className
            });

            if (beginBtn) {
                beginBtn.disabled = false;
                console.log('âœ… ãƒœã‚¿ãƒ³ã®disabledå±æ€§ã‚’è§£é™¤');

                beginBtn.addEventListener('click', async () => {
                    console.log('ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯');

                    // PitchPro v1.3.1æº–æ‹ : éŸ³å£°æ¤œå‡ºã‚’é–‹å§‹
                    if (audioDetector.startDetection) {
                        try {
                            console.log('ğŸ¤ éŸ³å£°æ¤œå‡ºã‚’é–‹å§‹ã—ã¾ã™...');
                            await audioDetector.startDetection();
                            console.log('âœ… éŸ³å£°æ¤œå‡ºé–‹å§‹æˆåŠŸ');
                        } catch (error) {
                            console.error('âŒ éŸ³å£°æ¤œå‡ºé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                        }
                    }

                    // startVoiceRangeTesté–¢æ•°ã®å­˜åœ¨ç¢ºèª
                    console.log('ğŸ” startVoiceRangeTesté–¢æ•°ç¢ºèª:', {
                        exists: typeof window.startVoiceRangeTest === 'function',
                        type: typeof window.startVoiceRangeTest
                    });

                    // æ—¢å­˜ã®éŸ³åŸŸãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’æ´»ç”¨
                    if (typeof window.startVoiceRangeTest === 'function') {
                        try {
                            await window.startVoiceRangeTest();
                        } catch (error) {
                            console.error('âŒ startVoiceRangeTestå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                        }
                    } else {
                        console.error('âŒ startVoiceRangeTesté–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                });
                console.log('ğŸ¯ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
            } else {
                console.error('âŒ begin-range-test-btnè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨ã—ã¦å…¬é–‹ï¼ˆvoice-range-test-demo.jsã‹ã‚‰ä½¿ç”¨ï¼‰
            window.globalAudioDetector = audioDetector;
            console.log('ğŸŒ AudioDetectorã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹');

            // Step2çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
            updateStep2UI('ready', progressData);
            console.log('âœ… Step2åˆæœŸåŒ–å®Œäº†');
        }

        // Step2åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼å‡¦ç†
        async function handleStep2InitializationError(error) {
            console.error('ğŸš¨ Step2åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);

            // çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ã—ã¦Step1ã«æˆ»ã‚‹
            if (typeof DataManager !== 'undefined') {
                DataManager.saveToStorage('preparationProgress', null);
                console.log('ğŸ§¹ çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
            }

            // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const mainStatusText = document.getElementById('main-status-text');
            const subInfoText = document.getElementById('sub-info-text');

            if (mainStatusText) {
                mainStatusText.textContent = 'æº–å‚™ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“';
            }
            if (subInfoText) {
                subInfoText.innerHTML = `
                    ã‚¨ãƒ©ãƒ¼: ${error.message}<br>
                    <a href="preparation-step1.html" class="text-blue-300 hover:underline">
                        æº–å‚™ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ï¼ˆ3ç§’å¾Œè‡ªå‹•é·ç§»ï¼‰
                    </a>
                `;
            }

            // 3ç§’å¾Œã«è‡ªå‹•ã§Step1ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            setTimeout(() => {
                window.location.href = 'preparation-step1.html';
            }, 3000);
        }

        // Step2 UIçŠ¶æ…‹æ›´æ–°
        function updateStep2UI(state, progressData) {
            const mainStatusText = document.getElementById('main-status-text');
            const subInfoText = document.getElementById('sub-info-text');

            switch (state) {
                case 'ready':
                    if (mainStatusText) {
                        mainStatusText.textContent = 'Step1å®Œäº†ï¼éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„';
                    }
                    if (subInfoText) {
                        const completedTime = new Date(progressData.completedAt).toLocaleTimeString();
                        subInfoText.textContent = `Step1å®Œäº†æ™‚åˆ»: ${completedTime}`;
                    }
                    break;
            }
        }
    </script>
</body>
</html>