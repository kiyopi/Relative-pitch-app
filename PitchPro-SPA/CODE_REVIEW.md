# コードレビュー報告書: PitchPro-SPA

## 1. エグゼクティブサマリー

PitchPro-SPAアプリケーションは、高い成熟度とエンジニアリングの厳密さを示しています。コードベースは適切に構造化されており、コントローラー、コアロジック、UI管理の間で関心の分離が明確になされています。アプリケーションのアーキテクチャは、複雑なオーディオ要件を持つシングルページアプリケーション（SPA）の課題、特に異なるデバイス（iOS/Android/Desktop）やナビゲーション状態にまたがる `AudioContext` ライフサイクルの管理を効果的に処理しています。

「脳内ピアノ理論」の実装と多様なトレーニングモードは堅牢で、セッション管理、評価、プレミアム分析のための洗練されたロジックを備えています。コードベースには、設計上の決定を説明する詳細な変更ログとコメントがあり、活発なメンテナンスと反復的な改善の証拠が見られます。

## 2. アーキテクチャと設計

### 2.1 SPAアーキテクチャとナビゲーション
独自のハッシュベースルーター（`SimpleRouter`）と `NavigationManager` の組み合わせは、SPAの強固な基盤を提供しています。
*   **強み:**
    *   **堅牢なナビゲーション制御:** `NavigationManager` は、トレーニングページへのアクセスを許可する前に必要な前提条件（マイク許可、音域データ）が満たされていることを確認する、洗練された「4層防御」システムを実装しています。これにより、状態の欠落による実行時エラーを効果的に防止しています。
    *   **リロード処理:** アプリケーションはページのリロードをインテリジェントに処理し、実際のリロード（状態の復元やリダイレクトが必要）とブラウザ/タブの切り替えイベントを区別しています。
    *   **ライフサイクル管理:** `router.js` の `cleanup` フックにより、ページ遷移時に `AudioContext` や `MediaStream` などの重いリソースが適切に解放され、メモリリークやオーディオの競合を防いでいます。

### 2.2 状態管理
状態は、特化したシングルトンクラス（`SessionManager`, `ModeController`）を通じて効果的に管理され、`localStorage` と `sessionStorage` を介して永続化されています。
*   **強み:**
    *   **信頼できる唯一の情報源 (Single Source of Truth):** `ModeController` は、すべてのモード関連設定（セッション数、基音選択ロジック、UIカラー）を一元管理しており、トレーニングモードの追加や変更が容易です。
    *   **セッションの整合性:** `SessionManager` は、`lessonId`（セッションのグループ化用）と個々のセッションカウントの区別を正しく処理しており、セッション追跡に関連する以前のバグに対処しています。
    *   **永続性:** 重要なユーザーデータ（音域、設定）は `localStorage` に保存され、一時的なセッション状態は `sessionStorage` に保持されるため、誤ってリロードした後でもシームレスなユーザー体験が可能になっています。

### 2.3 オーディオ処理
アプリケーションは、再生に `PitchShifter`（Tone.jsラッパー）、入力に `PitchPro.AudioDetectionComponent` を使用しています。
*   **強み:**
    *   **デバイス固有の調整:** `PitchShifter` には、iPadスピーカー向けの最適化（ベロシティ調整）や、一般的なクリックノイズ（「ブチ音」）防止ロジック（エンベロープ調整）が含まれています。
    *   **ノイズ耐性:** `PitchProConfig` は、バックグラウンドノイズを除去するために明瞭度と音量の厳格な閾値を定義しており、モバイルデバイスでよく見られる低周波ノイズに対する具体的な調整も行われています。
    *   **競合防止:** `trainingController.js` は、基音再生中にアプリが「自分自身の音を聞く」ことを防ぐため、音声検出の停止を慎重に調整しています。

## 3. コンポーネント別レビュー

### 3.1 `trainingController.js` (2000行以上)
これはトレーニング体験の中核となるオーケストレーターです。
*   **観察事項:**
    *   **包括的なロジック:** UI更新、オーディオ再生からピッチ検出、セッション記録まで、すべてを処理しています。
    *   **複雑さ:** コメントで整理されていますが、ファイルサイズはかなり大きいです。ビジネスロジック（フロー制御）とUI操作が混在しています。
    *   **推奨事項:** UI更新ロジックを別の `TrainingUIManager` クラスにリファクタリングして、コントローラーのサイズを縮小し、テスト容易性を向上させることを検討してください。

### 3.2 `session-data-recorder.js`
*   **観察事項:**
    *   **堅実な実装:** データ構造と永続化を正しく処理しています。
    *   **レッスンIDのサポート:** `lessonId` の統合により、セッションが正しくグループ化されており、これは「連続チャレンジ」モードや「12音階」モードにとって重要です。

### 3.3 `evaluation-calculator.js`
*   **観察事項:**
    *   **動的評価:** デバイスの品質やモードの難易度に基づいた動的評価のロジックは洗練されており、ユーザーフレンドリーです。
    *   **公平性:** マイク性能が低いユーザーが不当に不利にならないよう、評価閾値を調整する「デバイス品質検出」が含まれています。

### 3.4 `premium-analysis-*.js`
*   **観察事項:**
    *   **豊富な機能:** プレミアム分析は十分に実装されており、深い洞察（音程精度、脳内処理パターン、エラー傾向）を提供しています。
    *   **モジュール性:** 計算ロジック（`Calculator`）とUIロジック（`Controller`）の分離が優れています。

## 4. コード品質とベストプラクティス

*   **ドキュメンテーション:** コードには頻繁にコメントが付けられており、特定のバグ修正やデバイスの癖など、*なぜ* そのようにしたのかが説明されています。これは保守において非常に価値があります。
*   **エラーハンドリング:** 特に `getUserMedia` や `AudioContext` の状態に関して広範なエラーハンドリングがあり、問題が発生した際にアプリが適切に動作を継続するか、ユーザーに有益な情報を通知するようになっています。
*   **モダンJS:** コードは、モダンなJavaScript機能（async/await、クラス、モジュール）を効果的に使用しています。

## 5. 特定された課題と推奨事項

### 5.1 リファクタリングの可能性
*   **`trainingController.js` のサイズ:** 前述の通り、このファイルを分割することで保守性が向上します。
*   **ハードコードされた値:** 多くの定数は設定ファイルにありますが、一部のロジック（特定のCSSクラス名やタイムアウト時間など）は散在しています。これらをさらに一元化すると有益でしょう。

### 5.2 エッジケース
*   **iOSでのAudio Context:** iOSでのAudioContextサスペンドに対する多くの回避策がありますが、これはWeb Audioにとって依然として脆弱な領域です。新しいiOSバージョンでの継続的なテストが推奨されます。
*   **パフォーマンス:** `PitchProConfig` ではパフォーマンスのために2048のFFTサイズを使用していると言及されています。非常に低スペックなデバイスでは、これが依然として重い可能性があります。フレームレートに基づいた動的な品質調整は、将来的な拡張機能として考えられます。

## 6. 結論

PitchPro-SPAのコードベースは非常に良好な状態です。Web AudioとSPAの状態管理に関連する複雑な技術的課題を、堅牢でよく考えられたソリューションで解決しています。アーキテクチャは現在の機能を十分にサポートしており、将来の追加（計画されている「弱点克服」モードなど）に対しても拡張性があるように見えます。

**評価: 優秀**
*   **アーキテクチャ:** 9/10
*   **コード品質:** 9/10
*   **ドキュメンテーション:** 10/10
*   **堅牢性:** 9/10

## 7. 最近のバグ調査報告 (Volume Sensitivity Issue)

### 7.1 概要
ユーザーから報告された「マイクテストでボリュームバーが簡単に100%になる」「レンジテストでノイズを拾う」「トレーニング画面でボリュームバーが激しく動く」という問題について調査を行いました。

### 7.2 特定された問題点

#### A. PitchProライブラリ (v1.3.8) のバグ
*   **事象:** `updateSelectors` メソッドが `autoUpdateUI` パラメータを受け取るものの、内部設定 (`this.config.autoUpdateUI`) に反映するロジックが欠落していました。
*   **影響:** 外部（`trainingController.js`）からUIの自動更新を制御しようとしても無視され、ライブラリのデフォルト動作が優先されてしまう可能性があります。

#### B. `trainingController.js` の実装不整合
*   **事象:** `AudioDetectionComponent` の再利用時に `autoUpdateUI: false` を設定していましたが、コントローラー側でボリュームバーを手動更新するロジックが実装されていませんでした（または機能していませんでした）。
*   **影響:** 本来はボリュームバーが動かないはずですが、上記のライブラリバグにより「意図せず動いていた」状態でした。
*   **デバッグログの誤り:** 1219行目に `rawVolume * 200 * 3` という古い計算式に基づくデバッグログが残っており、これが混乱を招く要因となっていました（現在のライブラリは0-100%の値を返します）。

#### C. iPhoneの感度設定過多
*   **事象:** PitchProライブラリ内部のデバイス最適化設定において、iPhoneの `volumeMultiplier` が `3` に設定されていました。
*   **影響:** v1.3.8でのスケーリング変更（x100）と合わせると、入力レベルが約33%の時点で出力が100%に達してしまい、過敏な反応を引き起こしていました。

### 7.3 適用された修正内容 (v1.3.9)
1.  **ライブラリ修正 (v1.3.9):**
    *   `updateSelectors` で `autoUpdateUI` を正しく処理するように修正。
    *   iPhoneの `volumeMultiplier` を `3` から `2` に引き下げ、`noiseGate` を `0.028` から `0.04` に調整して感度を適正化。
2.  **コントローラー修正:**
    *   `trainingController.js` で `autoUpdateUI: true` を明示的に設定し、ライブラリの正規のUI更新機能を利用する。
    *   古いデバッグログを削除。
