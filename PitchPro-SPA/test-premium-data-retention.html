<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“ç®¡ç† - ãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="styles/base.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .test-section {
            margin-bottom: 2rem;
        }

        .test-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .test-result {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-free {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .status-premium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .alert-normal {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.1);
            color: #fbbf24;
        }

        .alert-critical {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <header>
            <h1 class="text-3xl font-bold text-white mb-2">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“ç®¡ç† - ãƒ†ã‚¹ãƒˆ</h1>
            <p class="text-white-60">data-manager.js v2.1.0 ã®å‹•ä½œç¢ºèª</p>
        </header>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                <div id="current-status"></div>
            </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</h2>
                <div class="test-controls">
                    <button class="btn btn-primary" onclick="generateTestSessions(10, 1)">
                        10ä»¶ç”Ÿæˆï¼ˆ1æ—¥å‰ï¼‰
                    </button>
                    <button class="btn btn-primary" onclick="generateTestSessions(10, 5)">
                        10ä»¶ç”Ÿæˆï¼ˆ5æ—¥å‰ï¼‰
                    </button>
                    <button class="btn btn-primary" onclick="generateTestSessions(20, 10)">
                        20ä»¶ç”Ÿæˆï¼ˆ10æ—¥å‰ï¼‰
                    </button>
                    <button class="btn btn-primary" onclick="generateTestSessions(50, 30)">
                        50ä»¶ç”Ÿæˆï¼ˆ30æ—¥å‰ï¼‰
                    </button>
                    <button class="btn btn-danger" onclick="clearAllSessions()">
                        å…¨å‰Šé™¤
                    </button>
                </div>
                <div id="generate-result" class="test-result"></div>
            </div>
        </div>

        <!-- ãƒ—ãƒ©ãƒ³åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">ãƒ—ãƒ©ãƒ³åˆ‡ã‚Šæ›¿ãˆ</h2>
                <div class="test-controls">
                    <button class="btn btn-secondary" onclick="switchToFree()">
                        ç„¡æ–™ãƒ—ãƒ©ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
                    </button>
                    <button class="btn btn-primary" onclick="switchToPremium()">
                        ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
                    </button>
                </div>
                <div id="plan-result" class="test-result"></div>
            </div>
        </div>

        <!-- ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ</h2>
                <div class="test-controls">
                    <button class="btn btn-primary" onclick="testCleanup()">
                        ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
                    </button>
                    <button class="btn btn-secondary" onclick="testSaveWithCleanup()">
                        ä¿å­˜+ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
                    </button>
                </div>
                <div id="cleanup-result" class="test-result"></div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ä¿å­˜çŠ¶æ³ -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">ãƒ‡ãƒ¼ã‚¿ä¿å­˜çŠ¶æ³</h2>
                <button class="btn btn-primary" onclick="showRetentionInfo()">
                    ä¿å­˜çŠ¶æ³ã‚’ç¢ºèª
                </button>
                <div id="retention-info" class="test-result"></div>
            </div>
        </div>

        <!-- å®¹é‡è­¦å‘Šãƒã‚§ãƒƒã‚¯ -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">å®¹é‡è­¦å‘Šãƒã‚§ãƒƒã‚¯</h2>
                <button class="btn btn-primary" onclick="checkWarning()">
                    å®¹é‡è­¦å‘Šã‚’ç¢ºèª
                </button>
                <div id="warning-result"></div>
            </div>
        </div>

        <!-- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚° -->
        <div class="test-section">
            <div class="glass-card">
                <h2 class="heading-md mb-4">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°</h2>
                <button class="btn btn-secondary" onclick="clearLog()">
                    ãƒ­ã‚°ã‚¯ãƒªã‚¢
                </button>
                <div id="console-log" class="test-result"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="js/data-manager.js"></script>

    <script>
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã‚­ãƒ£ãƒ—ãƒãƒ£
        const logMessages = [];
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        console.log = function(...args) {
            logMessages.push({ type: 'log', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateLogDisplay();
            originalLog.apply(console, args);
        };

        console.warn = function(...args) {
            logMessages.push({ type: 'warn', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateLogDisplay();
            originalWarn.apply(console, args);
        };

        console.error = function(...args) {
            logMessages.push({ type: 'error', message: args.join(' '), time: new Date().toLocaleTimeString() });
            updateLogDisplay();
            originalError.apply(console, args);
        };

        function updateLogDisplay() {
            const logDiv = document.getElementById('console-log');
            logDiv.innerHTML = logMessages.slice(-20).reverse().map(log => {
                const color = log.type === 'error' ? '#ef4444' : log.type === 'warn' ? '#fbbf24' : '#22c55e';
                return `<div style="color: ${color}">[${log.time}] ${log.message}</div>`;
            }).join('\n');
        }

        function clearLog() {
            logMessages.length = 0;
            updateLogDisplay();
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateStatus() {
            const statusDiv = document.getElementById('current-status');
            const subscriptionData = DataManager.getSubscriptionData();
            const isPremium = subscriptionData.premiumAccess.status === 'active';
            const sessions = DataManager.getFromStorage('sessionData') || [];
            const storageUsage = DataManager.getStorageUsage();

            const statusBadge = isPremium
                ? '<span class="status-badge status-premium">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡</span>'
                : '<span class="status-badge status-free">ç„¡æ–™ä¼šå“¡</span>';

            statusDiv.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${sessions.length}</div>
                        <div class="stat-label">ä¿å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${storageUsage.totalMB.toFixed(2)}MB</div>
                        <div class="stat-label">ä½¿ç”¨å®¹é‡ / 5MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${storageUsage.usage}%</div>
                        <div class="stat-label">ä½¿ç”¨ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${isPremium ? '#fbbf24' : '#9ca3af'}">
                            ${statusBadge}
                        </div>
                        <div class="stat-label">ä¼šå“¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
                    </div>
                </div>
            `;
        }

        // ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
        function generateTestSessions(count, daysAgo) {
            const sessions = DataManager.getFromStorage('sessionData') || [];
            const baseTime = Date.now() - (daysAgo * 24 * 60 * 60 * 1000);

            for (let i = 0; i < count; i++) {
                const session = {
                    sessionId: sessions.length + i + 1,
                    mode: 'random',
                    baseNote: 'C4',
                    baseFrequency: 261.63,
                    startTime: baseTime + (i * 60000), // 1åˆ†é–“éš”
                    endTime: baseTime + (i * 60000) + 180000,
                    duration: 180000,
                    completed: true,
                    pitchErrors: generatePitchErrors()
                };
                sessions.push(session);
            }

            DataManager.saveToStorage('sessionData', sessions);
            console.log(`âœ… ${count}ä»¶ã®ãƒ†ã‚¹ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆ${daysAgo}æ—¥å‰ï¼‰`);

            const resultDiv = document.getElementById('generate-result');
            resultDiv.textContent = `${count}ä»¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆ${daysAgo}æ—¥å‰ï¼‰\nç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${sessions.length}ä»¶`;

            updateStatus();
        }

        function generatePitchErrors() {
            const errors = [];
            for (let i = 0; i < 8; i++) {
                errors.push({
                    step: i,
                    expectedNote: 'C4',
                    expectedFrequency: 261.63,
                    detectedFrequency: 261.63 + (Math.random() * 10 - 5),
                    errorInCents: Math.random() * 50 - 25,
                    clarity: 0.9 + Math.random() * 0.1,
                    volume: 0.7 + Math.random() * 0.3,
                    timestamp: Date.now()
                });
            }
            return errors;
        }

        function clearAllSessions() {
            DataManager.saveToStorage('sessionData', []);
            console.log('ğŸ—‘ï¸ å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

            const resultDiv = document.getElementById('generate-result');
            resultDiv.textContent = 'å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ';

            updateStatus();
        }

        // ãƒ—ãƒ©ãƒ³åˆ‡ã‚Šæ›¿ãˆ
        function switchToFree() {
            const subscriptionData = DataManager.getSubscriptionData();
            subscriptionData.premiumAccess.status = 'expired';
            DataManager.saveToStorage('subscriptionData', subscriptionData);

            console.log('ğŸ“Š ç„¡æ–™ãƒ—ãƒ©ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');

            const resultDiv = document.getElementById('plan-result');
            resultDiv.textContent = 'ç„¡æ–™ãƒ—ãƒ©ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ\nä¿å­˜æœŸé–“: 7æ—¥åˆ†ã®ã¿';

            updateStatus();
        }

        function switchToPremium() {
            const subscriptionData = DataManager.getSubscriptionData();
            subscriptionData.premiumAccess.status = 'active';
            subscriptionData.premiumAccess.subscriptionEnd = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString();
            DataManager.saveToStorage('subscriptionData', subscriptionData);

            console.log('âœ¨ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');

            const resultDiv = document.getElementById('plan-result');
            resultDiv.textContent = 'ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ\nä¿å­˜æœŸé–“: ç„¡åˆ¶é™';

            updateStatus();
        }

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
        function testCleanup() {
            console.log('ğŸ§ª ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆé–‹å§‹...');

            const beforeCount = (DataManager.getFromStorage('sessionData') || []).length;
            const afterCount = DataManager.cleanupSessionData();

            const resultDiv = document.getElementById('cleanup-result');
            resultDiv.textContent = `ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œçµæœ:\nå‰Šé™¤å‰: ${beforeCount}ä»¶\nå‰Šé™¤å¾Œ: ${afterCount}ä»¶\nå‰Šé™¤æ•°: ${beforeCount - afterCount}ä»¶`;

            updateStatus();
        }

        function testSaveWithCleanup() {
            console.log('ğŸ§ª ä¿å­˜+ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ†ã‚¹ãƒˆé–‹å§‹...');

            const testSession = {
                sessionId: Date.now(),
                mode: 'random',
                baseNote: 'C4',
                baseFrequency: 261.63,
                startTime: Date.now(),
                endTime: Date.now() + 180000,
                duration: 180000,
                completed: true,
                pitchErrors: generatePitchErrors()
            };

            DataManager.saveSessionResultWithCleanup(testSession);

            const sessions = DataManager.getFromStorage('sessionData') || [];
            const resultDiv = document.getElementById('cleanup-result');
            resultDiv.textContent = `ä¿å­˜+ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œå®Œäº†\nç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${sessions.length}ä»¶`;

            updateStatus();
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜çŠ¶æ³
        function showRetentionInfo() {
            const info = DataManager.getDataRetentionInfo();

            const resultDiv = document.getElementById('retention-info');
            resultDiv.textContent = JSON.stringify(info, null, 2);

            updateStatus();
        }

        // å®¹é‡è­¦å‘Šãƒã‚§ãƒƒã‚¯
        function checkWarning() {
            const warning = DataManager.checkStorageWarning();

            let alertClass = 'alert-normal';
            if (warning.level === 'warning') alertClass = 'alert-warning';
            if (warning.level === 'critical') alertClass = 'alert-critical';

            const resultDiv = document.getElementById('warning-result');
            resultDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <span>${warning.message}</span>
                </div>
                <div class="test-result">${JSON.stringify(warning, null, 2)}</div>
            `;

            updateStatus();
        }

        // åˆæœŸè¡¨ç¤º
        updateStatus();
        console.log('âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ‡ãƒ¼ã‚¿ä¿å­˜æœŸé–“ç®¡ç†ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èµ·å‹•');
    </script>
</body>
</html>
