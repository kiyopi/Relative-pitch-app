# 相対音感トレーニングアプリ - 評価システム仕様書

**バージョン**: 2.2.0
**作成日**: 2025-08-07
**更新日**: 2025-10-29
**用途**: セッション単位（8音）の音程精度評価・採点システムの詳細仕様

**v2.2.0 重要更新内容** (2025-10-29):
- **測定精度の根本的改善**: 前の音の残響除外ロジック実装により異常値完全消滅
- **外れ値除外ロジック削除**: 測定精度向上により不要となった外れ値除外処理を削除
- **評価の信頼性向上**: 実際のユーザーパフォーマンスを正確に反映
- **詳細**: 測定開始から200ms除外し、残り500msの安定期間から最高明瞭度データを選択

**v2.1.0 重要更新内容** (2025-10-29):
- **評価ロジックの統合**: `EvaluationCalculator`に共通評価関数を追加
- **コード重複削除**: セッション評価・総合評価の評価基準を一元管理
- **保守性向上**: 評価基準変更時は`evaluation-calculator.js`の1箇所修正で全体反映
- **一貫性保証**: 全ての評価表示で同一基準を使用

**v2.0.0 重要更新内容**:
- **評価基準の科学的再設計**: デバイス測定誤差（±10〜15¢）を考慮した現実的な基準へ改定
- **新基準**: Excellent ±20¢、Good ±35¢、Pass ±50¢（旧基準より+5〜+10¢緩和）
- **学術的根拠の追加**: 音楽教育研究・プロ歌手の実測データに基づく閾値設定
- **デバイス環境の考慮**: Web Audio API・スマートフォンマイクの測定誤差を明示
- **セッション総合バッジ基準の統一**: 個別音符評価と同じ閾値に変更

**v1.1.0 更新内容** (参考):
- ハイブリッド評価方式の採用（平均スコアと精度割合の組み合わせ）
- 安定性係数による評価の追加
- Lucideアイコン仕様の追加
- S-E級判定基準の厳密化

---

## 🎯 評価システム概要

### 基本原理
相対音感トレーニングにおける評価は、**基音に対する相対的な音程の正確さ**を測定します。
各音階（ドレミファソラシド）における周波数の誤差をセント単位で計測し、その精度に基づいて評価を行います。

### 評価の重要性
- **即時フィードバック**: リアルタイムで自分の音程精度を把握
- **成長の可視化**: 練習による上達を数値とグラフで確認
- **モチベーション維持**: 段階的な評価で達成感を提供
- **弱点の特定**: 苦手な音程を明確化し効率的な練習を促進

### 評価の2つのレイヤー

本システムは**2段階の評価システム**で構成されています：

1. **セッション評価（本仕様書）**: 1セッション（8音）の個別評価
   - 個別音符評価（Excellent/Good/Pass/Practice）
   - セッション総合バッジ（8音の平均誤差による判定）

2. **総合評価（別仕様書）**: 8/12/24セッション完了時の総合判定
   - S/A/B/C/D/E級の総合グレード判定
   - デバイス品質補正・モード別基準適用
   - 詳細は `DYNAMIC_GRADE_LOGIC_SPECIFICATION.md` を参照

---

## 🔬 評価基準の科学的根拠（v2.0.0新規追加）

### デバイス測定誤差の実態

**Web Audio API・スマートフォンマイクの測定誤差**:
- **スマートフォン内蔵マイク**: ±5〜10¢の測定誤差
- **Web Audio API処理誤差**: ±3〜5¢
- **環境ノイズ影響**: ±2〜8¢
- **合計想定誤差**: **±10〜15¢**

### 学術的基準

**音楽教育研究・音声科学の知見**:
- **Just-Noticeable Difference (JND)**: 約5〜10¢（音程差の最小知覚閾値）
- **許容範囲**: ±44¢（Hutchins & Peretz, 2012）
- **良好な音感**: ±20¢以内（音楽教育研究）
- **プロレベル**: ±10¢以内
- **プロ歌手の実測平均**: 20〜30¢（レガート唱法: 22.9¢、スタッカート: 27.1¢）
- **アマチュア歌手の実測平均**: 30〜60¢

### v2.0.0基準の設計方針

**科学的バランス型**:
1. **測定誤差を加味**: デバイス誤差±15¢を考慮した現実的な達成可能ライン
2. **学術基準準拠**: 音楽教育研究・プロ歌手の実測データに基づく閾値
3. **段階的難易度**: 初心者→中級者→上級者の成長を促進

**旧基準（v1.1.0）の問題点**:
- ±15¢基準が厳しすぎる（デバイス誤差±15¢と同等）
- 初心者〜中級者には達成困難
- モチベーション低下のリスク

---

## 📊 評価基準（v2.0.0 - 科学的バランス型）

### 4段階評価システム

#### 🏆 優秀（Excellent）
- **判定基準**: ±20セント以内
- **説明**: 非常に正確な音程。デバイス誤差を超えた真の精度
- **科学的根拠**: デバイス誤差（±15¢）を考慮した「真に正確」なライン、プロ歌手の平均値に近い
- **スコア**: 100点
- **Lucideアイコン**: `trophy` (トロフィーアイコン)
- **表示色**: ゴールド (#FFD700)
- **アニメーション**: キラキラエフェクト

#### ⭐ 良好（Good）
- **判定基準**: ±35セント以内
- **説明**: 良好な精度。実用レベルの音感
- **科学的根拠**: 学術的「良好」基準（±20¢）+ 測定誤差マージン15¢
- **スコア**: 80点
- **Lucideアイコン**: `star` (星アイコン)
- **表示色**: グリーン (#51cf66)
- **アニメーション**: パルスエフェクト

#### 👍 合格（Pass）
- **判定基準**: ±50セント以内
- **説明**: 合格レベル。基本的な音感は身についている
- **科学的根拠**: 学術的許容範囲（±44¢）+ 安全マージン6¢
- **スコア**: 60点
- **Lucideアイコン**: `thumbs-up` (グッドアイコン)
- **表示色**: ブルー (#4c6ef5)
- **アニメーション**: 軽いバウンス

#### ⚠️ 要練習（Need Practice）
- **判定基準**: ±51セント以上
- **説明**: 練習が必要。基礎から丁寧に
- **科学的根拠**: 一般リスナーが「音程がおかしい」と気づく閾値（±50¢）を超える
- **スコア**: 30点
- **Lucideアイコン**: `alert-triangle` (警告アイコン)
- **表示色**: レッド (#dc2626)
- **アニメーション**: 振動エフェクト（励まし）

---

## 📊 旧基準（v1.1.0）との比較表

| 評価レベル | 旧基準（v1.1.0） | 新基準（v2.0.0） | 差分 | 改善効果 |
|-----------|-----------------|-----------------|------|----------|
| Excellent | ±15¢ | ±20¢ | +5¢ | デバイス誤差を考慮、達成率向上 |
| Good | ±25¢ | ±35¢ | +10¢ | 学術的良好基準+マージン |
| Pass | ±40¢ | ±50¢ | +10¢ | 学術的許容範囲+余裕 |
| Practice | >±40¢ | >±50¢ | +10¢ | 改善推奨ライン |

**期待される達成率の変化**:
- **旧基準**: Excellent達成率 約20%（厳しすぎ）
- **新基準**: Excellent達成率 約40%（適度な挑戦）

---

## 🎵 個別音階評価

### 評価プロセス

1. **音程検出**
   ```
   検出周波数 → 目標周波数との比較 → セント誤差計算
   ```

2. **セント誤差の計算式**
   ```
   誤差(セント) = 1200 × log2(検出周波数 / 目標周波数)
   ```

3. **個別採点**
   - 各音階（8音）それぞれに対して評価
   - リアルタイム視覚フィードバック提供
   - 新基準（±20¢/±35¢/±50¢）で判定

### 視覚的フィードバック

#### リアルタイム表示
```
ド: 🏆 +5¢  (優秀 - Excellent)
レ: ⭐ -20¢ (良好 - Good)
ミ: 👍 +35¢ (合格 - Pass)
ファ: ⚠️ +55¢ (要練習 - Practice)
```

#### 精度メーター
```
[========|=======] +5セント
    中心が正確な音程
```

---

## 📈 セッション総合評価（v2.0.0更新）

### セッション総合バッジ（8音の平均誤差による判定）

**実装箇所**: `result-session-controller.js` の `displayAccuracyBadge()` 関数

**新基準（v2.0.0）**:
- 🏆 **素晴らしい精度！**: 平均誤差 ±20¢以内
- ⭐ **良好な精度！**: 平均誤差 ±35¢以内
- 👍 **合格ライン達成！**: 平均誤差 ±50¢以内
- ⚠️ **練習を続けましょう！**: 平均誤差 >±50¢

**旧基準（v1.1.0）** - 参考:
- 🏆 素晴らしい精度: 平均誤差 ±15¢以内
- ⭐ 良好な精度: 平均誤差 ±25¢以内
- 👍 合格ライン: 平均誤差 ±40¢以内
- ⚠️ 練習が必要: 平均誤差 >±40¢

### 計算例

**セッション例**: 8音の誤差データ
```
ド: +5¢, レ: -18¢, ミ: +12¢, ファ: -8¢
ソ: +22¢, ラ: -15¢, シ: +10¢, ド: -6¢
```

**平均誤差計算**:
```
平均誤差 = (5 + 18 + 12 + 8 + 22 + 15 + 10 + 6) / 8 = 12.0¢
```

**判定結果**:
- 平均誤差 12.0¢ ≤ 20¢ → 🏆 **素晴らしい精度！**

---

## 📊 結果表示UI

### 1. 即座表示（各音階完了時）

```
♪ ミ を歌いました
━━━━━━━━━━━━━━━
精度: ⭐ 良好
誤差: -18セント
スコア: 80点
```

### 2. セッション完了時の詳細表示

#### 総合結果カード
```
┌─────────────────────────┐
│    🏆 セッション完了！     │
├─────────────────────────┤
│  平均誤差: 12.0¢        │
│  バッジ: 素晴らしい精度！ │
│  Excellent: 5音        │
│  Good: 2音             │
│  Pass: 1音             │
│  時間: 3:45            │
└─────────────────────────┘
```

#### 評価分布表示

**プログレスバー形式**:
```
🏆 Excellent [■■■■■□□□] 5音
⭐ Good      [■■□□□□□□] 2音
👍 Pass      [■□□□□□□□] 1音
⚠️ Practice  [□□□□□□□□] 0音
```

#### 詳細グラフ（アニメーション付き）

**棒グラフ表示**
```
100 ┤ ■
 80 ┤ ■ ■     ■   ■
 60 ┤ ■ ■ ■   ■ ■ ■ ■
 40 ┤ ■ ■ ■   ■ ■ ■ ■
 20 ┤ ■ ■ ■ ■ ■ ■ ■ ■
  0 └─────────────────
    ド レ ミ ファ ソ ラ シ ド
```

### 3. 誤差分布の可視化

**セント誤差の分布図**
```
+50 ┤
+35 ┤      ●
+20 ┤   ●     ●
  0 ┤ ●   ●     ●   ●
-20 ┤     ●
-35 ┤
-50 ┤
    └─────────────────
     ド レ ミ ファ ソ ラ シ ド
```

---

## 🎮 アニメーション仕様

### 評価表示アニメーション

1. **スコア表示**
   - 0から目標値までカウントアップ（1秒）
   - イージング: ease-out

2. **グラフ描画**
   - 左から右へ順次表示（0.5秒/本）
   - 各棒グラフがバウンスしながら出現

3. **バッジ表示**
   - スケール0→1でフェードイン
   - 評価に応じたパーティクルエフェクト

4. **改善提案**
   - スライドインで表示
   - 重要ポイントは点滅

---

## 💡 フィードバックメッセージ

### 音階別メッセージ

**優秀な場合（±20¢以内）**
- 「完璧です！」
- 「素晴らしい音程！」
- 「プロ級の精度！」

**良好な場合（±35¢以内）**
- 「いい感じ！」
- 「安定しています」
- 「その調子！」

**合格の場合（±50¢以内）**
- 「良くなっています！」
- 「あともう少し！」
- 「基礎が身についてきました」

**要練習の場合（>±50¢）**
- 「もう少し高く」（フラット時）
- 「もう少し低く」（シャープ時）
- 「リラックスして」

### セッション総合メッセージ

**高得点時（平均誤差 ±20¢以内）**
```
🌟 素晴らしいパフォーマンス！
デバイス誤差を超える真の精度です。
この調子で練習を続けましょう。
```

**良好時（平均誤差 ±35¢以内）**
```
👏 実用レベルの音感を持っています！
合唱や弾き語りに十分な精度です。
さらに練習すると上級者レベルに到達できます。
```

**合格時（平均誤差 ±50¢以内）**
```
✅ 基本的な音感が身についています！
カラオケや趣味演奏を楽しめるレベルです。
継続的な練習で精度が向上していきます。
```

**要練習時（平均誤差 >±50¢）**
```
💪 練習あるのみ！
まずは「ド」「ミ」「ソ」の
基本3音から始めてみましょう。
一歩ずつ確実に！
```

---

## 📱 レスポンシブ対応

### デスクトップ表示
- グラフとテキスト情報を横並び
- 詳細な数値表示
- 大きなビジュアライゼーション

### タブレット表示（iPad縦向き）
- グラフを上部に配置
- テキスト情報を下部に整理
- タッチ操作に最適化

### モバイル表示
- コンパクトな表示
- 重要情報のみ初期表示
- 「詳細を見る」で展開

---

## 🔄 データ活用

### 練習履歴の活用
- 過去のセッションとの比較
- 成長曲線の表示
- 苦手音程の特定と集中練習提案

### 統計情報
- 平均精度の推移
- 最高記録の更新通知
- 連続練習日数の記録

---

## 🎯 改善提案システム

### 自動分析による提案

**苦手音程の特定**
```
📊 分析結果：
「ファ」の精度が低い傾向があります（平均誤差 48¢）。
→ ファの音を重点的に練習しましょう
```

**パターン認識**
```
💡 気づき：
高い音程で誤差が大きくなる傾向があります。
→ 呼吸を深くして、リラックスして歌いましょう
```

---

## 🎨 Lucideアイコン仕様

### アイコン利用方針
評価システムの視覚的フィードバックにLucideアイコンを統一的に使用します。

### 評価レベル別アイコン定義（v2.0.0）

| 評価レベル | Lucideアイコン名 | 用途 | サイズ | カラー |
|-----------|----------------|------|------|--------|
| **Excellent** | `trophy` | 個別音階評価・セッションバッジ | 20px〜28px | ゴールド (#FFD700) |
| **Good** | `star` | 個別音階評価・セッションバッジ | 20px〜28px | グリーン (#51cf66) |
| **Pass** | `thumbs-up` | 個別音階評価・セッションバッジ | 20px〜28px | ブルー (#4c6ef5) |
| **Practice** | `alert-triangle` | 個別音階評価・セッションバッジ | 20px〜28px | レッド (#dc2626) |

### その他のUIアイコン

| 機能 | Lucideアイコン名 | 用途 | サイズクラス |
|------|----------------|------|------------|
| **音声入力** | `mic` | マイクテスト・録音中 | `icon-lg` |
| **音量** | `volume-2` | 音量インジケーター | `icon-md` |
| **統計** | `bar-chart-3` | グラフ表示 | `icon-md` |
| **トレンド** | `trending-up` | 成長曲線 | `icon-md` |
| **音楽** | `music` | 音階表示 | `icon-sm` |
| **再生** | `play` | 基音再生 | `icon-md` |
| **停止** | `stop` | 録音停止 | `icon-md` |
| **ホーム** | `home` | ナビゲーション | `icon-md` |
| **設定** | `settings` | 設定画面 | `icon-md` |

### アイコン実装コード例

```html
<!-- セッション総合バッジ表示 -->
<div class="accuracy-badge accuracy-badge-excellent">
    <i data-lucide="trophy" class="text-yellow-300 accuracy-icon"></i>
</div>

<!-- 個別音符評価表示 -->
<i data-lucide="star" class="text-green-300" style="width: 28px; height: 28px;"></i>
```

---

## 🔧 実装ファイル

### 主要実装箇所

1. **`result-session-controller.js`**
   - **個別音符評価**: Lines 177-183, 296-309
   - **セッション総合バッジ**: Lines 237-274 (`displayAccuracyBadge()`)
   - **評価分布表示**: Lines 169-232 (`displayEvaluationDistribution()`)

2. **実装時の変更ポイント**:
```javascript
// 個別音符評価（Line 179-182）
if (absError <= 20) distribution.excellent++;      // 旧: ≤15
else if (absError <= 35) distribution.good++;       // 旧: ≤25
else if (absError <= 50) distribution.pass++;       // 旧: ≤40
else distribution.practice++;

// セッション総合バッジ（Line 246-262）
if (avgError <= 20) {                               // 旧: ≤15
    badge.classList.add('accuracy-badge-excellent');
    // ...
} else if (avgError <= 35) {                        // 旧: ≤25
    badge.classList.add('accuracy-badge-good');
    // ...
} else if (avgError <= 50) {                        // 旧: ≤40
    badge.classList.add('accuracy-badge-pass');
    // ...
}
```

---

## 📚 参考文献・データソース

1. **Hutchins & Peretz (2012)**: "A frog in your throat or in your ear? Searching for the causes of poor singing" - 音程許容範囲±44¢
2. **Voice Science研究**: プロ歌手の実測平均誤差20〜30¢
3. **音楽知覚研究**: Just-Noticeable Difference (JND) 5〜10¢
4. **Web Audio API仕様**: 測定誤差±3〜5¢
5. **スマートフォンマイク性能**: 一般的な測定誤差±5〜10¢

---

## 🔄 総合評価との関係

### 評価システムの階層構造

```
┌─────────────────────────────────────┐
│  セッション評価（本仕様書）           │
│  - 1セッション（8音）の評価          │
│  - 個別音符: ±20¢/±35¢/±50¢        │
│  - セッションバッジ: 平均誤差で判定   │
└─────────────────────────────────────┘
           ↓ 8/12/24セッション完了後
┌─────────────────────────────────────┐
│  総合評価（別仕様書）                │
│  - S/A/B/C/D/E級の判定              │
│  - デバイス品質補正適用              │
│  - モード別基準（8/12/24セッション）  │
│  - 詳細: DYNAMIC_GRADE_LOGIC_SPECIFICATION.md │
└─────────────────────────────────────┘
```

---

## ✅ v2.0.0更新のまとめ

### 主要変更点
1. ✅ **評価基準の科学的再設計**: デバイス誤差を考慮した現実的な基準
2. ✅ **個別音符評価**: ±15¢→±20¢、±25¢→±35¢、±40¢→±50¢
3. ✅ **セッション総合バッジ**: 同じ閾値に統一
4. ✅ **学術的根拠の明記**: 音楽教育研究・プロ歌手データ
5. ✅ **デバイス環境の考慮**: Web Audio API・スマートフォンマイクの誤差明示

### 期待される効果
- 🎯 達成可能な目標設定でモチベーション向上
- 🎯 デバイス環境に左右されない公平な評価
- 🎯 学術的根拠に基づく信頼性の高い判定
- 🎯 初心者から上級者まで段階的な成長促進

---

## 📐 v2.1.0: 評価ロジックの統合アーキテクチャ

### 統合の目的

v2.1.0では、評価基準のロジックが複数箇所に重複していた問題を解決し、`EvaluationCalculator`クラスに統合しました。

### 統合前の問題点

**評価基準の重複（v2.0.0以前）**:
1. `result-session-controller.js` - セッション評価ページ
2. `results-overview.html` - 総合評価の詳細分析
3. `evaluation-calculator.js` - 総合グレード計算

各ファイルで独立して評価基準を実装していたため：
- ❌ 評価基準変更時に3箇所修正が必要
- ❌ 基準の不一致リスク（旧基準が残る可能性）
- ❌ 保守性・可読性の低下

### 統合後のアーキテクチャ（v2.1.0）

**`EvaluationCalculator`クラスに統合**:

```javascript
/**
 * 個別音程評価（v2.0.0: 科学的バランス型評価基準）
 * @param {number} absError - 絶対誤差（セント）
 * @returns {Object} { level, icon, color, cssClass, message }
 */
static evaluatePitchError(absError) {
  if (absError <= 20) return { level: 'excellent', icon: 'trophy', ... };
  else if (absError <= 35) return { level: 'good', icon: 'star', ... };
  else if (absError <= 50) return { level: 'pass', icon: 'thumbs-up', ... };
  else return { level: 'practice', icon: 'alert-triangle', ... };
}

/**
 * 平均誤差評価（セッションバッジ用）
 */
static evaluateAverageError(avgError) {
  return this.evaluatePitchError(avgError);
}

/**
 * 評価分布の計算
 */
static calculateDistribution(pitchErrors) {
  const distribution = { excellent: 0, good: 0, pass: 0, practice: 0 };
  pitchErrors.forEach(error => {
    const evaluation = this.evaluatePitchError(Math.abs(error.errorInCents));
    distribution[evaluation.level]++;
  });
  return distribution;
}
```

### 統合による改善

**保守性の向上**:
- ✅ 評価基準変更は`evaluation-calculator.js`の1箇所のみ
- ✅ 全ての評価表示に自動反映
- ✅ 基準の不一致リスクを完全排除

**コードの簡潔化**:
```javascript
// 【修正前】各ファイルで重複実装（20行以上）
if (absError <= 20) { evalIcon = 'trophy'; evalColor = 'text-yellow-300'; }
else if (absError <= 35) { evalIcon = 'star'; evalColor = 'text-green-300'; }
// ... 重複コード

// 【修正後】統合関数を呼び出すだけ（1行）
const evaluation = EvaluationCalculator.evaluatePitchError(absError);
```

**一貫性の保証**:
- ✅ セッション評価ページ
- ✅ 総合評価の詳細分析
- ✅ 評価分布グラフ

全てが同一の`evaluatePitchError()`関数を使用するため、完全に同一基準で評価されることを保証。

### 実装箇所

**統合関数の定義**:
- `/js/evaluation-calculator.js` (Lines 358-428)

**統合関数の使用箇所**:
- `/pages/js/result-session-controller.js`
  - `displayEvaluationDistribution()` - Line 187
  - `displayAccuracyBadge()` - Line 247
  - `displayDetailedAnalysis()` - Line 286

- `/pages/results-overview.html`
  - `showSessionDetail()` - Lines 815, 841（精度バッジ・音別詳細）

### 今後の拡張性

評価基準の変更（例：さらなる科学的知見の反映）が必要になった場合：

1. `evaluation-calculator.js`の`evaluatePitchError()`のみ修正
2. 全ての評価表示に自動反映
3. テストの簡素化（単一関数のテストのみ）

---

**このv2.1.0評価システムにより、科学的根拠に基づいた公平で現実的な音程精度評価が、保守性・一貫性を備えた形で実現されます。**

---

## 🔍 v2.3.0: 外れ値処理の検討事項（2025-10-30追加）

### 背景

**v2.2.0での外れ値除外ロジック復活**:
- 測定精度向上により異常値は減少したが、完全には消滅していない
- 固定閾値180¢（約1.8半音）で外れ値を判定し、平均誤差計算・評価分布から除外
- 外れ値は詳細分析に`alert-circle`アイコンで表示

### 根本的な問題

**180¢超の音には2つの異なるケースが混在**:

#### ケース1: 測定エラー（除外すべき）
- マイクの音拾いミス、環境ノイズ、誤検出
- 1000¢のような極端な値
- **特徴**: ランダムに発生、再現性なし

#### ケース2: 実力としての苦手音程（除外すべきでない）
- 本当に苦手な音程での大きなズレ
- 高音域・低音域での継続的な課題
- **特徴**: 特定の音で繰り返し発生、再現性あり

### 現在の課題

**一律180¢カットの問題点**:
- ユーザーが実際に200¢ずれている場合でも「外れ値」として除外
- 本当の弱点が評価から消え、改善の機会を失う
- 詳細分析レポートで苦手音程の特定が困難

### 検討すべき解決策

#### オプション1: 外れ値分類ロジックの実装

**提案内容**:
```javascript
/**
 * 外れ値を「測定エラー」と「苦手音程」に分類
 *
 * 判定基準:
 * 1. 極端な値（500¢超）→ 測定エラー
 * 2. セッション内で同じ音程が複数回180¢超 → 苦手音程
 * 3. 1回だけの180¢超 → 測定エラー
 */
function classifyOutliers(pitchErrors, outlierThreshold = 180) {
  const extremeThreshold = 500;
  const measurementErrors = [];  // 測定エラー
  const weakNotes = [];           // 苦手音程
  const validErrors = [];         // 正常範囲

  // 目標音程ごとにグループ化
  const groupedByTarget = {};
  pitchErrors.forEach(error => {
    const target = error.targetNote;
    if (!groupedByTarget[target]) groupedByTarget[target] = [];
    groupedByTarget[target].push(error);
  });

  // 各音程ごとに判定
  pitchErrors.forEach(error => {
    const absError = Math.abs(error.errorInCents);

    if (absError <= outlierThreshold) {
      validErrors.push(error);
    } else if (absError > extremeThreshold) {
      measurementErrors.push(error);  // 極端な値
    } else {
      // 180¢～500¢の範囲 → 再現性で判定
      const sameTargetErrors = groupedByTarget[error.targetNote];
      const outlierCount = sameTargetErrors.filter(e =>
        Math.abs(e.errorInCents) > outlierThreshold
      ).length;

      if (outlierCount >= 2 || sameTargetErrors.length === 1) {
        weakNotes.push(error);  // 苦手音程
      } else {
        measurementErrors.push(error);  // 1回だけの外れ値
      }
    }
  });

  return { measurementErrors, weakNotes, validErrors };
}
```

**評価への反映（検討中）**:
- **測定エラー**: 完全に除外（平均誤差・評価分布から除外）
- **苦手音程**:
  - オプションA: 平均誤差には含めるが、特別にマーク
  - オプションB: 除外するが、別途「要注意音程」として表示
  - オプションC: Practiceカテゴリとして評価分布に含める

**UI表示案**:
```
評価から除外された音: 2音

📊 測定エラー: 1音
  • D5 (誤差: 1200¢) - マイクの誤検出の可能性

⚠️ 苦手な音程: 1音
  • G5 (誤差: 220¢) - この音程は継続的な練習が推奨されます
```

#### オプション2: 閾値の引き上げ

**提案内容**:
```javascript
const outlierThreshold = 300; // または400¢
```

**メリット**:
- 180¢～300¢のズレは「実力」として評価に含める
- 実装がシンプル

**デメリット**:
- 測定エラーも含まれる可能性

#### オプション3: 詳細分析レポートでの包括的対応

**提案内容**:
- セッション評価では現状維持（180¢で一律除外）
- 詳細分析レポート（未実装）で以下を実装：
  - 外れ値の分類ロジック
  - 苦手音程の特定と可視化
  - 音程ごとの誤差傾向分析
  - 練習推奨度の表示

**メリット**:
- セッション評価はシンプルに保つ
- 詳細分析で深い洞察を提供
- 段階的な実装が可能

**デメリット**:
- 詳細分析レポートの実装が前提

### 実装優先度

**推奨アプローチ**: オプション3（詳細分析レポートでの包括的対応）

**理由**:
1. セッション評価の複雑化を避ける
2. 詳細分析レポートで包括的な分析を提供
3. ユーザー体験の段階的な向上
4. 実装の優先順位付けが容易

### 次期実装フェーズ

**詳細分析レポートページ実装時に決定すべき事項**:
1. 外れ値分類ロジックの採用可否
2. 苦手音程の定義と判定基準
3. UI表示方法（グラフ・テキスト・推奨練習メニュー）
4. 評価への反映方法（除外 vs 別表示 vs 含める）
5. 長期的なデータ蓄積による精度向上の可能性

---

**この検討事項は、詳細分析レポート実装時に最終決定されます。**
