# 相対音感トレーニングアプリ - 評価システム仕様書

**バージョン**: 2.5.0
**作成日**: 2025-08-07
**更新日**: 2025-11-27
**用途**: セッション単位（8音）の音程精度評価・採点システムの詳細仕様

**v2.5.0 重要更新内容** (2025-11-27):
- **評価計算ロジックの一元管理**: `EvaluationCalculator`クラスに統合
- **OUTLIER_THRESHOLD定数化**: 800¢閾値を定数として一元管理
- **extractSessionMetrics()追加**: 単一セッション用のメトリクス抽出メソッド
- **保守性向上**: 閾値変更時は`evaluation-calculator.js`の1箇所修正で全体反映
- **コード重複削除**: result-session-controller, results-overview-controllerの重複ロジック統合

**v2.4.0 重要更新内容** (2025-11-20):
- **外れ値戦略の根本的再設計**: 自動除外廃止 → 警告表示 + ユーザー判断へ移行
- **800¢閾値での警告表示**: 測定エラーの可能性を通知、レッスン削除を推奨
- **評価分布の完全包含**: 800¢超のデータもPractice評価としてカウント
- **UI色の統一**: 800¢超をamber色で表示（Practice評価の赤と区別）
- **設計思想の転換**: システムが判断→ユーザーが判断（レッスン削除機能で対処）
- **詳細**: すべてのデータを評価に反映し、透明性と信頼性を向上

**v2.2.0 重要更新内容** (2025-10-29):
- **測定精度の根本的改善**: 前の音の残響除外ロジック実装により異常値完全消滅
- **外れ値除外ロジック削除**: 測定精度向上により不要となった外れ値除外処理を削除
- **評価の信頼性向上**: 実際のユーザーパフォーマンスを正確に反映
- **詳細**: 測定開始から200ms除外し、残り500msの安定期間から最高明瞭度データを選択

**v2.1.0 重要更新内容** (2025-10-29):
- **評価ロジックの統合**: `EvaluationCalculator`に共通評価関数を追加
- **コード重複削除**: セッション評価・総合評価の評価基準を一元管理
- **保守性向上**: 評価基準変更時は`evaluation-calculator.js`の1箇所修正で全体反映
- **一貫性保証**: 全ての評価表示で同一基準を使用

**v2.0.0 重要更新内容**:
- **評価基準の科学的再設計**: デバイス測定誤差（±10〜15¢）を考慮した現実的な基準へ改定
- **新基準**: Excellent ±20¢、Good ±35¢、Pass ±50¢（旧基準より+5〜+10¢緩和）
- **学術的根拠の追加**: 音楽教育研究・プロ歌手の実測データに基づく閾値設定
- **デバイス環境の考慮**: Web Audio API・スマートフォンマイクの測定誤差を明示
- **セッション総合バッジ基準の統一**: 個別音符評価と同じ閾値に変更

**v1.1.0 更新内容** (参考):
- ハイブリッド評価方式の採用（平均スコアと精度割合の組み合わせ）
- 安定性係数による評価の追加
- Lucideアイコン仕様の追加
- S-E級判定基準の厳密化

---

## 🎯 評価システム概要

### 基本原理
相対音感トレーニングにおける評価は、**基音に対する相対的な音程の正確さ**を測定します。
各音階（ドレミファソラシド）における周波数の誤差をセント単位で計測し、その精度に基づいて評価を行います。

### 評価の重要性
- **即時フィードバック**: リアルタイムで自分の音程精度を把握
- **成長の可視化**: 練習による上達を数値とグラフで確認
- **モチベーション維持**: 段階的な評価で達成感を提供
- **弱点の特定**: 苦手な音程を明確化し効率的な練習を促進

### 評価の2つのレイヤー

本システムは**2段階の評価システム**で構成されています：

1. **セッション評価（本仕様書）**: 1セッション（8音）の個別評価
   - 個別音符評価（Excellent/Good/Pass/Practice）
   - セッション総合バッジ（8音の平均誤差による判定）

2. **総合評価（別仕様書）**: 8/12/24セッション完了時の総合判定
   - S/A/B/C/D/E級の総合グレード判定
   - デバイス品質補正・モード別基準適用
   - 詳細は `DYNAMIC_GRADE_LOGIC_SPECIFICATION.md` を参照

---

## 🔬 評価基準の科学的根拠（v2.0.0新規追加）

### デバイス測定誤差の実態

**Web Audio API・スマートフォンマイクの測定誤差**:
- **スマートフォン内蔵マイク**: ±5〜10¢の測定誤差
- **Web Audio API処理誤差**: ±3〜5¢
- **環境ノイズ影響**: ±2〜8¢
- **合計想定誤差**: **±10〜15¢**

### 学術的基準

**音楽教育研究・音声科学の知見**:
- **Just-Noticeable Difference (JND)**: 約5〜10¢（音程差の最小知覚閾値）
- **許容範囲**: ±44¢（Hutchins & Peretz, 2012）
- **良好な音感**: ±20¢以内（音楽教育研究）
- **プロレベル**: ±10¢以内
- **プロ歌手の実測平均**: 20〜30¢（レガート唱法: 22.9¢、スタッカート: 27.1¢）
- **アマチュア歌手の実測平均**: 30〜60¢

### v2.0.0基準の設計方針

**科学的バランス型**:
1. **測定誤差を加味**: デバイス誤差±15¢を考慮した現実的な達成可能ライン
2. **学術基準準拠**: 音楽教育研究・プロ歌手の実測データに基づく閾値
3. **段階的難易度**: 初心者→中級者→上級者の成長を促進

**旧基準（v1.1.0）の問題点**:
- ±15¢基準が厳しすぎる（デバイス誤差±15¢と同等）
- 初心者〜中級者には達成困難
- モチベーション低下のリスク

---

## 📊 評価基準（v2.0.0 - 科学的バランス型）

### 4段階評価システム

#### 🏆 優秀（Excellent）
- **判定基準**: ±20セント以内
- **説明**: 非常に正確な音程。デバイス誤差を超えた真の精度
- **科学的根拠**: デバイス誤差（±15¢）を考慮した「真に正確」なライン、プロ歌手の平均値に近い
- **スコア**: 100点
- **Lucideアイコン**: `trophy` (トロフィーアイコン)
- **表示色**: ゴールド (#FFD700)
- **アニメーション**: キラキラエフェクト

#### ⭐ 良好（Good）
- **判定基準**: ±35セント以内
- **説明**: 良好な精度。実用レベルの音感
- **科学的根拠**: 学術的「良好」基準（±20¢）+ 測定誤差マージン15¢
- **スコア**: 80点
- **Lucideアイコン**: `star` (星アイコン)
- **表示色**: グリーン (#51cf66)
- **アニメーション**: パルスエフェクト

#### 👍 合格（Pass）
- **判定基準**: ±50セント以内
- **説明**: 合格レベル。基本的な音感は身についている
- **科学的根拠**: 学術的許容範囲（±44¢）+ 安全マージン6¢
- **スコア**: 60点
- **Lucideアイコン**: `thumbs-up` (グッドアイコン)
- **表示色**: ブルー (#4c6ef5)
- **アニメーション**: 軽いバウンス

#### ⚠️ 要練習（Need Practice）
- **判定基準**: ±51セント以上
- **説明**: 練習が必要。基礎から丁寧に
- **科学的根拠**: 一般リスナーが「音程がおかしい」と気づく閾値（±50¢）を超える
- **スコア**: 30点
- **Lucideアイコン**: `alert-triangle` (警告アイコン)
- **表示色**: レッド (#dc2626)
- **アニメーション**: 振動エフェクト（励まし）

---

## 📊 旧基準（v1.1.0）との比較表

| 評価レベル | 旧基準（v1.1.0） | 新基準（v2.0.0） | 差分 | 改善効果 |
|-----------|-----------------|-----------------|------|----------|
| Excellent | ±15¢ | ±20¢ | +5¢ | デバイス誤差を考慮、達成率向上 |
| Good | ±25¢ | ±35¢ | +10¢ | 学術的良好基準+マージン |
| Pass | ±40¢ | ±50¢ | +10¢ | 学術的許容範囲+余裕 |
| Practice | >±40¢ | >±50¢ | +10¢ | 改善推奨ライン |

**期待される達成率の変化**:
- **旧基準**: Excellent達成率 約20%（厳しすぎ）
- **新基準**: Excellent達成率 約40%（適度な挑戦）

---

## 🎵 個別音階評価

### 評価プロセス

1. **音程検出**
   ```
   検出周波数 → 目標周波数との比較 → セント誤差計算
   ```

2. **セント誤差の計算式**
   ```
   誤差(セント) = 1200 × log2(検出周波数 / 目標周波数)
   ```

3. **個別採点**
   - 各音階（8音）それぞれに対して評価
   - リアルタイム視覚フィードバック提供
   - 新基準（±20¢/±35¢/±50¢）で判定

### 視覚的フィードバック

#### リアルタイム表示
```
ド: 🏆 +5¢  (優秀 - Excellent)
レ: ⭐ -20¢ (良好 - Good)
ミ: 👍 +35¢ (合格 - Pass)
ファ: ⚠️ +55¢ (要練習 - Practice)
```

#### 精度メーター
```
[========|=======] +5セント
    中心が正確な音程
```

---

## 📈 セッション総合評価（v2.0.0更新）

### セッション総合バッジ（8音の平均誤差による判定）

**実装箇所**: `result-session-controller.js` の `displayAccuracyBadge()` 関数

**新基準（v2.0.0）**:
- 🏆 **素晴らしい精度！**: 平均誤差 ±20¢以内
- ⭐ **良好な精度！**: 平均誤差 ±35¢以内
- 👍 **合格ライン達成！**: 平均誤差 ±50¢以内
- ⚠️ **練習を続けましょう！**: 平均誤差 >±50¢

**旧基準（v1.1.0）** - 参考:
- 🏆 素晴らしい精度: 平均誤差 ±15¢以内
- ⭐ 良好な精度: 平均誤差 ±25¢以内
- 👍 合格ライン: 平均誤差 ±40¢以内
- ⚠️ 練習が必要: 平均誤差 >±40¢

### 計算例

**セッション例**: 8音の誤差データ
```
ド: +5¢, レ: -18¢, ミ: +12¢, ファ: -8¢
ソ: +22¢, ラ: -15¢, シ: +10¢, ド: -6¢
```

**平均誤差計算**:
```
平均誤差 = (5 + 18 + 12 + 8 + 22 + 15 + 10 + 6) / 8 = 12.0¢
```

**判定結果**:
- 平均誤差 12.0¢ ≤ 20¢ → 🏆 **素晴らしい精度！**

---

## 📊 結果表示UI

### 1. 即座表示（各音階完了時）

```
♪ ミ を歌いました
━━━━━━━━━━━━━━━
精度: ⭐ 良好
誤差: -18セント
スコア: 80点
```

### 2. セッション完了時の詳細表示

#### 総合結果カード
```
┌─────────────────────────┐
│    🏆 セッション完了！     │
├─────────────────────────┤
│  平均誤差: 12.0¢        │
│  バッジ: 素晴らしい精度！ │
│  Excellent: 5音        │
│  Good: 2音             │
│  Pass: 1音             │
│  時間: 3:45            │
└─────────────────────────┘
```

#### 評価分布表示

**プログレスバー形式**:
```
🏆 Excellent [■■■■■□□□] 5音
⭐ Good      [■■□□□□□□] 2音
👍 Pass      [■□□□□□□□] 1音
⚠️ Practice  [□□□□□□□□] 0音
```

#### 詳細グラフ（アニメーション付き）

**棒グラフ表示**
```
100 ┤ ■
 80 ┤ ■ ■     ■   ■
 60 ┤ ■ ■ ■   ■ ■ ■ ■
 40 ┤ ■ ■ ■   ■ ■ ■ ■
 20 ┤ ■ ■ ■ ■ ■ ■ ■ ■
  0 └─────────────────
    ド レ ミ ファ ソ ラ シ ド
```

### 3. 誤差分布の可視化

**セント誤差の分布図**
```
+50 ┤
+35 ┤      ●
+20 ┤   ●     ●
  0 ┤ ●   ●     ●   ●
-20 ┤     ●
-35 ┤
-50 ┤
    └─────────────────
     ド レ ミ ファ ソ ラ シ ド
```

---

## 🎮 アニメーション仕様

### 評価表示アニメーション

1. **スコア表示**
   - 0から目標値までカウントアップ（1秒）
   - イージング: ease-out

2. **グラフ描画**
   - 左から右へ順次表示（0.5秒/本）
   - 各棒グラフがバウンスしながら出現

3. **バッジ表示**
   - スケール0→1でフェードイン
   - 評価に応じたパーティクルエフェクト

4. **改善提案**
   - スライドインで表示
   - 重要ポイントは点滅

---

## 💡 フィードバックメッセージ

### 音階別メッセージ

**優秀な場合（±20¢以内）**
- 「完璧です！」
- 「素晴らしい音程！」
- 「プロ級の精度！」

**良好な場合（±35¢以内）**
- 「いい感じ！」
- 「安定しています」
- 「その調子！」

**合格の場合（±50¢以内）**
- 「良くなっています！」
- 「あともう少し！」
- 「基礎が身についてきました」

**要練習の場合（>±50¢）**
- 「もう少し高く」（フラット時）
- 「もう少し低く」（シャープ時）
- 「リラックスして」

### セッション総合メッセージ

**高得点時（平均誤差 ±20¢以内）**
```
🌟 素晴らしいパフォーマンス！
デバイス誤差を超える真の精度です。
この調子で練習を続けましょう。
```

**良好時（平均誤差 ±35¢以内）**
```
👏 実用レベルの音感を持っています！
合唱や弾き語りに十分な精度です。
さらに練習すると上級者レベルに到達できます。
```

**合格時（平均誤差 ±50¢以内）**
```
✅ 基本的な音感が身についています！
カラオケや趣味演奏を楽しめるレベルです。
継続的な練習で精度が向上していきます。
```

**要練習時（平均誤差 >±50¢）**
```
💪 練習あるのみ！
まずは「ド」「ミ」「ソ」の
基本3音から始めてみましょう。
一歩ずつ確実に！
```

---

## 📱 レスポンシブ対応

### デスクトップ表示
- グラフとテキスト情報を横並び
- 詳細な数値表示
- 大きなビジュアライゼーション

### タブレット表示（iPad縦向き）
- グラフを上部に配置
- テキスト情報を下部に整理
- タッチ操作に最適化

### モバイル表示
- コンパクトな表示
- 重要情報のみ初期表示
- 「詳細を見る」で展開

---

## 🔄 データ活用

### 練習履歴の活用
- 過去のセッションとの比較
- 成長曲線の表示
- 苦手音程の特定と集中練習提案

### 統計情報
- 平均精度の推移
- 最高記録の更新通知
- 連続練習日数の記録

---

## 🎯 改善提案システム

### 自動分析による提案

**苦手音程の特定**
```
📊 分析結果：
「ファ」の精度が低い傾向があります（平均誤差 48¢）。
→ ファの音を重点的に練習しましょう
```

**パターン認識**
```
💡 気づき：
高い音程で誤差が大きくなる傾向があります。
→ 呼吸を深くして、リラックスして歌いましょう
```

---

## 🎨 Lucideアイコン仕様

### アイコン利用方針
評価システムの視覚的フィードバックにLucideアイコンを統一的に使用します。

### 評価レベル別アイコン定義（v2.0.0）

| 評価レベル | Lucideアイコン名 | 用途 | サイズ | カラー |
|-----------|----------------|------|------|--------|
| **Excellent** | `trophy` | 個別音階評価・セッションバッジ | 20px〜28px | ゴールド (#FFD700) |
| **Good** | `star` | 個別音階評価・セッションバッジ | 20px〜28px | グリーン (#51cf66) |
| **Pass** | `thumbs-up` | 個別音階評価・セッションバッジ | 20px〜28px | ブルー (#4c6ef5) |
| **Practice** | `alert-triangle` | 個別音階評価・セッションバッジ | 20px〜28px | レッド (#dc2626) |

### その他のUIアイコン

| 機能 | Lucideアイコン名 | 用途 | サイズクラス |
|------|----------------|------|------------|
| **音声入力** | `mic` | マイクテスト・録音中 | `icon-lg` |
| **音量** | `volume-2` | 音量インジケーター | `icon-md` |
| **統計** | `bar-chart-3` | グラフ表示 | `icon-md` |
| **トレンド** | `trending-up` | 成長曲線 | `icon-md` |
| **音楽** | `music` | 音階表示 | `icon-sm` |
| **再生** | `play` | 基音再生 | `icon-md` |
| **停止** | `stop` | 録音停止 | `icon-md` |
| **ホーム** | `home` | ナビゲーション | `icon-md` |
| **設定** | `settings` | 設定画面 | `icon-md` |

### アイコン実装コード例

```html
<!-- セッション総合バッジ表示 -->
<div class="accuracy-badge accuracy-badge-excellent">
    <i data-lucide="trophy" class="text-yellow-300 accuracy-icon"></i>
</div>

<!-- 個別音符評価表示 -->
<i data-lucide="star" class="text-green-300" style="width: 28px; height: 28px;"></i>
```

---

## 🔧 実装ファイル

### 主要実装箇所

1. **`result-session-controller.js`**
   - **個別音符評価**: Lines 177-183, 296-309
   - **セッション総合バッジ**: Lines 237-274 (`displayAccuracyBadge()`)
   - **評価分布表示**: Lines 169-232 (`displayEvaluationDistribution()`)

2. **実装時の変更ポイント**:
```javascript
// 個別音符評価（Line 179-182）
if (absError <= 20) distribution.excellent++;      // 旧: ≤15
else if (absError <= 35) distribution.good++;       // 旧: ≤25
else if (absError <= 50) distribution.pass++;       // 旧: ≤40
else distribution.practice++;

// セッション総合バッジ（Line 246-262）
if (avgError <= 20) {                               // 旧: ≤15
    badge.classList.add('accuracy-badge-excellent');
    // ...
} else if (avgError <= 35) {                        // 旧: ≤25
    badge.classList.add('accuracy-badge-good');
    // ...
} else if (avgError <= 50) {                        // 旧: ≤40
    badge.classList.add('accuracy-badge-pass');
    // ...
}
```

---

## 📚 参考文献・データソース

1. **Hutchins & Peretz (2012)**: "A frog in your throat or in your ear? Searching for the causes of poor singing" - 音程許容範囲±44¢
2. **Voice Science研究**: プロ歌手の実測平均誤差20〜30¢
3. **音楽知覚研究**: Just-Noticeable Difference (JND) 5〜10¢
4. **Web Audio API仕様**: 測定誤差±3〜5¢
5. **スマートフォンマイク性能**: 一般的な測定誤差±5〜10¢

---

## 🔄 総合評価との関係

### 評価システムの階層構造

```
┌─────────────────────────────────────┐
│  セッション評価（本仕様書）           │
│  - 1セッション（8音）の評価          │
│  - 個別音符: ±20¢/±35¢/±50¢        │
│  - セッションバッジ: 平均誤差で判定   │
└─────────────────────────────────────┘
           ↓ 8/12/24セッション完了後
┌─────────────────────────────────────┐
│  総合評価（別仕様書）                │
│  - S/A/B/C/D/E級の判定              │
│  - デバイス品質補正適用              │
│  - モード別基準（8/12/24セッション）  │
│  - 詳細: DYNAMIC_GRADE_LOGIC_SPECIFICATION.md │
└─────────────────────────────────────┘
```

---

## ✅ v2.0.0更新のまとめ

### 主要変更点
1. ✅ **評価基準の科学的再設計**: デバイス誤差を考慮した現実的な基準
2. ✅ **個別音符評価**: ±15¢→±20¢、±25¢→±35¢、±40¢→±50¢
3. ✅ **セッション総合バッジ**: 同じ閾値に統一
4. ✅ **学術的根拠の明記**: 音楽教育研究・プロ歌手データ
5. ✅ **デバイス環境の考慮**: Web Audio API・スマートフォンマイクの誤差明示

### 期待される効果
- 🎯 達成可能な目標設定でモチベーション向上
- 🎯 デバイス環境に左右されない公平な評価
- 🎯 学術的根拠に基づく信頼性の高い判定
- 🎯 初心者から上級者まで段階的な成長促進

---

## 📐 v2.1.0: 評価ロジックの統合アーキテクチャ

### 統合の目的

v2.1.0では、評価基準のロジックが複数箇所に重複していた問題を解決し、`EvaluationCalculator`クラスに統合しました。

### 統合前の問題点

**評価基準の重複（v2.0.0以前）**:
1. `result-session-controller.js` - セッション評価ページ
2. `results-overview.html` - 総合評価の詳細分析
3. `evaluation-calculator.js` - 総合グレード計算

各ファイルで独立して評価基準を実装していたため：
- ❌ 評価基準変更時に3箇所修正が必要
- ❌ 基準の不一致リスク（旧基準が残る可能性）
- ❌ 保守性・可読性の低下

### 統合後のアーキテクチャ（v2.1.0）

**`EvaluationCalculator`クラスに統合**:

```javascript
/**
 * 個別音程評価（v2.0.0: 科学的バランス型評価基準）
 * @param {number} absError - 絶対誤差（セント）
 * @returns {Object} { level, icon, color, cssClass, message }
 */
static evaluatePitchError(absError) {
  if (absError <= 20) return { level: 'excellent', icon: 'trophy', ... };
  else if (absError <= 35) return { level: 'good', icon: 'star', ... };
  else if (absError <= 50) return { level: 'pass', icon: 'thumbs-up', ... };
  else return { level: 'practice', icon: 'alert-triangle', ... };
}

/**
 * 平均誤差評価（セッションバッジ用）
 */
static evaluateAverageError(avgError) {
  return this.evaluatePitchError(avgError);
}

/**
 * 評価分布の計算
 */
static calculateDistribution(pitchErrors) {
  const distribution = { excellent: 0, good: 0, pass: 0, practice: 0 };
  pitchErrors.forEach(error => {
    const evaluation = this.evaluatePitchError(Math.abs(error.errorInCents));
    distribution[evaluation.level]++;
  });
  return distribution;
}
```

### 統合による改善

**保守性の向上**:
- ✅ 評価基準変更は`evaluation-calculator.js`の1箇所のみ
- ✅ 全ての評価表示に自動反映
- ✅ 基準の不一致リスクを完全排除

**コードの簡潔化**:
```javascript
// 【修正前】各ファイルで重複実装（20行以上）
if (absError <= 20) { evalIcon = 'trophy'; evalColor = 'text-yellow-300'; }
else if (absError <= 35) { evalIcon = 'star'; evalColor = 'text-green-300'; }
// ... 重複コード

// 【修正後】統合関数を呼び出すだけ（1行）
const evaluation = EvaluationCalculator.evaluatePitchError(absError);
```

**一貫性の保証**:
- ✅ セッション評価ページ
- ✅ 総合評価の詳細分析
- ✅ 評価分布グラフ

全てが同一の`evaluatePitchError()`関数を使用するため、完全に同一基準で評価されることを保証。

### 実装箇所

**統合関数の定義**:
- `/js/evaluation-calculator.js` (Lines 358-428)

**統合関数の使用箇所**:
- `/pages/js/result-session-controller.js`
  - `displayEvaluationDistribution()` - Line 187
  - `displayAccuracyBadge()` - Line 247
  - `displayDetailedAnalysis()` - Line 286

- `/pages/results-overview.html`
  - `showSessionDetail()` - Lines 815, 841（精度バッジ・音別詳細）

### 今後の拡張性

評価基準の変更（例：さらなる科学的知見の反映）が必要になった場合：

1. `evaluation-calculator.js`の`evaluatePitchError()`のみ修正
2. 全ての評価表示に自動反映
3. テストの簡素化（単一関数のテストのみ）

---

**このv2.1.0評価システムにより、科学的根拠に基づいた公平で現実的な音程精度評価が、保守性・一貫性を備えた形で実現されます。**

---

## 🔍 v2.4.0: 外れ値処理の実装完了（2025-11-20実装）

### 背景と経緯

**v2.3.0での検討事項**:
- 180¢閾値での自動除外は「測定エラー」と「実力としての弱点」を区別できない問題
- 3つのオプション（分類ロジック、閾値緩和、詳細分析での対応）を検討

**v2.4.0で採用したアプローチ**:
- **Option D: 外れ値自動除外の完全廃止**（新規提案）
- レッスン削除機能の実装により、ユーザー自身が判断可能となったため
- システムが判断するのではなく、ユーザーが全情報を見て判断する設計へ転換

### 実装内容

#### 1. 外れ値自動除外の廃止

**evaluation-calculator.js**:
```javascript
// 修正前: 150-180¢で自動除外
const deviceErrorMargin = deviceInfo ? this.getDeviceErrorMargin(deviceInfo.quality) : 10;
const outlierThreshold = 150 + deviceErrorMargin;  // 160-175¢
const validErrors = errors.filter(e => e <= outlierThreshold);

// 修正後: すべてのデータで計算
const avgError = totalError / totalNotes;
const outlierThreshold = 800;  // 警告用フラグのみ
const outlierFiltered = errors.filter(e => e > outlierThreshold).length > 0;
```

**DistributionChart.js**:
```javascript
// 修正前: 800¢超を評価分布から除外
if (absError > 800) {
    return;  // 除外
}

// 修正後: すべてのデータを評価分布に含める
distribution.total++;
const evaluation = window.EvaluationCalculator.evaluatePitchError(absError);
distribution[evaluation.level]++;  // 800¢超もPracticeとしてカウント
```

#### 2. 800¢閾値での警告表示

**note-result-item（個別の音）**:
- 800¢超: amber背景 + `alert-circle`アイコン（amber色）
- 50-800¢（Practice評価）: 背景なし + `alert-triangle`アイコン（薄いピンク）
- アイコンの形と色で明確に区別

**warning-alert（警告メッセージ）**:
```html
<div class="warning-alert">
    <i data-lucide="alert-circle" class="text-amber-500"></i>
    <div>
        <p><strong>大きな誤差について</strong></p>
        <p>大きな誤差が検出されました。正常に測定できなかった可能性があります。
           詳細分析で確認し、必要に応じてレッスン削除機能をご利用ください。
           削除はトレーニング記録ページのトレーニング履歴からでも行えます。</p>
    </div>
</div>
```

### 設計判断の根拠

#### なぜ自動除外を廃止したのか

**v2.3.0での課題**:
1. **180¢閾値の限界**: システムが「測定エラー」と「実力としての弱点」を区別できない
2. **情報の損失**: 自動除外により、ユーザーが本当の実力を把握できない
3. **透明性の欠如**: なぜ除外されたのか、ユーザーには不明瞭

**v2.4.0での解決アプローチ**:
1. **レッスン削除機能の実装**: ユーザー自身が判断・削除可能に
2. **完全な情報開示**: すべてのデータを評価に含め、800¢超は警告表示
3. **設計思想の転換**: システムが判断 → ユーザーが判断

#### 800¢閾値を選んだ理由

- **8半音の物理的意味**: オクターブの2/3という明確な基準
- **測定エラーの判別**: 通常の音程ズレではあり得ない誤差
- **警告のみの役割**: 自動除外せず、ユーザーに判断を委ねる
- **Practice評価との区別**: 50-800¢（赤系）vs 800¢超（amber）で視覚的に分離

### メリットとデメリット

#### メリット

1. **透明性の向上**
   - ユーザーがすべてのデータを確認可能
   - 評価の根拠が明確

2. **実力の正確な把握**
   - 自動除外による「良く見せる」効果の廃止
   - 本当の弱点が可視化される

3. **ユーザーの主体性**
   - 削除判断はユーザーが実施
   - システムは情報提供に徹する

4. **長期データ収益化への布石**
   - すべてのデータを蓄積
   - 将来の詳細分析で活用可能

#### デメリットと対策

1. **評価が厳しくなる可能性**
   - **対策**: 警告メッセージで削除機能を案内
   - **効果**: ユーザーが納得して削除可能

2. **ユーザーの判断負担**
   - **対策**: 明確な視覚的区別（amber背景 + alert-circle）
   - **効果**: どれが異常値か一目瞭然

3. **測定エラーの混入**
   - **対策**: 800¢超を警告表示し、削除を推奨
   - **効果**: ユーザーが能動的にデータ品質管理

### 技術実装サマリー

#### 変更ファイル一覧

| ファイル | 変更内容 |
|---------|---------|
| `evaluation-calculator.js` | v2.0.0: OUTLIER_THRESHOLD定数追加、extractSessionMetrics()追加 |
| `result-session-controller.js` | v3.4.0: extractSessionMetrics()で一元管理、ハードコード廃止 |
| `results-overview-controller.js` | v4.14.0: extractSessionMetrics()で一元管理、ハードコード廃止 |
| `DistributionChart.js` | 800¢超除外ロジック削除、全データをPracticeとしてカウント |
| `base.css` | `.text-amber-500`クラス追加 |
| `results.css` | `.note-result-item.error-outlier`スタイル追加 |

#### 一元管理アーキテクチャ (v2.5.0)

```
EvaluationCalculator（中央管理クラス）
├── OUTLIER_THRESHOLD = 800        # 外れ値警告閾値（定数）
├── extractSessionMetrics()        # 単一セッション用メトリクス抽出
│   └── 戻り値: { avgError, outlierCount, outlierFiltered, errors, totalNotes }
├── calculateBasicMetrics()        # 複数セッション用（総合評価）
├── evaluateAverageError()         # 平均誤差→評価レベル判定
└── evaluatePitchError()           # 個別誤差→評価レベル判定

使用箇所:
├── result-session-controller.js   # セッション結果ページ（ランダム基音モード）
├── results-overview-controller.js # 総合評価ページ（全モード共通）
└── records-controller.js          # トレーニング記録ページ
```

**閾値変更時の修正箇所**:
```javascript
// evaluation-calculator.js の1箇所のみ変更すれば全体に反映
static OUTLIER_THRESHOLD = 800;  // ← ここを変更するだけ
```

#### UI表示ルール

| 誤差範囲 | 評価 | アイコン | 色 | 背景 |
|---------|------|---------|-----|------|
| 0-20¢ | Excellent | trophy | 金色 | なし |
| 20-35¢ | Good | star | 緑色 | なし |
| 35-50¢ | Pass | thumbs-up | 青色 | なし |
| 50-800¢ | Practice | alert-triangle | 薄いピンク | なし |
| 800¢超 | 測定エラー | alert-circle | amber | amber 10% |

### 今後のデータ活用計画

#### Phase 3: 詳細分析レポートでの活用

**800¢超データの分析**:
- 測定エラーの頻度分析（マイク品質・環境の問題特定）
- 特定の音程での異常値パターン分析
- デバイス別・環境別の誤差傾向分析

**長期データ収集の価値**:
- ユーザーの成長曲線の可視化
- 苦手音程の変化追跡
- 練習効果の定量的評価

#### Phase 4-5: 収益化との関係

**無料版**: 警告表示のみ、削除機能は手動
**有料版（検討中）**:
- 測定エラー自動検出・推奨削除リスト
- 苦手音程の詳細分析・練習メニュー提案
- 長期成長レポート・パーソナライズドコーチング

---

**v2.4.0の設計思想**: システムは透明性を重視し、判断はユーザーに委ねる。すべてのデータを蓄積し、将来の高度な分析に活用する。
