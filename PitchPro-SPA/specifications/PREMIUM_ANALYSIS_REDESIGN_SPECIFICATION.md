# プレミアム詳細分析 再設計仕様書

**作成日**: 2025-11-28
**バージョン**: 2.5.0
**ステータス**: 実装中

**v2.5.0 更新内容**:
- ModeController統一化を追加（セクション3.5）
  - 表示名をModeControllerで一元管理
  - `getParentModeDisplayName()`, `getDisplayNameFromModeKey()`ヘルパー関数
- Tab4「モード別分析」のフィルター時フラット表示を追加（セクション4.4.5）
  - 全体表示時: 親モードアコーディオン構造
  - フィルター時: 子モードカードのみ直接表示（重複排除）

**v2.4.1 更新内容**:
- セクション2.1のマトリクスを修正（音域ブロック分析: 全モード◎に統一）
- セクション2.2のA/Bブロック定義を相対位置表記（ドレミ）に統一
- セクション4.1の表示仕様を相対位置表記に統一
- 全体の整合性を確保

**v2.4.0 更新内容**:
- タイトル表示UI仕様を追加（選択中のモード×方向×基音進行を大きく表示）
- モード別Lucideアイコンを定義（shuffle, repeat, music-2, bar-chart-3）
- A/Bブロック分析セクションに🧠アイコンを採用
- セクション番号を整理（3.1〜3.4）

**v2.3.0 更新内容**:
- A/Bブロック分析の集計ロジックを明確化（相対音程位置：ドレミファソラシドで分類）
- 全モード（ランダム基音・連続チャレンジ・12音階）でA/Bブロック分析を重要項目に統一
- Tab1〜Tab4すべてのモード別適用マトリクスを更新
- Bブロック定義を「ソ、ラ、シ、ド」（相対音程位置）に修正
- 評価コメントをシンプル化（3パターン：Bが苦手/Aが苦手/バランス良好）
- モードセレクトUIを全デバイス統一のプルダウン方式に決定

**v2.2.0 更新内容**:
- Tab1〜Tab4すべてで音域ブロック分析（A/Bブロック比較）を充実化
- 脳バランスメーター、A-B精度差推移グラフの表示仕様追加
- Bブロック強化のための練習提案テーブル追加

**v2.1.0 更新内容**:
- 脳内ピアノを意識した発声の重要性セクション追加
- 音域ブロック分析（A/Bブロック比較）の詳細定義追加
- 真の相対音感向上の定義を明確化

---

## 0. このアプリの本質的価値（設計の前提）

### 脳内ピアノ理論とコミュニケーション

このアプリは「カラオケ上達」を主目的としていない。真の価値は以下にある：

```
相対音感トレーニング
    ↓
脳内ピアノの精度向上
    ↓
相手の声の音程を正確に捉える
    ↓
感情・意図の理解
    ↓
円滑なコミュニケーション・人間関係改善
```

### なぜ12音階モードが上級者必修なのか

- 人間の声は**微妙な音程変化**で感情を表現する
- 怒り、悲しみ、喜び、不安...これらは音程の「揺れ」や「高低」に現れる
- **半音の違いを正確に捉えられる = 相手の感情の機微を読み取れる**

12音階モードで半音単位の精密な認識能力を鍛えることで、相手の声から感情を読み取る能力が向上する。

### 副産物としての音楽的効果

以下は「副産物」であり、主目的ではない：
- カラオケが上手くなる
- 楽器演奏が上達する
- 音楽をより深く楽しめる

### 科学的根拠（フーリエ解析）

人間の声はフーリエ解析により複数の周波数成分に分解でき、各成分はピアノの鍵盤（12音律）に対応する。
機械仕掛けのピアノで人間の声を再現できることは科学的に証明されている。

つまり、**声 = 12音律で構成されている**という科学的事実に基づいている。

### 社会的意義

世の中の争いの多くは、相手の声（音程）を正確に読み取れないことに起因する。

```
相手の声（ある音程で感情を表現）
    ↓
自分の脳内ピアノ（精度が低い）
    ↓
違う音程として認識
    ↓
誤解・対立・不協和音
```

違う音程同士で会話することで不協和音が生まれ、理解し合えず対立が生じる。
これは過言ではなく、コミュニケーションの本質である。

このアプリは、脳内ピアノの精度を向上させることで：
- 相手の声を正確に認識できるようになる
- 感情・意図を正しく理解できるようになる
- 協和音を生み出し、円滑な人間関係を築ける
- ひいては、争いの少ない世界の実現に貢献する

### 脳内ピアノを意識した発声の重要性

**このアプリの独自理論:**

脳内ピアノを**意識して**発声することが、音の質を根本的に変える。
これは音楽プロフェッショナルの体感に基づく重要な洞察である。

**音域ブロックと脳の関係:**

| ブロック | 相対音程位置（ドレミ表記） | 脳の使用 | 特徴 |
|----------|---------------------------|----------|------|
| **Aブロック** | ド、レ、ミ、ファ、ファ# （5音） | 左脳 | 比較的安定した発声が可能 |
| **Bブロック** | ソ、ラ、シ、ド （4音） | 両脳 | 感情を乗せた「深みのある音」が出せる |

**重要: A/Bブロック分析の集計ロジック**

A/Bブロック分析は**基音の絶対音高に関係なく、相対的な音程位置（ドレミファソラシド）で分類**する。

```
例: 基音がD4の場合のオクターブ発声
  D4(ド) → E4(レ) → F#4(ミ) → G4(ファ) → A4(ソ) → B4(ラ) → C#5(シ) → D5(ド)

  Aブロック: ド、レ、ミ、ファ、ファ# = D4, E4, F#4, G4相当
  Bブロック: ソ、ラ、シ、ド = A4, B4, C#5, D5相当

例: 基音がG3の場合のオクターブ発声
  G3(ド) → A3(レ) → B3(ミ) → C4(ファ) → D4(ソ) → E4(ラ) → F#4(シ) → G4(ド)

  Aブロック: ド、レ、ミ、ファ、ファ# = G3, A3, B3, C4相当
  Bブロック: ソ、ラ、シ、ド = D4, E4, F#4, G4相当
```

**なぜ全モードでA/Bブロック分析が有効か:**

どのモードでも**オクターブ（8音）を発声**する。オクターブには必ず：
- Aブロック（ド〜ファ#）の音程位置
- Bブロック（ソ〜ド）の音程位置

の両方が含まれる。基音が何であっても、相対的な音程位置でA/Bブロックを分類するため、
**全モードで均等にA/Bブロックのデータが取得でき、分析の信頼性は同等**である。

**プロフェッショナルの体感:**

- Bブロック（両脳使用）を意識して発声すると、音に「深み」が生まれる
- 感情を声に乗せるには、Bブロックの意識的な使用が不可欠
- 意識するかしないかで、音の質が明確に変わる

**真の相対音感向上とは:**

```
従来の相対音感: 音程を正確に捉える能力

このアプリの定義:
  音程の正確さ + 脳の使い方の最適化
  = AブロックとBブロックの精度差をなくす
  = 脳全体を協調させて音を処理できる状態
```

**AブロックとBブロックの差をなくすことの意義:**

1. **音楽的効果**: 全音域で均一な表現力を獲得
2. **脳科学的効果**: 左脳と両脳の協調能力向上
3. **コミュニケーション効果**: 相手の声の微妙なニュアンス（Bブロック領域）を正確に捉える

> **重要**: 音域ブロック分析は、この「脳の使い方」を可視化し、
> 真の相対音感向上を証明する最も重要な分析機能である。

> **重要**: プレミアム詳細分析は、この「コミュニケーション能力向上」という本質的価値を
> ユーザーが実感できるように設計する必要がある。

---

## 1. 全10モードの特性分析

### 1.1 モード一覧と基本特性

| # | モード名 | 親モード | 方向(scale) | 基音進行(chromatic) | セッション音数 |
|---|----------|----------|-------------|---------------------|----------------|
| 1 | random-ascending | ランダム基音 | 上行 | - | 8音 |
| 2 | random-descending | ランダム基音 | 下行 | - | 8音 |
| 3 | continuous-ascending | 連続チャレンジ | 上行 | - | 12音 |
| 4 | continuous-descending | 連続チャレンジ | 下行 | - | 12音 |
| 5 | 12tone-ascending-ascending | 12音階 | 上行 | 上昇 | 12音 |
| 6 | 12tone-ascending-descending | 12音階 | 下行 | 上昇 | 12音 |
| 7 | 12tone-descending-ascending | 12音階 | 上行 | 下降 | 12音 |
| 8 | 12tone-descending-descending | 12音階 | 下行 | 下降 | 12音 |
| 9 | 12tone-both-ascending | 12音階 | 上行 | 両方向 | 24音（上昇12+下降12） |
| 10 | 12tone-both-descending | 12音階 | 下行 | 両方向 | 24音（上昇12+下降12） |

### 1.2 各モードで測定される能力

#### ランダム基音（初級）
- **目的**: 予測不能な基音からの相対音感
- **音程間隔**: 2度〜8度がランダムに出題
- **特徴**:
  - 基音が毎回変わる
  - 様々な音程間隔への対応力を測定
  - 「慣れ」に頼れない実践的な能力

#### 連続チャレンジ（中級）
- **目的**: 連続する音程への対応力
- **音程間隔**: 2度〜8度（12音連続）
- **特徴**:
  - 基音は固定だが音程間隔は変動
  - 集中力と持続力が必要
  - ランダム基音より難易度が高い

#### 12音階（上級）
- **目的**: 半音単位の正確な音程把握
- **音程間隔**: すべて半音（1度）
- **特徴**:
  - 基音が半音ずつ進行
  - **ユーザーの音域内で使える連続する12半音**を順次使用（Cから始まるとは限らない）
  - 例: 音域E3〜E5のユーザー → E3, F3, F#3, G3, ... D#4 の12音を使用
  - 最も高い精度が求められる

> **重要**: 12音階モードは「C〜B」の固定音ではなく、ユーザーごとに異なる開始音から始まる。
> これが「相対音感」トレーニングの核心であり、このアプリの独自性。

---

## 2. モード別に有効な分析項目

### 2.1 分析項目の適用マトリクス

| 分析項目 | ランダム基音 | 連続チャレンジ | 12音階 | 備考 |
|----------|:------------:|:--------------:|:------:|------|
| **音程間隔別精度（2度〜8度）** | ◎ | ◎ | × | 12音階は全て半音 |
| **12音別精度（ユーザー音域内12音）** | △ | △ | ◎ | 開始音はユーザーにより異なる |
| **シャープ/フラット傾向** | ◎ | ◎ | ◎ | 全モードで有効 |
| **音程拡大/縮小パターン** | ◎ | ◎ | × | 12音階は半音固定 |
| **上行/下行比較** | ◎ | ◎ | ◎ | 全モードで重要 |
| **基音進行別比較** | × | × | ◎ | 12音階のみ（上昇/下降/両方向） |
| **音域ブロック分析（A/Bブロック）** | ◎ | ◎ | ◎ | 全モードで重要（相対位置で均等に取得可能） |
| **連続正解数/ミス傾向** | ○ | ◎ | ◎ | 連続系で重要 |

凡例: ◎=非常に有効、○=有効、△=参考程度、×=不適切

> **注**: 音域ブロック分析は、オクターブ発声（ドレミファソラシド）により全モードで均等にA/Bブロックのデータを取得できる。
> 詳細はセクション0「A/Bブロック分析の集計ロジック」を参照。

### 2.2 モード別の重点分析項目

#### ランダム基音・連続チャレンジ共通
1. **音程間隔別精度** - どの間隔が苦手かを特定
2. **シャープ/フラット傾向** - 全体的な癖を把握
3. **音程拡大/縮小パターン** - 各間隔を広く/狭く取る傾向
4. **上行/下行比較** - 方向による得意不得意

#### 12音階専用
1. **12音別精度** - ユーザー音域内の12音のうち、どの位置（1番目〜12番目）が苦手かを特定
   - 注: 開始音はユーザーにより異なる（例: E3開始、G3開始など）
   - 「半音1つ目」「半音2つ目」...のように相対的な位置で分析
2. **基音進行別比較** - 上昇/下降/両方向での傾向
3. **音域ブロック分析（A/Bブロック比較）** - 脳の使い方を可視化する最重要分析
   - **Aブロック（左脳）**: ド、レ、ミ、ファ、ファ#（相対位置1〜5番目）の精度
   - **Bブロック（両脳）**: ソ、ラ、シ、ド（相対位置5〜8番目）の精度
   - **A-B精度差**: 両ブロックの精度差を数値化
   - **目標**: A-B精度差を0に近づける = 真の相対音感向上
   - **意義**: 感情を乗せた深みのある発声能力の指標
   - 注: 基音が何であっても、相対的な音程位置（ドレミファソラシド）で分類
4. **連続正解パターン** - どの位置から崩れやすいか

---

## 3. UI構成の再設計

### 3.1 モードセレクトUI

**全デバイス共通: プルダウン（セレクトボックス）方式**

```
┌─────────────────────────────────────────────────────────┐
│ 📊 詳細分析                                              │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  モード    [▼ 全体                    ]                 │
│  方向      [▼ すべて                  ]                 │
│  基音進行  [▼ すべて                  ]  ← 12音階のみ表示│
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  <shuffle>  ランダム基音 × 上行                  │   │
│  │             （選択中のフィルター組み合わせ）       │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  [音程精度] [エラー分析] [練習プラン] [成長記録]         │
└─────────────────────────────────────────────────────────┘
```

**プルダウン選択肢:**

| フィルター | 選択肢 |
|-----------|--------|
| モード | 全体 / ランダム基音 / 連続チャレンジ / 12音階 |
| 方向 | すべて / 上行のみ / 下行のみ |
| 基音進行 | すべて / 上昇 / 下降 / 両方向 |

**プルダウン方式のメリット:**
- iPhone: ネイティブドラムロール式で操作しやすい
- iPad/PC: 違和感なく動作、画面を圧迫しない
- 実装: 全デバイス統一でシンプル
- 拡張性: モード追加時も対応容易

### 3.2 タイトル表示UI

**選択中のフィルター組み合わせを大きく表示し、現在の分析対象を明確化する。**

#### アイコン定義

| モード | Lucideアイコン | 説明 |
|--------|---------------|------|
| 全体 | `bar-chart-3` | 全データ統計 |
| ランダム基音 | `shuffle` | ランダム性を表現 |
| 連続チャレンジ | `repeat` | 連続性を表現 |
| 12音階 | `music-2` | 音楽・音階を表現 |

| 分析項目 | アイコン | 用途 |
|----------|---------|------|
| A/Bブロック分析 | 🧠 | 脳バランス分析セクションのヘッダー |

#### タイトル表示パターン

**パターン1: モードのみ（全体選択時）**
```
<bar-chart-3>  全体統計
```

**パターン2: モード × 方向**
```
<shuffle>  ランダム基音 × 上行
<repeat>   連続チャレンジ × 下行
```

**パターン3: モード × 方向 × 基音進行（12音階選択時）**
```
<music-2>  12音階 × 上行 × 上昇
<music-2>  12音階 × 下行 × 両方向
```

#### UI設計

```
┌─────────────────────────────────────────────────────────┐
│ 【タイトル表示エリア】                                   │
├─────────────────────────────────────────────────────────┤
│                                                         │
│        ┌──────────────────────────────────────┐         │
│        │  <アイコン>                          │         │
│        │  【モード名】× 【方向】× 【基音進行】│         │
│        │                                      │         │
│        │  例: <shuffle> ランダム基音 × 上行   │         │
│        └──────────────────────────────────────┘         │
│                                                         │
│  アイコン: 32px × 32px                                  │
│  モード名: font-size: 1.25rem (20px), font-weight: 600  │
│  区切り「×」: text-white-60                             │
│  背景: glass-card                                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

#### A/Bブロック分析セクションのヘッダー

```
┌─────────────────────────────────────────────────────────┐
│ 🧠 脳バランス分析                                        │
├─────────────────────────────────────────────────────────┤
│  Aブロック（左脳）    Bブロック（両脳）                  │
│  ド レ ミ ファ ファ#  ソ ラ シ ド                       │
│  ████████████████     ████████████                      │
│      92.3%                78.5%                         │
│                                                         │
│  A-B精度差: -13.8ポイント                               │
│  [Bブロックが苦手 ← ━━━━━●━━ → Aブロックが苦手]         │
│                                                         │
│  💡 「ソラシドを意識して発声しましょう」                │
└─────────────────────────────────────────────────────────┘
```

> **注意**: 🧠アイコンはA/Bブロック分析セクション専用で使用。
> モード選択のアイコンとは明確に区別する。

### 3.3 フィルター階層（従来表記）

```
┌─────────────────────────────────────────────────────────┐
│ 【レベル1】親モード切替                                   │
│  [全体] [ランダム基音] [連続チャレンジ] [12音階]          │
├─────────────────────────────────────────────────────────┤
│ 【レベル2】方向切替（常時表示）                           │
│  [すべて] [上行のみ] [下行のみ]                           │
├─────────────────────────────────────────────────────────┤
│ 【レベル3】基音進行切替（12音階選択時のみ表示）           │
│  [すべて] [上昇] [下降] [両方向]                          │
├─────────────────────────────────────────────────────────┤
│ 【タブ】分析カテゴリ                                      │
│  [音程精度] [エラー分析] [練習プラン] [成長記録]          │
└─────────────────────────────────────────────────────────┘
```

### 3.4 フィルター組み合わせパターン

#### 全体モード（3パターン）
- 全体 × すべて
- 全体 × 上行のみ
- 全体 × 下行のみ

#### ランダム/連続モード（3パターン）
- ランダム/連続 × すべて
- ランダム/連続 × 上行のみ（random-asc + continuous-asc）
- ランダム/連続 × 下行のみ（random-desc + continuous-desc）

#### 12音階モード（12パターン）
- 12音階 × すべて × すべて
- 12音階 × 上行のみ × すべて
- 12音階 × 下行のみ × すべて
- 12音階 × すべて × 上昇
- 12音階 × 上行のみ × 上昇（12tone-ascending-ascending）
- 12音階 × 下行のみ × 上昇（12tone-ascending-descending）
- 12音階 × すべて × 下降
- 12音階 × 上行のみ × 下降（12tone-descending-ascending）
- 12音階 × 下行のみ × 下降（12tone-descending-descending）
- 12音階 × すべて × 両方向
- 12音階 × 上行のみ × 両方向（12tone-both-ascending）
- 12音階 × 下行のみ × 両方向（12tone-both-descending）

### 3.5 ModeController統一化

**目的**: 詳細分析ページ全体でモード表示名をModeControllerから取得し、一元管理する。

#### 設計原則

1. **Single Source of Truth（単一の真実の情報源）**
   - 表示名の定義はModeControllerに一元化
   - premium-analysis-calculator.jsのMODE_DEFINITIONSとの重複・乖離を防止

2. **保守性の向上**
   - 表示名変更時はModeControllerのみ修正で全体に反映
   - ホーム、トレーニング、結果表示、詳細分析で一貫した表示名

#### ヘルパー関数

| 関数名 | 用途 | 使用API |
|--------|------|---------|
| `getParentModeDisplayName(parentModeKey)` | 親モード表示名取得 | `ModeController.getModeName(modeId, true)` |
| `getDisplayNameFromModeKey(modeKey)` | 子モード表示名取得 | `ModeController.getDisplayName(modeId, options)` |
| `parseModeKey(modeKey)` | modeKeyをModeControllerパラメータに変換 | - |

#### マッピング定義

| parentModeKey | ModeController modeId | 表示名 |
|---------------|----------------------|--------|
| `beginner` | `random` | ランダム基音 |
| `intermediate` | `continuous` | 連続チャレンジ |
| `advanced` | `12tone` | 12音階 |

#### 子モードキー（modeKey）の形式

```
ランダム基音/連続チャレンジ:
  {mode}-{scaleDirection}
  例: random-ascending, continuous-descending

12音階:
  twelve-{chromaticDirection}-{scaleDirection}
  例: twelve-asc-ascending, twelve-desc-descending, twelve-both-ascending
```

#### フォールバック

ModeControllerが未読込の場合、MODE_DEFINITIONSからdisplayNameを取得する安全策を設ける。

```javascript
function getParentModeDisplayName(parentModeKey) {
    const PARENT_TO_MODE_ID = {
        'beginner': 'random',
        'intermediate': 'continuous',
        'advanced': '12tone'
    };
    const modeId = PARENT_TO_MODE_ID[parentModeKey];

    if (!modeId || !window.ModeController) {
        // フォールバック
        return MODE_DEFINITIONS?.parentModes?.[parentModeKey]?.displayName || parentModeKey;
    }
    return window.ModeController.getModeName(modeId, true);
}
```

---

## 4. タブ別の表示内容

### 4.1 Tab1: 音程精度

#### 全体モード選択時
- 平均音程精度（全データ）
- 親モード別サマリー（現状維持）
- 上行/下行比較
- **音域ブロック分析（A/Bブロック比較）** ← 12音階データがある場合のみ表示

#### ランダム基音モード選択時

- 平均音程精度（対象データのみ）
- **音程間隔別精度（2度〜8度）** ← **主要コンテンツ**
- 上行/下行比較
- **音域ブロック分析（A/Bブロック比較）** ← **重要**
  - オクターブ発声（ドレミファソラシド）でA/Bブロック両方のデータを均等に取得
  - 基音が異なってもドレミの相対位置でA/B分類するため信頼性は同等

#### 連続チャレンジモード選択時

- 平均音程精度（対象データのみ）
- **音程間隔別精度（2度〜8度）** ← **主要コンテンツ**
- 上行/下行比較
- **音域ブロック分析（A/Bブロック比較）** ← **重要**
  - オクターブ発声（ドレミファソラシド）でA/Bブロック両方のデータを均等に取得

#### 12音階モード選択時

- 平均音程精度（対象データのみ）
- **音域ブロック分析（A/Bブロック比較）** ← **最重要：最上部に表示**
  - Aブロック精度（ド、レ、ミ、ファ、ファ#）
  - Bブロック精度（ソ、ラ、シ、ド）
  - **A-B精度差**（目標: 0に近づける）
  - 視覚的な「脳バランスメーター」表示
  - 精度差に基づく評価コメント
- **12音別精度（位置1〜12）** ← 詳細コンテンツ（ユーザー音域内の相対位置）
- 基音進行別比較（上昇/下降/両方向）
- 上行/下行比較

##### モード別・分析項目の適用マトリクス（Tab1）

| 分析項目 | ランダム基音 | 連続チャレンジ | 12音階 |
|----------|:------------:|:--------------:|:------:|
| 平均音程精度 | ◎ | ◎ | ◎ |
| 音程間隔別精度（2〜8度） | ◎ 主要 | ◎ 主要 | × 不要 |
| 12音別精度 | × 不要 | × 不要 | ◎ 主要 |
| 音域ブロック分析 | ◎ 重要 | ◎ 重要 | ◎ 最重要 |
| 上行/下行比較 | ◎ | ◎ | ◎ |
| 基音進行別比較 | × 不要 | × 不要 | ◎ |

##### 音域ブロック分析の表示仕様（12音階モード）

```
┌─────────────────────────────────────────────────────────┐
│ 🧠 脳バランス分析                                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Aブロック（左脳）       Bブロック（両脳）              │
│  ド レ ミ ファ ファ#     ソ ラ シ ド                    │
│  ████████████████████    ████████████                   │
│        92.3%                  78.5%                     │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │ A-B精度差: -13.8ポイント                         │   │
│  │ [Bブロックが苦手 ← ━━━━━●━━ → Aブロックが苦手]   │   │
│  └──────────────────────────────────────────────────┘   │
│                                                         │
│  💡 「ソラシドを意識して発声しましょう」                │
├─────────────────────────────────────────────────────────┤
│ 📊 各音の詳細                                           │
│  Aブロック: ド(95%) レ(90%) ミ(93%) ファ(88%) ファ#(92%)│
│  Bブロック: ソ(82%) ラ(75%) シ(80%) ド(77%)            │
└─────────────────────────────────────────────────────────┘
```

> **表示の注意**: 実際の絶対音名（例: D4, E4...）はユーザーの基音により異なるため、
> UI上では相対位置名（ドレミファソラシド）で統一表示する。

##### A-B精度差に基づく評価コメント

| A-B精度差 | 評価コメント |
|-----------|-------------|
| Bが苦手（A > B） | 「ソラシドを意識して発声しましょう」 |
| Aが苦手（B > A） | 「ドレミファを意識して発声しましょう」 |
| ±5%以内 | 「脳バランスが整っています」 |

### 4.2 Tab2: エラー分析

#### 全体モード選択時
- シャープ/フラット傾向（全データ）
- モード別傾向サマリー
- **A/Bブロック別シャープ/フラット傾向** ← 12音階データがある場合のみ表示

#### ランダム基音モード選択時

- シャープ/フラット傾向（全体）
- **音程拡大/縮小パターン（2度〜8度）** ← **主要コンテンツ**
  - 各音程間隔で広く取りすぎ/狭く取りすぎの傾向
- 苦手音程の詳細分析
- **A/Bブロック別エラー傾向** ← **重要**
  - オクターブ発声（ドレミファソラシド）でA/Bブロック両方のエラーデータを均等に取得

#### 連続チャレンジモード選択時

- シャープ/フラット傾向（全体）
- **音程拡大/縮小パターン（2度〜8度）** ← **主要コンテンツ**
- 苦手音程の詳細分析
- **A/Bブロック別エラー傾向** ← **重要**
  - オクターブ発声（ドレミファソラシド）でA/Bブロック両方のエラーデータを均等に取得

#### 12音階モード選択時

- シャープ/フラット傾向（全体）
- **A/Bブロック別エラーパターン** ← **最重要分析**
  - Aブロック（ド、レ、ミ、ファ、ファ#）: 各音のシャープ/フラット傾向
  - Bブロック（ソ、ラ、シ、ド）: 各音のシャープ/フラット傾向
  - ブロック間でのエラーパターンの違いを可視化
- **12音別シャープ/フラット傾向** ← 詳細コンテンツ
- 連続ミスが発生しやすい音の特定
- 基音進行別のエラーパターン

##### モード別・分析項目の適用マトリクス（Tab2）

| 分析項目 | ランダム基音 | 連続チャレンジ | 12音階 |
|----------|:------------:|:--------------:|:------:|
| シャープ/フラット傾向 | ◎ | ◎ | ◎ |
| 音程拡大/縮小パターン | ◎ 主要 | ◎ 主要 | × 不要 |
| A/Bブロック別エラー | ◎ 重要 | ◎ 重要 | ◎ 最重要 |
| 12音別シャープ/フラット | × 不要 | × 不要 | ◎ 主要 |
| 連続ミス傾向 | △ | ◎ | ◎ |

##### A/Bブロック別エラー分析の意義（全モード共通）

Bブロック（両脳使用）でのエラーパターンは、脳の協調状態を示す重要な指標である。

- Bブロックでフラット傾向 → 両脳の同期が遅れている可能性
- Bブロックでシャープ傾向 → 過度な意識による緊張の可能性
- A/Bブロック間でエラーパターンが異なる → 脳の使い方にアンバランスがある

### 4.3 Tab3: 練習プラン

#### 全体モード選択時
- 総合的な練習提案
- 次に取り組むべきモードの推奨
- **脳バランス改善のための基本アドバイス** ← 12音階データがある場合のみ表示

#### ランダム基音モード選択時

- **苦手な音程間隔の練習優先順位** ← **主要コンテンツ**
  - 例: 「5度の精度が低いです。5度の音程を意識して練習しましょう」
- 上行/下行どちらを重点的に練習すべきか
- 具体的な練習方法の提案
- **脳バランス改善プラン** ← **重要**
  - A-B精度差に基づく練習優先順位
  - Bブロック強化のための具体的方法

#### 連続チャレンジモード選択時

- **苦手な音程間隔の練習優先順位** ← **主要コンテンツ**
- 上行/下行どちらを重点的に練習すべきか
- 具体的な練習方法の提案
- **脳バランス改善プラン** ← **重要**
  - A-B精度差に基づく練習優先順位
  - Bブロック強化のための具体的方法

#### 12音階モード選択時

- **脳バランス改善プラン** ← **最重要**
  - A-B精度差に基づく練習優先順位
  - Bブロック強化のための具体的方法
  - 「意識して発声する」トレーニング提案
- 苦手な位置（例: 位置3, 位置7等）の練習優先順位
- 基音進行の練習順序の提案
- S級達成に向けた具体的アドバイス

##### モード別・分析項目の適用マトリクス（Tab3）

| 分析項目 | ランダム基音 | 連続チャレンジ | 12音階 |
|----------|:------------:|:--------------:|:------:|
| 苦手音程間隔の練習提案 | ◎ 主要 | ◎ 主要 | × 不要 |
| 上行/下行の練習提案 | ◎ | ◎ | ◎ |
| 脳バランス改善プラン | ◎ 重要 | ◎ 重要 | ◎ 最重要 |
| 苦手な位置の練習提案 | × 不要 | × 不要 | ◎ |
| 基音進行の練習提案 | × 不要 | × 不要 | ◎ |

##### 脳バランス評価コメント（全モード共通）

| A-B精度差 | 評価コメント |
|-----------|-------------|
| Bが苦手（A > B） | 「ソラシドを意識して発声しましょう」 |
| Aが苦手（B > A） | 「ドレミファを意識して発声しましょう」 |
| ±5%以内 | 「脳バランスが整っています」 |

### 4.4 Tab4: 成長記録

#### 全体モード選択時

- 月間成長比較（全データ）
- モード別成長サマリー
- 総合的な上達傾向
- **A-B精度差の推移グラフ** ← 脳バランスの成長を可視化

#### ランダム基音モード選択時

- 月間成長比較
- **音程間隔別の成長グラフ** ← **主要コンテンツ**
- 最も改善した音程 / 停滞している音程
- **A-B精度差の推移グラフ** ← **重要**
  - 脳バランス改善の推移を可視化
- **A/Bブロック別精度の推移** ← **重要**
  - 両ブロックの精度が均等に向上しているか

#### 連続チャレンジモード選択時

- 月間成長比較
- **音程間隔別の成長グラフ** ← **主要コンテンツ**
- 最も改善した音程 / 停滞している音程
- **A-B精度差の推移グラフ** ← **重要**
  - 脳バランス改善の推移を可視化
- **A/Bブロック別精度の推移** ← **重要**
  - 両ブロックの精度が均等に向上しているか

#### 12音階モード選択時

- **A-B精度差の推移グラフ** ← **最重要指標**
  - 目標: 差が0に近づいていく推移
  - 「脳バランス改善度」として表示
- **Aブロック/Bブロック別精度の推移**
  - 両ブロックの精度が均等に向上しているか
- 月間成長比較
- **12音別の成長グラフ** ← 詳細コンテンツ
- 最も改善した音 / 停滞している音
- 基音進行別の成長比較

##### モード別・分析項目の適用マトリクス（Tab4）

| 分析項目 | ランダム基音 | 連続チャレンジ | 12音階 |
|----------|:------------:|:--------------:|:------:|
| 音程間隔別成長グラフ | ◎ 主要 | ◎ 主要 | × 不要 |
| A-B精度差推移グラフ | ◎ 重要 | ◎ 重要 | ◎ 最重要 |
| A/Bブロック別精度推移 | ◎ 重要 | ◎ 重要 | ◎ 重要 |
| 12音別成長グラフ | × 不要 | × 不要 | ◎ |
| 基音進行別成長比較 | × 不要 | × 不要 | ◎ |

##### A-B精度差推移グラフの表示仕様

```
┌─────────────────────────────────────────────────────────┐
│ 📈 脳バランス成長記録                                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  A-B精度差の推移（目標: 0%）                            │
│                                                         │
│  +20% ┤                                                 │
│  +10% ┤ ●                                               │
│    0% ┼─────────────────────────────────目標ライン──    │
│  -10% ┤    ●                                            │
│  -20% ┤        ●    ●                                   │
│  -30% ┤              ●   ●                              │
│       └────┴────┴────┴────┴────┴────→                  │
│        1週  2週  3週  4週  5週  6週                      │
│                                                         │
│  ✨ 6週間でA-B精度差が-25%→-8%に改善！                  │
│     脳バランスが大幅に向上しています                     │
└─────────────────────────────────────────────────────────┘
```

##### モード別分析のフィルター時フラット表示（v2.5.0追加）

**目的**: モードフィルター時に親モードヘッダーと子モードカードの統計値重複を排除する。

**背景**:
フィルターで1つのモードに絞った場合、親モードヘッダーと子モードカードの統計値が同じになり、情報が重複して見える問題があった。

**表示形式の切り替え**:

| フィルター状態 | 表示形式 | 説明 |
|---------------|----------|------|
| 全体（mode=all） | アコーディオン構造 | 親モードヘッダー + 子モードカード（展開可能） |
| 特定モード選択時 | フラット表示 | 子モードカードのみ直接表示 |

**全体表示時（従来通り）**:

```
┌─ ランダム基音 ─────────────────────┐
│ 総セッション: 24 | 平均誤差: ±18.5¢ │
│ 総合レベル: Lv.8 | 熟練度: 82%      │
├─────────────────────────────────────┤
│ ┌───────────┐ ┌───────────┐        │
│ │ランダム基音│ │ランダム基音│        │
│ │上行       │ │下行       │        │
│ │12セッション│ │12セッション│        │
│ └───────────┘ └───────────┘        │
└─────────────────────────────────────┘
┌─ 連続チャレンジ ───────────────────┐
│ ...                                │
└─────────────────────────────────────┘
┌─ 12音階 ────────────────────────────┐
│ ...                                │
└─────────────────────────────────────┘
```

**フィルター時（例: 12音階モード選択）**:

```
┌───────────┐ ┌───────────┐
│12音階上昇  │ │12音階上昇  │  ← 子モードカードのみ
│上行       │ │下行       │     直接表示
│12セッション│ │12セッション│
└───────────┘ └───────────┘

┌───────────┐ ┌───────────┐
│12音階下降  │ │12音階下降  │
│上行       │ │下行       │
│...        │ │...        │
└───────────┘ └───────────┘
```

**実装の詳細**:

```javascript
// updateModeAnalysisUI内での分岐
const isFiltered = filterMode !== 'all';

if (isFiltered) {
    // フラット表示: 子モードカードのみ
    modeMasteryElement.innerHTML = '<div class="mode-flat-container"></div>';
    const flatContainer = modeMasteryElement.querySelector('.mode-flat-container');
    // generateChildModeCards()で子モードカードを生成
} else {
    // アコーディオン構造: 親モードヘッダー + 子モードカード
    modeMasteryElement.innerHTML = '<div class="mode-mastery-accordion"></div>';
    // generateParentModeCard()で親モードカードを生成
}
```

**CSS定義**:

```css
/* フラット表示コンテナ（フィルター時用） */
.mode-flat-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}
```

**メリット**:

1. **情報の重複排除**: 親と子で同じ統計値が表示される問題を解消
2. **UIの簡素化**: フィルター時はアコーディオン不要、直接カード表示
3. **操作性向上**: タップして展開する手間が不要
4. **子モード情報の維持**: 方向別の詳細情報は引き続き表示

---

## 5. 中級以上ユーザーへの価値提供

### 5.1 課金継続につながる価値

1. **精密な弱点特定**
   - 「3度が苦手」「12音階の位置3（開始音から半音3つ目）で必ずフラットになる」など具体的
   - 練習すべきポイントが明確になる

2. **成長の可視化**
   - 苦手だった音程/音が改善している実感
   - モチベーション維持につながる

3. **パーソナライズされた練習提案**
   - データに基づいた具体的なアドバイス
   - 効率的な上達をサポート

4. **上級者向けの深い分析**
   - 12音階の各音の傾向
   - 基音進行による癖の違い

### 5.2 無料版との差別化ポイント

| 機能 | 無料版 | 課金版 |
|------|--------|--------|
| 基本統計（平均精度等） | ○ | ○ |
| モード別フィルタリング | × | ○ |
| 音程間隔別分析 | × | ○ |
| 12音別分析 | × | ○ |
| エラーパターン分析 | × | ○ |
| パーソナライズ練習プラン | × | ○ |
| 詳細成長グラフ | × | ○ |
| 月間成長比較 | 簡易版 | 詳細版 |

---

## 6. 実装優先順位

### Phase 1: フィルター機能（必須）
1. モード切替UI実装
2. 方向切替UI実装
3. 12音階用の基音進行切替UI
4. データフィルタリングロジック

### Phase 2: モード別コンテンツ最適化
1. 音程間隔別精度（ランダム/連続用）
2. 12音別精度（12音階用）
3. 既存コンテンツの条件分岐

### Phase 3: 新規分析機能
1. 12音別シャープ/フラット傾向
2. 12音別成長グラフ
3. パーソナライズ練習プラン強化

---

## 7. データ構造の確認

### 7.1 セッションデータに含まれる情報

```javascript
// セッションレベル
{
  sessionId: number,
  lessonId: string,
  mode: 'random' | 'continuous' | '12tone',
  scaleDirection: 'ascending' | 'descending',      // 上行・下行（音階方向）
  chromaticDirection: 'ascending' | 'descending' | 'both' | 'random',  // 基音進行方向
  baseNote: string,           // 基音名（例: "C4"）
  baseFrequency: number,      // 基音周波数
  startTime: number,
  pitchErrors: [...],
  completed: boolean
}

// pitchErrorsの各要素
{
  step: number,               // 何番目の音か（0-indexed）
  expectedNote: string,       // 期待された音程名（例: "ド", "レ", "ミ"...）
  expectedFrequency: number,  // 期待された周波数
  detectedFrequency: number,  // 検出された周波数
  errorInCents: number|null,  // 誤差（セント）、無音時はnull
  clarity: number,            // 明瞭度（0-1）
  volume: number,             // 音量（0-1）
  timestamp: number,
  isValid: boolean            // 有効な測定かどうか
}
```

### 7.2 分析に必要な追加計算

- 12音別集計: `targetNote`から音名（C, C#, D...）を抽出
- 音程間隔別集計: `interval`でグルーピング
- シャープ/フラット判定: `errorInCents`の正負

---

## 8. 今後の検討事項

1. **データ量の閾値**
   - 各分析項目で「信頼性のある結果」を出すための最小データ数
   - データ不足時の表示方法

2. **期間フィルター**
   - 直近1週間/1ヶ月/全期間の切り替え
   - 成長記録での比較期間設定

3. **エクスポート機能**
   - 分析結果のPDF出力
   - データのCSVエクスポート

---

## 変更履歴

| バージョン | 日付 | 内容 |
|------------|------|------|
| 2.5.0 | 2025-11-28 | ModeController統一化（セクション3.5追加）、Tab4フィルター時フラット表示（セクション4.4.5追加） |
| 2.4.1 | 2025-11-28 | 全セクションでA/Bブロック表記を相対位置（ドレミ）に統一、マトリクス整合性修正 |
| 2.4.0 | 2025-11-28 | タイトル表示UI仕様追加（Lucideアイコン定義、🧠脳バランスアイコン） |
| 2.3.0 | 2025-11-28 | A/Bブロック分析を全モードで重要項目に統一、集計ロジック（ドレミ基準）を明確化 |
| 2.2.0 | 2025-11-28 | 4タブすべてで音域ブロック分析（A/Bブロック比較）を充実化 |
| 2.1.0 | 2025-11-28 | 脳内ピアノを意識した発声の重要性セクション追加 |
| 2.0.0 | 2025-11-28 | 初版作成（再設計） |
