# 音域不足時の自動拡張と警告システム仕様書

**バージョン**: 2.0.0
**作成日**: 2025-11-10
**最終更新日**: 2025-11-10
**対象システム**: 音域テスト・トレーニングモード基音選定

---

## 1. 概要

### 目的
トレーニングに必要な音数が音域測定結果で不足している場合、自動的に音域を拡張してトレーニング可能にする。同時に、ユーザーに音域外の音を歌う可能性を明示し、インフォームドコンセントを実現する。

### 背景
- **問題**: オクターブ相対音感トレーニングでは基音から1オクターブ上まで歌う必要がある
- **制約**: 音域が2.0オクターブ未満の場合、ランダム基音モードで必要な8音が確保できない
- **リスク**: 音域外の音を歌わされることで、ユーザーが不快な体験をする可能性

### 解決策
1. **自動拡張**: 音域上限側から不足分の音を追加
2. **明確な警告**: 音域テスト結果画面で黄色の警告アラート表示
3. **ユーザー選択**: 再測定するか、そのままトレーニング開始するかを選択可能

---

## 2. モード別必要音数

| モード | 必要音数 | 推奨音域 | 自動拡張対象 |
|--------|----------|----------|--------------|
| ランダム基音モード | 8音 | 2.0オクターブ以上 | ✅ Yes |
| 連続チャレンジモード | 12音 | 2.0オクターブ以上 | ✅ Yes |
| 12音階モード | 12音 | 2.0オクターブ以上 | ✅ Yes |

---

## 3. 音域判定基準

### 3.1 判定カテゴリ

| カテゴリ | 音域範囲 | アラート色 | トレーニング可否 | 自動拡張 |
|----------|----------|------------|------------------|----------|
| **測定成功** | 2.0オクターブ以上 | 緑（success-alert） | ✅ 可能 | 不要 |
| **音域不足警告** | 1.5～2.0オクターブ | 黄（warning-alert） | ⚠️ 可能（注意必要） | ✅ 実行 |
| **音域やや狭い** | 1.0～1.5オクターブ | 青（info-alert） | ⚠️ 可能（制限あり） | ✅ 実行 |
| **音域不足** | 1.0オクターブ未満 | 黄（warning-alert） | ❌ 不可 | - |
| **測定エラー** | 低音・高音逆転 | 黄（warning-alert） | ❌ 不可 | - |

### 3.2 判定ロジック（voice-range-test.js）

```javascript
if (octaves < 1.0) {
    isInsufficientRange = true;  // トレーニング不可
} else if (octaves < 1.5) {
    isNarrowRange = true;  // 制限あり許可
} else if (octaves < 2.0) {
    isNarrowRange = true;  // 音域不足警告（v3.3.0新規）
} else {
    // 測定成功（2.0オクターブ以上）
}
```

---

## 4. 自動拡張ロジック（trainingController.js）

### 4.1 実装箇所
- **関数**: `getAvailableNotes()`
- **実装日**: 2025-11-10
- **バージョン**: v3.0.0

### 4.2 拡張アルゴリズム

```javascript
// モード別必要音数チェック
let requiredNotes = 0;

if (currentMode === 'random') {
    requiredNotes = 8;  // ランダム基音モード
} else if (currentMode === 'continuous' || currentMode === '12tone') {
    requiredNotes = 12;  // 連続チャレンジ・12音階モード
}

// 音域不足の場合は自動拡張
if (requiredNotes > 0 && availableNotes.length < requiredNotes) {
    const neededNotes = requiredNotes - availableNotes.length;

    // 音域上限側から追加
    const higherNotes = allNotes.filter(note =>
        note.frequency > highestAvailableNote.frequency &&
        note.frequency <= highFreq  // 基音自体は音域内
    );

    const notesToAdd = higherNotes.slice(0, neededNotes);
    availableNotes = [...availableNotes, ...notesToAdd];
}
```

### 4.3 拡張例

**ケース: F-E（1.9オクターブ）→ 6音**

| 項目 | 内容 |
|------|------|
| 測定音域 | F2 (87.3Hz) - E4 (329.6Hz) |
| 理想的な基音 | G2, A2, B2, C3, D3, E3 = **6音** |
| 必要音数 | 8音（ランダム基音モード） |
| 不足数 | 2音 |
| **自動追加** | **F3, G3** |
| 最終基音リスト | G2, A2, B2, C3, D3, E3, **F3, G3** = 8音 |

**注意点**:
- F3を基音にすると、1オクターブ上のF4 (349.2Hz)が音域上限E4 (329.6Hz)を超える
- G3を基音にすると、1オクターブ上のG4 (392.0Hz)が音域上限E4 (329.6Hz)を超える
- → ユーザーに事前警告必須

---

## 5. 警告アラートUI仕様

### 5.1 表示条件
- 音域: **1.5～2.0オクターブ**
- 白鍵数: **8音未満**（ランダム基音モード用）

### 5.2 アラート内容

**アラート種類**: `warning-alert`（黄色）

```html
<div class="warning-alert">
    <i data-lucide="alert-triangle" style="color: #f59e0b; width: 32px; height: 32px;"></i>
    <div>
        <p class="alert-title">音域不足の警告 (1.9オクターブ)</p>
        <p>ランダム基音モードには2.0オクターブ（8音）が推奨されますが、現在の音域では不足しています。</p>
        <p class="alert-note">
            <strong>注意:</strong> トレーニング中、一部の基音では1オクターブ上の音が測定音域を超える場合があります。
            無理のない範囲で発声してください。再測定で音域を広げることをおすすめします。
        </p>
    </div>
</div>
```

### 5.3 ユーザーアクション

**2つの選択肢を提示**:
1. **「再測定」ボタン**: 音域テストをやり直す
2. **「トレーニング開始」ボタン**: 警告を了承してトレーニングを開始

---

## 6. ユーザーフロー

### 6.1 通常フロー（2.0オクターブ以上）

```
音域テスト完了
↓
緑の「測定成功」アラート
↓
「トレーニング開始」ボタンクリック
↓
トレーニング開始（8音自動確保）
```

### 6.2 音域不足フロー（1.5～2.0オクターブ）

```
音域テスト完了（例: F-E 1.9オクターブ）
↓
黄色の「音域不足の警告」アラート表示
  - 8音必要だが6音しかない旨
  - 音域を超える音を歌う可能性を明記
↓
ユーザー判断
  ├─ 再測定ボタン → 音域テストやり直し
  └─ トレーニング開始ボタン → 警告を了承
↓
トレーニング開始
  - 自動的にF3, G3を追加（8音確保）
  - F4, G4は音域外（ユーザー了承済み）
```

---

## 7. コンソールログ

### 7.1 音域テスト結果（voice-range-test.js）

```
⚠️ 音域やや不足検出: 1.90オクターブ（推奨: 2.0オクターブ以上）
   低音: 87.3Hz (F2) | 高音: 329.6Hz (E4)
   警告: ランダム基音モードで一部の音が音域外になる可能性があります
```

### 7.2 自動拡張実行（trainingController.js）

```
🎵 理想的な基音（基音+1オクターブが完全に音域内）: 6音
   範囲: G2 (98.0Hz) - E3 (164.8Hz)

⚠️ [ランダム基音モード] 音域不足: 6音 → 8音に拡張（2音追加）
   推奨: 2.0オクターブ以上の音域（現在: 1.90オクターブ）
   ※ テスト期間中のため、音域不足でも8音確保を優先

   候補: 2音 (F3, G3)

✅ 8音確保完了: G2, A2, B2, C3, D3, E3, F3, G3
   ※ 追加された2音は基音+1オクターブが音域上限を若干超えますが、
     オクターブ相対音感トレーニングとして8音使用を優先します

🎵 最終的な利用可能基音: 8音
```

---

## 8. モード別基音選定システム

### 8.1 ランダム基音モード（初級）

**特徴**:
- 8セッション固定
- 白鍵のみ使用
- 連続重複防止（同じ基音が連続しない）
- ゾーン分割・ゾーン順序ランダム化

**選定関数**: `selectAllBaseNotesForMode()`

```javascript
// ゾーン分割例（8音の場合）
Zone 1: G2, A2
Zone 2: B2, C3
Zone 3: D3, E3
Zone 4: F3, G3

// ゾーン順序ランダム化（Fisher-Yates）
例: [Zone3, Zone1, Zone4, Zone2] → D3, G2, F3, B2, E3, A2, G3, C3
```

### 8.2 連続チャレンジモード（中級）

**特徴**:
- 12セッション固定
- クロマチック12音使用
- 重複なし（全音を1回ずつ使用）
- 連続重複防止（v2.0.0追加）
- オクターブ跳躍（v3.0.0追加、音域2.5オクターブ以上）

**選定関数**: `selectContinuousMode()` → 自動分岐
- 音域 < 2.5オクターブ: `selectContinuousModeBasic()`
- 音域 ≥ 2.5オクターブ: `selectContinuousModeWithOctaveVariation()`

#### 8.2.1 基本モード（音域2.5オクターブ未満）

**選定アルゴリズム（v2.0.0）**:
```javascript
for (各セッション) {
    // 優先順位1: 未使用 + 前回と異なる音
    candidates = 未使用音.filter(note =>
        note !== lastNote
    );

    // 優先順位2: 未使用のみ（フォールバック）
    if (candidates.length === 0) {
        candidates = 未使用音;
    }

    // ランダム選択
    selectedNote = candidates[random()];
    lastNote = selectedNote;
}
```

**具体例**:
```
❌ v1.0.0: C3 → C3 → D3 → E3 ... (連続重複発生)
✅ v2.0.0: C3 → D3 → E3 → F3 ... (連続重複なし)
```

#### 8.2.2 オクターブ跳躍モード（音域2.5オクターブ以上）

**選定アルゴリズム（v3.0.0）**:
```javascript
// STEP 1: 音域内の全音符を音名でグループ化
noteNameGroups = {
    "C": [C2, C3, C4],
    "D": [D2, D3, D4],
    ...
};

// STEP 2: 12セッション分の音名を選定
for (各セッション) {
    // 優先順位1: 未使用音名 + 前回と異なる音名
    candidateNames = 未使用音名.filter(name =>
        name !== lastNoteName
    );

    // 優先順位2: 未使用音名のみ
    if (candidateNames.length === 0) {
        candidateNames = 未使用音名;
    }

    // 音名をランダム選択
    selectedName = candidateNames[random()];

    // その音名のオクターブ群からランダム選択
    selectedNote = noteNameGroups[selectedName][random()];

    usedNoteNames.add(selectedName);
    lastNoteName = selectedName;
}
```

**具体例**:
```
音域: C2 (65.4Hz) - A5 (880.0Hz) = 3.75オクターブ

❌ 基本モード: C3 → D3 → E3 → F3 ... (単調)
✅ オクターブ跳躍: C3 → E4 → G2 → A3 → D4 → F2 ... (跳躍あり)

音名使用: C, E, G, A, D, F (各音名1回のみ、オクターブは多様)
```

**音程間隔分析との整合性**:
- 音名は12種類のみ使用（重複なし）
- オクターブは異なるが、音名の関係性は一定
- 例: C→E（3度）はC3→E4でもC2→E3でも音程間隔は同じ
- 音程間隔別精度分析（2度±18¢、3度±24¢等）への影響を最小化

### 8.3 12音階モード（上級）

**特徴**:
- 12-24セッション（ユーザー選択）
- クロマチック12音順次使用
- 半音階順序（C→C#→D→...→B）
- オクターブ跳躍あり

**選定関数**: `select12ToneMode()`

---

## 9. 技術的詳細

### 9.1 関連ファイル

| ファイル | 役割 | 主要関数 | バージョン |
|----------|------|----------|------------|
| `voice-range-test.js` | 音域テスト・警告アラート表示 | `calculateVoiceRange()`, `displayVoiceRangeResults()` | v4.0.0 |
| `trainingController.js` | 基音自動拡張・基音選定 | `getAvailableNotes()`, `selectAllBaseNotesForMode()`, `selectContinuousMode()`, `selectContinuousModeBasic()`, `selectContinuousModeWithOctaveVariation()` | v3.0.0 (拡張+オクターブ跳躍), v2.0.0 (連続重複防止) |
| `base.css` | アラートスタイル | `.warning-alert`, `.alert-title`, `.alert-note` | - |

### 9.2 データフロー

```
【音域テスト】
voice-range-test.js
  ↓ localStorage保存
{
  results: {
    lowFreq: 87.3,
    highFreq: 329.6,
    octaves: 1.90,
    ...
  }
}

【トレーニング開始】
trainingController.js
  ↓ localStorage読み込み
voiceRangeData = localStorage.getItem('voiceRangeData')
  ↓ 基音計算
getAvailableNotes()
  - 理想的な基音: 6音（G2-E3）
  - 必要音数: 8音
  - 自動拡張: +2音（F3, G3）
  ↓ 基音選定
selectAllBaseNotesForMode()
  - 8音から8セッション分の基音を選定
  - 連続重複防止
  - ゾーン順序ランダム化
```

---

## 10. 既知の制約・注意事項

### 10.1 技術的制約
- **音域上限側からのみ拡張**: 低音側の拡張は実装していない（低音は出しづらいため）
- **基音自体は音域内**: 追加する基音自体は音域内に収める（1オクターブ上が音域外になる可能性）
- **白鍵のみ対応**: ランダム基音モードは白鍵のみを使用

### 10.2 ユーザー体験上の注意
- **無理な発声を強制しない**: 警告を明示し、ユーザーに選択肢を提供
- **再測定を推奨**: 音域不足の場合は再測定で音域を広げることを推奨
- **トレーニング中の対応**: 音域外の音が出た場合は無理せずスキップする旨を事前説明

### 10.3 将来の改善案
- **動的スキップ機能**: トレーニング中、音域外の音を自動スキップ
- **低音側拡張**: ユーザー設定で低音側からの拡張も可能に
- **モード別最適化**: 連続チャレンジ・12音階モードでの異なる拡張戦略

### 10.4 連続チャレンジモード拡張履歴

**Phase 1** (v2.0.0 - 2025-11-10):
- ✅ 連続重複防止実装
- ✅ 重複なし（全音1回ずつ使用）

**Phase 2** (v3.0.0 - 2025-11-10):
- ✅ オクターブ跳躍機能実装
- ✅ 音域2.5オクターブ以上で自動有効化
- ✅ 音程間隔分析との整合性を保持（音名は重複なし）

**Phase 2の設計判断**:
- 音名重複を避けることで、音程間隔別精度分析（2度±18¢、3度±24¢等）への影響を最小化
- C3→E4でも音程間隔は「3度」として正確に分析可能
- オクターブ跳躍により広い音域を活用し、単調さを解消

---

## 11. テストケース

### 11.1 正常系

| テストケース | 音域 | 白鍵数 | 期待される挙動 |
|--------------|------|--------|----------------|
| TC-01 | 2.5オクターブ | 10音以上 | 緑の測定成功アラート、自動拡張なし |
| TC-02 | 2.0オクターブ | 8音ちょうど | 緑の測定成功アラート、自動拡張なし |
| TC-03 | 1.9オクターブ | 6音 | 黄色の警告アラート、+2音自動拡張 |
| TC-04 | 1.5オクターブ | 4音 | 黄色の警告アラート、+4音自動拡張 |
| TC-05 | 1.2オクターブ | 3音 | 青の情報アラート、+5音自動拡張 |

### 11.2 異常系

| テストケース | 音域 | 期待される挙動 |
|--------------|------|----------------|
| TC-06 | 0.8オクターブ | 黄色の音域不足アラート、トレーニング不可 |
| TC-07 | 低音・高音逆転 | 黄色の測定エラーアラート、再測定必須 |
| TC-08 | 測定完全失敗 | 黄色の完全失敗アラート、再測定必須 |

### 11.3 境界値テスト

| テストケース | 音域 | 期待される挙動 |
|--------------|------|----------------|
| TC-09 | 0.99オクターブ | 音域不足（トレーニング不可） |
| TC-10 | 1.00オクターブ | 音域やや狭い（青アラート） |
| TC-11 | 1.49オクターブ | 音域やや狭い（青アラート） |
| TC-12 | 1.50オクターブ | 音域不足警告（黄アラート） |
| TC-13 | 1.99オクターブ | 音域不足警告（黄アラート） |
| TC-14 | 2.00オクターブ | 測定成功（緑アラート） |

---

## 12. 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 2.0.0 | 2025-11-10 | 連続チャレンジモードオクターブ跳躍機能追加（Phase 2実装完了）・セクション8.2.2追加 |
| 1.1.0 | 2025-11-10 | 連続チャレンジモード連続重複防止機能追加（Phase 1）・セクション8「モード別基音選定システム」追加 |
| 1.0.0 | 2025-11-10 | 初版作成（ランダム基音モード8音自動拡張・警告アラートUI） |

---

**関連仕様書**:
- `TRAINING_SPECIFICATION.md` - トレーニングモード仕様
- `EVALUATION_SYSTEM_SPECIFICATION.md` - 評価システム仕様
- `NAVIGATION_HANDLING_SPECIFICATION.md` - ナビゲーション処理仕様
