# 音域不足時の自動拡張と警告システム仕様書

**バージョン**: 3.2.0
**作成日**: 2025-11-10
**最終更新日**: 2025-11-18
**対象システム**: 音域テスト・トレーニングモード基音選定

---

## 1. 概要

### 目的
トレーニングに必要な音数が音域測定結果で不足している場合、自動的に音域を拡張してトレーニング可能にする。同時に、ユーザーに音域外の音を歌う可能性を明示し、インフォームドコンセントを実現する。

### 背景
- **問題**: オクターブ相対音感トレーニングでは基音から1オクターブ上まで歌う必要がある
- **制約**: 音域が2.0オクターブ未満の場合、ランダム基音モードで必要な8音が確保できない
- **リスク**: 音域外の音を歌わされることで、ユーザーが不快な体験をする可能性

### 解決策
1. **自動拡張**: 音域上限側から不足分の音を追加
2. **明確な警告**: 音域テスト結果画面で黄色の警告アラート表示
3. **ユーザー選択**: 再測定するか、そのままトレーニング開始するかを選択可能

---

## 2. モード別必要音数

| モード | 必要音数 | 推奨音域 | 自動拡張対象 | 重複許可フォールバック |
|--------|----------|----------|--------------|---------------------|
| ランダム基音モード | 8音（白鍵） | 2.0オクターブ以上 | ✅ Yes | ✅ Yes（優先順位5-6） |
| 連続チャレンジモード | 12音（全音） | 2.0オクターブ以上 | ✅ Yes | ✅ Yes（優先順位3） |
| 12音階モード | 12音（全音） | 2.0オクターブ以上 | ✅ Yes | ❌ No（重複なし） |

### 2.1 自動拡張と重複許可の関係

**ランダム基音モード**:
- **自動拡張**: 白鍵が6音 → 高音域から2音追加 → 8音確保
- **重複許可**: 8音全て使用済み（7セッション目以降）→ 前回と異なる音なら重複許可
- **実際の動作**: 音域内の6音を優先使用 → 重複許可で安全に8セッション完遂

**連続チャレンジモード**:
- **自動拡張**: 利用可能な音が12音未満 → 高音域から追加 → 12音確保
- **重複許可**: 12音全て使用済み（13セッション目以降）→ 優先順位3で重複許可
- **実際の動作**: オクターブ跳躍で多様性確保 → 必要に応じて重複許可

**12音階モード**:
- **自動拡張**: 利用可能な音が12音未満 → 高音域から追加 → 12音確保
- **重複許可**: ❌ なし（`selectSequentialMode`は順次選択のみ）
- **実際の動作**: 常に12音確保済み → 重複なしで12セッション実行

---

## 3. 音域判定基準

### 3.1 判定カテゴリ

| カテゴリ | 音域範囲 | アラート色 | トレーニング可否 | 自動拡張 |
|----------|----------|------------|------------------|----------|
| **測定成功** | 2.0オクターブ以上 | 緑（success-alert） | ✅ 可能 | 不要 |
| **音域不足警告** | 1.5～2.0オクターブ | 黄（warning-alert） | ⚠️ 可能（注意必要） | ✅ 実行 |
| **音域やや狭い** | 1.0～1.5オクターブ | 青（info-alert） | ⚠️ 可能（制限あり） | ✅ 実行 |
| **音域不足** | 1.0オクターブ未満 | 黄（warning-alert） | ❌ 不可 | - |
| **測定エラー** | 低音・高音逆転 | 黄（warning-alert） | ❌ 不可 | - |

### 3.2 判定ロジック（voice-range-test.js）

```javascript
if (octaves < 1.0) {
    isInsufficientRange = true;  // トレーニング不可
} else if (octaves < 1.5) {
    isNarrowRange = true;  // 制限あり許可
} else if (octaves < 2.0) {
    isNarrowRange = true;  // 音域不足警告（v3.3.0新規）
} else {
    // 測定成功（2.0オクターブ以上）
}
```

---

## 4. 自動拡張ロジック（trainingController.js）

### 4.1 実装箇所
- **関数**: `getAvailableNotes()`
- **実装日**: 2025-11-10
- **バージョン**: v3.0.0

### 4.2 拡張アルゴリズム（v3.2.0更新: 方向別拡張対応）

```javascript
// モード別必要音数チェック
let requiredNotes = 0;

if (currentMode === 'random') {
    requiredNotes = 8;  // ランダム基音モード
} else if (currentMode === 'continuous' || currentMode === '12tone') {
    requiredNotes = 12;  // 連続チャレンジ・12音階モード
}

// 音域不足の場合は自動拡張
if (requiredNotes > 0 && availableNotes.length < requiredNotes) {
    const neededNotes = requiredNotes - availableNotes.length;
    let notesToAdd = [];

    if (currentScaleDirection === 'descending') {
        // 【下行モード】低音側に拡張（v3.2.0新規）
        const lowestAvailableNote = availableNotes[0];

        // 音域下限側から追加（10%余裕を持たせる）
        const lowerNotes = allNotes.filter(note =>
            note.frequency < lowestAvailableNote.frequency &&
            note.frequency / 2 >= lowFreq * 0.9  // 基音-1オクターブが音域下限の90%以上
        );

        // 必要な分だけ追加（低い音から順に）
        notesToAdd = lowerNotes.slice(-neededNotes);

        // 低音側に追加するため、配列の先頭に挿入
        availableNotes = [...notesToAdd, ...availableNotes];
    } else {
        // 【上行モード】高音側に拡張（従来ロジック）
        const highestAvailableNote = availableNotes[availableNotes.length - 1];

        // 音域上限側から追加（10%余裕を持たせる）
        const higherNotes = allNotes.filter(note =>
            note.frequency > highestAvailableNote.frequency &&
            note.frequency * 2 <= highFreq * 1.1  // 基音+1オクターブが音域上限の110%以下
        );

        // 必要な分だけ追加
        notesToAdd = higherNotes.slice(0, neededNotes);
        availableNotes = [...availableNotes, ...notesToAdd];
    }
}
```

### 4.3 拡張例

#### 4.3.1 上行モード拡張例

**ケース: F-E（1.9オクターブ）→ 6音**

| 項目 | 内容 |
|------|------|
| 測定音域 | F2 (87.3Hz) - E4 (329.6Hz) |
| 理想的な基音 | G2, A2, B2, C3, D3, E3 = **6音** |
| 必要音数 | 8音（ランダム基音モード） |
| 不足数 | 2音 |
| **自動追加** | **F3, G3**（高音側に拡張） |
| 最終基音リスト | G2, A2, B2, C3, D3, E3, **F3, G3** = 8音 |

**注意点**:
- F3を基音にすると、1オクターブ上のF4 (349.2Hz)が音域上限E4 (329.6Hz)を超える
- G3を基音にすると、1オクターブ上のG4 (392.0Hz)が音域上限E4 (329.6Hz)を超える
- → ユーザーに事前警告必須

#### 4.3.2 下行モード拡張例（v3.2.0新規）

**ケース: G2-F4（1.92オクターブ、12音階下行モード）→ 11音**

| 項目 | 内容 |
|------|------|
| 測定音域 | 94.3Hz - 357.4Hz (1.92オクターブ) |
| 理想的な基音 | G3 (196.0Hz) - F4 (349.2Hz) = **11音** |
| 必要音数 | 12音（12音階モード） |
| 不足数 | 1音 |
| **拡張条件** | `note.frequency / 2 >= 94.3 * 0.9` (84.87Hz以上) |
| **候補音** | F#3 (185.0Hz) → 185.0 / 2 = 92.5Hz ✅ |
|  | F3 (174.6Hz) → 174.6 / 2 = 87.3Hz ✅ |
| **自動追加** | **F#3**（低音側に拡張、1音のみ必要） |
| 最終基音リスト | **F#3**, G3, G#3, A3, A#3, B3, C4, C#4, D4, D#4, E4, F4 = 12音 |

**注意点**:
- F#3を基音にすると、1オクターブ下のF#2 (92.5Hz)が音域下限94.3Hzを若干下回る
- 10%余裕により拡張可能（92.5Hz ≥ 84.87Hz）
- → ユーザーに事前警告必須

#### 4.3.3 10%余裕の設計理由（v3.2.0）

**問題**:
- 厳密な条件（`note.frequency / 2 >= lowFreq`）では拡張候補が見つからないケースが頻発
- 例: 188.6Hz ～ 196.0Hzの範囲（わずか7.4Hz）に半音階の音が存在しない

**解決策**:
- 上行モード: `note.frequency * 2 <= highFreq * 1.1` （音域上限の110%まで許容）
- 下行モード: `note.frequency / 2 >= lowFreq * 0.9` （音域下限の90%まで許容）

**効果**:
- 拡張候補範囲が約3-4倍に拡大（7.4Hz → 26.26Hz）
- 音域不足時でも確実に必要な音数を確保可能
- ユーザー体験の向上（音域外の音でも発声可能な範囲内）

---

## 5. 警告アラートUI仕様

### 5.1 表示条件
- 音域: **1.5～2.0オクターブ**
- 対象: **全トレーニングモード共通**

### 5.2 アラート内容

**アラート種類**: `warning-alert`（黄色）

```html
<div class="warning-alert">
    <i data-lucide="alert-triangle" style="color: #f59e0b; width: 32px; height: 32px;"></i>
    <div>
        <p class="alert-title">音域不足の警告 (1.9オクターブ)</p>
        <p>すべてのトレーニングモードには2.0オクターブが推奨されますが、現在の音域では不足しています。</p>
        <p class="alert-note">
            <strong>注意:</strong> トレーニング中、一部の基音では1オクターブ上の音が測定音域を超える場合があります。
            無理のない範囲で発声してください。再測定で音域を広げることをおすすめします。
        </p>
    </div>
</div>
```

### 5.3 ユーザーアクション

**2つの選択肢を提示**:
1. **「再測定」ボタン**: 音域テストをやり直す
2. **「トレーニング開始」ボタン**: 警告を了承してトレーニングを開始

---

## 6. ユーザーフロー

### 6.1 通常フロー（2.0オクターブ以上）

```
音域テスト完了
↓
緑の「測定成功」アラート
↓
「トレーニング開始」ボタンクリック
↓
トレーニング開始（8音自動確保）
```

### 6.2 音域不足フロー（1.5～2.0オクターブ）

```
音域テスト完了（例: F-E 1.9オクターブ）
↓
黄色の「音域不足の警告」アラート表示
  - 8音必要だが6音しかない旨
  - 音域を超える音を歌う可能性を明記
↓
ユーザー判断
  ├─ 再測定ボタン → 音域テストやり直し
  └─ トレーニング開始ボタン → 警告を了承
↓
トレーニング開始
  - 自動的にF3, G3を追加（8音確保）
  - F4, G4は音域外（ユーザー了承済み）
```

---

## 7. コンソールログ

### 7.1 音域テスト結果（voice-range-test.js）

```
⚠️ 音域やや不足検出: 1.90オクターブ（推奨: 2.0オクターブ以上）
   低音: 87.3Hz (F2) | 高音: 329.6Hz (E4)
   警告: すべてのトレーニングモードで一部の音が音域外になる可能性があります
```

### 7.2 自動拡張実行（trainingController.js）

```
🎵 理想的な基音（基音+1オクターブが完全に音域内）: 6音
   範囲: G2 (98.0Hz) - E3 (164.8Hz)

⚠️ [ランダム基音モード] 音域不足: 6音 → 8音に拡張（2音追加）
   推奨: 2.0オクターブ以上の音域（現在: 1.90オクターブ）
   ※ テスト期間中のため、音域不足でも8音確保を優先

   候補: 2音 (F3, G3)

✅ 8音確保完了: G2, A2, B2, C3, D3, E3, F3, G3
   ※ 追加された2音は基音+1オクターブが音域上限を若干超えますが、
     オクターブ相対音感トレーニングとして8音使用を優先します

🎵 最終的な利用可能基音: 8音
```

---

## 8. モード別基音選定システム

### 8.1 ランダム基音モード（初級）

**特徴**:
- 8セッション固定
- 白鍵のみ使用
- 連続重複防止（同じ基音が連続しない）
- ゾーン分割・ゾーン順序ランダム化
- **6段階フォールバック**（v4.0.2実装）

**選定関数**: `selectRandomMode()`

#### 8.1.1 基本アルゴリズム

```javascript
// ゾーン分割（2.0オクターブ以上の場合は4ゾーン）
const numZones = octaves >= 2.0 ? 4 : octaves >= 1.5 ? 3 : 1;
const sessionsPerZone = maxSessions / numZones;

// ゾーン順序ランダム化（Fisher-Yates）
const zoneOrder = shuffleArray([0, 1, 2, 3]);
// 例: [2, 0, 3, 1] → Zone3 → Zone1 → Zone4 → Zone2

for (let session = 0; session < 8; session++) {
    const zoneIndex = zoneOrder[Math.floor(session / sessionsPerZone) % numZones];
    const zoneNotes = zones[zoneIndex];

    // 6段階フォールバック（以下参照）
    ...
}
```

#### 8.1.2 6段階フォールバック優先順位（v4.0.2）

**目的**: 音域不足・ゾーン制約下でも必ず8セッション完遂

```javascript
// 優先順位1: ゾーン内で未使用 + 前回と異なる音
candidates = zoneNotes.filter(note =>
    !selectedNotes.includes(note) && note !== lastNote
);

// 優先順位2: ゾーン内で未使用（前回と同じでも許容）
if (candidates.length === 0) {
    candidates = zoneNotes.filter(note =>
        !selectedNotes.includes(note)
    );
}

// 優先順位3: 全体から未使用 + 前回と異なる音
if (candidates.length === 0) {
    candidates = whiteKeys.filter(note =>
        !selectedNotes.includes(note) && note !== lastNote
    );
}

// 優先順位4: 全体から未使用（フォールバック）
if (candidates.length === 0) {
    candidates = whiteKeys.filter(note =>
        !selectedNotes.includes(note)
    );
}

// 優先順位5: 全白鍵使用済み → 前回と異なる音なら重複許可 ✅
if (candidates.length === 0) {
    candidates = whiteKeys.filter(note =>
        note !== lastNote
    );
    console.warn(`⚠️ 全白鍵使用済み - 重複許可モードで選択`);
}

// 優先順位6: 最後のフォールバック（前回と同じでも許可）
if (candidates.length === 0) {
    candidates = whiteKeys;
    console.error(`❌ 候補なし - 完全ランダム選択`);
}
```

#### 8.1.3 実際の動作例（1.73オクターブ、白鍵6音の場合）

**getAvailableNotes()**: 6音 → 8音に補正（F3, G3追加）

**selectRandomMode()**:

| セッション | ゾーン | 利用可能な音 | 優先順位 | 選択音 | 重複？ |
|-----------|-------|------------|---------|--------|--------|
| 1 | Zone 0 | G2, A2 | 優先順位1 | G2 | ❌ |
| 2 | Zone 0 | A2（G2使用済み） | 優先順位1 | A2 | ❌ |
| 3 | Zone 1 | B2, C3 | 優先順位1 | B2 | ❌ |
| 4 | Zone 1 | C3（B2使用済み） | 優先順位1 | C3 | ❌ |
| 5 | Zone 2 | D3, E3 | 優先順位1 | D3 | ❌ |
| 6 | Zone 2 | E3（D3使用済み） | 優先順位1 | E3 | ❌ |
| 7 | Zone 3 | F3, G3（補正追加） | 優先順位1 | F3 | ❌ |
| 8 | Zone 3 | G3（F3使用済み） | 優先順位1 | G3 | ❌ |

**結果**:
- セッション1-6: ✅ 音域内の安全な6音使用
- セッション7-8: ⚠️ 補正で追加された2音使用（1オクターブ上が音域外）
- 重複: ❌ なし（8音全て異なる）

**重複許可フォールバックが発動するケース**:
- ゾーンに白鍵が1音しかない場合（そのゾーンで2セッション → 同じ音を2回）
- 7セッション目で7音全て使用済み、かつ残り1音が前回と同じ場合

### 8.2 連続チャレンジモード（中級）

**特徴**:
- 12セッション固定
- クロマチック12音使用
- 重複なし（全音を1回ずつ使用）
- 連続重複防止（v2.0.0追加）
- オクターブ跳躍（v3.0.0追加、音域2.5オクターブ以上）

**選定関数**: `selectContinuousMode()` → 自動分岐
- 音域 < 2.5オクターブ: `selectContinuousModeBasic()`
- 音域 ≥ 2.5オクターブ: `selectContinuousModeWithOctaveVariation()`

#### 8.2.1 基本モード（音域2.5オクターブ未満）

**選定アルゴリズム（v2.0.0）**:
```javascript
for (各セッション) {
    // 優先順位1: 未使用 + 前回と異なる音
    candidates = 未使用音.filter(note =>
        note !== lastNote
    );

    // 優先順位2: 未使用のみ（フォールバック）
    if (candidates.length === 0) {
        candidates = 未使用音;
    }

    // ランダム選択
    selectedNote = candidates[random()];
    lastNote = selectedNote;
}
```

**具体例**:
```
❌ v1.0.0: C3 → C3 → D3 → E3 ... (連続重複発生)
✅ v2.0.0: C3 → D3 → E3 → F3 ... (連続重複なし)
```

#### 8.2.2 オクターブ跳躍モード（音域2.5オクターブ以上）

**選定アルゴリズム（v3.0.0）**:
```javascript
// STEP 1: 音域内の全音符を音名でグループ化
noteNameGroups = {
    "C": [C2, C3, C4],
    "D": [D2, D3, D4],
    ...
};

// STEP 2: 12セッション分の音名を選定
for (各セッション) {
    // 優先順位1: 未使用音名 + 前回と異なる音名
    candidateNames = 未使用音名.filter(name =>
        name !== lastNoteName
    );

    // 優先順位2: 未使用音名のみ
    if (candidateNames.length === 0) {
        candidateNames = 未使用音名;
    }

    // 音名をランダム選択
    selectedName = candidateNames[random()];

    // その音名のオクターブ群からランダム選択
    selectedNote = noteNameGroups[selectedName][random()];

    usedNoteNames.add(selectedName);
    lastNoteName = selectedName;
}
```

**具体例**:
```
音域: C2 (65.4Hz) - A5 (880.0Hz) = 3.75オクターブ

❌ 基本モード: C3 → D3 → E3 → F3 ... (単調)
✅ オクターブ跳躍: C3 → E4 → G2 → A3 → D4 → F2 ... (跳躍あり)

音名使用: C, E, G, A, D, F (各音名1回のみ、オクターブは多様)
```

**音程間隔分析との整合性**:
- 音名は12種類のみ使用（重複なし）
- オクターブは異なるが、音名の関係性は一定
- 例: C→E（3度）はC3→E4でもC2→E3でも音程間隔は同じ
- 音程間隔別精度分析（2度±18¢、3度±24¢等）への影響を最小化

### 8.3 12音階モード（上級）

**特徴**:
- 12-24セッション（ユーザー選択）
- クロマチック12音順次使用
- 半音階順序（C→C#→D→...→B）
- オクターブ跳躍あり

**選定関数**: `select12ToneMode()`

---

## 9. 技術的詳細

### 9.1 関連ファイル

| ファイル | 役割 | 主要関数 | バージョン |
|----------|------|----------|------------|
| `voice-range-test.js` | 音域テスト・警告アラート表示 | `calculateVoiceRange()`, `displayVoiceRangeResults()` | v4.0.0 |
| `trainingController.js` | 基音自動拡張・基音選定 | `getAvailableNotes()`, `selectAllBaseNotesForMode()`, `selectContinuousMode()`, `selectContinuousModeBasic()`, `selectContinuousModeWithOctaveVariation()` | v3.0.0 (拡張+オクターブ跳躍), v2.0.0 (連続重複防止) |
| `base.css` | アラートスタイル | `.warning-alert`, `.alert-title`, `.alert-note` | - |

### 9.2 データフロー

```
【音域テスト】
voice-range-test.js
  ↓ localStorage保存
{
  results: {
    lowFreq: 87.3,
    highFreq: 329.6,
    octaves: 1.90,
    ...
  }
}

【トレーニング開始】
trainingController.js
  ↓ localStorage読み込み
voiceRangeData = localStorage.getItem('voiceRangeData')
  ↓ 基音計算
getAvailableNotes()
  - 理想的な基音: 6音（G2-E3）
  - 必要音数: 8音
  - 自動拡張: +2音（F3, G3）
  ↓ 基音選定
selectAllBaseNotesForMode()
  - 8音から8セッション分の基音を選定
  - 連続重複防止
  - ゾーン順序ランダム化
```

---

## 10. 既知の制約・注意事項

### 10.1 技術的制約

#### v3.2.0更新: 方向別拡張対応
- **上行モード**: 音域上限側に拡張（基音+1オクターブが音域外になる可能性）
- **下行モード**: 音域下限側に拡張（基音-1オクターブが音域外になる可能性）
- **10%余裕**: 両方向とも10%の余裕を持たせて拡張（確実な音数確保のため）
- **基音順序維持**: 下行モード拡張時は配列先頭に挿入して音程順序を保持
- **白鍵のみ対応**: ランダム基音モードは白鍵のみを使用（連続・12音階は全音対応）

### 10.2 ユーザー体験上の注意
- **無理な発声を強制しない**: 警告を明示し、ユーザーに選択肢を提供
- **再測定を推奨**: 音域不足の場合は再測定で音域を広げることを推奨
- **トレーニング中の対応**: 音域外の音が出た場合は無理せずスキップする旨を事前説明

### 10.3 将来の改善案
- **動的スキップ機能**: トレーニング中、音域外の音を自動スキップ
- **低音側拡張**: ユーザー設定で低音側からの拡張も可能に
- **モード別最適化**: 連続チャレンジ・12音階モードでの異なる拡張戦略

### 10.4 連続チャレンジモード拡張履歴

**Phase 1** (v2.0.0 - 2025-11-10):
- ✅ 連続重複防止実装
- ✅ 重複なし（全音1回ずつ使用）

**Phase 2** (v3.0.0 - 2025-11-10):
- ✅ オクターブ跳躍機能実装
- ✅ 音域2.5オクターブ以上で自動有効化
- ✅ 音程間隔分析との整合性を保持（音名は重複なし）

**Phase 2の設計判断**:
- 音名重複を避けることで、音程間隔別精度分析（2度±18¢、3度±24¢等）への影響を最小化
- C3→E4でも音程間隔は「3度」として正確に分析可能
- オクターブ跳躍により広い音域を活用し、単調さを解消

---

## 11. テストケース

### 11.1 正常系

| テストケース | 音域 | 白鍵数 | 期待される挙動 |
|--------------|------|--------|----------------|
| TC-01 | 2.5オクターブ | 10音以上 | 緑の測定成功アラート、自動拡張なし |
| TC-02 | 2.0オクターブ | 8音ちょうど | 緑の測定成功アラート、自動拡張なし |
| TC-03 | 1.9オクターブ | 6音 | 黄色の警告アラート、+2音自動拡張 |
| TC-04 | 1.5オクターブ | 4音 | 黄色の警告アラート、+4音自動拡張 |
| TC-05 | 1.2オクターブ | 3音 | 青の情報アラート、+5音自動拡張 |

### 11.2 異常系

| テストケース | 音域 | 期待される挙動 |
|--------------|------|----------------|
| TC-06 | 0.8オクターブ | 黄色の音域不足アラート、トレーニング不可 |
| TC-07 | 低音・高音逆転 | 黄色の測定エラーアラート、再測定必須 |
| TC-08 | 測定完全失敗 | 黄色の完全失敗アラート、再測定必須 |

### 11.3 境界値テスト

| テストケース | 音域 | 期待される挙動 |
|--------------|------|----------------|
| TC-09 | 0.99オクターブ | 音域不足（トレーニング不可） |
| TC-10 | 1.00オクターブ | 音域やや狭い（青アラート） |
| TC-11 | 1.49オクターブ | 音域やや狭い（青アラート） |
| TC-12 | 1.50オクターブ | 音域不足警告（黄アラート） |
| TC-13 | 1.99オクターブ | 音域不足警告（黄アラート） |
| TC-14 | 2.00オクターブ | 測定成功（緑アラート） |

---

## 12. 12音階モード専用トレーニング開始時音域警告システム（v3.0.0新規）

### 12.1 概要

**目的**: 12音階モード開始時に音域不足を検出し、ユーザーに事前確認を求める

**実装日**: 2025-11-14
**実装場所**: `preparation-pitchpro-cycle.js`
**対象モード**: 12音階モードのみ

### 12.2 設計思想

#### 問題背景
- 音域テストでは全モード共通で2.0オクターブ推奨
- ランダム基音・連続チャレンジで1.5オクターブの音域を保存
- その後12音階モードに切り替えると、自動拡張で強制的にトレーニング開始
- 本来は音域テストで「2.0オクターブ未満」として再測定を促すべき

#### 解決方針
1. **厳格なチェックは避ける**: 2オクターブ未満でも完全禁止はしない（難易度は高いが不可能ではない）
2. **ユーザーの自主性を尊重**: 音域不足を警告し、続行するか再測定するかをユーザーに委ねる
3. **設定による非表示**: 「今後この警告を表示しない」で経験者は警告スキップ可能

### 12.3 警告ダイアログ仕様

#### 表示条件
- **モード**: 12音階モードのみ
- **音域**: 2.0オクターブ未満
- **タイミング**: トレーニング開始ボタン押下時（準備ページ）
- **スキップ設定**: localStorage `skip12ToneVoiceRangeWarning` が `true` の場合は非表示

#### ダイアログUI

```html
<div class="modal-overlay">
    <div class="glass-card">
        <!-- ヘッダー -->
        <div style="display: flex; align-items: center; gap: 12px;">
            <i data-lucide="alert-triangle" style="color: #fbbf24;"></i>
            <h3>音域が不足しています</h3>
        </div>

        <!-- 音域情報 -->
        <div class="warning-alert">
            現在の音域: 1.73オクターブ
            推奨音域: 2.0オクターブ以上
        </div>

        <!-- 警告メッセージ -->
        <p>一部の音が発声困難な可能性がありますが、12音階モードでトレーニングを開始しますか？</p>

        <!-- 設定チェックボックス -->
        <label>
            <input type="checkbox" id="skip-warning-checkbox">
            今後この警告を表示しない
        </label>

        <!-- アクションボタン -->
        <button id="retest-voice-range-btn">音域テストをやり直す</button>
        <button id="continue-anyway-btn">このまま開始</button>
    </div>
</div>
```

### 12.4 ユーザーアクション

#### ボタン1: 「音域テストをやり直す」
- **動作**: ダイアログを閉じ、準備ページの音域テストセクションへスクロール
- **設定保存**: チェックボックスがONの場合、localStorage に保存
- **結果**: トレーニング開始を中断

#### ボタン2: 「このまま開始」
- **動作**: ダイアログを閉じ、トレーニングを開始
- **設定保存**: チェックボックスがONの場合、localStorage に保存
- **結果**: 自動拡張ロジックで12音確保し、トレーニング続行

### 12.5 実装関数

#### `check12ToneVoiceRange(mode)`
- **目的**: 12音階モード専用の音域チェック
- **引数**: トレーニングモード
- **戻り値**: `true` = 続行, `false` = 中断
- **処理フロー**:
  1. 12音階モード以外はチェックスキップ
  2. localStorage `skip12ToneVoiceRangeWarning` 確認
  3. 音域データ取得
  4. オクターブ数計算
  5. 2.0オクターブ以上 → OK
  6. 2.0オクターブ未満 → ダイアログ表示

#### `showVoiceRangeWarningDialog(octaveRange)`
- **目的**: 音域不足警告ダイアログを表示
- **引数**: 現在のオクターブ数
- **戻り値**: Promise<boolean>
- **処理フロー**:
  1. ダイアログHTML動的生成
  2. DOM追加、Lucideアイコン初期化
  3. ボタンイベント設定
  4. Promise で結果を返す

### 12.6 localStorage設定

| キー | 値 | 説明 |
|------|----|----|
| `skip12ToneVoiceRangeWarning` | `"true"` / なし | 警告スキップフラグ |

**設定タイミング**:
- ユーザーが「今後この警告を表示しない」をチェック
- どちらのボタンを押しても保存される

### 12.7 統合箇所

#### preparation-pitchpro-cycle.js

**2箇所のトレーニング開始ボタン**:
1. `skip-range-test-btn` (音域設定済み表示画面)
2. `complete-range-test-btn` (音域テスト完了後)

```javascript
// トレーニング開始ボタン押下時
const mode = redirectInfo?.mode || 'random';

// 12音階モード用音域チェック
const canContinue = await check12ToneVoiceRange(mode);
if (!canContinue) {
    return; // トレーニング開始を中断
}

// 続行処理...
```

### 12.8 trainingController.jsの変更

#### 修正前（v2.x）
```javascript
if (actualCount < 12) {
    alert(`12音階モードには最低12音の音域が必要です。`);
    window.location.hash = 'home';
    throw new Error('12音階モード: 音域不足');
}
```

#### 修正後（v3.0.0 - 2025-11-14）
```javascript
// getAvailableNotes()で既に12音確保されているはず（音域不足時は高音域から自動追加）
if (actualCount < 12) {
    console.error(`❌ [12音階モード] 致命的エラー: 12音確保に失敗（実際: ${actualCount}音）`);
    console.error(`   → getAvailableNotes()の自動拡張ロジックを確認してください`);
} else {
    console.log(`✅ [12音階モード] クロマチック12音確保完了: ${chromaticNotes.map(n => n.note).join(' → ')}`);
}
```

**重要な仕様理解**:
- `getAvailableNotes()`関数が音域不足を検出すると、**高音域から自動的に不足分を追加**
- 例: 音域1.73オクターブで9音のみ → 高音域から3音追加 → 合計12音確保
- したがって`selectSequentialMode()`には**常に12音の配列**が渡される
- `actualCount < 12`は本来発生しないため、エラーログに変更

**セッション数**:
- 片方向モード: **常に12セッション**（音域不足でも12音×1回）
- 両方向モード: **常に24セッション**（音域不足でも12音×2回）
- 音階の重複はなし、高音域追加により必ず12音確保

**変更理由**:
1. preparationページで事前確認済み（ユーザーが「このまま開始」を選択）
2. `getAvailableNotes()`で自動拡張により12音確保済み
3. `actualCount < 12`は実装エラーを示すため、エラーログに変更

### 12.9 ユーザーフロー

#### パターンA: 2.0オクターブ以上
```
準備ページ → トレーニング開始ボタン
    ↓
音域チェック（2.0オクターブ以上）
    ↓
トレーニング開始（警告なし）
```

#### パターンB: 2.0オクターブ未満（初回）
```
準備ページ → トレーニング開始ボタン
    ↓
音域チェック（1.73オクターブ）
    ↓
警告ダイアログ表示
    ├→ 「音域テストをやり直す」
    │   └→ 音域テストセクションへスクロール
    │
    └→ 「このまま開始」
        ├→ チェックON → localStorage保存
        └→ トレーニング開始（自動拡張で12音確保）
```

#### パターンC: 2.0オクターブ未満（警告スキップ設定済み）
```
準備ページ → トレーニング開始ボタン
    ↓
音域チェック（localStorage確認: skip=true）
    ↓
トレーニング開始（警告スキップ）
```

### 12.10 設計上の重要な決定

#### なぜ厳格な禁止にしなかったか
- **柔軟性**: 2.0オクターブ未満でも12音階は可能（難易度は高い）
- **ユーザー尊重**: 経験者は警告を煩わしく感じる可能性
- **将来拡張**: 苦手練習モードでカスタム設定可能にする予定

#### なぜ準備ページで実装したか
- **タイミング**: ユーザーが「開始」を明示的に選択した直後
- **自然な体験**: トレーニングページに遷移してからエラーで戻るより自然
- **音域データ**: 準備ページで既に読み込み済み

#### なぜ12音階モードのみか
- **難易度**: 12音階は12音全てを使用する上級モード
- **代替手段**: ランダム基音・連続チャレンジは8音でも実施可能
- **将来対応**: 6音階モードは苦手練習モードで対応予定

---

## 13. 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 3.2.0 | 2025-11-18 | **下行モード対応**: Section 4.2更新（方向別拡張ロジック実装）、Section 4.3.2追加（下行モード拡張例）、Section 4.3.3追加（10%余裕の設計理由）、Section 10.1更新（両方向対応を明記）。12音階下行モードで音域不足時に12音確保できずクラッシュする問題を解決（trainingController.js v4.0.21-v4.0.22）|
| 3.1.0 | 2025-11-14 | Section 2.1追加: 自動拡張と重複許可の関係を詳細説明。Section 8.1更新: ランダム基音モードの6段階フォールバック優先順位と実際の動作例を追加 |
| 3.0.2 | 2025-11-14 | 警告メッセージを「全モード共通で2.0オクターブ推奨」に統一（Section 5.1, 5.2, 7.1更新） |
| 3.0.1 | 2025-11-14 | セクション12.8更新: selectSequentialMode()のセッション数仕様明確化（常に12/24セッション、音域不足でも音階重複なし） |
| 3.0.0 | 2025-11-14 | 12音階モード専用トレーニング開始時音域警告システム追加（セクション12追加） |
| 2.0.0 | 2025-11-10 | 連続チャレンジモードオクターブ跳躍機能追加（Phase 2実装完了）・セクション8.2.2追加 |
| 1.1.0 | 2025-11-10 | 連続チャレンジモード連続重複防止機能追加（Phase 1）・セクション8「モード別基音選定システム」追加 |
| 1.0.0 | 2025-11-10 | 初版作成（ランダム基音モード8音自動拡張・警告アラートUI） |

---

**関連仕様書**:
- `TRAINING_SPECIFICATION.md` - トレーニングモード仕様
- `EVALUATION_SYSTEM_SPECIFICATION.md` - 評価システム仕様
- `NAVIGATION_HANDLING_SPECIFICATION.md` - ナビゲーション処理仕様
