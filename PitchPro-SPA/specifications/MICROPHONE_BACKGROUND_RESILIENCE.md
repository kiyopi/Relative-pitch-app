# ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰è€æ€§ä»•æ§˜æ›¸

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0.0
**ä½œæˆæ—¥**: 2025-11-09
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-09
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†

---

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [å•é¡Œã®ç™ºè¦‹ã¨åˆ†æ](#å•é¡Œã®ç™ºè¦‹ã¨åˆ†æ)
3. [è§£æ±ºç­–ã®è¨­è¨ˆ](#è§£æ±ºç­–ã®è¨­è¨ˆ)
4. [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)
5. [å‹•ä½œãƒ•ãƒ­ãƒ¼](#å‹•ä½œãƒ•ãƒ­ãƒ¼)
6. [ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª](#ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª)
7. [ä»Šå¾Œã®æ‹¡å¼µ](#ä»Šå¾Œã®æ‹¡å¼µ)

---

## æ¦‚è¦

### ç›®çš„
PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®MicrophoneLifecycleManagerãŒã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰/ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§»æ™‚ã«ç™ºç”Ÿã™ã‚‹ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³æ¨©é™ã‚¨ãƒ©ãƒ¼ã‹ã‚‰è‡ªå‹•çš„ã«å¾©æ—§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

### å¯¾è±¡ãƒ•ã‚§ãƒ¼ã‚º
- **æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆéŸ³åŸŸãƒ†ã‚¹ãƒˆï¼‰**: `/PitchPro-SPA/pages/preparation.html`
- **ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚º**: `/PitchPro-SPA/pages/training.html`

### ã‚¹ã‚³ãƒ¼ãƒ—
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»å‹•æ™‚ã®ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ä¸€æ™‚åœæ­¢
- ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚ã®è‡ªå‹•å†é–‹
- æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”ã‚¨ãƒ©ãƒ¼ã‹ã‚‰ã®è‡ªå‹•å¾©æ—§
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€æ˜ãªå¾©æ—§ãƒ—ãƒ­ã‚»ã‚¹

---

## å•é¡Œã®ç™ºè¦‹ã¨åˆ†æ

### å ±å‘Šã•ã‚ŒãŸå•é¡Œ

#### å•é¡Œ1: éŸ³åŸŸãƒ†ã‚¹ãƒˆ - ãƒã‚¤ã‚¯æ¤œå‡ºå¤±æ•—
**ç—‡çŠ¶**:
```
1. éŸ³åŸŸãƒ†ã‚¹ãƒˆã§ãƒã‚¤ã‚¯è¨±å¯ã‚’å‡ºã™
2. ã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•
3. PitchProã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¦ãƒã‚¤ã‚¯è¨±å¯ã‚’å†å®Ÿè¡Œ
5. éŸ³å£°ã‚’å‡ºã—ç¶šã‘ã¦ã‚‚ãƒã‚¤ã‚¯æ¤œå‡ºãŒã§ããªã„
```

#### å•é¡Œ2: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° - ãƒã‚¤ã‚¯è¨±å¯å†è¦æ±‚
**ç—‡çŠ¶**:
```
1. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã§ãƒã‚¤ã‚¯è¨±å¯ã‚’å‡ºã™
2. ã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•
3. PitchProã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹
4. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
5. åŸºéŸ³å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹
6. ãƒã‚¤ã‚¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå†å‡ºç¾
```

### æ ¹æœ¬åŸå› ã®ç‰¹å®š

#### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°åˆ†æ
```
[Warning] MicrophoneLifecycleManager] Unhealthy microphone state detected
[Error] Maximum recovery attempts reached - stopping health checks
Error Code: MICROPHONE_ACCESS_DENIED
recoveryAttempts: 3
healthStatus: unhealthy
Error: Microphone health check failed after 3 recovery attempts.
Monitoring stopped to prevent infinite error loop.
```

#### åŸå› ã®è©³ç´°åˆ†æ

**1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ç®¡ç†**
- ãƒšãƒ¼ã‚¸ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•ã™ã‚‹ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è‡ªå‹•çš„ã«åœæ­¢ã™ã‚‹
- ã“ã‚Œã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ãŸã‚ã®ãƒ–ãƒ©ã‚¦ã‚¶ä»•æ§˜

**2. PitchProã®å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯**
- `MicrophoneLifecycleManager`ãŒå®šæœŸçš„ã«ãƒã‚¤ã‚¯ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­ã«ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒåœæ­¢ã™ã‚‹ã¨ã€"unhealthy"ã¨åˆ¤å®š

**3. è‡ªå‹•å¾©æ—§ã®è©¦è¡Œã¨å¤±æ•—**
- PitchProãŒè‡ªå‹•çš„ã«å¾©æ—§ã‚’è©¦è¡Œï¼ˆæœ€å¤§3å›ï¼‰
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­ã¯å¾©æ—§ãŒä¸å¯èƒ½ãªãŸã‚ã€3å›ã¨ã‚‚å¤±æ•—

**4. ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®å›ºå®šåŒ–**
- ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®ãŸã‚ã€3å›å¤±æ•—å¾Œã¯å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯è‡ªä½“ã‚’åœæ­¢
- ã“ã®çŠ¶æ…‹ã§ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¾©å¸°ã—ã¦ã‚‚ã€è‡ªå‹•å¾©æ—§ãŒå®Ÿè¡Œã•ã‚Œãªã„
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å†è¨±å¯ã—ã¦ã‚‚ã€å†…éƒ¨ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ãŒæ®‹ã‚Šç¶šã‘ã‚‹

**5. çµæœçš„ãªç—‡çŠ¶**
- éŸ³åŸŸãƒ†ã‚¹ãƒˆ: ãƒã‚¤ã‚¯æ¤œå‡ºãŒå®Œå…¨ã«å‹•ä½œã—ãªããªã‚‹
- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°: åŸºéŸ³å†ç”Ÿæ™‚ã«å†åº¦ãƒã‚¤ã‚¯è¨±å¯ãŒè¦æ±‚ã•ã‚Œã‚‹

---

## è§£æ±ºç­–ã®è¨­è¨ˆ

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### æ¡ˆ1: visibilitychangeã‚¤ãƒ™ãƒ³ãƒˆã§ã®åˆ¶å¾¡ï¼ˆæ¡ç”¨ï¼‰
**ãƒ¡ãƒªãƒƒãƒˆ**:
- ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–APIã§ç¢ºå®Ÿã«æ¤œå‡º
- PitchProãŒå¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«åˆ¶å¾¡å¯èƒ½
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­ã®ã‚¨ãƒ©ãƒ¼ã‚’æœªç„¶ã«é˜²æ­¢

**å®Ÿè£…**:
```javascript
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»å‹•æ™‚: PitchProã‚’åœæ­¢
        audioDetector.stopDetection();
    } else {
        // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚: PitchProã‚’å†é–‹
        audioDetector.startDetection();
    }
});
```

#### æ¡ˆ2: PitchProã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒƒã‚¯ã§åˆ¶å¾¡ï¼ˆéæ¡ç”¨ï¼‰
**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ**:
- PitchProãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé…ã„
- ã™ã§ã«ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ãªã£ãŸå¾Œã®å¯¾å‡¦ã¨ãªã‚‹

#### æ¡ˆ3: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‹ã‚‰ã®è‡ªå‹•å¾©æ—§ï¼ˆæ¡ˆ1ã¨ä½µç”¨æ¡ç”¨ï¼‰
**ãƒ¡ãƒªãƒƒãƒˆ**:
- ã™ã§ã«ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ãªã£ãŸå ´åˆã®å¯¾å‡¦
- æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã—ã¦è‡ªå‹•ãƒªã‚»ãƒƒãƒˆ
- ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•ã¨ã—ã¦ã®å½¹å‰²

**å®Ÿè£…**:
```javascript
if (error.code === 'MICROPHONE_ACCESS_DENIED' &&
    error.context?.maxAttemptsReached) {
    // è‡ªå‹•çš„ã«PitchProã‚’ãƒªã‚»ãƒƒãƒˆ
    await audioDetector.reset();
}
```

### æ¡ç”¨ã—ãŸè¨­è¨ˆ

**ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: æ¡ˆ1 + æ¡ˆ3
- **ç¬¬1å±¤ï¼ˆäºˆé˜²ï¼‰**: visibilitychangeã§äº‹å‰ã«PitchProã‚’åˆ¶å¾¡
- **ç¬¬2å±¤ï¼ˆå¾©æ—§ï¼‰**: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è‡ªå‹•ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½

---

## å®Ÿè£…è©³ç´°

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `/PitchPro-SPA/pages/js/preparation-pitchpro-cycle.js`

### ã‚³ãƒ¼ãƒ‰å®Ÿè£…

#### 1. çŠ¶æ…‹ç®¡ç†ã®æ‹¡å¼µï¼ˆconstructorï¼‰

```javascript
constructor() {
    // çŠ¶æ…‹ç®¡ç†
    this.state = {
        detectionActive: false,
        detectedPitches: [],
        detectionStartTime: null,
        currentMode: 'permission',
        wasActiveBeforeBackground: false // è¿½åŠ : ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‰ã®çŠ¶æ…‹ä¿æŒ
    };

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶å¾¡ã‚’åˆæœŸåŒ–æ™‚ã«è¨­å®š
    this.setupBackgroundControl();
}
```

**è¿½åŠ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**:
- `wasActiveBeforeBackground`: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»å‹•å‰ã«éŸ³å£°æ¤œå‡ºãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã ã£ãŸã‹ã‚’è¨˜éŒ²

#### 2. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆsetupBackgroundControlï¼‰

```javascript
/**
 * ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶å¾¡ã®è¨­å®š
 * ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã«ãªã£ãŸæ™‚ã«PitchProã‚’ä¸€æ™‚åœæ­¢ã—ã€
 * è¡¨ç¤ºæ™‚ã«å†é–‹ã¾ãŸã¯ãƒªã‚»ãƒƒãƒˆã™ã‚‹
 */
setupBackgroundControl() {
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•æ™‚
            console.log('ğŸ”‡ Page hidden - pausing PitchPro');
            if (this.audioDetector && this.state.detectionActive) {
                this.state.wasActiveBeforeBackground = true;
                this.audioDetector.stopDetection();
            }
        } else {
            // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚
            console.log('ğŸ”Š Page visible - resuming PitchPro');
            if (this.audioDetector && this.state.wasActiveBeforeBackground) {
                if (this.audioDetector.state !== 'error') {
                    this.audioDetector.startDetection();
                } else {
                    // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®å ´åˆã¯å®Œå…¨ãƒªã‚»ãƒƒãƒˆ
                    console.log('âš ï¸ PitchPro in error state - performing reset');
                    this.audioDetector.reset();
                    setTimeout(() => {
                        this.audioDetector.startDetection();
                    }, 500);
                }
                this.state.wasActiveBeforeBackground = false;
            }
        }
    });
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

**ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»å‹•æ™‚**:
1. `document.hidden`ãŒ`true`ã«ãªã‚‹
2. éŸ³å£°æ¤œå‡ºãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã€çŠ¶æ…‹ã‚’ä¿å­˜
3. `stopDetection()`ã§PitchProã‚’åœæ­¢

**ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°æ™‚**:
1. `document.hidden`ãŒ`false`ã«ãªã‚‹
2. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‰ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã ã£ãŸå ´åˆã®ã¿å†é–‹
3. ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯:
   - æ­£å¸¸: `startDetection()`ã§å†é–‹
   - ã‚¨ãƒ©ãƒ¼: `reset()` â†’ 500mså¾…æ©Ÿ â†’ `startDetection()`

#### 3. è‡ªå‹•å¾©æ—§ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆhandleAudioErroræ‹¡å¼µï¼‰

```javascript
/**
 * ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
handleAudioError(context, error) {
    console.error(`ğŸš¨ Audio Error [${context}]:`, error);
    this.state.detectionActive = false;

    // è‡ªå‹•å¾©æ—§ãƒ­ã‚¸ãƒƒã‚¯: æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
    if (error.code === 'MICROPHONE_ACCESS_DENIED' &&
        error.context?.maxAttemptsReached) {
        console.log('ğŸ”„ Auto-recovering from max attempts error...');

        setTimeout(async () => {
            if (this.audioDetector) {
                await this.audioDetector.reset();
                console.log('âœ… PitchPro reset complete');

                // UIã‚’ãƒªã‚»ãƒƒãƒˆçŠ¶æ…‹ã«æˆ»ã™
                if (this.uiElements.requestMicBtn) {
                    this.uiElements.requestMicBtn.disabled = false;
                    this.uiElements.requestMicBtn.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>ãƒã‚¤ã‚¯è¨±å¯</span>';
                    lucide.createIcons();
                }
            }
        }, 1000);
        return;
    }

    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼æ™‚UIæ›´æ–°
    if (this.uiElements.requestMicBtn) {
        this.uiElements.requestMicBtn.disabled = false;
        this.uiElements.requestMicBtn.innerHTML = '<i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i><span>ã‚¨ãƒ©ãƒ¼ - å†è©¦è¡Œ</span>';
        lucide.createIcons();
    }
}
```

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰`MICROPHONE_ACCESS_DENIED`ã‚’æ¤œå‡º
2. `maxAttemptsReached`ãƒ•ãƒ©ã‚°ã‚’ç¢ºèª
3. 1ç§’å¾…æ©Ÿå¾Œã€`reset()`ã‚’å®Ÿè¡Œ
4. UIã‚’ãƒªã‚»ãƒƒãƒˆçŠ¶æ…‹ã«æˆ»ã™ï¼ˆã€Œãƒã‚¤ã‚¯è¨±å¯ã€ãƒœã‚¿ãƒ³ï¼‰
5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å†è©¦è¡Œå¯èƒ½ãªçŠ¶æ…‹ã«ã™ã‚‹

---

## å‹•ä½œãƒ•ãƒ­ãƒ¼

### ã‚·ãƒŠãƒªã‚ª1: æ­£å¸¸ãªãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§»

```
[éŸ³åŸŸãƒ†ã‚¹ãƒˆä¸­]
  â†“
[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•]
  â†“ visibilitychange (hidden)
[PitchPro.stopDetection() å®Ÿè¡Œ]
  â†“ state.wasActiveBeforeBackground = true
[ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ä¸­: ãƒã‚¤ã‚¯åœæ­¢]
  â†“
[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¾©å¸°]
  â†“ visibilitychange (visible)
[audioDetector.state ãƒã‚§ãƒƒã‚¯]
  â†“ state !== 'error'
[PitchPro.startDetection() å®Ÿè¡Œ]
  â†“
[éŸ³åŸŸãƒ†ã‚¹ãƒˆå†é–‹]
```

### ã‚·ãƒŠãƒªã‚ª2: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‹ã‚‰ã®å¾©æ—§

```
[éŸ³åŸŸãƒ†ã‚¹ãƒˆä¸­]
  â†“
[ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ç§»å‹•]
  â†“ (PitchProãŒ3å›å¾©æ—§è©¦è¡Œ)
[MicrophoneLifecycleManager: maxAttemptsReached]
  â†“
[ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å¾©å¸°]
  â†“ visibilitychange (visible)
[audioDetector.state ãƒã‚§ãƒƒã‚¯]
  â†“ state === 'error'
[PitchPro.reset() å®Ÿè¡Œ]
  â†“ 500ms å¾…æ©Ÿ
[PitchPro.startDetection() å®Ÿè¡Œ]
  â†“
[éŸ³åŸŸãƒ†ã‚¹ãƒˆå†é–‹]
```

### ã‚·ãƒŠãƒªã‚ª3: æœ€å¤§è©¦è¡Œå›æ•°ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚

```
[ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ]
  â†“
[handleAudioError() å‘¼ã³å‡ºã—]
  â†“
[ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯]
  â†“ MICROPHONE_ACCESS_DENIED + maxAttemptsReached
[è‡ªå‹•å¾©æ—§é–‹å§‹]
  â†“ 1ç§’å¾…æ©Ÿ
[PitchPro.reset() å®Ÿè¡Œ]
  â†“
[UIã‚’ã€Œãƒã‚¤ã‚¯è¨±å¯ã€çŠ¶æ…‹ã«æˆ»ã™]
  â†“
[ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å†è©¦è¡Œå¯èƒ½]
```

---

## ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª

### ãƒ†ã‚¹ãƒˆ1: éŸ³åŸŸãƒ†ã‚¹ãƒˆ - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§»

**æ‰‹é †**:
1. æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºã§éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹
2. ãƒã‚¤ã‚¯è¨±å¯ã‚’å®Ÿè¡Œ
3. éŸ³å£°æ¤œå‡ºãŒå‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. ã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•
5. 10ç§’å¾…æ©Ÿ
6. ã‚¢ãƒ—ãƒªã‚’ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¾©å¸°
7. éŸ³å£°ã‚’å‡ºã™

**æœŸå¾…çµæœ**:
- âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«`ğŸ”‡ Page hidden - pausing PitchPro`ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«`ğŸ”Š Page visible - resuming PitchPro`ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… éŸ³å£°æ¤œå‡ºãŒè‡ªå‹•çš„ã«å†é–‹ã•ã‚Œã‚‹
- âœ… ãƒã‚¤ã‚¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå†å‡ºç¾ã—ãªã„

### ãƒ†ã‚¹ãƒˆ2: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§»

**æ‰‹é †**:
1. ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚ºã‚’é–‹å§‹
2. ãƒã‚¤ã‚¯è¨±å¯ã‚’å®Ÿè¡Œ
3. ã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•
4. 10ç§’å¾…æ©Ÿ
5. ã‚¢ãƒ—ãƒªã‚’ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¾©å¸°
6. åŸºéŸ³å†ç”Ÿãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹

**æœŸå¾…çµæœ**:
- âœ… ãƒã‚¤ã‚¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå†å‡ºç¾ã—ãªã„
- âœ… éŸ³å£°æ¤œå‡ºãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- âœ… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãŒç¶™ç¶šå¯èƒ½

### ãƒ†ã‚¹ãƒˆ3: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‹ã‚‰ã®è‡ªå‹•å¾©æ—§

**æ‰‹é †**:
1. éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹
2. ãƒã‚¤ã‚¯è¨±å¯ã‚’å®Ÿè¡Œ
3. DevToolsã§PitchProã‚’å¼·åˆ¶çš„ã«ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ã™ã‚‹
4. `maxAttemptsReached`ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹

**æœŸå¾…çµæœ**:
- âœ… ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«`ğŸ”„ Auto-recovering from max attempts error...`ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… 1ç§’å¾Œã«`âœ… PitchPro reset complete`ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… UIãŒã€Œãƒã‚¤ã‚¯è¨±å¯ã€ãƒœã‚¿ãƒ³ã«æˆ»ã‚‹
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå†è©¦è¡Œå¯èƒ½

### ãƒ†ã‚¹ãƒˆ4: é•·æœŸãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆ30ç§’ä»¥ä¸Šï¼‰

**æ‰‹é †**:
1. éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹
2. ãƒã‚¤ã‚¯è¨±å¯ã‚’å®Ÿè¡Œ
3. ã‚¢ãƒ—ãƒªã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»å‹•
4. 30ç§’å¾…æ©Ÿ
5. ã‚¢ãƒ—ãƒªã‚’ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«å¾©å¸°

**æœŸå¾…çµæœ**:
- âœ… ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã«ãªã£ã¦ã„ã¦ã‚‚è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆ
- âœ… éŸ³å£°æ¤œå‡ºãŒæ­£å¸¸ã«å†é–‹ã•ã‚Œã‚‹

---

## ä»Šå¾Œã®æ‹¡å¼µ

### Phase 1: ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚ºã¸ã®é©ç”¨

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `/PitchPro-SPA/pages/js/training-controller.js`ï¼ˆä»®ï¼‰

**å®Ÿè£…å†…å®¹**:
- åŒæ§˜ã®ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…
- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é€²è¡ŒçŠ¶æ…‹ã®ä¿æŒãƒ»å¾©å…ƒ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ç¢ºä¿

### Phase 2: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®è©³ç´°ãƒ­ã‚°

**ç›®çš„**: ãƒ‡ãƒãƒƒã‚°ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚µãƒãƒ¼ãƒˆã®å‘ä¸Š

**å®Ÿè£…å†…å®¹**:
```javascript
handleAudioError(context, error) {
    // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’localStorageã«è¨˜éŒ²
    const errorLog = {
        timestamp: Date.now(),
        context,
        error: {
            code: error.code,
            message: error.message,
            recoveryAttempts: error.context?.recoveryAttempts,
            maxAttemptsReached: error.context?.maxAttemptsReached
        }
    };

    // ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆæœ€æ–°10ä»¶ã®ã¿ï¼‰
    const logs = JSON.parse(localStorage.getItem('pitchpro_error_logs') || '[]');
    logs.unshift(errorLog);
    localStorage.setItem('pitchpro_error_logs', JSON.stringify(logs.slice(0, 10)));
}
```

### Phase 3: ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

**ç›®çš„**: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§»æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç†è§£å‘ä¸Š

**å®Ÿè£…æ¡ˆ**:
```javascript
setupBackgroundControl() {
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // é€šçŸ¥ã‚’è¡¨ç¤º
            showNotification('éŸ³å£°æ¤œå‡ºã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ', 'info');
        } else {
            // å¾©å¸°é€šçŸ¥
            showNotification('éŸ³å£°æ¤œå‡ºã‚’å†é–‹ã—ã¾ã—ãŸ', 'success');
        }
    });
}
```

### Phase 4: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡ºã¨ã®çµ±åˆ

**ç›®çš„**: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡æ–­æ™‚ã®å¯¾å‡¦

**å®Ÿè£…æ¡ˆ**:
```javascript
// ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ¤œå‡º
window.addEventListener('offline', () => {
    if (this.audioDetector && this.state.detectionActive) {
        this.audioDetector.stopDetection();
        this.state.wasOffline = true;
    }
});

// ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°
window.addEventListener('online', () => {
    if (this.state.wasOffline) {
        this.audioDetector.startDetection();
        this.state.wasOffline = false;
    }
});
```

---

## å‚è€ƒè³‡æ–™

### PitchPro AudioProcessing
- **ãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/kiyopi/pitchpro-audio-processing
- **MicrophoneLifecycleManager**: è‡ªå‹•å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ãƒ»å¾©æ—§ã‚·ã‚¹ãƒ†ãƒ 
- **ErrorNotificationSystem**: ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 

### ãƒ–ãƒ©ã‚¦ã‚¶API
- **visibilitychange**: https://developer.mozilla.org/en-US/docs/Web/API/Document/visibilitychange_event
- **MediaStream**: https://developer.mozilla.org/en-US/docs/Web/API/MediaStream

### é–¢é€£ä»•æ§˜æ›¸
- `VOLUME_BAR_INTEGRATION_SPECIFICATION.md`: éŸ³é‡ãƒãƒ¼çµ±åˆä»•æ§˜
- `CRITICAL_DECISIONS_AND_INSIGHTS.md`: iPadOS 13+ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š

---

**ã“ã®ä»•æ§˜æ›¸ã«ã‚ˆã‚Šã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰é·ç§»æ™‚ã®ãƒã‚¤ã‚¯æ¨©é™å•é¡Œã‚’å®Œå…¨ã«è§£æ±ºã—ã€å®‰å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æä¾›ã—ã¾ã™ã€‚**
