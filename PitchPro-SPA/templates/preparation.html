<!-- ヘッダー -->
<header class="page-header">
    <div class="page-header-content">
        <div class="page-header-icon-wrapper">
            <div class="page-header-icon gradient-catalog-blue">
                <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
            </div>
        </div>
        <div class="page-header-text">
            <h1 class="page-title">トレーニング前の準備</h1>
            <p class="page-subtitle text-green-200">ランダム基音モード へのアクセス</p>
        </div>
    </div>
</header>

<!-- メインコンテンツ -->
<main class="narrow-main">
    <!-- ステータス表示 -->
    <div class="mb-4">
        <div class="flex items-center justify-between gap-4">
            <!-- Step 1: マイク許可 -->
            <div class="flex-1 text-center">
                <div class="step-indicator" id="step-1">
                    <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                </div>
                <p class="text-xs text-white-60 mt-2">マイク許可</p>
            </div>

            <!-- 接続線 -->
            <div class="step-connector" id="connector-1"></div>

            <!-- Step 2: 音声テスト -->
            <div class="flex-1 text-center">
                <div class="step-indicator" id="step-2">
                    <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                </div>
                <p class="text-xs text-white-60 mt-2">音声テスト</p>
            </div>

            <!-- 接続線 -->
            <div class="step-connector" id="connector-2"></div>

            <!-- Step 3: 音域テスト -->
            <div class="flex-1 text-center">
                <div class="step-indicator" id="step-3">
                    <i data-lucide="music" style="width: 24px; height: 24px;"></i>
                </div>
                <p class="text-xs text-white-60 mt-2">音域テスト</p>
            </div>
        </div>
    </div>

    <div class="glass-card">
        <!-- マイク許可セクション -->
        <section class="test-section" id="permission-section">
            <div class="section-header">
                <h3 class="text-section-title">マイクロフォンの許可</h3>
                <p class="section-description">音程検出のためマイクロフォンへのアクセスが必要です</p>
            </div>

            <div class="info-alert">
                <i data-lucide="shield-check" style="color: #60a5fa; width: 32px; height: 32px; display: block; min-width: 32px; min-height: 32px;"></i>
                <p>音声データは外部に送信されません。ブラウザ内でリアルタイム処理されます。</p>
            </div>

            <button class="btn btn-primary" id="request-mic-btn">
                <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                <span>マイクを許可</span>
            </button>
        </section>

        <!-- 音声テストセクション -->
        <section class="test-section hidden" id="audio-test-section">
            <div class="section-header">
                <h3 class="text-section-title">音声テスト</h3>
                <p class="section-description">音量と周波数検出を確認します</p>
            </div>

            <!-- 音声テスト中表示エリア -->
            <div class="audio-test-content" id="audio-test-content">
                <div class="voice-instruction">
                    <div class="voice-instruction-icon">
                        <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                    </div>
                    <p class="voice-instruction-text" id="voice-instruction-text">「ド」を発声してください</p>
                    <div class="voice-instruction-pulse"></div>
                </div>

                <!-- 音量レベル -->
                <div class="meter-group">
                    <div class="meter-label">
                        <span>音量レベル</span>
                        <span class="meter-value" id="volume-value">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 検出周波数 -->
                <div class="meter-group">
                    <div class="meter-label">
                        <span>検出周波数</span>
                        <span class="meter-value" id="frequency-value">261.6 Hz (C4)</span>
                    </div>
                </div>
            </div>

            <div class="success-alert hidden" id="detection-success">
                <i data-lucide="check-circle" style="color: #22c55e; width: 32px; height: 32px; display: block; min-width: 32px; min-height: 32px;"></i>
                <p id="detection-success-message">音声検出が完了しました！</p>
            </div>

            <!-- 音域テストを開始ボタン（正規版互換） -->
            <button class="btn btn-primary hidden" id="start-range-test-btn">
                <span>音域テストを開始</span>
                <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
            </button>

            <!-- 音域データがある場合: 詳細表示（正規版互換） -->
            <div class="glass-card hidden" id="range-saved-display">
                <h4 class="heading-sm">
                    <i data-lucide="check-circle" class="text-green-400"></i>
                    <span>音域設定済み</span>
                </h4>
                <div class="range-info-container">
                    <div class="range-info-row">
                        <span>音域範囲</span>
                        <span class="range-info-value" id="saved-range">A2 - F5</span>
                    </div>
                    <div class="range-info-row">
                        <span>オクターブ数</span>
                        <span class="range-info-value" id="saved-octaves">2.6オクターブ</span>
                    </div>
                    <div class="range-info-row">
                        <span>設定日時</span>
                        <span class="range-info-value" id="saved-date">2024-01-01</span>
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button class="btn btn-outline" id="retest-range-btn">
                        <span>音域を再測定</span>
                        <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                    </button>
                    <button class="btn btn-success" id="skip-range-test-btn">
                        <span>トレーニング開始</span>
                        <i data-lucide="skip-forward" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- 音域テストセクション（詳細版） -->
        <section class="test-section hidden" id="range-test-section">
            <div class="section-header">
                <h3 class="text-section-title">音域テスト</h3>
                <p class="section-description">あなたの快適な音域を測定します</p>
                <!-- マイクステータスアイコン -->
                <div class="mic-status-container standby" id="mic-status-container" style="margin: 12px auto 0 auto;">
                    <i data-lucide="mic" id="mic-status-icon" style="width: 40px; height: 40px;"></i>
                </div>
            </div>

            <!-- メインステータス -->
            <div class="text-center mb-6">
                <h4 class="voice-range-main-text" id="main-status-text">「音域テスト開始」ボタンでテストを開始してください</h4>
            </div>

            <!-- 音域テストバッジ -->
            <div class="range-test-layout-flex">
                <div class="range-test-item">
                    <div class="voice-range-display-container">
                        <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                            <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                            <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16"
                                    stroke-dasharray="452" stroke-dashoffset="452"
                                    transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                        </svg>
                        <div class="voice-note-badge">
                            <div id="range-icon" class="icon-4xl text-white" style="display: block;">
                                <img src="pages/icons/arrow-down.png" alt="下向き矢印" style="width: 80px; height: 80px; display: block;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- サブ情報 -->
            <div class="text-center mt-4">
                <p class="text-sm voice-range-sub-text" id="sub-info-text">待機中...</p>
            </div>

            <!-- 検出状況表示 -->
            <div class="detection-meters" style="margin-top: 24px;">
                <!-- 音量レベル -->
                <div class="meter-group" id="range-volume-container">
                    <div class="meter-label">
                        <span>音量レベル</span>
                        <span class="volume-text meter-value" id="range-test-volume-text">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green"
                             id="range-test-volume-bar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- 検出周波数 -->
                <div class="meter-group">
                    <div class="meter-label">
                        <span>検出周波数</span>
                        <span class="meter-value" id="range-test-frequency-value">0 Hz</span>
                    </div>
                </div>
            </div>

            <!-- コントロールボタン -->
            <div class="text-center mt-6">
                <button class="btn btn-primary voice-range-btn" id="begin-range-test-btn">
                    <i data-lucide="play" style="width: 20px; height: 20px;"></i>
                    <span>音域テスト開始</span>
                </button>

                <button class="btn btn-outline ml-3 voice-range-btn hidden" id="retry-measurement-btn">
                    <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                    <span>再測定</span>
                </button>
            </div>

            <!-- 結果表示エリア -->
            <div class="mt-6 hidden" id="results-section">
                <h3 class="heading-md">
                    <i data-lucide="bar-chart-3" class="text-green-300"></i>
                    <span>音域テスト結果</span>
                </h3>

                <!-- 基本結果 -->
                <div class="range-info-container" style="margin-bottom: 0;">
                    <div class="range-info-row">
                        <span>音域範囲</span>
                        <span class="range-info-value" id="result-range">-</span>
                    </div>
                    <div class="range-info-row">
                        <span>オクターブ数</span>
                        <span class="range-info-value" id="result-octaves">-</span>
                    </div>
                    <div class="range-info-row">
                        <span>最低音</span>
                        <span class="range-info-value" id="result-low-freq">-</span>
                    </div>
                    <div class="range-info-row" style="margin-bottom: 24px;">
                        <span>最高音</span>
                        <span class="range-info-value" id="result-high-freq">-</span>
                    </div>
                </div>

                <!-- 詳細情報・警告メッセージ表示エリア -->
                <div id="result-details">
                    <!-- JavaScriptで動的に生成 -->
                </div>

                <!-- アクションボタン -->
                <div class="flex flex-col md:flex-row gap-3 mt-5">
                    <button class="btn btn-outline" id="remeasure-btn">
                        <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                        <span>再測定</span>
                    </button>
                    <button class="btn btn-success" id="complete-range-test-btn">
                        <span>トレーニング開始</span>
                        <i data-lucide="arrow-right" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>
            </div>
        </section>
    </div>
</main>