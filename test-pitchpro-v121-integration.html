<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro v1.2.1 統合テスト</title>

    <!-- 本番スタイルシート使用 -->
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">

    <!-- フォント -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- アイコンライブラリ -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="min-h-screen p-6">
        <div class="container max-w-4xl mx-auto">
            <!-- ヘッダー -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-4">🚀 PitchPro v1.2.1 統合テスト</h1>
                <p class="text-yellow-200 text-lg">新バージョンの機能確認・統合テスト</p>
            </header>

            <!-- v1.2.1 新機能確認 -->
            <div class="glass-card mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="star" class="text-yellow-300 icon-md"></i>
                    <h3 class="heading-md text-yellow-300">v1.2.1 新機能・改善点確認</h3>
                </div>
                <div id="version-info" class="text-white-70 space-y-2">
                    <div>ライブラリ読み込み状況確認中...</div>
                </div>
            </div>

            <!-- システム状態 -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="activity" class="text-blue-300"></i>
                    <span>システム状態</span>
                </h3>
                <div id="system-status" class="status-card mb-4">初期化前...</div>

                <div class="flex gap-3 flex-wrap">
                    <button id="init-btn" class="btn btn-primary">
                        <i data-lucide="mic" class="icon-sm"></i>
                        <span>初期化</span>
                    </button>
                    <button id="start-btn" class="btn btn-success" disabled>
                        <i data-lucide="play" class="icon-sm"></i>
                        <span>検出開始</span>
                    </button>
                    <button id="stop-btn" class="btn btn-outline" disabled>
                        <i data-lucide="stop-circle" class="icon-sm"></i>
                        <span>検出停止</span>
                    </button>
                </div>
            </div>

            <!-- 音量バーテスト -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="volume-2" class="text-green-300"></i>
                    <span>音量バー動作テスト</span>
                </h3>
                <div class="volume-meter">
                    <div class="flex items-center justify-between mb-2 w-full">
                        <span class="text-white-70">音量レベル</span>
                        <span id="volume-text" class="text-white font-medium">0.0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="flex items-center justify-center gap-4 mt-4">
                    <div class="frequency-display text-2xl font-bold text-green-300 bg-black bg-opacity-30 px-4 py-2 rounded-lg" id="frequency">0 Hz</div>
                    <div class="note-display text-xl font-bold text-yellow-300 bg-black bg-opacity-30 px-4 py-2 rounded-lg" id="note">-</div>
                </div>
            </div>

            <!-- updateSelectors機能テスト -->
            <div class="glass-card mb-6">
                <h3 class="heading-md mb-4">
                    <i data-lucide="repeat" class="text-purple-300"></i>
                    <span>updateSelectors機能テスト</span>
                </h3>
                <div class="info-card mb-4">
                    <h4 class="text-white font-medium mb-2">🔄 UI要素動的切り替え</h4>
                    <p class="text-white-70">v1.2.1のupdateSelectors()メソッドでUI要素を瞬時に切り替えできるかテスト</p>
                </div>

                <!-- 代替音量バー -->
                <div class="volume-meter mb-4">
                    <div class="flex items-center justify-between mb-2 w-full">
                        <span class="text-white-70">代替音量バー</span>
                        <span id="alt-volume-text" class="text-white font-medium">0.0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-purple" id="alt-volume-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button id="switch-main-btn" class="btn btn-outline" disabled>
                        <i data-lucide="mic" class="icon-sm"></i>
                        <span>メイン表示に切り替え</span>
                    </button>
                    <button id="switch-alt-btn" class="btn btn-outline" disabled>
                        <i data-lucide="repeat" class="icon-sm"></i>
                        <span>代替表示に切り替え</span>
                    </button>
                </div>
            </div>

            <!-- ログ出力 -->
            <div class="glass-card">
                <h3 class="heading-md mb-4">
                    <i data-lucide="file-text" class="text-white-70"></i>
                    <span>ログ出力</span>
                </h3>
                <div id="log-output" class="bg-black bg-opacity-50 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm"></div>
                <button id="clear-log-btn" class="btn btn-outline mt-3">
                    <i data-lucide="trash-2" class="icon-sm"></i>
                    <span>ログクリア</span>
                </button>
            </div>
        </div>
    </div>

    <!-- PitchPro v1.2.1 -->
    <script src="voice-range-test-v4/src/js/pitchpro-v1.2.1.umd.js"></script>

    <script>
        // ログ出力関数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('log-output');
            const colorClass = {
                'info': 'text-white-70',
                'success': 'text-green-300',
                'warning': 'text-yellow-300',
                'error': 'text-red-300',
                'debug': 'text-blue-300'
            }[type] || 'text-white-70';

            const logEntry = document.createElement('div');
            logEntry.className = colorClass;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // バージョン情報確認
        if (typeof PitchPro !== 'undefined') {
            log('🎉 PitchPro v1.2.1 UMD読み込み成功', 'success');
            log(`📦 利用可能なクラス: ${Object.keys(PitchPro).join(', ')}`, 'info');

            // バージョン情報表示
            const versionInfo = document.getElementById('version-info');
            const versionItems = [
                `✅ ライブラリ読み込み: 成功`,
                `📋 利用可能なクラス: ${Object.keys(PitchPro).length}個`,
                `🔧 主要クラス: ${Object.keys(PitchPro).slice(0,5).join(', ')}`,
                `🆔 PitchPro Version: ${PitchPro.VERSION || 'v1.2.1'}`,
                `📅 Build Date: ${PitchPro.BUILD_DATE || '最新'}`
            ];
            versionInfo.innerHTML = versionItems.map(item =>
                `<div class="flex items-center gap-2 mb-1">${item}</div>`
            ).join('');
        } else {
            log('❌ PitchPro ライブラリの読み込みに失敗', 'error');
        }

        // アプリケーション状態
        let audioDetector = null;
        let microphoneController = null;
        let isInitialized = false;

        // DOM要素取得
        const initBtn = document.getElementById('init-btn');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const switchMainBtn = document.getElementById('switch-main-btn');
        const switchAltBtn = document.getElementById('switch-alt-btn');
        const clearLogBtn = document.getElementById('clear-log-btn');
        const systemStatus = document.getElementById('system-status');

        // 初期化ボタン
        initBtn.addEventListener('click', async () => {
            try {
                log('🎤 初期化開始...', 'info');
                initBtn.disabled = true;

                // MicrophoneController初期化
                microphoneController = new PitchPro.MicrophoneController();
                await microphoneController.initialize();
                log('✅ MicrophoneController初期化完了', 'success');

                // AudioDetectionComponent初期化
                audioDetector = new PitchPro.AudioDetectionComponent({
                    volumeBarSelector: '#volume-bar',
                    volumeTextSelector: '#volume-text',
                    frequencySelector: '#frequency',
                    noteSelector: '#note'
                });

                await audioDetector.initialize(microphoneController);
                log('✅ AudioDetectionComponent初期化完了', 'success');

                // コールバック設定
                audioDetector.setCallbacks({
                    onPitchUpdate: (result) => {
                        // 自動的にUI更新される（PitchProが管理）
                    },
                    onError: (error) => {
                        log(`❌ エラー: ${error.message}`, 'error');
                    }
                });

                isInitialized = true;
                startBtn.disabled = false;
                switchMainBtn.disabled = false;
                switchAltBtn.disabled = false;
                systemStatus.textContent = '✅ 初期化完了 - 検出開始可能';
                systemStatus.className = 'status-card status-success';

                log('🎉 システム初期化完了！', 'success');

            } catch (error) {
                log(`❌ 初期化エラー: ${error.message}`, 'error');
                initBtn.disabled = false;
                systemStatus.textContent = `❌ 初期化失敗: ${error.message}`;
                systemStatus.className = 'status-card status-error';
            }
        });

        // 検出開始ボタン
        startBtn.addEventListener('click', async () => {
            try {
                log('▶️ 音声検出開始...', 'info');
                await audioDetector.startDetection();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                systemStatus.textContent = '🎵 音声検出中...';
                systemStatus.className = 'status-card status-active';
                log('✅ 音声検出開始', 'success');
            } catch (error) {
                log(`❌ 検出開始エラー: ${error.message}`, 'error');
            }
        });

        // 検出停止ボタン
        stopBtn.addEventListener('click', () => {
            log('⏹️ 音声検出停止...', 'info');
            audioDetector.stopDetection();
            startBtn.disabled = false;
            stopBtn.disabled = true;
            systemStatus.textContent = '⏸️ 検出停止中';
            systemStatus.className = 'status-card status-ready';
            log('✅ 音声検出停止', 'success');
        });

        // メイン表示切り替え
        switchMainBtn.addEventListener('click', () => {
            if (!audioDetector) return;

            log('🔄 メイン表示に切り替え中...', 'debug');
            try {
                audioDetector.updateSelectors({
                    volumeBarSelector: '#volume-bar',
                    volumeTextSelector: '#volume-text',
                    frequencySelector: '#frequency',
                    noteSelector: '#note'
                });
                log('✅ メイン表示に切り替え完了', 'success');
            } catch (error) {
                log(`❌ 切り替えエラー: ${error.message}`, 'error');
            }
        });

        // 代替表示切り替え
        switchAltBtn.addEventListener('click', () => {
            if (!audioDetector) return;

            log('🔄 代替表示に切り替え中...', 'debug');
            try {
                audioDetector.updateSelectors({
                    volumeBarSelector: '#alt-volume-bar',
                    volumeTextSelector: '#alt-volume-text',
                    frequencySelector: '#frequency',
                    noteSelector: '#note'
                });
                log('✅ 代替表示に切り替え完了', 'success');
            } catch (error) {
                log(`❌ 切り替えエラー: ${error.message}`, 'error');
            }
        });

        // ログクリア
        clearLogBtn.addEventListener('click', () => {
            document.getElementById('log-output').innerHTML = '';
            log('🧹 ログをクリアしました', 'info');
        });

        // Lucide初期化
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
            log('✅ Lucideアイコン初期化完了', 'debug');
        }

        log('🚀 PitchPro v1.2.1 統合テスト開始', 'info');
    </script>
</body>
</html>