<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®æº–å‚™ï¼ˆãƒ†ã‚¹ãƒˆç‰ˆï¼‰- 8vaç›¸å¯¾éŸ³æ„Ÿãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <link rel="stylesheet" href="Bolt/v2/styles/results.css">
    <link rel="stylesheet" href="Bolt/v2/styles/training.css">
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="page-header">
            <div class="page-header-content">
                <div class="page-header-icon-wrapper">
                    <div class="page-header-icon gradient-catalog-blue">
                        <i data-lucide="mic" class="text-white" data-stroke-width="2" style="width: 36px; height: 36px;"></i>
                    </div>
                </div>
                <div class="page-header-text">
                    <h1 class="page-title">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å‰ã®æº–å‚™ï¼ˆãƒ†ã‚¹ãƒˆç‰ˆï¼‰</h1>
                    <p class="page-subtitle text-green-200">PitchPro v1.1.3 + SafariéŸ³é‡ä½ä¸‹å¯¾ç­– çµ±åˆãƒ†ã‚¹ãƒˆ</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="narrow-main">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="mb-4">
                <div class="flex items-center justify-between gap-4">
                    <!-- Step 1: ãƒã‚¤ã‚¯è¨±å¯ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-1">
                            <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">ãƒã‚¤ã‚¯è¨±å¯</p>
                    </div>
                    
                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-1"></div>
                    
                    <!-- Step 2: éŸ³å£°ãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-2">
                            <i data-lucide="speech" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³å£°ãƒ†ã‚¹ãƒˆ</p>
                    </div>
                    
                    <!-- æ¥ç¶šç·š -->
                    <div class="step-connector" id="connector-2"></div>
                    
                    <!-- Step 3: éŸ³åŸŸãƒ†ã‚¹ãƒˆ -->
                    <div class="flex-1 text-center">
                        <div class="step-indicator" id="step-3">
                            <i data-lucide="music" style="width: 24px; height: 24px;"></i>
                        </div>
                        <p class="text-xs text-white-60 mt-2">éŸ³åŸŸãƒ†ã‚¹ãƒˆ</p>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <!-- ãƒã‚¤ã‚¯è¨±å¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section" id="permission-section">
                    <div class="section-header">
                        <h3 class="text-section-title">ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã®è¨±å¯</h3>
                        <p class="section-description">éŸ³ç¨‹æ¤œå‡ºã®ãŸã‚ãƒã‚¤ã‚¯ãƒ­ãƒ•ã‚©ãƒ³ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™</p>
                    </div>
                    
                    <div class="info-alert">
                        <i data-lucide="shield-check" style="width: 48px; height: 48px; color: #60a5fa;"></i>
                        <p>éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã¯å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†ã•ã‚Œã¾ã™ã€‚</p>
                    </div>
                    
                    <button class="btn btn-primary" id="request-mic-btn">
                        <i data-lucide="mic" style="width: 24px; height: 24px;"></i>
                        <span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>
                    </button>
                </section>

                <!-- éŸ³å£°ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="audio-test-section">
                    <div class="section-header">
                        <h3 class="text-section-title">éŸ³å£°ãƒ†ã‚¹ãƒˆ</h3>
                        <p class="section-description">éŸ³é‡ã¨å‘¨æ³¢æ•°æ¤œå‡ºã‚’ç¢ºèªã—ã¾ã™</p>
                    </div>
                    
                    <div class="voice-instruction">
                        <div class="voice-instruction-icon">
                            <i data-lucide="music" style="width: 32px; height: 32px; color: white;"></i>
                        </div>
                        <p class="voice-instruction-text" id="voice-instruction-text">ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„</p>
                        <div class="voice-instruction-pulse"></div>
                    </div>
                    
                    <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                            <span class="meter-value" id="volume-value">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                    <div class="meter-group">
                        <div class="meter-label">
                            <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                            <span class="meter-value" id="frequency-value">261.6 Hz (C4)</span>
                        </div>
                    </div>
                    
                    <!-- é€²æ—è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆæ–°è¿½åŠ ï¼‰ -->
                    <div class="meter-group" id="progress-display" style="display: none;">
                        <div class="text-center p-4 bg-blue-500 bg-opacity-20 rounded-lg border border-blue-300 border-opacity-30">
                            <div class="text-sm text-blue-200 mb-2">æ¤œå‡ºé€²æ—</div>
                            <div class="text-lg font-semibold text-white" id="progress-text">ã€Œãƒ‰ã€ã‚’ç™ºå£°ã—ã¦ãã ã•ã„</div>
                            <div class="mt-2 text-xs text-blue-300" id="progress-detail">æ™‚é–“ãƒ»å›æ•°ã®æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„</div>
                        </div>
                    </div>

                    <div class="success-alert" id="detection-success">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p id="detection-success-message">ã€Œãƒ‰ã€ã®éŸ³ç¨‹ã‚’æ¤œå‡ºã§ãã¾ã—ãŸï¼éŸ³åŸŸãƒ†ã‚¹ãƒˆã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                    </div>

                    <!-- éŸ³åŸŸè¨­å®šæ¸ˆã¿ã®å ´åˆã®è¡¨ç¤º -->
                    <div class="glass-card hidden" id="range-saved-display">
                        <h4 class="heading-sm">
                            <i data-lucide="check-circle" class="text-green-400"></i>
                            <span>éŸ³åŸŸè¨­å®šæ¸ˆã¿</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>éŸ³åŸŸç¯„å›²</span>
                                <span class="range-info-value" id="saved-range">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                                <span class="range-info-value" id="saved-octaves">2.6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</span>
                            </div>
                            <div class="range-info-row">
                                <span>è¨­å®šæ—¥æ™‚</span>
                                <span class="range-info-value" id="saved-date">2024-01-01</span>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button class="btn btn-success" id="skip-range-test-btn">
                                <span>ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç·´ç¿’é–‹å§‹</span>
                                <i data-lucide="skip-forward" style="width: 20px; height: 20px;"></i>
                            </button>
                            <button class="btn btn-primary" id="retest-range-btn">
                                <span>éŸ³åŸŸã‚’å†ãƒ†ã‚¹ãƒˆ</span>
                                <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                            </button>
                        </div>
                    </div>

                    <button class="btn btn-primary hidden" id="start-range-test-btn">
                        <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚’é–‹å§‹</span>
                        <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                    </button>
                </section>

                <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="range-test-section">
                    <div class="section-header">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-section-title">éŸ³åŸŸãƒ†ã‚¹ãƒˆ</h3>
                                <p class="section-description">ã‚ãªãŸã®å¿«é©ãªéŸ³åŸŸã‚’æ¸¬å®šã—ã¦ã„ã¾ã™</p>
                            </div>
                            <!-- ãƒã‚¤ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆå³ä¸Šé…ç½®ï¼‰ -->
                            <div class="mic-status-container standby" id="mic-status-container">
                                <i data-lucide="mic" id="mic-status-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- ãƒ†ã‚¹ãƒˆæŒ‡ç¤º -->
                    <div class="text-center mb-6">
                        <h4 class="text-sub-title text-center" id="test-instruction-text">éŸ³åŸŸã‚’æ¸¬å®šã—ã¾ã™</h4>
                    </div>
                    
                    <!-- æ¤œå‡ºçŠ¶æ³ -->
                    <div class="detection-meters">
                        <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆè¡¨ç¤º -->
                        <div class="range-test-layout-flex">
                            <!-- ä¸­å¤®: éŸ³ç¨‹ãƒãƒƒã‚¸ã¨å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                            <div class="range-test-item">
                                <div class="voice-range-display-container">
                                    <svg class="voice-stability-svg" width="160" height="160" id="stability-ring">
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="16"/>
                                        <circle cx="80" cy="80" r="72" fill="none" stroke="#3b82f6" stroke-width="16" 
                                                stroke-dasharray="452" stroke-dashoffset="452" 
                                                transform="rotate(-90 80 80)" class="voice-progress-circle"/>
                                    </svg>
                                    <div class="voice-note-badge">
                                        <i data-lucide="arrow-down" id="range-icon" style="width: 80px; height: 80px; color: white; display: block;"></i>
                                        <p class="countdown-text" id="countdown-display" style="display: none;">0</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ¤œå‡ºçŠ¶æ³è¡¨ç¤ºï¼ˆdetection-metersã®ä¸‹ï¼‰ -->
                        <div class="detection-meters" style="margin-top: 20px;">
                            <!-- éŸ³é‡ãƒ¬ãƒ™ãƒ« -->
                            <div class="meter-group">
                                <div class="meter-label">
                                    <span>éŸ³é‡ãƒ¬ãƒ™ãƒ«</span>
                                    <span class="meter-value" id="range-test-volume-text">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill gradient-catalog-green" 
                                         id="range-test-volume-bar" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- æ¤œå‡ºå‘¨æ³¢æ•° -->
                            <div class="meter-group">
                                <div class="meter-label">
                                    <span>æ¤œå‡ºå‘¨æ³¢æ•°</span>
                                    <span class="meter-value" id="range-test-frequency-value">0 Hz</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary hidden" id="begin-range-test-btn">
                                <i data-lucide="play" style="width: 20px; height: 20px;"></i>
                                <span>éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹</span>
                            </button>
                        </div>
                    </div>

                    <p class="test-status" id="test-status">å¾…æ©Ÿä¸­...</p>
                </section>

                <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <section class="test-section hidden" id="result-section">
                    <div class="section-header">
                        <h3 class="text-section-title">ãƒ†ã‚¹ãƒˆå®Œäº†</h3>
                        <p class="section-description">éŸ³åŸŸãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ</p>
                    </div>
                    
                    <div class="result-card">
                        <h4 class="heading-sm">
                            <i data-lucide="music" class="text-orange-400"></i>
                            <span>ã‚ãªãŸã®éŸ³åŸŸ</span>
                        </h4>
                        <div class="range-info-container">
                            <div class="range-info-row">
                                <span>éŸ³åŸŸç¯„å›²</span>
                                <span class="range-info-value">A2 - F5</span>
                            </div>
                            <div class="range-info-row">
                                <span>ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–æ•°</span>
                                <span class="range-info-value">2.6ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–</span>
                            </div>
                        </div>
                    </div>

                    <div class="success-alert">
                        <i data-lucide="check-circle" style="width: 24px; height: 24px; color: #22c55e;"></i>
                        <p>æœ€é©ãªåŸºéŸ³ãŒè‡ªå‹•é¸æŠã•ã‚Œã¾ã™ã€‚ã“ã®çµæœã§ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                    </div>

                    <div class="flex gap-3 mt-4">
                        <button class="btn btn-outline" id="remeasure-range-btn">
                            <span>å†æ¸¬å®š</span>
                            <i data-lucide="refresh-cw" style="width: 20px; height: 20px;"></i>
                        </button>
                        <button class="btn btn-success" id="start-training-btn">
                            <span>ã“ã®çµæœã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹</span>
                            <i data-lucide="arrow-right" style="width: 24px; height: 24px;"></i>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- å¿…è¦ãªJavaScriptï¼ˆèª­ã¿è¾¼ã¿é †åºé‡è¦ï¼‰ -->
    <!-- UIãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- PitchPro v1.1.3ï¼ˆSafariéŸ³é‡ä½ä¸‹å¯¾ç­–ç‰ˆï¼‰ -->
    <script src="js/pitchpro-audio/pitchpro-v1.1.3.umd.js"></script>
    
    <!-- VoiceRangeTesterV113ï¼ˆPitchPro v1.1.3å®Œå…¨å¯¾å¿œç‰ˆï¼‰ -->
    <script src="js/modules/voice-range-tester-v1.1.3.js"></script>
    
    <!-- TODO: å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«åŒ– /js/preparation-test.js -->
    <script>
        // Lucideã‚¢ã‚¤ã‚³ãƒ³åˆæœŸåŒ–
        lucide.createIcons();
        
        // ã‚·ã‚¹ãƒ†ãƒ å¤‰æ•°ï¼ˆpitchpro-correct-test.htmlæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        let micController = null;
        let pitchDetector = null;
        let isAudioTesting = false;
        let audioTestStartTime = null;
        let audioTestDuration = 15000;
        let detectedC4 = false;
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨å¤‰æ•°
        let voiceRangeTester = null;
        
        // DOMè¦ç´ 
        const requestMicBtn = document.getElementById('request-mic-btn');
        const startRangeTestBtn = document.getElementById('start-range-test-btn');
        const startTrainingBtn = document.getElementById('start-training-btn');
        const remeasureRangeBtn = document.getElementById('remeasure-range-btn');
        const retestRangeBtn = document.getElementById('retest-range-btn');
        const skipRangeTestBtn = document.getElementById('skip-range-test-btn');

        const permissionSection = document.getElementById('permission-section');
        const audioTestSection = document.getElementById('audio-test-section');
        const rangeTestSection = document.getElementById('range-test-section');
        const resultSection = document.getElementById('result-section');
        const rangeSavedDisplay = document.getElementById('range-saved-display');

        // UIè¡¨ç¤ºè¦ç´ 
        const volumeProgress = document.getElementById('volume-progress');
        const volumeValue = document.getElementById('volume-value');
        const frequencyValue = document.getElementById('frequency-value');
        const detectionSuccess = document.getElementById('detection-success');
        const progressDisplay = document.getElementById('progress-display');
        const progressText = document.getElementById('progress-text');
        const progressDetail = document.getElementById('progress-detail');

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
        function updateStepStatus(stepNumber, status) {
            const step = document.getElementById(`step-${stepNumber}`);
            const connector = document.getElementById(`connector-${stepNumber}`);
            
            if (!step) return;
            
            // çŠ¶æ…‹ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            step.classList.remove('active', 'completed', 'pending');
            if (connector) {
                connector.classList.remove('active', 'completed');
            }
            
            // æ–°ã—ã„çŠ¶æ…‹ã‚’é©ç”¨
            step.classList.add(status);
            if (connector && status === 'completed') {
                connector.classList.add('completed');
            }
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ç‰¹åˆ¥å‡¦ç†
            if (status === 'active' && connector) {
                connector.classList.add('active');
            }
        }

        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function showSection(targetSection) {
            const sections = [permissionSection, audioTestSection, rangeTestSection, resultSection];
            
            sections.forEach(section => {
                if (section) {
                    section.classList.add('hidden');
                }
            });
            
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
        }

        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showErrorMessage(message) {
            console.error('âŒ ã‚¨ãƒ©ãƒ¼:', message);
            alert(`ã‚¨ãƒ©ãƒ¼: ${message}`);
        }

        // é€²æ—è¡¨ç¤ºæ›´æ–°
        function updateProgressDisplay(mainText, detailText) {
            if (progressDisplay) {
                progressDisplay.style.display = 'block';
            }
            if (progressText) {
                progressText.textContent = mainText;
            }
            if (progressDetail) {
                progressDetail.textContent = detailText;
            }
        }

        // ãƒã‚¤ã‚¯åˆæœŸåŒ–ï¼ˆpitchpro-correct-test.htmlæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆï¼‰
        async function initializeMicrophone() {
            try {
                console.log('ğŸ¤ ãƒã‚¤ã‚¯åˆæœŸåŒ–é–‹å§‹ï¼ˆSafariéŸ³é‡ä½ä¸‹å¯¾ç­–çµ±åˆç‰ˆï¼‰');
                requestMicBtn.disabled = true;
                requestMicBtn.innerHTML = '<i data-lucide="loader" style="width: 24px; height: 24px;"></i><span>åˆæœŸåŒ–ä¸­...</span>';
                lucide.createIcons();
                
                if (!window.PitchPro) {
                    throw new Error('PitchProãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const { AudioManager, PitchDetector } = window.PitchPro;
                
                // AudioManageråˆæœŸåŒ–ï¼ˆSafari Web Audio APIéŸ³é‡ä½ä¸‹å•é¡Œã®åŒ…æ‹¬çš„å¯¾ç­–ï¼‰
                micController = new AudioManager({
                    sampleRate: 44100,
                    channelCount: 1,
                    echoCancellation: false,        // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 1
                    noiseSuppression: false,        // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 2
                    autoGainControl: false          // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 3
                });
                
                await micController.initialize();
                console.log('âœ… AudioManageråˆæœŸåŒ–å®Œäº†ï¼ˆSafariéŸ³é‡ä½ä¸‹å¯¾ç­–ï¼šAGCãƒ»ECãƒ»NSå…¨ç„¡åŠ¹ï¼‰');
                
                // PitchDetectoråˆæœŸåŒ–ï¼ˆSafariéŸ³é‡ä½ä¸‹å•é¡Œå®Œå…¨å¯¾ç­–ç‰ˆï¼‰
                pitchDetector = new PitchDetector(micController, {
                    fftSize: 4096,
                    smoothing: 0.0,  // SafariéŸ³é‡ä½ä¸‹æ ¹æœ¬åŸå› 4: smoothingTimeConstantç„¡åŠ¹åŒ–ï¼ˆæœ€é‡è¦ï¼‰
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.0001,
                    harmonicCorrection: false,
                    silenceDetection: { enabled: false }
                });
                
                await pitchDetector.initialize();
                console.log('âœ… PitchDetectoråˆæœŸåŒ–å®Œäº†ï¼ˆSafariéŸ³é‡ä½ä¸‹4å¤§å¯¾ç­–å®Ÿè£…æ¸ˆã¿ï¼‰');
                
                // VoiceRangeTesterV113åˆæœŸåŒ–
                if (window.VoiceRangeTesterV113) {
                    voiceRangeTester = new window.VoiceRangeTesterV113(pitchDetector);
                    console.log('âœ… VoiceRangeTesterV113åˆæœŸåŒ–å®Œäº†');
                } else {
                    console.error('âŒ VoiceRangeTesterV113ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                console.log('âœ… ãƒã‚¤ã‚¯åˆæœŸåŒ–å®Œäº†');
                updateStepStatus(1, 'completed');
                updateStepStatus(2, 'active');
                
                showSection(audioTestSection);
                startAudioTest();
                
            } catch (error) {
                console.error('âŒ ãƒã‚¤ã‚¯åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                showErrorMessage(`ãƒã‚¤ã‚¯åˆæœŸåŒ–ã«å¤±æ•—: ${error.message}`);
                
                requestMicBtn.disabled = false;
                requestMicBtn.innerHTML = '<i data-lucide="mic" style="width: 24px; height: 24px;"></i><span>ãƒã‚¤ã‚¯ã‚’è¨±å¯</span>';
                lucide.createIcons();
            }
        }

        // éŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆpitchpro-correct-test.htmlæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³çµ±åˆï¼‰
        function startAudioTest() {
            if (!pitchDetector) {
                console.error('âŒ PitchDetector ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            isAudioTesting = true;
            audioTestStartTime = Date.now();
            detectedC4 = false;
            
            // pitchpro-correct-test.htmlæˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
            pitchDetector.setCallbacks({
                onPitchUpdate: (result) => {
                    if (!isAudioTesting || !result) return;
                    
                    const { frequency, note } = result;
                    let volumeLevel = 0;
                    
                    // ã€SafariéŸ³é‡ä½ä¸‹å•é¡Œæ ¹æœ¬è§£æ±ºã€‘Web Audio APIã‹ã‚‰ç›´æ¥éŸ³é‡ã‚’é«˜ç²¾åº¦è¨ˆç®—
                    try {
                        if (pitchDetector && pitchDetector.rawAnalyser) {
                            const bufferLength = pitchDetector.rawAnalyser.fftSize;
                            const dataArray = new Float32Array(bufferLength);
                            pitchDetector.rawAnalyser.getFloatTimeDomainData(dataArray);
                            
                            // é«˜ç²¾åº¦RMSè¨ˆç®—ï¼ˆSafariæœ€é©åŒ–ç‰ˆï¼‰
                            let sum = 0;
                            let maxValue = 0;
                            for (let i = 0; i < bufferLength; i++) {
                                const value = Math.abs(dataArray[i]);
                                sum += value * value;
                                maxValue = Math.max(maxValue, value);
                            }
                            
                            const rms = Math.sqrt(sum / bufferLength);
                            
                            // Safariå¯¾å¿œï¼šã‚¹ãƒ ãƒ¼ã‚ºãªéŸ³é‡æ¤œå‡ºï¼ˆè‡ªç„¶ãªä¸Šæ˜‡ã‚«ãƒ¼ãƒ–æœ€é©åŒ–ï¼‰
                            const baseMultiplier = 2800; // å…¨ä½“çš„ã«æ„Ÿåº¦å‘ä¸Š
                            const minThreshold = 0.0005;   // æ¤œå‡ºæœ€å°é–¾å€¤
                            const instantDropThreshold = 0.002; // å³åº§ã‚¼ãƒ­åŒ–é–¾å€¤
                            
                            // éŸ³é‡è¨ˆç®—ï¼šRMSã¨ãƒ”ãƒ¼ã‚¯å€¤ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´
                            const combinedVolume = (rms * 0.85) + (maxValue * 0.15);
                            
                            // ã‚¹ãƒ ãƒ¼ã‚ºãªéŸ³é‡ãƒãƒ¼åå¿œï¼ˆæ®µéšçš„å¤‰åŒ–ãªã—ï¼‰
                            if (combinedVolume < instantDropThreshold) {
                                volumeLevel = 0; // å³åº§ã‚¼ãƒ­åŒ–
                            } else if (combinedVolume < minThreshold) {
                                volumeLevel = 0; // å¾®ç´°éŸ³é‡ã‚«ãƒƒãƒˆ
                            } else {
                                // å˜ä¸€ã®æ„Ÿåº¦è¨­å®šã§ã‚¹ãƒ ãƒ¼ã‚ºãªä¸Šæ˜‡ã‚«ãƒ¼ãƒ–ã‚’å®Ÿç¾
                                volumeLevel = Math.min(100, Math.max(0, combinedVolume * baseMultiplier));
                            }
                        }
                    } catch (error) {
                        console.warn('Direct volume calculation failed, using fallback:', error);
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šPitchProã®å€¤ã‚’ä½¿ç”¨ï¼ˆSafariå¯¾å¿œæ„Ÿåº¦å‘ä¸Šï¼‰
                        const rawVolume = result.volume || 0;
                        volumeLevel = Math.min(100, Math.max(0, rawVolume * 800)); // æ„Ÿåº¦å‘ä¸Š
                    }
                    
                    // éŸ³é‡ãƒãƒ¼æ›´æ–°
                    if (volumeProgress) {
                        volumeProgress.style.width = volumeLevel + '%';
                    }
                    if (volumeValue) {
                        volumeValue.textContent = volumeLevel.toFixed(1) + '%';
                    }
                    
                    // å‘¨æ³¢æ•°è¡¨ç¤ºæ›´æ–°
                    if (frequencyValue) {
                        if (frequency > 0) {
                            frequencyValue.textContent = `${frequency.toFixed(1)} Hz`;
                        } else {
                            frequencyValue.textContent = '0 Hz';
                        }
                    }
                    
                    // éŸ³å£°æ¤œå‡ºãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šåºƒã„ç¯„å›²ã§äººã®å£°ã‚’æ¤œå‡ºï¼‰
                    if (frequency >= 80 && frequency <= 400 && volumeLevel >= 20) {
                        if (!detectedC4) {
                            detectedC4 = true;
                            updateProgressDisplay('å£°ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼', `${frequency.toFixed(1)}Hz - å®‰å®šã—ãŸéŸ³å£°ã‚’æ¤œå‡ºä¸­`);
                            
                            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—©ã‚ã«è¡¨ç¤º
                            if (detectionSuccess) {
                                detectionSuccess.style.display = 'flex';
                            }
                            
                            setTimeout(() => {
                                if (isAudioTesting) {
                                    completeAudioTest();
                                }
                            }, 2000);
                        }
                    }
                },
                onError: (error) => {
                    console.error('ğŸ¤ éŸ³å£°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    showErrorMessage('éŸ³å£°ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            });
            
            // æ¤œå‡ºé–‹å§‹
            const success = pitchDetector.startDetection();
            if (success) {
                console.log('ğŸµ éŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹');
                updateProgressDisplay('å£°ã‚’å‡ºã—ã¦ãã ã•ã„', '3ç§’é–“ç¶™ç¶šã—ã¦ç™ºå£°ã—ã¦ãã ã•ã„');
                
                // 15ç§’ã‚¿ã‚¤ãƒãƒ¼
                setTimeout(checkAudioTestComplete, audioTestDuration);
            } else {
                showErrorMessage('éŸ³å£°ãƒ†ã‚¹ãƒˆé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // éŸ³å£°ãƒ†ã‚¹ãƒˆå®Œäº†ãƒã‚§ãƒƒã‚¯
        function checkAudioTestComplete() {
            if (!isAudioTesting) return;
            
            if (detectedC4) {
                completeAudioTest();
            } else {
                // æ™‚é–“åˆ‡ã‚Œ - å†è©¦è¡Œã‚’ä¿ƒã™
                updateProgressDisplay('æ™‚é–“åˆ‡ã‚Œ', '130-180Hzã®å£°ã§2ç§’é–“ç¶™ç¶šã—ã¦ãã ã•ã„');
                audioTestStartTime = Date.now(); // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
                setTimeout(checkAudioTestComplete, audioTestDuration);
            }
        }

        // éŸ³å£°ãƒ†ã‚¹ãƒˆå®Œäº†
        function completeAudioTest() {
            isAudioTesting = false;
            
            // PitchDetectoråœæ­¢
            if (pitchDetector) {
                pitchDetector.stopDetection();
                console.log('ğŸµ PitchDetectoråœæ­¢å®Œäº†');
            }
            
            // éŸ³é‡ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            if (volumeProgress) {
                volumeProgress.style.width = '0%';
            }
            if (volumeValue) {
                volumeValue.textContent = '0%';
            }
            
            // å‘¨æ³¢æ•°è¡¨ç¤ºã‚’0Hzã«ãƒªã‚»ãƒƒãƒˆ
            if (frequencyValue) {
                frequencyValue.textContent = '0 Hz';
            }
            
            console.log('âœ… éŸ³å£°ãƒ†ã‚¹ãƒˆå®Œäº†');
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            if (detectionSuccess) {
                detectionSuccess.style.display = 'flex';
            }
            
            // é€²æ—è¡¨ç¤ºã‚’éš ã™
            if (progressDisplay) {
                progressDisplay.style.display = 'none';
            }
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤º
            if (startRangeTestBtn) {
                startRangeTestBtn.classList.remove('hidden');
            }
            
            updateStepStatus(2, 'completed');
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        if (requestMicBtn) {
            requestMicBtn.addEventListener('click', initializeMicrophone);
        }

        if (startRangeTestBtn) {
            startRangeTestBtn.addEventListener('click', () => {
                if (!voiceRangeTester || !pitchDetector) {
                    showErrorMessage('éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                console.log('ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆVoiceRangeTesterV113ä½¿ç”¨ï¼‰');
                showSection(rangeTestSection);
                updateStepStatus(3, 'active');
                
                // éŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹
                const success = voiceRangeTester.startRangeTest();
                if (success) {
                    // PitchDetectorå†é–‹
                    pitchDetector.startDetection();
                } else {
                    showErrorMessage('éŸ³åŸŸãƒ†ã‚¹ãƒˆã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }

        // æ–°è¦è¿½åŠ ï¼šéŸ³åŸŸãƒ†ã‚¹ãƒˆé–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        const beginRangeTestBtn = document.getElementById('begin-range-test-btn');
        if (beginRangeTestBtn) {
            beginRangeTestBtn.addEventListener('click', () => {
                if (!voiceRangeTester) {
                    showErrorMessage('éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }
                
                console.log('ğŸµ éŸ³åŸŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹');
                
                // VoiceRangeTesterV113ã®å®Ÿéš›ã®ãƒ†ã‚¹ãƒˆé–‹å§‹
                const success = voiceRangeTester.beginActualTest();
                if (success) {
                    // ãƒœã‚¿ãƒ³ã‚’éš ã™
                    beginRangeTestBtn.classList.add('hidden');
                } else {
                    showErrorMessage('éŸ³åŸŸãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }

        if (startTrainingBtn) {
            startTrainingBtn.addEventListener('click', () => {
                console.log('ğŸƒ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é–‹å§‹');
                window.location.href = 'Bolt/v2/pages/training.html';
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“„ preparation-test.html èª­ã¿è¾¼ã¿å®Œäº† - PitchPro v1.1.3 + SafariéŸ³é‡ä½ä¸‹å¯¾ç­–çµ±åˆãƒ†ã‚¹ãƒˆç‰ˆ');
        });
    </script>
</body>
</html>