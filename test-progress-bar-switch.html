<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プログレスバー切り替えテスト</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <style>
        body {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .control-panel {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-test {
            margin: 1rem 0;
        }
        
        .progress-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .volume-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }
        
        .volume-text {
            min-width: 60px;
            font-family: monospace;
        }
        
        #debug-log {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a0a0a0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; margin-bottom: 2rem;">プログレスバー切り替えテスト</h1>
        
        <!-- コントロールパネル -->
        <div class="test-section">
            <h2>コントロール</h2>
            <div class="control-panel">
                <button id="test-mic-btn" class="btn btn-primary">マイクテスト用に設定</button>
                <button id="test-range-btn" class="btn btn-primary">音域テスト用に設定</button>
                <button id="start-detection-btn" class="btn btn-secondary">音声検出開始</button>
                <button id="stop-detection-btn" class="btn btn-secondary" disabled>音声検出停止</button>
                <button id="simulate-volume-btn" class="btn btn-secondary">音量シミュレート</button>
            </div>
        </div>
        
        <!-- マイクテスト用プログレスバー -->
        <div class="test-section">
            <h3>マイクテスト用UI</h3>
            <div class="progress-test">
                <div class="progress-label">音量レベル (ID: volume-progress)</div>
                <div class="volume-display">
                    <span class="volume-text" id="volume-value">0%</span>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="progress-test">
                <div class="progress-label">検出周波数</div>
                <div class="volume-display">
                    <span class="volume-text" id="frequency-value" style="color: #60a5fa;">0 Hz</span>
                </div>
            </div>
        </div>
        
        <!-- 音域テスト用プログレスバー -->
        <div class="test-section">
            <h3>音域テスト用UI</h3>
            <div class="progress-test">
                <div class="progress-label">音量レベル (ID: range-test-volume-bar)</div>
                <div class="volume-display">
                    <span class="volume-text" id="range-test-volume-text">0%</span>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="range-test-volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="progress-test">
                <div class="progress-label">検出周波数</div>
                <div class="volume-display">
                    <span class="volume-text" id="range-test-frequency-value" style="color: #60a5fa;">0 Hz</span>
                </div>
            </div>
        </div>
        
        <!-- デバッグログ -->
        <div class="test-section">
            <h3>デバッグログ</h3>
            <div id="debug-log">テストページ読み込み完了...\n</div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    
    <script>
        // グローバル変数
        let audioDetector = null;
        let currentMode = 'none'; // 'mic' | 'range' | 'none'
        let simulationInterval = null;
        
        // DOM要素
        const elements = {
            // マイクテスト要素
            micVolumeBar: document.getElementById('volume-progress'),
            micVolumeText: document.getElementById('volume-value'),
            micFrequencyValue: document.getElementById('frequency-value'),
            
            // 音域テスト要素
            rangeVolumeBar: document.getElementById('range-test-volume-bar'),
            rangeVolumeText: document.getElementById('range-test-volume-text'),
            rangeFrequencyValue: document.getElementById('range-test-frequency-value'),
            
            // ボタン要素
            testMicBtn: document.getElementById('test-mic-btn'),
            testRangeBtn: document.getElementById('test-range-btn'),
            startDetectionBtn: document.getElementById('start-detection-btn'),
            stopDetectionBtn: document.getElementById('stop-detection-btn'),
            simulateVolumeBtn: document.getElementById('simulate-volume-btn'),
            
            // デバッグログ
            debugLog: document.getElementById('debug-log')
        };
        
        // ログ関数
        function log(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                'INFO': 'ℹ️',
                'SUCCESS': '✅',
                'ERROR': '❌',
                'WARNING': '⚠️',
                'DEBUG': '🔍'
            }[type] || '📝';
            
            const logMessage = `[${timestamp}] ${emoji} ${message}\n`;
            elements.debugLog.textContent += logMessage;
            elements.debugLog.scrollTop = elements.debugLog.scrollHeight;
            console.log(logMessage.trim());
        }
        
        // UI更新関数 - マイクテスト用
        function updateMicUI(result) {
            if (!result) return;
            
            log(`マイクUI更新: 音量=${result.volume?.toFixed(1)}%, 周波数=${result.frequency?.toFixed(1)}Hz`, 'DEBUG');
            
            // 周波数更新
            if (result.frequency && elements.micFrequencyValue) {
                elements.micFrequencyValue.textContent = `${result.frequency.toFixed(1)} Hz`;
                elements.micFrequencyValue.style.color = '#60a5fa';
            }
            
            // 音量更新
            if (result.volume !== undefined) {
                const volume = Math.min(100, Math.max(0, result.volume));
                
                if (elements.micVolumeBar) {
                    elements.micVolumeBar.style.width = `${volume}%`;
                    elements.micVolumeBar.style.backgroundColor = '#22c55e';
                }
                
                if (elements.micVolumeText) {
                    elements.micVolumeText.textContent = `${Math.round(volume)}%`;
                }
            }
        }
        
        // UI更新関数 - 音域テスト用
        function updateRangeUI(result) {
            if (!result) return;
            
            log(`音域UI更新: 音量=${result.volume?.toFixed(1)}%, 周波数=${result.frequency?.toFixed(1)}Hz`, 'DEBUG');
            
            // 周波数更新
            if (result.frequency && elements.rangeFrequencyValue) {
                elements.rangeFrequencyValue.textContent = `${result.frequency.toFixed(1)} Hz`;
                elements.rangeFrequencyValue.style.color = '#60a5fa';
            }
            
            // 音量更新
            if (result.volume !== undefined) {
                const volume = Math.min(100, Math.max(0, result.volume));
                
                if (elements.rangeVolumeBar) {
                    // 強制的にスタイル適用
                    elements.rangeVolumeBar.style.setProperty('width', `${volume}%`, 'important');
                    elements.rangeVolumeBar.style.setProperty('background-color', '#22c55e', 'important');
                    
                    // デバッグ確認
                    log(`🔍 range-test-volume-bar DOM確認: width=${elements.rangeVolumeBar.style.width}`, 'DEBUG');
                }
                
                if (elements.rangeVolumeText) {
                    elements.rangeVolumeText.textContent = `${Math.round(volume)}%`;
                }
            }
        }
        
        // AudioDetectionComponent初期化
        async function initializeAudioDetector() {
            try {
                if (!window.PitchPro) {
                    throw new Error('PitchPro not loaded');
                }
                
                log('AudioDetectionComponent初期化開始', 'INFO');
                
                const { AudioDetectionComponent } = window.PitchPro;
                audioDetector = new AudioDetectionComponent({
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    deviceOptimization: true,
                    debug: true,
                    logPrefix: '🎵 ProgressBarTest'
                });
                
                await audioDetector.initialize();
                log('AudioDetectionComponent初期化完了', 'SUCCESS');
                
                return true;
                
            } catch (error) {
                log(`初期化エラー: ${error.message}`, 'ERROR');
                return false;
            }
        }
        
        // マイクテスト用に設定
        async function setupForMicTest() {
            try {
                if (!audioDetector) {
                    if (!await initializeAudioDetector()) {
                        return;
                    }
                }
                
                log('マイクテスト用設定開始', 'INFO');
                
                // 既存の検出を停止
                audioDetector.stopDetection();
                
                // マイクテスト用コールバック設定
                audioDetector.setCallbacks({
                    onPitchUpdate: updateMicUI,
                    onError: (error) => log(`マイクテストエラー: ${error.message}`, 'ERROR')
                });
                
                currentMode = 'mic';
                log('マイクテスト用設定完了', 'SUCCESS');
                
                // ボタン状態更新
                updateButtonStates();
                
            } catch (error) {
                log(`マイクテスト設定エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 音域テスト用に設定
        async function setupForRangeTest() {
            try {
                if (!audioDetector) {
                    if (!await initializeAudioDetector()) {
                        return;
                    }
                }
                
                log('音域テスト用設定開始', 'INFO');
                
                // 既存の検出を停止
                audioDetector.stopDetection();
                
                // 音域テスト用コールバック設定
                audioDetector.setCallbacks({
                    onPitchUpdate: updateRangeUI,
                    onError: (error) => log(`音域テストエラー: ${error.message}`, 'ERROR')
                });
                
                currentMode = 'range';
                log('音域テスト用設定完了', 'SUCCESS');
                
                // ボタン状態更新
                updateButtonStates();
                
            } catch (error) {
                log(`音域テスト設定エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 音声検出開始
        async function startDetection() {
            try {
                if (!audioDetector) {
                    log('AudioDetectionComponentが初期化されていません', 'ERROR');
                    return;
                }
                
                await audioDetector.startDetection();
                log(`音声検出開始 (${currentMode}モード)`, 'SUCCESS');
                
                updateButtonStates();
                
            } catch (error) {
                log(`検出開始エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 音声検出停止
        function stopDetection() {
            if (audioDetector) {
                audioDetector.stopDetection();
                log('音声検出停止', 'INFO');
            }
            
            // シミュレーション停止
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            updateButtonStates();
        }
        
        // 音量シミュレート
        function simulateVolume() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                log('音量シミュレーション停止', 'INFO');
                updateButtonStates();
                return;
            }
            
            log('音量シミュレーション開始', 'INFO');
            
            let counter = 0;
            simulationInterval = setInterval(() => {
                const volume = Math.sin(counter * 0.1) * 30 + 50; // 20-80%の範囲で変動
                const frequency = Math.sin(counter * 0.05) * 50 + 150; // 100-200Hzの範囲で変動
                
                const result = {
                    volume: Math.max(0, volume),
                    frequency: Math.max(80, frequency),
                    note: 'C4'
                };
                
                if (currentMode === 'mic') {
                    updateMicUI(result);
                } else if (currentMode === 'range') {
                    updateRangeUI(result);
                }
                
                counter++;
            }, 100);
            
            updateButtonStates();
        }
        
        // ボタン状態更新
        function updateButtonStates() {
            const isDetecting = audioDetector?.isDetecting || false;
            const isSimulating = simulationInterval !== null;
            
            elements.startDetectionBtn.disabled = isDetecting || currentMode === 'none';
            elements.stopDetectionBtn.disabled = !isDetecting && !isSimulating;
            elements.simulateVolumeBtn.textContent = isSimulating ? 'シミュレーション停止' : '音量シミュレート';
            elements.simulateVolumeBtn.disabled = currentMode === 'none';
            
            // モード表示
            elements.testMicBtn.style.backgroundColor = currentMode === 'mic' ? '#10b981' : '#3b82f6';
            elements.testRangeBtn.style.backgroundColor = currentMode === 'range' ? '#10b981' : '#3b82f6';
        }
        
        // イベントリスナー設定
        elements.testMicBtn.addEventListener('click', setupForMicTest);
        elements.testRangeBtn.addEventListener('click', setupForRangeTest);
        elements.startDetectionBtn.addEventListener('click', startDetection);
        elements.stopDetectionBtn.addEventListener('click', stopDetection);
        elements.simulateVolumeBtn.addEventListener('click', simulateVolume);
        
        // 初期化
        log('プログレスバー切り替えテストページ読み込み完了', 'SUCCESS');
        log('まず「マイクテスト用に設定」または「音域テスト用に設定」ボタンを押してください', 'INFO');
        updateButtonStates();
    </script>
</body>
</html>