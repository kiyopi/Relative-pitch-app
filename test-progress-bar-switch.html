<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="Bolt/v2/styles/base.css">
    <style>
        body {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        
        .control-panel {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .progress-test {
            margin: 1rem 0;
        }
        
        .progress-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .volume-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }
        
        .volume-text {
            min-width: 60px;
            font-family: monospace;
        }
        
        #debug-log {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a0a0a0;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="text-align: center; margin-bottom: 2rem;">ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ</h1>
        
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
        <div class="test-section">
            <h2>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
            <div class="control-panel">
                <button id="test-mic-btn" class="btn btn-primary">ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨ã«è¨­å®š</button>
                <button id="test-range-btn" class="btn btn-primary">éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã«è¨­å®š</button>
                <button id="start-detection-btn" class="btn btn-secondary">éŸ³å£°æ¤œå‡ºé–‹å§‹</button>
                <button id="stop-detection-btn" class="btn btn-secondary" disabled>éŸ³å£°æ¤œå‡ºåœæ­¢</button>
                <button id="simulate-volume-btn" class="btn btn-secondary">éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ</button>
            </div>
        </div>
        
        <!-- ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div class="test-section">
            <h3>ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨UI</h3>
            <div class="progress-test">
                <div class="progress-label">éŸ³é‡ãƒ¬ãƒ™ãƒ« (ID: volume-progress)</div>
                <div class="volume-display">
                    <span class="volume-text" id="volume-value">0%</span>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="volume-progress" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="progress-test">
                <div class="progress-label">æ¤œå‡ºå‘¨æ³¢æ•°</div>
                <div class="volume-display">
                    <span class="volume-text" id="frequency-value" style="color: #60a5fa;">0 Hz</span>
                </div>
            </div>
        </div>
        
        <!-- éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div class="test-section">
            <h3>éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨UI</h3>
            <div class="progress-test">
                <div class="progress-label">éŸ³é‡ãƒ¬ãƒ™ãƒ« (ID: range-test-volume-bar)</div>
                <div class="volume-display">
                    <span class="volume-text" id="range-test-volume-text">0%</span>
                    <div class="progress-bar">
                        <div class="progress-fill gradient-catalog-green" id="range-test-volume-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="progress-test">
                <div class="progress-label">æ¤œå‡ºå‘¨æ³¢æ•°</div>
                <div class="volume-display">
                    <span class="volume-text" id="range-test-frequency-value" style="color: #60a5fa;">0 Hz</span>
                </div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° -->
        <div class="test-section">
            <h3>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h3>
            <div id="debug-log">ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†...\n</div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let audioDetector = null;
        let currentMode = 'none'; // 'mic' | 'range' | 'none'
        let simulationInterval = null;
        
        // DOMè¦ç´ 
        const elements = {
            // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆè¦ç´ 
            micVolumeBar: document.getElementById('volume-progress'),
            micVolumeText: document.getElementById('volume-value'),
            micFrequencyValue: document.getElementById('frequency-value'),
            
            // éŸ³åŸŸãƒ†ã‚¹ãƒˆè¦ç´ 
            rangeVolumeBar: document.getElementById('range-test-volume-bar'),
            rangeVolumeText: document.getElementById('range-test-volume-text'),
            rangeFrequencyValue: document.getElementById('range-test-frequency-value'),
            
            // ãƒœã‚¿ãƒ³è¦ç´ 
            testMicBtn: document.getElementById('test-mic-btn'),
            testRangeBtn: document.getElementById('test-range-btn'),
            startDetectionBtn: document.getElementById('start-detection-btn'),
            stopDetectionBtn: document.getElementById('stop-detection-btn'),
            simulateVolumeBtn: document.getElementById('simulate-volume-btn'),
            
            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
            debugLog: document.getElementById('debug-log')
        };
        
        // ãƒ­ã‚°é–¢æ•°
        function log(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                'INFO': 'â„¹ï¸',
                'SUCCESS': 'âœ…',
                'ERROR': 'âŒ',
                'WARNING': 'âš ï¸',
                'DEBUG': 'ğŸ”'
            }[type] || 'ğŸ“';
            
            const logMessage = `[${timestamp}] ${emoji} ${message}\n`;
            elements.debugLog.textContent += logMessage;
            elements.debugLog.scrollTop = elements.debugLog.scrollHeight;
            console.log(logMessage.trim());
        }
        
        // UIæ›´æ–°é–¢æ•° - ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨
        function updateMicUI(result) {
            if (!result) return;
            
            log(`ãƒã‚¤ã‚¯UIæ›´æ–°: éŸ³é‡=${result.volume?.toFixed(1)}%, å‘¨æ³¢æ•°=${result.frequency?.toFixed(1)}Hz`, 'DEBUG');
            
            // å‘¨æ³¢æ•°æ›´æ–°
            if (result.frequency && elements.micFrequencyValue) {
                elements.micFrequencyValue.textContent = `${result.frequency.toFixed(1)} Hz`;
                elements.micFrequencyValue.style.color = '#60a5fa';
            }
            
            // éŸ³é‡æ›´æ–°
            if (result.volume !== undefined) {
                const volume = Math.min(100, Math.max(0, result.volume));
                
                if (elements.micVolumeBar) {
                    elements.micVolumeBar.style.width = `${volume}%`;
                    elements.micVolumeBar.style.backgroundColor = '#22c55e';
                }
                
                if (elements.micVolumeText) {
                    elements.micVolumeText.textContent = `${Math.round(volume)}%`;
                }
            }
        }
        
        // UIæ›´æ–°é–¢æ•° - éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨
        function updateRangeUI(result) {
            if (!result) return;
            
            log(`éŸ³åŸŸUIæ›´æ–°: éŸ³é‡=${result.volume?.toFixed(1)}%, å‘¨æ³¢æ•°=${result.frequency?.toFixed(1)}Hz`, 'DEBUG');
            
            // å‘¨æ³¢æ•°æ›´æ–°
            if (result.frequency && elements.rangeFrequencyValue) {
                elements.rangeFrequencyValue.textContent = `${result.frequency.toFixed(1)} Hz`;
                elements.rangeFrequencyValue.style.color = '#60a5fa';
            }
            
            // éŸ³é‡æ›´æ–°
            if (result.volume !== undefined) {
                const volume = Math.min(100, Math.max(0, result.volume));
                
                if (elements.rangeVolumeBar) {
                    // å¼·åˆ¶çš„ã«ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
                    elements.rangeVolumeBar.style.setProperty('width', `${volume}%`, 'important');
                    elements.rangeVolumeBar.style.setProperty('background-color', '#22c55e', 'important');
                    
                    // ãƒ‡ãƒãƒƒã‚°ç¢ºèª
                    log(`ğŸ” range-test-volume-bar DOMç¢ºèª: width=${elements.rangeVolumeBar.style.width}`, 'DEBUG');
                }
                
                if (elements.rangeVolumeText) {
                    elements.rangeVolumeText.textContent = `${Math.round(volume)}%`;
                }
            }
        }
        
        // AudioDetectionComponentåˆæœŸåŒ–
        async function initializeAudioDetector() {
            try {
                if (!window.PitchPro) {
                    throw new Error('PitchPro not loaded');
                }
                
                log('AudioDetectionComponentåˆæœŸåŒ–é–‹å§‹', 'INFO');
                
                const { AudioDetectionComponent } = window.PitchPro;
                audioDetector = new AudioDetectionComponent({
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    deviceOptimization: true,
                    debug: true,
                    logPrefix: 'ğŸµ ProgressBarTest'
                });
                
                await audioDetector.initialize();
                log('AudioDetectionComponentåˆæœŸåŒ–å®Œäº†', 'SUCCESS');
                
                return true;
                
            } catch (error) {
                log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
                return false;
            }
        }
        
        // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨ã«è¨­å®š
        async function setupForMicTest() {
            try {
                if (!audioDetector) {
                    if (!await initializeAudioDetector()) {
                        return;
                    }
                }
                
                log('ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨è¨­å®šé–‹å§‹', 'INFO');
                
                // æ—¢å­˜ã®æ¤œå‡ºã‚’åœæ­¢
                audioDetector.stopDetection();
                
                // ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                audioDetector.setCallbacks({
                    onPitchUpdate: updateMicUI,
                    onError: (error) => log(`ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR')
                });
                
                currentMode = 'mic';
                log('ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨è¨­å®šå®Œäº†', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                updateButtonStates();
                
            } catch (error) {
                log(`ãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã«è¨­å®š
        async function setupForRangeTest() {
            try {
                if (!audioDetector) {
                    if (!await initializeAudioDetector()) {
                        return;
                    }
                }
                
                log('éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨è¨­å®šé–‹å§‹', 'INFO');
                
                // æ—¢å­˜ã®æ¤œå‡ºã‚’åœæ­¢
                audioDetector.stopDetection();
                
                // éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
                audioDetector.setCallbacks({
                    onPitchUpdate: updateRangeUI,
                    onError: (error) => log(`éŸ³åŸŸãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR')
                });
                
                currentMode = 'range';
                log('éŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨è¨­å®šå®Œäº†', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                updateButtonStates();
                
            } catch (error) {
                log(`éŸ³åŸŸãƒ†ã‚¹ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // éŸ³å£°æ¤œå‡ºé–‹å§‹
        async function startDetection() {
            try {
                if (!audioDetector) {
                    log('AudioDetectionComponentãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ERROR');
                    return;
                }
                
                await audioDetector.startDetection();
                log(`éŸ³å£°æ¤œå‡ºé–‹å§‹ (${currentMode}ãƒ¢ãƒ¼ãƒ‰)`, 'SUCCESS');
                
                updateButtonStates();
                
            } catch (error) {
                log(`æ¤œå‡ºé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // éŸ³å£°æ¤œå‡ºåœæ­¢
        function stopDetection() {
            if (audioDetector) {
                audioDetector.stopDetection();
                log('éŸ³å£°æ¤œå‡ºåœæ­¢', 'INFO');
            }
            
            // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            updateButtonStates();
        }
        
        // éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        function simulateVolume() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                log('éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢', 'INFO');
                updateButtonStates();
                return;
            }
            
            log('éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹', 'INFO');
            
            let counter = 0;
            simulationInterval = setInterval(() => {
                const volume = Math.sin(counter * 0.1) * 30 + 50; // 20-80%ã®ç¯„å›²ã§å¤‰å‹•
                const frequency = Math.sin(counter * 0.05) * 50 + 150; // 100-200Hzã®ç¯„å›²ã§å¤‰å‹•
                
                const result = {
                    volume: Math.max(0, volume),
                    frequency: Math.max(80, frequency),
                    note: 'C4'
                };
                
                if (currentMode === 'mic') {
                    updateMicUI(result);
                } else if (currentMode === 'range') {
                    updateRangeUI(result);
                }
                
                counter++;
            }, 100);
            
            updateButtonStates();
        }
        
        // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
        function updateButtonStates() {
            const isDetecting = audioDetector?.isDetecting || false;
            const isSimulating = simulationInterval !== null;
            
            elements.startDetectionBtn.disabled = isDetecting || currentMode === 'none';
            elements.stopDetectionBtn.disabled = !isDetecting && !isSimulating;
            elements.simulateVolumeBtn.textContent = isSimulating ? 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢' : 'éŸ³é‡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ';
            elements.simulateVolumeBtn.disabled = currentMode === 'none';
            
            // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
            elements.testMicBtn.style.backgroundColor = currentMode === 'mic' ? '#10b981' : '#3b82f6';
            elements.testRangeBtn.style.backgroundColor = currentMode === 'range' ? '#10b981' : '#3b82f6';
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        elements.testMicBtn.addEventListener('click', setupForMicTest);
        elements.testRangeBtn.addEventListener('click', setupForRangeTest);
        elements.startDetectionBtn.addEventListener('click', startDetection);
        elements.stopDetectionBtn.addEventListener('click', stopDetection);
        elements.simulateVolumeBtn.addEventListener('click', simulateVolume);
        
        // åˆæœŸåŒ–
        log('ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'SUCCESS');
        log('ã¾ãšã€Œãƒã‚¤ã‚¯ãƒ†ã‚¹ãƒˆç”¨ã«è¨­å®šã€ã¾ãŸã¯ã€ŒéŸ³åŸŸãƒ†ã‚¹ãƒˆç”¨ã«è¨­å®šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'INFO');
        updateButtonStates();
    </script>
</body>
</html>