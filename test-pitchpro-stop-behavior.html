<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro stopDetection() 動作確認</title>
    <style>
        body {
            background: #1e293b;
            color: white;
            padding: 2rem;
            font-family: Arial, sans-serif;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border: none;
            border-radius: 8px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #log {
            background: rgba(0,0,0,0.5);
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .mic-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 1rem;
            transition: all 0.3s;
        }
        .mic-off {
            background: #6b7280;
        }
        .mic-on {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>PitchPro stopDetection() 動作確認テスト</h1>
    
    <div class="test-section">
        <h2>マイク状態 <span id="mic-indicator" class="mic-indicator mic-off"></span></h2>
        <p>ブラウザのアドレスバーのマイクアイコンも確認してください</p>
    </div>
    
    <div class="test-section">
        <h2>テストコントロール</h2>
        <button id="init-btn">1. 初期化 (initialize)</button>
        <button id="start-btn" disabled>2. 検出開始 (startDetection)</button>
        <button id="stop-btn" disabled>3. 検出停止 (stopDetection)</button>
        <button id="destroy-btn" disabled>4. 破棄 (destroy)</button>
        <button id="check-btn">状態確認</button>
    </div>
    
    <div class="test-section">
        <h2>デバッグログ</h2>
        <div id="log"></div>
    </div>
    
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    <script>
        let audioDetector = null;
        const log = document.getElementById('log');
        const micIndicator = document.getElementById('mic-indicator');
        
        // ボタン要素
        const initBtn = document.getElementById('init-btn');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const destroyBtn = document.getElementById('destroy-btn');
        const checkBtn = document.getElementById('check-btn');
        
        function addLog(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                'INFO': 'ℹ️',
                'SUCCESS': '✅',
                'ERROR': '❌',
                'WARNING': '⚠️',
                'DEBUG': '🔍'
            }[type] || '📝';
            
            log.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(`${emoji} ${message}`);
        }
        
        // マイク状態を監視
        async function checkMicrophoneStatus() {
            try {
                // MediaDevicesの権限状態を確認
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    addLog(`マイク権限状態: ${result.state}`, 'DEBUG');
                }
                
                // MediaStreamTrackの状態を確認
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    // アクティブなストリームがあるかチェック
                    let hasActiveStream = false;
                    if (audioDetector) {
                        // AudioDetectorの内部状態を確認
                        addLog('AudioDetector内部状態チェック...', 'DEBUG');
                        
                        // isDetectingプロパティがあれば確認
                        if ('isDetecting' in audioDetector) {
                            addLog(`isDetecting: ${audioDetector.isDetecting}`, 'DEBUG');
                            hasActiveStream = audioDetector.isDetecting;
                        }
                        
                        // audioManagerがあれば確認
                        if (audioDetector.audioManager && audioDetector.audioManager.mediaStream) {
                            const stream = audioDetector.audioManager.mediaStream;
                            const tracks = stream.getTracks();
                            hasActiveStream = tracks.some(track => track.readyState === 'live');
                            addLog(`MediaStream tracks: ${tracks.length}, Active: ${hasActiveStream}`, 'DEBUG');
                            
                            tracks.forEach((track, index) => {
                                addLog(`  Track ${index}: ${track.kind}, State: ${track.readyState}, Enabled: ${track.enabled}`, 'DEBUG');
                            });
                        }
                    }
                    
                    // インジケーター更新
                    if (hasActiveStream) {
                        micIndicator.className = 'mic-indicator mic-on';
                        addLog('🎤 マイクはアクティブです', 'WARNING');
                    } else {
                        micIndicator.className = 'mic-indicator mic-off';
                        addLog('🔇 マイクは非アクティブです', 'SUCCESS');
                    }
                    
                    return hasActiveStream;
                }
            } catch (error) {
                addLog(`状態確認エラー: ${error.message}`, 'ERROR');
            }
            
            return false;
        }
        
        // 1. 初期化
        async function initialize() {
            try {
                addLog('AudioDetectionComponent初期化開始', 'INFO');
                
                const { AudioDetectionComponent } = window.PitchPro;
                audioDetector = new AudioDetectionComponent({
                    volumeBarSelector: '#dummy',
                    volumeTextSelector: '#dummy',
                    frequencySelector: '#dummy',
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    deviceOptimization: true,
                    debug: true,
                    logPrefix: '🎵 Test'
                });
                
                await audioDetector.initialize();
                addLog('初期化完了', 'SUCCESS');
                
                // ボタン状態更新
                initBtn.disabled = true;
                startBtn.disabled = false;
                destroyBtn.disabled = false;
                
                // マイク状態確認
                await checkMicrophoneStatus();
                
            } catch (error) {
                addLog(`初期化エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 2. 検出開始
        async function startDetection() {
            try {
                addLog('検出開始', 'INFO');
                await audioDetector.startDetection();
                addLog('検出開始完了', 'SUCCESS');
                
                // ボタン状態更新
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // マイク状態確認
                await checkMicrophoneStatus();
                
            } catch (error) {
                addLog(`検出開始エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 3. 検出停止
        async function stopDetection() {
            try {
                addLog('stopDetection()実行', 'INFO');
                audioDetector.stopDetection();
                addLog('stopDetection()完了', 'SUCCESS');
                
                // ボタン状態更新
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // マイク状態確認（少し待ってから）
                addLog('1秒後にマイク状態を確認...', 'INFO');
                setTimeout(async () => {
                    const isActive = await checkMicrophoneStatus();
                    if (isActive) {
                        addLog('⚠️ stopDetection()後もマイクはアクティブのままです！', 'WARNING');
                        addLog('これはPitchProの仕様かバグの可能性があります', 'WARNING');
                    } else {
                        addLog('✅ stopDetection()でマイクが正しく停止しました', 'SUCCESS');
                    }
                }, 1000);
                
            } catch (error) {
                addLog(`検出停止エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 4. 破棄
        async function destroy() {
            try {
                addLog('destroy()実行', 'INFO');
                audioDetector.destroy();
                addLog('destroy()完了', 'SUCCESS');
                
                // ボタン状態更新
                initBtn.disabled = false;
                startBtn.disabled = true;
                stopBtn.disabled = true;
                destroyBtn.disabled = true;
                
                // マイク状態確認（少し待ってから）
                addLog('1秒後にマイク状態を確認...', 'INFO');
                setTimeout(async () => {
                    const isActive = await checkMicrophoneStatus();
                    if (isActive) {
                        addLog('⚠️ destroy()後もマイクはアクティブのままです！', 'ERROR');
                        addLog('これは深刻な問題です', 'ERROR');
                    } else {
                        addLog('✅ destroy()でマイクが正しく解放されました', 'SUCCESS');
                    }
                    
                    audioDetector = null;
                    addLog('AudioDetectorインスタンスをnullに設定', 'INFO');
                }, 1000);
                
            } catch (error) {
                addLog(`破棄エラー: ${error.message}`, 'ERROR');
            }
        }
        
        // 状態確認
        async function checkStatus() {
            addLog('=== 現在の状態 ===', 'INFO');
            
            if (!audioDetector) {
                addLog('AudioDetectorは存在しません', 'INFO');
            } else {
                addLog('AudioDetectorが存在します', 'INFO');
                
                // 各プロパティを確認
                if ('isDetecting' in audioDetector) {
                    addLog(`isDetecting: ${audioDetector.isDetecting}`, 'DEBUG');
                }
                
                if ('isInitialized' in audioDetector) {
                    addLog(`isInitialized: ${audioDetector.isInitialized}`, 'DEBUG');
                }
                
                if (audioDetector.audioManager) {
                    addLog('audioManagerが存在します', 'DEBUG');
                    
                    if (audioDetector.audioManager.mediaStream) {
                        addLog('mediaStreamが存在します', 'DEBUG');
                    }
                }
            }
            
            await checkMicrophoneStatus();
            addLog('=================', 'INFO');
        }
        
        // イベントリスナー
        initBtn.addEventListener('click', initialize);
        startBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);
        destroyBtn.addEventListener('click', destroy);
        checkBtn.addEventListener('click', checkStatus);
        
        // 初期ログ
        addLog('テストページ読み込み完了', 'SUCCESS');
        addLog('1. 初期化 → 2. 検出開始 → 3. 検出停止 の順でテストしてください', 'INFO');
        addLog('各ステップでマイクの状態を確認します', 'INFO');
    </script>
</body>
</html>