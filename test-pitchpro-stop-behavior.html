<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchPro stopDetection() å‹•ä½œç¢ºèª</title>
    <style>
        body {
            background: #1e293b;
            color: white;
            padding: 2rem;
            font-family: Arial, sans-serif;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        button {
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border: none;
            border-radius: 8px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #log {
            background: rgba(0,0,0,0.5);
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .mic-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 1rem;
            transition: all 0.3s;
        }
        .mic-off {
            background: #6b7280;
        }
        .mic-on {
            background: #ef4444;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>PitchPro stopDetection() å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ãƒã‚¤ã‚¯çŠ¶æ…‹ <span id="mic-indicator" class="mic-indicator mic-off"></span></h2>
        <p>ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ãƒã‚¤ã‚¯ã‚¢ã‚¤ã‚³ãƒ³ã‚‚ç¢ºèªã—ã¦ãã ã•ã„</p>
    </div>
    
    <div class="test-section">
        <h2>ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
        <button id="init-btn">1. åˆæœŸåŒ– (initialize)</button>
        <button id="start-btn" disabled>2. æ¤œå‡ºé–‹å§‹ (startDetection)</button>
        <button id="stop-btn" disabled>3. æ¤œå‡ºåœæ­¢ (stopDetection)</button>
        <button id="destroy-btn" disabled>4. ç ´æ£„ (destroy)</button>
        <button id="check-btn">çŠ¶æ…‹ç¢ºèª</button>
    </div>
    
    <div class="test-section">
        <h2>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</h2>
        <div id="log"></div>
    </div>
    
    <script src="js/pitchpro-audio/dist/pitchpro.umd.js"></script>
    <script>
        let audioDetector = null;
        const log = document.getElementById('log');
        const micIndicator = document.getElementById('mic-indicator');
        
        // ãƒœã‚¿ãƒ³è¦ç´ 
        const initBtn = document.getElementById('init-btn');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const destroyBtn = document.getElementById('destroy-btn');
        const checkBtn = document.getElementById('check-btn');
        
        function addLog(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = {
                'INFO': 'â„¹ï¸',
                'SUCCESS': 'âœ…',
                'ERROR': 'âŒ',
                'WARNING': 'âš ï¸',
                'DEBUG': 'ğŸ”'
            }[type] || 'ğŸ“';
            
            log.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(`${emoji} ${message}`);
        }
        
        // ãƒã‚¤ã‚¯çŠ¶æ…‹ã‚’ç›£è¦–
        async function checkMicrophoneStatus() {
            try {
                // MediaDevicesã®æ¨©é™çŠ¶æ…‹ã‚’ç¢ºèª
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    addLog(`ãƒã‚¤ã‚¯æ¨©é™çŠ¶æ…‹: ${result.state}`, 'DEBUG');
                }
                
                // MediaStreamTrackã®çŠ¶æ…‹ã‚’ç¢ºèª
                if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒˆãƒªãƒ¼ãƒ ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    let hasActiveStream = false;
                    if (audioDetector) {
                        // AudioDetectorã®å†…éƒ¨çŠ¶æ…‹ã‚’ç¢ºèª
                        addLog('AudioDetectorå†…éƒ¨çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯...', 'DEBUG');
                        
                        // isDetectingãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Œã°ç¢ºèª
                        if ('isDetecting' in audioDetector) {
                            addLog(`isDetecting: ${audioDetector.isDetecting}`, 'DEBUG');
                            hasActiveStream = audioDetector.isDetecting;
                        }
                        
                        // audioManagerãŒã‚ã‚Œã°ç¢ºèª
                        if (audioDetector.audioManager && audioDetector.audioManager.mediaStream) {
                            const stream = audioDetector.audioManager.mediaStream;
                            const tracks = stream.getTracks();
                            hasActiveStream = tracks.some(track => track.readyState === 'live');
                            addLog(`MediaStream tracks: ${tracks.length}, Active: ${hasActiveStream}`, 'DEBUG');
                            
                            tracks.forEach((track, index) => {
                                addLog(`  Track ${index}: ${track.kind}, State: ${track.readyState}, Enabled: ${track.enabled}`, 'DEBUG');
                            });
                        }
                    }
                    
                    // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
                    if (hasActiveStream) {
                        micIndicator.className = 'mic-indicator mic-on';
                        addLog('ğŸ¤ ãƒã‚¤ã‚¯ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™', 'WARNING');
                    } else {
                        micIndicator.className = 'mic-indicator mic-off';
                        addLog('ğŸ”‡ ãƒã‚¤ã‚¯ã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™', 'SUCCESS');
                    }
                    
                    return hasActiveStream;
                }
            } catch (error) {
                addLog(`çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
            
            return false;
        }
        
        // 1. åˆæœŸåŒ–
        async function initialize() {
            try {
                addLog('AudioDetectionComponentåˆæœŸåŒ–é–‹å§‹', 'INFO');
                
                const { AudioDetectionComponent } = window.PitchPro;
                audioDetector = new AudioDetectionComponent({
                    volumeBarSelector: '#dummy',
                    volumeTextSelector: '#dummy',
                    frequencySelector: '#dummy',
                    clarityThreshold: 0.4,
                    minVolumeAbsolute: 0.003,
                    deviceOptimization: true,
                    debug: true,
                    logPrefix: 'ğŸµ Test'
                });
                
                await audioDetector.initialize();
                addLog('åˆæœŸåŒ–å®Œäº†', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                initBtn.disabled = true;
                startBtn.disabled = false;
                destroyBtn.disabled = false;
                
                // ãƒã‚¤ã‚¯çŠ¶æ…‹ç¢ºèª
                await checkMicrophoneStatus();
                
            } catch (error) {
                addLog(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // 2. æ¤œå‡ºé–‹å§‹
        async function startDetection() {
            try {
                addLog('æ¤œå‡ºé–‹å§‹', 'INFO');
                await audioDetector.startDetection();
                addLog('æ¤œå‡ºé–‹å§‹å®Œäº†', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // ãƒã‚¤ã‚¯çŠ¶æ…‹ç¢ºèª
                await checkMicrophoneStatus();
                
            } catch (error) {
                addLog(`æ¤œå‡ºé–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // 3. æ¤œå‡ºåœæ­¢
        async function stopDetection() {
            try {
                addLog('stopDetection()å®Ÿè¡Œ', 'INFO');
                audioDetector.stopDetection();
                addLog('stopDetection()å®Œäº†', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // ãƒã‚¤ã‚¯çŠ¶æ…‹ç¢ºèªï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰ï¼‰
                addLog('1ç§’å¾Œã«ãƒã‚¤ã‚¯çŠ¶æ…‹ã‚’ç¢ºèª...', 'INFO');
                setTimeout(async () => {
                    const isActive = await checkMicrophoneStatus();
                    if (isActive) {
                        addLog('âš ï¸ stopDetection()å¾Œã‚‚ãƒã‚¤ã‚¯ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¾ã¾ã§ã™ï¼', 'WARNING');
                        addLog('ã“ã‚Œã¯PitchProã®ä»•æ§˜ã‹ãƒã‚°ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'WARNING');
                    } else {
                        addLog('âœ… stopDetection()ã§ãƒã‚¤ã‚¯ãŒæ­£ã—ãåœæ­¢ã—ã¾ã—ãŸ', 'SUCCESS');
                    }
                }, 1000);
                
            } catch (error) {
                addLog(`æ¤œå‡ºåœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // 4. ç ´æ£„
        async function destroy() {
            try {
                addLog('destroy()å®Ÿè¡Œ', 'INFO');
                audioDetector.destroy();
                addLog('destroy()å®Œäº†', 'SUCCESS');
                
                // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                initBtn.disabled = false;
                startBtn.disabled = true;
                stopBtn.disabled = true;
                destroyBtn.disabled = true;
                
                // ãƒã‚¤ã‚¯çŠ¶æ…‹ç¢ºèªï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰ï¼‰
                addLog('1ç§’å¾Œã«ãƒã‚¤ã‚¯çŠ¶æ…‹ã‚’ç¢ºèª...', 'INFO');
                setTimeout(async () => {
                    const isActive = await checkMicrophoneStatus();
                    if (isActive) {
                        addLog('âš ï¸ destroy()å¾Œã‚‚ãƒã‚¤ã‚¯ã¯ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¾ã¾ã§ã™ï¼', 'ERROR');
                        addLog('ã“ã‚Œã¯æ·±åˆ»ãªå•é¡Œã§ã™', 'ERROR');
                    } else {
                        addLog('âœ… destroy()ã§ãƒã‚¤ã‚¯ãŒæ­£ã—ãè§£æ”¾ã•ã‚Œã¾ã—ãŸ', 'SUCCESS');
                    }
                    
                    audioDetector = null;
                    addLog('AudioDetectorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’nullã«è¨­å®š', 'INFO');
                }, 1000);
                
            } catch (error) {
                addLog(`ç ´æ£„ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }
        
        // çŠ¶æ…‹ç¢ºèª
        async function checkStatus() {
            addLog('=== ç¾åœ¨ã®çŠ¶æ…‹ ===', 'INFO');
            
            if (!audioDetector) {
                addLog('AudioDetectorã¯å­˜åœ¨ã—ã¾ã›ã‚“', 'INFO');
            } else {
                addLog('AudioDetectorãŒå­˜åœ¨ã—ã¾ã™', 'INFO');
                
                // å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèª
                if ('isDetecting' in audioDetector) {
                    addLog(`isDetecting: ${audioDetector.isDetecting}`, 'DEBUG');
                }
                
                if ('isInitialized' in audioDetector) {
                    addLog(`isInitialized: ${audioDetector.isInitialized}`, 'DEBUG');
                }
                
                if (audioDetector.audioManager) {
                    addLog('audioManagerãŒå­˜åœ¨ã—ã¾ã™', 'DEBUG');
                    
                    if (audioDetector.audioManager.mediaStream) {
                        addLog('mediaStreamãŒå­˜åœ¨ã—ã¾ã™', 'DEBUG');
                    }
                }
            }
            
            await checkMicrophoneStatus();
            addLog('=================', 'INFO');
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        initBtn.addEventListener('click', initialize);
        startBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);
        destroyBtn.addEventListener('click', destroy);
        checkBtn.addEventListener('click', checkStatus);
        
        // åˆæœŸãƒ­ã‚°
        addLog('ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'SUCCESS');
        addLog('1. åˆæœŸåŒ– â†’ 2. æ¤œå‡ºé–‹å§‹ â†’ 3. æ¤œå‡ºåœæ­¢ ã®é †ã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'INFO');
        addLog('å„ã‚¹ãƒ†ãƒƒãƒ—ã§ãƒã‚¤ã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™', 'INFO');
    </script>
</body>
</html>